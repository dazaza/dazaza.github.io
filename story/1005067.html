<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我可以通过Postgres做所有的事情：给长生不老的程序员上的课</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">我可以通过Postgres做所有的事情：给长生不老的程序员上的课</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-04 07:24:27</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/6/1ba822d3deea68457c900755620e600e.jpeg"><img src="http://img.diglog.com/img/2020/6/1ba822d3deea68457c900755620e600e.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>如果你对“圣经”有一点粗略的了解，你可能会认得“腓立比书”第4章第13节中的那个半开玩笑的标题。虽然我选择它是因为我认为它朗朗上口，但公平地说，许多开发人员对某些数据库有着宗教上的亲和力。</p><p>这篇文章的目的是阐明另一种思考发展问题的方式。正如您将看到的，这些问题都可以用灵丹妙药代码来解决。我想给出一些用数据库更好地解决问题的具体例子。</p><p>Postgres只是更擅长解决一些问题。自20多年前推出以来，在添加功能和性能方面做了大量工作。</p><p>此外，我还看到了很多项目，其中应用程序CPU经常处于负载状态，而DB服务器CPU徘徊在5%左右。在所有条件相同的情况下，这些技术必须对跨资源重新分配负载有好处。</p><p>所有示例都假设您使用的是ECTO，但是这些概念可以很容易地移植到其他系统。将逻辑移入Postgres并不意味着抛弃您的ORM。值得庆幸的是，通过结合迁移和片段，我们可以少量地注入SQL来实现我们的目标。</p><p>在本例中，模式表示一辆汽车。共有3列：engine_type、mpg和kwh。一辆车不应该在所有3个字段中都有数据。只有装有电动马达的汽车才应该有千瓦时。而且只有汽油发动机才应该有每加仑油耗。</p><p>假设您想要确保在变更集中验证逻辑，您可以创建一个自定义验证器，如下所示：</p><p>使用Postgres，迁移将获得新的检查约束。支持此约束只需要向变更集添加一个check_straint/3函数。使用此策略，数据库将确保遵循业务逻辑，如果不遵循，变更集将返回有用的错误。</p><p>此外，还将验证数据库中的所有数据。即使它没有通过变更集(可能您从外部源导入了数据)。我认为，通过在前端和后端进行验证来采用一种简单的方法来验证数据是很常见的。在数据库级别添加这种类型的验证是腰带和吊带和弹性废纸带。</p><p>Citext是Postgres的延伸。它添加了一个本质上是不区分大小写的字符串的新数据类型。安装它非常简单(如下所示)。</p><p>在幕后，Postgres实际上将查询的两边都转换为小写。顺便说一句，这通常是您在应用程序代码中要做的事情，以实现相同的目的。</p><p>如您所见，执行不区分大小写的搜索所需的长生不老的代码稍微复杂一些。此外，如果您决定将其添加到现有数据库，则需要迁移所有现有数据。使用Citext没有这一要求。</p><p>假设您的用户根据价格搜索汽车。你要给他们看的车和他们要的价格完全一样，但也要给他们看一些多一点和少一点的车。在灵丹妙药中，这可能意味着获得3个结果列表并合并它们。</p><p>Postgres已经在按顺序存储数据。使用窗口函数LAG和LEAD，您可以让Postgres确定精确匹配的目标，然后在索引中抓取它周围的行。把这想成是去一个停车场，那里每辆车都是按价格顺序停放的。如果你从5000美元的车开始，价格接近的车就会停在它旁边。</p><p>在上面的示例中，您还可以看到CTE的用法。顶部(以“with”开头)定义查询中使用的CTE。</p><p>CTE是一个临时结果集，您可以在另一个SQL语句中引用它，包括SELECT、INSERT、UPDATE或DELETE。它在您进行递归查询的任何时候都很有用。</p><p>在灵丹妙药中，搜索模糊匹配的效率可能非常低。假设您想要一个文本搜索，既可以查看汽车的型号，也可以查看汽车的型号。此外，您还希望返回近匹配项，以防用户拼错名称。</p><p>在elxir中，您可能需要加载每辆车，然后迭代每辆车(两次)以计算字符串相似度并对结果进行排序。在本例中，我们使用字符串模块中提供的jaro_Distance。</p><p>通过将该逻辑移到数据库查询中，我们可以使用Postgres内置的函数。Postgres中提供了Levenshtein距离计算，无需任何插件。</p><p>我只是触及了Postgres功能的皮毛。我希望我已经给了您一些关于如何利用您已经安装的这个非常强大的工具的想法。</p><p>Postgres在组织、查询和转换数据方面有很多优势(这就是它设计的目的)。在应用程序中保留逻辑肯定是有时间和地点的，但我希望您至少能考虑一下将逻辑移入Postgres会对您有什么帮助。</p><p>我省略的一些特性包括视图、触发器和pg_NOTIFY。如果您对这些感兴趣，请查看这篇关于缓存长生不老药应用程序的文章。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/@toddresudek/i-can-do-all-things-through-postgres-lessons-for-the-elixir-programmer-400fd805c23a">https://medium.com/@toddresudek/i-can-do-all-things-through-postgres-lessons-for-the-elixir-programmer-400fd805c23a</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/长生不老/">#长生不老</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/lessons/">#lessons</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/postgres/">#postgres</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1005041.html"><img src="http://img.diglog.com/img/2020/6/thumb_c0e1be35788304c1f8d3f08471141a59.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005041.html">使高级保护程序和Titan安全密钥更易于使用</a></div><span class="my_story_list_date">2020-6-4 4:5</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004902.html"><img src="http://img.diglog.com/img/2020/6/thumb_d595175b230343c0b997b7be23b3b8e3.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004902.html">意大利COVID联系人追踪应用程序现在是以开源方式开发的</a></div><span class="my_story_list_date">2020-6-3 5:35</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004878.html"><img src="http://img.diglog.com/img/2020/6/thumb_c3f0187519479516880e5375c7ab0f1f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004878.html">使用图形理解程序</a></div><span class="my_story_list_date">2020-6-3 2:38</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004698.html"><img src="http://img.diglog.com/img/2020/6/thumb_0a06d715e16bbcc483db91407d2f4bd3.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004698.html">Userinterface.js-用于构建前端JavaScript应用程序的小型库</a></div><span class="my_story_list_date">2020-6-2 1:46</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>