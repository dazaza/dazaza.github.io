<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>åˆ©ç”¨K3åœ¨2020å¹´å†…ç®¡ç†æˆ‘çš„ä¸ªäººæœåŠ¡å™¨</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">åˆ©ç”¨K3åœ¨2020å¹´å†…ç®¡ç†æˆ‘çš„ä¸ªäººæœåŠ¡å™¨</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-06 07:14:10</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/7b15f85cf51e716c60511d53696eacf2.jpeg"><img src="http://img2.diglog.com/img/2020/11/7b15f85cf51e716c60511d53696eacf2.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Permalink     GitHub is home to over 50 million developers working together to host and review code, manage projects, and build software together.</p><p>PermalLink GitHubæ˜¯5000ä¸‡å¤šåå¼€å‘äººå‘˜çš„å®¶å›­ï¼Œä»–ä»¬ä¸€èµ·å·¥ä½œï¼Œå…±åŒæ‰˜ç®¡å’Œå®¡æŸ¥ä»£ç ã€ç®¡ç†é¡¹ç›®å’Œæ„å»ºè½¯ä»¶ã€‚</p><p>  Sign up</p><p>æŠ¥åã€‚</p><p>       This document is going to describe how I manage my personal server in 2020. It will talk about</p><p>æœ¬æ–‡æ¡£å°†ä»‹ç»æˆ‘åœ¨2020å¹´å¦‚ä½•ç®¡ç†æˆ‘çš„ä¸ªäººæœåŠ¡å™¨ã€‚å®ƒå°†è°ˆè®ºå…³äºã€‚</p><p>      &lt;iframe width=&#34;560&#34; height=&#34;315&#34; src=&#34; https://www.youtube.com/embed/P5ZJui3aPoQ&#34; frameborder=&#34;0&#34; allow=&#34;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture&#34; allowfullscreen&gt;&lt;/iframe&gt;  It has been more than 15 years now that I manage my own dedicated server, I am in my thirties, and it all started thanks to a talk from Benjamin Bayart  Internet libre, ou minitel 2.0 or for the non-French &#34;Free internet or minitel 2.0&#34;. For those who don&#39;t know what is a minitel, let me quote for you Wikipedia.</p><p>&ltï¼›iframeå®½åº¦=&#34ï¼›560&#34ï¼›é«˜åº¦=&#34ï¼›315&#34ï¼›src=&#34ï¼›https://www.youtube.com/embed/P5ZJui3aPoQ&#34ï¼›å¸§è¾¹ç•Œ=&#34ï¼›0&#34ï¼›å…è®¸=#34ï¼›åŠ é€Ÿåº¦è®¡ï¼›è‡ªåŠ¨æ’­æ”¾ï¼›å‰ªè´´æ¿å†™å…¥ï¼›åŠ å¯†åª’ä½“ï¼›é™€èºä»ªï¼›ç”»ä¸­ç”»&34ï¼›å…è®¸å±å¹•&&gt;ï¼›/iframe&&gt;ï¼›æˆ‘ç®¡ç†è‡ªå·±çš„ä¸“ç”¨æœåŠ¡å™¨å·²ç»15å¹´å¤šäº†ï¼Œæˆ‘å·²ç»30å¤šå²äº†ï¼Œè¿™ä¸€åˆ‡éƒ½è¦å½’åŠŸäºæœ¬æ°æ˜Â·å·´äºšç‰¹(Benjamin Bayart)äº’è”ç½‘å›¾ä¹¦é¦†çš„ä¸€æ¬¡æ¼”è®²ï¼Œæˆ–è€…æ˜¯ä¸ºäº†éæ³•è¯­çš„å…è´¹äº’è”ç½‘æˆ–Minitel 2.0ã€‚å¯¹äºé‚£äº›ä¸çŸ¥é“ä»€ä¹ˆæ˜¯Minitelçš„äººï¼Œè®©æˆ‘ä¸ºä½ å¼•è¿°ä¸€ä¸‹ç»´åŸºç™¾ç§‘(Wikipedia)ã€‚</p><p> The Minitel was a videotex online service accessible through telephone lines, and was the world&#39;s most successful online service prior to the World Wide Web. It was invented in Cesson-SÃ©vignÃ©, near Rennes in Brittany, France.</p><p>Minitelæ˜¯ä¸€ç§å¯é€šè¿‡ç”µè¯çº¿è®¿é—®çš„å¯è§†å›¾æ–‡åœ¨çº¿æœåŠ¡ï¼Œåœ¨ä¸‡ç»´ç½‘å‡ºç°ä¹‹å‰æ˜¯ä¸–ç•Œä¸Šæœ€æˆåŠŸçš„åœ¨çº¿æœåŠ¡ã€‚å®ƒæ˜¯åœ¨æ³•å›½å¸ƒåˆ—å¡”å°¼é›·æ©é™„è¿‘çš„å¡æ¾-å¡ç»´æ¶…å‘æ˜çš„ã€‚</p><p> In the essence, the talk is about creating awareness in 2007 that the internet is starting to lose its decentralized nature and look like more to a minitel 2.0 due to our reliance on centralized big corp for about everything on the Web. This warning ring even louder nowadays with the advent of the Cloud where our computers are now just a fancy screen for accessing data/compute remotely.</p><p>æœ¬è´¨ä¸Šï¼Œè¿™åœºè®¨è®ºæ˜¯å…³äºåœ¨2007å¹´è®©äººä»¬æ„è¯†åˆ°ï¼Œç”±äºæˆ‘ä»¬ä¾èµ–é›†ä¸­åŒ–çš„å¤§å…¬å¸æ¥å¤„ç†ç½‘ç»œä¸Šçš„ä¸€åˆ‡ï¼Œäº’è”ç½‘æ­£å¼€å§‹å¤±å»å…¶åˆ†æ•£æ€§ï¼Œçœ‹èµ·æ¥æ›´åƒæ˜¯Minitel 2.0ã€‚å¦‚ä»Šï¼Œéšç€äº‘çš„å‡ºç°ï¼Œè¿™ç§è­¦å‘Šçš„å£°éŸ³å˜å¾—æ›´åŠ å“äº®ï¼Œæˆ‘ä»¬çš„è®¡ç®—æœºç°åœ¨åªæ˜¯ä¸€ä¸ªç”¨äºè¿œç¨‹è®¿é—®æ•°æ®/è®¡ç®—çš„å¥‡ç‰¹å±å¹•ã€‚</p><p> I went from hardcore extremist, by hosting a server made from scrap materials behind my parent house telephone line, using Gentoo to recompile everything, control every USE flags and have the satisfying pleasure of adding  -mtune=native to the compilation command line. Some years later, after being fed up with having to spend nights to recompile everything on an old Intel Pentium 3 because I missed a USE flag that was mandatory to try this new software, I switched to Debian.</p><p>æˆ‘ä»ä¸€ä¸ªé“æ†æç«¯åˆ†å­ï¼Œåœ¨æˆ‘çˆ¶æ¯å®¶çš„ç”µè¯çº¿åé¢æ‰˜ç®¡äº†ä¸€ä¸ªç”±åºŸå¼ƒææ–™åˆ¶æˆçš„æœåŠ¡å™¨ï¼Œä½¿ç”¨Gentooé‡æ–°ç¼–è¯‘æ‰€æœ‰ä¸œè¥¿ï¼Œæ§åˆ¶æ¯ä¸€ä¸ªä½¿ç”¨æ ‡å¿—ï¼Œå¹¶äº«å—ç€åœ¨ç¼–è¯‘å‘½ä»¤è¡Œä¸­æ·»åŠ -mtune=ativeçš„ä»¤äººæ»¡æ„çš„ä¹è¶£ã€‚å‡ å¹´åï¼Œå› ä¸ºé”™è¿‡äº†è¯•ç”¨è¿™æ¬¾æ–°è½¯ä»¶æ‰€å¿…éœ€çš„ä½¿ç”¨æ ‡å¿—ï¼Œæˆ‘å—å¤Ÿäº†ä¸å¾—ä¸åœ¨æ—§çš„è‹±ç‰¹å°”å¥”è…¾3ä¸ŠèŠ±ä¸Šå‡ ä¸ªæ™šä¸Šé‡æ–°ç¼–è¯‘æ‰€æœ‰çš„ä¸œè¥¿ï¼Œäºæ˜¯æˆ‘è½¬è€Œä½¿ç”¨Debianã€‚</p><p> At that point I thought I had the perfect setup, just do an  apt-get install and you have your software installed in a few minutes, is there anything more than that really ?</p><p>åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘è®¤ä¸ºæˆ‘æœ‰ä¸€ä¸ªå®Œç¾çš„è®¾ç½®ï¼Œåªéœ€åšä¸€ä¸ªapt-getå®‰è£…ï¼Œä½ å°±å¯ä»¥åœ¨å‡ åˆ†é’Ÿå†…å®‰è£…å¥½ä½ çš„è½¯ä»¶ï¼Œè¿˜æœ‰ä»€ä¹ˆæ¯”è¿™æ›´å¤šçš„å—ï¼Ÿ</p><p> It was at that time also that I switched from hosting my server at my parent house to a hosting company. I was out for college and calling my parents to ask them to reboot the machine because it froze due to aging components was taking too much time. I was living in the constant fear of losing some emails and friends on IRC were complaining that the archive/history of the channel that my server was providing was not accessible anymore. So as hard as the decision had been, especially since everything was installed by hand without configuration management, I went to see my parents to tell them that I am removing the server from their care to host it on  online.net and that they should expect even fewer calls from me from now on.</p><p>ä¹Ÿæ˜¯åœ¨é‚£ä¸ªæ—¶å€™ï¼Œæˆ‘ä»æ¯å®¶æ‰˜ç®¡æˆ‘çš„æœåŠ¡å™¨è½¬åˆ°äº†æ‰˜ç®¡å…¬å¸ã€‚æˆ‘å»ä¸Šå¤§å­¦äº†ï¼Œæ‰“ç”µè¯ç»™æˆ‘çš„çˆ¶æ¯ï¼Œè®©ä»–ä»¬é‡æ–°å¯åŠ¨æœºå™¨ï¼Œå› ä¸ºå®ƒå› ä¸ºç»„ä»¶è€åŒ–è€Œæ­»æœºï¼ŒèŠ±è´¹äº†å¤ªå¤šçš„æ—¶é—´ã€‚æˆ‘ä¸€ç›´ç”Ÿæ´»åœ¨ä¸¢å¤±ç”µå­é‚®ä»¶çš„ææƒ§ä¸­ï¼ŒIRCä¸Šçš„æœ‹å‹æŠ±æ€¨è¯´ï¼Œæˆ‘çš„æœåŠ¡å™¨æä¾›çš„é¢‘é“çš„æ¡£æ¡ˆ/å†å²å†ä¹Ÿæ— æ³•è®¿é—®äº†ã€‚å› æ­¤ï¼Œå°½ç®¡è¿™ä¸ªå†³å®šå¾ˆè‰°éš¾ï¼Œç‰¹åˆ«æ˜¯å› ä¸ºæ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯æ‰‹å·¥å®‰è£…çš„ï¼Œæ²¡æœ‰é…ç½®ç®¡ç†ï¼Œä½†æˆ‘å»è§äº†æˆ‘çš„çˆ¶æ¯ï¼Œå‘Šè¯‰ä»–ä»¬æˆ‘å°†æŠŠæœåŠ¡å™¨ä»ä»–ä»¬æ‰‹ä¸­ç§»é™¤ï¼Œè½¬è€Œæ‰˜ç®¡åœ¨Online e.netä¸Šï¼Œè€Œä¸”ä»ç°åœ¨å¼€å§‹ï¼Œä»–ä»¬åº”è¯¥ä¼šæ›´å°‘åœ°æ¥åˆ°æˆ‘çš„ç”µè¯ã€‚</p><p> Rich of this new available bandwidth and after porting my manual deployments to Ansible, I really thought this time I had the perfect setup. Easy to install and configured management ! Is there anything more than that really ?</p><p>è¿™ä¸ªæ–°çš„å¯ç”¨å¸¦å®½éå¸¸ä¸°å¯Œï¼Œåœ¨å°†æˆ‘çš„æ‰‹åŠ¨éƒ¨ç½²ç§»æ¤åˆ°Ansibleä¹‹åï¼Œæˆ‘çœŸçš„è®¤ä¸ºè¿™ä¸€æ¬¡æˆ‘æœ‰äº†å®Œç¾çš„è®¾ç½®ã€‚æ˜“äºå®‰è£…å’Œé…ç½®ç®¡ç†ï¼è¿˜æœ‰ä»€ä¹ˆæ¯”è¿™æ›´é‡è¦çš„å—ï¼Ÿ</p><p> I had found my cruise boat and sailed peacefully with it until the dependencies monsters knocked me off board. When you try to  CRAM everything (mail, webserver, gitlab, pop3, imap, torrent, owncloud, munin, ...) into a single machine on Debian, you ultimately end-up activating unstable repository to get the latest version of packages and end-up with conflicting versions between softwares to the point that doing an  apt-get update &amp;&amp; apt-get upgrade is now your nemesis.</p><p>æˆ‘æ‰¾åˆ°äº†æˆ‘çš„æ¸¸è‰‡ï¼Œå¹³é™åœ°ä¹˜ç€å®ƒèˆªè¡Œï¼Œç›´åˆ°é‚£äº›ä¾é™„çš„æ€ªç‰©æŠŠæˆ‘èµ¶ä¸‹äº†èˆ¹ã€‚å½“ä½ è¯•å›¾å¡«æ»¡æ‰€æœ‰ä¸œè¥¿(é‚®ä»¶ã€ç½‘ç»œæœåŠ¡å™¨ã€GitLabã€POP3ã€IMAPã€Torrentã€ownCloudã€Muninç­‰ç­‰)ã€‚åœ¨Debianä¸Šçš„ä¸€å°æœºå™¨ä¸Šï¼Œä½ æœ€ç»ˆä¼šæ¿€æ´»ä¸ç¨³å®šçš„å­˜å‚¨åº“æ¥è·å–æœ€æ–°ç‰ˆæœ¬çš„åŒ…ï¼Œæœ€ç»ˆå¯¼è‡´è½¯ä»¶ä¹‹é—´çš„ç‰ˆæœ¬å†²çªï¼Œä»¥è‡³äºè¿›è¡Œapt-getæ›´æ–°&ampï¼›&ampï¼›apt-getå‡çº§ç°åœ¨æˆäº†ä½ çš„æ­»å¯¹å¤´ã€‚</p><p> While avoiding system upgrade, I spent some time playing with Kvm/Xen, FreeBSD jails, Illumos, micro-kernel (I thought it will be the future :x) and the new player in town Docker ! I ended-up using Docker due to being too busy/lazy to reinstall everything on something new and Docker allowed me to progressively isolate/patch the software that were annoying me. Hello Python projects !</p><p>åœ¨é¿å…ç³»ç»Ÿå‡çº§çš„åŒæ—¶ï¼Œæˆ‘èŠ±äº†ä¸€äº›æ—¶é—´ç©KVM/Xenã€FreeBSD jagesã€Illumosã€å¾®å†…æ ¸(æˆ‘è®¤ä¸ºå®ƒå°†æ˜¯æœªæ¥çš„X)å’ŒDockeré•‡çš„æ–°ç©å®¶ï¼ç”±äºå¤ªå¿™/å¤ªæ‡’ï¼Œæˆ‘æœ€ç»ˆä½¿ç”¨äº†Dockerï¼Œæ²¡æœ‰æ—¶é—´åœ¨æ–°çš„ä¸œè¥¿ä¸Šé‡æ–°å®‰è£…æ‰€æœ‰ä¸œè¥¿ï¼Œè€ŒDockerè®©æˆ‘é€æ¸éš”ç¦»/ä¿®è¡¥ä»¤æˆ‘æ¼ç«çš„è½¯ä»¶ã€‚ä½ å¥½ï¼ŒPythoné¡¹ç›®ï¼</p><p> This hybrid setup worked for a while, but it felt clunky to manage, especially with Ansible in the mix. I ended-up moving everything into containers, not without hassle, and now Ansible was felling at odd and the integration between systemd and Docker weird, I was just spending time gluing trivial things.</p><p>è¿™ç§æ··åˆè®¾ç½®æ›¾ç»å¥æ•ˆè¿‡ä¸€æ®µæ—¶é—´ï¼Œä½†å®ƒè®©äººæ„Ÿè§‰ç®¡ç†èµ·æ¥å¾ˆç¬¨æ‹™ï¼Œç‰¹åˆ«æ˜¯åœ¨Ansibleçš„å‚ä¸ä¸‹ã€‚æˆ‘æœ€åæŠŠæ‰€æœ‰ä¸œè¥¿éƒ½æ¬åˆ°äº†å®¹å™¨é‡Œï¼Œå¹¶ä¸æ˜¯æ²¡æœ‰éº»çƒ¦ï¼Œç°åœ¨Ansibleå¯¹ODDæ„Ÿåˆ°å¥‡æ€ªï¼ŒSystem då’ŒDockerä¹‹é—´çš„é›†æˆä¹Ÿå¾ˆå¥‡æ€ªï¼Œæˆ‘åªæ˜¯æŠŠæ—¶é—´èŠ±åœ¨ç²˜åˆçç¢çš„ä¸œè¥¿ä¸Šã€‚</p><p> So I spent a bit of time this month to create and share with you my perfect new setup for managing a personal server in 2020 !</p><p>å› æ­¤ï¼Œè¿™ä¸ªæœˆæˆ‘èŠ±äº†ä¸€äº›æ—¶é—´æ¥åˆ›å»ºå¹¶ä¸å¤§å®¶åˆ†äº«æˆ‘åœ¨2020å¹´ç®¡ç†ä¸ªäººæœåŠ¡å™¨çš„å®Œç¾æ–°è®¾ç½®ï¼</p><p>  So let&#39;s start. The first step is to create a GPG key. This key will serve to encrypt every secret we have in order to be able to commit them inside the git repository. With secrets inside git, our repository will be able be standalone and portable across machines. We will be able to do a  git clone and get working !</p><p>æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªGPGå¯†é’¥ã€‚è¿™ä¸ªå¯†é’¥å°†ç”¨äºåŠ å¯†æˆ‘ä»¬æ‹¥æœ‰çš„æ¯ä¸€ä¸ªç§˜å¯†ï¼Œä»¥ä¾¿èƒ½å¤Ÿåœ¨gitå­˜å‚¨åº“ä¸­æäº¤å®ƒä»¬ã€‚æœ‰äº†gitå†…éƒ¨çš„ç§˜å¯†ï¼Œæˆ‘ä»¬çš„å­˜å‚¨åº“å°†èƒ½å¤Ÿç‹¬ç«‹è¿è¡Œï¼Œå¹¶ä¸”å¯ä»¥è·¨æœºå™¨ç§»æ¤ã€‚æˆ‘ä»¬å°†èƒ½å¤Ÿè¿›è¡Œgitå…‹éš†å¹¶å¼€å§‹å·¥ä½œï¼</p><p>  This GPG key will be the guardian of your infrastructure, if it leaks, anybody will be able to access your infra. So store it somewhere safe</p><p>è¿™ä¸ªGPGå¯†é’¥å°†æ˜¯ä½ çš„åŸºç¡€è®¾æ–½çš„å®ˆæŠ¤è€…ï¼Œå¦‚æœå®ƒæ³„éœ²äº†ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ä½ çš„åŸºç¡€è®¾æ–½ã€‚æ‰€ä»¥æŠŠå®ƒæ”¾åœ¨å®‰å…¨çš„åœ°æ–¹</p><p>   Now that we have a PGP key, we will use the wonderful tool  SOPS to encrypt our secrets with it.</p><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†PGPå¯†é’¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªéå¸¸æ£’çš„å·¥å…·SOPSæ¥åŠ å¯†æˆ‘ä»¬çš„ç§˜å¯†ã€‚</p><p> Sops is not very well known, but very practical and easy to use, which is a great plus for once in a security tool.</p><p>SOPSä¸æ˜¯å¾ˆå‡ºåï¼Œä½†éå¸¸å®ç”¨å’Œæ˜“äºä½¿ç”¨ï¼Œè¿™å¯¹äºä¸€ä¸ªå®‰å…¨å·¥å…·æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŠ åˆ†ã€‚</p><p>   After that just invoke sops to create a new secret with your GPG key. Sops force the use of YAML, so your file need to be a valid YAML.</p><p>åœ¨é‚£ä¹‹åï¼Œåªéœ€è°ƒç”¨SOPSæ¥ç”¨æ‚¨çš„GPGå¯†é’¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç§˜å¯†å³å¯ã€‚SOPSå¼ºåˆ¶ä½¿ç”¨YAMLï¼Œå› æ­¤æ‚¨çš„æ–‡ä»¶éœ€è¦æ˜¯æœ‰æ•ˆçš„YAMLã€‚</p><p> â¯ mkdir secrets secrets_decryptedâ¯ sops secrets/foobar.yml * editor with default values  *â¯ cat secrets/foorbar.yml   # content of file is encrypted nowhello: ENC[AES256_GCM,data:zpzQz+siZxcshJjmi4PBvX2GMm3sWibxRPCgil2mi+c6AQ0uXEBLM2lL0o+BBg ==,...</p><p>ECCmkdir Secret_Deccryptedâ¯SOPS Secret/foobar.yml*ç¼–è¾‘å™¨ä½¿ç”¨é»˜è®¤å€¼*â¯çŒ«æœºå¯†/foorbar.yml#æ–‡ä»¶å†…å®¹ä¸åŠ å¯†ï¼šenc[AES256_GCMï¼ŒECC[AES256_GCMï¼ŒENTC[AES256_GCMï¼ŒENTC[AES256_GCMï¼ŒFORBAR.YML==ï¼Œ...ã€‚</p><p>   There are other commands that allow you to avoid dumping your decrypted secrets onto the file system. If you are interested in this feature look at</p><p>è¿˜æœ‰å…¶ä»–å‘½ä»¤å…è®¸æ‚¨é¿å…å°†è§£å¯†çš„æœºå¯†è½¬å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚å¦‚æœæ‚¨å¯¹æ­¤åŠŸèƒ½æ„Ÿå…´è¶£ï¼Œè¯·æŸ¥çœ‹ã€‚</p><p>   Now that we are able to store secrets securely within our repository, it is time to generate a new ssh key in order to be able to log to our future next server.</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨å­˜å‚¨åº“ä¸­å®‰å…¨åœ°å­˜å‚¨ç§˜å¯†ï¼Œæ˜¯æ—¶å€™ç”Ÿæˆä¸€ä¸ªæ–°çš„sshå¯†é’¥ï¼Œä»¥ä¾¿èƒ½å¤Ÿç™»å½•åˆ°æˆ‘ä»¬æœªæ¥çš„ä¸‹ä¸€å°æœåŠ¡å™¨ã€‚</p><p> We are going to set a passphrase to our ssh keys and use a ssh-agent/ keychain in order to avoid typing it every time</p><p>æˆ‘ä»¬å°†ä¸ºsshå¯†é’¥è®¾ç½®å¯†ç çŸ­è¯­ï¼Œå¹¶ä½¿ç”¨sshä»£ç†/å¯†é’¥é“¾ï¼Œä»¥é¿å…æ¯æ¬¡éƒ½è¾“å…¥å¯†ç ã€‚</p><p> # Don&#39;t forget to set a strong passphrase and change the default name for your key from id_rsa to something else, it will be usefull later onssh-keygen  # To add your ssh ke into the keyring eval   $(keychain --eval --agents ssh  ~/.ssh/your_private_key )</p><p>#ä¸è¦å¿˜è®°è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ï¼Œå¹¶å°†å¯†é’¥çš„é»˜è®¤åç§°ä»id_rsaæ›´æ”¹ä¸ºå…¶ä»–åç§°ï¼Œç¨ååœ¨ssh-keygen#å°†ssh keæ·»åŠ åˆ°å¯†é’¥ç¯eval$(keychain--val--Agents ssh~/.ssh/you_Private_key)ä¼šå¾ˆæœ‰ç”¨ã€‚(=</p><p>  sops secrets/ssh.yml  # edit the yaml file to get 2 section for your private and public ssh key  # paste the content of your keys in this sectiongit add secrets/ssh.ymlgit commit -m   &#39;Adding ssh key &#39;</p><p>SOPS secrets/ssh.yml#ç¼–è¾‘YAMLæ–‡ä»¶ä»¥è·å¾—ç§é’¥å’Œå…¬é’¥çš„2ä¸ªéƒ¨åˆ†#å°†å¯†é’¥çš„å†…å®¹ç²˜è´´åˆ°æ­¤éƒ¨åˆ†ä¸­å®ƒæ·»åŠ ç§˜å¯†/ssh.ymlgit Commit-m&#39ï¼›æ·»åŠ sshå¯†é’¥&#39ï¼›</p><p>  Now we want for this repository to be self-contained and easily portable across machines. A valid approach would have been to use Ansible in order to automate our deployment. But we will not tap a lot into the full power of a configuration management in this setup, so I chose to use a simple makefile to automate the deployment.</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªå­˜å‚¨åº“æ˜¯è‡ªåŒ…å«çš„ï¼Œå¹¶ä¸”å¯ä»¥æ–¹ä¾¿åœ°è·¨æœºå™¨ç§»æ¤ã€‚ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•æ˜¯ä½¿ç”¨Ansibleæ¥è‡ªåŠ¨åŒ–æˆ‘ä»¬çš„éƒ¨ç½²ã€‚ä½†æ˜¯åœ¨è¿™ä¸ªè®¾ç½®ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šå……åˆ†åˆ©ç”¨é…ç½®ç®¡ç†çš„å…¨éƒ¨åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©ä½¿ç”¨ä¸€ä¸ªç®€å•çš„Makefileæ¥è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚</p><p> â¯ mkdir configâ¯ cat Makefile.PHONY: installinstall: sops -d --extract   &#39;[&#34;public_key&#34;] &#39; --output  ~/.ssh/erebe_rsa.pub secrets/ssh.yml sops -d --extract   &#39;[&#34;private_key&#34;] &#39; --output  ~/.ssh/erebe_rsa.key secrets/ssh.yml chmod 600  ~/.ssh/erebe_rsa. * grep -q erebe.eu  ~/.ssh/config  &gt; /dev/null  2&gt;&amp;1  || cat config/ssh_client_config  &gt;&gt;  ~/.ssh/config mkdir  ~/.kube  ||  exit 0</p><p>â¯mkdiré…ç½®â¯çŒ«ç”Ÿæˆæ–‡ä»¶ã€‚PHONYï¼šå®‰è£…ï¼šSOPS-d--æå–#39ï¼›[&#34ï¼›å…¬é’¥#34ï¼›]&#39ï¼›--è¾“å‡º~/.ssh/erebe_rsa.pub secrets/ssh.yml sops-d--æå–&#39ï¼›[&#34ï¼›ç§æœ‰å¯†é’¥&#34ï¼›]&#39ï¼›--è¾“å‡º~/.ssh/erebe_rsa.key secre.sã€‚*grep-q erebe.eu~/.ssh/config&gtï¼›/dev/null 2&gtï¼›&ampï¼›1||cat config/ssh_client_config&gtï¼›&gtï¼›~/.ssh/config mkdir~/.kube||é€€å‡º0ã€‚</p><p> The installation section is decrypting the ssh keys, install them and looking into my ~/.ssh/config to see if I already have a section for my server in order to add it if missing. With that I will be able to do a  ssh my-server and get everything setup correctly</p><p>å®‰è£…éƒ¨åˆ†æ­£åœ¨è§£å¯†sshå¯†é’¥ï¼Œå®‰è£…å®ƒä»¬ï¼Œç„¶åæŸ¥çœ‹æˆ‘çš„~/.ssh/configï¼Œçœ‹çœ‹æˆ‘çš„æœåŠ¡å™¨æ˜¯å¦å·²ç»æœ‰ä¸€ä¸ªéƒ¨åˆ†ï¼Œä»¥ä¾¿åœ¨ä¸¢å¤±æ—¶æ·»åŠ å®ƒã€‚è¿™æ ·ï¼Œæˆ‘å°±èƒ½å¤Ÿæ‰§è¡Œssh my-serverï¼Œå¹¶æ­£ç¡®è®¾ç½®æ‰€æœ‰å†…å®¹ã€‚</p><p>  We have a git repository with our ssh keys, so now is the time to use those keys and get a real server behind it.</p><p>æˆ‘ä»¬æœ‰ä¸€ä¸ªgitå­˜å‚¨åº“å’Œæˆ‘ä»¬çš„sshå¯†é’¥ï¼Œæ‰€ä»¥ç°åœ¨æ˜¯æ—¶å€™ä½¿ç”¨è¿™äº›å¯†é’¥å¹¶å¾—åˆ°ä¸€ä¸ªçœŸæ­£çš„æœåŠ¡å™¨æ¥æ”¯æŒå®ƒäº†ã€‚</p><p> Personally I use a 1st tier  dedibox from  online.net now renamed into  scaleway for 8â‚¬ per month. Their machine is rock solid, cheap and never had an issue with them since more than 15 years. You are free to chose whatever provider you want but here my recommendations for the thing to look at</p><p>å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯Online.netçš„ä¸€çº§åŒ…å¢ï¼Œç°åœ¨æ›´åä¸ºscalewayï¼Œæ¯æœˆ8æ¬§å…ƒã€‚ä»–ä»¬çš„æœºå™¨åšå¦‚ç£çŸ³ï¼Œä»·æ ¼ä¾¿å®œï¼Œ15å¹´å¤šæ¥ä»æœªå‡ºè¿‡é—®é¢˜ã€‚ä½ å¯ä»¥è‡ªç”±é€‰æ‹©ä½ æƒ³è¦çš„ä»»ä½•ä¾›åº”å•†ï¼Œä½†æˆ‘åœ¨è¿™é‡Œæ¨èç»™ä½ çœ‹çš„ä¸œè¥¿ã€‚</p><p> Disk space: Using containers consume a lot of disk space. So take a machine with at least 60G of space.</p><p>ç£ç›˜ç©ºé—´ï¼šä½¿ç”¨å®¹å™¨ä¼šæ¶ˆè€—å¤§é‡ç£ç›˜ç©ºé—´ã€‚å› æ­¤ï¼Œå°±æ‹¿ä¸€å°è‡³å°‘æœ‰60Gç©ºé—´çš„æœºå™¨æ¥è¯´å§ã€‚</p><p> Public bandwidth limitation: All hosting company throttle public bandwidth to avoid issue with torrent seedbox. So the higher you get for the same price, the better it is (i.e: scaleway provide 250Mbits/s while OVH only 200Mbits)</p><p>å…¬å…±å¸¦å®½é™åˆ¶ï¼šæ‰€æœ‰æ‰˜ç®¡å…¬å¸éƒ½ä¼šé™åˆ¶å…¬å…±å¸¦å®½ï¼Œä»¥é¿å…Torrentç§å­ç›’å‡ºç°é—®é¢˜ã€‚åŒæ ·çš„ä»·æ ¼è¶Šé«˜è¶Šå¥½(æ¯”å¦‚ï¼šScewayæä¾›250Mbit/sï¼Œè€ŒOVHåªæä¾›200Mbit/s)</p><p> Free backup storage: At some point we will have data to backup, so look if they provide some external storage for backups</p><p>å…è´¹å¤‡ä»½å­˜å‚¨ï¼šåœ¨æŸä¸€æ—¶åˆ»ï¼Œæˆ‘ä»¬å°†æœ‰æ•°æ®è¦å¤‡ä»½ï¼Œå› æ­¤è¯·æŸ¥çœ‹ä»–ä»¬æ˜¯å¦ä¸ºå¤‡ä»½æä¾›äº†ä¸€äº›å¤–éƒ¨å­˜å‚¨ã€‚</p><p>  Domain name/Free mail account: If you plan to use them as a registrar for your domain name, look if they can provide you email account storage in order to configure them as fallback to not lose mail</p><p>åŸŸå/å…è´¹é‚®ä»¶å¸æˆ·ï¼šå¦‚æœæ‚¨è®¡åˆ’ä½¿ç”¨å®ƒä»¬ä½œä¸ºæ‚¨çš„åŸŸåçš„æ³¨å†Œå•†ï¼Œè¯·æŸ¥çœ‹å®ƒä»¬æ˜¯å¦å¯ä»¥ä¸ºæ‚¨æä¾›ç”µå­é‚®ä»¶å¸æˆ·å­˜å‚¨ï¼Œä»¥ä¾¿å°†å®ƒä»¬é…ç½®ä¸ºåå¤‡ï¼Œä»¥ä¸ä¸¢å¤±é‚®ä»¶ã€‚</p><p> Once you have your server provider, do the installation and choose Debian for the OS. At some point we will ask you for your ssh key, so provide the one you created earlier. If you have the possibility to select your filesystem use XFS instead of ext4 as it provides good support</p><p>ä¸€æ—¦æ‚¨æœ‰äº†æœåŠ¡å™¨æä¾›å•†ï¼Œè¯·è¿›è¡Œå®‰è£…å¹¶é€‰æ‹©Debianä½œä¸ºæ“ä½œç³»ç»Ÿã€‚åœ¨æŸä¸ªæ—¶åˆ»ï¼Œæˆ‘ä»¬ä¼šè¦æ±‚æ‚¨æä¾›sshå¯†é’¥ï¼Œå› æ­¤è¯·æä¾›æ‚¨ä¹‹å‰åˆ›å»ºçš„å¯†é’¥ã€‚å¦‚æœå¯ä»¥é€‰æ‹©æ–‡ä»¶ç³»ç»Ÿï¼Œè¯·ä½¿ç”¨XFSè€Œä¸æ˜¯ext4ï¼Œå› ä¸ºå®ƒæä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚</p><p>    The machine is in place and reachable to the outside world.First thing to do is secure it ! We want to :</p><p>æœºå™¨å·²ç»å°±ä½ï¼Œå¤–ç•Œå¯ä»¥æ¥è§¦åˆ°ã€‚é¦–å…ˆè¦åšçš„æ˜¯ä¿æŠ¤å¥½å®ƒï¼æˆ‘ä»¬å¸Œæœ›ï¼š</p><p>    HOST= ${my-server}.PHONY: install package  # ...package: ssh  ${HOST}   &#39;apt-get update &amp;&amp; apt-get install -y curl htop mtr tcpdump ncdu vim dnsutils strace linux-perf iftop &#39;   # Enable automatic security Updates ssh  ${HOST}   &#39;echo &#34;unattended-upgrades unattended-upgrades/enable_auto_updates boolean true&#34; | de bconf-set-selections &amp;&amp; apt-get install unattended-upgrades -y &#39;</p><p>Host=${my-server}.PHONYï¼šå®‰è£…ç¨‹åºåŒ…#...ç¨‹åºåŒ…ï¼šSSH${host}&#39ï¼›apt-get update&ampï¼›&ampï¼›apt-get install-y curl HTOP MTR Tcpump ncdu vim dnsutils strace linux-perf iftopï¼›#å¯ç”¨è‡ªåŠ¨å®‰å…¨æ›´æ–°ssh${hostã€‚</p><p> With that the machine will install security update by its own, without requesting us to type manually  apt-get update &amp;&amp; apt-get upgrade</p><p>è¿™æ ·ï¼Œè®¡ç®—æœºå°†è‡ªè¡Œå®‰è£…å®‰å…¨æ›´æ–°ï¼Œè€Œä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨é”®å…¥apt-get update&ampï¼›&ampï¼›apt-get upgradeã€‚</p><p>  Next is improving the security of our ssh server. We are going to disable password authentication and allowing only public key authentication.As our ssh keys are encrypted in our repository, they will be always available to us if needed, as long as we have the GPG key.</p><p>ä¸‹ä¸€æ­¥æ˜¯æé«˜sshæœåŠ¡å™¨çš„å®‰å…¨æ€§ã€‚æˆ‘ä»¬å°†ç¦ç”¨å¯†ç èº«ä»½éªŒè¯ï¼Œåªå…è®¸å…¬é’¥èº«ä»½éªŒè¯ã€‚å› ä¸ºæˆ‘ä»¬çš„sshå¯†é’¥åœ¨æˆ‘ä»¬çš„å­˜å‚¨åº“ä¸­æ˜¯åŠ å¯†çš„ï¼Œæ‰€ä»¥åªè¦æˆ‘ä»¬æ‹¥æœ‰GPGå¯†é’¥ï¼Œå¦‚æœéœ€è¦ï¼Œå®ƒä»¬å°†å§‹ç»ˆå¯ç”¨ã€‚</p><p>   As I don&#39;t use any configuration management (i.e: Ansible), It is kind of tedious to use a normal user and leverage privilege escalation (sudo) to do stuff in  root. So I allow root login on the SSH server to make things easier to manage. If you plan to use a configuration management system, disable the root login authentication.</p><p>å› ä¸ºæˆ‘ä¸ä½¿ç”¨ä»»ä½•é…ç½®ç®¡ç†(å³ï¼šAnsible)ï¼Œæ‰€ä»¥ä½¿ç”¨æ™®é€šç”¨æˆ·å¹¶åˆ©ç”¨æƒé™æå‡(Sudo)åœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œæ“ä½œæœ‰ç‚¹å•è°ƒä¹å‘³ã€‚å› æ­¤ï¼Œæˆ‘å…è®¸ä»¥è¶…çº§ç”¨æˆ·èº«ä»½ç™»å½•SSHæœåŠ¡å™¨ï¼Œä»¥ä¾¿äºç®¡ç†ã€‚å¦‚æœæ‚¨è®¡åˆ’ä½¿ç”¨é…ç½®ç®¡ç†ç³»ç»Ÿï¼Œè¯·ç¦ç”¨è¶…çº§ç”¨æˆ·ç™»å½•èº«ä»½éªŒè¯ã€‚</p><p>  Warning Be sure that you are correctly able to log with your ssh key before doing that or you will need to reinstall your machine/use the rescue console of your hosting provider to fix things</p><p>è­¦å‘Šï¼šåœ¨æ‰§è¡Œæ­¤æ“ä½œä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨èƒ½å¤Ÿæ­£ç¡®åœ°ä½¿ç”¨sshå¯†é’¥ç™»å½•ï¼Œå¦åˆ™æ‚¨å°†éœ€è¦é‡æ–°å®‰è£…æ‚¨çš„æœºå™¨/ä½¿ç”¨ä¸»æœºæä¾›å•†çš„æ•‘æ´æ§åˆ¶å°æ¥ä¿®å¤é—®é¢˜ã€‚</p><p> â¯ Makefile.PHONY: install package ssh  #...  # Check if the file is different from our git repository and if it is the case re-upload and restart the ssh serverssh: ssh  ${HOST}   &#34;cat /etc/ssh/sshd_config &#34;  | diff - config/sshd_config \  || (scp config/sshd_config  ${HOST}:/etc/ssh/sshd_config  &amp;&amp; ssh  ${HOST} systemctl restart</p><p>â¯ç”Ÿæˆæ–‡ä»¶ã€‚PHONYï¼šå®‰è£…ç¨‹åºåŒ…ssh#...#æ£€æŸ¥è¯¥æ–‡ä»¶æ˜¯å¦ä¸æˆ‘ä»¬çš„GITå­˜å‚¨åº“ä¸åŒï¼Œå¦‚æœæ˜¯ï¼Œè¯·é‡æ–°ä¸Šä¼ å¹¶é‡æ–°å¯åŠ¨sshæœåŠ¡å™¨ï¼šssh${HOST}&#34ï¼›cat/etc/ssh/sshd_config&#34ï¼›|diff-config/sshd_config\||(scp config/sshd_config${host}ï¼š/etc/ssh/sshd_config&ampï¼›&ampã€‚</p><p>    Last part of the plan is to secure the network by putting in place firewall rules.</p><p>è¯¥è®¡åˆ’çš„æœ€åä¸€éƒ¨åˆ†æ˜¯é€šè¿‡åˆ¶å®šé˜²ç«å¢™è§„åˆ™æ¥ä¿æŠ¤ç½‘ç»œå®‰å…¨ã€‚</p><p> I want to stay close to the real things, so I use directly iptables to create my firewall rules. This is at the cost of having to duplicate the rules for IPv4 and IPv6.</p><p>æˆ‘æƒ³è¦æ¥è¿‘çœŸå®æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ç›´æ¥ä½¿ç”¨iptableæ¥åˆ›å»ºæˆ‘çš„é˜²ç«å¢™è§„åˆ™ã€‚è¿™æ˜¯ä»¥ä¸å¾—ä¸å¤åˆ¶IPv4å’ŒIPv6çš„è§„åˆ™ä¸ºä»£ä»·çš„ã€‚</p><p>  We want for our deployment of iptables rules to be idempotent, so we are going to create a custom chain to avoid messing with the default one.Also, I am going to use  iptables command directly instead of  iptable-restore, because  iptables-restore files need to be holistic and does not compose well when programs manage only a subpart of the firewall rules. As we are going to install Kubernetes later on, it will allow us to avoid messing with proxy rules.</p><p>æˆ‘ä»¬å¸Œæœ›iptableè§„åˆ™çš„éƒ¨ç½²æ˜¯å¹‚ç­‰çš„ï¼Œå› æ­¤æˆ‘ä»¬å°†åˆ›å»ºè‡ªå®šä¹‰é“¾ä»¥é¿å…å¹²æ‰°é»˜è®¤è§„åˆ™ã€‚æ­¤å¤–ï¼Œæˆ‘å°†ç›´æ¥ä½¿ç”¨iptableå‘½ä»¤è€Œä¸æ˜¯iptable-Restoreï¼Œå› ä¸ºiptable-Restoreæ–‡ä»¶éœ€è¦æ˜¯æ•´ä½“çš„ï¼Œå¹¶ä¸”å½“ç¨‹åºåªç®¡ç†é˜²ç«å¢™è§„åˆ™çš„ä¸€ä¸ªå­éƒ¨åˆ†æ—¶ä¸èƒ½å¾ˆå¥½åœ°ç»„åˆã€‚ç”±äºæˆ‘ä»¬ç¨åå°†å®‰è£…Kubernetesï¼Œå®ƒå°†å…è®¸æˆ‘ä»¬é¿å…æ‰°ä¹±ä»£ç†è§„åˆ™ã€‚</p><p> #!/bin/sh  # Execute only when it is for our main NIC[   &#34; $IFACE &#34;  !=   &#34;enp1s0 &#34; ]  ||  exit 0  # In order to get an IPv6 lease from online.netsysctl -w net.ipv6.conf.enp1s0.accept_ra=2  ###########################  # IPv4  ###########################  # Reset our custom chainiptables -P INPUT ACCEPTiptables -D INPUT -j USER_CUSTOMiptables -F USER_CUSTOMiptables -X USER_CUSTOMiptables -N USER_CUSTOM  # Allow loopback interfaceiptables -A USER_CUSTOM -i lo -j ACCEPT  # Allow wireguard interfaceiptables -A USER_CUSTOM -i wg0 -j ACCEPT  # Allow Kubernetes interfacesiptables -A USER_CUSTOM -i cni0 -j ACCEPTiptables -A USER_CUSTOM -i flannel.1 -j ACCEPT  # Allow already accepted connectionsiptables -A USER_CUSTOM -p tcp -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPTiptables -A USER_CUSTOM -p udp -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPTiptables -A USER_CUSTOM -p icmp -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT  # Accept incoming ICMP - Server provider use ping to monitor the machineiptables -A USER_CUSTOM -p icmp -j ACCEPT  # Allow sshiptables -A USER_CUSTOM -p tcp --dport 22 -j ACCEPT  # Allow http/httpsiptables -A USER_CUSTOM -p tcp --dport 80 -j ACCEPTiptables -A USER_CUSTOM -p tcp --dport 443 -j ACCEPT  # Allow SMTP and IMAPiptables -A USER_CUSTOM -p tcp --dport 25 -j ACCEPTiptables -A USER_CUSTOM -p tcp --dport 993 -j ACCEPT  # Allow wireguardiptables -A USER_CUSTOM -p udp --dport 995 -j ACCEPT  # Allow kubernetes k3S api serveriptables -A USER_CUSTOM -p tcp --dport 6443 -j ACCEPT  # Add our custom chainiptables -I INPUT 1 -j USER_CUSTOM  # DROP INCOMING TRAFFIC by default if nothing matchiptables -P INPUT DROP  #######  #IPv6  #######  #do the same thing with ip6tables instead of iptables  # Accept incoming ICMPip6tables -A USER_CUSTOM -p icmpv6 -j ACCEPT  # Allow ipv6 route auto configuration if your provider support itip6tables -A USER_CUSTOM -p udp --dport 546 -j ACCEPTip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type router-advertisement -j ACCEPTip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type router-solicitation -j ACCEPTip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type neighbour-advertisement -j ACCEPTip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type neighbour-solicitation -j ACCEPT ip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type echo-request -j ACCEPTip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type echo-reply -j ACCEPT</p><p>#ï¼/bin/sh#ä»…å½“å®ƒç”¨äºæˆ‘ä»¬çš„ä¸»NIC[&#34ï¼›$iFace&#34ï¼›ï¼=&#34ï¼›enp1s0&#34ï¼›]|é€€å‡º0#ä»¥ä¾¿ä»Onlineè·å–IPv6ç§Ÿçº¦ã€‚netsysctl-w net.ipv6.conf.enp1s0.ept_ra=2#é‡ç½®æˆ‘ä»¬çš„è‡ªå®šä¹‰é“¾è¡¨-Pè¾“å…¥ACCEPTipables-D INPUT-j user_ã€‚N user_Custom#Allow Loopback Interfaceipables-A user_Custom-i lo-j Accept#Allow Wireguard Interfaceipables-A user_Custom-i wg0-j Accept#Allow Kubernetes InterfaceSipables-A user_Custom-I cni0-j ACCEPTipables-A user_Custom-I flannel.1-j Accept#Allow Allow Alternated ConnectionSapeipables-A user_Custom-p tcp-m Connail-ctc-ctcstate establishedï¼ŒRelated-j ACCEPTipables-A user_Custom-p UDP-m ConnTrack--ctstate establishedï¼ŒRelated-j ACCEPTipables-A user_Custom-p ICMP-m ConnTrack--ctstate establishedï¼ŒRelated-j Accept#Acceptä¼ å…¥ICMP-æœåŠ¡å™¨æä¾›ç¨‹åºä½¿ç”¨pingæ¥ç›‘è§†æœºå™¨è¯†åˆ«è¡¨-A user_Custom-p ICMP-j Accept#Allow sShipables-A user_Custom-p tcp--dport 22-j Accept#Allow http/Http-p TCP--dport 80-j ACCEPTipables-A user_Custom-p TCP--dport 443-j Accept#Allow SMTP and IMAPiptable-A user_Custom-p TCP--dport 443-j Accept#Allow SMTP and IMAPiptable-A user_Custom-p TCP--dport 443-j Accept#Allow SMTP and IMAPiptableã€‚#Allow wireguardiptable-A user_CUSTOM-p UDP--dport 995-j Accept#Allow Kubernetes k3S API serverables-A user_Custom-p tcp--dport 6443-j Accept#æ·»åŠ è‡ªå®šä¹‰é“¾æ¥è¡¨-iè¾“å…¥1-j user_Custom#å¦‚æœæ²¡æœ‰åŒ¹é…è¡¨-Pè¾“å…¥ä¸¢å¼ƒï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸¢å¼ƒä¼ å…¥æµé‡#IPv6#å¯¹ip6tableè€Œä¸æ˜¯iptabtableæ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚å¦‚æœæ‚¨çš„æä¾›å•†æ”¯æŒitip6table--A user_Custom-p UDP--dport 546-j ACCEPTip6ables--icmpv6-typeè·¯ç”±å™¨-advertisement-j ACCEPTip6table--icmpv6--A user_Custom-p icmpv6--icmpv6-type Router-Solication-j ACCEPTip6ables--A user_Custom-p icmpv6--icmpv6--icmpv6-typeè·¯ç”±å™¨-è¯·æ±‚-j ACCEPTip6ables--dport 546--j ACCEPTip6ables--icmpv6--icmpv6ã€‚A user_Custom-p icmpv6--icmpv6-type ECHO-REPLY-j Acceptã€‚</p><p> I don&#39;t rate limit ssh connections, as most of the time it is me that is hit by that limit. Nowadays most bot scanning ssh servers are smart enough to time their attempts to avoid being rate limited.Even if we are only allowing public key authentication, some bots are going to try endlessly to connect to our SSH server, in hope that someday a breach appears. Like waves crashing tirelessly on the shore.</p><p>æˆ‘ä¸ä¼šé™åˆ¶sshè¿æ¥çš„é€Ÿç‡ï¼Œå› ä¸ºå¤§å¤šæ•°æ—¶å€™æ˜¯æˆ‘å—åˆ°äº†è¿™ä¸ªé™åˆ¶ã€‚å¦‚ä»Šï¼Œå¤§å¤šæ•°åƒµå°¸æ‰«æsshæœåŠ¡å™¨éƒ½è¶³å¤Ÿèªæ˜ï¼Œèƒ½å¤Ÿè®¡æ—¶ä»¥é¿å…é€Ÿç‡å—é™ã€‚å³ä½¿æˆ‘ä»¬åªå…è®¸å…¬é’¥èº«ä»½éªŒè¯ï¼Œä¸€äº›åƒµå°¸ä¹Ÿä¼šæ²¡å®Œæ²¡äº†åœ°å°è¯•è¿æ¥åˆ°æˆ‘ä»¬çš„SSHæœåŠ¡å™¨ï¼Œå¸Œæœ›æœ‰ä¸€å¤©ä¼šå‡ºç°æ¼æ´ã€‚å°±åƒæµ·æµªä¸çŸ¥ç–²å€¦åœ°æ‹æ‰“ç€æµ·å²¸ã€‚</p><p>  -A USER_CUSTOM -p tcp -m conntrack --ctstate NEW --dport 22 -m recent --set --name SSH-A USER_CUSTOM -p tcp -m conntrack --ctstate NEW --dport 22 -m recent --update --seconds 60 --hitcount 4 --rttl --name SSH -j DROP-A USER_CUSTOM -p tcp -m conntrack --ctstate NEW --dport 22 -j ACCEPT</p><p>--A user_Custom-p tcp-m ConnTrack--ctstate new--dport 22-m recent--set--name SSH-A user_Custom-p tcp-m ConnTrack--ctstate new--dport 22-m recent--update--ç§’60--HitCount 4--rtl--name SSH-j drop--A user_Custom-p tcp-m ConnTrack--ctstate new--dport 22-j Accept</p><p> We are going to deploy those rules in the  if-pre-up to restore them automatically when the machine reboots. As those rules are idempotent we force their execution when invoked to be sure they are in place.</p><p>æˆ‘ä»¬å°†åœ¨if-pre-upä¸­éƒ¨ç½²è¿™äº›è§„åˆ™ï¼Œä»¥ä¾¿åœ¨æœºå™¨é‡æ–°å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤å®ƒä»¬ã€‚å› ä¸ºè¿™äº›è§„åˆ™æ˜¯å¹‚ç­‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è°ƒç”¨å®ƒä»¬æ—¶å¼ºåˆ¶æ‰§è¡Œå®ƒä»¬ï¼Œä»¥ç¡®ä¿å®ƒä»¬åˆ°ä½ã€‚</p><p>   Now that we have a server provisioned and a bit more secure, we want to assign it a cute DNS name instead of just its IP address.If you don&#39;t know what is a DNS please refer to :</p><p>ç°åœ¨æˆ‘ä»¬å·²ç»é…ç½®äº†æœåŠ¡å™¨ï¼Œå¹¶ä¸”å®‰å…¨æ€§æ›´é«˜äº†ï¼Œæˆ‘ä»¬æƒ³ä¸ºå®ƒåˆ†é…ä¸€ä¸ªå¯çˆ±çš„DNSåç§°ï¼Œè€Œä¸ä»…ä»…æ˜¯å®ƒçš„IPåœ°å€ã€‚å¦‚æœæ‚¨ä¸çŸ¥é“ä»€ä¹ˆæ˜¯DNSï¼Œè¯·å‚é˜…ï¼š</p><p>   I personally use  GANDI.net, as they provide free mailbox with a domain name. While I run a postfix/mail server on my server to receive and store emails, to avoid having to set up and manage a tedious DKIM I use GANDI SMTP mail server to send my emails and be trusted/not end up as spams. More on that later in setup your mail server.</p><p>æˆ‘ä¸ªäººä½¿ç”¨Gandi.netï¼Œå› ä¸ºä»–ä»¬æä¾›å¸¦æœ‰åŸŸåçš„å…è´¹é‚®ç®±ã€‚å½“æˆ‘åœ¨æœåŠ¡å™¨ä¸Šè¿è¡ŒPostfix/é‚®ä»¶æœåŠ¡å™¨æ¥æ¥æ”¶å’Œå­˜å‚¨ç”µå­é‚®ä»¶æ—¶ï¼Œä¸ºäº†é¿å…è®¾ç½®å’Œç®¡ç†ç¹ççš„DKIMï¼Œæˆ‘ä½¿ç”¨Gandi SMTPé‚®ä»¶æœåŠ¡å™¨æ¥å‘é€ç”µå­é‚®ä»¶ï¼Œå¹¶ä¸”è¢«ä¿¡ä»»/ä¸ä¼šæˆä¸ºåƒåœ¾é‚®ä»¶ã€‚åœ¨åé¢çš„è®¾ç½®é‚®ä»¶æœåŠ¡å™¨ä¸­å°†è¯¦ç»†ä»‹ç»è¿™ä¸€ç‚¹ã€‚</p><p>  Propagation should be fast enough (if you plan to use let&#39;s encrypt DNS challenge for wildcard)</p><p>ä¼ æ’­é€Ÿåº¦åº”è¯¥è¶³å¤Ÿå¿«(å¦‚æœæ‚¨è®¡åˆ’å¯¹é€šé…ç¬¦ä½¿ç”¨LETçš„åŠ å¯†DNSè´¨è¯¢)ã€‚</p><p>    This one is simple, just need to get the information of how to use the API of your registrar.For gandi, we will use their cli  gandi and manage our zone in a plain text file.</p><p>è¿™ä¸ªå¾ˆç®€å•ï¼Œåªéœ€è¦è·å–å¦‚ä½•ä½¿ç”¨æ³¨å†Œå•†çš„APIçš„ä¿¡æ¯ã€‚å¯¹äºç”˜è¿ªï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»–ä»¬çš„cli gandiï¼Œå¹¶ä»¥çº¯æ–‡æœ¬æ–‡ä»¶çš„å½¢å¼ç®¡ç†æˆ‘ä»¬çš„åŒºåŸŸã€‚</p><p>    @ 10800 IN SOA ns1.gandi.net. hostmaster.gandi.net. 1579092697 10800 3600 604800 10800@ 10800 IN A 195.154.119.61@ 10800 IN AAAA 2001:bc8:3d8f::cafe@ 10800 IN MX 1 mail.erebe.eu.@ 10800 IN MX 10 spool.mail.gandi.net.@ 10800 IN MX 50 fb.mail.gandi.net.api 10800 IN A 195.154.119.61api 10800 IN AAAA 2001:bc8:3d8f::cafe...</p><p>@10800åœ¨SOA ns1.gandi.netä¸­ã€‚Hostmaster.gandi.netã€‚1579092697 10800 3600 604800 10800@10800 in A 195.154.119.61@10800 in AAA2001ï¼šbc8ï¼š3d8fï¼šï¼šcae@10800 in MX 1 mail.erebe.eu.@10800 in MX 10 spool.mail.gandi.net@10800 in MX 50 fb.mail.gandi.net.api 10800 in A 195.154.119.61api 10800 in A 195.154.119.61api 10800 in AAA2001ï¼šbc8ï¼š3d8fï¼šï¼šcaeã€‚</p><p> Depending from your registrar, FAI and the TTL you set on your records, it can take quite some times for the new record to be propagated/updated everywhere, so be patient !</p><p>æ ¹æ®æ‚¨çš„æ³¨å†Œå•†ã€FAIå’Œæ‚¨åœ¨æ‚¨çš„è®°å½•ä¸Šè®¾ç½®çš„TTLï¼Œæ–°è®°å½•å¯èƒ½éœ€è¦ç›¸å½“é•¿çš„æ—¶é—´æ‰èƒ½ä¼ æ’­/æ›´æ–°åˆ°ä»»ä½•åœ°æ–¹ï¼Œæ‰€ä»¥è¯·è€å¿ƒç­‰å¾…ï¼</p><p>  We now have a server secured, with a domain name attached, and that we can re-deploy at ease.</p><p>æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªå®‰å…¨çš„æœåŠ¡å™¨ï¼Œé™„åŠ äº†åŸŸåï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°é‡æ–°éƒ¨ç½²ã€‚</p><p> The next step is to install Kubernetes on it. The choice of Kubernetes can be a bit controversial for only using it on a single machine. Kubernetes is a container orchestrator, so you can only leverage its full power when managing a fleet of servers.In addition, running vanilla Kubernetes require installing ETCD and other heavyweight components, plus some difficulties configuring every module for them to work correctly together.</p><p>ä¸‹ä¸€æ­¥æ˜¯åœ¨ä¸Šé¢å®‰è£…Kubernetesã€‚é€‰æ‹©Kuberneteså¯èƒ½ä¼šå¼•èµ·ä¸€äº›äº‰è®®ï¼Œå› ä¸ºå®ƒåªåœ¨ä¸€å°æœºå™¨ä¸Šä½¿ç”¨ã€‚Kubernetesæ˜¯ä¸€ä¸ªå®¹å™¨åè°ƒå™¨ï¼Œæ‰€ä»¥æ‚¨åªèƒ½åœ¨ç®¡ç†ä¸€ç»„æœåŠ¡å™¨æ—¶å……åˆ†åˆ©ç”¨å®ƒçš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼Œè¿è¡Œvanilla Kuberneteséœ€è¦å®‰è£…etcdå’Œå…¶ä»–é‡é‡çº§ç»„ä»¶ï¼Œä»¥åŠé…ç½®æ¯ä¸ªæ¨¡å—çš„ä¸€äº›å›°éš¾ï¼Œä»¥ä¾¿å®ƒä»¬èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚</p><p>  Meet  K3S, a trimmed and packaged Kubernetes cluster in a single binary. This prodigy is bought to us by rancher labs, one of the big player in the container operator world. They took the decision for you (replacing ETCD by SQLite, network overlay, load balancer, ...) in order for k3s to be the smaller possible and easy to setup, while being a 100% compliant Kubernetes cluster.</p><p>æ¥çœ‹çœ‹K3Sï¼Œå®ƒæ˜¯ä¸€ä¸ªç»è¿‡ä¿®å‰ªå’Œæ‰“åŒ…çš„åº“ä¼¯å†…æ–¯é›†ç¾¤(Kubernetes Cluster)ï¼ŒåŒ…å«åœ¨ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå¥‡è¿¹æ˜¯é›†è£…ç®±è¿è¥å•†ä¸–ç•Œä¸Šæœ€å¤§çš„å‚ä¸è€…ä¹‹ä¸€ç‰§åœºä¸»å®éªŒå®¤ä¹°ç»™æˆ‘ä»¬çš„ã€‚ä»–ä»¬ä¸ºæ‚¨åšå‡ºäº†å†³å®š(å°†etcdæ›¿æ¢ä¸ºSQLiteã€ç½‘ç»œè¦†ç›–ã€è´Ÿè½½å‡è¡¡å™¨ç­‰)ã€‚ä¸ºäº†ä½¿k3å°½å¯èƒ½æ›´å°ã€æ›´æ˜“äºè®¾ç½®ï¼ŒåŒæ—¶åˆæ˜¯100%å…¼å®¹çš„Kubernetesé›†ç¾¤ã€‚</p><p> The main benefit of having Kubernetes installed on my server, is that it allow me to have a standard interface for all my deployments, have everything store in git and allows me to leverage other tools like  skaffold when I am developing my projects.</p><p>åœ¨æˆ‘çš„æœåŠ¡å™¨ä¸Šå®‰è£…Kubernetesçš„ä¸»è¦å¥½å¤„æ˜¯ï¼Œå®ƒå…è®¸æˆ‘ä¸ºæ‰€æœ‰éƒ¨ç½²æä¾›ä¸€ä¸ªæ ‡å‡†ç•Œé¢ï¼Œå°†æ‰€æœ‰å†…å®¹å­˜å‚¨åœ¨Gitä¸­ï¼Œå¹¶å…è®¸æˆ‘åœ¨å¼€å‘é¡¹ç›®æ—¶åˆ©ç”¨å…¶ä»–å·¥å…·ï¼Œå¦‚skaffoldã€‚</p><p> Warning With everything installed, just having the Kubernetes server components running add a 10% CPU on my  Intel(R) Atom(TM) CPU C2338 @ 1.74GHz. So if you are already CPU bound, don&#39;t use it or scale up your server.</p><p>è­¦å‘Šï¼šå®‰è£…å®Œæ¯•åï¼Œä»…è¿è¡ŒKubernetesæœåŠ¡å™¨ç»„ä»¶å°±ä¼šåœ¨æˆ‘çš„è‹±ç‰¹å°”(R)Atom(TM)CPU C2338@1.74 GHzä¸Šå¢åŠ 10%çš„CPUã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨å·²ç»å—CPUé™åˆ¶ï¼Œè¯·ä¸è¦ä½¿ç”¨å®ƒæˆ–æ‰©å±•æ‚¨çš„æœåŠ¡å™¨ã€‚</p><p>  kubernetes_install: ssh  ${HOST}   &#39;export INSTALL_K3S_EXEC=&#34; --no-deploy servicelb --no-deploy traefik --no-deploy local-storage&#34;; \  curl -sfL https://get.k3s.io | sh - &#39;</p><p>KUBNETES_INSTALLï¼šssh${HOST}&#39ï¼›EXPORT INSTALL_K3S_EXEC=&#34ï¼›--ä¸éƒ¨ç½²æœåŠ¡b--ä¸éƒ¨ç½²traefik--ä¸-éƒ¨ç½²æœ¬åœ°å­˜å‚¨&#34ï¼›ï¼›\curl-sfl https://get.k3s.io|sh-&#39ï¼›</p><p>  servicelb Everything will live on the same machine, so there is no need to load balance, most of the time we are going to avoid the network overlay also, by using the host network directly as much as possible</p><p>Servicelbæ‰€æœ‰ä¸œè¥¿éƒ½å°†ä½äºåŒä¸€å°è®¡ç®—æœºä¸Šï¼Œå› æ­¤ä¸éœ€è¦è¿›è¡Œè´Ÿè½½å¹³è¡¡ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜å°†é€šè¿‡å°½å¯èƒ½ç›´æ¥ä½¿ç”¨ä¸»æœºç½‘ç»œæ¥é¿å…ç½‘ç»œè¦†ç›–ã€‚</p><p> traefik I have more experience with Nginx/HAProxy for reverse-proxy, so I am going to use nginx ingress controller in place of Traefik</p><p>Traefikæˆ‘æœ‰æ›´å¤šä½¿ç”¨nginx/HAProxyè¿›è¡Œåå‘ä»£ç†çš„ç»éªŒï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—ä½¿ç”¨nginxå…¥å£æ§åˆ¶å™¨æ¥ä»£æ›¿Traefikã€‚</p><p> local-storage this application is for creating automatically local volume (PV) for your hosts, as we have only one machine, we will bypass this complexity and just use  HostPath volume</p><p>æœ¬åœ°å­˜å‚¨æ­¤åº”ç”¨ç¨‹åºç”¨äºè‡ªåŠ¨ä¸ºæ‚¨çš„ä¸»æœºåˆ›å»ºæœ¬åœ°å·(PV)ï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€å°è®¡ç®—æœºï¼Œæˆ‘ä»¬å°†ç»•è¿‡è¿™ä¸€å¤æ‚æ€§ï¼Œåªä½¿ç”¨HostPathå·</p><p>   and check that your server is in Ready state (it can take some time). If it is the case, congrats ! You have a Kubernetes control plane working !</p><p>å¹¶æ£€æŸ¥æ‚¨çš„æœåŠ¡å™¨æ˜¯å¦å¤„äºå°±ç»ªçŠ¶æ€(å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´)ã€‚å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œæ­å–œä½ ï¼ä½ æœ‰ä¸€æ¶åº“ä¼¯å†…æ–¯æ§åˆ¶æœºåœ¨å·¥ä½œï¼</p><p> Now that this is done, we need to automate the setup of the kubeconfig installation.</p><p>ç°åœ¨å·²ç»å®Œæˆäº†è¿™é¡¹å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦è‡ªåŠ¨è®¾ç½®kubeconfigå®‰è£…ã€‚</p><p> On your server copy the content of the kube config file  /etc/rancher/k3s/k3s.yaml and encrypt it with sops under  secrets/kubernetes-config.yml.  Be sure to Replace 127.0.0.1 in the config by the ip/domain name of your server.</p><p>åœ¨æ‚¨çš„æœåŠ¡å™¨ä¸Šï¼Œå¤åˆ¶Kubeé…ç½®æ–‡ä»¶/etc/rancher/k3s/k3s.yamlçš„å†…å®¹ï¼Œå¹¶ä½¿ç”¨secrets/Kubernetes-config.ymlä¸‹çš„sopå¯¹å…¶è¿›è¡ŒåŠ å¯†ã€‚è¯·ç¡®ä¿å°†é…ç½®ä¸­çš„127.0.0.1æ›¿æ¢ä¸ºæœåŠ¡å™¨çš„IP/åŸŸåã€‚</p><p>   If you made things correctly and that you have kubectl installed on your local machine, you should be able to do a</p><p>å¦‚æœæ‚¨æ­£ç¡®åœ°è¿›è¡Œäº†æ“ä½œï¼Œå¹¶ä¸”åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šå®‰è£…äº†kubectlï¼Œåˆ™åº”è¯¥èƒ½å¤Ÿæ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚</p><p>    I have many small pet projects exposing an HTTP endpoint that I want to expose to the rest of the internet, as I have blocked every ingoing traffic other than for port 80 and 443, I need to multiplex every application under those two. For that I need to install a reverse proxy that will also do TLS termination.</p><p>æˆ‘æœ‰è®¸å¤šå–œæ¬¢çš„å°é¡¹ç›®ï¼Œå®ƒä»¬å…¬å¼€äº†ä¸€ä¸ªæˆ‘æƒ³è¦å‘Internetå…¶ä½™éƒ¨åˆ†å…¬å¼€çš„HTTPç«¯ç‚¹ï¼Œå› ä¸ºæˆ‘å·²ç»é˜»æ­¢äº†ç«¯å£80å’Œ443ä»¥å¤–çš„æ‰€æœ‰ä¼ å…¥æµé‡ï¼Œå› æ­¤æˆ‘éœ€è¦å¤šè·¯ä¼ è¾“è¿™ä¸¤ä¸ªç«¯å£ä¸‹çš„æ¯ä¸ªåº”ç”¨ç¨‹åºã€‚ä¸ºæ­¤ï¼Œæˆ‘éœ€è¦å®‰è£…ä¸€ä¸ªåå‘ä»£ç†ï¼Œä¹Ÿå°†åšTLSç»ˆæ­¢ã€‚</p><p> As I have disabled Traefik, the default reverse-proxy, during the k3s installation, I need to install my own. My choice went to Nginx. I know it well with HaProxy, knows it is reliable and it is the most mature between the two on Kubernetes.</p><p>ç”±äºæˆ‘åœ¨k3så®‰è£…æœŸé—´ç¦ç”¨äº†é»˜è®¤çš„åå‘ä»£ç†Traefikï¼Œæ‰€ä»¥æˆ‘éœ€è¦å®‰è£…æˆ‘è‡ªå·±çš„ã€‚æˆ‘é€‰æ‹©äº†æ©å‰å…‹æ–¯ã€‚æˆ‘éå¸¸äº†è§£HaProxyï¼ŒçŸ¥é“å®ƒæ˜¯å¯é çš„ï¼Œä¹Ÿæ˜¯Kubernetesä¸Šä¸¤è€…ä¸­æœ€æˆç†Ÿçš„ã€‚</p><p> To install it on your K3s cluster either use the Helm chart or directly with a kube apply. Refer for the installation guide for  baremetal</p><p>è¦å°†å…¶å®‰è£…åˆ°æ‚¨çš„K3Sé›†ç¾¤ä¸Šï¼Œå¯ä»¥ä½¿ç”¨Helmå›¾è¡¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨Kubeåº”ç”¨ã€‚è¯·å‚é˜…è£¸æœºå®‰è£…æŒ‡å—ã€‚</p><p> WARNING: Don&#39;t copy-paste directly from the documentation nginx-ingress annotations, the &#39;-&#39; is not a real &#39;-&#39; and your annotation will not be recognized  ğŸ¤¦</p><p>è­¦å‘Šï¼šè¯·å‹¿ç›´æ¥ä»æ–‡æ¡£ngix-inressæ‰¹æ³¨å¤åˆ¶ç²˜è´´ï¼Œè¯¥æ‰¹æ³¨ä¸æ˜¯çœŸæ­£çš„æ‰¹æ³¨ï¼Œæ‚¨çš„æ‰¹æ³¨å°†æ— æ³•è¯†åˆ«ğŸ¤¦ã€‚</p><p>    I am going also to edit the deployment in order for the Nginx reverse proxy to use  HostNetwork and avoid going thought the network overlay.In the above YAML file, replace DNS policy value by  ClusterFirstWithHostNet and add a new entry  hostNetwork: true for the container to use directly your network card instead of a virtual interface.</p><p>æˆ‘è¿˜å°†ç¼–è¾‘éƒ¨ç½²ï¼Œä»¥ä¾¿Nginxåå‘ä»£ç†ä½¿ç”¨HostNetworkå¹¶é¿å…é€šè¿‡ç½‘ç»œè¦†ç›–ã€‚åœ¨ä¸Šé¢çš„YAMLæ–‡ä»¶ä¸­ï¼Œå°†DNSç­–ç•¥å€¼æ›¿æ¢ä¸ºClusterFirstWithHostNetï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæ–°æ¡ç›®hostNetworkï¼štrueï¼Œä»¥ä¾¿å®¹å™¨ç›´æ¥ä½¿ç”¨æ‚¨çš„ç½‘å¡è€Œä¸æ˜¯è™šæ‹Ÿæ¥å£ã€‚</p><p>  If you are using the helm chart, there is a variable/flag to toggle the usage of host network.Save your YAML file in your repo</p><p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯èˆµå›¾ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªå˜é‡/æ ‡å¿—æ¥åˆ‡æ¢ä¸»æœºç½‘ç»œçš„ä½¿ç”¨æƒ…å†µã€‚å°†YAMLæ–‡ä»¶ä¿å­˜åœ¨æ‚¨çš„èµ„æºåº“ä¸­ã€‚</p><p>......</p><p>.</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/erebe/personal-server/blob/master/README.md">https://github.com/erebe/personal-server/blob/master/README.md</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/2020/">#2020</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ç®¡ç†/">#ç®¡ç†</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/personnal/">#personnal</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1033261.html"><img src="http://img2.diglog.com/img/2020/11/thumb_3757f085c3829baa1f2757fbabdda308.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033261.html">2020å¹´æ°‘è°ƒæƒ¨è´¥çš„åŸå› å¾ˆç®€å•</a></div><span class="my_story_list_date">2020-11-5 20:0</span></div><div class="col-sm"><div><a target="_blank" href="/story/1033238.html"><img src="http://img2.diglog.com/img/2020/11/thumb_8558cc48d118c1527ddf864ef6921a02.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033238.html">
TCè¯¾ç¨‹æä¾›å­¦ç”Ÿä¼˜æƒ åˆ¸ï¼šSpace 2020</a></div><span class="my_story_list_date">2020-11-5 17:24</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032986.html"><img src="http://img2.diglog.com/img/2020/11/thumb_b611b9f380586a2db7f0182f8e5a697b.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032986.html">
æœ‰æ²¡æœ‰åˆé€‚çš„ä¸œè¥¿ï¼Ÿåœ¨TCä¼šè®®ä¸Šå±•ç¤ºå’Œæ¨ä»‹ï¼šSpace 2020</a></div><span class="my_story_list_date">2020-11-3 23:31</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032983.html"><img src="http://img2.diglog.com/img/2020/11/thumb_a2cc3137e4ee29dcbb58282675d87469.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032983.html">
é‡‘èç§‘æŠ€é£é™©æŠ•èµ„åœ¨2020å¹´ç¬¬ä¸‰å­£åº¦çš„4ä¸ªæ”¶è·</a></div><span class="my_story_list_date">2020-11-3 23:3</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¾å›½/">#ç¾å›½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è°·æ­Œ/">#è°·æ­Œ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¨‹åº/">#ç¨‹åº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>