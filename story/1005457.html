<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我们使用HashiCorp Nomad</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">我们使用HashiCorp Nomad</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-06 23:39:03</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/6/98d4f3097fc60ec58df2443c8103fabc.png"><img src="http://img.diglog.com/img/2020/6/98d4f3097fc60ec58df2443c8103fabc.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>在这篇博客文章中，我们将带您了解在全球200多个边缘城市运行的服务的可靠性模型。然后，我们将介绍部署新的动态任务调度系统HashiCorp Nomad如何帮助我们提高每个数据中心的服务可用性，包括我们如何部署Nomad以及我们在此过程中克服的挑战。最后，我们将向您展示我们目前如何使用Nomad，以及我们计划如何在未来使用它。</p><p>对于这篇博客文章，我们将区分每个数据中心中运行的两种不同类别的服务：</p><p>面向客户的服务：我们客户使用的所有堆栈产品，如缓存、网站管家、DDoS防护、限速、负载均衡等。</p><p>管理服务：运行数据中心所需的软件，不在客户流量的直接请求路径中。</p><p>我们面向客户的服务的可靠性模型是在每个数据中心的所有机器上运行它们。这很有效，因为它允许通过添加更多机器来动态扩展每个数据中心的容量。</p><p>由于我们在每台机器上运行的动态负载平衡系统Unimog，扩展变得特别容易。它的作用是根据当前资源使用情况不断重新平衡流量，并检查服务的运行状况。这有助于提供对单个机器故障的恢复能力，并确保所有机器上的资源使用率几乎相同。</p><p>例如，这里是我们的一个数据中心一天的CPU使用率，其中每个时间序列代表一台机器，不同的颜色代表不同代的硬件。Unimog使所有处理流量的机器保持大致相同的CPU利用率。</p><p>我们的一些大型数据中心拥有大量机器，但有时我们需要在每个位置可靠地运行管理服务的单个或几个实例。</p><p>目前有几个选项可以做到这一点，每个选项都有自己的优缺点：</p><p>将服务部署到数据中心的所有计算机：缺点：它不必要地使用了本可以用于服务客户流量的资源，而且不划算。</p><p>将服务部署到每个数据中心的几台静态计算机上：缺点：当这些几台计算机意外故障时，它会面临服务不可用的风险。</p><p>第三个更可行的选择是使用动态任务调度，以便在确保可靠性的同时只使用适量的资源。</p><p>对于我们希望在每个数据中心运行的管理服务，必须在两个不太理想的可靠性模型选项之间进行选择，这并不理想。</p><p>事实上，其中一些服务，即使它们不在请求路径中，也需要继续运行数据中心。如果运行这些服务的计算机变得不可用，在某些情况下，我们必须在恢复它们时临时禁用数据中心。这样做会自动将用户重新路由到下一个可用的数据中心，并且不会造成中断。事实上，整个Cloudflare网络设计为在数据中心被禁用和自动恢复的情况下运行。但是，最好将最终用户路由到他们附近的数据中心，因此我们希望最大限度地减少任何数据中心级别的停机时间。</p><p>这让我们意识到，我们需要一个系统来确保在每个数据中心中运行一定数量的服务实例，而不管最终运行该服务的是哪台物理机。</p><p>面向客户的服务在每个数据中心的所有机器上运行，不需要登录到该新系统。另一方面，当前在具有次优可靠性保证的固定机器子集上运行的服务和不需要在所有机器上运行的服务都是很好的入职候选。</p><p>虽然Kubernetes是另一个选择，但我们决定使用HashiCorp的Nomad，原因如下：</p><p>满足了我们最初的要求，即在每个数据中心可靠地运行资源隔离的二进制文件的单个实例。</p><p>几乎没有依赖关系，并且与领事直接集成。Consul是我们已经在每个数据中心部署的另一款HashiCorp软件。它提供分布式键值存储和服务发现功能。</p><p>轻量级(一站式二进制)，易于部署和调配新群集，这在部署与我们拥有的数据中心一样多的群集时是一个优势。</p><p>具有模块化任务驱动程序(部分负责执行任务和提供资源隔离)架构，不仅支持容器，还支持二进制文件和任何自定义任务驱动程序。</p><p>是开源的，并且是用Go编写的。我们在团队中有围棋语言的经验，而且Nomad在GitHub上有一个响应迅速的维护人员社区。</p><p>Nomad Server：组成集群的实例负责调度，每个数据中心5个，以提供足够的容错能力。</p><p>Nomad Client：执行实际任务的实例，在每个数据中心的所有机器上运行</p><p>为了保证Nomad Server集群的可靠性，我们在属于不同故障域的计算机上部署了实例：</p><p>在不同的多节点机箱中(我们的大多数边缘硬件都以多节点机箱的形式提供，一个机箱包含四个单独的服务器)。</p><p>我们还向我们的配置管理工具添加了逻辑，以确保我们始终保持一致数量的Nomad Server实例，而不管服务器几乎每天都在进行扩展和退役。</p><p>逻辑相当简单，随着服务器扩展和退役的发生，Nomad Server角色被重新分配到新的机器列表。然后，我们的配置管理工具确保Nomad Server在旧机器上关闭之前在新机器上运行。</p><p>此外，由于服务器扩展和退役一次影响机架的一个子集，并且Nomad Server角色分配逻辑提供机架多样性保证，因此群集始终保持正常运行。</p><p>Nomad作业文件被模板化并签入到git存储库中。然后，我们的配置管理工具可确保在每个数据中心安排作业。从那时起，Nomad将接管并确保作业在每个数据中心的所有时间都在运行。</p><p>通过向每个Nomad客户端公开机架元数据，我们能够确保特定服务的每个实例在不同的机架上运行，并且绑定到不同的故障域。这样，我们可以确保一个服务器机架的故障不会影响服务运行状况，因为服务也在不同的机架上运行，不受故障的影响。</p><p>我们利用Nomad与Consul的集成将Nomad作业动态添加到Consul Service Catalog。这允许我们通过查询Consul来发现特定服务当前在每个数据中心的何处运行。此外，启用Consul DNS接口后，我们还可以使用基于DNS的查找来定位在Nomad上运行的服务。</p><p>为了能够正确运行与我们拥有的数据中心一样多的Nomad集群，在这些集群上运行的Nomad集群和服务上具有良好的可观察性是至关重要的。</p><p>我们使用普罗米修斯抓取每个数据中心中运行的Nomad Server和客户端实例，并使用AlertManager对关键指标发出警报。使用普罗米修斯指标，我们构建了Grafana仪表板来提供每个集群的可见性。</p><p>我们设置Prometheus实例以发现在Nomad上运行的服务，方法是使用以下Prometheus配置查询Consul Service Directory并定期抓取它们的指标：</p><p>-consul_sd_configs：-server：localhost：8500作业名称：management_service_via_consul reabel_configs：-action：Keep regex：management-service source_labels：-__META_CONSUL_SERVICE。</p><p>然后，我们使用这些指标来创建Grafana仪表板，并为在Nomad上运行的服务设置警报。</p><p>为了限制对Nomad API端点的访问，我们启用了相互TLS身份验证，并为与Nomad交互的每个实体生成客户端证书。这样，只有拥有有效客户端证书的实体才能与Nomad API端点交互，以便安排作业或执行任何CLI操作。</p><p>部署新组件总是伴随着一系列挑战；下面列出了我们在此过程中必须克服的几个障碍。</p><p>当开始使用exec驱动程序运行chroot环境中隔离的二进制文件时，我们注意到在initramfs上运行的无状态根分区不受支持，因为任务不会启动，并且我们在日志中收到以下错误消息：</p><p>2月12日19：49：03机器游牧-客户端[258433]：2020-02-12T19：49：03.332Z[错误]client.alloc_runner.task_runner：运行驱动程序失败：alloc_id=fa202-63b-33f-924-42cbd5 task=server error=&#34；无法使用Executor启动命令：rpc错误：code=未知desc=CONTAINER_linux.go：346：启动容器进程导致&。PIVOT_ROOT无效参数\&#34；\&#34；&#34；&#34；</p><p>我们提交了GitHub问题并提交了变通拉取请求，该请求被及时审查并合并到上游。</p><p>同时，为了最大限度地提高隔离安全性，我们通过修改引导过程在我们的设置中启用了PIVOT_ROOT，其他团队成员开发并提出了内核邮件列表的补丁，以使其在将来更容易实现。</p><p>一个非常重要的方面是确保在Nomad上运行的任务的资源使用不会中断同一台机器上托管的其他服务。</p><p>磁盘空间是每台机器上的共享资源，必须能够为Nomad设置配额。我们通过将Nomad数据目录隔离到每台机器上的专用固定大小挂载点来实现这一点。但是，Nomad目前不支持开箱即用的磁盘带宽和IOPS限制。</p><p>Nomad作业文件有一个可以限制内存和CPU使用的资源部分(内存以MB为单位，CPU以MHz为单位)：</p><p>这在幕后使用cgroup，我们的测试表明，虽然内存限制是按照预期实施的，但CPU限制是软限制，只要主机上有可用的CPU，就不会强制实施。</p><p>如上所述，所有机器当前都运行相同的面向客户的工作负载。使用Nomad动态调度单个作业以在单机上运行，挑战了这一假设。</p><p>虽然我们的动态负载平衡系统Unimog会根据资源使用情况平衡请求，以确保它在所有机器上几乎相同，但是资源使用高峰的批处理类型作业可能会带来挑战。</p><p>确保Unimog调整以适应此批处理类型的工作负载，并且不会最终陷入正反馈循环。</p><p>现在，每个数据中心都部署了Nomad，我们能够通过逐步自注册来提高运营所必需的管理服务的可靠性。我们迈出了第一步，加入了我们的重启和维护管理服务。</p><p>在每个数据中心，我们都运行一项服务，促进机器的在线无人值守滚动重启和维护。此服务过去在每个数据中心的一台知名计算机上运行。这使得它容易受到单机故障的影响，并且在停机时会阻止计算机在重新启动后自动启用。因此，登上Nomad以提高其可靠性是一项伟大的第一项服务。</p><p>我们现在可以保证此服务在每个数据中心始终运行，而不受单个机器故障的影响。现在，其他机器不再依赖于众所周知的地址来定位此服务，而是查询Consul DNS并动态计算出服务正在运行的位置以与其交互。</p><p>就这项服务的可靠性而言，这是一个很大的改进，因此，在接下来的几个月里，预计会有更多的管理服务相继出现，我们对此感到非常兴奋。</p><p>边缘可靠性可用性游牧调度</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.cloudflare.com/how-we-use-hashicorp-nomad">https://blog.cloudflare.com/how-we-use-hashicorp-nomad</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/hashicorp/">#hashicorp</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/nomad/">#nomad</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>