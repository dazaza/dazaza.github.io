<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>ä½¿ç”¨Rustä¸º1100ä¸‡å¹¶å‘ç”¨æˆ·æ‰©å±•Elixir</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">ä½¿ç”¨Rustä¸º1100ä¸‡å¹¶å‘ç”¨æˆ·æ‰©å±•Elixir</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-11 08:32:49</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/d8a50e934080e1cb6b2fa8ece56296f9.png"><img src="http://img2.diglog.com/img/2020/11/d8a50e934080e1cb6b2fa8ece56296f9.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Over the last year, the Backend Infrastructure team at Discord was hard at work improving the scalability and performance of our core real-time communications infrastructure.</p><p>åœ¨è¿‡å»çš„ä¸€å¹´é‡Œï¼ŒDiscordeçš„åç«¯åŸºç¡€è®¾æ–½å›¢é˜Ÿä¸€ç›´åœ¨åŠªåŠ›æé«˜æˆ‘ä»¬æ ¸å¿ƒå®æ—¶é€šä¿¡åŸºç¡€è®¾æ–½çš„å¯æ‰©å±•æ€§å’Œæ€§èƒ½ã€‚</p><p> One big project we undertook was changing how we update the Member List (all those nifty people on the right side of the screen). Instead of sending updates for every single person in the Member List, we could just send down the updates for the visible portion of the Member List. This has obvious benefits such as less network traffic, less CPU usage, better battery life; the list goes on and on.</p><p>æˆ‘ä»¬æ‰¿æ‹…çš„ä¸€ä¸ªå¤§é¡¹ç›®æ˜¯æ”¹å˜æˆ‘ä»¬æ›´æ–°ä¼šå‘˜åˆ—è¡¨çš„æ–¹å¼(å±å¹•å³ä¾§æ‰€æœ‰æ¼‚äº®çš„äºº)ã€‚æˆ‘ä»¬ä¸éœ€è¦ä¸ºæˆå‘˜åˆ—è¡¨ä¸­çš„æ¯ä¸ªäººå‘é€æ›´æ–°ï¼Œåªéœ€å‘ä¸‹å‘é€æˆå‘˜åˆ—è¡¨ä¸­å¯è§éƒ¨åˆ†çš„æ›´æ–°å³å¯ã€‚è¿™æœ‰æ˜æ˜¾çš„å¥½å¤„ï¼Œæ¯”å¦‚æ›´å°‘çš„ç½‘ç»œæµé‡ï¼Œæ›´å°‘çš„CPUä½¿ç”¨é‡ï¼Œæ›´é•¿çš„ç”µæ± ç»­èˆªæ—¶é—´ï¼›ä¸èƒœæšä¸¾ã€‚</p><p> However, this posed one big problem on the server side: We needed a data structure capable of holding hundreds of thousands of entries, sorted in a particular way that can accept and process tons of mutations, and can report back indices of where things are being added and removed.</p><p>ç„¶è€Œï¼Œè¿™ç»™æœåŠ¡å™¨ç«¯å¸¦æ¥äº†ä¸€ä¸ªå¤§é—®é¢˜ï¼šæˆ‘ä»¬éœ€è¦ä¸€ç§èƒ½å¤Ÿå®¹çº³æ•°åä¸‡ä¸ªæ¡ç›®çš„æ•°æ®ç»“æ„ï¼Œä»¥ä¸€ç§ç‰¹æ®Šçš„æ–¹å¼è¿›è¡Œæ’åºï¼Œå¯ä»¥æ¥å—å’Œå¤„ç†å¤§é‡çš„çªå˜ï¼Œå¹¶ä¸”å¯ä»¥è¿”å›æ·»åŠ å’Œåˆ é™¤å†…å®¹çš„ç´¢å¼•ã€‚</p><p> Elixir is a functional language; its data structures are immutable. This is great for reasoning about code and supporting the massive concurrency you enjoy when you write Elixir. The double-edged sword of immutable data structures is that mutations are modeled by taking an existing data structure and an operation and creating a brand new data structure that is the result of applying that operation to the existing data structure.</p><p>ELXIRæ˜¯ä¸€ç§å‡½æ•°å¼è¯­è¨€ï¼›å®ƒçš„æ•°æ®ç»“æ„æ˜¯ä¸å¯å˜çš„ã€‚è¿™å¯¹äºä»£ç æ¨ç†å’Œæ”¯æŒæ‚¨åœ¨ç¼–å†™Elixiræ—¶äº«å—åˆ°çš„å¤§è§„æ¨¡å¹¶å‘æ€§éå¸¸æœ‰ç”¨ã€‚ä¸å¯å˜æ•°æ®ç»“æ„çš„åŒåˆƒå‰‘æ˜¯ï¼Œçªå˜æ˜¯é€šè¿‡é‡‡ç”¨ç°æœ‰æ•°æ®ç»“æ„å’Œæ“ä½œå¹¶åˆ›å»ºå…¨æ–°çš„æ•°æ®ç»“æ„æ¥å»ºæ¨¡çš„ï¼Œè¯¥æ•°æ®ç»“æ„æ˜¯å°†è¯¥æ“ä½œåº”ç”¨äºç°æœ‰æ•°æ®ç»“æ„çš„ç»“æœã€‚</p><p> This meant that when someone joined a server â€” internally referred to as guilds â€” with a Member List of 100,000 members, we would have to build a new list with 100,001 members in it. The BEAM VM is pretty speedy and  getting faster everyday. It tries to take advantage of  persistent data structures where it can, but at the scale we operate, these large lists could not be updated fast enough.</p><p>è¿™æ„å‘³ç€ï¼Œå½“æŸäººåŠ å…¥ä¸€ä¸ªæ‹¥æœ‰10ä¸‡åæˆå‘˜çš„æœåŠ¡å™¨(å†…éƒ¨ç§°ä¸ºè¡Œä¼š)æ—¶ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸æ„å»ºä¸€ä¸ªåŒ…å«100,001åæˆå‘˜çš„æ–°åˆ—è¡¨ã€‚BEAM VMé€Ÿåº¦ç›¸å½“å¿«ï¼Œè€Œä¸”æ¯å¤©éƒ½åœ¨å˜å¾—æ›´å¿«ã€‚å®ƒè¯•å›¾åœ¨å¯èƒ½çš„æƒ…å†µä¸‹åˆ©ç”¨æŒä¹…æ•°æ®ç»“æ„ï¼Œä½†åœ¨æˆ‘ä»¬è¿è¥çš„è§„æ¨¡ä¸Šï¼Œè¿™äº›å¤§å‹åˆ—è¡¨çš„æ›´æ–°é€Ÿåº¦è¿˜ä¸å¤Ÿå¿«ã€‚</p><p>  Two engineers took up the challenge of making a pure Elixir data structure that could hold large sorted sets and support fast mutation operations. This is easier said than done, so letâ€™s put on our Computer Science helmets and go spelunking into the caves of data structure design.</p><p>ä¸¤åå·¥ç¨‹å¸ˆæ¥å—äº†æŒ‘æˆ˜ï¼Œåˆ¶é€ å‡ºä¸€ç§çº¯ç²¹çš„ä¸‡çµä¸¹æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥å®¹çº³å¤§çš„æ’åºé›†ï¼Œå¹¶æ”¯æŒå¿«é€Ÿå˜å¼‚æ“ä½œã€‚è¿™è¯´èµ·æ¥å®¹æ˜“åšèµ·æ¥éš¾ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æˆ´ä¸Šè®¡ç®—æœºç§‘å­¦çš„å¤´ç›”ï¼Œæ·±å…¥æ•°æ®ç»“æ„è®¾è®¡çš„æ´ç©´ã€‚</p><p> Elixir ships with a set implementation called MapSet. MapSet is a general purpose data structure built on top of the Map data structure. Itâ€™s useful for lots of Set operations, but it provides no guarantees around ordering, which is a key requirement for the Member List. This pretty much ruled out MapSet as a contender.</p><p>ELXIRé™„å¸¦ä¸€ä¸ªåä¸ºMapSetçš„Setå®ç°ã€‚MapSetæ˜¯å»ºç«‹åœ¨Mapæ•°æ®ç»“æ„ä¹‹ä¸Šçš„é€šç”¨æ•°æ®ç»“æ„ã€‚å®ƒå¯¹è®¸å¤šé›†åˆæ“ä½œå¾ˆæœ‰ç”¨ï¼Œä½†æ˜¯å®ƒä¸èƒ½ä¿è¯æ’åºï¼Œè€Œæ’åºæ˜¯æˆå‘˜åˆ—è¡¨çš„ä¸€ä¸ªå…³é”®è¦æ±‚ã€‚è¿™å‡ ä¹æ’é™¤äº†MapSetä½œä¸ºç«äº‰è€…çš„å¯èƒ½æ€§ã€‚</p><p> Next up would be the venerable List type: wrap the List with a helper that would enforce uniqueness and sort the list after insertion of new elements. A quick benchmark of this approach shows that for small lists â€” 5,000 elementsâ€” insertion time was measured between 500ğœ‡s and 3,000ğœ‡s. This was already far too slow to be viable.</p><p>æ¥ä¸‹æ¥æ˜¯ä»¤äººæ•¬ç•çš„åˆ—è¡¨ç±»å‹ï¼šä½¿ç”¨å¸®åŠ©å™¨åŒ…è£…åˆ—è¡¨ï¼Œè¯¥å¸®åŠ©å™¨å°†å¼ºåˆ¶å”¯ä¸€æ€§ï¼Œå¹¶åœ¨æ’å…¥æ–°å…ƒç´ åå¯¹åˆ—è¡¨è¿›è¡Œæ’åºã€‚è¿™ç§æ–¹æ³•çš„ä¸€ä¸ªå¿«é€ŸåŸºå‡†æ˜¾ç¤ºï¼Œå¯¹äº5,000ä¸ªå…ƒç´ çš„å°åˆ—è¡¨ï¼Œæ’å…¥æ—¶é—´åœ¨500ğœ‡såˆ°3,000ğœ‡sä¹‹é—´æµ‹é‡ã€‚è¿™å·²ç»å¤ªæ…¢äº†ï¼Œæ— æ³•å®ç°ã€‚</p><p> Even worse, the performance of insertion scaled with size of list and depth of position in the list. Worst case that was benchmarked was adding a new element to the end of a 250,000 item list, which came in around 170,000ğœ‡s: basically an eternity.</p><p>æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæ’å…¥çš„æ€§èƒ½éšåˆ—è¡¨çš„å¤§å°å’Œåœ¨åˆ—è¡¨ä¸­çš„ä½ç½®æ·±åº¦è€Œå˜åŒ–ã€‚æœ€ç³Ÿç³•çš„æƒ…å†µæ˜¯åœ¨250,000ä¸ªé¡¹ç›®åˆ—è¡¨çš„æœ«å°¾æ·»åŠ ä¸€ä¸ªæ–°å…ƒç´ ï¼Œè¿™ä¸ªåˆ—è¡¨å¤§çº¦æœ‰170,000ä¸ªğœ‡ï¼šåŸºæœ¬ä¸Šæ˜¯æ°¸æ’çš„ã€‚</p><p>   Erlang ships with a module called ordsets. Ordsets are Ordered Sets, so sounds like we found the solution to our problem: Letâ€™s break out the benchmarking to check for viability. When the list is small the performance looks pretty great measuring between 0.008ğœ‡s and 288ğœ‡s. Sadly, when the size tested was increased to 250,000 worst-case performance increased to 27,000ğœ‡s, which was five times faster than our custom List implementation but still not fast enough.</p><p>Erlangé™„å¸¦äº†ä¸€ä¸ªåä¸ºordsetsçš„æ¨¡å—ã€‚Ordsetæ˜¯æœ‰åºé›†ï¼Œæ‰€ä»¥å¬èµ·æ¥æˆ‘ä»¬æ‰¾åˆ°äº†é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼šè®©æˆ‘ä»¬æ‰“ç ´åŸºå‡†æµ‹è¯•æ¥æ£€æŸ¥å¯è¡Œæ€§ã€‚å½“åˆ—è¡¨å¾ˆå°æ—¶ï¼Œæ€§èƒ½çœ‹èµ·æ¥ç›¸å½“ä¸é”™ï¼Œä»‹äº0.008ğœ‡å’Œ288ğœ‡ä¹‹é—´ã€‚é—æ†¾çš„æ˜¯ï¼Œå½“æµ‹è¯•çš„å¤§å°å¢åŠ åˆ°250,000æ—¶ï¼Œæœ€åæƒ…å†µä¸‹çš„æ€§èƒ½ä¼šå¢åŠ åˆ°27,000ğœ‡ï¼Œè¿™æ¯”æˆ‘ä»¬çš„è‡ªå®šä¹‰åˆ—è¡¨å®ç°å¿«äº†äº”å€ï¼Œä½†ä»ç„¶ä¸å¤Ÿå¿«ã€‚</p><p> Having exhausted all the obvious candidates that come with the language, a cursory search of packages was done to see if someone else had already solved and open sourced the solution to this problem. A few packages were checked, but none of them provided the properties and performance required. Thankfully, the field of Computer Science has been optimizing algorithms and data structures for storing and sorting data for the last 60 years, so there were plenty of ideas about how to proceed.</p><p>åœ¨ç”¨å°½äº†è¯¥è¯­è¨€é™„å¸¦çš„æ‰€æœ‰æ˜æ˜¾çš„å€™é€‰ç¨‹åºä¹‹åï¼Œæˆ‘ä»¬ç²—ç•¥åœ°æœç´¢äº†ä¸€ä¸‹åŒ…ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰äººå·²ç»è§£å†³äº†è¿™ä¸ªé—®é¢˜å¹¶å°†å…¶å¼€æºã€‚æ£€æŸ¥äº†å‡ ä¸ªåŒ…ï¼Œä½†å®ƒä»¬éƒ½æ²¡æœ‰æä¾›æ‰€éœ€çš„å±æ€§å’Œæ€§èƒ½ã€‚å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œåœ¨è¿‡å»çš„60å¹´é‡Œï¼Œè®¡ç®—æœºç§‘å­¦é¢†åŸŸä¸€ç›´åœ¨ä¼˜åŒ–å­˜å‚¨å’Œæ’åºæ•°æ®çš„ç®—æ³•å’Œæ•°æ®ç»“æ„ï¼Œå› æ­¤æœ‰å¾ˆå¤šå…³äºå¦‚ä½•ç»§ç»­è¿›è¡Œçš„æƒ³æ³•ã€‚</p><p>  The ordsets perform extremely well at small sizes. Maybe there was some way that we could chain a bunch of very small ordsets together and quickly access the correct one when accessing a particular position. If you turn your head sideways and squint real hard, this starts to look like a  Skip List, which is exactly what was implemented.</p><p>åœ¨å°å°ºå¯¸çš„æƒ…å†µä¸‹ï¼Œè¿™äº›æ•°æ®é›†è¡¨ç°å¾—éå¸¸å¥½ã€‚ä¹Ÿè®¸æœ‰æŸç§æ–¹æ³•å¯ä»¥è®©æˆ‘ä»¬å°†ä¸€å †éå¸¸å°çš„æŒ‡ä»¤é›†é“¾æ¥åœ¨ä¸€èµ·ï¼Œå¹¶åœ¨è®¿é—®ç‰¹å®šä½ç½®æ—¶å¿«é€Ÿè®¿é—®æ­£ç¡®çš„æŒ‡ä»¤é›†ã€‚å¦‚æœä½ ä¾§ç€å¤´ï¼Œä½¿åŠ²çœ¯ç€çœ¼ç›ï¼Œè¿™çœ‹èµ·æ¥å°±åƒæ˜¯è·³è¿‡åˆ—è¡¨ï¼Œè€Œè¿™æ­£æ˜¯ä½ æ‰€å®ç°çš„ã€‚</p><p> The first incarnation of this new data structure was pretty straightforward. The OrderedSet was a wrapper around a list of Cells, inside each cell was a small ordset: the first item of the ordset, the last item of the ordset, and a count of the number of items. This allowed the OrderedSet to quickly traverse the list of Cells to find the appropriate Cell and then do a very fast ordset operation. By leveraging compile time guards in the implementation of traversal, you can get pretty good performance in the worst case scenarios that stymie ordset. Insertion of an item at the end of a 250,000 item list dropped from 27,000ğœ‡s to 5,000ğœ‡s, five times faster than raw ordsets and 34 times faster than the naive List implementation.</p><p>è¿™ç§æ–°æ•°æ®ç»“æ„çš„ç¬¬ä¸€ä¸ªåŒ–èº«éå¸¸ç®€å•ã€‚OrderedSetæ˜¯å•å…ƒæ ¼åˆ—è¡¨çš„åŒ…è£…å™¨ï¼Œæ¯ä¸ªå•å…ƒæ ¼å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªè¾ƒå°çš„å‘½ä»¤é›†ï¼šå‘½ä»¤é›†çš„ç¬¬ä¸€é¡¹ã€å‘½ä»¤é›†çš„æœ€åä¸€é¡¹å’Œé¡¹æ•°çš„è®¡æ•°ã€‚è¿™å…è®¸OrderedSetå¿«é€Ÿéå†å•å…ƒæ ¼åˆ—è¡¨ä»¥æ‰¾åˆ°åˆé€‚çš„å•å…ƒæ ¼ï¼Œç„¶åæ‰§è¡Œéå¸¸å¿«é€Ÿçš„å‘½ä»¤é›†æ“ä½œã€‚é€šè¿‡åœ¨éå†å®ç°ä¸­åˆ©ç”¨ç¼–è¯‘æ—¶é—´ä¿æŠ¤ï¼Œæ‚¨å¯ä»¥åœ¨é˜»ç¢å‘½ä»¤é›†çš„æœ€åæƒ…å†µä¸‹è·å¾—ç›¸å½“å¥½çš„æ€§èƒ½ã€‚åœ¨250,000ä¸ªæ¡ç›®åˆ—è¡¨æœ«å°¾æ’å…¥æ¡ç›®çš„é€Ÿåº¦ä»27,000ğœ‡ä¸‹é™åˆ°5,000ğœ‡ï¼Œæ¯”åŸå§‹å‘½ä»¤é›†å¿«5å€ï¼Œæ¯”æœ´ç´ åˆ—è¡¨å®ç°å¿«34å€ã€‚</p><p>  The old worst case was better, but a new worst case of insertion at the beginning of the list had been created; a 250,000 item list was clocking in at 19,000ğœ‡s. Wat?!</p><p>æ—§çš„æœ€å·®æƒ…å†µæ›´å¥½ä¸€äº›ï¼Œä½†æ–°çš„æœ€å·®æƒ…å†µæ˜¯åœ¨åˆ—è¡¨å¼€å¤´æ’å…¥ï¼›ä¸€ä¸ª250,000ä¸ªé¡¹ç›®åˆ—è¡¨ä»¥19,000ä¸ªğœ‡è®°å½•ã€‚ä»€ä¹ˆï¼Ÿï¼</p><p> This makes sense if you think about the data structure. When you insert an item into the front of the OrderedSet it ends up in the first Cell, but that Cell is full, so it evicts its last item to the next Cell, but that Cell is full, so it evicts its last item to the next Cell, and so on. At this point, most engineers would shrug and say â€œYou canâ€™t have your cake and eat it too,â€ but at Discord we are pushing the envelope on quantum cake technology.</p><p>å¦‚æœæ‚¨è€ƒè™‘ä¸€ä¸‹æ•°æ®ç»“æ„ï¼Œè¿™æ˜¯æœ‰æ„ä¹‰çš„ã€‚å½“æ‚¨å°†ä¸€é¡¹æ’å…¥åˆ°OrderedSetçš„å‰é¢æ—¶ï¼Œå®ƒä¼šåœ¨ç¬¬ä¸€ä¸ªCellä¸­ç»“æŸï¼Œä½†è¯¥Cellæ˜¯æ»¡çš„ï¼Œå› æ­¤å®ƒä¼šå°†å…¶æœ€åä¸€é¡¹é€å‡ºåˆ°ä¸‹ä¸€ä¸ªCellï¼Œä½†è¯¥Cellæ˜¯æ»¡çš„ï¼Œå› æ­¤å®ƒä¼šå°†å…¶æœ€åä¸€é¡¹é€å‡ºåˆ°Next Cellï¼Œä¾æ­¤ç±»æ¨ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œå¤§å¤šæ•°å·¥ç¨‹å¸ˆä¼šè€¸è€¸è‚©ï¼Œè¯´â€œä½ ä¸èƒ½æ—¢æœ‰è›‹ç³•åˆåƒè›‹ç³•â€ï¼Œä½†åœ¨æ„è§ä¸ä¸€çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ­£åœ¨æŒ‘æˆ˜é‡å­è›‹ç³•æŠ€æœ¯çš„æé™ã€‚</p><p>  The problem is that when things fill up, operations can cascade from Cell to Cell. What if we could do something more clever? What if we allow Cells to swell and split, dynamically inserting new Cells in the middle of the list? This is slightly more expensive, but has the benefit that the worst case is a Cell Split instead of 2N Cell operations, where N is the number of Cells.</p><p>é—®é¢˜æ˜¯ï¼Œå½“ç©ºé—´è¢«å¡«æ»¡æ—¶ï¼Œæ“ä½œå¯èƒ½ä¼šä»ä¸€ä¸ªCellçº§è”åˆ°å¦ä¸€ä¸ªCellã€‚å¦‚æœæˆ‘ä»¬èƒ½åšäº›æ›´èªæ˜çš„äº‹å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬å…è®¸å•å…ƒæ ¼è†¨èƒ€å’Œæ‹†åˆ†ï¼Œå¹¶åœ¨åˆ—è¡¨ä¸­é—´åŠ¨æ€æ’å…¥æ–°å•å…ƒæ ¼ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿè¿™æ ·åšçš„æˆæœ¬ç¨é«˜ï¼Œä½†å¥½å¤„æ˜¯ï¼Œæœ€ç³Ÿç³•çš„æƒ…å†µæ˜¯ä¿¡å…ƒæ‹†åˆ†ï¼Œè€Œä¸æ˜¯2Nä¸ªä¿¡å…ƒæ“ä½œï¼Œå…¶ä¸­Næ˜¯ä¿¡å…ƒçš„æ•°é‡ã€‚</p><p>  At small list sizes, this new dynamic OrderedSet could perform insertions at any point in the list between 4ğœ‡s and 34ğœ‡s. Not bad. The real test came when we cranked up the size to 250,000. Inserting at the beginning of the list tookâ€¦. drumrollâ€¦. 4ğœ‡s. Thatâ€™s looking fast. But remember last time we made one number fast, we made another slow. Maybe the end of the list is horrible now, better check.</p><p>åœ¨è¾ƒå°çš„åˆ—è¡¨å¤§å°ä¸‹ï¼Œè¿™ä¸ªæ–°çš„Dynamic OrderedSetå¯ä»¥åœ¨åˆ—è¡¨ä¸­4ä¸ªğœ‡åˆ°34ä¸ªğœ‡ä¹‹é—´çš„ä»»æ„ä½ç½®æ‰§è¡Œæ’å…¥ã€‚å½“æˆ‘ä»¬æŠŠå°ºå¯¸æ‰©å¤§åˆ°25ä¸‡ä»¶æ—¶ï¼ŒçœŸæ­£çš„è€ƒéªŒæ¥äº†ã€‚åœ¨åˆ—è¡¨å¼€å¤´æ’å…¥èŠ±è´¹äº†â€¦ã€‚ã€‚é¼“å£°â€¦ã€‚ã€‚4ä¸ªğœ‡sã€‚çœ‹èµ·æ¥å¾ˆå¿«ã€‚ä½†è¯·è®°ä½ï¼Œä¸Šä¸€æ¬¡æˆ‘ä»¬è®©ä¸€ä¸ªæ•°å­—å˜å¿«äº†ï¼Œæˆ‘ä»¬åˆè®©å¦ä¸€ä¸ªæ•°å­—å˜æ…¢äº†ã€‚ä¹Ÿè®¸ç°åœ¨åå•çš„æœ«å°¾å¾ˆå¯æ€•ï¼Œæœ€å¥½æ£€æŸ¥ä¸€ä¸‹ã€‚</p><p> With a list size of 250,000 items, inserting an item at the end of the list took 640ğœ‡s. Looks like we have a winner.</p><p>åœ¨åˆ—è¡¨å¤§å°ä¸º250,000é¡¹çš„æƒ…å†µä¸‹ï¼Œåœ¨åˆ—è¡¨æœ«å°¾æ’å…¥ä¸€é¡¹éœ€è¦640ğœ‡ã€‚çœ‹èµ·æ¥æˆ‘ä»¬æœ‰èµ¢å®¶äº†ã€‚</p><p>   This solution would work for guilds up to 250,000 members, but that was the scaling limit. For a lot of people, this would have been the end of the story. But Discord has been using Rust to make things go fast, and we posed a question: â€œCould we use Rust to go faster?â€</p><p>è¿™ä¸ªè§£å†³æ–¹æ¡ˆé€‚ç”¨äºæœ€å¤š25ä¸‡åä¼šå‘˜çš„å…¬ä¼šï¼Œä½†è¿™æ˜¯æ‰©å±•çš„é™åˆ¶ã€‚å¯¹äºå¾ˆå¤šäººæ¥è¯´ï¼Œè¿™å°†æ˜¯æ•…äº‹çš„ç»“å±€ã€‚ä½†ä¸å’Œè°ç»„ç»‡ä¸€ç›´åœ¨åˆ©ç”¨é“é”ˆè®©äº‹æƒ…å‘å±•å¾—æ›´å¿«ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼šâ€œæˆ‘ä»¬èƒ½ç”¨é“é”ˆæ¥åŠ å¿«é€Ÿåº¦å—ï¼Ÿâ€</p><p> Rust is not a functional language, and will happily let you mutate data structures. It also has no run-time and provides â€œzero-cost abstractions.â€ If we could somehow get Rust to manage this set, it would probably perform much better.</p><p>Rustä¸æ˜¯ä¸€ç§å‡½æ•°å¼è¯­è¨€ï¼Œå®ƒå¯ä»¥è®©æ‚¨å¾ˆé«˜å…´åœ°æ”¹å˜æ•°æ®ç»“æ„ã€‚å®ƒä¹Ÿæ²¡æœ‰è¿è¡Œæ—¶ï¼Œå¹¶æä¾›â€œé›¶æˆæœ¬æŠ½è±¡â€ã€‚å¦‚æœæˆ‘ä»¬èƒ½ä»¥æŸç§æ–¹å¼è®©æ‹‰æ–¯ç‰¹æ¥ç®¡ç†è¿™å¥—è®¾å¤‡ï¼Œå®ƒçš„è¡¨ç°å¯èƒ½ä¼šå¥½å¾—å¤šã€‚</p><p> Our core services arenâ€™t written in Rust, they are Elixir-based. Elixir serves this purpose very well, and lucky for us, the BEAM VM had another nifty trick up its sleeve. The BEAM VM has three types of functions:</p><p>æˆ‘ä»¬çš„æ ¸å¿ƒæœåŠ¡ä¸æ˜¯ç”¨Rustå†™çš„ï¼Œå®ƒä»¬æ˜¯åŸºäºé•¿ç”Ÿä¸è€è¯çš„ã€‚é•¿ç”Ÿä¸è€è¯å¾ˆå¥½åœ°å®ç°äº†è¿™ä¸€ç›®çš„ï¼Œå¹¸è¿çš„æ˜¯ï¼ŒBEAM VMè¿˜æœ‰å¦ä¸€ä¸ªå¦™æ‹›ã€‚BEAM VMå…·æœ‰ä¸‰ç§ç±»å‹çš„åŠŸèƒ½ï¼š</p><p> Functions that are built into the language and act as the building blocks for user-space functions. These are called BIFs or Built-In Functions.</p><p>å†…ç½®äºè¯­è¨€ä¸­å¹¶å……å½“ç”¨æˆ·ç©ºé—´å‡½æ•°çš„æ„å»ºå—çš„å‡½æ•°ã€‚è¿™äº›è¢«ç§°ä¸ºBIFæˆ–å†…ç½®å‡½æ•°ã€‚</p><p> Then there are NIFs or Native Implemented Functions. These are functions that are built in C or Rust and compiled into the BEAM VM. Calling these functions is just like calling a BIF but, you can control what it does.</p><p>ç„¶åæ˜¯NIFæˆ–åŸç”Ÿå®ç°çš„åŠŸèƒ½ã€‚è¿™äº›å‡½æ•°æ˜¯ç”¨Cæˆ–Rustæ„å»ºçš„ï¼Œå¹¶ç¼–è¯‘åˆ°BEAM VMä¸­ã€‚è°ƒç”¨è¿™äº›å‡½æ•°å°±åƒè°ƒç”¨BIFä¸€æ ·ï¼Œä½†æ‚¨å¯ä»¥æ§åˆ¶å®ƒçš„åŠŸèƒ½ã€‚</p><p> Thereâ€™s a fantastic Elixir project called  Rustler. It provides nice support on the Elixir and Rust side for making a safe NIF that is well behaved and using the guarantees of Rust is guaranteed not to crash the VM or leak memory.</p><p>æœ‰ä¸€ä¸ªå¾ˆæ£’çš„é•¿ç”Ÿä¸è€è¯é¡¹ç›®å«â€œé“åŒ â€ã€‚å®ƒåœ¨Elixirå’ŒRustç«¯æä¾›äº†å¾ˆå¥½çš„æ”¯æŒï¼Œä»¥åˆ›å»ºè¡Œä¸ºè‰¯å¥½çš„å®‰å…¨NIFï¼Œå¹¶ä¸”ä½¿ç”¨Rustçš„ä¿è¯ä¸ä¼šå¯¼è‡´VMå´©æºƒæˆ–å†…å­˜æ³„æ¼ã€‚</p><p> We set aside a week to see if this would be worth the effort. By the end of the week, we had a very limited proof-of-concept that we could measure. The first benchmarks were extremely promising. The best case for adding an item to the set was 0.4ğœ‡s with a worst case of 2.85ğœ‡s, compared to OrderedSetâ€™s 4ğœ‡s to 640ğœ‡s. This was a benchmark just using integers, but it was enough evidence to build out support for a wider range of Erlang Terms and fill out the rest of the functionality.</p><p>æˆ‘ä»¬ç•™å‡ºäº†ä¸€å‘¨çš„æ—¶é—´ï¼Œçœ‹çœ‹è¿™æ˜¯å¦å€¼å¾—æˆ‘ä»¬ä»˜å‡ºåŠªåŠ›ã€‚åˆ°äº†å‘¨æœ«ï¼Œæˆ‘ä»¬å¯ä»¥è¡¡é‡çš„æ¦‚å¿µè¯æ˜éå¸¸æœ‰é™ã€‚ç¬¬ä¸€æ‰¹åŸºå‡†éå¸¸æœ‰å¸Œæœ›ã€‚å‘é›†åˆä¸­æ·»åŠ æ¡ç›®çš„æœ€å¥½æƒ…å†µæ˜¯0.4Erlang sï¼Œæœ€å·®æƒ…å†µæ˜¯2.85Erlang sï¼Œè€ŒOrderedSetçš„æœ€å·®æƒ…å†µæ˜¯4ğœ‡åˆ°640Erlang sã€‚è¿™åªæ˜¯ä¸€ä¸ªä½¿ç”¨æ•´æ•°çš„åŸºå‡†ï¼Œä½†å®ƒè¶³ä»¥å¢å¼ºå¯¹æ›´å¹¿æ³›çš„ğœ‡æœ¯è¯­çš„æ”¯æŒï¼Œå¹¶å®Œå–„å…¶ä½™åŠŸèƒ½ã€‚</p><p> With the spike showing so much promise, we continued on building out support for most Erlang Terms and all the functionality we needed for the member list. It was time to benchmark again. We cranked the number of items all the way up to 1,000,000 items. The test machine churned for a few minutes and finally printed out the result: SortedSet best case was 0.61ğœ‡s and worst case was 3.68ğœ‡s, testing multiple sizes of sets from 5,000 to 1,000,000 items.</p><p>éšç€è¿™ä¸ªå³°å€¼æ˜¾ç¤ºå‡ºå¦‚æ­¤å¤šçš„å‰æ™¯ï¼Œæˆ‘ä»¬ç»§ç»­æ„å»ºå¯¹å¤§å¤šæ•°Erlangæœ¯è¯­çš„æ”¯æŒï¼Œä»¥åŠæˆå‘˜åˆ—è¡¨æ‰€éœ€çš„æ‰€æœ‰åŠŸèƒ½ã€‚ç°åœ¨æ˜¯å†æ¬¡åˆ¶å®šåŸºå‡†çš„æ—¶å€™äº†ã€‚æˆ‘ä»¬æŠŠå•†å“æ•°é‡ä¸€è·¯å¢åŠ åˆ°100ä¸‡ä»¶ã€‚æµ‹è¯•æœºæ…æ‹Œäº†å‡ åˆ†é’Ÿï¼Œæœ€åæ‰“å°å‡ºç»“æœï¼šSortedSetæœ€å¥½çš„æƒ…å†µæ˜¯0.61ğœ‡ï¼Œæœ€åçš„æƒ…å†µæ˜¯3.68ğœ‡ï¼Œæµ‹è¯•äº†ä»5,000åˆ°1,000,000ä¸ªé¡¹ç›®çš„å¤šç§å¤§å°çš„é›†åˆã€‚</p><p> For the second iteration in a row we were able to make the worst case as good as the previous iterations best-case timings.</p><p>å¯¹äºè¿ç»­çš„ç¬¬äºŒæ¬¡è¿­ä»£ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä½¿æœ€åçš„æƒ…å†µä¸å‰ä¸€æ¬¡è¿­ä»£çš„æœ€ä½³æƒ…å†µè®¡æ—¶ä¸€æ ·å¥½ã€‚</p><p>  The Rust backed NIF provides massive performance benefits without trading off ease of use or memory. Since the library operations all clocked in well under the 1 millisecond threshold, we could just use the built-in Rustler guarantees and not need to worry about reductions or yielding. The SortedSet module looks to the caller to just be a vanilla Elixir module that performs crazy fast.</p><p>é“é”ˆæ”¯æŒçš„NIFåœ¨ä¸ç‰ºç‰²æ˜“ç”¨æ€§æˆ–å†…å­˜çš„æƒ…å†µä¸‹æä¾›äº†å·¨å¤§çš„æ€§èƒ½ä¼˜åŠ¿ã€‚ç”±äºå›¾ä¹¦é¦†çš„æ‰€æœ‰æ“ä½œéƒ½åœ¨1æ¯«ç§’çš„é˜ˆå€¼ä»¥ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åªä½¿ç”¨å†…ç½®çš„Rustlerä¿è¯ï¼Œè€Œä¸éœ€è¦æ‹…å¿ƒå‡å°‘æˆ–å‡å°‘ã€‚åœ¨è°ƒç”¨è€…çœ‹æ¥ï¼ŒSortedSetæ¨¡å—åªæ˜¯ä¸€ä¸ªæ‰§è¡Œé€Ÿåº¦éå¸¸å¿«çš„é¦™è‰è¯å‰‚æ¨¡å—ã€‚</p><p>  Today, the Rust backed SortedSet powers every single Discord guild: from the 3 person guild planning a trip to Japan to 200,000 people enjoying the latest, fun game.</p><p>ä»Šå¤©ï¼Œé“é”ˆæ”¯æŒçš„SortedSetä¸ºæ¯ä¸€ä¸ªä¸å’Œè°çš„è¡Œä¼šæä¾›åŠ¨åŠ›ï¼šä»è®¡åˆ’å»æ—¥æœ¬æ—…è¡Œçš„3äººè¡Œä¼šåˆ°20ä¸‡äººæ­£åœ¨äº«å—æœ€æ–°çš„æœ‰è¶£æ¸¸æˆã€‚</p><p> Since deploying SortedSet, weâ€™ve seen performance improve across the board with no impact to memory pressure. We learned that Rust and Elixir can work side by side to operate in extremely tight performance constraints. We can still keep our core real-time communications logic in the higher-level Elixir with its wonderful guarantees and easy concurrency while dropping down into Rust when needed.</p><p>è‡ªä»éƒ¨ç½²SortedSetä»¥æ¥ï¼Œæˆ‘ä»¬çœ‹åˆ°æ€§èƒ½åœ¨æ²¡æœ‰å½±å“å†…å­˜å‹åŠ›çš„æƒ…å†µä¸‹å…¨é¢æå‡ã€‚æˆ‘ä»¬äº†è§£åˆ°ï¼Œé“é”ˆå’Œé•¿ç”Ÿä¸è€è¯å¯ä»¥å¹¶æ’å·¥ä½œï¼Œåœ¨æå…¶ä¸¥æ ¼çš„æ€§èƒ½çº¦æŸä¸‹è¿è¡Œã€‚æˆ‘ä»¬ä»ç„¶å¯ä»¥å°†æˆ‘ä»¬çš„æ ¸å¿ƒå®æ—¶é€šä¿¡é€»è¾‘ä¿ç•™åœ¨æ›´é«˜çº§åˆ«çš„çµä¸¹å¦™è¯ä¸­ï¼Œå› ä¸ºå®ƒå…·æœ‰å‡ºè‰²çš„ä¿è¯å’Œå®¹æ˜“çš„å¹¶å‘æ€§ï¼Œå¹¶ä¸”åœ¨éœ€è¦æ—¶å¯ä»¥ä¸‹é™åˆ°Rustä¸­ã€‚</p><p> If you need a high-speed mutation friendly SortedSet,  we have released SortedSet as an open source library.</p><p>å¦‚æœä½ éœ€è¦ä¸€ä¸ªé«˜é€Ÿå˜å¼‚å‹å¥½çš„SortedSetï¼Œæˆ‘ä»¬å·²ç»å‘å¸ƒäº†ä¸€ä¸ªå¼€æºçš„SortedSetã€‚</p><p> If solving hard problems with awesome tools like Elixir and Rust is interesting to you,  go check out our jobs page.</p><p>å¦‚æœä½ å¯¹ä½¿ç”¨åƒElixirå’ŒRustè¿™æ ·çš„å¼ºå¤§å·¥å…·æ¥è§£å†³éš¾é¢˜æ„Ÿå…´è¶£ï¼Œé‚£å°±å»çœ‹çœ‹æˆ‘ä»¬çš„æ‹›è˜é¡µé¢å§ã€‚</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.discord.com/using-rust-to-scale-elixir-for-11-million-concurrent-users-c6f19fc029d3">https://blog.discord.com/using-rust-to-scale-elixir-for-11-million-concurrent-users-c6f19fc029d3</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/scale/">#scale</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/åˆ—è¡¨/">#åˆ—è¡¨</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1034383.html"><img src="http://img2.diglog.com/img/2020/11/thumb_13adc774d7220747f1b03cc994ede446.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1034383.html">InfluxDBå°†èµŒæ³¨æŠ¼åœ¨Rustå’ŒApache Arrowçš„ä¸‹ä¸€ä»£æ•°æ®å­˜å‚¨ä¸Š</a></div><span class="my_story_list_date">2020-11-11 4:9</span></div><div class="col-sm"><div><a target="_blank" href="/story/1034269.html"><img src="http://img2.diglog.com/img/2020/11/thumb_524109d84e42d6e5e81376458a2dafa9.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1034269.html">äºšé©¬é€Šå› ä½¿ç”¨å•†å®¶æ•°æ®è€Œé¢ä¸´æ¬§ç›Ÿåå„æ–­æŒ‡æ§ï¼šæ¥æº</a></div><span class="my_story_list_date">2020-11-10 22:26</span></div><div class="col-sm"><div><a target="_blank" href="/story/1034264.html"><img src="http://img2.diglog.com/img/2020/11/thumb_1eb6a76bdc96a6c7ea176671840feb7e.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1034264.html">æ¬§ç›Ÿå°±äºšé©¬é€Šä½¿ç”¨æ•°æ®æèµ·åå„æ–­è¯‰è®¼</a></div><span class="my_story_list_date">2020-11-10 22:20</span></div><div class="col-sm"><div><a target="_blank" href="/story/1034251.html"><img src="http://img2.diglog.com/img/2020/11/thumb_c1dfc94501cbe88803516dad93e2d016.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1034251.html">
æ¬§æ´²å¯¹äºšé©¬é€Šä½¿ç”¨å¤§æ•°æ®æèµ·åå„æ–­è¯‰è®¼</a></div><span class="my_story_list_date">2020-11-10 21:2</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¾å›½/">#ç¾å›½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è°·æ­Œ/">#è°·æ­Œ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¨‹åº/">#ç¨‹åº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>