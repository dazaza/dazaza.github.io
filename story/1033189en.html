<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>å…³äºå¸•å…‹ç´¢æ–¯çš„æ³¨è®°</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">å…³äºå¸•å…‹ç´¢æ–¯çš„æ³¨è®°</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-05 02:01:06</div><div class="page_narrow text-break page_content"><p>These are my notes after learning the  Paxos algorithm.The primary goal here is to sharpen my own understanding of the algorithm, but maybe someone will find this explanation of Paxos useful!This post assumes fluency with mathematical notation.</p><p>è¿™äº›æ˜¯æˆ‘åœ¨å­¦ä¹ äº†Paxosç®—æ³•åçš„ç¬”è®°ã€‚è¿™é‡Œçš„ä¸»è¦ç›®æ ‡æ˜¯åŠ æ·±æˆ‘è‡ªå·±å¯¹è¯¥ç®—æ³•çš„ç†è§£ï¼Œä½†ä¹Ÿè®¸æœ‰äººä¼šå‘ç°è¿™ä¸ªå…³äºPaxosçš„è§£é‡Šå¾ˆæœ‰ç”¨ï¼è¿™ç¯‡æ–‡ç« å‡è®¾æˆ‘å¯¹æ•°å­¦ç¬¦å·å¾ˆç†Ÿç»ƒã€‚</p><p> I must confess it took me a long time to understand distributed consensus.Iâ€™ve read a whole bunch of papers( Part Time Parliament, Paxos Made Simple, Practical BFT, In Search of an Understandable Consensus Algorithm, CASPaxos: Replicated State Machines without logs), but they didnâ€™t make sense.Or rather, nothing specific was unclear, but, at the same time, I was unable to answer the core question:</p><p>æˆ‘å¿…é¡»æ‰¿è®¤ï¼Œæˆ‘èŠ±äº†å¾ˆé•¿æ—¶é—´æ¥ç†è§£åˆ†å¸ƒå¼å…±è¯†ã€‚æˆ‘è¯»äº†ä¸€å¤§å †è®ºæ–‡(åœ¨è®®ä¼šå…¼èŒæœŸé—´ï¼ŒPaxosåšäº†ç®€å•å®ç”¨çš„BFTï¼Œå¯»æ‰¾ä¸€ä¸ªå¯ä»¥ç†è§£çš„å…±è¯†ç®—æ³•ï¼ŒCASPaxosï¼šæ²¡æœ‰æ—¥å¿—çš„å¤åˆ¶çŠ¶æ€æœº)ï¼Œä½†å®ƒä»¬æ²¡æœ‰æ„ä¹‰ã€‚æˆ–è€…è¯´ï¼Œæ²¡æœ‰ä»€ä¹ˆå…·ä½“çš„ä¸œè¥¿æ˜¯ä¸æ¸…æ¥šçš„ï¼Œä½†åŒæ—¶ï¼Œæˆ‘æ— æ³•å›ç­”æ ¸å¿ƒé—®é¢˜ï¼š</p><p>    The Paxos Algorithm or How to Win a Turing Award lecture (I canâ€™t believe I actually was in St. Petersburg at that time and missed this!)</p><p>å¸•å…‹ç´¢æ–¯ç®—æ³•æˆ–å¦‚ä½•èµ¢å¾—å›¾çµå¥–è®²åº§(æˆ‘ä¸æ•¢ç›¸ä¿¡æˆ‘å½“æ—¶çœŸçš„åœ¨åœ£å½¼å¾—å ¡ï¼Œé”™è¿‡äº†è¿™ä¸ªï¼)ã€‚</p><p> I now think that the thing is actually much simpler than it is made to believe :-)</p><p>æˆ‘ç°åœ¨è®¤ä¸ºäº‹æƒ…å®é™…ä¸Šæ¯”äººä»¬æƒ³è±¡çš„è¦ç®€å•å¾—å¤šï¼š-)ã€‚</p><p> Paxos is an algorithm for implementing distributed consensus.Suppose you have  N machines which communicate over a faulty network.The network may delay, reorder, and loose messages (it can not corrupt them though).Some machines might die, and might return later.Due to network delays, â€œmachine is deadâ€ and â€œmachine is temporary unreachableâ€ are indistinguishable.What we want to do is to make machines agree on some value.â€œAgreeâ€ here means that if some machine says â€œvalue is Xâ€, and another machine says â€œvalue is Yâ€, then X necessary is equal to Y.It is OK for machine to answer â€œI donâ€™t know yetâ€.</p><p>Paxosæ˜¯ä¸€ç§å®ç°åˆ†å¸ƒå¼å…±è¯†çš„ç®—æ³•ã€‚å‡è®¾ä½ æœ‰Nå°æœºå™¨ï¼Œå®ƒä»¬åœ¨æ•…éšœç½‘ç»œä¸Šé€šä¿¡ã€‚ç½‘ç»œå¯èƒ½ä¼šå»¶è¿Ÿã€é‡æ–°æ’åºå’Œæ¾æ•£æ¶ˆæ¯(å°½ç®¡å®ƒä¸ä¼šç ´åå®ƒä»¬)ã€‚ä¸€äº›æœºå™¨å¯èƒ½ä¼šæ­»æ‰ï¼Œå¯èƒ½ä¼šç¨åè¿”å›ã€‚ç”±äºç½‘ç»œå»¶è¿Ÿï¼Œâ€œæœºå™¨æ­»äº†â€å’Œâ€œæœºå™¨æš‚æ—¶æ— æ³•åˆ°è¾¾â€æ˜¯æ— æ³•åŒºåˆ†çš„ã€‚æˆ‘ä»¬è¦åšçš„æ˜¯è®©æœºå™¨å°±æŸä¸ªå€¼è¾¾æˆä¸€è‡´ã€‚è¿™é‡Œçš„â€œåŒæ„â€æ˜¯æŒ‡ï¼Œå¦‚æœä¸€å°æœºå™¨è¯´â€œå€¼æ˜¯Xâ€ï¼Œè€Œå¦ä¸€å°æœºå™¨è¯´â€œå€¼æ˜¯Yâ€ï¼Œé‚£ä¹ˆâ€œæœºå™¨æ­»äº†â€å’Œâ€œæœºå™¨æš‚æ—¶æ— æ³•åˆ°è¾¾â€æ˜¯æ— æ³•åŒºåˆ†çš„ã€‚æˆ‘ä»¬è¦åšçš„æ˜¯è®©æœºå™¨å°±æŸä¸ªå€¼è¾¾æˆä¸€è‡´ã€‚è¿™é‡Œçš„â€œåŒæ„â€æ˜¯æŒ‡ï¼Œå¦‚æœä¸€å°æœºå™¨è¯´â€œå€¼æ˜¯Xâ€ï¼Œè€Œå¦ä¸€å°è¯´â€œå€¼æ˜¯Yâ€ï¼Œé‚£ä¹ˆXå¿…éœ€ç­‰äºYã€‚æœºå™¨å›ç­”â€œæˆ‘è¿˜ä¸çŸ¥é“â€æ˜¯å¯ä»¥çš„ã€‚</p><p> The problem with this formulation is that Paxos is an elementary, but subtle algorithm.To understand it (at least for me), a precise, mathematical formulation is needed.So, letâ€™s try again.</p><p>è¿™ä¸ªå…¬å¼çš„é—®é¢˜æ˜¯ï¼ŒPaxosæ˜¯ä¸€ä¸ªåŸºæœ¬ä½†å¾®å¦™çš„ç®—æ³•ã€‚è¦ç†è§£å®ƒ(è‡³å°‘å¯¹æˆ‘æ¥è¯´)ï¼Œéœ€è¦ä¸€ä¸ªç²¾ç¡®çš„æ•°å­¦å…¬å¼ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å†è¯•ä¸€æ¬¡ã€‚</p><p> What is Paxos?Paxos is a theorem about sets!This is definitely mathematical, and is true (as long as you base math on set theory), but is not that helpful.So, letâ€™s try again.</p><p>ä»€ä¹ˆæ˜¯Paxosï¼ŸPaxosæ˜¯ä¸€ä¸ªå…³äºé›†åˆçš„å®šç†ï¼è¿™ç»å¯¹æ˜¯æ•°å­¦çš„ï¼Œè€Œä¸”æ˜¯çœŸçš„(åªè¦ä½ æŠŠæ•°å­¦å»ºç«‹åœ¨é›†åˆè®ºçš„åŸºç¡€ä¸Š)ï¼Œä½†æ˜¯æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å†è¯•ä¸€æ¬¡ã€‚</p><p>  A system is characterized by a state.The system evolves in discrete steps: each step takes system from  state to  state&#39;.Transitions are non-deterministic: from a single current  s1, you may get to different next states  s2 and  s3.(non-determinism models a flaky network).An infinite sequence of systemâ€™s states is called a behavior:</p><p>ç³»ç»Ÿçš„ç‰¹å¾æ˜¯ä¸€ç§çŠ¶æ€ã€‚ç³»ç»Ÿä»¥ç¦»æ•£çš„æ­¥éª¤æ¼”åŒ–ï¼šæ¯ä¸€æ­¥éƒ½å°†ç³»ç»Ÿä»ä¸€ä¸ªçŠ¶æ€å¸¦åˆ°å¦ä¸€ä¸ªçŠ¶æ€ã€‚è½¬å˜æ˜¯ä¸ç¡®å®šçš„ï¼šä»ä¸€ä¸ªå½“å‰çš„S1ï¼Œä½ å¯èƒ½ä¼šåˆ°è¾¾ä¸åŒçš„ä¸‹ä¸€ä¸ªçŠ¶æ€S2å’ŒS3ã€‚(éå†³å®šè®ºä¸ºä¸€ä¸ªæ¾æ•£çš„ç½‘ç»œå»ºæ¨¡)ã€‚æ— é™çš„ç³»ç»ŸçŠ¶æ€åºåˆ—è¢«ç§°ä¸ºä¸€ç§è¡Œä¸ºï¼š</p><p>  Due to non-determinism, thereâ€™s a potentially infinite number of possible behaviors.Nonetheless, depending on the transition function, we might be able to prove that some condition is true for any state in any behavior.</p><p>ç”±äºéå†³å®šè®ºï¼Œæ½œåœ¨çš„å¯èƒ½è¡Œä¸ºçš„æ•°é‡æ˜¯æ— é™çš„ï¼Œä¸æœ½çš„ï¼Œä¾èµ–äºè½¬ç§»å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿè®¸èƒ½å¤Ÿè¯æ˜ï¼Œå¯¹äºä»»ä½•è¡Œä¸ºä¸­çš„ä»»ä½•çŠ¶æ€ï¼ŒæŸäº›æ¡ä»¶éƒ½æ˜¯æ­£ç¡®çš„ã€‚</p><p> Letâ€™s start with a simple example, and also introduce some notation.I wonâ€™t use TLA+, as I donâ€™t enjoy its concrete syntax.Instead, math will be set in monospaced unicode.</p><p>è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­å¼€å§‹ï¼Œå¹¶ä»‹ç»ä¸€äº›ç¬¦å·ã€‚æˆ‘ä¸ä¼šä½¿ç”¨TLA+ï¼Œå› ä¸ºæˆ‘ä¸å–œæ¬¢å®ƒçš„å…·ä½“è¯­æ³•ã€‚</p><p> The example models an integer counter.Each step the counter decrements or increments (non-deterministically), but never gets too big or too small</p><p>è¯¥ç¤ºä¾‹å¯¹æ•´æ•°è®¡æ•°å™¨è¿›è¡Œå»ºæ¨¡ã€‚æ¯ä¸€æ­¥è®¡æ•°å™¨éƒ½ä¼šé€’å‡æˆ–é€’å¢(éç¡®å®šæ€§)ï¼Œä½†ä¸ä¼šå˜å¾—å¤ªå¤§æˆ–å¤ªå°ã€‚</p><p> Sets: â„• -- Natural numbers with zeroVars: counter âˆˆ â„•Init â‰¡ counter = 0Next â‰¡ (counter &lt; 9 âˆ§ counter&#39; = counter + 1) âˆ¨ (counter &gt; 0 âˆ§ counter&#39; = counter - 1)Theorem: âˆ€ i: 0 â‰¤ counter_i â‰¤ 9-- Notation-- â‰¡: equals by definition-- âˆ§: &#34;and&#34;, conjunction-- âˆ¨: &#34;or&#34;, disjunction</p><p>é›†åˆï¼šâ„•--å¸¦é›¶çš„è‡ªç„¶æ•°å˜é‡ï¼šCounterâˆˆâ„•Initâ‰¡Counter=0Nextâ‰¡(Counter&ltï¼›9âˆ§Counter&#39ï¼›=Counter+1)âˆ¨(Counter&gtï¼›0âˆ§Counter&#39ï¼›=Counter-1)å®šç†ï¼šâˆ€Iï¼š0â‰¤Counter_Iâ‰¤9--NOTATION--â‰¡ï¼šå®šä¹‰ç­‰äº--âˆ§ï¼š&#34ï¼›å’Œ&#34ï¼›ï¼ŒCONNECT-âˆ¨ï¼š&#34ï¼›æˆ–&#34ï¼›ï¼Œæå–ã€‚</p><p> The sate of the system is a single variableâ€‰â€”â€‰ counter.It holds a natural number.In general, we will represent a state of any system by a fixed set of variables.Even if the system logically consists of several components, we model it using a single unified state.</p><p>ç³»ç»Ÿçš„çŠ¶æ€æ˜¯ä¸€ä¸ªå•å˜é‡çš„â€‰-â€‰è®¡æ•°å™¨ï¼Œå®ƒåŒ…å«ä¸€ä¸ªè‡ªç„¶æ•°ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç”¨ä¸€ç»„å›ºå®šçš„å˜é‡æ¥è¡¨ç¤ºä»»ä½•ç³»ç»Ÿçš„çŠ¶æ€ï¼Œå³ä½¿ç³»ç»Ÿåœ¨é€»è¾‘ä¸Šç”±å‡ ä¸ªç»„ä»¶ç»„æˆï¼Œæˆ‘ä»¬ä¹Ÿä¼šç”¨ä¸€ä¸ªç»Ÿä¸€çš„çŠ¶æ€å¯¹å…¶è¿›è¡Œå»ºæ¨¡ã€‚</p><p> The  Init formula specifies the initial state, the  counter is zero.Note that  = is a mathematical equality, and not an assignment. Init is a  predicate on states.</p><p>åˆå§‹åŒ–å…¬å¼æŒ‡å®šåˆå§‹çŠ¶æ€ï¼Œè®¡æ•°å™¨ä¸ºé›¶ã€‚è¯·æ³¨æ„=æ˜¯æ•°å­¦ç­‰å¼ï¼Œè€Œä¸æ˜¯èµ‹å€¼ã€‚Initæ˜¯ä¸€ä¸ªåŸºäºçŠ¶æ€çš„è°“è¯ã€‚</p><p>  Next defines a non-deterministic transition function.It is a predicate on pairs of states,  s1 and  s2. counter is a variable in the  s1 state,  counter&#39; is the corresponding variable in the  s2 state.In plain English, transition from  s1 to  s2 is valid if one of these is true:</p><p>ä¸‹ä¸€æ­¥ï¼Œå®šä¹‰äº†ä¸€ä¸ªéç¡®å®šæ€§è½¬ç§»å‡½æ•°ï¼Œå®ƒæ˜¯å…³äºçŠ¶æ€å¯¹S1å’ŒS2çš„è°“è¯ã€‚COUNTERæ˜¯S1çŠ¶æ€ä¸‹çš„å˜é‡ï¼ŒCOUNTER#39ï¼›æ˜¯S2çŠ¶æ€ä¸‹çš„å¯¹åº”å˜é‡ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœä¸‹åˆ—æ¡ä»¶ä¹‹ä¸€æˆç«‹ï¼Œåˆ™ä»S1åˆ°S2çš„è½¬æ¢æ˜¯æœ‰æ•ˆçš„ï¼š</p><p> Value of  counter in  s1 is less than  9 and value of  counter in  s2 is greater by 1.</p><p>S1ä¸­çš„COUNTERå€¼å°äº9ï¼ŒS2ä¸­çš„COUNTERå€¼å¤§äº1ã€‚</p><p> Value of  counter in  s1 is greater than  0, and value of  counter in  s2 is smaller by 1.</p><p>S1ä¸­çš„COUNTERå€¼å¤§äº0ï¼ŒS2ä¸­çš„COUNTERå€¼å°äº1ã€‚</p><p> Next is true for  ({counter: 5}, {counter: 6}).  Next is false for  ({counter: 5}, {counter: 5}).</p><p>NEXTå¯¹äº({COUNTERï¼š5}ï¼Œ{COUNTERï¼š6})ä¸ºçœŸã€‚NEXTå¯¹äº({COUNTERï¼š5}ï¼Œ{COUNTERï¼š5})ä¸ºFALSEã€‚</p><p>  0 â†’ 1 â†’ 2 â†’ 3 â†’ 4 â†’ 5 â†’ 6 â†’ 7 â†’ 8 â†’ 9</p><p>0â†’1â†’2â†’3â†’4â†’5â†’6â†’7â†’8â†’9ã€‚</p><p>  0 â†’ 1 â†’ 2 â†’ 3 â†’ 3 â†’ 2 â†’ 1 â†’ 0</p><p>%0â†’%1â†’%2â†’%3â†’%3â†’%2â†’%1â†’%0ã€‚</p><p>  1 â†’ 2 â†’ 3 â†’ 4 â†’ 5:  Init does not hold for initial state</p><p>1â†’2â†’3â†’4â†’5ï¼šåˆå§‹åŒ–ä¸é€‚ç”¨äºåˆå§‹çŠ¶æ€ã€‚</p><p>  0 â†’ 1 â†’ 0 â†’ -1:  Next does not hold for  (0, -1) pair</p><p>0â†’1â†’0â†’-1ï¼šNextä¸é€‚ç”¨äº(0ï¼Œ-1)å¯¹ã€‚</p><p> â€œbehaviorâ€ means that the initial state satisfies  Init, and each transition satisfies  Next.</p><p>â€œè¡Œä¸ºâ€æ˜¯æŒ‡åˆå§‹çŠ¶æ€æ»¡è¶³Initï¼Œç„¶åæ¯ä¸ªè½¬æ¢éƒ½æ»¡è¶³ã€‚</p><p> We can state and prove a theorem about this system: for every state in every behavior, the value of counter is between 0 and 9.Proof is by induction:</p><p>æˆ‘ä»¬å¯ä»¥é™ˆè¿°å¹¶è¯æ˜å…³äºè¿™ä¸ªç³»ç»Ÿçš„ä¸€ä¸ªå®šç†ï¼šå¯¹äºæ¯ä¸ªè¡Œä¸ºä¸­çš„æ¯ä¸ªçŠ¶æ€ï¼Œè®¡æ•°å™¨çš„å€¼éƒ½åœ¨0åˆ°9ä¹‹é—´ã€‚Proofæ˜¯é€šè¿‡å½’çº³æ³•å¾—å‡ºçš„ï¼š</p><p> If the condition is true for state  s1, and  Next holds for  (s1, s2), then the condition is true for  s2.</p><p>å¦‚æœæ¡ä»¶å¯¹äºçŠ¶æ€S1ä¸ºçœŸï¼Œå¹¶ä¸”æ¥ä¸‹æ¥å¯¹äº(S1ï¼ŒS2)æˆç«‹ï¼Œåˆ™æ¡ä»¶å¯¹äºS2ä¸ºçœŸã€‚</p><p> As usual with induction, sometimes we would want to prove a  stronger property, because it gives us more powerful base for an induction step.</p><p>ä¸é€šå¸¸çš„å½’çº³æ³•ä¸€æ ·ï¼Œæœ‰æ—¶æˆ‘ä»¬ä¼šæƒ³è¦è¯æ˜ä¸€ä¸ªæ›´å¼ºçš„æ€§è´¨ï¼Œå› ä¸ºå®ƒä¸ºå½’çº³æ³•æ­¥éª¤æä¾›äº†æ›´å¼ºå¤§çš„åŸºç¡€ã€‚</p><p> To sum up, we define a non-deterministic state machine using two predicates  Init and  Next. Init is a predicate on states which restricts possible initial states. Next is a predicate on  pairs of states, which defines a non-deterministic transition function. Vars section describes the state as a fixed set of typed variables. Sets defines auxiliary fixed sets, elements of which are values of variables. Theorem section specifies a predicate on behaviors:  sequences of steps evolving according to  Init and  Next.</p><p>æ€»ä¹‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªè°“è¯Initå’ŒNextå®šä¹‰äº†ä¸€ä¸ªéç¡®å®šæ€§çŠ¶æ€æœºã€‚Initæ˜¯é™åˆ¶å¯èƒ½çš„åˆå§‹çŠ¶æ€çš„çŠ¶æ€è°“è¯ã€‚æ¥ä¸‹æ¥æ˜¯çŠ¶æ€å¯¹ä¸Šçš„è°“è¯ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªéç¡®å®šæ€§çš„è½¬ç§»å‡½æ•°ã€‚Varséƒ¨åˆ†å°†çŠ¶æ€æè¿°ä¸ºä¸€ç»„å›ºå®šçš„ç±»å‹åŒ–å˜é‡ã€‚é›†åˆå®šä¹‰è¾…åŠ©å›ºå®šé›†åˆï¼Œå…¶å…ƒç´ æ˜¯å˜é‡çš„å€¼ã€‚å®šç†éƒ¨åˆ†æŒ‡å®šäº†å…³äºè¡Œä¸ºçš„è°“è¯ï¼šæ ¹æ®Initå’ŒNextæ¼”åŒ–çš„æ­¥éª¤åºåˆ—ã€‚</p><p> The theorem does not automatically follow from  Init and  Next, it needs to be proven.Alternatively, we can simulate a range of possible behaviors on a computer and check the theorem for the specific cases.If the set of reachable states is small enough (finite would be a good start), we can enumerate  all behaviors and produce a brute force proof.If there are too many reachable states, we canâ€™t prove the theorem this way, but we often can prove it to be wrong, by finding a counter example.This is the idea behind model checking in general and TLA+ specifically.</p><p>è¿™ä¸ªå®šç†ä¸ä¼šè‡ªåŠ¨ä»Initå’ŒNextå¾—åˆ°è¯æ˜ã€‚æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è®¡ç®—æœºä¸Šæ¨¡æ‹Ÿä¸€ç³»åˆ—å¯èƒ½çš„è¡Œä¸ºï¼Œå¹¶é’ˆå¯¹å…·ä½“æƒ…å†µæ£€æŸ¥å®šç†ã€‚å¦‚æœå¯è¾¾çŠ¶æ€é›†è¶³å¤Ÿå°(æœ‰é™å°†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€å§‹)ï¼Œæˆ‘ä»¬å¯ä»¥æšä¸¾æ‰€æœ‰è¡Œä¸ºå¹¶äº§ç”Ÿæš´åŠ›è¯æ˜ã€‚å¦‚æœå¯è¾¾çŠ¶æ€å¤ªå¤šï¼Œæˆ‘ä»¬ä¸èƒ½ç”¨è¿™ç§æ–¹å¼è¯æ˜å®šç†ï¼Œä½†æˆ‘ä»¬é€šå¸¸å¯ä»¥é€šè¿‡æ‰¾åˆ°åä¾‹æ¥è¯æ˜å®ƒæ˜¯é”™è¯¯çš„ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„æƒ³æ³•ã€‚å¦‚æœå¯è¾¾çŠ¶æ€å¤ªå¤šï¼Œæˆ‘ä»¬å°±ä¸èƒ½ç”¨è¿™ç§æ–¹å¼è¯æ˜å®šç†ï¼Œä½†æˆ‘ä»¬é€šå¸¸å¯ä»¥é€šè¿‡æ‰¾åˆ°åä¾‹æ¥è¯æ˜å®ƒæ˜¯é”™è¯¯çš„ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„æƒ³æ³•ï¼šå¦‚æœå¯è¾¾çŠ¶æ€é›†è¶³å¤Ÿå°(æœ‰é™å°†æ˜¯ä¸€ä¸ªå¥½çš„å¼€å§‹)ï¼Œæˆ‘ä»¬å¯ä»¥åˆ—ä¸¾æ‰€æœ‰è¡Œä¸ºå¹¶äº§ç”Ÿæš´åŠ›è¯æ˜ã€‚</p><p> Having mastered the basic vocabulary, letâ€™s start slowly building towards Paxos.We begin with defining what consensus is.As this is math, weâ€™ll do it using sets.</p><p>æŒæ¡äº†åŸºæœ¬è¯æ±‡åï¼Œè®©æˆ‘ä»¬å¼€å§‹æ…¢æ…¢æ„å»ºPaxosã€‚æˆ‘ä»¬é¦–å…ˆå®šä¹‰å…±è¯†æ˜¯ä»€ä¹ˆã€‚å› ä¸ºè¿™æ˜¯æ•°å­¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä½¿ç”¨é›†åˆæ¥å®Œæˆã€‚</p><p> Sets: ğ• -- Arbitrary set of valuesVars: chosen âˆˆ 2^ğ• -- Subset of valuesTheorem: âˆ€ i: |chosen_i| â‰¤ 1 âˆ§ âˆ€ i, j: i â‰¤ j âˆ§ chosen_i â‰  {} â‡’ chosen_i = chosen_j-- Notation-- {}: empty set-- 2^X: set of all subsets of X, powerset-- |X|: cardinality (size) of the set</p><p>é›†åˆï¼šğ•--ä»»æ„å€¼é›†åˆVarsï¼šSELECTEDâˆˆ2^ğ•--å€¼å­é›†å®šç†ï¼šâˆ€iï¼š|SELECTED_I|â‰¤1âˆ§âˆ€iï¼Œjï¼šiâ‰¤jâˆ§SELECTED_Iâ‰ {}â‡’CHOSED_I=SELECTED_j--NOTATION--{}ï¼šç©ºé›†--2^Xï¼šç”±Xçš„æ‰€æœ‰å­é›†ç»„æˆçš„é›†åˆï¼Œå¹‚é›†--|X|ï¼šé›†åˆçš„åŸºæ•°(å¤§å°ã€‚</p><p> The state of the system is a set of chosen values.For this set to constitute consensus (over time) we need two conditions to hold:</p><p>ç³»ç»Ÿçš„çŠ¶æ€æ˜¯ä¸€ç»„é€‰å®šçš„å€¼ã€‚è¦ä½¿è¿™ç»„å€¼æ„æˆå…±è¯†(éšç€æ—¶é—´çš„æ¨ç§»)ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæ¡ä»¶æ¥æ»¡è¶³ï¼š</p><p> if we choose a value at one point in time, we stick to it (math friendly: any two chosen values are equal to each other)</p><p>å¦‚æœæˆ‘ä»¬åœ¨æŸä¸ªæ—¶é—´ç‚¹é€‰æ‹©ä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬ä¼šåšæŒä½¿ç”¨å®ƒ(æ•°å­¦å‹å¥½ï¼šä»»ä½•ä¸¤ä¸ªé€‰æ‹©çš„å€¼éƒ½ç›¸ç­‰)</p><p>  Sets: ğ• -- Arbitrary set of valuesVars: chosen âˆˆ 2^ğ• -- Subset of valuesInit â‰¡ chosen = {}Next â‰¡ chosen = {} âˆ§ âˆƒ v âˆˆ ğ•: chosen&#39; = {v}Theorem: âˆ€ i: |chosen_i| â‰¤ 1 âˆ§ âˆ€ i, j: i â‰¤ j âˆ§ (chosen_i â‰  {} â‡’ chosen_i = chosen_j)</p><p>é›†åˆï¼šğ•--ä»»æ„å€¼é›†åˆVarsï¼šSELECTEDâˆˆ2^VARS--å€¼å­é›†Initâ‰¡SELECTED={}Nextâ‰¡SELECTED={}âˆ§âˆƒvâˆˆğ•ï¼šSELECTED&#39ï¼›={v}å®šç†ï¼šâˆ€iï¼š|SELECTED_i|â‰¤1âˆ§âˆ€iï¼Œjï¼šiâ‰¤jâˆ§(SELECTED_Iâ‰ {}â‡’SELECTED_i=SELECTED_j)ã€‚</p><p> In the initial state, the set of chosen values is empty.We can make a step if the current set of chosen values is empty, in which case we select an arbitrary value.</p><p>åœ¨åˆå§‹çŠ¶æ€ä¸‹ï¼Œé€‰æ‹©çš„å€¼é›†ä¸ºç©ºã€‚å¦‚æœå½“å‰é€‰æ‹©çš„å€¼é›†ä¸ºç©ºï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€ä¸ªæ­¥éª¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä»»æ„å€¼ã€‚</p><p> This technically breaks our behavior theory: we require behaviors to be infinite, but, for this spec, we can only make a single step.The fix is to allow empty steps: a step which does not change the state at all is always valid.We call such steps â€œstuttering stepsâ€.</p><p>è¿™åœ¨æŠ€æœ¯ä¸Šæ‰“ç ´äº†æˆ‘ä»¬çš„è¡Œä¸ºç†è®ºï¼šæˆ‘ä»¬è¦æ±‚è¡Œä¸ºæ˜¯æ— é™çš„ï¼Œä½†å¯¹äºè¿™ä¸ªè§„èŒƒï¼Œæˆ‘ä»¬åªèƒ½è¿ˆå‡ºä¸€æ­¥ã€‚ä¿®å¤æ–¹æ³•æ˜¯å…è®¸ç©ºæ­¥éª¤ï¼šæ ¹æœ¬ä¸æ”¹å˜çŠ¶æ€çš„æ­¥éª¤æ€»æ˜¯æœ‰æ•ˆçš„ã€‚æˆ‘ä»¬ç§°è¿™æ ·çš„æ­¥éª¤ä¸ºâ€œå¡é¡¿æ­¥éª¤â€ã€‚</p><p> The proof of the first condition of the consensus theorem is a trivial induction.The proof of the second part is actually non-trivial, hereâ€™s a sketch.Assume that  i and  j are indices, which violate the condition.They might be far from each other in state-space, so we canâ€™t immediately apply  Next.So letâ€™s choose the  smallest  j1 âˆˆ [i+1;j] such that the condition is violated.Let  i1 = j1 - 1.The condition is still violated for  (i1, j1) pair, but this time they are subsequent steps, and we can show that  Next does not hold for them, concluding the proof.</p><p>ä¸€è‡´æ€§å®šç†ç¬¬ä¸€ä¸ªæ¡ä»¶çš„è¯æ˜æ˜¯ä¸€ä¸ªå¹³å‡¡çš„å½’çº³ï¼Œç¬¬äºŒéƒ¨åˆ†çš„è¯æ˜å®é™…ä¸Šæ˜¯éå¹³å‡¡çš„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç¤ºæ„å›¾ï¼Œå‡è®¾iå’Œjæ˜¯è¿åæ¡ä»¶çš„æŒ‡æ ‡ï¼Œå®ƒä»¬åœ¨çŠ¶æ€ç©ºé—´ä¸­å¯èƒ½ç›¸è·å¾ˆè¿œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç«‹å³åº”ç”¨ä¸‹ä¸€ä¸ªæ¡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©æœ€å°çš„J1âˆˆ[i+1ï¼›ä½¿å¾—æ¡ä»¶æ˜¯è¿åçš„ï¼Œè®¾i1=j1-1ï¼Œ(i1ï¼Œj1)å¯¹ä»ç„¶è¿åæ¡ä»¶ï¼Œä½†è¿™ä¸€æ¬¡å®ƒä»¬æ˜¯åç»­æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥è¯æ˜ä¸‹ä¸€æ­¥ä¸é€‚ç”¨äºå®ƒä»¬ï¼Œä»è€Œå¾—å‡ºè¯æ˜ã€‚(i1ï¼Œj1)å¯¹(i1ï¼Œj1)å¯¹ä»ç„¶è¿åæ¡ä»¶ï¼Œä½†è¿™æ¬¡æ˜¯åç»­æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥è¯æ˜ä¸‹ä¸€æ­¥ä¸é€‚ç”¨äºå®ƒä»¬ï¼Œä»è€Œå¾—å‡ºè¯æ˜ã€‚</p><p> Letâ€™s try to extend this to a truly distributed case, where we have  N machine (â€œacceptorsâ€).We start with formalizing the naive consensus algorithm: let acceptors vote for values, and select the value which gets a majority of votes.</p><p>è®©æˆ‘ä»¬å°è¯•å°†å…¶æ‰©å±•åˆ°çœŸæ­£åˆ†å¸ƒå¼çš„æƒ…å†µï¼Œå…¶ä¸­æˆ‘ä»¬æœ‰Nå°æœºå™¨(â€œæ¥å—è€…â€)ï¼Œæˆ‘ä»¬ä»å½¢å¼åŒ–çš„æœ´ç´ å…±è¯†ç®—æ³•å¼€å§‹ï¼šè®©æ¥å—è€…ä¸ºå€¼æŠ•ç¥¨ï¼Œå¹¶é€‰æ‹©è·å¾—å¤šæ•°é€‰ç¥¨çš„å€¼ã€‚</p><p> Sets: ğ• -- Arbitrary set of values ğ”¸ -- Finite set of acceptorsVars: votes âˆˆ 2^(ğ”¸Ã—ğ•) -- Set of (acceptor, value) pairsInit â‰¡ votes = {}Next â‰¡ âˆƒ a âˆˆ ğ”¸: âˆƒ v âˆˆ V: votes&#39; = votes âˆª {(a, v)} âˆ§ âˆ€ v âˆˆ V: (a, v) âˆ‰ voteschosen â‰¡ {v âˆˆ V: |{a âˆˆ ğ”¸: (a, v) âˆˆ votes}| &gt; |ğ”¸| / 2}</p><p>é›†åˆï¼šğ•--ä»»æ„å€¼é›†åˆğ”¸--æœ‰é™æ¥å—è€…é›†åˆVarsï¼šVotesâˆˆ2^(ğ”¸Ã—ğ•)--(æ¥å—è€…ï¼Œå€¼)å¯¹çš„é›†åˆInitâ‰¡Votes={}Nextâ‰¡âˆƒaâˆˆğ”¸ï¼šâˆƒvâˆˆVï¼šVotes&#39ï¼›=Votesâˆª{(aï¼Œv)}âˆ§âˆ€vâˆˆVï¼š(aï¼Œv)âˆ‰voteselectedâ‰¡{vâˆˆVï¼š|{aâˆˆğ”¸ï¼š(aï¼Œv)âˆˆVotes}|&gtï¼›|ğ”¸|/2}ã€‚</p><p> The state of the system is the set of all votes cast by all acceptors.We represent a vote as a pair of an acceptor and the value it voted for.Initially, the set of votes is empty.On each step, some acceptor casts a vote for some value (adds  (a, v) pair to the set of votes), but only if it hasnâ€™t voted yet.Remember that  Next is a predicate on pairs of states, so we check  votes for existing vote, but add a new one to  votes&#39;.The value is chosen if the set of acceptors which voted for the value ( {a âˆˆ ğ”¸: (a, v) âˆˆ votes}) is at least half as large as the set of all acceptors.In other words, if a majority of acceptors has voted for the value.</p><p>ç³»ç»Ÿçš„çŠ¶æ€æ˜¯æ‰€æœ‰æ¥å—è€…æŠ•å‡ºçš„æ‰€æœ‰é€‰ç¥¨çš„é›†åˆã€‚æˆ‘ä»¬å°†ä¸€å¼ é€‰ç¥¨è¡¨ç¤ºä¸ºæ¥å—è€…å’Œå®ƒæ‰€æŠ•çš„å€¼çš„ä¸€å¯¹ã€‚æœ€åˆï¼Œè¿™ç»„é€‰ç¥¨æ˜¯ç©ºçš„ã€‚åœ¨æ¯ä¸€æ­¥ä¸Šï¼Œä¸€äº›æ¥å—è€…ä¸ºæŸä¸ªå€¼æŠ•ä¸‹ä¸€ç¥¨(å°†(aï¼Œv)å¯¹åŠ åˆ°è¿™ç»„é€‰ç¥¨ä¸­)ï¼Œä½†å‰ææ˜¯å®ƒè¿˜æ²¡æœ‰æŠ•ç¥¨ã€‚è¯·è®°ä½ï¼ŒNEXTæ˜¯çŠ¶æ€å¯¹ä¸Šçš„è°“è¯ï¼Œæ‰€ä»¥æˆ‘ä»¬æ£€æŸ¥ç°æœ‰é€‰ç¥¨çš„é€‰ç¥¨ï¼Œä½†åœ¨é€‰ç¥¨ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„é€‰ç¥¨#39ï¼›å¦‚æœæŠ•ç¥¨æ”¯æŒè¯¥å€¼çš„æ¥å—è€…é›†åˆ({aâˆˆğ”¸ï¼š(aï¼Œv)âˆˆVotes})è‡³å°‘æ˜¯æ‰€æœ‰æ¥å—è€…é›†åˆçš„ä¸€åŠï¼Œåˆ™é€‰æ‹©è¯¥å€¼ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœå¤§å¤šæ•°æ¥å—è€…æŠ•ç¥¨æ”¯æŒè¯¥å€¼ã€‚</p><p>  Letâ€™s prove consensus theorem for Majority Vote protocol.TYPE ERROR, DOES NOT COMPUTE.The consensus theorem is a predicate on behaviors of states consisting of  chosen variable.Here,  chosen isnâ€™t a variable,  votes is! chosen is a function which maps current state to some boolean.</p><p>è®©æˆ‘ä»¬è¯æ˜å¤šæ•°æŠ•ç¥¨åè®®çš„å…±è¯†å®šç†ã€‚ç±»å‹é”™è¯¯ï¼Œä¸ç«äº‰ã€‚å…±è¯†å®šç†æ˜¯å…³äºç”±é€‰å®šå˜é‡ç»„æˆçš„å›½å®¶è¡Œä¸ºçš„è°“è¯ã€‚è¿™é‡Œï¼Œé€‰å®šä¸æ˜¯å˜é‡ï¼Œé€‰ç¥¨æ˜¯ï¼SELECTEDæ˜¯ä¸€ä¸ªå°†å½“å‰çŠ¶æ€æ˜ å°„åˆ°æŸä¸ªå¸ƒå°”å€¼çš„å‡½æ•°ã€‚</p><p> While it is intuitively clear what â€œconsensus theoremâ€ would look like for this case, letâ€™s make this precise.Letâ€™s  map states with  votes variable to states with  chosen variable using the majority rule,  f.This mapping naturally extends to a mapping between corresponding behaviors (sequences of steps):</p><p>è™½ç„¶ç›´è§‚ä¸Šå¾ˆæ¸…æ¥šè¿™ç§æƒ…å†µä¸‹çš„â€œå…±è¯†å®šç†â€æ˜¯ä»€ä¹ˆæ ·å­ï¼Œä½†è®©æˆ‘ä»¬æ¥ç²¾ç¡®ä¸€ä¸‹ã€‚è®©æˆ‘ä»¬ä½¿ç”¨å¤šæ•°è§„åˆ™få°†å…·æœ‰æŠ•ç¥¨å˜é‡çš„çŠ¶æ€æ˜ å°„åˆ°å…·æœ‰æ‰€é€‰å˜é‡çš„çŠ¶æ€ã€‚æ­¤æ˜ å°„è‡ªç„¶æ‰©å±•åˆ°ç›¸åº”è¡Œä¸º(æ­¥éª¤åºåˆ—)ä¹‹é—´çš„æ˜ å°„ï¼š</p><p> f(votes_0 â†’ votes_1 â†’ ...)= f(votes_0) â†’ f(votes_1) â†’ ...= chosen_0 â†’ chosen_1 â†’ ...</p><p>F(Votes_0â†’Votes_1â†’...)=f(Votes_0)â†’f(Votes_1)â†’...=SELECTED_0â†’SELECTED_1â†’...ã€‚</p><p> Now we can precisely state that for every behavior  B of majority voting spec, the theorem holds for  f(B).This yields a better way to prove this!Instead of proving the theorem directly (which would again require i1, j1 trick), we prove that our mapping  f is a homomorphism.That is, we prove that if  votes_0 â†’ votes_1 â†’ â€¦â€‹ is a behavior of the majority voting spec, then  f(votes_0) â†’ f(votes_1) â†’ â€¦â€‹ is a behavior of the consensus spec.This lets us to re-use existing proof.</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å‡†ç¡®åœ°è¯´ï¼Œå¯¹äºå¤šæ•°æŠ•ç¥¨è§„èŒƒçš„æ¯ä¸€ç§è¡Œä¸ºBï¼Œå®šç†å¯¹f(B)éƒ½æˆç«‹ã€‚è¿™æä¾›äº†ä¸€ç§æ›´å¥½çš„è¯æ˜æ–¹æ³•ï¼æˆ‘ä»¬è¯æ˜äº†æˆ‘ä»¬çš„æ˜ å°„fæ˜¯åŒæ€ï¼Œè€Œä¸æ˜¯ç›´æ¥è¯æ˜å®šç†(è¿™åŒæ ·éœ€è¦i1ï¼Œj1æŠ€å·§)ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¯æ˜äº†å¦‚æœVotes_0â†’Votes_1â†’â€¦ã€‚æŠ•ç¥¨æ˜¯å¤šæ•°æŠ•ç¥¨è§„èŒƒçš„è¡Œä¸ºï¼Œç„¶åæ˜¯f(â€‹_0)â†’f(Votes_1)â†’â€¦ã€‚â€‹æ˜¯ä¸€ç§å…±è¯†è§„èŒƒçš„è¡Œä¸ºï¼Œè¿™è®©æˆ‘ä»¬å¯ä»¥é‡ç”¨ç°æœ‰çš„è¯æ®ã€‚</p><p> The poof for initial step is trivial, but letâ€™s spell it out just to appreciate the amount of details a human mind can glance through</p><p>æœ€åˆçš„æ­¥éª¤æ˜¯å¾®ä¸è¶³é“çš„ï¼Œä½†è®©æˆ‘ä»¬æŠŠå®ƒè¯´æ¸…æ¥šï¼Œåªæ˜¯ä¸ºäº†æ¬£èµäººç±»å¤§è„‘å¯ä»¥æµè§ˆçš„ç»†èŠ‚çš„æ•°é‡ã€‚</p><p> f({votes: {}})= {chosen: {v âˆˆ V: |{a âˆˆ ğ”¸: (a, v) âˆˆ {}}| &gt; |ğ”¸| / 2}}= {chosen: {v âˆˆ V: |{}| &gt; |ğ”¸| / 2}}= {chosen: {v âˆˆ V: 0 &gt; |ğ”¸| / 2}}= {chosen: {v âˆˆ V: FALSE}}= {chosen: {}}</p><p>F({âˆˆï¼š{}})={Chooseï¼š{vâˆˆğ”¸Vï¼š|{aâˆˆï¼š(aï¼Œv)âˆˆ{}}|&gtï¼›|ğ”¸|/2}}={Chooseï¼š{vâˆˆVï¼š|{}|&gtï¼›|ğ”¸|/2}}={Chooseï¼š{vâˆˆVï¼š0&gtï¼›|ğ”¸|/2}}={Chooseï¼š{vâˆˆVï¼šFalse}}={Chooseï¼š{}}ã€‚</p><p> Letâ€™s show that if Majority Voteâ€™s  Next_m holds for  (votes, votes&#39;), then Consensusâ€™s  Next_c holds for  (f(votes), f(votes&#39;)).Thereâ€™s one obstacle on our way: this claim is false!Consider a case with three acceptors and two values:  ğ”¸ = {a1, a2, a3},  ğ• = {v1, v2}.Consider these values of  votes and  votes&#39;:</p><p>è®©æˆ‘ä»¬è¯æ˜ï¼Œå¦‚æœå¤šæ•°ç¥¨çš„next_mæ”¯æŒ(Votesï¼ŒVotes&39ï¼›)ï¼Œé‚£ä¹ˆå…±è¯†çš„next_cæ”¯æŒ(f(Votes)ï¼Œf(Votes&39ï¼›))ã€‚æˆ‘ä»¬å‰è¿›çš„é“è·¯ä¸Šæœ‰ä¸€ä¸ªéšœç¢ï¼šè¿™ä¸ªå£°æ˜æ˜¯é”™è¯¯çš„ï¼è€ƒè™‘ä¸€ä¸ªæœ‰ä¸‰ä¸ªæ¥å—è€…å’Œä¸¤ä¸ªå€¼çš„æƒ…å†µï¼šğ”¸={a1ï¼Œa2ï¼Œa3}ï¼Œğ•={v1ï¼Œv2}ã€‚è€ƒè™‘ä¸€ä¸‹æŠ•ç¥¨æ•°å’ŒæŠ•ç¥¨æ•°çš„ä»¥ä¸‹å€¼ï¼š</p><p> votes = {(a1, v1), (a2, v1), (a1, v2)}votes&#39; = {(a1, v1), (a2, v1), (a1, v2), (a3, v2)}</p><p>æŠ•ç¥¨={(a1ï¼Œv1)ï¼Œ(a2ï¼Œv1)ï¼Œ(a1ï¼Œv2)}æŠ•ç¥¨&#39ï¼›={(a1ï¼Œv1)ï¼Œ(a2ï¼Œv1)ï¼Œ(a1ï¼Œv2)ï¼Œ(a3ï¼Œv2)}ã€‚</p><p> If you just mechanically check  Next, you see that it works! a3 hasnâ€™t cast its vote, so it can do this now.The problem is that  chosen(votes) = {v1} and  chosen(votes&#39;) = {v1, v2}.</p><p>å¦‚æœä½ åªæ˜¯æœºæ¢°åœ°æ£€æŸ¥ä¸‹ä¸€æ­¥ï¼Œä½ ä¼šå‘ç°å®ƒèµ·ä½œç”¨äº†ï¼A3è¿˜æ²¡æœ‰æŠ•ç¥¨ï¼Œæ‰€ä»¥ç°åœ¨å¯ä»¥æŠ•ç¥¨äº†ï¼Œé—®é¢˜æ˜¯SELECTED(VORTS)={v1}å’ŒSELECTED(VORTS&#39ï¼›)={V1ï¼ŒV2}ã€‚</p><p> We are trying to prove too much! f works correctly only for states reachable from  Init, and the bad value of  votes where  a1 votes twice is not reachable.</p><p>æˆ‘ä»¬è¯•å›¾è¯æ˜çš„å¤ªå¤šäº†ï¼Fä»…é€‚ç”¨äºå¯ä»Initè®¿é—®çš„å·ï¼Œå¹¶ä¸”æ— æ³•è®¿é—®A1æŠ•ç¥¨ä¸¤æ¬¡çš„æŠ•ç¥¨å€¼é”™è¯¯ã€‚</p><p> So, we first should prove a lemma: each acceptor votes at most once.After that, we can prove  Next_m(votes, votes&#39;) = Next_c(f(votes), f(votes&#39;)) under the assumption of at most once voting.Specifically, if  |f(votes&#39;)| turns out to be larger than  1, then we can pick two majorities which voted for different values, which allows to pin down a single acceptor which voted twice, which is a contradiction.The rest is left as an exercise for the reader :)</p><p>å› æ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆè¦è¯æ˜ä¸€ä¸ªå¼•ç†ï¼šæ¯ä¸ªæ¥å—è€…è‡³å¤šæŠ•ç¥¨ä¸€æ¬¡ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è‡³å¤šä¸€æ¬¡æŠ•ç¥¨çš„å‡è®¾ä¸‹è¯æ˜next_m(Votesï¼ŒVotes&39ï¼›)=next_c(f(Votes)ï¼Œf(Votes&39ï¼›))ã€‚å…·ä½“åœ°è¯´ï¼Œå¦‚æœ|f(Votes)|å¤§äº1ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€‰æ‹©æŠ•ç¥¨ç»™ä¸åŒå€¼çš„ä¸¤ä¸ªå¤šæ•°ï¼Œè¿™æ ·å¯ä»¥ç¡®å®šä¸€ä¸ªæ¥å—è€…æŠ•äº†ä¸¤æ¬¡ç¥¨ï¼Œè¿™æ˜¯ä¸€ä¸ªçŸ›ç›¾çš„é—®é¢˜ã€‚å‰©ä¸‹çš„å°±ç•™ç»™è¯»è€…ç»ƒä¹ äº†ï¼š)ï¼Œå¦‚æœ|f(Votes)|å¤§äº1ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸¤ä¸ªå¤šæ•°æŠ•ç¥¨ç»™ä¸åŒçš„å€¼ï¼Œè¿™æ ·å°±å¯ä»¥ç¡®å®šä¸€ä¸ªæ¥å—è€…æŠ•äº†ä¸¤æ¬¡ç¥¨ï¼Œè¿™æ˜¯çŸ›ç›¾çš„ã€‚å‰©ä¸‹çš„å°±ç•™ç»™è¯»è€…ç»ƒä¹ äº†ï¼š)ã€‚</p><p> So, majority vote indeed implements consensus.Letâ€™s look closer at the â€œmajorityâ€ condition.It is clearly important.If we define  chosen as</p><p>å› æ­¤ï¼Œå¤šæ•°ç¥¨ç¡®å®å®ç°äº†å…±è¯†ã€‚è®©æˆ‘ä»¬æ›´ä»”ç»†åœ°çœ‹çœ‹â€œå¤šæ•°â€æ¡ä»¶ã€‚è¿™æ˜¾ç„¶å¾ˆé‡è¦ã€‚å¦‚æœæˆ‘ä»¬å°†é€‰æ‹©å®šä¹‰ä¸ºã€‚</p><p> chosen â‰¡ {v âˆˆ V: |{a âˆˆ ğ”¸: (a, v) âˆˆ votes}| &gt; 0}</p><p>é€‰æ‹©çš„â‰¡{vâˆˆVï¼š|{aâˆˆğ”¸ï¼š(aï¼Œv)âˆˆVotes}|&gtï¼›0}ã€‚</p><p> then its easy to construct a behavior with several chosen values.The property of majority we use is that any two majorities have at least one acceptor in common.But any other condition with this property would work as well as majority.For example, we can assign an integer weight to each acceptor, and require the sum of weights to be more than half.As a more specific example, consider a set of for acceptors  {a, b, c, d}.</p><p>æˆ‘ä»¬ä½¿ç”¨çš„å¤šæ•°å±æ€§æ˜¯ä»»ä½•ä¸¤ä¸ªå¤šæ•°éƒ½æœ‰è‡³å°‘ä¸€ä¸ªå…±åŒçš„æ¥å—è€…ï¼Œä½†æ˜¯ä»»ä½•å…¶ä»–å…·æœ‰æ­¤å±æ€§çš„æ¡ä»¶ä¹ŸåŒæ ·é€‚ç”¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªæ¥å—è€…åˆ†é…ä¸€ä¸ªæ•´æ•°æƒé‡ï¼Œå¹¶è¦æ±‚æƒé‡ä¹‹å’Œå¤§äºä¸€åŠã€‚ä½œä¸ºä¸€ä¸ªæ›´å…·ä½“çš„ä¾‹å­ï¼Œè€ƒè™‘ä¸€ç»„foræ¥å—è€…{aï¼Œbï¼Œcï¼Œd}ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹FORæ¥å—è€…çš„é›†åˆ{aï¼Œbï¼Œcï¼Œd}ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªæ¥å—è€…åˆ†é…ä¸€ä¸ªæ•´æ•°æƒé‡ï¼Œå¹¶è¦æ±‚æƒé‡ä¹‹å’Œå¤§äºä¸€åŠã€‚ä½œä¸ºä¸€ä¸ªæ›´å…·ä½“çš„ä¾‹å­ï¼Œè€ƒè™‘ä¸€ç»„foræ¥å—è€…{aï¼Œbï¼Œcï¼Œd}ã€‚</p><p>       Sets: ğ• -- Arbitrary set of values ğ”¸ -- Finite set of acceptors â„š âˆˆ 2^ğ”¸ -- Set of quorumsAssume: âˆ€ q1, q1 âˆˆ â„š: q1 âˆ© q2 â‰  {}Vars: votes âˆˆ 2^(ğ”¸Ã—ğ•) -- Set of (acceptor, value) pairsInit â‰¡ votes = {}Next â‰¡ âˆƒ a âˆˆ ğ”¸: âˆƒ v âˆˆ V: votes&#39; = votes âˆª {(a, v)} âˆ§ âˆ€ v âˆˆ V: (a, v) âˆ‰ voteschosen â‰¡ {v âˆˆ V: âˆƒ q âˆˆ â„š: AllVotedFor(q, v)}AllVotedFor(q, v) â‰¡ âˆ€ a âˆˆ q: (a, v) âˆˆ votes</p><p>é›†åˆï¼šğ•--ä»»æ„å€¼é›†åˆğ”¸--æœ‰é™æ¥å—è€…é›†åˆâ„šâˆˆ2^ğ”¸--ä»²è£é›†åˆå‡è®¾ï¼šâˆ€Q1ï¼ŒQ1âˆˆâ„šï¼šQ1âˆ©Q2â‰ {}Varsï¼šVotesâˆˆ2^(ğ”¸Ã—ğ•)--(æ¥å—è€…ï¼Œå€¼)å¯¹é›†åˆInitâ‰¡Votes={}Nextâ‰¡âˆƒaâˆˆğ”¸ï¼šâˆƒvâˆˆVï¼šVotes&#39ï¼›=Votesâˆª{(aï¼Œv)}âˆ§âˆ€vâˆˆVï¼š(aï¼Œv)âˆ‰Votes Chooseâ‰¡{vâˆˆVï¼šâˆƒqâˆˆâ„šï¼šAllVoted For(qï¼Œv)}AllVoted for(qï¼Œv)â‰¡âˆ€aâˆˆqï¼š(aï¼Œv)âˆˆVotesã€‚</p><p> We require to specify a set of quorumsâ€‰â€”â€‰set a of subsets of acceptors such that every two quorums have at least one acceptor in common.The value is chosen if there exists a quorum such that its every member voted for the value.</p><p>æˆ‘ä»¬éœ€è¦æŒ‡å®šä¸€ç»„Quorumâ€‰-â€‰Set aï¼Œå®ƒç”±æ¥å—è€…çš„å­é›†ç»„æˆï¼Œè¿™æ ·æ¯ä¸¤ä¸ªQuorumè‡³å°‘æœ‰ä¸€ä¸ªå…±åŒçš„æ¥å—è€…ã€‚å¦‚æœå­˜åœ¨ä¸€ä¸ªQuorumï¼Œä½¿å¾—æ¯ä¸ªæˆå‘˜éƒ½æŠ•ç¥¨æ”¯æŒè¯¥å€¼ï¼Œåˆ™é€‰æ‹©è¯¥å€¼ã€‚</p><p> Thereâ€™s one curious thing worth noting here.Consensus is a property of the whole system, thereâ€™s no single â€œplaceâ€ where we can point to and say â€œhey, this is it, this is consensusâ€.Imagine 3 acceptors, sitting on Earth, Venus, and Mars, and choosing between values  v1 and  v2.They can execute Quorum Vote algorithm without communicating with each other at all.They will necessary reach consensus without knowing which specific value they agreed on!An external observer can then travel to the three planets, collect the votes and discover the chosen value, but this feature isnâ€™t built into the algorithm itself.</p><p>è¿™é‡Œæœ‰ä¸€ä»¶å¥‡æ€ªçš„äº‹æƒ…å€¼å¾—æ³¨æ„ã€‚Consensusæ˜¯æ•´ä¸ªç³»ç»Ÿçš„å±æ€§ï¼Œæˆ‘ä»¬æ²¡æœ‰ä¸€ä¸ªâ€œåœ°æ–¹â€å¯ä»¥æŒ‡ç€è¯´â€œå˜¿ï¼Œå°±æ˜¯å®ƒï¼Œè¿™å°±æ˜¯å…±è¯†â€ã€‚æƒ³è±¡3ä¸ªæ¥å—è€…ï¼Œååœ¨åœ°çƒã€é‡‘æ˜Ÿå’Œç«æ˜Ÿä¸Šï¼Œåœ¨v1å’Œv2å€¼ä¹‹é—´è¿›è¡Œé€‰æ‹©ï¼Œä»–ä»¬å¯ä»¥æ‰§è¡Œæ³•å®šæŠ•ç¥¨ç®—æ³•ï¼Œè€Œæ ¹æœ¬ä¸éœ€è¦ç›¸äº’æ²Ÿé€šã€‚ä»–ä»¬å¿…é¡»åœ¨ä¸çŸ¥é“ä»–ä»¬åŒæ„çš„å…·ä½“å€¼çš„æƒ…å†µä¸‹è¾¾æˆå…±è¯†ï¼ç„¶åï¼Œå¤–éƒ¨è§‚å¯Ÿè€…å¯ä»¥æ—…è¡Œåˆ°è¿™ä¸‰ä¸ªè¡Œæ˜Ÿï¼Œæ”¶é›†é€‰ç¥¨ï¼Œå‘ç°é€‰æ‹©çš„å€¼ï¼Œä½†è¿™ä¸ªåŠŸèƒ½å¹¶ä¸æ˜¯ç®—æ³•æœ¬èº«çš„ç»„æˆéƒ¨åˆ†ã€‚</p><p> OK, so weâ€™ve just described an algorithm for finding consensus among  N machines, proved the consensus theorem for it, and noted that it has staggering communication efficiency:  zero messages.Should we collect our Turing Award?</p><p>å¥½çš„ï¼Œæˆ‘ä»¬åˆšåˆšæè¿°äº†ä¸€ç§åœ¨Nå°æœºå™¨ä¹‹é—´å¯»æ‰¾å…±è¯†çš„ç®—æ³•ï¼Œè¯æ˜äº†å®ƒçš„å…±è¯†å®šç†ï¼Œå¹¶æ³¨æ„åˆ°å®ƒå…·æœ‰æƒŠäººçš„é€šä¿¡æ•ˆç‡ï¼šé›¶æ¶ˆæ¯ã€‚æˆ‘ä»¬åº”è¯¥é¢†å–å›¾çµå¥–å—ï¼Ÿ</p><p> Well, no, thereâ€™s a big problem with Quorum Voteâ€‰â€”â€‰it can get stuck.Specifically, if there are three values, and the votes are evenly split between them, then no value is chosen, and only stuttering steps are possible.If you can vote for different values, it might happen that neither value receives a majority of votes.Voting satisfies the safety property, but not the liveness propertyâ€‰â€”â€‰the algorithm can get stuck even if all machines are on-line and communication is perfect.</p><p>å—¯ï¼Œä¸ï¼ŒQuorum Voteâ€‰-â€‰æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œå®ƒå¯èƒ½ä¼šè¢«å¡ä½ã€‚å…·ä½“åœ°è¯´ï¼Œå¦‚æœæœ‰ä¸‰ä¸ªå€¼ï¼Œé€‰ç¥¨åœ¨å®ƒä»¬ä¹‹é—´å¹³å‡åˆ†é…ï¼Œé‚£ä¹ˆå°±ä¸ä¼šé€‰æ‹©ä»»ä½•å€¼ï¼Œåªå¯èƒ½å‡ºç°å¡é¡¿çš„æ­¥éª¤ã€‚å¦‚æœä½ å¯ä»¥æŠ•ç¥¨ç»™ä¸åŒçš„å€¼ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸¤ä¸ªå€¼éƒ½å¾—ä¸åˆ°å¤šæ•°ç¥¨çš„æƒ…å†µã€‚æŠ•ç¥¨æ»¡è¶³å®‰å…¨å±æ€§ï¼Œä½†ä¸æ»¡è¶³æ´»æ€§å±æ€§â€‰-â€‰ï¼Œå³ä½¿æ‰€æœ‰æœºå™¨éƒ½åœ¨çº¿å¹¶ä¸”é€šä¿¡å®Œç¾ï¼Œç®—æ³•ä¹Ÿå¯èƒ½ä¼šå¡ä½ã€‚</p><p> There is a simple fix to the problem, with a rich historical tradition among many â€œdemocraticâ€ governments.Letâ€™s have a vote, and letâ€™s pick the value chosen by the majority, but letâ€™s allow to vote only for a single candidate value:</p><p>è¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªç®€å•çš„è§£å†³åŠæ³•ï¼Œåœ¨è®¸å¤šâ€œæ°‘ä¸»â€æ”¿åºœä¸­æœ‰ç€ä¸°å¯Œçš„å†å²ä¼ ç»Ÿã€‚è®©æˆ‘ä»¬è¿›è¡ŒæŠ•ç¥¨ï¼Œè®©æˆ‘ä»¬é€‰æ‹©å¤šæ•°äººé€‰æ‹©çš„å€¼ï¼Œä½†è®©æˆ‘ä»¬åªå…è®¸æŠ•ç¥¨ç»™å•ä¸€çš„å€™é€‰å€¼ï¼š</p><p> Sets: ğ• -- Arbitrary set of values ğ”¸ -- Finite set of acceptors â„š âˆˆ 2^ğ”¸ -- Set of quorumsAssume: âˆ€ q1, q1 âˆˆ â„š: q1 âˆ© q2 â‰  {}Vars: votes âˆˆ 2^(ğ”¸Ã—ğ•) -- Set of (acceptor, value) pairsInit â‰¡ votes = {}Next â‰¡ âˆƒ a âˆˆ ğ”¸, v âˆˆ V: âˆ€ (a1, v1) âˆˆ votes: v1 = v âˆ§ votes&#39; = votes âˆª {(a, v)}chosen â‰¡ {v âˆˆ V: âˆƒ q âˆˆ â„š: AllVotedFor(q, v)}AllVotedFor(q, v) â‰¡ âˆ€ a âˆˆ q: (a, v) âˆˆ votes</p><p>é›†åˆï¼šğ•--ä»»æ„å€¼é›†åˆğ”¸--æœ‰é™æ¥å—è€…é›†åˆâ„šâˆˆ2^ğ”¸--ä»²è£é›†åˆå‡è®¾ï¼šâˆ€Q1ï¼ŒQ1âˆˆâ„šï¼šQ1âˆ©Q2â‰ {}Varsï¼šVotesâˆˆ2^(ğ”¸Ã—ğ•)--(æ¥å—è€…ï¼Œå€¼)å¯¹é›†åˆInitâ‰¡Votes={}Nextâ‰¡âˆƒaâˆˆğ”¸ï¼ŒvâˆˆVï¼šâˆ€(a1ï¼Œv1)âˆˆVotesï¼šv1=vâˆ§Votes&#39ï¼›=Votesâˆª{(aï¼Œv)}Selectedâ‰¡{vâˆˆVï¼šâˆƒqâˆˆâ„šï¼šAllVoted For(qï¼Œv)}AllVoted For(qï¼Œv)â‰¡âˆ€aâˆˆqï¼š(aï¼Œv)âˆˆVotesã€‚</p><p> The new condition says that an acceptor is only allowed to cast a vote if all other votes are for the same value.As a special case, if the set of votes is empty, the acceptor can vote for any value (but all other acceptors would have to vote for this value afterwards).</p><p>æ–°çš„æ¡ä»¶è§„å®šï¼Œåªæœ‰åœ¨æ‰€æœ‰å…¶ä»–ç¥¨æ•°éƒ½ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œæ¥å—è€…æ‰èƒ½æŠ•ç¥¨ã€‚ä½œä¸ºç‰¹ä¾‹ï¼Œå¦‚æœç¥¨æ•°ä¸ºç©ºï¼Œæ¥å—è€…å¯ä»¥æŠ•ç¥¨æ”¯æŒä»»ä½•å€¼(ä½†æ‰€æœ‰å…¶ä»–æ¥å—è€…éšåéƒ½å¿…é¡»æŠ•ç¥¨æ”¯æŒè¯¥å€¼)ã€‚</p><p> From a mathematical point of view, this algorithm is perfect.From a practical stand point, not so much: an acceptor to cast the first vote somehow needs to make sure that it is indeed the first one.The obvious fix to this problem is to assign a unique integer number to each acceptor, call the highest-numbered acceptor â€œleaderâ€, and allow only the leader to cast the first decisive vote.</p><p>ä»æ•°å­¦çš„è§’åº¦çœ‹ï¼Œè¿™ä¸ªç®—æ³•æ˜¯å®Œç¾çš„ã€‚ä»å®ç”¨çš„è§’åº¦æ¥çœ‹ï¼Œå¹¶éå¦‚æ­¤ï¼šæ¥å—äººæŠ•ç¬¬ä¸€ç¥¨éœ€è¦ä»¥æŸç§æ–¹å¼ç¡®ä¿å®ƒç¡®å®æ˜¯ç¬¬ä¸€ç¥¨ã€‚è¿™ä¸ªé—®é¢˜çš„æ˜æ˜¾è§£å†³åŠæ³•æ˜¯ç»™æ¯ä¸ªæ¥å—äººåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°ï¼Œç§°äººæ•°æœ€å¤šçš„æ¥å—äººä¸ºâ€œé¢†å…ˆè€…â€ï¼Œåªå…è®¸é¢†å…ˆè€…æŠ•ç¬¬ä¸€å¼ å†³å®šæ€§çš„ä¸€ç¥¨ã€‚</p><p> So acceptors first communicate with each other to figure out who the leader is, then the leader casts the vote, and the followers follow.But this also violates liveness: if the leader dies, then the followers would wait indefinitely.A fix for this problem is to let the second highest acceptor to take over the leadership if the leader perishes.But under our assumptions, itâ€™s impossible to distinguish between a situation when the leader is dead from a situation when it just has a  really bad internet connection.So naively picking successor would lead to a split vote and a standstill again (power transitions are known to be problematic for authoritarian regimes in real life too!).If only there were some kind of â€¦â€‹ distributed consensus algorithm for picking the leader!</p><p>å› æ­¤ï¼Œæ¥å—è€…é¦–å…ˆç›¸äº’æ²Ÿé€šï¼Œå¼„æ¸…æ¥šè°æ˜¯é¢†å¯¼è€…ï¼Œç„¶åé¢†å¯¼è€…æŠ•ç¥¨ï¼Œè¿½éšè€…è·Ÿéšã€‚ä½†è¿™ä¹Ÿè¿åäº†æ´»è·ƒæ€§ï¼šå¦‚æœé¢†å¯¼è€…æ­»äº¡ï¼Œè¿½éšè€…å°±ä¼šæ— é™æœŸåœ°ç­‰å¾…ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ä¸ªåŠæ³•æ˜¯ï¼Œå¦‚æœé¢†å¯¼è€…æ­»äº¡ï¼Œè®©ç¬¬äºŒé«˜æ¥å—è€…æ¥ç®¡é¢†å¯¼æƒã€‚ä½†åœ¨æˆ‘ä»¬çš„å‡è®¾ä¸‹ï¼Œå¾ˆéš¾å°†é¢†å¯¼äººå»ä¸–çš„æƒ…å†µä¸ç½‘ç»œè¿æ¥éå¸¸ç³Ÿç³•çš„æƒ…å†µåŒºåˆ†å¼€æ¥ã€‚å› æ­¤ï¼Œå¤©çœŸåœ°é€‰æ‹©ç»§ä»»è€…ä¼šå¯¼è‡´åˆ†è£‚æŠ•ç¥¨å’Œå†æ¬¡åœæ»ä¸å‰(ä¼—æ‰€å‘¨çŸ¥ï¼ŒæƒåŠ›äº¤æ¥åœ¨ç°å®ç”Ÿæ´»ä¸­å¯¹å¨æƒæ”¿æƒä¹Ÿæ˜¯æœ‰é—®é¢˜çš„ï¼)ã€‚å¦‚æœæœ‰æŸç§å½¢å¼çš„â€¦å°±å¥½äº†ã€‚â€‹åˆ†å¸ƒå¼åå•†é€‰å‡ºé¢†è¢–ç®—æ³•ï¼</p><p> This is the place were we start discussing real Paxos :-)It starts with a â€œballot votingâ€ algorithm.This algorithm, just like the ones weâ€™ve already seen, does not define any messages.Rather, message passing is an implementation detail, so weâ€™ll get to it later.</p><p>è¿™æ˜¯æˆ‘ä»¬å¼€å§‹è®¨è®ºçœŸæ­£çš„Paxosçš„åœ°æ–¹ï¼š-)å®ƒä»â€œæŠ•ç¥¨æŠ•ç¥¨â€ç®—æ³•å¼€å§‹ã€‚è¿™ä¸ªç®—æ³•å’Œæˆ‘ä»¬å·²ç»çœ‹åˆ°çš„ç®—æ³•ä¸€æ ·ï¼Œæ²¡æœ‰å®šä¹‰ä»»ä½•æ¶ˆæ¯ã€‚ç›¸åï¼Œæ¶ˆæ¯ä¼ é€’æ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬ç¨åå†è®¨è®ºå®ƒã€‚</p><p> Recall that rigged voting requires all acceptors to vote for a single values.It is immune to split voting, but is susceptible to getting stuck when the leader goes offline.The idea behind ballot voting is to have many voting rounds, ballots.In each ballot, acceptors can vote only for a single value, so each ballot individually can get stuck.However, as we are running many ballots, some ballots will make progress.The value is chosen in a ballot if it is chosen by some quorum of acceptors.The value is chosen in an overall algorithm if it is chosen in some ballot.</p><p>å›æƒ³ä¸€ä¸‹ï¼Œèˆå¼ŠæŠ•ç¥¨è¦æ±‚æ‰€æœ‰æ¥å—è€…æŠ•ç¥¨ç»™å•ä¸€çš„å€¼ã€‚å®ƒä¸å—åˆ†å¼€æŠ•ç¥¨çš„å½±å“ï¼Œä½†å½“é¢†å…ˆè€…è„±æœºæ—¶å®¹æ˜“è¢«å¡ä½ã€‚æŠ½ç­¾èƒŒåçš„æƒ³æ³•æ˜¯æœ‰è®¸å¤šè½®æŠ•ç¥¨ï¼Œå³æŠ½ç­¾ã€‚åœ¨æ¯ä¸€è½®æŠ•ç¥¨ä¸­ï¼Œæ¥å—è€…åªèƒ½æŠ•ç¥¨ç»™å•ä¸€çš„å€¼ï¼Œæ‰€ä»¥æ¯ä¸€ç¥¨éƒ½å¯èƒ½è¢«å¡ä½ã€‚ä½†æ˜¯ï¼Œç”±äºæˆ‘ä»¬æ­£åœ¨è¿›è¡Œå¤šè½®æŠ•ç¥¨ï¼Œæœ‰äº›é€‰ç¥¨ä¼šå–å¾—è¿›å±•ã€‚å¦‚æœå€¼æ˜¯ç”±ä¸€å®šçš„æ³•å®šäººæ•°é€‰æ‹©çš„ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯åœ¨æŠ•ç¥¨ä¸­é€‰å‡ºçš„ã€‚å¦‚æœå€¼æ˜¯åœ¨æŸäº›é€‰ç¥¨ä¸­é€‰å‡ºçš„ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯åœ¨ä¸€ä¸ªæ•´ä½“çš„ç®—æ³•ä¸­é€‰å‡ºçš„ï¼Œå¦‚æœå®ƒæ˜¯åœ¨ä¸€äº›é€‰ç¥¨ä¸­é€‰å‡ºçš„ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯åœ¨ä¸€ä¸ªæ•´ä½“çš„ç®—æ³•ä¸­é€‰å‡ºçš„ã€‚</p><p> The Turing award question is: how do we make sure that no two ballots choose different values?Note that it is OK if two ballots choose the same value.</p><p>å›¾çµå¥–çš„é—®é¢˜æ˜¯ï¼šæˆ‘ä»¬å¦‚ä½•ç¡®ä¿æ²¡æœ‰ä¸¤ä¸ªé€‰ç¥¨é€‰æ‹©ä¸åŒçš„å€¼ï¼Ÿè¯·æ³¨æ„ï¼Œå¦‚æœä¸¤ä¸ªé€‰ç¥¨é€‰æ‹©ç›¸åŒçš„å€¼ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p> Letâ€™s just brute force this question, really.First, assume that the ballots are ordered (for example, by numbering them with natural numbers).And letâ€™s say we want to pick some value  v to vote for in ballot  b.When  v is safe?Well, when no other value  v1 can be chosen by any other ballot.Letâ€™s tighten this up a bit.</p><p>è®©æˆ‘ä»¬çœŸçš„ç²—æš´åœ°å¼ºè¡Œå›ç­”è¿™ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œå‡è®¾é€‰ç¥¨æ˜¯æœ‰åºçš„(ä¾‹å¦‚ï¼Œç”¨è‡ªç„¶æ•°ç¼–å·)ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦åœ¨é€‰ç¥¨bä¸­é€‰æ‹©æŸä¸ªå€¼væ¥æŠ•ç¥¨ã€‚ä»€ä¹ˆæ—¶å€™væ˜¯å®‰å…¨çš„ï¼Ÿå¥½çš„ï¼Œå½“å…¶ä»–ä»»ä½•é€‰ç¥¨éƒ½ä¸èƒ½é€‰æ‹©å…¶ä»–å€¼v1æ—¶ã€‚è®©æˆ‘ä»¬æŠŠè¿™ä¸ªé™åˆ¶å¾—æ›´ç´§ä¸€äº›ã€‚</p><p> Value  v is safe at ballot  b if any smaller ballot  b1 ( b1 &lt; b) did not choose and will not choose any value other than  v.</p><p>å¦‚æœä»»ä½•è¾ƒå°çš„é€‰ç¥¨b1(b1&ltï¼›b)æ²¡æœ‰é€‰æ‹©ä¹Ÿä¸ä¼šé€‰æ‹©é™¤vä¹‹å¤–çš„ä»»ä½•å€¼ï¼Œåˆ™å€¼våœ¨é€‰ç¥¨bå¤„æ˜¯å®‰å…¨çš„ã€‚</p><p> So yeah, easy-peasy, we  just need to predict which values will be chosen in the future, and we are done!Weâ€™ll deal with it in a moment, but letâ€™s first convince ourselves that, if we only select safe values for voting, we wonâ€™t violate consensus spec.</p><p>æ‰€ä»¥ï¼Œç®€å•åœ°è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦é¢„æµ‹æœªæ¥å°†é€‰æ‹©å“ªäº›ä»·å€¼è§‚ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ï¼æˆ‘ä»¬ç¨åä¼šå¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œä½†è®©æˆ‘ä»¬é¦–å…ˆè¯´æœè‡ªå·±ï¼Œå¦‚æœæˆ‘ä»¬åªé€‰æ‹©å®‰å…¨çš„ä»·å€¼è§‚è¿›è¡ŒæŠ•ç¥¨ï¼Œæˆ‘ä»¬å°±ä¸ä¼šè¿åå…±è¯†è§„èŒƒã€‚</p><p> So, when we select a safe value  v to vote for in a particular ballot, it might get chosen in this ballot.We need to check that it wonâ€™t conflict with any other value.For smaller ballots thatâ€™s easyâ€‰â€”â€‰itâ€™s the definition of safety condition.What if we conflict with some value  v1 chosen in a future ballot?Well, that value is also safe, so whoever chose  v1, was sure that it wonâ€™t conflict with  v.</p><p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åœ¨æŸä¸€æ¬¡æŠ•ç¥¨ä¸­é€‰æ‹©ä¸€ä¸ªå®‰å…¨å€¼væ—¶ï¼Œå®ƒå¯èƒ½ä¼šåœ¨è¿™æ¬¡æŠ•ç¥¨ä¸­è¢«é€‰ä¸­ã€‚æˆ‘ä»¬éœ€è¦æ£€æŸ¥å®ƒæ˜¯å¦ä¸ä¼šä¸ä»»ä½•å…¶ä»–å€¼å†²çªã€‚å¯¹äºè¾ƒå°çš„é€‰ç¥¨ï¼Œè¿™å¾ˆå®¹æ˜“â€‰-â€‰ï¼Œè¿™æ˜¯å®‰å…¨æ¡ä»¶çš„å®šä¹‰ã€‚å¦‚æœæˆ‘ä»¬ä¸å°†æ¥æŠ•ç¥¨ä¸­é€‰æ‹©çš„æŸä¸ªå€¼v1å‘ç”Ÿå†²çªæ€ä¹ˆåŠï¼Ÿå—¯ï¼Œè¿™ä¸ªå€¼ä¹Ÿæ˜¯å®‰å…¨çš„ï¼Œæ‰€ä»¥æ— è®ºè°é€‰æ‹©äº†v1ï¼Œéƒ½è‚¯å®šå®ƒä¸ä¼šä¸vå†²çªã€‚</p><p> How do we tackle the precognition problem?Weâ€™ll ask acceptors to commit to  not voting in certain ballots.For example, if you are looking for a safe value for ballot  b and know that thereâ€™s a quorum  q such that each quorum member never voted in smaller ballots, and promised to never vote in smaller ballots, you can be sure that any value is safe.Indeed, any quorum in smaller ballots will have at least one member which would refuse to vote for any value.</p><p>æˆ‘ä»¬å¦‚ä½•è§£å†³é¢„çŸ¥é—®é¢˜ï¼Ÿæˆ‘ä»¬å°†è¦æ±‚æ¥å—è€…æ‰¿è¯ºä¸åœ¨æŸäº›é€‰ç¥¨ä¸­æŠ•ç¥¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªå®‰å…¨çš„bé€‰ç¥¨å€¼ï¼Œå¹¶ä¸”çŸ¥é“æœ‰ä¸€ä¸ªæ³•å®šäººæ•°Qï¼Œè¿™æ ·æ¯ä¸ªæ³•å®šäººæ•°æˆå‘˜ä»æœªåœ¨è¾ƒå°çš„é€‰ç¥¨ä¸­æŠ•ç¥¨ï¼Œå¹¶ä¸”æ‰¿è¯ºæ°¸è¿œä¸ä¼šåœ¨è¾ƒå°çš„é€‰ç¥¨ä¸­æŠ•ç¥¨ï¼Œä½ å¯ä»¥ç¡®å®šä»»ä½•å€¼éƒ½æ˜¯å®‰å…¨çš„ã€‚äº‹å®ä¸Šï¼Œä»»ä½•è¾ƒå°é€‰ç¥¨ä¸­çš„ä»»ä½•æ³•å®šäººæ•°éƒ½å°†è‡³å°‘æœ‰ä¸€ä¸ªæˆå‘˜æ‹’ç»æŠ•ç¥¨ç»™ä»»ä½•å€¼ã€‚</p><p> Ok, but what if thereâ€™s some quorum member which has already voted for some  v1 in some ballot  b1 &lt; b?(Take a deep breath, the next sentence is the kernel of the core idea of Paxos).Well, that means that  v1 was safe at  b1, so, if there will be no votes between  b1 and  b,  v1 is also safe at  b!(Exhale).In other words, to pick a safe value at  b we:</p><p>å¥½çš„ï¼Œä½†æ˜¯å¦‚æœæœ‰ä¸€äº›æ³•å®šæˆå‘˜å·²ç»åœ¨ä¸€äº›é€‰ç¥¨b1å’Œbä¸­æŠ•ç¥¨ç»™äº†æŸä¸ªv1å‘¢ï¼Ÿ(æ·±å‘¼å¸ï¼Œä¸‹ä¸€å¥è¯æ˜¯Paxosæ ¸å¿ƒæ€æƒ³çš„æ ¸å¿ƒ)ã€‚å—¯ï¼Œè¿™æ„å‘³ç€v1åœ¨b1æ˜¯å®‰å…¨çš„ï¼Œæ‰€ä»¥ï¼Œå¦‚æœb1å’Œbä¹‹é—´æ²¡æœ‰é€‰ç¥¨ï¼Œv1åœ¨bï¼(å‘¼æ°”)ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚æ¢å¥è¯è¯´ï¼Œè¦åœ¨bé€‰æ‹©ä¸€ä¸ªå®‰å…¨å€¼ï¼Œæˆ‘ä»¬ï¼š</p><p> Among all of the votes already cast by the quorum members we pick the one with the highest ballot number.</p><p>åœ¨æ³•å®šäººæ•°æˆå‘˜å·²ç»æŠ•å‡ºçš„æ‰€æœ‰é€‰ç¥¨ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©å¾—ç¥¨æ•°æœ€é«˜çš„ä¸€å¼ ã€‚</p><p> To implement the â€œnever voteâ€ promise, each acceptor will maintain  maxBal value.It will never vote in ballots smaller or equal to  maxBal.</p><p>ä¸ºäº†å®ç°â€œæ°¸ä¸æŠ•ç¥¨â€çš„æ‰¿è¯ºï¼Œæ¯ä¸ªæ¥å—è€…å°†ä¿æŒmaxBalå€¼ï¼Œæ°¸è¿œä¸ä¼šåœ¨å°äºæˆ–ç­‰äºmaxBalçš„é€‰ç¥¨ä¸­æŠ•ç¥¨ã€‚</p><p> Letâ€™s stop hand-waving and put this algorithm in math.Again, we are not thinking about messages yet, and just assume that each acceptor can observe the state of the whole system.</p><p>è®©æˆ‘ä»¬åœæ­¢æŒ¥æ‰‹ï¼ŒæŠŠè¿™ä¸ªç®—æ³•ä»˜è¯¸æ•°å­¦ã€‚å¦å¤–ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è€ƒè™‘æ¶ˆæ¯ï¼Œåªæ˜¯å‡è®¾æ¯ä¸ªæ¥å—è€…éƒ½å¯ä»¥è§‚å¯Ÿæ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€ã€‚</p><p> Sets: ğ”¹ -- Numbered set of ballots (for example, â„•) ğ• -- Arbitrary set of values ğ”¸ -- Finite set of acceptors â„š âˆˆ 2^ğ”¸ -- Set of quorumsAssume: âˆ€ q1, q1 âˆˆ â„š: q1 âˆ© q2 â‰  {}Vars: -- Set of (acceptor, ballot, value) triples votes âˆˆ 2^(ğ”¸Ã—ğ”¹Ã—ğ•) -- Function that maps acceptors to ballot numbers or -1. -- maxBal :: ğ”¸ -&gt; ğ”¹ âˆª {-1} maxBal âˆˆ (ğ”¹ âˆª {-1})^ğ”¸Voted(a, b) â‰¡ âˆƒ v âˆˆ ğ•: (a, b, v) âˆˆ votesSafe(v, b) â‰¡ âˆƒ q âˆˆ â„š: âˆ€ a âˆˆ q: maxBal(a) â‰¥ b - 1 âˆ§ âˆƒ b1 âˆˆ ğ”¹ âˆª {-1}: âˆ€ b2 âˆˆ [b1+1; b-1], a âˆˆ q: Â¬Voted(a, b2) âˆ§ b1 = -1 âˆ¨</p><p>é›†åˆï¼šğ”¹--ç¼–å·çš„é€‰ç¥¨é›†åˆ(ä¾‹å¦‚ï¼Œâ„•)ğ•--ä»»æ„å€¼é›†åˆğ”¸--æ¥å—è€…çš„æœ‰é™é›†åˆâ„šâˆˆ2^ğ”¸--ä»²è£é›†åˆå‡è®¾ï¼šâˆ€Q1ï¼ŒQ1âˆˆâ„šï¼šQ1âˆ©Q2â‰ {}Varsï¼š--(æ¥å—è€…ï¼Œé€‰ç¥¨ï¼Œå€¼)ä¸‰é‡æŠ•ç¥¨é›†åˆâˆˆ2^(ğ”¸Ã—ğ”¹Ã—ğ•)--å°†æ¥å—è€…æ˜ å°„åˆ°é€‰ç¥¨ç¼–å·æˆ–-1çš„å‡½æ•°ã€‚--MAXBALï¼šï¼šğ”¸-&gtï¼›ğ”¹âˆª{-1}MaxBalâˆˆ(ğ”¹âˆª{-1})^ğ”¸Vote(aï¼Œb)â‰¡âˆƒvâˆˆğ•ï¼š(aï¼Œbï¼Œv)âˆˆvotesSafe(vï¼Œb)â‰¡âˆƒqâˆˆâ„šï¼šâˆ€aâˆˆqï¼šmaxBal(A)â‰¥b-1âˆ§âˆƒb1âˆˆğ”¹âˆª{-1}ï¼šâˆ€b2âˆˆ[b1+1ï¼›B-1]ï¼Œaâˆˆqï¼šï¼ŒæŠ•ç¥¨(aï¼Œb2)âˆ§b1=-1âˆ¨ã€‚</p><p>......</p><p>.</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://matklad.github.io/2020/11/01/notes-on-paxos.html">https://matklad.github.io/2020/11/01/notes-on-paxos.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/å…‹ç´¢æ–¯/">#å…‹ç´¢æ–¯</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/notes/">#notes</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/æŠ•ç¥¨/">#æŠ•ç¥¨</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¾å›½/">#ç¾å›½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è°·æ­Œ/">#è°·æ­Œ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¨‹åº/">#ç¨‹åº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>