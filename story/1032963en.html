<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CTOå¯æ€•çš„åœç”µæ•…äº‹</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">CTOå¯æ€•çš„åœç”µæ•…äº‹</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-03 22:14:59</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/1b8d43f0863065c4f954f4168059ebc7.jpg"><img src="http://img2.diglog.com/img/2020/11/1b8d43f0863065c4f954f4168059ebc7.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Youâ€™re sound asleep when the alarms go off. Itâ€™s 3 a.m. You wipe your eyes, check your phone. You know something is wrong. Very wrong.</p><p>é—¹é’Ÿå“çš„æ—¶å€™ä½ ç¡å¾—æ­£é¦™ã€‚ç°åœ¨æ˜¯å‡Œæ™¨3ç‚¹ã€‚ä½ æ“¦æ“¦çœ¼ç›ï¼Œçœ‹çœ‹æ‰‹æœºã€‚ä½ çŸ¥é“æœ‰äº›ä¸å¯¹åŠ²ã€‚å¤§é”™ç‰¹é”™ã€‚</p><p> The website is down. Your application is broken. The only light in the room is coming from your computer monitor. The Gremlin in the system can be hiding anywhere, and itâ€™s your teamâ€™s job to find it.</p><p>ç½‘ç«™ç˜«ç—ªäº†ã€‚æ‚¨çš„åº”ç”¨ç¨‹åºå·²æŸåã€‚æˆ¿é—´é‡Œå”¯ä¸€çš„å…‰æ¥è‡ªä½ çš„ç”µè„‘æ˜¾ç¤ºå™¨ã€‚ç³»ç»Ÿä¸­çš„Gremlinå¯èƒ½éšè—åœ¨ä»»ä½•åœ°æ–¹ï¼Œæ‰¾åˆ°å®ƒæ˜¯æ‚¨çš„å›¢é˜Ÿçš„å·¥ä½œã€‚</p><p>  As someone who runs PR for various DevOps startups, Iâ€™ve seen this story play out over and over. The reputation cost alone of a major outage is enough to instill fear in even the most seasoned engineer!</p><p>ä½œä¸ºä¸€ä¸ªä¸ºå¤šå®¶DevOpsåˆåˆ›å…¬å¸ç®¡ç†å…¬å…³çš„äººï¼Œæˆ‘çœ‹åˆ°è¿™ä¸ªæ•…äº‹ä¸€éåˆä¸€éåœ°ä¸Šæ¼”ã€‚å³ä½¿æ˜¯æœ€æœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆï¼Œå…‰æ˜¯ä¸€æ¬¡é‡å¤§åœæœºçš„å£°èª‰æˆæœ¬å°±è¶³ä»¥è®©äººæ„Ÿåˆ°ææƒ§ï¼</p><p> But the truth is, every company has system failure. And weâ€™re still a bit away from getting online systems to look more like utilities, where you flip a switch and it just works. So sharing stories and normalizing failure (e.g. transparent and blameless postmortems) are positive trends for the industry; it makes everyone feel less scared and alone.</p><p>ä½†äº‹å®æ˜¯ï¼Œæ¯å®¶å…¬å¸éƒ½æœ‰ç³»ç»Ÿæ•…éšœã€‚æˆ‘ä»¬ç¦»è®©åœ¨çº¿ç³»ç»Ÿçœ‹èµ·æ¥æ›´åƒå…¬ç”¨äº‹ä¸šå…¬å¸è¿˜æœ‰ä¸€æ®µè·¯è¦èµ°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªè¦è½»è½»ä¸€æŒ‰å¼€å…³ï¼Œå®ƒå°±èƒ½æ­£å¸¸å·¥ä½œã€‚å› æ­¤ï¼Œåˆ†äº«æ•…äº‹å’Œå°†å¤±è´¥æ­£å¸¸åŒ–(ä¾‹å¦‚ï¼Œé€æ˜å’Œæ— å¯æŒ‡è´£çš„äº‹åå¤„ç†)æ˜¯è¯¥è¡Œä¸šçš„ç§¯æè¶‹åŠ¿ï¼›å®ƒè®©æ¯ä¸ªäººéƒ½ä¸é‚£ä¹ˆå®³æ€•å’Œå­¤ç‹¬ã€‚</p><p> Iâ€™m not going to cite generic numbers about the cost of downtime. For Amazon it may be millions per hour; for your company, it may be confined to a frustrating customer experience, if dealt with swiftly. But ultimately these kinds of situations lose businesses money, hurt reputations, drain engineering resources and fuel interest in the competition.</p><p>æˆ‘ä¸æ‰“ç®—å¼•ç”¨æœ‰å…³åœæœºæˆæœ¬çš„é€šç”¨æ•°å­—ã€‚å¯¹äºšé©¬é€Šæ¥è¯´ï¼Œè¿™å¯èƒ½æ˜¯æ¯å°æ—¶æ•°ç™¾ä¸‡ç¾å…ƒï¼›å¯¹ä½ çš„å…¬å¸æ¥è¯´ï¼Œå¦‚æœå¤„ç†è¿…é€Ÿï¼Œå¯èƒ½åªä¼šé™åˆ¶åœ¨ä»¤äººæ²®ä¸§çš„å®¢æˆ·ä½“éªŒä¸Šã€‚ä½†æœ€ç»ˆï¼Œè¿™äº›æƒ…å†µä¼šè®©ä¼ä¸šèµ”é’±ï¼ŒæŸå®³å£°èª‰ï¼Œè€—å°½å·¥ç¨‹èµ„æºï¼Œå¹¶æ¿€å‘äººä»¬å¯¹ç«äº‰çš„å…´è¶£ã€‚</p><p> So in the spirit of Halloween, and more importantly in the spirit of sharing experiences to better prevent them from happening in the future, letâ€™s take a look at six scary outages stories, as told by CTOs themselves.</p><p>å› æ­¤ï¼Œæœ¬ç€ä¸‡åœ£èŠ‚çš„ç²¾ç¥ï¼Œæ›´é‡è¦çš„æ˜¯æœ¬ç€åˆ†äº«ç»éªŒä»¥æ›´å¥½åœ°é˜²æ­¢æœªæ¥å‘ç”Ÿè¿™ç§æƒ…å†µçš„ç²¾ç¥ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹CTOä»¬è‡ªå·±è®²è¿°çš„å…­ä¸ªå¯æ€•çš„åœç”µæ•…äº‹ã€‚</p><p>      â€œPush canâ€™t possibly be down. Our pushes are in a queue, and I am receiving pushes.â€</p><p>â€œæ¨ç›˜ä¸å¯èƒ½å¾€ä¸‹æ¨ã€‚æˆ‘ä»¬çš„æ¨é€åœ¨æ’é˜Ÿï¼Œè€Œæˆ‘æ­£åœ¨æ¥å—æ¨é€ã€‚â€œã€‚</p><p> â€œItâ€™s been five days, and push is STILL down. People are filing all kinds of tasks.â€</p><p>â€œå·²ç»äº”å¤©äº†ï¼Œæ¨ç›˜è¿˜æ˜¯å¾€ä¸‹ã€‚äººä»¬æ­£åœ¨å°†å„ç§ä»»åŠ¡å½’æ¡£ã€‚â€œ</p><p> â€¦ so I reluctantly started poking around. All our push metrics looked relatively normal, every test push I sent was promptly delivered. Yet the support team was right â€” people had been steadily complaining for five full days about pushes not succeeding. What on earth could it be?</p><p>â€¦ã€‚æ‰€ä»¥æˆ‘å¾ˆä¸æƒ…æ„¿åœ°å¼€å§‹å››å¤„æ‰“å¬ã€‚æˆ‘ä»¬æ‰€æœ‰çš„æ¨é€æŒ‡æ ‡çœ‹èµ·æ¥éƒ½æ¯”è¾ƒæ­£å¸¸ï¼Œæˆ‘å‘é€çš„æ¯ä¸€æ¬¡æµ‹è¯•æ¨é€éƒ½æ˜¯åŠæ—¶äº¤ä»˜çš„ã€‚ç„¶è€Œï¼Œæ”¯æŒå›¢é˜Ÿæ˜¯å¯¹çš„-äººä»¬æ•´æ•´äº”å¤©æ¥ä¸€ç›´åœ¨æŠ±æ€¨æ¨åŠ¨æ²¡æœ‰æˆåŠŸã€‚åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p> These were Android push notifications, and Android devices needed to hold a socket open to the server to subscribe to push notifications. We had tens of millions of Android devices, so we ran the push notification service in an autoscaling group. To load-balance connections across the group, we used round-robin DNS, and to increase capacity we would simply increase the size of the ASG [auto-scaling group]. Eventually, we figured out that the complaints had begun right around the last time we increased the size of the ASG, so that was a good clue. Another clue was that all the people complaining seemed to be in Eastern Europe. We asked a few of them to run a verbose trace, and thatâ€™s when we learned that the DNS record was coming back as â€¦ missing?</p><p>è¿™äº›éƒ½æ˜¯Androidæ¨é€é€šçŸ¥ï¼ŒAndroidè®¾å¤‡éœ€è¦å‘æœåŠ¡å™¨æ‰“å¼€ä¸€ä¸ªå¥—æ¥å­—æ‰èƒ½è®¢é˜…æ¨é€é€šçŸ¥ã€‚æˆ‘ä»¬æœ‰æ•°ä»¥åƒä¸‡è®¡çš„Androidè®¾å¤‡ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸€ä¸ªè‡ªåŠ¨ä¼¸ç¼©ç»„ä¸­è¿è¡Œæ¨é€é€šçŸ¥æœåŠ¡ã€‚ä¸ºäº†åœ¨æ•´ä¸ªç»„ä¸­å®ç°è¿æ¥è´Ÿè½½å¹³è¡¡ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å¾ªç¯DNSï¼Œè€Œè¦å¢åŠ å®¹é‡ï¼Œæˆ‘ä»¬åªéœ€å¢åŠ ASG[è‡ªåŠ¨ä¼¸ç¼©ç»„]çš„å¤§å°å³å¯ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬å‘ç°æŠ•è¯‰æ˜¯åœ¨æˆ‘ä»¬æœ€åä¸€æ¬¡å¢åŠ ASGå¤§å°çš„æ—¶å€™å¼€å§‹çš„ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„çº¿ç´¢ã€‚å¦ä¸€æ¡çº¿ç´¢æ˜¯ï¼Œæ‰€æœ‰æŠ±æ€¨çš„äººä¼¼ä¹éƒ½åœ¨ä¸œæ¬§ã€‚æˆ‘ä»¬è¦æ±‚ä»–ä»¬ä¸­çš„ä¸€äº›äººè¿è¡Œè¯¦ç»†çš„è·Ÿè¸ªï¼Œå°±åœ¨é‚£æ—¶æˆ‘ä»¬äº†è§£åˆ°dnsè®°å½•å°†ä»¥â€¦çš„å½¢å¼è¿”å›ã€‚å¤±è¸ªäº†å—ï¼Ÿ</p><p> Turns out that when we increased the size of the ASG, the round-robin DNS record exceeded the UDP packet size. Normally this is no big deal; the protocol says it should fall back to using TCP in that instance. And it did, for almost everyone. Except for users behind one major router in Romania. We delegated DNS for that record from route53 to a small local python DNS server that let us return a random subset of four Android push notification servers, and everything was fine again. ğŸ’€</p><p>ç»“æœå‘ç°ï¼Œå½“æˆ‘ä»¬å¢åŠ ASGçš„å¤§å°æ—¶ï¼Œå¾ªç¯DNSè®°å½•è¶…è¿‡äº†UDPæ•°æ®åŒ…çš„å¤§å°ã€‚é€šå¸¸è¿™æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ï¼›åè®®è¯´åœ¨è¿™ç§æƒ…å†µä¸‹åº”è¯¥é€€å›åˆ°ä½¿ç”¨TCPã€‚å®ƒç¡®å®å‘ç”Ÿäº†ï¼Œå¯¹å‡ ä¹æ¯ä¸ªäººæ¥è¯´éƒ½æ˜¯å¦‚æ­¤ã€‚é™¤äº†ç½—é©¬å°¼äºšä¸€å°ä¸»è¦è·¯ç”±å™¨åé¢çš„ç”¨æˆ·ã€‚æˆ‘ä»¬å°†è¯¥è®°å½•çš„DNSä»route53å§”æ‰˜ç»™ä¸€ä¸ªå°å‹çš„æœ¬åœ°python DNSæœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨å…è®¸æˆ‘ä»¬è¿”å›4ä¸ªAndroidæ¨é€é€šçŸ¥æœåŠ¡å™¨çš„éšæœºå­é›†ï¼Œç„¶åä¸€åˆ‡éƒ½æ¢å¤æ­£å¸¸ã€‚ğŸ’€ã€‚</p><p>   The outage occurred on a Friday afternoon, just as we were about to head out to Halloween Happy Hour. The page came in that we were serving exclusively 500s â€” a bad, bad experience for customers. After some digging, we realized that our hosts had filled up their disks, and we started failing because we couldnâ€™t write logs (also scary because we were flying blind).</p><p>åœç”µå‘ç”Ÿåœ¨ä¸€ä¸ªå‘¨äº”çš„ä¸‹åˆï¼Œå½“æ—¶æˆ‘ä»¬æ­£å‡†å¤‡å»ä¸‡åœ£èŠ‚æ¬¢ä¹æ—¶å…‰ã€‚ä¼ æ¥çš„é¡µé¢æ˜¾ç¤ºï¼Œæˆ‘ä»¬åªä¸º500æä¾›æœåŠ¡-è¿™å¯¹å®¢æˆ·æ¥è¯´æ˜¯ä¸€ç§éå¸¸éå¸¸ç³Ÿç³•çš„ä½“éªŒã€‚ç»è¿‡ä¸€äº›æŒ–æ˜ï¼Œæˆ‘ä»¬æ„è¯†åˆ°æˆ‘ä»¬çš„ä¸»æœºå·²ç»å¡«æ»¡äº†ä»–ä»¬çš„ç£ç›˜ï¼Œæˆ‘ä»¬å¼€å§‹å¤±è´¥ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½å†™æ—¥å¿—(ä¹Ÿå¾ˆå¯æ€•ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯åœ¨ç›²ç›®é£è¡Œ)ã€‚</p><p> We ended up refreshing the hosts, implementing log rotation to prevent that from happening in the future, and creating an alarm to warn us if we were ever getting close again. But the most interesting thing we did is have one of our engineers write a new Gremlin for our platform: the disk Gremlin to make sure we could proactively exercise the fixes to make sure we never failed that way again. Then we automated that test and that test still lingers, running randomly in our production environment to this very day. ğŸ˜±</p><p>æˆ‘ä»¬æœ€ç»ˆåˆ·æ–°äº†ä¸»æœºï¼Œå®ç°äº†æ—¥å¿—è½®æ¢ä»¥é˜²æ­¢å°†æ¥å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå¹¶åˆ›å»ºäº†è­¦æŠ¥ä»¥è­¦å‘Šæˆ‘ä»¬æ˜¯å¦å†æ¬¡æ¥è¿‘ã€‚ä½†æœ€æœ‰è¶£çš„æ˜¯ï¼Œæˆ‘ä»¬è®©ä¸€ä½å·¥ç¨‹å¸ˆä¸ºæˆ‘ä»¬çš„å¹³å°ç¼–å†™äº†ä¸€ä¸ªæ–°çš„Gremlinï¼šDisk Gremlinï¼Œä»¥ç¡®ä¿æˆ‘ä»¬å¯ä»¥ä¸»åŠ¨æ‰§è¡Œä¿®å¤ï¼Œç¡®ä¿æˆ‘ä»¬ä¸ä¼šå†ä»¥è¿™ç§æ–¹å¼å¤±è´¥ã€‚ç„¶åï¼Œæˆ‘ä»¬è‡ªåŠ¨åŒ–äº†è¯¥æµ‹è¯•ï¼Œè€Œè¯¥æµ‹è¯•ä»ç„¶æŒ¥ä¹‹ä¸å»ï¼Œç›´åˆ°ä»Šå¤©ä»åœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­éšæœºè¿è¡Œã€‚ğŸ˜±ã€‚</p><p>   Remember that urban legend about a server going down everyday, at the same specific hour? And after weeks of investigations, someone looked at the security camera footageâ€¦ and found out that the maid was disconnecting the server to connect the vacuum cleaner! Well, we all know that the Gremlin in the closet isnâ€™t always as scary or mysterious as we initially think :)</p><p>è¿˜è®°å¾—é‚£ä¸ªå…³äºæœåŠ¡å™¨æ¯å¤©åœ¨åŒä¸€ç‰¹å®šæ—¶é—´åœæœºçš„éƒ½å¸‚ä¼ è¯´å—ï¼Ÿç»è¿‡å‡ å‘¨çš„è°ƒæŸ¥ï¼Œæœ‰äººçœ‹äº†ç›‘æ§å½•åƒâ€¦ã€‚å‘ç°å¥³ä½£æ­£åœ¨æ–­å¼€æœåŠ¡å™¨è¿æ¥å¸å°˜å™¨ï¼å—¯ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œè¡£æŸœé‡Œçš„Gremlinå¹¶ä¸æ€»æ˜¯åƒæˆ‘ä»¬æœ€åˆæƒ³è±¡çš„é‚£æ ·å¯æ€•æˆ–ç¥ç§˜ï¼š)ã€‚</p><p>  Several times a week, weâ€™d been seeing the backendâ€™s latency metrics going through the roof. And each time we investigated it, we noticed one of the tables getting locked and queries kept timing out all over. We wondered: Is one of our customers redeploying their application non-stop? The main suspect was a complex query which fetches the list of all our customersâ€™ serversâ€™ information, so theyâ€™ll be able to choose which of them they would like to debug. We started optimizing that query and saw huge improvements, yet those latency spikes kept happening.</p><p>æ¯å‘¨æœ‰å¥½å‡ æ¬¡ï¼Œæˆ‘ä»¬éƒ½çœ‹åˆ°åç«¯çš„å»¶è¿ŸæŒ‡æ ‡è¾¾åˆ°äº†é¡¶å³°ã€‚æ¯æ¬¡æˆ‘ä»¬è°ƒæŸ¥å®ƒæ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šæ³¨æ„åˆ°å…¶ä¸­ä¸€ä¸ªè¡¨è¢«é”å®šï¼Œå¹¶ä¸”æ‰€æœ‰æŸ¥è¯¢éƒ½ä¸æ–­è¶…æ—¶ã€‚æˆ‘ä»¬æƒ³çŸ¥é“ï¼šæˆ‘ä»¬çš„ä¸€ä¸ªå®¢æˆ·æ˜¯å¦ä¸é—´æ–­åœ°é‡æ–°éƒ¨ç½²ä»–ä»¬çš„åº”ç”¨ç¨‹åºï¼Ÿä¸»è¦çš„ç–‘ç‚¹æ˜¯ä¸€ä¸ªå¤æ‚çš„æŸ¥è¯¢ï¼Œå®ƒè·å–æˆ‘ä»¬æ‰€æœ‰å®¢æˆ·çš„æœåŠ¡å™¨ä¿¡æ¯çš„åˆ—è¡¨ï¼Œè¿™æ ·ä»–ä»¬å°±å¯ä»¥é€‰æ‹©è¦è°ƒè¯•çš„æœåŠ¡å™¨ã€‚æˆ‘ä»¬å¼€å§‹ä¼˜åŒ–è¯¥æŸ¥è¯¢ï¼Œçœ‹åˆ°äº†å·¨å¤§çš„æ”¹è¿›ï¼Œä½†è¿™äº›å»¶è¿Ÿå³°å€¼ä»åœ¨ä¸æ–­å‘ç”Ÿã€‚</p><p> Then a couple of weeks ago, while attending the weekly â€œCustomer Success Briefing,â€ the latency spike was happening again and it hit me like a brick. I noticed a query that we barely used, from our applicationâ€™s back office, that was really slow because we never prioritized fixing it (it was scarcely used). Apparently, our customer success manager had been collecting the data for the meeting, and every time the query didnâ€™t return fast enough, he just kept hitting refresh and retrying. That rarely used query was locking up our database and challenging our customer success managerâ€™s sanity! Looking back at the data, we confirmed that all of the latency peaks were aligned with Customer Success briefings. Eventually, after about 20 minutes of optimizing that query, everything returned to normal. ğŸƒ</p><p>å‡ å‘¨å‰ï¼Œåœ¨å‚åŠ æ¯å‘¨ä¸€æ¬¡çš„â€œå®¢æˆ·æˆåŠŸç®€æŠ¥ä¼šâ€æ—¶ï¼Œå»¶è¿Ÿé«˜å³°å†æ¬¡å‡ºç°ï¼Œè¿™å¯¹æˆ‘æ‰“å‡»å¾ˆå¤§ã€‚æˆ‘ä»åº”ç”¨ç¨‹åºçš„åå°æ³¨æ„åˆ°ä¸€ä¸ªæˆ‘ä»¬å¾ˆå°‘ä½¿ç”¨çš„æŸ¥è¯¢ï¼Œå®ƒéå¸¸æ…¢ï¼Œå› ä¸ºæˆ‘ä»¬ä»æ¥æ²¡æœ‰ä¼˜å…ˆä¿®å¤å®ƒ(å®ƒå‡ ä¹æ²¡æœ‰ä½¿ç”¨è¿‡)ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬çš„å®¢æˆ·æˆåŠŸç»ç†ä¸€ç›´åœ¨ä¸ºä¼šè®®æ”¶é›†æ•°æ®ï¼Œæ¯æ¬¡æŸ¥è¯¢è¿”å›å¾—ä¸å¤Ÿå¿«æ—¶ï¼Œä»–éƒ½ä¼šä¸åœåœ°ç‚¹å‡»åˆ·æ–°å’Œé‡è¯•ã€‚é‚£ä¸ªå¾ˆå°‘ä½¿ç”¨çš„æŸ¥è¯¢é”å®šäº†æˆ‘ä»¬çš„æ•°æ®åº“ï¼Œå¹¶æŒ‘æˆ˜æˆ‘ä»¬å®¢æˆ·æˆåŠŸç»ç†çš„ç†æ™ºï¼å›é¡¾æ•°æ®ï¼Œæˆ‘ä»¬ç¡®è®¤æ‰€æœ‰å»¶è¿Ÿå³°å€¼éƒ½ä¸å®¢æˆ·æˆåŠŸç®€æŠ¥ä¿æŒä¸€è‡´ã€‚æœ€ç»ˆï¼Œåœ¨ä¼˜åŒ–è¯¥æŸ¥è¯¢å¤§çº¦20åˆ†é’Ÿåï¼Œä¸€åˆ‡éƒ½æ¢å¤æ­£å¸¸ã€‚ğŸƒ</p><p>   It was a clear, sunny day in San Francisco. I was working at a small internet company, when suddenly our app stopped loading for me. Not just one view, but the whole app. Hard reload, but no luck. I looked around and my teammates were also confused; the app wasnâ€™t working for them either. Our users werenâ€™t complaining (yet?) but we started digging in anyway. No deployments had happened yet that day, no infrastructure had changed; yet it was broken consistently across OS types and browsers. What could have changed?</p><p>é‚£æ˜¯æ—§é‡‘å±±ä¸€ä¸ªæ™´æœ—é˜³å…‰ç¿çƒ‚çš„æ—¥å­ã€‚æˆ‘åœ¨ä¸€å®¶å°äº’è”ç½‘å…¬å¸å·¥ä½œï¼Œçªç„¶æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåœæ­¢ä¸ºæˆ‘åŠ è½½ã€‚ä¸åªæ˜¯ä¸€ä¸ªè§†å›¾ï¼Œè€Œæ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºã€‚é‡æ–°è£…å¼¹å¾ˆè¾›è‹¦ï¼Œä½†è¿æ°”ä¸ä½³ã€‚æˆ‘ç¯é¡¾å››å‘¨ï¼Œæˆ‘çš„é˜Ÿå‹ä»¬ä¹Ÿå¾ˆå›°æƒ‘ï¼›è¿™ä¸ªåº”ç”¨ç¨‹åºä¹Ÿä¸èƒ½ä¸ºä»–ä»¬å·¥ä½œã€‚æˆ‘ä»¬çš„ç”¨æˆ·æ²¡æœ‰æŠ±æ€¨(è¿˜æ²¡æœ‰å—ï¼Ÿ)ã€‚ä½†ä¸ç®¡æ€æ ·ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¼€å§‹æŒ–å‘äº†ã€‚é‚£ä¸€å¤©è¿˜æ²¡æœ‰è¿›è¡Œä»»ä½•éƒ¨ç½²ï¼ŒåŸºç¡€è®¾æ–½ä¹Ÿæ²¡æœ‰æ”¹å˜ï¼›ç„¶è€Œï¼Œå®ƒåœ¨å„ç§æ“ä½œç³»ç»Ÿç±»å‹å’Œæµè§ˆå™¨ä¸­éƒ½æ˜¯ä¸€è‡´å´©æºƒçš„ã€‚ä¼šæœ‰ä»€ä¹ˆæ”¹å˜å‘¢ï¼Ÿ</p><p> We found some errors in a critical (but boring-and-hadnâ€™t-changed-in-forever) API call, without which the app wouldnâ€™t load. But why were the errors only happening for people that worked at the company? And why now? It turned out that for internal users, the API returned some extra dataâ€¦extra data that had been slowly growing over the last few weeks, until it had finally exceeded the requestâ€™s maximum payload size that afternoon. ğŸ‘»</p><p>æˆ‘ä»¬åœ¨ä¸€ä¸ªå…³é”®çš„(ä½†å¾ˆæ— èŠè€Œä¸”æ²¡æœ‰æ°¸è¿œæ”¹å˜çš„)APIè°ƒç”¨ä¸­å‘ç°äº†ä¸€äº›é”™è¯¯ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›é”™è¯¯ï¼Œåº”ç”¨ç¨‹åºå°†æ— æ³•åŠ è½½ã€‚ä½†ä¸ºä»€ä¹ˆè¿™äº›é”™è¯¯åªå‘ç”Ÿåœ¨å…¬å¸çš„å‘˜å·¥èº«ä¸Šå‘¢ï¼Ÿä¸ºä»€ä¹ˆæ˜¯ç°åœ¨ï¼ŸåŸæ¥ï¼Œå¯¹äºå†…éƒ¨ç”¨æˆ·ï¼Œè¯¥æ¥å£è¿”å›äº†ä¸€äº›é¢å¤–çš„æ•°æ®â€¦ã€‚é¢å¤–çš„æ•°æ®åœ¨è¿‡å»å‡ å‘¨å†…ä¸€ç›´åœ¨ç¼“æ…¢å¢é•¿ï¼Œç›´åˆ°é‚£å¤©ä¸‹åˆæœ€ç»ˆè¶…è¿‡è¯·æ±‚çš„æœ€å¤§æœ‰æ•ˆè´Ÿè½½å¤§å°ã€‚ğŸ‘»ã€‚</p><p>   The AddTrust Root Certificate Authority (CA) we relied on expired at roughly 4 a.m. Pacific Time on Saturday morning, May 30, 2020.</p><p>æˆ‘ä»¬æ‰€ä¾èµ–çš„AddTrust Rootè¯ä¹¦é¢å‘æœºæ„(CA)å¤§çº¦åœ¨å‡Œæ™¨4ç‚¹è¿‡æœŸã€‚å¤ªå¹³æ´‹æ—¶é—´2020å¹´5æœˆ30æ—¥æ˜ŸæœŸå…­ä¸Šåˆã€‚</p><p> At the time, we were transitioning some of our infrastructure to Letâ€™s Encrypt, a nonprofit certificate authority, as part of our move to Kubernetes. Legacy Syslog clients required AddTrust/UserTrust/Comodo. We run our own SaaS environment in addition to a number of worldwide environments for a major cloud partner. In our SaaS environment, a single certificate chain is used everywhere, including our ingestion endpoint, Syslog endpoint, and web app. We thought we were ready for this root certificate expiryâ€¦ we were not.</p><p>å½“æ—¶ï¼Œä½œä¸ºè¿ç§»åˆ°Kubernetesçš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ­£åœ¨å°†æˆ‘ä»¬çš„ä¸€äº›åŸºç¡€è®¾æ–½è¿‡æ¸¡åˆ°ä¸€ä¸ªéè¥åˆ©æ€§çš„è¯ä¹¦é¢å‘æœºæ„â€œè®©æˆ‘ä»¬åŠ å¯†â€(Weâ€˜s Encrypt)ã€‚æ—§å¼ç³»ç»Ÿæ—¥å¿—å®¢æˆ·ç«¯éœ€è¦AddTrust/UserTrust/Comodoã€‚é™¤äº†ä¸ºä¸»è¦äº‘åˆä½œä¼™ä¼´è¿è¡Œå¤šä¸ªå…¨çƒç¯å¢ƒå¤–ï¼Œæˆ‘ä»¬è¿˜è¿è¡Œè‡ªå·±çš„SaaSç¯å¢ƒã€‚åœ¨æˆ‘ä»¬çš„SaaSç¯å¢ƒä¸­ï¼Œåˆ°å¤„éƒ½ä½¿ç”¨å•ä¸ªè¯ä¹¦é“¾ï¼ŒåŒ…æ‹¬æˆ‘ä»¬çš„æ¥æ”¶ç«¯ç‚¹ã€ç³»ç»Ÿæ—¥å¿—ç«¯ç‚¹å’ŒWebåº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬è®¤ä¸ºæˆ‘ä»¬å·²ç»ä¸ºè¿™ä¸ªæ ¹è¯ä¹¦è¿‡æœŸâ€¦åšå¥½äº†å‡†å¤‡ã€‚æˆ‘ä»¬æ²¡æœ‰ã€‚</p><p> Quick primer on certificate chains: All certificate-based security relies on chains of trust. Browsers and operating systems ship with these trust stores of root certificates.</p><p>è¯ä¹¦é“¾å¿«é€Ÿå…¥é—¨ï¼šæ‰€æœ‰åŸºäºè¯ä¹¦çš„å®‰å…¨æ€§éƒ½ä¾èµ–äºä¿¡ä»»é“¾ã€‚æµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿé™„å¸¦è¿™äº›æ ¹è¯ä¹¦çš„ä¿¡ä»»å­˜å‚¨åŒºã€‚</p><p> LogDNA Chain: AddTrust Root CA (expired May 30) -&gt; UserTrust CA -&gt; Sectigo -&gt; *. logdna.com</p><p>LogDNAé“¾ï¼šAddTrust Root CA(5æœˆ30æ—¥åˆ°æœŸ)-&gtï¼›UserTrust CA-&gtï¼›Sectigo-&gtï¼›*ã€‚Logdna.comã€‚</p><p>  UserTrust CA itself is also part of root trust stores of many browsers, so even if AddTrust is expired, itâ€™s ignored since the chain leading up to the UserTrust CA is still valid.</p><p>UserTrust CAæœ¬èº«ä¹Ÿæ˜¯è®¸å¤šæµè§ˆå™¨çš„æ ¹ä¿¡ä»»å­˜å‚¨çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å³ä½¿AddTrustè¿‡æœŸï¼Œå®ƒä¹Ÿä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºé€šå‘UserTrust CAçš„é“¾ä»ç„¶æœ‰æ•ˆã€‚</p><p>  Turns out, old legacy systems will only see the LogDNA chain, which is considered an invalid chain if any of the four certificates are expired. They also donâ€™t recognize UserTrust as a trusted root certificate.</p><p>åŸæ¥ï¼Œæ—§çš„é—ç•™ç³»ç»Ÿå°†åªçœ‹åˆ°LogDNAé“¾ï¼Œå¦‚æœå››ä¸ªè¯ä¹¦ä¸­çš„ä»»ä½•ä¸€ä¸ªè¿‡æœŸï¼Œå®ƒå°±è¢«è®¤ä¸ºæ˜¯æ— æ•ˆçš„é“¾ã€‚å®ƒä»¬ä¹Ÿä¸ä¼šå°†UserTrustè¯†åˆ«ä¸ºå—ä¿¡ä»»çš„æ ¹è¯ä¹¦ã€‚</p><p> All of the support tickets we received mentioned that our v1 agent was no longer sending logs to our ingestion endpoints, but our v2 agent and other modern implementations of REST API-based clients were all working fine.</p><p>æˆ‘ä»¬æ”¶åˆ°çš„æ‰€æœ‰æ”¯æŒç¥¨è¯éƒ½æåˆ°æˆ‘ä»¬çš„v1ä»£ç†ä¸å†å‘æˆ‘ä»¬çš„æ¥æ”¶ç«¯ç‚¹å‘é€æ—¥å¿—ï¼Œä½†æ˜¯æˆ‘ä»¬çš„v2ä»£ç†å’Œå…¶ä»–åŸºäºrest APIçš„å®¢æˆ·ç«¯çš„ç°ä»£å®ç°éƒ½å·¥ä½œå¾—å¾ˆå¥½ã€‚</p><p> We erroneously started working on an update to our v1 agent. Ironically, our CI/CD provider also had an outage of their own due to the same AddTrust Root CA expiration, which further complicated our rollout of that agent. Once we realized that the issue was with the actual certificate chain and how older legacy systems behaved with that chain, we quickly rectified it by switching in a new certificate chain based on Letâ€™s Encrypt. ğŸ§Ÿ</p><p>æˆ‘ä»¬é”™è¯¯åœ°å¼€å§‹å¯¹v1ä»£ç†è¿›è¡Œæ›´æ–°ã€‚å…·æœ‰è®½åˆºæ„å‘³çš„æ˜¯ï¼Œç”±äºç›¸åŒçš„AddTrust Root CAåˆ°æœŸï¼Œæˆ‘ä»¬çš„CI/CDæä¾›å•†è‡ªå·±ä¹Ÿå‘ç”Ÿäº†æ•…éšœï¼Œè¿™è¿›ä¸€æ­¥ä½¿æˆ‘ä»¬æ¨å‡ºè¯¥ä»£ç†å˜å¾—æ›´åŠ å¤æ‚ã€‚ä¸€æ—¦æˆ‘ä»¬æ„è¯†åˆ°é—®é¢˜å‡ºåœ¨å®é™…çš„è¯ä¹¦é“¾ä¸Šï¼Œä»¥åŠæ—§çš„é—ç•™ç³»ç»Ÿåœ¨è¯¥é“¾ä¸Šçš„è¡Œä¸ºå¦‚ä½•ï¼Œæˆ‘ä»¬å°±ä¼šé€šè¿‡åˆ‡æ¢åˆ°ä¸€ä¸ªåŸºäºâ€œè®©æˆ‘ä»¬åŠ å¯†â€çš„æ–°è¯ä¹¦é“¾æ¥å¿«é€Ÿçº æ­£è¿™ä¸ªé—®é¢˜ã€‚ğŸ§Ÿã€‚</p><p>   Full-on site outages are horrible â€” but they donâ€™t make your skin crawl the same way that the random, unpredictable failures really can. I was working on the mobile web version of Twitter, and we got requests that, for some random unlucky campers, caused a scary error page whenever they visited the site. For everyone else, the sky was blue and the birds were chirping. But now and again, someone else would get hit. And, once they were hit, they were stuck in a pit of despair, unable to read any tweets from their phone.</p><p>å…¨é¢çš„ç«™ç‚¹åœæœºæ˜¯å¯æ€•çš„-ä½†å®ƒä»¬ä¸ä¼šè®©æ‚¨çš„çš®è‚¤åƒéšæœºçš„ã€ä¸å¯é¢„æµ‹çš„æ•…éšœé‚£æ ·çˆ¬è¡Œã€‚æˆ‘å½“æ—¶æ­£åœ¨å¼€å‘Twitterçš„ç§»åŠ¨ç½‘ç»œç‰ˆæœ¬ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†ä¸€äº›è¯·æ±‚ï¼Œå¯¹äºä¸€äº›éšæœºå€’éœ‰çš„éœ²è¥è€…æ¥è¯´ï¼Œæ¯å½“ä»–ä»¬è®¿é—®è¯¥ç½‘ç«™æ—¶ï¼Œéƒ½ä¼šå¯¼è‡´ä¸€ä¸ªå¯æ€•çš„é”™è¯¯é¡µé¢ã€‚å¯¹äºå…¶ä»–äººæ¥è¯´ï¼Œå¤©ç©ºæ˜¯è“è‰²çš„ï¼Œé¸Ÿå„¿åœ¨å•å•¾ã€‚ä½†æ—¶ä¸æ—¶åœ°ï¼Œä¼šæœ‰å…¶ä»–äººè¢«å‡»ä¸­ã€‚è€Œä¸”ï¼Œä¸€æ—¦ä»–ä»¬è¢«å‡»ä¸­ï¼Œä»–ä»¬å°±é™·å…¥äº†ç»æœ›çš„æ·±æ¸Šï¼Œæ— æ³•é˜…è¯»æ‰‹æœºä¸Šçš„ä»»ä½•æ¨æ–‡ã€‚</p><p> Slowly, as the number of these tarnished accounts increased, the 500s started creeping up to critical levels. We were able to see that the new library we were using failed to parse session cookies with a specific character. So every time you logged back in, you were rolling the dice on getting bit by this pesky bug, and you couldnâ€™t be cured without the wizardly powers to reset your cookies on a phone. Eventually, we fixed the bug in the library, and everyone was able to go back to reading their tweetsâ€¦ which, as we know, can be a very scary thing on its own! ğŸ•¸ï¸</p><p>æ…¢æ…¢åœ°ï¼Œéšç€è¿™äº›å—æŸè´¦æˆ·æ•°é‡çš„å¢åŠ ï¼Œ500å¼€å§‹æ”€å‡åˆ°ä¸´ç•Œæ°´å¹³ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„æ–°åº“æ— æ³•è§£æå…·æœ‰ç‰¹å®šå­—ç¬¦çš„ä¼šè¯cookieã€‚æ‰€ä»¥æ¯æ¬¡ä½ é‡æ–°ç™»å½•çš„æ—¶å€™ï¼Œä½ éƒ½æ˜¯åœ¨æ·éª°å­ï¼Œè¢«è¿™ä¸ªè®¨åŒçš„æ¼æ´å’¬äº†ä¸€å£ï¼Œå¦‚æœæ²¡æœ‰é‡æ–°è®¾ç½®æ‰‹æœºcookieçš„ç¥å¥‡åŠ›é‡ï¼Œä½ å°±ä¸å¯èƒ½è¢«æ²»æ„ˆã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬ä¿®å¤äº†å›¾ä¹¦é¦†ä¸­çš„é”™è¯¯ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥å›å»é˜…è¯»ä»–ä»¬çš„æ¨æ–‡â€¦ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€çŸ¥ï¼Œè¿™æœ¬èº«å°±æ˜¯ä¸€ä»¶éå¸¸å¯æ€•çš„äº‹æƒ…ï¼ğŸ•¸ï¸</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://thenewstack.io/6-scary-outage-stories-from-ctos/">https://thenewstack.io/6-scary-outage-stories-from-ctos/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/åœç”µ/">#åœç”µ</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/outage/">#outage</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/æœåŠ¡å™¨/">#æœåŠ¡å™¨</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¾å›½/">#ç¾å›½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è°·æ­Œ/">#è°·æ­Œ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¨‹åº/">#ç¨‹åº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>