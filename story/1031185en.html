<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>å¯¹Lispè¯­æ³•çš„ç›´è§‚è®¤è¯†</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">å¯¹Lispè¯­æ³•çš„ç›´è§‚è®¤è¯†</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-26 11:23:41</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/40becf456d568eb672f89c4d3aea36ca.png"><img src="http://img2.diglog.com/img/2020/10/40becf456d568eb672f89c4d3aea36ca.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Every lisp hacker I ever met, myself included, thought that all those brackets in Lisp were off-putting and weird. At first, of course. Soon after we all came to the same epiphany:  lispâ€™s power lies in those brackets! In this essay, weâ€™ll go on a journey to that epiphany.</p><p>æˆ‘é‡åˆ°çš„æ¯ä¸ªLISPé»‘å®¢ï¼ŒåŒ…æ‹¬æˆ‘è‡ªå·±ï¼Œéƒ½è®¤ä¸ºLispä¸­çš„æ‰€æœ‰æ‹¬å·éƒ½ä»¤äººè®¨åŒå’Œå¥‡æ€ªã€‚å½“ç„¶ï¼Œä¸€å¼€å§‹æ˜¯è¿™æ ·çš„ã€‚ä¸ä¹…ä¹‹åï¼Œæˆ‘ä»¬éƒ½å¾—åˆ°äº†åŒæ ·çš„é¡¿æ‚Ÿï¼šLISPçš„åŠ›é‡åœ¨äºè¿™äº›æ‹¬å·ï¼åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è¸ä¸Šä¸€æ®µé€šå¾€é‚£ä¸ªé¡¿æ‚Ÿçš„æ—…ç¨‹ã€‚</p><p>  Say we were creating a program that let you draw stuff. If we wrote this in JavaScript, we might have functions like this:</p><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ªè®©ä½ ç”»ä¸œè¥¿çš„ç¨‹åºã€‚å¦‚æœæˆ‘ä»¬ç”¨JavaScriptç¼–å†™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæœ‰å¦‚ä¸‹å‡½æ•°ï¼š</p><p> drawPoint ({x:  0 , y:  1 },  &#39;yellow&#39; ) drawLine ({x:  0 , y:  0 }, {x:  1 , y:  1 },  &#39;blue&#39; ) drawCircle ( point ,  radius ,  &#39;red&#39; ) rotate ( shape ,  90 ) ...</p><p>DraPoint({xï¼š0ï¼Œyï¼š1}ï¼Œ&#39ï¼›é»„è‰²&#39ï¼›)draLine({xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}ï¼Œ&#39ï¼›è“è‰²&#39ï¼›)draCircle(pointï¼ŒRadiusï¼Œ&#39ï¼›ï¼›red&#39ï¼›)Rotate(Shapeï¼Œ90)...ã€‚</p><p>    This means that a user would be able to â€œsendâ€ instructions to your screen, and you would see their drawing come to life.</p><p>è¿™æ„å‘³ç€ç”¨æˆ·å°†èƒ½å¤Ÿå‘æ‚¨çš„å±å¹•â€œå‘é€â€æŒ‡ä»¤ï¼Œæ‚¨å°†çœ‹åˆ°ä»–ä»¬çš„ç»˜ç”»æ ©æ ©å¦‚ç”Ÿã€‚</p><p>  Well, say we set up a websocket connection. We could receive instructions from the user like this:</p><p>å¥½å§ï¼Œå‡è®¾æˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªç½‘ç»œæ’åº§è¿æ¥ã€‚æˆ‘ä»¬å¯ä»¥æ”¶åˆ°æ¥è‡ªç”¨æˆ·çš„æŒ‡ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>   To make it work off the bat, one option could be to take code strings as input:</p><p>è¦ä½¿å…¶å³æ—¶å·¥ä½œï¼Œä¸€ç§é€‰æ‹©æ˜¯å°†ä»£ç å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥ï¼š</p><p>  Now the user could send  &#34;drawLine({x: 0, y: 0}, {x: 1, y: 1}, &#39;red&#39;)&#34; and bam: weâ€™ll draw a line!</p><p>ç°åœ¨ï¼Œç”¨æˆ·å¯ä»¥å‘é€&#34ï¼›draLine({xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}ï¼Œ&#39ï¼›red&#39ï¼›)&#34ï¼›å’Œbamï¼šæˆ‘ä»¬è¦ç”»ä¸€æ¡çº¿ï¼</p><p> Butâ€¦your spidey sense may already be tingling. What if the user was malicious and managed to send us an instruction like this:</p><p>ä½†æ˜¯â€¦ã€‚ä½ çš„èœ˜è››æ„Ÿå¯èƒ½å·²ç»åˆºç—›äº†ã€‚å¦‚æœç”¨æˆ·æ˜¯æ¶æ„çš„ï¼Œå¹¶ä¸”è®¾æ³•å‘æˆ‘ä»¬å‘é€äº†å¦‚ä¸‹æŒ‡ä»¤ï¼Œè¯¥æ€ä¹ˆåŠï¼š</p><p>  Uh ohâ€¦our cookie would get sent to iwillp3wn.com, and the malicious user would indeed pwn us. We canâ€™t use eval; itâ€™s too dangerous.</p><p>å“¦å“¦â€¦ã€‚æˆ‘ä»¬çš„cookieä¼šè¢«å‘é€åˆ°iwill p3wn.comï¼Œè€Œæ¶æ„ç”¨æˆ·ç¡®å®ä¼šå¯¹æˆ‘ä»¬è¿›è¡Œæ”»å‡»ã€‚æˆ‘ä»¬ä¸èƒ½ç”¨EVALï¼Œå¤ªå±é™©äº†ã€‚</p><p> There lies our problem: we canâ€™t use  eval, but we need some way to receive arbitrary instructions.</p><p>è¿™å°±æ˜¯æˆ‘ä»¬çš„é—®é¢˜æ‰€åœ¨ï¼šæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨evalï¼Œä½†æˆ‘ä»¬éœ€è¦æŸç§æ–¹å¼æ¥æ¥æ”¶ä»»æ„æŒ‡ä»¤ã€‚</p><p>  Well, we could represent those instructions as JSON. We can map each JSON instruction to a special function, and that way we can control what runs. Hereâ€™s one way we can represent it:</p><p>æˆ‘ä»¬å¯ä»¥å°†è¿™äº›æŒ‡ä»¤è¡¨ç¤ºä¸ºJSONã€‚æˆ‘ä»¬å¯ä»¥å°†æ¯ä¸ªJSONæŒ‡ä»¤æ˜ å°„åˆ°ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶è¿è¡Œä»€ä¹ˆã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬å¯ä»¥è¡¨ç¤ºå®ƒçš„ä¸€ç§æ–¹å¼ï¼š</p><p> {  instructions: [  { functionName:  &#34;drawLine&#34; , args: [{ x:  0 , y:  0  }, { x:  1 , y:  1  },  &#34;blue&#34; ] },  ]; }</p><p>{è¯´æ˜ï¼š[{functionNameï¼š&#34ï¼›drawLine&#34ï¼›ï¼Œargsï¼š[{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}ï¼Œ&#34ï¼›Blue&#34ï¼›]}ï¼Œ]ï¼›}ã€‚</p><p>      Letâ€™s see if we can clean this up. Hereâ€™s our JSON:</p><p>è®©æˆ‘ä»¬çœ‹çœ‹èƒ½ä¸èƒ½æŠŠè¿™é‡Œæ¸…ç†å¹²å‡€ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬çš„JSONï¼š</p><p> {  instructions: [  { functionName:  &#34;drawLine&#34; , args: [{ x:  0 , y:  0  }, { x:  1 , y:  1  },  &#34;blue&#34; ] },  ]; }</p><p>{è¯´æ˜ï¼š[{functionNameï¼š&#34ï¼›drawLine&#34ï¼›ï¼Œargsï¼š[{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}ï¼Œ&#34ï¼›Blue&#34ï¼›]}ï¼Œ]ï¼›}ã€‚</p><p> Well, since  every instruction has a  functionName, and an  args, we donâ€™t really need to spell that out. We  could write it like this:</p><p>å› ä¸ºæ¯æ¡æŒ‡ä»¤éƒ½æœ‰functionNameå’Œargsï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦è¯¦ç»†è¯´æ˜ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p><p> {  instructions: [[ &#34;drawLine&#34; , { x:  0 , y:  0  }, { x:  1 , y:  1  },  &#34;blue&#34; ]], }</p><p>{è¯´æ˜ï¼š[[&#34ï¼›DrawLine&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}ï¼Œ&#34ï¼›Blue&#34ï¼›]]ï¼Œ}</p><p> Nice! We changed our object in favor of an array. To handle that, all we need is a rule:  the   first  part of our instruction is the function name, and the  rest are arguments. If we wrote that down, hereâ€™s how our  onMessage would look:</p><p>å¥½çš„!ã€‚æˆ‘ä»¬å°†å¯¹è±¡æ›´æ”¹ä¸ºæ”¯æŒæ•°ç»„ã€‚è¦å¤„ç†è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€æ¡è§„åˆ™ï¼šæŒ‡ä»¤çš„ç¬¬ä¸€éƒ¨åˆ†æ˜¯å‡½æ•°åï¼Œå…¶ä½™éƒ¨åˆ†æ˜¯å‚æ•°ã€‚å¦‚æœæˆ‘ä»¬æŠŠå®ƒå†™ä¸‹æ¥ï¼Œæˆ‘ä»¬çš„onMessageä¼šæ˜¯è¿™æ ·çš„ï¼š</p><p> websocket .onMessage ( data   =&gt;  {    const   fns   =  {  drawLine:  drawLine ,   ...  };   data . instructions .forEach (([ fnName ,  ... args ])  =&gt;   fns \[ fnName \]( ... args )); })</p><p>WebSocket.onMessage(data=&gtï¼›{const fns={drawLineï¼šdrawLineï¼Œ...}ï¼›data.ã€‚è¯´æ˜.forEach(([fnNameï¼Œ...ã€‚Args])=&gtï¼›fns\[fnName\](...ã€‚Args))ï¼›})ã€‚</p><p>    drawLine ({x:  0 , y:  0 }, {x:  1 , y:  1 },  &#39;blue&#39; ) // same as [ &#34;drawLine&#34; , { x:  0 , y:  0  }, { x:  1 , y:  1  }]</p><p>DrawLine({xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}ï¼Œ&#39ï¼›Blue&#39ï¼›)//ä¸[&#34ï¼›DrawLine&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}]ç›¸åŒã€‚</p><p>    [ &#34;rotate&#34; , [ &#34;drawLine&#34; , { x:  0 , y:  0  }, { x:  1 , y:  1  }],  90 ]</p><p>[&#34ï¼›Rotate&#34ï¼›ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}]ï¼Œ90]ã€‚</p><p> Here, the  rotate instruction has an argument that is in  itself an instruction! Pretty powerful. Surprisingly, we just need to tweak our code a tiny bit to make it work:</p><p>è¿™é‡Œï¼ŒRotateæŒ‡ä»¤æœ‰ä¸€ä¸ªæœ¬èº«å°±æ˜¯æŒ‡ä»¤çš„å‚æ•°ï¼ç›¸å½“å¼ºå¤§ã€‚ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæˆ‘ä»¬åªéœ€ç¨å¾®è°ƒæ•´ä»£ç å³å¯ä½¿å…¶æ­£å¸¸å·¥ä½œï¼š</p><p> websocket .onMessage ( data   =&gt;  {    const   fns   =  {  drawLine:  drawLine ,   ...  };   const   parseInstruction   =  ( ins )  =&gt;  {   if  ( ! Array .isArray ( ins )) {   // this must be a primitive argument, like {x: 0 y: 0}   return   ins ;  }   const  [ fName ,  ... args ]  =   ins ;   fns \[ fName \]( ... args );  };   data . instructions .forEach ( parseInstruction ); })</p><p>WebSocket.onMessage(Data=&gtï¼›{const fns={drawLineï¼šdrawLineï¼Œ...}ï¼›const parseInstruction=(Ins)=&gtï¼›{if(ï¼Array.isArray(Ins)){//è¿™å¿…é¡»æ˜¯åŸºå…ƒå‚æ•°ï¼Œå¦‚{xï¼š0 yï¼š0}return insï¼›}const[fNameï¼Œ...ã€‚Args]=INSï¼›fns\[fName\](...ã€‚Args)ï¼›}ï¼›æ•°æ®ã€‚æŒ‡ä»¤.forEach(ParseInstruction)ï¼›})ã€‚</p><p> Nice, We introduce a  parseInstruction function. We can apply  parseInstruction recursively to arguments, and support stuff like:</p><p>ä¸é”™ï¼Œæˆ‘ä»¬å¼•å…¥äº†parseInstructionå‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥é€’å½’åœ°å°†parseInstructionåº”ç”¨äºå‚æ•°ï¼Œå¹¶æ”¯æŒå¦‚ä¸‹å†…å®¹ï¼š</p><p> [ &#34;rotate&#34; , [ &#34;rotate&#34; , [ &#34;drawLine&#34; , { x:  0 , y:  0  }, { x:  1 , y:  1  }],  90 ]]]</p><p>[&#34ï¼›Rotate&#34ï¼›ï¼Œ[&#34ï¼›Rotate&#34ï¼›ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}]ï¼Œ90]]</p><p>    {  instructions: [[ &#34;drawLine&#34; , { x:  0 , y:  0  }, { x:  1 , y:  1  }]], }</p><p>{è¯´æ˜ï¼š[[&#34ï¼›DrawLine&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}]]ï¼Œ}ã€‚</p><p>    Instead of a top-level key, we could have a special instruction called  do, which runs all the instructions itâ€™s given.</p><p>æˆ‘ä»¬å¯ä»¥æœ‰ä¸€ä¸ªåä¸ºdoçš„ç‰¹æ®ŠæŒ‡ä»¤ï¼Œè€Œä¸æ˜¯é¡¶çº§é”®ï¼Œå®ƒè¿è¡Œå®ƒç»™å‡ºçš„æ‰€æœ‰æŒ‡ä»¤ã€‚</p><p>  websocket .onMessage ( data   =&gt;  {    const   fns   =  {   ...   do : ( ... args )  =&gt;   args [ args .length  -   1 ],  };   const   parseInstruction   =  ( ins )  =&gt;  {   if  ( ! Array .isArray ( ins )) {   // this must be a primitive argument, like {x: 0, y: 0}   return   ins ;  }   const  [ fName ,  ... args ]  =   ins ;   return   fns \[ fName \]( ... args .map ( parseInstruction ));  };   parseInstruction ( instruction ); })</p><p>WebSocket.onMessage(æ•°æ®=&gtï¼›{const fns={...ã€‚åšï¼š(â€¦â€¦ã€‚Args)=&gtï¼›args[args.length-1]ï¼Œ}ï¼›const parseInstruction=(INS)=&gtï¼›{if(ï¼Array.isArray(Ins)){//è¿™å¿…é¡»æ˜¯åŸºå…ƒå‚æ•°ï¼Œå¦‚{xï¼š0ï¼Œyï¼š0}return insï¼›}const[fNameï¼Œ...ã€‚Args]=insï¼›è¿”å›fns\[fName\](...ã€‚Args.map(ParseInstruction)ï¼›}ï¼›parseInstruction(æŒ‡ä»¤)ï¼›})ã€‚</p><p> Oh wow, that was easy. We just added  do in  fns. Now we can support an instruction like this:</p><p>å“¦ï¼Œå“‡ï¼Œé‚£å¤ªç®€å•äº†ã€‚æˆ‘ä»¬åˆšåˆšåœ¨FNSä¸­æ·»åŠ äº†DOã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥æ”¯æŒè¿™æ ·çš„æŒ‡ä»¤ï¼š</p><p> [   &#34;do&#34; ,  [ &#34;drawPoint&#34; , { x:  0 , y:  0  }],  [ &#34;rotate&#34; , [ &#34;drawLine&#34; , { x:  0 , y:  0  }, { x:  1 , y:  1  }],  90 ]], ];</p><p>[&#34ï¼›DO&#34ï¼›ï¼Œ[&#34ï¼›DrawPoint&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}]ï¼Œ[&#34ï¼›Rotate&#34ï¼›ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}]ï¼Œ90]]ï¼Œ]ï¼›</p><p>    If we could support definitions, our remote user could write some very expressive instructions! Letâ€™s convert our code to the kind of data structure weâ€™ve been playing with:</p><p>å¦‚æœæˆ‘ä»¬å¯ä»¥æ”¯æŒå®šä¹‰ï¼Œæˆ‘ä»¬çš„è¿œç¨‹ç”¨æˆ·å°±å¯ä»¥ç¼–å†™ä¸€äº›éå¸¸æœ‰è¡¨ç°åŠ›çš„æŒ‡ä»¤ï¼è®©æˆ‘ä»¬å°†ä»£ç è½¬æ¢ä¸ºæˆ‘ä»¬ä¸€ç›´ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼š</p><p> [ &#34;def&#34; ,  &#34;shape&#34; , [ &#34;drawLine&#34; , { x:  0 , y:  0  }, { x:  1 , y:  1  }]] [ &#34;rotate&#34; ,  &#34;shape&#34; ,  90 ]</p><p>[&#34ï¼›def&#34ï¼›ï¼Œ&#34ï¼›Shape&#34ï¼›ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}]][&#34ï¼›Rotate&#34ï¼›ï¼Œ&#34ï¼›Shape&#34ï¼›ï¼Œ90]ã€‚</p><p> Noot bad! If we can support an instruction like that, weâ€™d be golden! Hereâ€™s how:</p><p>æ²¡ä»€ä¹ˆä¸å¥½çš„ï¼å¦‚æœæˆ‘ä»¬èƒ½æ”¯æŒè¿™æ ·çš„æŒ‡ä»¤ï¼Œæˆ‘ä»¬å°±å¤§åŠŸå‘Šæˆäº†ï¼ä»¥ä¸‹æ˜¯æ–¹æ³•ï¼š</p><p> websocket .onMessage ( data   =&gt;  {    const   variables   =  {};   const   fns   =  {   ...   def : ( name ,  v )  =&gt;  {   defs [ name ]  =   v ;  },  };   const   parseInstruction   =  ( ins )  =&gt;  {   if  ( variables [ ins ]) {   // this must be some kind of variable, like &#34;shape&#34;   return   variables [ ins ];  }   if  ( ! Array .isArray ( ins )) {   // this must be a primitive argument, like {x: 0 y: 0}   return   ins ;  }   const  [ fName ,  ... args ]  =   ins ;   return   fns \[ fName \]( ... args .map ( parseInstruction ));  };   parseInstruction ( instruction ); })</p><p>WebSocket.onMessage(æ•°æ®=&gtï¼›{å¸¸é‡å˜é‡={}ï¼›å¸¸é‡fns={...ã€‚Defï¼š(nameï¼Œv)=&gtï¼›{defs[name]=vï¼›}ï¼Œ}ï¼›const parseInstruction=(Ins)=&gtï¼›{if(Variables[Ins]){//è¿™å¿…é¡»æ˜¯æŸç§å˜é‡ï¼Œå¦‚&#34ï¼›Shape&#34ï¼›Return Variables[Ins]ï¼›}If(ï¼Array.isArray(Ins)){//è¿™å¿…é¡»æ˜¯åŸºå…ƒå‚æ•°ï¼Œå¦‚{xï¼š0 yï¼š0}return insï¼›}const[fNameï¼Œ...ã€‚Args]=insï¼›è¿”å›fns\[fName\](...ã€‚Args.map(ParseInstruction)ï¼›}ï¼›parseInstruction(æŒ‡ä»¤)ï¼›})ã€‚</p><p> Here, we introduced a  variables object, which keeps track of every variable we define. A special  def function updates that  variables object. Now we can run this instruction:</p><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªVariableså¯¹è±¡ï¼Œå®ƒè·Ÿè¸ªæˆ‘ä»¬å®šä¹‰çš„æ¯ä¸ªå˜é‡ã€‚ä¸€ä¸ªç‰¹æ®Šçš„defå‡½æ•°ä¼šæ›´æ–°è¯¥Variableså¯¹è±¡ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š</p><p> [   &#34;do&#34; ,  [ &#34;def&#34; ,  &#34;shape&#34; , [ &#34;drawLine&#34; , { x:  0 , y:  0  }, { x:  1 , y:  1  }]],  [ &#34;rotate&#34; ,  &#34;shape&#34; ,  90 ], ];</p><p>[&#34ï¼›do&#34ï¼›ï¼Œ[&#34ï¼›def&#34ï¼›ï¼Œ&#34ï¼›Shape&#34ï¼›ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š1ï¼Œyï¼š1}]]ï¼Œ[&#34ï¼›æ—‹è½¬&#34ï¼›ï¼Œ&#34ï¼›Shape&#34ï¼›ï¼Œ90]ï¼Œ]ï¼›</p><p>   Letâ€™s step it up a notch. What if we let our remote user  define their own functions?</p><p>è®©æˆ‘ä»¬æ›´ä¸Šä¸€å±‚æ¥¼å§ã€‚å¦‚æœæˆ‘ä»¬è®©æˆ‘ä»¬çš„è¿œç¨‹ç”¨æˆ·å®šä¹‰ä»–ä»¬è‡ªå·±çš„åŠŸèƒ½ä¼šæ€ä¹ˆæ ·ï¼Ÿ</p><p>  const   drawTriangle   =   function ( left ,  top ,  right ,  color ) {    drawLine ( left ,  top ,  color );   drawLine ( top ,  right ,  color );    drawLine ( left ,  right ,  color );  }  drawTriangle ( ... )</p><p>Const draTriangle=function(Leftï¼Œtopï¼Œrightï¼Œcolor){drawLine(Leftï¼Œtopï¼Œcolor)ï¼›draLine(topï¼Œrightï¼Œcolor)ï¼›DrawLine(Leftï¼ŒRightï¼Œcolor)ï¼›}DrawTriangle(...)ã€‚</p><p> How would we do it? Letâ€™s follow our intuition again. If we transcribe this to our data representation, hereâ€™s how it could look:</p><p>æˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè®©æˆ‘ä»¬å†è·Ÿç€æˆ‘ä»¬çš„ç›´è§‰èµ°ä¸€éã€‚å¦‚æœæˆ‘ä»¬å°†å…¶è½¬å½•ä¸ºæˆ‘ä»¬çš„æ•°æ®è¡¨ç¤ºå½¢å¼ï¼Œåˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p> [ &#34;def&#34; ,  &#34;drawTriangle&#34; ,  [ &#34;fn&#34; , [ &#34;left&#34; ,  &#34;top&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  [ &#34;do&#34; ,  [ &#34;drawLine&#34; ,  &#34;left&#34; ,  &#34;top&#34; ,  &#34;color&#34; ],  [ &#34;drawLine&#34; ,  &#34;top&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  [ &#34;drawLine&#34; ,  &#34;left&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  ],  ], ], [ &#34;drawTriangle&#34; , { x:  0 , y:  0  }, { x:  3 , y:  3  }, { x:  6 , y:  0  },  &#34;blue&#34; ],</p><p>[&#34ï¼›def&#34ï¼›ï¼Œ&#34ï¼›Dragä¸‰è§’å½¢&#34ï¼›ï¼Œ[&#34ï¼›FN&#34ï¼›ï¼Œ[&#34ï¼›Left&#34ï¼›ï¼Œ&#34ï¼›ï¼Œ&#34ï¼›Right&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›Do&#34ï¼›ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ&#34ï¼›Left&#34ï¼›ï¼Œ&#34ï¼›top&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›drawLine&#34ï¼›ï¼Œ&#34ï¼›top&#34ï¼›ï¼Œ&#34ï¼›right&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›drawLine&#34ï¼›ï¼Œ&#34ï¼›Left&#34ï¼›ï¼Œ&#34ï¼›right&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›draTriangle&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š3ï¼Œyï¼š3}ï¼Œ{xï¼š6ï¼Œyï¼š0}ï¼Œ&#34ï¼›è“è‰²&#34ï¼›]ï¼Œ</p><p>         All we need to do is to parse this instruction somehow, and bam, we are good to go!</p><p>æˆ‘ä»¬æ‰€éœ€è¦åšçš„å°±æ˜¯ä»¥æŸç§æ–¹å¼è§£æè¿™æ¡æŒ‡ä»¤ï¼Œç„¶åç °çš„ä¸€å£°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹äº†ï¼</p><p>  The key to making this work is our  [&#34;fn&#34;, â€¦] instruction. What if we did this:</p><p>å®Œæˆè¿™é¡¹å·¥ä½œçš„å…³é”®æ˜¯æˆ‘ä»¬çš„[#34ï¼›fn&#34ï¼›ï¼Œâ€¦]ã€‚æŒ‡ä»¤ã€‚å¦‚æœæˆ‘ä»¬è¿™æ ·åšä¼šæ€ä¹ˆæ ·ï¼š</p><p> const   parseFnInstruction   =  ( args ,  body ,  oldVariables )  =&gt;  {   return  ( ... values )  =&gt;  {   const   newVariables   =  {   ... oldVariables ,   ... mapArgsWithValues ( args ,  values ),  };   return   parseInstruction ( body ,  newVariables );  }; };</p><p>Const parseFnInstruction=(argsï¼Œbodyï¼ŒoldVariables)=&gtï¼›{return(...ã€‚å€¼)=&gtï¼›{const newVariables={...ã€‚æ—§çš„å˜é‡ï¼Œ..ã€‚MapArgsWithValues(argsï¼Œvalue)ï¼Œ}ï¼›return parseInstructions(Bodyï¼ŒnewVariables)ï¼›}ï¼›}ï¼›</p><p> When we find a  fn instruction, we run  parseFnInstruction. This produces a new javascript function. We would replace  drawTriangle here with that function:</p><p>å½“æˆ‘ä»¬æ‰¾åˆ°FnæŒ‡ä»¤æ—¶ï¼Œæˆ‘ä»¬è¿è¡ŒparseFnInstructionã€‚è¿™å°†äº§ç”Ÿä¸€ä¸ªæ–°çš„javascriptå‡½æ•°ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è¯¥å‡½æ•°æ›¿æ¢æ­¤å¤„çš„DrawTriangleï¼š</p><p> [ &#34;drawTriangle&#34; , { x:  0 , y:  0  }, { x:  3 , y:  3  }, { x:  6 , y:  0  },  &#34;blue&#34; ]</p><p>[&#34ï¼›draTriangle&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š3ï¼Œyï¼š3}ï¼Œ{xï¼š6ï¼Œyï¼š0}ï¼Œ&#34ï¼›è“è‰²&#34ï¼›]ã€‚</p><p>  [{ x:  0 , y:  0  }, { x:  3 , y:  3  }, { x:  6 , y:  0  },  &#34;blue&#34; ]</p><p>[{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š3ï¼Œyï¼š3}ï¼Œ{xï¼š6ï¼Œyï¼š0}ï¼Œ&#34ï¼›è“è‰²&#34ï¼›]ã€‚</p><p>   Would create a new  variables object, that includes a mapping of the function arguments to these newly provided values:</p><p>å°†åˆ›å»ºä¸€ä¸ªæ–°çš„Variableså¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…æ‹¬å‡½æ•°å‚æ•°åˆ°è¿™äº›æ–°æä¾›çš„å€¼çš„æ˜ å°„ï¼š</p><p> const   newVariables   =  {   ... oldVariables ,  left: { x:  0 , y:  0  },   top: { x:  3 , y:  3  },  right: {x:  6 , y:  0  },   color:  &#34;blue&#34; ,  }</p><p>Const newVariables={...ã€‚æ—§å˜é‡ï¼Œå·¦ä¾§ï¼š{xï¼š0ï¼Œyï¼š0}ï¼Œé¡¶éƒ¨ï¼š{xï¼š3ï¼Œyï¼š3}ï¼Œå³ä¾§ï¼š{xï¼š6ï¼Œyï¼š0}ï¼Œé¢œè‰²ï¼š&#34ï¼›è“è‰²&#34ï¼›ï¼Œ}ã€‚</p><p>  [   &#34;do&#34; ,  [ &#34;drawLine&#34; ,  &#34;left&#34; ,  &#34;top&#34; ,  &#34;color&#34; ],  [ &#34;drawLine&#34; ,  &#34;top&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  [ &#34;drawLine&#34; ,  &#34;left&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  ],</p><p>[&#34ï¼›Do&#34ï¼›ï¼Œ[&#34ï¼›drawLine&#34ï¼›ï¼Œ&#34ï¼›Left&#34ï¼›ï¼Œ&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ&#34ï¼›top&#34ï¼›ï¼Œ&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›DrawLine&#34ï¼›]ï¼›ï¼Œ&#34ï¼›å·¦&#34ï¼›ï¼Œ&#34ï¼›å³&#34ï¼›ï¼Œ&#34ï¼›é¢œè‰²&#34ï¼›]ï¼Œ]ï¼Œ</p><p> And run it through  parseInstruction, with our  newVariables. With that  &#34;left&#34; would be looked up as a variable and map to  {x: 0, y: 0}.</p><p>å¹¶ä½¿ç”¨æˆ‘ä»¬çš„æ–°å˜é‡é€šè¿‡parseInstructionsè¿è¡Œå®ƒã€‚è¿™æ ·ï¼Œä¼šå°†&#34ï¼›LEFT&#34ï¼›ä½œä¸ºå˜é‡è¿›è¡ŒæŸ¥æ‰¾å¹¶æ˜ å°„åˆ°{xï¼š0ï¼Œyï¼š0}ã€‚</p><p>   Letâ€™s follow through on our plan. The first thing we need to do, is to have  parseInstruction accept  variables as an argument:</p><p>è®©æˆ‘ä»¬ç»§ç»­æ‰§è¡Œæˆ‘ä»¬çš„è®¡åˆ’å§ã€‚æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯è®©parseInstructionsæ¥å—å˜é‡ä½œä¸ºå‚æ•°ï¼š</p><p> const   parseInstruction   =  ( ins ,  variables )  =&gt;  {   ...   return   fn ( ... args .map (( arg )  =&gt;   parseInstruction ( arg ,  variables )));  };   parseInstruction ( instruction ,  variables );</p><p>Const parseInstruction=(insï¼Œå˜é‡)=&gtï¼›{...ã€‚è¿”å›fn(...ã€‚Args.map((Arg)=&gtï¼›parseInstruction(argï¼Œå˜é‡)ï¼›}ï¼›parseInstruction(æŒ‡ä»¤ï¼Œå˜é‡)ï¼›</p><p> Next, weâ€™ll want to add a special check to detect if we have a â€œfnâ€ instruction:</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªç‰¹æ®Šæ£€æŸ¥ï¼Œä»¥æ£€æµ‹æ˜¯å¦æœ‰â€œfnâ€æŒ‡ä»¤ï¼š</p><p> const   parseInstruction   =  ( ins ,  variables )  =&gt;  {   ...   const  [ fName ,  ... args ]  =   ins ;   if  ( fName   ==   &#34;fn&#34; ) {   return   parseFnInstruction ( ... args ,  variables );  }   ...   return   fn ( ... args .map (( arg )  =&gt;   parseInstruction ( arg ,  variables )));  };   parseInstruction ( instruction ,  variables );</p><p>Const parseInstruction=(insï¼Œå˜é‡)=&gtï¼›{...ã€‚Const[fNameï¼Œ...ã€‚Args]=insï¼›if(fName==&#34ï¼›fn&#34ï¼›){return parseFnInstruction...ã€‚å‚æ•°ï¼Œå˜é‡)ï¼›}...ã€‚è¿”å›fn(...ã€‚Args.map((Arg)=&gtï¼›parseInstruction(argï¼Œå˜é‡)ï¼›}ï¼›parseInstruction(æŒ‡ä»¤ï¼Œå˜é‡)ï¼›</p><p>  const   mapArgsWithValues   =  ( args ,  values )  =&gt;  {    return   args .reduce (( res ,  k ,  idx )  =&gt;  {   res [ k ]  =   values [ idx ];   return   res ;  }, {}); } const   parseFnInstruction   =  ( args ,  body ,  oldVariables )  =&gt;  {   return  ( ... values )  =&gt;  {   const   newVariables   =  { ... oldVariables ,  ... mapArgsWithValues ( args ,  values )}   return   parseInstruction ( body ,  newVariables );  }; };</p><p>Const mapArgsWithValues=(argsï¼ŒValues)=&gtï¼›{return args.duce((resï¼Œkï¼Œidx)=&gtï¼›{res[k]=values[idx]ï¼›return resï¼›}ï¼Œ{})ï¼›}const parseFnInstructions=(argsï¼Œbodyï¼ŒoldVariables)=&gtï¼›{return(...ã€‚å€¼)=&gtï¼›{const newVariables={...ã€‚æ—§çš„å˜é‡ï¼Œ..ã€‚MapArgsWithValues(argsï¼Œvalue)}return parseInstructions(Bodyï¼ŒnewVariables)ï¼›}ï¼›}ï¼›</p><p> It works exactly like we said. We return a new function. When itâ€™s run, it:</p><p>å®ƒå®Œå…¨æŒ‰ç…§æˆ‘ä»¬è¯´çš„é‚£æ ·å·¥ä½œã€‚æˆ‘ä»¬è¿”å›ä¸€ä¸ªæ–°å‡½æ•°ã€‚å½“å®ƒè¿è¡Œæ—¶ï¼Œå®ƒï¼š</p><p>   const   parseInstruction   =  ( ins ,  variables )  =&gt;  {   ...   const  [ fName ,  ... args ]  =   ins ;   if  ( fName   ==   &#34;fn&#34; ) {   return   makeFn ( ... args ,  variables );  }   const   fn   =   fns [ fName ]  ||   variables [ fName ];   return   fn ( ... args .map (( arg )  =&gt;   parseInstruction ( arg ,  variables )));</p><p>Const parseInstruction=(insï¼Œå˜é‡)=&gtï¼›{...ã€‚Const[fNameï¼Œ...ã€‚Args]=insï¼›if(fName==&#34ï¼›fn&#34ï¼›){return makeFn(...ã€‚Argsï¼ŒVariables)ï¼›}const fn=fns[fName]||å˜é‡[fName]ï¼›è¿”å›fn(...ã€‚Args.map((Arg)=&gtï¼›parseInstruction(argï¼ŒVariables)ï¼›</p><p>   Here, since  fn can now come from both  fns and  variables, we check both. Put it all together, and it works!</p><p>è¿™é‡Œï¼Œç”±äºfnç°åœ¨æ—¢å¯ä»¥æ¥è‡ªfnï¼Œä¹Ÿå¯ä»¥æ¥è‡ªå˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ—¶æ£€æŸ¥ä¸¤è€…ã€‚æŠŠæ‰€æœ‰è¿™äº›æ”¾åœ¨ä¸€èµ·ï¼Œå®ƒå°±ä¼šèµ·ä½œç”¨ï¼</p><p> websocket .onMessage ( data   =&gt;  {    const   variables   =  {};   const   fns   =  {  drawLine:  drawLine ,  drawPoint:  drawPoint ,  rotate:  rotate ,   do : ( ... args )  =&gt;   args [ args .length  -   1 ],   def : ( name ,  v )  =&gt;  {   variables [ name ]  =   v ;  },  };   const   mapArgsWithValues   =  ( args ,  values )  =&gt;  {   return   args .reduce (( res ,  k ,  idx )  =&gt;  {   res [ k ]  =   values [ idx ];   return   res ;  }, {});  };   const   parseFnInstruction   =  ( args ,  body ,  oldVariables )  =&gt;  {   return  ( ... values )  =&gt;  {   const   newVariables   =  {   ... oldVariables ,   ... mapArgsWithValues ( args ,  values ),  };   return   parseInstruction ( body ,  newVariables );  };  };   const   parseInstruction   =  ( ins ,  variables )  =&gt;  {   if  ( variables [ ins ]) {   // this must be some kind of variable   return   variables [ ins ];  }   if  ( ! Array .isArray ( ins )) {   // this must be a primitive argument, like {x: 0 y: 0}   return   ins ;  }   const  [ fName ,  ... args ]  =   ins ;   if  ( fName   ==   &#34;fn&#34; ) {   return   parseFnInstruction ( ... args ,  variables );  }   const   fn   =   fns [ fName ]  ||   variables [ fName ];   return   fn ( ... args .map (( arg )  =&gt;   parseInstruction ( arg ,  variables )));  };   parseInstruction ( instruction ,  variables ); })</p><p>WebSocket.onMessage(Data=&gtï¼›{const Variables={}ï¼›const fns={drawLineï¼šDrawLineï¼ŒDrawPointï¼šDrawPointï¼ŒRotateï¼šRotateï¼ŒDoï¼š(...ã€‚Args)=&gtï¼›args[args.length-1]ï¼Œdefï¼š(nameï¼Œv)=&gtï¼›{å˜é‡[name]=vï¼›}ï¼Œ}ï¼›const mapArgsWithValues=(argsï¼Œvalue)=&gtï¼›{return args.duce((resï¼Œkï¼Œidx)=&gtï¼›{res[k]=values[idx]ï¼›return resï¼›}ï¼Œ{})ï¼›}ï¼›Const parseFnInstruction=(argsï¼Œbodyï¼ŒoldVariables)=&gtï¼›{return(...ã€‚å€¼)=&gtï¼›{const newVariables={...ã€‚æ—§çš„å˜é‡ï¼Œ..ã€‚MapArgsWithValues(argsï¼ŒValues)ï¼Œ}ï¼›return parseInstructions(bodyï¼ŒnewVariables)ï¼›}ï¼›}ï¼›const parseInstruction=(insï¼ŒVariables)=&gtï¼›{if(Variables[Ins]){//è¿™å¿…é¡»æ˜¯æŸç§å˜é‡è¿”å›å˜é‡[Ins]ï¼›}if(ï¼Array.isArray(Ins)){//è¿™å¿…é¡»æ˜¯åŸºå…ƒå‚æ•°ï¼Œå¦‚{xï¼š0 yï¼š0}return insï¼›}const[fNameï¼Œ...ã€‚Args]=insï¼›if(fName==&#34ï¼›fn&#34ï¼›){return parseFnInstruction...ã€‚Argsï¼ŒVariables)ï¼›}const fn=fns[fName]||å˜é‡[fName]ï¼›è¿”å›fn(...ã€‚Args.map((Arg)=&gtï¼›parseInstruction(argï¼Œå˜é‡)ï¼›}ï¼›parseInstruction(æŒ‡ä»¤ï¼Œå˜é‡)ï¼›})ã€‚</p><p>  [   &#34;do&#34; ,  [   &#34;def&#34; ,   &#34;drawTriangle&#34; ,  [   &#34;fn&#34; ,  [ &#34;left&#34; ,  &#34;top&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  [   &#34;do&#34; ,  [ &#34;drawLine&#34; ,  &#34;left&#34; ,  &#34;top&#34; ,  &#34;color&#34; ],  [ &#34;drawLine&#34; ,  &#34;top&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  [ &#34;drawLine&#34; ,  &#34;left&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  ],  ],  ],  [ &#34;drawTriangle&#34; , { x:  0 , y:  0  }, { x:  3 , y:  3  }, { x:  6 , y:  0  },  &#34;blue&#34; ],  [ &#34;drawTriangle&#34; , { x:  6 , y:  6  }, { x:  10 , y:  10  }, { x:  6 , y:  16  },  &#34;purple&#34; ], ])</p><p>[&#34ï¼›Do&#34ï¼›ï¼Œ[&#34ï¼›def&#34ï¼›ï¼Œ&#34ï¼›draTriangle&#34ï¼›ï¼Œ[&#34ï¼›FN&#34ï¼›ï¼Œ[&#34ï¼›Left&#34ï¼›ï¼Œ&#34ï¼›top&#34ï¼›ï¼Œ&#34ï¼›Right&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›Do&#34ï¼›ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ&#34ï¼›å·¦ä¾§&#34ï¼›ï¼Œ&#34ï¼›é¡¶éƒ¨&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ&#34ï¼›é¡¶éƒ¨&#34ï¼›ï¼Œ&#34ï¼›å³ä¾§&#34ï¼›ï¼Œ&#34ï¼›é¢œè‰²&#34ï¼›]ï¼Œ[&#34ï¼›drawLine&#34ï¼›ï¼Œ&#34ï¼›å·¦ä¾§&#34ï¼›ï¼Œ&#34ï¼›å³ä¾§&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›drawTriangle&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š3ï¼Œyï¼š3}ï¼Œ{xï¼š6ï¼Œyï¼š0}ï¼Œ&#34ï¼›è“è‰²&#34ï¼›]ï¼Œ[&#34ï¼›drawTriangle&#34ï¼›ï¼Œ{xï¼š6ï¼Œyï¼š6}ï¼Œ{xï¼š10ï¼Œyï¼š10}ï¼Œ{xï¼š6ï¼Œyï¼š16}ï¼Œ&#34ï¼›ç´«è‰²&#34ï¼›]ï¼Œ])ã€‚</p><p> We can compose functions, we can define variables, and we can even create our own functions. If we think about it, we just created a programming language!  1.</p><p>æˆ‘ä»¬å¯ä»¥ç¼–å†™å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å˜é‡ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„å‡½æ•°ã€‚å¦‚æœæˆ‘ä»¬ä»”ç»†æƒ³æƒ³ï¼Œæˆ‘ä»¬åˆšåˆšåˆ›å»ºäº†ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼</p><p>     We may even notice something interesting. Our new array languages has advantages to JavaScript itself!</p><p>æˆ‘ä»¬ç”šè‡³å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸€äº›æœ‰è¶£çš„äº‹æƒ…ã€‚æˆ‘ä»¬æ–°çš„æ•°ç»„è¯­è¨€æ¯”JavaScriptæœ¬èº«æ›´æœ‰ä¼˜åŠ¿ï¼</p><p>  In JavaScript, you define variables by writing  const x = foo. Say you wanted to â€œrewriteâ€  const to be just  c. You couldnâ€™t do this, because  const x = foo is special syntax in JavaScript. Youâ€™re not allowed to change that around.</p><p>åœ¨JavaScriptä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡ç¼–å†™const x=fooæ¥å®šä¹‰å˜é‡ã€‚å‡è®¾æ‚¨å¸Œæœ›å°†constâ€œé‡å†™â€ä¸ºcã€‚æ‚¨ä¸èƒ½è¿™æ ·åšï¼Œå› ä¸ºconst x=fooæ˜¯JavaScriptä¸­çš„ç‰¹æ®Šè¯­æ³•ã€‚ä½ ä¸èƒ½æ”¹å˜è¿™ä¸€ç‚¹ã€‚</p><p> In our array language though, thereâ€™s no syntax at all! Everything is just arrays. We could easily write some special  c instruction that works just like  def.</p><p>ä½†æ˜¯ï¼Œåœ¨æˆ‘ä»¬çš„æ•°ç»„è¯­è¨€ä¸­ï¼Œæ ¹æœ¬æ²¡æœ‰è¯­æ³•ï¼æ‰€æœ‰ä¸œè¥¿éƒ½åªæ˜¯æ•°ç»„ã€‚æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°ç¼–å†™ä¸€äº›ç‰¹æ®Šçš„cæŒ‡ä»¤ï¼Œå…¶å·¥ä½œæ–¹å¼ä¸defç±»ä¼¼ã€‚</p><p> If we think about it, itâ€™s as though in Javascript we are guests, and we need to follow the language designerâ€™s rules. But in our array language, we are â€œco-ownersâ€. There is no big difference between the â€œbuilt-inâ€ stuff (â€œdefâ€, â€œfnâ€) the language designer wrote, and the stuff we write! (â€œdrawTriangleâ€).</p><p>å¦‚æœæˆ‘ä»¬ä»”ç»†æƒ³æƒ³ï¼Œå°±å¥½åƒåœ¨Javascriptä¸­æˆ‘ä»¬æ˜¯å®¢äººï¼Œæˆ‘ä»¬éœ€è¦éµå¾ªè¯­è¨€è®¾è®¡è€…çš„è§„åˆ™ã€‚ä½†åœ¨æˆ‘ä»¬çš„æ•°ç»„è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬æ˜¯â€œå…±åŒæ‰€æœ‰è€…â€ã€‚è¯­è¨€è®¾è®¡è€…ç¼–å†™çš„â€œå†…ç½®â€å†…å®¹(â€œdefâ€ã€â€œfnâ€)å’Œæˆ‘ä»¬ç¼–å†™çš„å†…å®¹æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼(â€œDrawing Triangleâ€)ã€‚</p><p>  Thereâ€™s another, much more resounding win. If our code is just a bunch of arrays, we can  do stuff to the code. We could write code that generates code!</p><p>è¿˜æœ‰å¦ä¸€ä¸ªæ›´å“äº®çš„èƒœåˆ©ã€‚å¦‚æœæˆ‘ä»¬çš„ä»£ç åªæ˜¯ä¸€å †æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ä»£ç åšä¸€äº›æ“ä½œã€‚æˆ‘ä»¬å¯ä»¥ç¼–å†™ç”Ÿæˆä»£ç çš„ä»£ç ï¼</p><p>      This would be difficult to do. Weâ€™d need something like Babel to parse our file, and work on top of the AST to make sure we rewrite our code safely to</p><p>è¿™æ˜¯å¾ˆéš¾åšåˆ°çš„ã€‚æˆ‘ä»¬éœ€è¦åƒbabelè¿™æ ·çš„ä¸œè¥¿æ¥è§£ææˆ‘ä»¬çš„æ–‡ä»¶ï¼Œå¹¶åœ¨ASTä¹‹ä¸Šå·¥ä½œï¼Œä»¥ç¡®ä¿æˆ‘ä»¬å®‰å…¨åœ°é‡å†™ä»£ç ã€‚</p><p>  But in our array language, our code is just arrays! Itâ€™s easy to rewrite  unless:</p><p>ä½†æ˜¯åœ¨æˆ‘ä»¬çš„æ•°ç»„è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬çš„ä»£ç åªæ˜¯æ•°ç»„ï¼å®ƒå¾ˆå®¹æ˜“é‡å†™ï¼Œé™¤éï¼š</p><p>     Having your code represented as data doesnâ€™t just allow you to manipulate your code with ease. It also allows your editor to do it too. For example, say you are editing this code:</p><p>å°†ä»£ç è¡¨ç¤ºä¸ºæ•°æ®ä¸ä»…ä»…å…è®¸æ‚¨è½»æ¾åœ°æ“ä½œä»£ç ã€‚å®ƒè¿˜å…è®¸æ‚¨çš„ç¼–è¾‘å™¨ä¹Ÿè¿™æ ·åšã€‚ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨æ­£åœ¨ç¼–è¾‘æ­¤ä»£ç ï¼š</p><p>         If youâ€™re editor understood these arrays, you can tell it: â€œexpandâ€ this area to the right:</p><p>å¦‚æœæ‚¨æ˜¯äº†è§£è¿™äº›æ•°ç»„çš„ç¼–è¾‘ï¼Œæ‚¨å¯ä»¥å‘Šè¯‰å®ƒï¼šå‘å³â€œå±•å¼€â€æ­¤åŒºåŸŸï¼š</p><p>       All of a sudden, instead of editing characters, you are editing the  structure of your code. This is called structural editing  2. It can help you move with the speed of a sculptor, and is one of the many wins youâ€™ll get when your code is data.</p><p>çªç„¶ä¹‹é—´ï¼Œæ‚¨ç¼–è¾‘çš„ä¸æ˜¯å­—ç¬¦ï¼Œè€Œæ˜¯ä»£ç çš„ç»“æ„ã€‚è¿™å°±æ˜¯æ‰€è°“çš„ç»“æ„åŒ–ç¼–è¾‘2ã€‚å®ƒå¯ä»¥å¸®åŠ©ä½ ä»¥é›•åˆ»å®¶çš„é€Ÿåº¦ç§»åŠ¨ï¼Œè¿™ä¹Ÿæ˜¯å½“ä½ çš„ä»£ç æ˜¯æ•°æ®æ—¶ä½ å°†è·å¾—çš„ä¼—å¤šèƒœåˆ©ä¹‹ä¸€ã€‚</p><p>  Well, this array language you happened to have discoveredâ€¦is a poorly implemented dialect of Lisp!</p><p>å—¯ï¼Œæ‚¨ç¢°å·§å‘ç°çš„è¿™ç§æ•°ç»„è¯­è¨€æ˜¯â€¦ã€‚æ˜¯Lispçš„ä¸€ç§å®ç°ä¸ä½³çš„æ–¹è¨€ï¼</p><p>  [   &#34;do&#34; ,  [   &#34;def&#34; ,   &#34;drawTriangle&#34; ,  [   &#34;fn&#34; ,  [ &#34;left&#34; ,  &#34;top&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  [   &#34;do&#34; ,  [ &#34;drawLine&#34; ,  &#34;left&#34; ,  &#34;top&#34; ,  &#34;color&#34; ],  [ &#34;drawLine&#34; ,  &#34;top&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  [ &#34;drawLine&#34; ,  &#34;left&#34; ,  &#34;right&#34; ,  &#34;color&#34; ],  ],  ],  ],  [ &#34;drawTriangle&#34; , { x:  0 , y:  0  }, { x:  3 , y:  3  }, { x:  6 , y:  0  },  &#34;blue&#34; ],  [ &#34;drawTriangle&#34; , { x:  6 , y:  6  }, { x:  10 , y:  10  }, { x:  6 , y:  16  },  &#34;purple&#34; ], ])</p><p>[&#34ï¼›Do&#34ï¼›ï¼Œ[&#34ï¼›def&#34ï¼›ï¼Œ&#34ï¼›draTriangle&#34ï¼›ï¼Œ[&#34ï¼›FN&#34ï¼›ï¼Œ[&#34ï¼›Left&#34ï¼›ï¼Œ&#34ï¼›top&#34ï¼›ï¼Œ&#34ï¼›Right&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›Do&#34ï¼›ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ&#34ï¼›å·¦ä¾§&#34ï¼›ï¼Œ&#34ï¼›é¡¶éƒ¨&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›DrawLine&#34ï¼›ï¼Œ&#34ï¼›é¡¶éƒ¨&#34ï¼›ï¼Œ&#34ï¼›å³ä¾§&#34ï¼›ï¼Œ&#34ï¼›é¢œè‰²&#34ï¼›]ï¼Œ[&#34ï¼›drawLine&#34ï¼›ï¼Œ&#34ï¼›å·¦ä¾§&#34ï¼›ï¼Œ&#34ï¼›å³ä¾§&#34ï¼›ï¼Œ&#34ï¼›color&#34ï¼›]ï¼Œ[&#34ï¼›drawTriangle&#34ï¼›ï¼Œ{xï¼š0ï¼Œyï¼š0}ï¼Œ{xï¼š3ï¼Œyï¼š3}ï¼Œ{xï¼š6ï¼Œyï¼š0}ï¼Œ&#34ï¼›è“è‰²&#34ï¼›]ï¼Œ[&#34ï¼›drawTriangle&#34ï¼›ï¼Œ{xï¼š6ï¼Œyï¼š6}ï¼Œ{xï¼š10ï¼Œyï¼š10}ï¼Œ{xï¼š6ï¼Œyï¼š16}ï¼Œ&#34ï¼›ç´«è‰²&#34ï¼›]ï¼Œ])</p><p>  ( do    ( def  draw-triangle ( fn  [left top right color]  ( draw-line  left top color)  ( draw-line  top right color)  ( draw-line  left right color)))  ( draw-triangle  { :x   0   :y   0 } { :x   3   :y   3 } { :x   6   :y   0 }  &#34;blue&#34; )  ( draw-triangle  { :x   6   :y   6 } { :x   10   :y   10 } { :x   6   :y   16 }  &#34;purple&#34; ))</p><p>(DO(å®šä¹‰ç»˜åˆ¶ä¸‰è§’å½¢(FN[å·¦ä¸Šå³ä¸Šé¢œè‰²](ç”»çº¿å·¦ä¸Šé¢œè‰²)(ç”»çº¿å³ä¸Šé¢œè‰²)(ç»˜åˆ¶ä¸‰è§’å½¢{ï¼šx0ï¼šy0}{ï¼šx3ï¼šy3}{ï¼šx6ï¼šy0}&#34ï¼›è“è‰²&#34ï¼›)(ç»˜åˆ¶ä¸‰è§’å½¢{ï¼šx6ï¼šy6}{ï¼šx10ï¼šy10}{ï¼šx6ï¼šy16}&#34ï¼›ç´«è‰²&#34ï¼›)ã€‚</p><p>        Now, if we agree that the ability to manipulate source code is important to us, what kind of languages are most conducive for supporting it?</p><p>ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬åŒæ„æ“çºµæºä»£ç çš„èƒ½åŠ›å¯¹æˆ‘ä»¬æ¥è¯´å¾ˆé‡è¦ï¼Œé‚£ä¹ˆä»€ä¹ˆæ ·çš„è¯­è¨€æœ€æœ‰åˆ©äºæ”¯æŒå®ƒå‘¢ï¼Ÿ</p><p> One way we can solve that question is to rephrase it: how could we make manipulating code as intuitive as manipulating  data within  our code? The answer sprouts out: Make the code data! What an exciting conclusion. If we care about manipulating source code, we glide into the answer: the code  must be data  3.</p><p>æˆ‘ä»¬å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯é‡æ–°è¡¨è¿°ï¼šæˆ‘ä»¬å¦‚ä½•æ‰èƒ½ä½¿æ“ä½œä»£ç ä¸æ“ä½œä»£ç ä¸­çš„æ•°æ®ä¸€æ ·ç›´è§‚ï¼Ÿç­”æ¡ˆå†’å‡ºæ¥äº†ï¼šåˆ¶ä½œä»£ç æ•°æ®ï¼è¿™æ˜¯ä¸€ä¸ªå¤šä¹ˆæ¿€åŠ¨äººå¿ƒçš„ç»“è®ºã€‚å¦‚æœæˆ‘ä»¬å…³å¿ƒæ“çºµæºä»£ç ï¼Œæˆ‘ä»¬å°±ä¼šå¾—åˆ°ç­”æ¡ˆï¼šä»£ç å¿…é¡»æ˜¯æ•°æ®3ã€‚</p><p> If the code must be data, what kind of data representation could we use? XML could work, JSON could work, and the list goes on. But, what would happen if we tried to find the simplest data structure? If we keep simplifying, we glide into to the simplest nested structure of allâ€¦lists!</p><p>å¦‚æœä»£ç å¿…é¡»æ˜¯æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»€ä¹ˆæ ·çš„æ•°æ®è¡¨ç¤ºå‘¢ï¼ŸXMLå¯ä»¥å·¥ä½œï¼ŒJSONå¯ä»¥å·¥ä½œï¼Œä¸èƒœæšä¸¾ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¯•å›¾æ‰¾åˆ°æœ€ç®€å•çš„æ•°æ®ç»“æ„ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬ç»§ç»­ç®€åŒ–ï¼Œæˆ‘ä»¬å°±ä¼šæ»‘å‘æ‰€æœ‰â€¦ä¸­æœ€ç®€å•çš„åµŒå¥—ç»“æ„ã€‚æ¸…å•ï¼</p><p>  Itâ€™s illuminating, in the sense that it seems like Lisp is â€œdiscoveredâ€. Itâ€™s like the solution to an optimization problem: if you care about manipulating code, you gravitate towards discovering Lisp. Thereâ€™s something awe-inspiring about using a tool thatâ€™s discovered: who knows, alien life-forms could use Lisp!</p><p>å®ƒå¾ˆæœ‰å¯å‘æ€§ï¼Œä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼ŒLispä¼¼ä¹æ˜¯è¢«â€œå‘ç°â€çš„ã€‚è¿™å°±åƒæ˜¯ä¼˜åŒ–é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼šå¦‚æœæ‚¨å…³å¿ƒä»£ç æ“ä½œï¼Œé‚£ä¹ˆæ‚¨ä¼šå€¾å‘äºä½¿ç”¨Lispã€‚ä½¿ç”¨å·²å‘ç°çš„å·¥å…·æœ‰ä¸€äº›ä»¤äººæ•¬ç•çš„ä¸œè¥¿ï¼šè°çŸ¥é“ï¼Œå¤–æ˜Ÿç”Ÿå‘½å½¢å¼å¯èƒ½ä¼šä½¿ç”¨Lispï¼</p><p> Itâ€™s exciting, in that, there  may be a better syntax. We donâ€™t know. Ruby and Python in my opinion where experiments, trying to bring lisp-like power without the brackets. I donâ€™t think the question is a solved one yet. Maybe you can think about it ğŸ™‚</p><p>è¿™å¾ˆä»¤äººå…´å¥‹ï¼Œå› ä¸ºå¯èƒ½æœ‰æ›´å¥½çš„è¯­æ³•ã€‚æˆ‘ä»¬ä¸çŸ¥é“ã€‚åœ¨æˆ‘çœ‹æ¥ï¼ŒRubyå’ŒPythonåœ¨å“ªé‡Œåšå®éªŒï¼Œè¯•å›¾å¸¦æ¥LISPå¼çš„åŠŸèƒ½ï¼Œæ²¡æœ‰æ‹¬å·ã€‚æˆ‘è®¤ä¸ºè¿™ä¸ªé—®é¢˜è¿˜æ²¡æœ‰è§£å†³ã€‚ä¹Ÿè®¸ä½ å¯ä»¥è€ƒè™‘ä¸€ä¸‹ï¼ŒğŸ™‚ã€‚</p><p>  You can imagine how expressive you can be if you can rewrite the code your language is written in. Youâ€™d truly be on the same footing as the language designer, and the abstractions you could write at that level, can add up to save you years of work.</p><p>æ‚¨å¯ä»¥æƒ³è±¡ï¼Œå¦‚æœæ‚¨å¯ä»¥é‡å†™æ‚¨çš„è¯­è¨€æ‰€ç”¨çš„ä»£ç ï¼Œé‚£ä¹ˆæ‚¨çš„è¡¨ç°åŠ›ä¼šæœ‰å¤šå¼ºã€‚æ‚¨å°†çœŸæ­£å¤„äºä¸è¯­è¨€è®¾è®¡äººå‘˜ç›¸åŒçš„åœ°ä½ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥åœ¨è¯¥çº§åˆ«ç¼–å†™çš„æŠ½è±¡åŠ èµ·æ¥å¯ä»¥èŠ‚çœæ‚¨å¤šå¹´çš„å·¥ä½œã€‚</p><p>   Thanks to Daniel Woelfel,  Alex Kotliarskyi, Sean Grove, Joe Averbukh, Irakli Safareli, for reviewing drafts of this essay</p><p>æ„Ÿè°¢Daniel Woelfelï¼ŒAlex Kotliarskyiï¼ŒSean Groveï¼ŒJoe Averbukhï¼ŒIrakli Safareliå®¡é˜…è¿™ç¯‡æ–‡ç« çš„è‰ç¨¿</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://stopa.io/post/265">https://stopa.io/post/265</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/è¯­æ³•/">#è¯­æ³•</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/lisp/">#lisp</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ä»£ç /">#ä»£ç </a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¾å›½/">#ç¾å›½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è°·æ­Œ/">#è°·æ­Œ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç¨‹åº/">#ç¨‹åº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>