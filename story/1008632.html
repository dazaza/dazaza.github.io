<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Sqlite是如何工作的？</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Sqlite是如何工作的？</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-28 02:30:22</div><div class="page_narrow text-break page_content"><p>今天晚上，神奇的卡马兰让我坐下来，比我们以前学到了更多关于数据库的知识。</p><p>我想破解SQLite，因为我以前用过它，它不需要配置，也不需要单独的服务器进程，我被告知它的源代码写得很好，很容易接近，所有的数据都存储在一个文件中。太棒了！</p><p>只有一个主键和一个字符串！还有什么比这更简单的呢？然后，我编写了一些Python脚本，将/usr/share/dict/words的内容放入数据库：</p><p>将sqlite3c=sqlite3.connect(&#34；./fun.sqlite&#34；)with open(&#39；/usr/share/dict/words&#39；)导入为f：对于i，枚举中的Word(F)：Word=word.strid()word=Unicode(Word，&#39；latin1&#39；)c.Execute(&#34；插入到有趣的值(？，？)；&#34；，(i，Word))。</p><p>太棒了！现在，我们有一个名为fun.sqlite foreexperientation的4MB数据库。对于二进制文件，我最喜欢做的第一件事就是对它们进行分类。这非常有效，但是Kamal指出，当然，十六进制转储是查看二进制文件的更好方式。HEXDUMP-C fun.sqlite的输出如下所示：</p><p>我在本文中粘贴了六进制转储的前几千行，这样您可以更仔细地查看。您将看到该文件交替拆分为单词和胡言乱语-将会有一个主要是单词的序列，然后是不可读的无稽之谈。</p><p>这个原因当然有押韵之处！SQLite数据库的出色编写的文件格式告诉我们，SQLite数据库被分成多个页面，文件的第16和17字节就是页面大小。</p><p>00000000 53 51 4c 69 74 65 20 66 6f 72 6d 61 74 20 33 00|SQLite格式3.|00000010 04 00 01 01 00 40 20 20 00 00 00 27 00 000c be|[电子邮件受保护].&#39；.|^页面大小：)</p><p>所以我们的页面大小是0x0400字节，或1024字节，或1k。因此，这个数据库被分割成一堆1k的块，称为页面。</p><p>我们的FUN表的id列上有一个索引，它允许我们快速运行像SELECT*FROM FUN WHERE id=100这样的查询。更准确地说：要查找第100行，我们不需要阅读每一页，只需阅读几页即可。我总是以模糊的方式理解索引-我知道它们是“某种树”，它允许您访问O(Logn)中的数据，尤其是数据库使用的是一种称为btree的东西。我仍然不知道btree是什么。让我们看看还能不能做得更好！</p><p>这就是它开始变得真正有趣的地方！我下载了sqlitessource代码，Kamal和我想出了如何编译它(使用nix，这完全是另一回事)。</p><p>然后我放入一条打印语句，这样它每次访问页面时都会告诉我。大约有14万行SQLite源代码，这有点吓人！</p><p>/*//*。*//*2009年1月28日*作者放弃此源代码的版权。代替**法律通知，这里有一个祝福：*愿你行善不作恶。**愿你宽恕自己，宽恕他人。**愿你自由分享，从不超过您的备份此文件包含sqlite3backupxxx()**give.**函数和相关特性的实现。</p><p>我的下一个目标是让SQLite告诉我它是如何遍历页面的。对140,000行进行了一些仔细的整理后，我们找到了这个函数btreePageFromDbPage。所有页面读取都需要通过此函数，因此我们只需向其添加一些日志：)。</p><p>/*将从寻呼机获取的DbPage转换为**btree层使用的MemPage。*/static MemPage*btreePageFromDbPage(DbPage*pDbPage，Pgno pgno，BtShared*pbt){MemPage*ppage=(MemPage*)sqlite3PagerGetExtra(PDbPage)；ppage-&gt；adata=sqlite3Page3Page3Page。页页-&gt；hdrOffset=页页-&gt；pgno==1？100：0；返回页页；}。</p><p>现在它每读一页就会通知我们！干净利落！我们来做个小实验。</p><p>sqlite&&gt;SELECT*FROM FUN WHERE id=1；读取btree页，页号1读取btree页，页号5读取btree页，页号828读取btree页，页号10读取btree页，页号2读取btree页，页号76读取btree页，页号61|A&#39；ssqlite&&gt;；SELECT*FROM FUN where id=20；读取btree页，页号1读取。</p><p>这两行(第1行和第20行)在同一页中，因此它遍历相同的路径才能到达这两行！</p><p>SQLITE&&gt;SELECT*FROM FUN WHERE id=200；读取btree页，页号1读取btree页，页号5读取btree页，页号828读取btree页，页号11读取btree页，页号2读取btree页，页号76阅读btree页，页号2818200|aggie。</p><p>显然，200在树上是相当接近的，但它需要在最后转到2818。而80000要远得多：</p><p>SQLITE&&gt;SELECT*FROM FUN WHERE id=80000；读取btree页，页号1读取btree页，页号5阅读btree页，页号1198阅读btree页，页号992阅读btree页，页号2阅读btree页，页号1813阅读btree页，页号44980000|scarfs。</p><p>如果我们返回并检查该文件，我们可以看到页面1、5、1198、992、2和1813是内部节点-其中没有数据，只有指向其他页面的指针。第6、2818和449页是叶节点，它们是数据所在的位置。</p><p>我仍然不太清楚内部页面是如何构建的，以及指向其子页面的指针是如何工作的。现在是睡觉的时间了，但也许那会在以后的某一天发生！</p><p>修改开放源码程序以打印出调试信息，以便更好地了解它们的内部结构：非常有趣。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://jvns.ca/blog/2014/09/27/how-does-sqlite-work-part-1-pages/">https://jvns.ca/blog/2014/09/27/how-does-sqlite-work-part-1-pages/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/sqlite/">#sqlite</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1006822.html"><img src="http://img.diglog.com/img/2020/6/thumb_8f8c5b1332820c7c0c8de312535c9593.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1006822.html">一种面向SQLite的Jupyter内核</a></div><span class="my_story_list_date">2020-6-17 0:14</span></div><div class="col-sm"><div><a target="_blank" href="/story/1006434.html"><img src="http://img.diglog.com/img/2020/6/thumb_0afa365aa6fefea5db5b7c52877985b4.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1006434.html">使用SQLite从*选择Code_Execution From*；</a></div><span class="my_story_list_date">2020-6-14 1:12</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003458.html"><img src="http://img.diglog.com/img/2020/5/thumb_14171a5347be41b5d0afb282b90a6222.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003458.html">DuckDB，SQLite for Analytics</a></div><span class="my_story_list_date">2020-5-24 7:20</span></div><div class="col-sm"><div><a target="_blank" href="/story/1002380.html"><img src="http://img.diglog.com/img/2020/5/thumb_00bbc7fd7c30910f969897267423d001.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1002380.html">Python Flask REST API和Sqlite DB AS数据存储，不超过100行</a></div><span class="my_story_list_date">2020-5-16 18:8</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>