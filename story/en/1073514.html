<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>æ–‡æœ¬å‘ˆç°è®¨åŒä½ ï¼ˆ2019ï¼‰Text Rendering Hates You (2019)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Text Rendering Hates You (2019)<br/>æ–‡æœ¬å‘ˆç°è®¨åŒä½ ï¼ˆ2019ï¼‰</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2022-02-15 20:20:58</div><div class="page_narrow text-break page_content"><p>Rendering text, how hard could it be? As it turns out, incredibly hard! To my knowledge, literally no system renders text â€œperfectlyâ€. Itâ€™s all best-effort, although some efforts are more important than others.</p><p>æ¸²æŸ“æ–‡æœ¬ï¼Œæœ‰å¤šå›°éš¾ï¼Ÿäº‹å®è¯æ˜ï¼Œè¿™éå¸¸éš¾ï¼æ®æˆ‘æ‰€çŸ¥ï¼Œå‡ ä¹æ²¡æœ‰ä»»ä½•ç³»ç»Ÿèƒ½â€œå®Œç¾åœ°â€å‘ˆç°æ–‡æœ¬ã€‚è¿™éƒ½æ˜¯æœ€å¥½çš„åŠªåŠ›ï¼Œå°½ç®¡æœ‰äº›åŠªåŠ›æ¯”å…¶ä»–åŠªåŠ›æ›´é‡è¦ã€‚</p><p> Iâ€™ll be assuming you want to support arbitrary text provided by users with custom fonts, colors, and styles with line-wrapping and support for text-selection. Basically the minimum required to properly display a simple rich-text document, terminal, webpage, or anything else.</p><p>æˆ‘å‡è®¾æ‚¨å¸Œæœ›æ”¯æŒç”¨æˆ·æä¾›çš„ä»»æ„æ–‡æœ¬ï¼Œè¿™äº›æ–‡æœ¬å…·æœ‰è‡ªå®šä¹‰å­—ä½“ã€é¢œè‰²å’Œå¸¦æœ‰æ¢è¡Œå’Œæ”¯æŒæ–‡æœ¬é€‰æ‹©çš„æ ·å¼ã€‚åŸºæœ¬ä¸Šæ˜¯æ­£ç¡®æ˜¾ç¤ºç®€å•çš„å¯Œæ–‡æœ¬æ–‡æ¡£ã€ç»ˆç«¯ã€ç½‘é¡µæˆ–å…¶ä»–ä»»ä½•å†…å®¹æ‰€éœ€çš„æœ€ä½è¦æ±‚ã€‚</p><p> The overarching theme here will be: there are no consistent right answers, everything is way more important than you think, and everything affects everything else.</p><p>è¿™é‡Œæœ€é‡è¦çš„ä¸»é¢˜æ˜¯ï¼šæ²¡æœ‰ä¸€è‡´çš„æ­£ç¡®ç­”æ¡ˆï¼Œæ¯ä»¶äº‹éƒ½æ¯”ä½ æƒ³è±¡çš„é‡è¦å¾—å¤šï¼Œæ¯ä»¶äº‹éƒ½ä¼šå½±å“å…¶ä»–ä¸€åˆ‡ã€‚</p><p> The topics I focus on here have no particular rhyme or reason, theyâ€™re just the ones that come to mind after a few years of working on rendering in Firefox. For instance, I donâ€™t spend much time talking about the challenges of text-segmentation or managing the different platform-specific text libraries, because I donâ€™t look at that much.</p><p>æˆ‘åœ¨è¿™é‡Œå…³æ³¨çš„ä¸»é¢˜æ²¡æœ‰ç‰¹åˆ«çš„éŸµå‘³æˆ–ç†ç”±ï¼Œå®ƒä»¬åªæ˜¯åœ¨Firefoxä¸­æ¸²æŸ“å‡ å¹´åå‡ºç°åœ¨æˆ‘è„‘æµ·ä¸­çš„ä¸»é¢˜ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä¸ä¼šèŠ±å¤ªå¤šæ—¶é—´è®¨è®ºæ–‡æœ¬åˆ†å‰²æˆ–ç®¡ç†ä¸åŒå¹³å°ç‰¹å®šæ–‡æœ¬åº“çš„æŒ‘æˆ˜ï¼Œå› ä¸ºæˆ‘ä¸ä¼šçœ‹å¤ªå¤šã€‚</p><p>  Text is complicated and english is bad at expressing these nuances. For the purpose of this document, I will try to stick to the following terms. Note that these words arenâ€™t â€œrightâ€, I just find them useful for communicating the key concepts to native english speakers who donâ€™t have backgrounds in linguistics.</p><p>æ–‡æœ¬å¾ˆå¤æ‚ï¼Œè‹±è¯­ä¸å–„äºè¡¨è¾¾è¿™äº›ç»†å¾®å·®åˆ«ã€‚å°±æœ¬æ–‡ä»¶è€Œè¨€ï¼Œæˆ‘å°†å°½é‡éµå®ˆä»¥ä¸‹æ¡æ¬¾ã€‚è¯·æ³¨æ„ï¼Œè¿™äº›è¯ä¸æ˜¯â€œæ­£ç¡®çš„â€ï¼Œæˆ‘åªæ˜¯è§‰å¾—å®ƒä»¬å¯¹å‘æ²¡æœ‰è¯­è¨€å­¦èƒŒæ™¯çš„è‹±è¯­æ¯è¯­äººå£«ä¼ è¾¾å…³é”®æ¦‚å¿µå¾ˆæœ‰ç”¨ã€‚</p><p>  Scalar: A Unicode Scalar, the â€œsmallest unitâ€ unicode describes (AKA a code point).</p><p>æ ‡é‡ï¼šUnicodeæ ‡é‡ï¼ŒUnicodeæè¿°çš„â€œæœ€å°å•ä½â€ï¼ˆåˆåä»£ç ç‚¹ï¼‰ã€‚</p><p> Character: A Unicode Extended Grapheme Cluster (EGC), the â€œbiggest unitâ€ unicode describes (potentially composed of multiple scalars).</p><p>å­—ç¬¦ï¼šä¸€ä¸ªUnicodeæ‰©å±•å­—é›†é›†ç¾¤ï¼ˆEGCï¼‰ï¼ŒUnicodeæè¿°çš„â€œæœ€å¤§å•å…ƒâ€ï¼ˆå¯èƒ½ç”±å¤šä¸ªæ ‡é‡ç»„æˆï¼‰ã€‚</p><p> Glyph: An atomic unit of rendering yielded by the font. Generally this will have a unique ID in the font.</p><p>å­—å½¢ï¼šç”±å­—ä½“äº§ç”Ÿçš„ä¸€ç§åŸå­å‘ˆç°å•ä½ã€‚é€šå¸¸ï¼Œå­—ä½“ä¸­ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„IDã€‚</p><p> Ligature: A glyph that is made up of several scalars, and potentially even several characters (native speakers may or may not think of a ligature as multiple â€œcharactersâ€, but to the font itâ€™s just one â€œcharacterâ€).</p><p>è¿å­—ï¼šç”±å‡ ä¸ªæ ‡é‡ï¼Œç”šè‡³å¯èƒ½æ˜¯å‡ ä¸ªå­—ç¬¦ç»„æˆçš„å­—å½¢ï¼ˆæ¯è¯­äººå£«å¯èƒ½è®¤ä¸ºè¿å­—æ˜¯å¤šä¸ªâ€œå­—ç¬¦â€ï¼Œä¹Ÿå¯èƒ½ä¸è®¤ä¸ºè¿å­—æ˜¯å¤šä¸ªâ€œå­—ç¬¦â€ï¼Œä½†å¯¹äºå­—ä½“æ¥è¯´ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªâ€œå­—ç¬¦â€ï¼‰ã€‚</p><p>  Script: The set of glyphs that make up some language (fonts tend to implement particular scripts).</p><p>è„šæœ¬ï¼šç»„æˆæŸç§è¯­è¨€çš„ä¸€ç»„å­—å½¢ï¼ˆå­—ä½“å€¾å‘äºå®ç°ç‰¹å®šçš„è„šæœ¬ï¼‰ã€‚</p><p>  Color: RGB and Alpha values for fonts (alpha isnâ€™t needed for some usecases, but itâ€™s interesting).</p><p>é¢œè‰²ï¼šå­—ä½“çš„RGBå’ŒAlphaå€¼ï¼ˆæœ‰äº›ç”¨ä¾‹ä¸éœ€è¦Alphaï¼Œä½†å¾ˆæœ‰è¶£ï¼‰ã€‚</p><p> Style: Bold and Italics modifiers for fonts (hinting, aliasing, and other settings tend to also get crammed in here in practical implementations).</p><p>æ ·å¼ï¼šå­—ä½“çš„ç²—ä½“å’Œæ–œä½“ä¿®é¥°ç¬¦ï¼ˆæš—ç¤ºã€åˆ«åå’Œå…¶ä»–è®¾ç½®åœ¨å®é™…å®ç°ä¸­ä¹Ÿä¼šè¢«å¡æ»¡ï¼‰ã€‚</p><p>  Just so you have an idea for how a typical text-rendering pipeline works, hereâ€™s a quick sketch:</p><p>ä¸ºäº†è®©æ‚¨äº†è§£å…¸å‹çš„æ–‡æœ¬æ¸²æŸ“ç®¡é“æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºæ„å›¾ï¼š</p><p>   Most fonts donâ€™t actually provide every glyph in existence. Thereâ€™s too many glyphs, so fonts are usually designed to only implement a particular script. End users usually donâ€™t know or care about this, and so a robust system must  cascade into other fonts when characters arenâ€™t available.</p><p>å¤§å¤šæ•°å­—ä½“å®é™…ä¸Šå¹¶æ²¡æœ‰æä¾›æ‰€æœ‰ç°å­˜çš„å­—å½¢ã€‚å­—å½¢å¤ªå¤šï¼Œæ‰€ä»¥å­—ä½“é€šå¸¸è®¾è®¡ä¸ºåªå®ç°ç‰¹å®šçš„è„šæœ¬ã€‚æœ€ç»ˆç”¨æˆ·é€šå¸¸ä¸çŸ¥é“æˆ–ä¸å…³å¿ƒè¿™ä¸€ç‚¹ï¼Œå› æ­¤å½“å­—ç¬¦ä¸å¯ç”¨æ—¶ï¼Œä¸€ä¸ªå¥å£®çš„ç³»ç»Ÿå¿…é¡»çº§è”åˆ°å…¶ä»–å­—ä½“ä¸­ã€‚</p><p> For instance, even though the markup of the following text doesnâ€™t  suggest the presence of multiple fonts, drawing it correctly on all systems absolutely requires it: hello ğŸ˜º à¤®à¤¨à¥€à¤· Ø¨Ø³Ù… å¥½. This is dangerously close to Step 1 (Styling) depending on the results of Step 3 (Shaping)!</p><p>ä¾‹å¦‚ï¼Œå°½ç®¡ä»¥ä¸‹æ–‡æœ¬çš„æ ‡è®°å¹¶ä¸è¡¨ç¤ºå­˜åœ¨å¤šç§å­—ä½“ï¼Œä½†åœ¨æ‰€æœ‰ç³»ç»Ÿä¸Šæ­£ç¡®ç»˜åˆ¶å®ƒç»å¯¹éœ€è¦ï¼šhelloğŸ˜º à¤®à¤¨à¥€à¤· Ø¨Ø³Ù… å¥½. è¿™ä¸æ­¥éª¤1ï¼ˆé€ å‹ï¼‰éå¸¸æ¥è¿‘ï¼Œè¿™å–å†³äºæ­¥éª¤3ï¼ˆé€ å‹ï¼‰çš„ç»“æœï¼</p><p> (Alternatively, you can take the  Noto approach and use a single Uber Font that contains every character ever. Although that means users canâ€™t configure the font, and you canâ€™t provide a â€œnativeâ€ text experience to users on all platforms. But letâ€™s assume you want the more robust solution.)</p><p>ï¼ˆæˆ–è€…ï¼Œä½ å¯ä»¥é‡‡ç”¨Notoæ–¹æ³•ï¼Œä½¿ç”¨ä¸€ç§åŒ…å«æ‰€æœ‰å­—ç¬¦çš„Uberå­—ä½“ã€‚å°½ç®¡è¿™æ„å‘³ç€ç”¨æˆ·æ— æ³•é…ç½®å­—ä½“ï¼Œä¹Ÿæ— æ³•åœ¨æ‰€æœ‰å¹³å°ä¸Šä¸ºç”¨æˆ·æä¾›â€œåŸç”Ÿâ€æ–‡æœ¬ä½“éªŒã€‚ä½†å‡è®¾ä½ æƒ³è¦æ›´å¼ºå¤§çš„è§£å†³æ–¹æ¡ˆã€‚ï¼‰</p><p> Similarly, layout requires you to know how much space each part of your text takes up, but this is only known once you shape the text! Step 2 depends on the results of Step 3?</p><p>åŒæ ·ï¼Œå¸ƒå±€è¦æ±‚æ‚¨çŸ¥é“æ–‡æœ¬çš„æ¯ä¸ªéƒ¨åˆ†å ç”¨äº†å¤šå°‘ç©ºé—´ï¼Œä½†è¿™åªæœ‰åœ¨æ‚¨å¡‘é€ æ–‡æœ¬ä¹‹åæ‰èƒ½çŸ¥é“ï¼ç¬¬äºŒæ­¥å–å†³äºç¬¬ä¸‰æ­¥çš„ç»“æœï¼Ÿ</p><p> Shaping absolutely depends on you knowing your layout and styling, so we seem to be stuck. What do we do?</p><p>é€ å‹å®Œå…¨å–å†³äºä½ å¯¹è‡ªå·±çš„å¸ƒå±€å’Œé€ å‹çš„äº†è§£ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼¼ä¹è¢«å¡ä½äº†ã€‚æˆ‘ä»¬è¯¥æ€ä¹ˆåŠï¼Ÿ</p><p> First off, styling gets to cheat. Although what we  really want from a font is full glyphs, styling only needs to ask about  scalars. If a font doesnâ€™t properly support a script it shouldnâ€™t claim to know anything about the scalars that make up that script. So we can easily find the â€œbestâ€ font as follows:</p><p>é¦–å…ˆï¼Œé€ å‹ä¼šä½œå¼Šã€‚è™½ç„¶æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„å­—ä½“æ˜¯å®Œæ•´çš„å­—å½¢ï¼Œä½†æ ·å¼è®¾è®¡åªéœ€è¦è¯¢é—®æ ‡é‡ã€‚å¦‚æœå­—ä½“ä¸èƒ½æ­£ç¡®æ”¯æŒè„šæœ¬ï¼Œå®ƒå°±ä¸åº”è¯¥å£°ç§°çŸ¥é“ç»„æˆè„šæœ¬çš„æ ‡é‡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰¾åˆ°â€œæœ€ä½³â€å­—ä½“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p> For every character (EGC) in our text, keep asking each font in our cascade if it knows about all the scalars that make up that character, and use it if it does. If we get to the end of the cascade with no providers, then we yield tofu ( ô¿½, a missing glyph indicator).</p><p>å¯¹äºæ–‡æœ¬ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼ˆEGCï¼‰ï¼Œä¸æ–­è¯¢é—®çº§è”ä¸­çš„æ¯ä¸ªå­—ä½“æ˜¯å¦çŸ¥é“ç»„æˆè¯¥å­—ç¬¦çš„æ‰€æœ‰æ ‡é‡ï¼Œå¦‚æœçŸ¥é“ï¼Œå°±ä½¿ç”¨å®ƒã€‚å¦‚æœæˆ‘ä»¬åœ¨æ²¡æœ‰ä¾›åº”å•†çš„æƒ…å†µä¸‹èµ°åˆ°æœ€åï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šç”Ÿäº§è±†è…ï¼ˆô¿½, ç¼ºå°‘å›¾ç¤ºç¬¦æŒ‡ç¤ºå™¨ï¼‰ã€‚</p><p> In the case of emoji, youâ€™ve probably seen the failure mode of this process before! Because some emoji are actually ligatures of several simpler emoji, a font may successfully report support for the character while only yielding the components. So ğŸ¤¦ğŸ¿â€â™€ï¸ may literally appear as ğŸ¤¦ ğŸ¿â€ â™€ if the font is â€œtoo oldâ€ to know about the new ligature. This can also happen if your unicode implementation is â€œtoo oldâ€ to know about a character, causing the styling system to accept a partial match in the font.</p><p>åœ¨è¡¨æƒ…ç¬¦å·çš„ä¾‹å­ä¸­ï¼Œä½ å¯èƒ½å·²ç»è§è¿‡è¿™ä¸ªè¿‡ç¨‹çš„å¤±è´¥æ¨¡å¼äº†ï¼å› ä¸ºä¸€äº›è¡¨æƒ…ç¬¦å·å®é™…ä¸Šæ˜¯å‡ ä¸ªç®€å•è¡¨æƒ…ç¬¦å·çš„è¿å­—ï¼Œæ‰€ä»¥å­—ä½“å¯èƒ½ä¼šæˆåŠŸåœ°æŠ¥å‘Šå¯¹è¯¥å­—ç¬¦çš„æ”¯æŒï¼ŒåŒæ—¶åªç”Ÿæˆç»„ä»¶ã€‚æ‰€ä»¥ğŸ¤¦ğŸ¿â€â™€ï¸ å¯èƒ½çœ‹èµ·æ¥åƒğŸ¤¦ ğŸ¿â€ â™€ å¦‚æœå­—ä½“â€œå¤ªæ—§â€ï¼Œæ— æ³•äº†è§£æ–°çš„è¿å­—ã€‚å¦‚æœunicodeå®ç°â€œå¤ªæ—§â€ï¼Œæ— æ³•äº†è§£å­—ç¬¦ï¼Œå¯¼è‡´æ ·å¼ç³»ç»Ÿæ¥å—å­—ä½“ä¸­çš„éƒ¨åˆ†åŒ¹é…ï¼Œä¹Ÿä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚</p><p> So now we know exactly what fonts weâ€™ll use without looking at layout or shape (although shaping might change our colors, more on that in later sections). Can we untie layout and shape as well? Nope! Things like paragraph breaks give you a nice hard break on lines, but the only way to do wrapping is to iteratively do shaping!</p><p>å› æ­¤ï¼Œç°åœ¨æˆ‘ä»¬ä¸éœ€è¦æŸ¥çœ‹å¸ƒå±€æˆ–å½¢çŠ¶ï¼Œå°±å¯ä»¥ç¡®åˆ‡åœ°çŸ¥é“æˆ‘ä»¬å°†ä½¿ç”¨ä»€ä¹ˆå­—ä½“ï¼ˆå°½ç®¡å½¢çŠ¶å¯èƒ½ä¼šæ”¹å˜æˆ‘ä»¬çš„é¢œè‰²ï¼Œåé¢çš„éƒ¨åˆ†å°†å¯¹æ­¤è¿›è¡Œè¯¦ç»†ä»‹ç»ï¼‰ã€‚æˆ‘ä»¬èƒ½åŒæ—¶è§£å¼€å¸ƒå±€å’Œå½¢çŠ¶å—ï¼Ÿä¸ï¼åƒæ®µè½åˆ†éš”ç¬¦è¿™æ ·çš„ä¸œè¥¿ä¼šè®©ä½ åœ¨è¡Œä¸Šæœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç¡¬ä¸­æ–­ï¼Œä½†æ˜¯è¿›è¡ŒåŒ…è£…çš„å”¯ä¸€æ–¹æ³•æ˜¯è¿­ä»£åœ°è¿›è¡Œé€ å‹ï¼</p><p> You have to assume that your text fits on a single line and shape it until you run out of space. At that point you can perform layout operations and figure out where to break the text and start the next line. Repeat until everything is shaped and laid out.</p><p>ä½ å¿…é¡»å‡è®¾ä½ çš„æ–‡æœ¬åªé€‚åˆä¸€è¡Œï¼Œå¹¶å¡‘é€ å®ƒï¼Œç›´åˆ°ä½ ç”¨å®Œç©ºé—´ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæ‚¨å¯ä»¥æ‰§è¡Œå¸ƒå±€æ“ä½œï¼Œå¹¶ç¡®å®šåœ¨ä½•å¤„æ‰“æ–­æ–‡æœ¬å¹¶å¼€å§‹ä¸‹ä¸€è¡Œã€‚é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰çš„ä¸œè¥¿éƒ½æˆå‹å¹¶å¸ƒç½®å¥½ã€‚</p><p>  Coming from english, you might think ligatures are just fancy fluff. I mean, who  really cares if â€œÃ¦â€ is written as â€œaeâ€? Well, as it turns out, some languages are basically entirely ligatures. For instance â€œà¤¡à¥à¤¡ Ø¨Ø³Ù…â€ has individual characters of â€œà¤¡à¥ à¤¡ Ø¨ Ø³ Ù…â€. If youâ€™re viewing this in a competent text-rendering system (any of the major browsers), those two strings should look  very different.</p><p>æ¥è‡ªè‹±è¯­ï¼Œä½ å¯èƒ½ä¼šè®¤ä¸ºè¿å­—åªæ˜¯èŠ±å“¨çš„ç»’æ¯›ã€‚æˆ‘çš„æ„æ€æ˜¯ï¼Œè°çœŸçš„åœ¨ä¹â€œÃ¦â€æ˜¯å¦å†™ä¸ºâ€œaeâ€ï¼Ÿäº‹å®è¯æ˜ï¼Œæœ‰äº›è¯­è¨€åŸºæœ¬ä¸Šå®Œå…¨æ˜¯è¿å­—ã€‚ä¾‹å¦‚â€œà¤¡à¥à¤¡ Ø¨Ø³Ù…â€œå…·æœ‰â€çš„ä¸ªæ€§à¤¡à¥ à¤¡ Ø¨Ø³Ù…â€ã€‚å¦‚æœæ‚¨åœ¨ä¸€ä¸ªæœ‰èƒ½åŠ›çš„æ–‡æœ¬å‘ˆç°ç³»ç»Ÿï¼ˆä»»ä½•ä¸»è¦æµè§ˆå™¨ï¼‰ä¸­æŸ¥çœ‹æ­¤å†…å®¹ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²çœ‹èµ·æ¥åº”è¯¥éå¸¸ä¸åŒã€‚</p><p> And no: this isnâ€™t about the difference between unicode scalars and extended grapheme clusters. If you ask a unicode-robust system (such as Swift) for the extended grapheme clusters of that string, it will spit out those 5 characters!</p><p>ä¸ï¼šè¿™ä¸æ˜¯unicodeæ ‡é‡å’Œæ‰©å±•çš„graphemeé›†ç¾¤ä¹‹é—´çš„åŒºåˆ«ã€‚å¦‚æœä½ å‘ä¸€ä¸ªunicodeå¥å£®çš„ç³»ç»Ÿï¼ˆæ¯”å¦‚Swiftï¼‰è¯¢é—®è¯¥å­—ç¬¦ä¸²çš„æ‰©å±•å­—ç¬¦é›†ï¼Œå®ƒä¼šåå‡ºè¿™5ä¸ªå­—ç¬¦ï¼</p><p> The shape of a character depends on its neighbours:  you cannot correctly draw text character-by-character.</p><p>ä¸€ä¸ªå­—ç¬¦çš„å½¢çŠ¶å–å†³äºå®ƒçš„é‚»åŸŸï¼šä½ ä¸èƒ½ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦åœ°æ­£ç¡®ç»˜åˆ¶æ–‡æœ¬ã€‚</p><p> Which is to say, you must use a  shaping library. The industry standard for this is  HarfBuzz, and itâ€™s extremely hard to implement your own. Use HarfBuzz.</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¿…é¡»ä½¿ç”¨ä¸€ä¸ªæˆå½¢åº“ã€‚è¿™æ–¹é¢çš„è¡Œä¸šæ ‡å‡†æ˜¯HarfBuzzï¼Œè¦å®ç°è‡ªå·±çš„æ ‡å‡†éå¸¸å›°éš¾ã€‚ä½¿ç”¨å“ˆå¤«å¸ƒå…¹ã€‚</p><p>  Cursive scripts frequently have their glyphs intersect to avoid seams, and that can cause you problems.</p><p>è‰ä¹¦çš„å­—å½¢ç»å¸¸ç›¸äº¤ä»¥é¿å…æ¥ç¼ï¼Œè¿™å¯èƒ½ä¼šç»™æ‚¨å¸¦æ¥é—®é¢˜ã€‚</p><p> Letâ€™s look at â€œà¤®à¤¨à¥€à¤· Ù…Ù†Ø´â€ again. Seems fine, eh? Letâ€™s blow it up:</p><p>è®©æˆ‘ä»¬çœ‹çœ‹â€œà¤®à¤¨à¥€à¤· â€œåˆæ¥äº†ã€‚çœ‹èµ·æ¥ä¸é”™å§ï¼Ÿè®©æˆ‘ä»¬æŠŠå®ƒç‚¸äº†å§ï¼š</p><p>    If youâ€™re in Safari or Edge, this might still look ok! If youâ€™re in Firefox or Chrome, it looks awful, like this:</p><p>å¦‚æœä½ åœ¨ç‹©çŒæˆ–è¾¹ç¼˜ï¼Œè¿™å¯èƒ½ä»ç„¶çœ‹èµ·æ¥ä¸é”™ï¼å¦‚æœä½ ä½¿ç”¨çš„æ˜¯Firefoxæˆ–Chromeï¼Œå®ƒçœ‹èµ·æ¥å¾ˆç³Ÿç³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>  The problem is that Chrome and Firefox are trying to  cheat. They ate their vegetables and properly shaped the text, but once they had glyphs they still tried to draw them individually. This mostly works fine, except for when thereâ€™s transparency and overlapping. Then you get darkening at the overlaps.</p><p>é—®é¢˜æ˜¯Chromeå’ŒFirefoxæ­£åœ¨è¯•å›¾ä½œå¼Šã€‚ä»–ä»¬åƒè”¬èœï¼Œå¹¶æ­£ç¡®åœ°å¡‘é€ æ–‡å­—ï¼Œä½†ä¸€æ—¦ä»–ä»¬æœ‰äº†å­—å½¢ï¼Œä»–ä»¬ä»ç„¶è¯•å›¾å•ç‹¬ç»˜åˆ¶ã€‚é™¤äº†é€æ˜å’Œé‡å ä¹‹å¤–ï¼Œè¿™åŸºæœ¬ä¸Šå¯ä»¥æ­£å¸¸å·¥ä½œã€‚ç„¶ååœ¨é‡å å¤„å˜æš—ã€‚</p><p> A â€œcorrectâ€ implementation will draw the text to a temporary surface  without transparency and then composite that surface into the scene  with transparency. Firefox and Chrome donâ€™t do this because itâ€™s expensive and  usually unnecessary for the major western languages. Interestingly, they  do understand the issue, because they actually bend over backwards to specially handle this for emoji (but weâ€™ll get to that later).</p><p>â€œæ­£ç¡®â€çš„å®ç°ä¼šå°†æ–‡æœ¬ç»˜åˆ¶åˆ°æ²¡æœ‰é€æ˜åº¦çš„ä¸´æ—¶æ›²é¢ä¸Šï¼Œç„¶åå°†è¯¥æ›²é¢åˆæˆåˆ°å…·æœ‰é€æ˜åº¦çš„åœºæ™¯ä¸­ã€‚Firefoxå’ŒChromeä¸è¿™ä¹ˆåšï¼Œå› ä¸ºå®ƒå¾ˆæ˜‚è´µï¼Œè€Œä¸”å¯¹äºä¸»è¦çš„è¥¿æ–¹è¯­è¨€æ¥è¯´é€šå¸¸æ˜¯ä¸å¿…è¦çš„ã€‚æœ‰è¶£çš„æ˜¯ï¼Œä»–ä»¬ç¡®å®ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºä»–ä»¬å®é™…ä¸Šä¼šç«­å°½å…¨åŠ›ä¸“é—¨å¤„ç†emojiï¼ˆä½†æˆ‘ä»¬å°†åœ¨åé¢è®¨è®ºï¼‰ã€‚</p><p>  Ok this one is  mostly a curiosity in that Iâ€™m not aware of any super-reasonable cases where this happens, but it naturally falls out of markups. Hereâ€™s two pieces of text with the same  content but different color styling:</p><p>å¥½çš„ï¼Œè¿™ä¸€ä¸ªä¸»è¦æ˜¯ä¸€ä¸ªå¥½å¥‡ï¼Œå› ä¸ºæˆ‘ä¸çŸ¥é“æœ‰ä»»ä½•è¶…åˆç†çš„æƒ…å†µä¸‹ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œä½†å®ƒè‡ªç„¶ä¼šä¸‹é™çš„åŠ ä»·ã€‚ä»¥ä¸‹æ˜¯ä¸¤æ®µå†…å®¹ç›¸åŒä½†é¢œè‰²æ ·å¼ä¸åŒçš„æ–‡æœ¬ï¼š</p><p> à¤ªà¤¨à¥à¤¹  à¤ªà¤¨à¥à¤¹  à¤¤à¥à¤°  à¤°à¥à¤š  à¤•à¥ƒà¤• à¥ƒ  à¤¡ à¥à¤¡  à¤¨ à¥à¤¹ à¥ƒ à¥‡  Ø¥Ù„ Ø§  Ø¨ Ø³ Ù…  Ø§ Ù„ Ù„ Ù‡</p><p>à¤ªà¤¨à¥à¤¹  à¤ªà¤¨à¥à¤¹  à¤¤à¥à¤°  à¤°à¥à¤š  à¤•à¥ƒà¤• à¥ƒ  à¤¡ à¥à¤¡  à¤¨ à¥à¤¹ à¥ƒ à¥‡  Ø¥Ù„ Ø§  Ø¨ Ø³ Ù…  Ø§ Ù„ Ù„ Ù‡</p><p> à¤ªà¤¨à¥à¤¹ à¤ªà¤¨à¥à¤¹ à¤¤à¥à¤° à¤°à¥à¤š à¤•à¥ƒà¤•à¥ƒ à¤¡à¥à¤¡ à¤¨à¥à¤¹à¥ƒà¥‡ Ø¥Ù„Ø§ Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡</p><p>à¤ªà¤¨à¥à¤¹ à¤ªà¤¨à¥à¤¹ à¤¤à¥à¤° à¤°à¥à¤š à¤•à¥ƒà¤•à¥ƒ à¤¡à¥à¤¡ à¤¨à¥à¤¹à¥ƒà¥‡ Ø¥Ù„Ø§ Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡</p><p>     Hereâ€™s what they look like in Chrome (if using its  new layout implementation):</p><p>ä»¥ä¸‹æ˜¯å®ƒä»¬åœ¨Chromeä¸­çš„å¤–è§‚ï¼ˆå¦‚æœä½¿ç”¨æ–°çš„å¸ƒå±€å®ç°ï¼‰ï¼š</p><p>        I guess everyone should do what Firefox does, right? But if we zoom in, we can see that itâ€™s doing something very janky:</p><p>æˆ‘æƒ³æ¯ä¸ªäººéƒ½åº”è¯¥åƒFirefoxé‚£æ ·åšï¼Œå¯¹å§ï¼Ÿä½†å¦‚æœæˆ‘ä»¬æ”¾å¤§ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ­£åœ¨åšä¸€äº›éå¸¸åˆºè€³çš„äº‹æƒ…ï¼š</p><p>   The problem is, thereâ€™s really no reasonable answer for what  should happen here. Weâ€™ve broken up a ligature with different stylings, and since the ligature is in some sense a rendering â€œunitâ€ itâ€™s reasonable to simply refuse to support this (as most do).</p><p>é—®é¢˜æ˜¯ï¼Œè¿™é‡ŒçœŸçš„æ²¡æœ‰åˆç†çš„ç­”æ¡ˆã€‚æˆ‘ä»¬å·²ç»ç”¨ä¸åŒçš„æ ·å¼åˆ†è§£äº†ä¸€ä¸ªè¿å­—ï¼Œç”±äºè¿å­—åœ¨æŸç§æ„ä¹‰ä¸Šæ˜¯ä¸€ä¸ªå‘ˆç°â€œå•å…ƒâ€ï¼Œæ‰€ä»¥æ‹’ç»æ”¯æŒå®ƒæ˜¯åˆç†çš„ï¼ˆå°±åƒå¤§å¤šæ•°äººé‚£æ ·ï¼‰ã€‚</p><p> For whatever reason,  someone working on Firefox got really enthusiastic about trying to handle it more gracefully. The general approach is to draw the ligature multiple times with best-guess masks and different colors, which works surprisingly well!</p><p>ä¸ç®¡å‡ºäºä»€ä¹ˆåŸå› ï¼ŒFirefoxä¸Šçš„å·¥ä½œäººå‘˜éå¸¸çƒ­è¡·äºå°è¯•æ›´ä¼˜é›…åœ°å¤„ç†å®ƒã€‚ä¸€èˆ¬çš„æ–¹æ³•æ˜¯ç”¨æœ€ä½³çŒœæµ‹é¢å…·å’Œä¸åŒçš„é¢œè‰²å¤šæ¬¡ç”»è¿å­—ï¼Œæ•ˆæœå‡ºäººæ„æ–™åœ°å¥½ï¼</p><p> There is a  some merit in trying to support these â€œpartial ligaturesâ€: only shaping can know if a ligature will happen, and it can depend on system-specific fonts, so a ligature may show up where no one expected! The classic english example here is an Ã¦ ligature from a user-installed font spanning the boundary of a hyperlink.</p><p>å°è¯•æ”¯æŒè¿™äº›â€œéƒ¨åˆ†è¿å­—â€æœ‰ä¸€äº›å¥½å¤„ï¼šåªæœ‰æ•´å½¢æ‰èƒ½çŸ¥é“æ˜¯å¦ä¼šå‘ç”Ÿè¿å­—ï¼Œè€Œä¸”å®ƒå¯ä»¥å–å†³äºç³»ç»Ÿç‰¹å®šçš„å­—ä½“ï¼Œæ‰€ä»¥è¿å­—å¯èƒ½ä¼šå‡ºç°åœ¨æ²¡æœ‰äººé¢„æ–™åˆ°çš„åœ°æ–¹ï¼è¿™é‡Œçš„ç»å…¸è‹±æ–‡ç¤ºä¾‹æ˜¯ç”¨æˆ·å®‰è£…çš„å­—ä½“è·¨è¶Šè¶…é“¾æ¥è¾¹ç•Œçš„Ã¦è¿å­—ã€‚</p><p> Also it kinda sucks that english can ch ange  style mid-word but cursive scripts canâ€™t?</p><p>è¿˜æœ‰ä¸€ç‚¹å¾ˆç³Ÿç³•ï¼Œè‹±è¯­å¯ä»¥æ”¹å˜ä¸­é—´è¯çš„é£æ ¼ï¼Œä½†è‰ä¹¦å´ä¸èƒ½ï¼Ÿ</p><p>   If you draw emoji the way the native system would, you need to disrespect the textâ€™s color settings (except for transparency):</p><p>å¦‚æœæŒ‰ç…§æœ¬æœºç³»ç»Ÿçš„æ–¹å¼ç»˜åˆ¶è¡¨æƒ…ç¬¦å·ï¼Œåˆ™éœ€è¦ä¸å°Šé‡æ–‡æœ¬çš„é¢œè‰²è®¾ç½®ï¼ˆé€æ˜åº¦é™¤å¤–ï¼‰ï¼š</p><p> Hello â¤ï¸ ğŸ˜º ğŸ‰ â„¢ï¸ ğŸ¥¶ ğŸ˜¡ ğŸ˜ˆ ğŸ¤Ÿ ğŸ¤ŸğŸ» ğŸ¤ŸğŸ¿ There (Black)</p><p>ä½ å¥½â¤ï¸ ğŸ˜º ğŸ‰ â„¢ï¸ ğŸ¥¶ ğŸ˜¡ ğŸ˜ˆ ğŸ¤Ÿ ğŸ¤ŸğŸ» ğŸ¤ŸğŸ¿ é‚£é‡Œï¼ˆé»‘è‰²ï¼‰</p><p> Hello â¤ï¸ ğŸ˜º ğŸ‰ â„¢ï¸ ğŸ¥¶ ğŸ˜¡ ğŸ˜ˆ ğŸ¤Ÿ ğŸ¤ŸğŸ» ğŸ¤ŸğŸ¿ There (Red)</p><p>ä½ å¥½â¤ï¸ ğŸ˜º ğŸ‰ â„¢ï¸ ğŸ¥¶ ğŸ˜¡ ğŸ˜ˆ ğŸ¤Ÿ ğŸ¤ŸğŸ» ğŸ¤ŸğŸ¿ é‚£é‡Œï¼ˆçº¢è‰²ï¼‰</p><p> Hello â¤ï¸ ğŸ˜º ğŸ‰ â„¢ï¸ ğŸ¥¶ ğŸ˜¡ ğŸ˜ˆ ğŸ¤Ÿ ğŸ¤ŸğŸ» ğŸ¤ŸğŸ¿ There (Transparent)</p><p>ä½ å¥½â¤ï¸ ğŸ˜º ğŸ‰ â„¢ï¸ ğŸ¥¶ ğŸ˜¡ ğŸ˜ˆ ğŸ¤Ÿ ğŸ¤ŸğŸ» ğŸ¤ŸğŸ¿ é‚£é‡Œï¼ˆé€æ˜ï¼‰</p><p> Hello â¤ï¸ ğŸ˜º ğŸ‰ â„¢ï¸ ğŸ¥¶ ğŸ˜¡ ğŸ˜ˆ ğŸ¤Ÿ ğŸ¤ŸğŸ» ğŸ¤ŸğŸ¿ There (Bold)</p><p>ä½ å¥½â¤ï¸ ğŸ˜º ğŸ‰ â„¢ï¸ ğŸ¥¶ ğŸ˜¡ ğŸ˜ˆ ğŸ¤Ÿ ğŸ¤ŸğŸ» ğŸ¤ŸğŸ¿ é‚£é‡Œï¼ˆç²—ä½“ï¼‰</p><p> Hello â¤ï¸ ğŸ˜º ğŸ‰ â„¢ï¸ ğŸ¥¶ ğŸ˜¡ ğŸ˜ˆ ğŸ¤Ÿ ğŸ¤ŸğŸ» ğŸ¤ŸğŸ¿ There (Italics)</p><p>ä½ å¥½â¤ï¸ ğŸ˜º ğŸ‰ â„¢ï¸ ğŸ¥¶ ğŸ˜¡ ğŸ˜ˆ ğŸ¤Ÿ ğŸ¤ŸğŸ» ğŸ¤ŸğŸ¿ æœ‰ï¼ˆæ–œä½“ï¼‰</p><p> Emoji generally have their own native colors, and this color can even have semantic meaning, as is the case for skin-tone modifiers. More problematically: they have multiple colors!</p><p>è¡¨æƒ…ç¬¦å·é€šå¸¸æœ‰è‡ªå·±çš„æœ¬è‰²ï¼Œè¿™ç§é¢œè‰²ç”šè‡³å¯ä»¥æœ‰è¯­ä¹‰æ„ä¹‰ï¼Œå°±åƒè‚¤è‰²ä¿®é¥°è¯­ä¸€æ ·ã€‚æ›´éº»çƒ¦çš„æ˜¯ï¼šå®ƒä»¬æœ‰å¤šç§é¢œè‰²ï¼</p><p> As far as I can tell, this wasnâ€™t really a thing before emoji, and so different platforms approach this in different ways. Some provide emoji as a straight-up image (Apple), others provide emoji as  a series of single-color  layers (Microsoft).</p><p>æ®æˆ‘æ‰€çŸ¥ï¼Œè¿™åœ¨è¡¨æƒ…ç¬¦å·å‡ºç°ä¹‹å‰å¹¶ä¸æ˜¯ä¸€ä»¶çœŸæ­£çš„äº‹æƒ…ï¼Œæ‰€ä»¥ä¸åŒçš„å¹³å°ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†è¿™ä»¶äº‹ã€‚ä¸€äº›äººå°†è¡¨æƒ…ç¬¦å·ä½œä¸ºä¸€ä¸ªç›´æ¥çš„å›¾åƒæä¾›ï¼ˆè‹¹æœï¼‰ï¼Œå¦ä¸€äº›äººå°†è¡¨æƒ…ç¬¦å·ä½œä¸ºä¸€ç³»åˆ—å•è‰²å›¾å±‚æä¾›ï¼ˆå¾®è½¯ï¼‰ã€‚</p><p> The latter approach is kinda nice because it integrates well with existing text rendering pipelines by â€œjustâ€ desugarring a glyph into a series of single-color glyphs, which everyone is used to working with.</p><p>åä¸€ç§æ–¹æ³•æœ‰ç‚¹ä¸é”™ï¼Œå› ä¸ºå®ƒé€šè¿‡â€œä»…ä»…â€å°†ä¸€ä¸ªglyphå»ç³–åŒ–ä¸ºä¸€ç³»åˆ—å•è‰²glyphï¼Œä¸ç°æœ‰çš„æ–‡æœ¬æ¸²æŸ“ç®¡é“å¾ˆå¥½åœ°é›†æˆï¼Œæ¯ä¸ªäººéƒ½ä¹ æƒ¯äºä½¿ç”¨è¿™äº›glyphã€‚</p><p> However that means that your style can change  repeatedly while drawing a â€œsingleâ€ glyph. It also means that a â€œsingleâ€ glyph can overlap itself, leading to the transparency issues discussed in an earlier section. And yet, as shown above, browsers  do properly composite the transparency for emoji!</p><p>ç„¶è€Œï¼Œè¿™æ„å‘³ç€æ‚¨çš„æ ·å¼å¯ä»¥åœ¨ç»˜åˆ¶â€œå•ä¸ªâ€å­—å½¢æ—¶åå¤æ›´æ”¹ã€‚è¿™ä¹Ÿæ„å‘³ç€ä¸€ä¸ªâ€œå•ä¸€â€å­—å½¢å¯èƒ½ä¼šé‡å ï¼Œä»è€Œå¯¼è‡´å‰é¢ä¸€èŠ‚ä¸­è®¨è®ºçš„é€æ˜åº¦é—®é¢˜ã€‚ç„¶è€Œï¼Œå¦‚ä¸Šæ‰€ç¤ºï¼Œæµè§ˆå™¨ç¡®å®æ­£ç¡®åœ°åˆæˆäº†è¡¨æƒ…ç¬¦å·çš„é€æ˜åº¦ï¼</p><p>  You already need to detect color glyphs and handle them specially, so itâ€™s easy to take a special compositing path for them</p><p>æ‚¨å·²ç»éœ€è¦æ£€æµ‹é¢œè‰²å›¾ç¤ºç¬¦å¹¶å¯¹å…¶è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œå› æ­¤å¾ˆå®¹æ˜“ä¸ºå®ƒä»¬é‡‡ç”¨ç‰¹æ®Šçš„åˆæˆè·¯å¾„</p><p> Cursive scripts are slightly ugly with bad transparency, but emoji are terrifying/gibberish, so extra work is justified</p><p>è‰ä¹¦æœ‰ç‚¹éš¾çœ‹ï¼Œé€æ˜åº¦ä¸å¥½ï¼Œä½†è¡¨æƒ…ç¬¦å·å¾ˆå¯æ€•/èƒ¡è¨€ä¹±è¯­ï¼Œæ‰€ä»¥é¢å¤–çš„å·¥ä½œæ˜¯åˆç†çš„</p><p>  Oh also, what does it mean to italicize or bold an emoji? Should you ignore those styles? Should you synthesize them? Who knows. ğŸ¤·â€â™€ï¸</p><p>å“¦ï¼Œè¿˜æœ‰ï¼Œå°†è¡¨æƒ…ç¬¦å·æ–œä½“åŒ–æˆ–åŠ ç²—æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿä½ åº”è¯¥å¿½ç•¥è¿™äº›é£æ ¼å—ï¼Ÿä½ åº”è¯¥åˆæˆå®ƒä»¬å—ï¼Ÿè°çŸ¥é“å‘¢ã€‚ğŸ¤·â€â™€ï¸</p><p>  Yeah for whatever reason a bunch of systems secretly increase the font-size for emoji to make them look better.</p><p>æ˜¯çš„ï¼Œä¸ç®¡å‡ºäºä»€ä¹ˆåŸå› ï¼Œå¾ˆå¤šç³»ç»Ÿéƒ½ä¼šç§˜å¯†åœ°å¢åŠ è¡¨æƒ…ç¬¦å·çš„å­—ä½“å¤§å°ï¼Œè®©å®ƒä»¬çœ‹èµ·æ¥æ›´å¥½ã€‚</p><p>  Text is really small and detailed, and itâ€™s really important that itâ€™s easily legible. Sounds like a job for anti-aliasing (AA)! Oh, 480p really is low resolution huh. More AA!!!</p><p>æ–‡æœ¬éå¸¸å°ï¼Œéå¸¸è¯¦ç»†ï¼Œè€Œä¸”éå¸¸é‡è¦çš„æ˜¯å®ƒå¾ˆå®¹æ˜“é˜…è¯»ã€‚å¬èµ·æ¥åƒæ˜¯åèµ°æ ·ï¼ˆAAï¼‰çš„å·¥ä½œï¼å“¦ï¼Œ480pçœŸçš„æ˜¯ä½åˆ†è¾¨ç‡ï¼Œå—¯ã€‚æ›´å¤šAAï¼ï¼ï¼</p><p>    Greyscale-AA is the â€œnaturalâ€ approach to anti-aliasing. The basic idea is to give partially-covered pixels partial-transparency. During composition, this will cause that pixel to be slightly tinted as if it were slightly covered, creating clearer details.</p><p>ç°åº¦AAæ˜¯æ¶ˆé™¤æ··å çš„â€œè‡ªç„¶â€æ–¹æ³•ã€‚å…¶åŸºæœ¬æ€æƒ³æ˜¯ä¸ºéƒ¨åˆ†è¦†ç›–çš„åƒç´ æä¾›éƒ¨åˆ†é€æ˜åº¦ã€‚åœ¨æ„å›¾è¿‡ç¨‹ä¸­ï¼Œè¿™å°†å¯¼è‡´åƒç´ ç¨å¾®ç€è‰²ï¼Œå°±åƒå®ƒè¢«ç¨å¾®è¦†ç›–ä¸€æ ·ï¼Œä»è€Œåˆ›å»ºæ›´æ¸…æ™°çš„ç»†èŠ‚ã€‚</p><p> Itâ€™s greyscale because thatâ€™s the term used for one-dimensional color, like our one-dimensional transparency (otherwise glyphs tend to be a single solid color). Also in the common case of black text on a white background, the anti-aliasing literally shows up as greyness around the edges.</p><p>å®ƒæ˜¯ç°åº¦çš„ï¼Œå› ä¸ºè¿™æ˜¯ç”¨äºä¸€ç»´é¢œè‰²çš„æœ¯è¯­ï¼Œå°±åƒæˆ‘ä»¬çš„ä¸€ç»´é€æ˜åº¦ï¼ˆå¦åˆ™å­—å½¢å¾€å¾€æ˜¯å•ä¸€çš„çº¯è‰²ï¼‰ã€‚åŒæ ·ï¼Œåœ¨ç™½è‰²èƒŒæ™¯ä¸Šçš„é»‘è‰²æ–‡æœ¬çš„å¸¸è§æƒ…å†µä¸‹ï¼ŒæŠ—é”¯é½¿ä¼šåœ¨è¾¹ç¼˜å‘¨å›´æ˜¾ç¤ºä¸ºç°è‰²ã€‚</p><p> Subpixel-AA is a trick that abuses the common way pixels are laid out on desktop monitors. Itâ€™s more complicated than this, so if youâ€™re really interested you should look it up, but hereâ€™s a TL;DR of the high-level concept:</p><p>äºšåƒç´ AAæ˜¯ä¸€ç§æ»¥ç”¨æ¡Œé¢æ˜¾ç¤ºå™¨ä¸Šåƒç´ å¸ƒå±€çš„å¸¸è§æ–¹å¼çš„æŠŠæˆã€‚å®ƒæ¯”è¿™æ›´å¤æ‚ï¼Œæ‰€ä»¥å¦‚æœä½ çœŸçš„æ„Ÿå…´è¶£ï¼Œä½ åº”è¯¥æŸ¥ä¸€ä¸‹ï¼Œä½†è¿™é‡Œæœ‰ä¸€ä¸ªTLï¼›é«˜å±‚æ¦‚å¿µçš„DRï¼š</p><p> Your monitorâ€™s pixels are actually three little columns of RED GREEN BLUE. If you make a pixel red youâ€™re  kinda also making it â€œWHITE BLACK BLACKâ€. Similarly, if you make it blue, youâ€™re making â€œBLACK BLACK WHITEâ€. In other words, by messing around with colors you can  triple your horizontal resolution and get way more details!</p><p>ä½ çš„æ˜¾ç¤ºå™¨çš„åƒç´ å®é™…ä¸Šæ˜¯ä¸‰å°åˆ—çº¢ã€ç»¿ã€è“ã€‚å¦‚æœä½ æŠŠä¸€ä¸ªåƒç´ å˜æˆçº¢è‰²ï¼Œä½ ä¹Ÿä¼šæŠŠå®ƒå˜æˆâ€œé»‘ç™½â€ã€‚åŒæ ·åœ°ï¼Œå¦‚æœä½ æŠŠå®ƒå˜æˆè“è‰²ï¼Œä½ å°±å˜æˆäº†â€œé»‘ç™½â€ã€‚æ¢å¥è¯è¯´ï¼Œé€šè¿‡æ··æ·†é¢œè‰²ï¼Œä½ å¯ä»¥å°†æ°´å¹³åˆ†è¾¨ç‡æé«˜ä¸‰å€ï¼Œè·å¾—æ›´å¤šç»†èŠ‚ï¼</p><p> You might think that this would look super messed up and rainbowy, but in practice it honestly works out really well (some disagree). The human brain likes to see patterns and smooth things out. That said, if you take a screenshot of subpixel-AA text you will  absolutely be able to see the colors if you resize the image, or even look at it on a monitor with a different subpixel layout. This is why screenshots of text often look really weird and bad.</p><p>ä½ å¯èƒ½ä¼šè®¤ä¸ºè¿™çœ‹èµ·æ¥éå¸¸æ··ä¹±ï¼Œåƒå½©è™¹ä¸€æ ·ï¼Œä½†å®é™…ä¸Šæ•ˆæœéå¸¸å¥½ï¼ˆæœ‰äº›äººä¸åŒæ„ï¼‰ã€‚äººç±»çš„å¤§è„‘å–œæ¬¢çœ‹åˆ°æ¨¡å¼å¹¶ä½¿äº‹æƒ…å˜å¾—å¹³æ»‘ã€‚è¿™å°±æ˜¯è¯´ï¼Œå¦‚æœä½ æ‹æ‘„ä¸€å¼ äºšåƒç´ AAæ–‡æœ¬çš„å±å¹•æˆªå›¾ï¼Œå¦‚æœä½ è°ƒæ•´å›¾åƒå¤§å°ï¼Œæˆ–è€…ç”šè‡³åœ¨ä¸åŒäºšåƒç´ å¸ƒå±€çš„æ˜¾ç¤ºå™¨ä¸Šè§‚çœ‹ï¼Œä½ ç»å¯¹èƒ½å¤Ÿçœ‹åˆ°é¢œè‰²ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ–‡æœ¬æˆªå›¾çœ‹èµ·æ¥éå¸¸å¥‡æ€ªå’Œç³Ÿç³•çš„åŸå› ã€‚</p><p> (As a total aside, the fact that this works also means that the color of an icon can accidentally change its perceived size and position, which is really annoying.)</p><p>ï¼ˆæ€»çš„æ¥è¯´ï¼Œè¿™ä¹Ÿæ„å‘³ç€å›¾æ ‡çš„é¢œè‰²å¯èƒ½ä¼šæ„å¤–åœ°æ”¹å˜å…¶æ„ŸçŸ¥çš„å¤§å°å’Œä½ç½®ï¼Œè¿™çœŸçš„å¾ˆçƒ¦äººã€‚ï¼‰</p><p> So subpixel-AA is a really neat hack that can significantly improve text legibility, great! But, sadly, itâ€™s also a huge pain in the neck!</p><p>æ‰€ä»¥äºšåƒç´ AAæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é»‘å®¢ï¼Œå¯ä»¥æ˜¾è‘—æé«˜æ–‡æœ¬çš„æ˜“è¯»æ€§ï¼Œå¤ªæ£’äº†ï¼ä½†æ˜¯ï¼Œå¯æ‚²çš„æ˜¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå·¨å¤§çš„é¢ˆéƒ¨ç–¼ç—›ï¼</p><p> Note that regardless of the AA system you use, you can also have  subpixel glyph offsets. Although you always want your rasterized glyphs to be snapped to full pixels, the rasterization itself is for a specific subpixel offset (a value between 0 and 1).</p><p>è¯·æ³¨æ„ï¼Œæ— è®ºä½¿ç”¨å“ªç§AAç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨äºšåƒç´ è½®å»“åç§»ã€‚å°½ç®¡æ‚¨æ€»æ˜¯å¸Œæœ›å…‰æ …åŒ–çš„å›¾ç¤ºç¬¦æ•æ‰åˆ°å®Œæ•´åƒç´ ï¼Œä½†å…‰æ …åŒ–æœ¬èº«é€‚ç”¨äºç‰¹å®šçš„å­åƒç´ åç§»ï¼ˆ0åˆ°1ä¹‹é—´çš„å€¼ï¼‰ã€‚</p><p>  If its subpixel offset was 0.5, then its rasterization would be two 50% grey pixels</p><p>å¦‚æœå®ƒçš„äºšåƒç´ åç§»ä¸º0.5ï¼Œé‚£ä¹ˆå®ƒçš„å…‰æ …åŒ–å°†æ˜¯ä¸¤ä¸ª50%çš„ç°è‰²åƒç´ </p><p>  Rasterizing glyphs is surprisingly expensive, so you really want to cache it in an atlas. But how do you cache glyph rasterizations when youâ€™re using subpixel-offsets? Each offset is its own unique rasterization, so youâ€™re incredibly unlikely to get cache hits like that!</p><p>æ …æ ¼åŒ–å›¾ç¤ºç¬¦çš„æˆæœ¬æƒŠäººåœ°é«˜ï¼Œæ‰€ä»¥æ‚¨çœŸçš„å¸Œæœ›å°†å…¶ç¼“å­˜åœ¨atlasä¸­ã€‚ä½†åœ¨ä½¿ç”¨äºšåƒç´ åç§»æ—¶ï¼Œå¦‚ä½•ç¼“å­˜è½®å»“å…‰æ …åŒ–ï¼Ÿæ¯ä¸ªåç§»é‡éƒ½æœ‰è‡ªå·±ç‹¬ç‰¹çš„å…‰æ …åŒ–ï¼Œæ‰€ä»¥ä½ ä¸å¤ªå¯èƒ½å¾—åˆ°è¿™æ ·çš„ç¼“å­˜å‘½ä¸­ç‡ï¼</p><p> Quality and performance must be balanced here, and that can be done by snapping your subpixel offsets. For english text, a reasonable balance is to have no vertical subpixel precision while snapping the horizontal subpixel offset to a quarter-integer. This leaves you with only 4 subpixel-positions, which is still a big improvement in quality while allowing for a reasonable amount of caching.</p><p>è´¨é‡å’Œæ€§èƒ½å¿…é¡»å¹³è¡¡ï¼Œè¿™å¯ä»¥é€šè¿‡æ•æ‰äºšåƒç´ åç§»æ¥å®ç°ã€‚å¯¹äºè‹±æ–‡æ–‡æœ¬ï¼Œä¸€ä¸ªåˆç†çš„å¹³è¡¡æ˜¯åœ¨å°†æ°´å¹³å­åƒç´ åç§»æ•æ‰ä¸ºå››åˆ†ä¹‹ä¸€æ•´æ•°æ—¶æ²¡æœ‰å‚ç›´å­åƒç´ ç²¾åº¦ã€‚è¿™åªå‰©ä¸‹4ä¸ªäºšåƒç´ ä½ç½®ï¼Œè¿™ä»ç„¶æ˜¯è´¨é‡ä¸Šçš„ä¸€å¤§æ”¹è¿›ï¼ŒåŒæ—¶å…è®¸åˆç†çš„ç¼“å­˜é‡ã€‚</p><p>  One nice thing about greyscale-AA is that you can play a bit fast-and-loose with it, and it will degrade gracefully. For instance, if you transform a texture with text on it (scaling, rotating, or translating), it might look a bit blurry but it will look basically fine.</p><p>greyscale AAçš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯ï¼Œä½ å¯ä»¥ç©å¾—å¿«ä¸€ç‚¹ï¼Œæ”¾æ¾ä¸€ç‚¹ï¼Œå®ƒä¼šä¼˜é›…åœ°é€€åŒ–ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨çº¹ç†ä¸Šå˜æ¢æ–‡æœ¬ï¼ˆç¼©æ”¾ã€æ—‹è½¬æˆ–å¹³ç§»ï¼‰ï¼Œå®ƒå¯èƒ½çœ‹èµ·æ¥æœ‰ç‚¹æ¨¡ç³Šï¼Œä½†åŸºæœ¬ä¸Šçœ‹èµ·æ¥å¾ˆå¥½ã€‚</p><p> If you do the same thing with subpixel-AA, it will look terrible. The entire idea behind subpixel-AA is that you are abusing how the pixels are laid out in a display. If the pixels of the display donâ€™t line up with the pixels of your texture, the red and blue edges will be clearly visible!</p><p>å¦‚æœä½ ç”¨äºšåƒç´ AAåšåŒæ ·çš„äº‹æƒ…ï¼Œå®ƒçœ‹èµ·æ¥ä¼šå¾ˆç³Ÿç³•ã€‚äºšåƒç´ AAèƒŒåçš„æ•´ä¸ªæƒ³æ³•æ˜¯ï¼Œä½ åœ¨æ»¥ç”¨æ˜¾ç¤ºå™¨ä¸­åƒç´ çš„å¸ƒå±€æ–¹å¼ã€‚å¦‚æœæ˜¾ç¤ºçš„åƒç´ ä¸çº¹ç†çš„åƒç´ ä¸ä¸€è‡´ï¼Œåˆ™çº¢è‰²å’Œè“è‰²è¾¹ç¼˜å°†æ¸…æ™°å¯è§ï¼</p><p> One might think that the â€œfixâ€ for this is to just rerasterize the glyphs in their new location. And indeed, if the transform is static, this can work. But if the transform is an  animation this will actually look  even worse. This is actually a really common browser bug: if we  ever fail to detect that an animation is happening to some text, the characters will  jiggle as each glyph bounces around between different subpixel snappings and hints on each frame.</p><p>æœ‰äººå¯èƒ½ä¼šè®¤ä¸ºï¼Œè§£å†³è¿™ä¸ªé—®é¢˜çš„â€œåŠæ³•â€æ˜¯åœ¨æ–°ä½ç½®é‡æ–°æ ‡è®°ç¬¦å·ã€‚äº‹å®ä¸Šï¼Œå¦‚æœè½¬æ¢æ˜¯é™æ€çš„ï¼Œè¿™æ˜¯å¯è¡Œçš„ã€‚ä½†å¦‚æœå˜æ¢æ˜¯ä¸€ä¸ªåŠ¨ç”»ï¼Œè¿™å®é™…ä¸Šçœ‹èµ·æ¥ä¼šæ›´ç³Ÿã€‚è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„æµè§ˆå™¨é”™è¯¯ï¼šå¦‚æœæˆ‘ä»¬æ— æ³•æ£€æµ‹åˆ°æŸä¸ªæ–‡æœ¬æ­£åœ¨å‘ç”ŸåŠ¨ç”»ï¼Œå½“æ¯ä¸ªå­—å½¢åœ¨ä¸åŒçš„å­åƒç´ æ•æ‰å’Œæ¯å¸§æç¤ºä¹‹é—´æ¥å›è·³è·ƒæ—¶ï¼Œè§’è‰²å°†æŠ–åŠ¨ã€‚</p><p> As a result, browsers contain several heuristics to detect things which might be animations so that they can force-disable subpixel-AA for that part of the page (and ideally even subpixel-positioning). This can be pretty hard to do reliably, because arbitrarily complex JS can drive an animation without giving any clear â€œheads upâ€ to the browser.</p><p>å› æ­¤ï¼Œæµè§ˆå™¨åŒ…å«äº†å‡ ç§è¯•æ¢æ³•æ¥æ£€æµ‹å¯èƒ½æ˜¯åŠ¨ç”»çš„ä¸œè¥¿ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥å¼ºåˆ¶ç¦ç”¨é¡µé¢è¯¥éƒ¨åˆ†çš„äºšåƒç´ AAï¼ˆç†æƒ³æƒ…å†µä¸‹ç”šè‡³äºšåƒç´ å®šä½ï¼‰ã€‚è¿™å¯èƒ½å¾ˆéš¾åšåˆ°å¯é ï¼Œå› ä¸ºä»»æ„å¤æ‚çš„JSå¯ä»¥é©±åŠ¨åŠ¨ç”»ï¼Œè€Œä¸ç»™æµè§ˆå™¨ä»»ä½•æ¸…æ™°çš„â€œæç¤ºâ€ã€‚</p><p> Furthermore, if partial transparency is involved, subpixel-AA is also problematic. Basically, weâ€™re tweaking our R, G, and B channels to encode 3 transparency values (one for each subpixel), but the text itself also has a color, and the thing the text is on does to, so information easily gets lost.</p><p>æ­¤å¤–ï¼Œå¦‚æœæ¶‰åŠéƒ¨åˆ†é€æ˜åº¦ï¼Œäºšåƒç´ AAä¹Ÿæœ‰é—®é¢˜ã€‚åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬æ­£åœ¨è°ƒæ•´Rã€Gå’ŒBé€šé“ï¼Œä»¥ç¼–ç 3ä¸ªé€æ˜åº¦å€¼ï¼ˆæ¯ä¸ªå­åƒç´ ä¸€ä¸ªï¼‰ï¼Œä½†æ–‡æœ¬æœ¬èº«ä¹Ÿæœ‰ä¸€ç§é¢œè‰²ï¼Œå¹¶ä¸”æ–‡æœ¬ä¸Šçš„å†…å®¹ä¼šæ”¹å˜ï¼Œå› æ­¤ä¿¡æ¯å¾ˆå®¹æ˜“ä¸¢å¤±ã€‚</p><p> When using greyscale-AA we have a dedicated alpha channel so nothing is ever lost. As such, browsers tend to use greyscale-AA when transparency is involved.</p><p>å½“ä½¿ç”¨greyscale AAæ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªä¸“ç”¨çš„alphaé€šé“ï¼Œå› æ­¤ä¸ä¼šä¸¢å¤±ä»»ä½•ä¸œè¥¿ã€‚å› æ­¤ï¼Œå½“æ¶‰åŠé€æ˜åº¦æ—¶ï¼Œæµè§ˆå™¨å€¾å‘äºä½¿ç”¨ç°åº¦AAã€‚</p><p> â€¦Except Firefox. Yet again, this is a weird place where someone working on Firefox got really enthusiastic and did something complicated: Component Alpha. It turns out you can in fact properly composite subpixel-AA text, but it involves effectively having 3 extra channels dedicated to the transparency of your R, G, and B channels. Unsurprisingly, this doubles the memory footprint of text thatâ€™s composited in this way.</p><p>é™¤äº†Firefoxã€‚å†ä¸€æ¬¡ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„åœ°æ–¹ï¼Œæœ‰äººåœ¨Firefoxä¸Šå·¥ä½œéå¸¸çƒ­æƒ…ï¼Œåšäº†ä¸€äº›å¤æ‚çš„äº‹æƒ…ï¼šç»„ä»¶Alphaã€‚äº‹å®è¯æ˜ï¼Œä½ å®é™…ä¸Šå¯ä»¥æ­£ç¡®åœ°åˆæˆäºšåƒç´ AAæ–‡æœ¬ï¼Œä½†å®ƒå®é™…ä¸Šéœ€è¦æœ‰3ä¸ªé¢å¤–çš„é€šé“ï¼Œä¸“é—¨ç”¨äºRã€Gå’ŒBé€šé“çš„é€æ˜åº¦ã€‚ä¸å‡ºæ‰€æ–™ï¼Œè¿™ä¼šä½¿ä»¥è¿™ç§æ–¹å¼åˆæˆçš„æ–‡æœ¬çš„å†…å­˜å ç”¨å¢åŠ ä¸€å€ã€‚</p><p>  On newer versions of macos, subpixel-aa of text is disabled at the OS level by default</p><p>åœ¨è¾ƒæ–°ç‰ˆæœ¬çš„macosä¸Šï¼Œé»˜è®¤æƒ…å†µä¸‹åœ¨æ“ä½œç³»ç»Ÿçº§åˆ«ç¦ç”¨æ–‡æœ¬çš„å­åƒç´ aa</p><p> Chrome seems to be disabling subpixel-aa more aggressively (not sure what the exact policy is)</p><p>Chromeä¼¼ä¹æ›´ç§¯æåœ°ç¦ç”¨äº†äºšåƒç´ aaï¼ˆä¸ç¡®å®šå…·ä½“çš„ç­–ç•¥æ˜¯ä»€ä¹ˆï¼‰</p><p> Firefoxâ€™s new graphics backend (webrender) has abandoned Component Alpha for the sake of simplicity</p><p>Firefoxçš„æ–°å›¾å½¢åç«¯ï¼ˆwebrenderï¼‰ä¸ºäº†ç®€å•èµ·è§æ”¾å¼ƒäº†Alphaç»„ä»¶</p><p>  This partâ€™s just a grab bag of little things that donâ€™t need merit much discussion.</p><p>è¿™éƒ¨åˆ†åªæ˜¯ä¸€äº›ä¸éœ€è¦å¤ªå¤šè®¨è®ºçš„å°ä¸œè¥¿ã€‚</p><p>  God this blows. These fonts are mostly provided by Adobe, because they got really into SVG a while ago. Sometimes you can just ignore the SVG parts (I believe the Source Code Pro font technically contains some SVG glyphs, but in practice they arenâ€™t actually used by websites), but in general you need to implement SVG support to draw All The Fonts.</p><p>å¤©å‘ï¼Œè¿™å¤ªæ£’äº†ã€‚è¿™äº›å­—ä½“ä¸»è¦ç”±Adobeæä¾›ï¼Œå› ä¸ºå®ƒä»¬ä¸ä¹…å‰å°±çœŸæ­£è¿›å…¥äº†SVGã€‚æœ‰æ—¶å€™ä½ å¯ä»¥å¿½ç•¥SVGéƒ¨åˆ†ï¼ˆæˆ‘ç›¸ä¿¡æºä»£ç Proå­—ä½“åœ¨æŠ€æœ¯ä¸ŠåŒ…å«ä¸€äº›SVGå­—å½¢ï¼Œä½†å®é™…ä¸Šå®ƒä»¬å¹¶æ²¡æœ‰è¢«ç½‘ç«™ä½¿ç”¨ï¼‰ï¼Œä½†é€šå¸¸ä½ éœ€è¦å®ç°SVGæ”¯æŒæ¥ç»˜åˆ¶æ‰€æœ‰å­—ä½“ã€‚</p><p> Also have you heard of  Animated SVG Fonts? No? Good. I think theyâ€™re broken/unimplemented everywhere now. (Firefox randomly supported it for a while because of some enthusiastic developer.)</p><p>ä½ å¬è¯´è¿‡SVGåŠ¨ç”»å­—ä½“å—ï¼Ÿä¸å¥½çš„æˆ‘è®¤ä¸ºä»–ä»¬ç°åœ¨åˆ°å¤„éƒ½å¤±è´¥äº†ã€‚ï¼ˆç”±äºä¸€äº›çƒ­å¿ƒçš„å¼€å‘è€…ï¼ŒFirefoxéšæœºæ”¯æŒäº†å®ƒä¸€æ®µæ—¶é—´ã€‚ï¼‰</p><p>  If you naively respect a userâ€™s request for a very large font (or very large zoom level), you will run into extreme memory management problems with the size of your glyph atlas, as each character may be bigger than the entire screen. There are a few ways to handle this:</p><p>å¦‚æœä½ å¤©çœŸåœ°å°Šé‡ç”¨æˆ·å¯¹è¶…å¤§å­—ä½“ï¼ˆæˆ–è¶…å¤§ç¼©æ”¾çº§åˆ«ï¼‰çš„è¦æ±‚ï¼Œä½ ä¼šåœ¨å­—å½¢å›¾è°±çš„å¤§å°ä¸Šé‡åˆ°æç«¯çš„å†…å­˜ç®¡ç†é—®é¢˜ï¼Œå› ä¸ºæ¯ä¸ªå­—ç¬¦éƒ½å¯èƒ½æ¯”æ•´ä¸ªå±å¹•å¤§ã€‚æœ‰å‡ ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p><p> Rasterize the glyph at a smaller size, and upscale during composition (easy, produces blurry edges)</p><p>åœ¨æ„å›¾è¿‡ç¨‹ä¸­ä»¥è¾ƒå°çš„å°ºå¯¸å’Œè¾ƒé«˜çš„æ¯”ä¾‹æ …æ ¼åŒ–è½®å»“ï¼ˆç®€å•ï¼Œäº§ç”Ÿæ¨¡ç³Šçš„è¾¹ç¼˜ï¼‰</p><p>  Itâ€™s pretty common for folks to know that the primary direction of text can be left-to-right (english), right-to-left (arabic), or top-to-bottom (japanese).</p><p>äººä»¬é€šå¸¸çŸ¥é“æ–‡æœ¬çš„ä¸»è¦æ–¹å‘å¯ä»¥æ˜¯ä»å·¦åˆ°å³ï¼ˆè‹±è¯­ï¼‰ã€ä»å³åˆ°å·¦ï¼ˆé˜¿æ‹‰ä¼¯è¯­ï¼‰æˆ–ä»ä¸Šåˆ°ä¸‹ï¼ˆæ—¥è¯­ï¼‰ã€‚</p><p>     On a desktop, if you drag your mouse across that text to select it, you may notice that the selection becomes discontinuous and jumpy in the middle. This is because weâ€™re mixing left-to-right and right-to-left text in the same line, which absolutely happens all the time.</p><p>åœ¨æ¡Œé¢ä¸Šï¼Œå¦‚æœå°†é¼ æ ‡æ‹–åŠ¨åˆ°è¯¥æ–‡æœ¬ä¸Šä»¥é€‰æ‹©å®ƒï¼Œæ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°è¯¥é€‰æ‹©åœ¨ä¸­é—´å˜å¾—ä¸è¿ç»­å’Œè·³è·ƒã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨åŒä¸€è¡Œä¸­æ··åˆäº†ä»å·¦åˆ°å³å’Œä»å³åˆ°å·¦çš„æ–‡æœ¬ï¼Œè¿™ç»å¯¹æ˜¯ç»å¸¸å‘ç”Ÿçš„ã€‚</p><p> At first dragging right  increases the selection, but then it  decreases it until it suddenly starts increasing again. This is in fact totally correct and desirable: the selection is just remaining contiguous  in the actual underlying string. This way you can correctly copy a fragment of text that spans the transition.</p><p>èµ·åˆï¼Œå‘å³æ‹–åŠ¨ä¼šå¢åŠ é€‰æ‹©ï¼Œä½†éšåä¼šå‡å°‘é€‰æ‹©ï¼Œç›´åˆ°å®ƒçªç„¶å¼€å§‹å†æ¬¡å¢åŠ ã€‚è¿™å®é™…ä¸Šæ˜¯å®Œå…¨æ­£ç¡®å’Œå¯å–çš„ï¼šé€‰æ‹©åªæ˜¯åœ¨å®é™…çš„åº•å±‚å­—ç¬¦ä¸²ä¸­ä¿æŒè¿ç»­ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ‚¨å¯ä»¥æ­£ç¡®å¤åˆ¶è·¨è¶Šè½¬æ¢çš„æ–‡æœ¬ç‰‡æ®µã€‚</p><p> So you need to deal with that in your selection codeâ€™s hit-detection. Also you need to deal with that in your line breaking algorithm during layout.</p><p>å› æ­¤ï¼Œæ‚¨éœ€è¦åœ¨é€‰æ‹©ä»£ç çš„å‘½ä¸­æ£€æµ‹ä¸­å¤„ç†è¿™ä¸€ç‚¹ã€‚åœ¨å¸ƒå±€è¿‡ç¨‹ä¸­ï¼Œä½ è¿˜éœ€è¦åœ¨æ¢è¡Œç®—æ³•ä¸­å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚</p><p>   oh hey what? oh  Ù„Ø§ Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ no ä½ å¥½ 1234ä½ å¥½</p><p>ä»€ä¹ˆï¼Ÿå“¦ï¼Œä¸ä½ å¥½ 1234ä½ å¥½</p><p>    When characters are missing from fonts, itâ€™s nice to be able to communicate to the user that this happened. This is the â€œtofuâ€ glyph. Now, you can just draw a blank tofu (a rectangle) and leave it at that, but if you want to be helpful you can write out the value of the missing character so it can be debugged more easily.</p><p>å½“å­—ä½“ä¸­ç¼ºå°‘å­—ç¬¦æ—¶ï¼Œèƒ½å¤Ÿå‘ç”¨æˆ·ä¼ è¾¾è¿™ä¸€æƒ…å†µæ˜¯å¾ˆå¥½çš„ã€‚è¿™æ˜¯â€œè±†è…â€å­—å½¢ã€‚ç°åœ¨ï¼Œä½ å¯ä»¥åªç”»ä¸€ä¸ªç©ºç™½çš„è±†è…ï¼ˆä¸€ä¸ªçŸ©å½¢ï¼‰å¹¶ä¿ç•™å®ƒï¼Œä½†æ˜¯å¦‚æœä½ æƒ³æœ‰æ‰€å¸®åŠ©ï¼Œä½ å¯ä»¥å†™å‡ºç¼ºå°‘çš„å­—ç¬¦çš„å€¼ï¼Œè¿™æ ·å°±å¯ä»¥æ›´å®¹æ˜“åœ°è°ƒè¯•å®ƒã€‚</p><p> But, wait, weâ€™re using text to explain that we canâ€™t draw text? Hmm.</p><p>ä½†æ˜¯ï¼Œç­‰ç­‰ï¼Œæˆ‘ä»¬ç”¨æ–‡å­—æ¥è§£é‡Šæˆ‘ä»¬ä¸èƒ½ç”»æ–‡å­—ï¼Ÿéšé©¬å°”å¯å¤«æ¨¡å‹ã€‚</p><p> You could appeal to an assumption that the system must have a basic font that can draw 0-9 and A-F, but for those who expect to truly Destroy Their Tools With Their Tools you can do what Firefox does: the microfont!</p><p>ä½ å¯ä»¥å‡è®¾ç³»ç»Ÿå¿…é¡»æœ‰ä¸€ä¸ªåŸºæœ¬çš„å­—ä½“ï¼Œå¯ä»¥ç”»0-9å’Œa-Fï¼Œä½†æ˜¯å¯¹äºé‚£äº›å¸Œæœ›ç”¨å·¥å…·çœŸæ­£ç ´åå·¥å…·çš„äººæ¥è¯´ï¼Œä½ å¯ä»¥åšFirefoxåšçš„äº‹æƒ…ï¼šmicrofontï¼</p><p> Inside Firefox thereâ€™s a little hardcoded array describing one-bit pixel art of a tiny font atlas for exactly those 16 characters. So when drawing tofu, it can blit those glyphs out without worrying about fonts.</p><p>Firefoxå†…éƒ¨æœ‰ä¸€ä¸ªå°çš„ç¡¬ç¼–ç æ•°ç»„ï¼Œæè¿°äº†ä¸€ä¸ªå°å­—ä½“å›¾é›†çš„ä¸€ä½åƒç´ è‰ºæœ¯ï¼Œæ­£å¥½å¯¹åº”è¿™16ä¸ªå­—ç¬¦ã€‚æ‰€ä»¥åœ¨ç”»è±†è…çš„æ—¶å€™ï¼Œå®ƒå¯ä»¥å¿«é€Ÿåœ°ç”»å‡ºé‚£äº›å­—å½¢ï¼Œè€Œä¸ç”¨æ‹…å¿ƒå­—ä½“ã€‚</p><p>   For high-quality fonts, stylings like  italics and  bold are provided natively, as there isnâ€™t a simple algorithmic way to do those effects nicely.</p><p>å¯¹äºé«˜è´¨é‡çš„å­—ä½“ï¼Œåƒæ–œä½“å’Œç²—ä½“è¿™æ ·çš„æ ·å¼æ˜¯æœ¬æœºæä¾›çš„ï¼Œå› ä¸ºæ²¡æœ‰ç®€å•çš„ç®—æ³•å¯ä»¥å¾ˆå¥½åœ°å®ç°è¿™äº›æ•ˆæœã€‚</p><p> Except some fonts donâ€™t provide those stylings, and so you need a simple algorithmic way to do those effects.</p><p>é™¤äº†ä¸€äº›å­—ä½“ä¸æä¾›è¿™äº›æ ·å¼ï¼Œæ‰€ä»¥ä½ éœ€è¦ä¸€ä¸ªç®€å•çš„ç®—æ³•æ¥å®ç°è¿™äº›æ•ˆæœã€‚</p><p> Exactly how you detect and handle all of this is pretty system-specific, hairy, and outside my area of expertise, so I canâ€™t really explain it well. I would just be digging through  Webrenderâ€™s font code.</p><p>å‡†ç¡®åœ°è¯´ï¼Œä½ æ˜¯å¦‚ä½•æ£€æµ‹å’Œå¤„ç†è¿™ä¸€åˆ‡çš„ï¼Œè¿™æ˜¯éå¸¸å…·ä½“çš„ç³»ç»Ÿï¼Œéå¸¸å¤æ‚ï¼Œè¶…å‡ºäº†æˆ‘çš„ä¸“ä¸šé¢†åŸŸï¼Œæ‰€ä»¥æˆ‘ä¸èƒ½å¾ˆå¥½åœ°è§£é‡Šå®ƒã€‚æˆ‘åªæ˜¯åœ¨æµè§ˆWebrenderçš„å­—ä½“ä»£ç ã€‚</p><p> Anyway, no matter what you do, you need a  synthetic fallback. Thankfully, the implementations are actually pretty straightforward:</p><p>ä¸ç®¡æ€æ ·ï¼Œä¸ç®¡ä½ åšä»€ä¹ˆï¼Œä½ éƒ½éœ€è¦ä¸€ä¸ªç»¼åˆçš„é€€è·¯ã€‚è°¢å¤©è°¢åœ°ï¼Œè¿™äº›å®ç°å®é™…ä¸Šéå¸¸ç®€å•ï¼š</p><p>   Honestly, these approaches do a pretty decent job! But users might notice that things seem â€œwrongâ€ and you can do better if you put in the work.</p><p>è€å®è¯´ï¼Œè¿™äº›æ–¹æ³•åšå¾—ç›¸å½“ä¸é”™ï¼ä½†ç”¨æˆ·å¯èƒ½ä¼šæ³¨æ„åˆ°äº‹æƒ…ä¼¼ä¹â€œä¸å¯¹â€ï¼Œå¦‚æœä½ æŠ•å…¥å·¥ä½œï¼Œä½ å¯ä»¥åšå¾—æ›´å¥½ã€‚</p><p>  Platform-specific bugs, optimizations, and quirks have thrived for long enough to become aesthetics. So even if you adamantly believe that certain things are ideal or important, thereâ€™s always going to be a huge group of users with different preferences. A robust text rendering system supports those different preferences (while picking reasonable defaults).</p><p>ç‰¹å®šäºå¹³å°çš„bugã€ä¼˜åŒ–å’Œæ€ªç™–å·²ç»å‘å±•äº†è¶³å¤Ÿé•¿çš„æ—¶é—´ï¼Œæˆä¸ºäº†ç¾å­¦ã€‚æ‰€ä»¥ï¼Œå³ä½¿ä½ åšä¿¡æŸäº›ä¸œè¥¿æ˜¯ç†æƒ³çš„æˆ–é‡è¦çš„ï¼Œä¹Ÿæ€»ä¼šæœ‰ä¸€å¤§ç¾¤ç”¨æˆ·æœ‰ä¸åŒçš„åå¥½ã€‚å¥å£®çš„æ–‡æœ¬å‘ˆç°ç³»ç»Ÿæ”¯æŒè¿™äº›ä¸åŒçš„é¦–é€‰é¡¹ï¼ˆåŒæ—¶é€‰æ‹©åˆç†çš„é»˜è®¤å€¼ï¼‰ã€‚</p><p> You should support system configurations, font-specific configurations, application-specific configurations, and text-run-specific configurations. You should also try to</p><p>æ‚¨åº”è¯¥æ”¯æŒç³»ç»Ÿé…ç½®ã€å­—ä½“ç‰¹å®šé…ç½®ã€åº”ç”¨ç¨‹åºç‰¹å®šé…ç½®å’Œæ–‡æœ¬è¿è¡Œç‰¹å®šé…ç½®ã€‚ä½ ä¹Ÿåº”è¯¥è¯•ç€</p><p>......</p><p>......</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/å‘ˆç°/">#å‘ˆç°</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/rendering/">#rendering</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/æ–‡æœ¬/">#æ–‡æœ¬</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è°·æ­Œ/">#è°·æ­Œ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>