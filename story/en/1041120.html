<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>jqå®ç”¨å…¥é—¨ï¼ˆåŠæ›´å¤šï¼‰ A Practical Introduction to jq (and more)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">A Practical Introduction to jq (and more)<br/>jqå®ç”¨å…¥é—¨ï¼ˆåŠæ›´å¤šï¼‰ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-22 04:44:10</div><div class="page_narrow text-break page_content"><p>Published December 21, 2020 jq is a command line tool for parsing and modifying JSON. It is useful for extracting relevant bits of information from tools that output JSON, or REST APIs that return JSON. Mac users can install  jq using homebrew ( brew install jq); see  here for more install options.</p><p>2020å¹´12æœˆ21æ—¥å‘å¸ƒjqæ˜¯ç”¨äºè§£æå’Œä¿®æ”¹JSONçš„å‘½ä»¤è¡Œå·¥å…·ã€‚è¿™å¯¹äºä»è¾“å‡ºJSONçš„å·¥å…·æˆ–è¿”å›JSONçš„REST APIä¸­æå–ç›¸å…³çš„ä¿¡æ¯ä½å¾ˆæœ‰ç”¨ã€‚ Macç”¨æˆ·å¯ä»¥ä½¿ç”¨è‡ªåˆ¶è½¯ä»¶æ¥å®‰è£…jqï¼ˆbrew install jqï¼‰ï¼›æœ‰å…³æ›´å¤šå®‰è£…é€‰é¡¹ï¼Œè¯·å‚è§æ­¤å¤„ã€‚</p><p> In this post we&#39;ll examine a couple &#34;real world&#34; examples of using  jq, but let&#39;s start with...</p><p> åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶ä¸€å¯¹å¤«å¦‡çš„çœŸå®ä¸–ç•Œã€‚ä½¿ç”¨jqçš„ç¤ºä¾‹ï¼Œä½†è®©æˆ‘ä»¬ä»...å¼€å§‹</p><p>     {  :  &#34;duchess&#34;,  :  &#34;Toronto&#34;,  : [ {  :  &#34;x&#34;,  :  10 }, {  :  &#34;y&#34;,  :  15 } ]}</p><p>     {ï¼šï¼†ï¼ƒ34; duchessï¼†ï¼ƒ34 ;,ï¼šï¼†ï¼ƒ34; Torontoï¼†ï¼ƒ34 ;,ï¼šï¼š[{ï¼šï¼†ï¼ƒ34; xï¼†ï¼ƒ34 ;,ï¼š10}ï¼Œ{ï¼šï¼†ï¼ƒ34; yï¼†ï¼ƒ34 ;,ï¼š 15}]}</p><p> I like this pretty-printing/formatting capability so much, I have an alias that formats JSON I&#39;ve copied (in my OS &#34;clipboard&#34;) &amp; puts it back in my clipboard:</p><p> æˆ‘éå¸¸å–œæ¬¢è¿™ç§æ¼‚äº®çš„æ‰“å°/æ ¼å¼åŒ–åŠŸèƒ½ï¼Œæˆ‘æœ‰ä¸€ä¸ªåˆ«åå¯ä»¥æ ¼å¼åŒ–å·²å¤åˆ¶çš„JSONï¼ˆåœ¨æˆ‘çš„OSï¼†ï¼ƒ34; clipboardï¼†ï¼ƒ34;ä¸­ï¼‰å¹¶ä¸”æŠŠå®ƒæ”¾å›æˆ‘çš„å‰ªè´´æ¿ä¸­ï¼š</p><p>  The  &#39;.&#39; in the  jq &#39;.&#39; command above is the simplest jq &#34;filter.&#34; The dot takes the input JSON and outputs it as is. You can read more about filters  here, but the bare minimum to know is that  .keyname will filter the result to a property matching that key, and  [index] will match an array value at that index:</p><p>  ï¼†ï¼ƒ39;ã€‚ï¼†ï¼ƒ39;åœ¨jqï¼†ï¼ƒ39;ã€‚ï¼†ï¼ƒ39;ä¸­ä¸Šé¢çš„å‘½ä»¤æ˜¯æœ€ç®€å•çš„jqï¼†ï¼ƒ34; filterã€‚è¯¥ç‚¹æ¥å—è¾“å…¥çš„JSONå¹¶æŒ‰åŸæ ·è¾“å‡ºã€‚æ‚¨å¯ä»¥åœ¨æ­¤å¤„é˜…è¯»æœ‰å…³è¿‡æ»¤å™¨çš„æ›´å¤šä¿¡æ¯ï¼Œä½†æœ€åŸºæœ¬çš„äº†è§£æ˜¯.keynameä¼šå°†ç»“æœè¿‡æ»¤åˆ°ä¸è¯¥é”®åŒ¹é…çš„å±æ€§ï¼Œè€Œ[index]å°†ä¸è¯¥ç´¢å¼•å¤„çš„æ•°ç»„å€¼åŒ¹é…ï¼š</p><p> $  echo  $USERX | jq  &#39;.name&#39; &#34;duchess&#34;$  echo  $USERX | jq  &#39;.orders[0]&#39;{  &#34;id&#34;:  &#34;x&#34;,  &#34;qty&#34;: 10}</p><p> $ echo $ USERX | jqï¼†ï¼ƒ39; .nameï¼†ï¼ƒ39; ï¼†ï¼ƒ34; duchessï¼†ï¼ƒ34; $ echo $ USERX | jqï¼†ï¼ƒ39; .orders [0]ï¼†ï¼ƒ39; {ï¼†ï¼ƒ34; idï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; xï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; qtyï¼†ï¼ƒ34 ;: 10}</p><p>   Filtering output by value is also handy! Here we use  | to output the result of one filter into the input of another filter and  select(.qty&gt;10) to select only orders with  qty value greater than 10:</p><p>   æŒ‰å€¼è¿‡æ»¤è¾“å‡ºä¹Ÿå¾ˆæ–¹ä¾¿ï¼åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨|å°†ä¸€ä¸ªè¿‡æ»¤å™¨çš„ç»“æœè¾“å‡ºåˆ°å¦ä¸€ä¸ªè¿‡æ»¤å™¨çš„è¾“å…¥ä¸­ï¼Œç„¶åé€‰æ‹©ï¼ˆ.qtyï¼†gt; 10ï¼‰ä»…é€‰æ‹©qtyå€¼å¤§äº10çš„è®¢å•ï¼š </p><p>   $ ORDER= &#39;{&#34;user_id&#34;:123,&#34;user_name&#34;:&#34;duchess&#34;,&#34;order_id&#34;:456,&#34;order_status&#34;:&#34;sent&#34;,&#34;vendor_id&#34;:789,&#34;vendor_name&#34;:&#34;Abe Books&#34;}&#39;$  echo  $ORDER | jq  &#39;.&#39;{  &#34;user_id&#34;: 123,  &#34;user_name&#34;:  &#34;duchess&#34;,  &#34;order_id&#34;: 456,  &#34;order_status&#34;:  &#34;sent&#34;,  &#34;vendor_id&#34;: 789,  &#34;vendor_name&#34;:  &#34;Abe Books&#34;}$  echo  $ORDER | jq  &#39;with_entries(select(.key|match(&#34;order_&#34;)))&#39;{  &#34;order_id&#34;: 456,  &#34;order_status&#34;:  &#34;sent&#34;}</p><p>$ ORDER =ï¼†ï¼ƒ39; {ï¼†ï¼ƒ34; user_idï¼†ï¼ƒ34;ï¼š123ï¼Œï¼†ï¼ƒ34; user_nameï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; duchessï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34; order_idï¼†ï¼ƒ34;ï¼š456ï¼Œï¼†ï¼ƒ 34; order_statusï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; sentï¼†ï¼ƒ34;ï¼Œvendor_idï¼†ï¼ƒ34;ï¼š789ï¼Œï¼†ï¼ƒ34; vendor_nameï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; Abe Booksï¼†ï¼ƒ34;}ï¼†ï¼ƒ39; $ echo $ ORDER | jqï¼†ï¼ƒ39;ã€‚ï¼†ï¼ƒ39; {123ï¼Œuser_nameï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34;å…¬çˆµå¤«äººï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; order_idï¼†ï¼ƒ34 ;: 456 ï¼Œï¼†ï¼ƒ34; order_statusï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; sentï¼†ï¼ƒ34 ;ã€ï¼†ï¼ƒ34; vendor_idï¼†ï¼ƒ34 ;ï¼š 789ï¼Œï¼†ï¼ƒ34; vendor_nameï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; Abe Booksï¼†ï¼ƒ34;} $ echo $ ORDER | jqï¼†ï¼ƒ39; with_entriesï¼ˆselectï¼ˆ.key | matchï¼ˆï¼†ï¼ƒ34; order _ï¼†ï¼ƒ34;ï¼‰ï¼‰ï¼‰ï¼†ï¼ƒ39; {ï¼†ï¼ƒ34; order_idï¼†ï¼ƒ34 ;ï¼š 456ï¼Œï¼†ï¼ƒ34; order_statusï¼†ï¼ƒ34 ;ï¼š ï¼†ï¼ƒ34;å‘é€ï¼†ï¼ƒ34;}</p><p>      The fact that the  task_name value is a  filename is a red flagâ€“ it&#39;s bad to have labels with high cardinality and I&#39;m not sure how many of these there are. I want to find out:</p><p>      task_nameå€¼æ˜¯æ–‡ä»¶åçš„äº‹å®æ˜¯ä¸€ä¸ªå±é™©ä¿¡å·-å…·æœ‰é«˜åŸºæ•°çš„æ ‡ç­¾å¾ˆä¸å¥½ï¼Œè€Œä¸”æˆ‘ä¸ç¡®å®šå…¶ä¸­æœ‰å¤šå°‘ä¸ªæ ‡ç­¾ã€‚æˆ‘æƒ³æ‰¾å‡ºï¼š</p><p>   At my company there is a  CLI tool we&#39;ll call  pquery that allows prometheus metrics to be queried from the command line, and it outputs JSONâ€“how conventient! I use this tool in the following examples. You don&#39;t have this tool, but fear not:  this wonderful post explains how to query prometheus using  curl which is essentially what  pquery does.</p><p>   åœ¨æˆ‘å…¬å¸ï¼Œæœ‰ä¸€ä¸ªCLIå·¥å…·ï¼Œæˆ‘ä»¬å°†è°ƒç”¨pqueryï¼Œè¯¥å·¥å…·å…è®¸ä»å‘½ä»¤è¡ŒæŸ¥è¯¢prometheusåº¦é‡æ ‡å‡†ï¼Œå¹¶ä¸”å®ƒè¾“å‡ºJSONï¼Œè¿™æ˜¯å¤šä¹ˆæ–¹ä¾¿ï¼åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨æ­¤å·¥å…·ã€‚æ‚¨æ²¡æœ‰æ­¤å·¥å…·ï¼Œä½†ä¸è¦æ‹…å¿ƒï¼šè¿™ç¯‡ç²¾å½©çš„æ–‡ç« è§£é‡Šäº†å¦‚ä½•ä½¿ç”¨curlæŸ¥è¯¢æ™®ç½—ç±³ä¿®æ–¯ï¼Œè¿™å®é™…ä¸Šæ˜¯pqueryçš„å·¥ä½œã€‚</p><p> Using  pquery we can view prometheus metrics from our various clusters. But even if we filter for this exact metric name, it&#39;s more data than we can easily look at. We&#39;ll use  wc -l (wordcount: count lines) to get a rough idea of how much data we&#39;re working with:</p><p> ä½¿ç”¨pqueryï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹æ¥è‡ªå„ä¸ªé›†ç¾¤çš„PrometheusæŒ‡æ ‡ã€‚ä½†æ˜¯ï¼Œå³ä½¿æˆ‘ä»¬è¿‡æ»¤äº†è¿™ä¸ªç¡®åˆ‡çš„æŒ‡æ ‡åç§°ï¼Œå®ƒçš„æ•°æ®ä¹Ÿæ¯”æˆ‘ä»¬å®¹æ˜“çœ‹åˆ°çš„æ›´å¤šã€‚æˆ‘ä»¬å°†ä½¿ç”¨wc -lï¼ˆwordcountï¼šè®¡æ•°è¡Œï¼‰æ¥å¤§è‡´äº†è§£æˆ‘ä»¬æ­£åœ¨å¤„ç†çš„æ•°æ®é‡ï¼š</p><p>  316,117 lines of JSON! Oof! We want to iterate over the metrics. But what jq filter do we need to access the array of metrics? I find  head useful for figuring out what the top level keys are for a large json structure:</p><p>  316,117è¡ŒJSONï¼é’±å¸ï¼æˆ‘ä»¬è¦éå†æŒ‡æ ‡ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä»€ä¹ˆjqè¿‡æ»¤å™¨æ¥è®¿é—®æŒ‡æ ‡æ•°ç»„ï¼Ÿæˆ‘å‘ç°å¯¹äºç¡®å®šå¤§å‹jsonç»“æ„çš„é¡¶çº§é”®æ˜¯æœ‰ç”¨çš„ï¼š</p><p> $ pquery  &#39;async_task_total&#39; | head -n 20{  &#34;data&#34;: {  &#34;result&#34;: [ {  &#34;metric&#34;: {  &#34;__name__&#34;:  &#34;async_task_total&#34;,  &#34;app&#34;:  &#34;toodle-app-alpha&#34;,  &#34;instance&#34;:  &#34;10.55.55.55:9393&#34;,  &#34;job&#34;:  &#34;toodle-app-alpha&#34;,  &#34;kubernetes_pod_name&#34;:  &#34;toodle-app-b446b7ccd-6mls6&#34;,  &#34;namespace&#34;:  &#34;noweb&#34;,  &#34;netpol&#34;:  &#34;toodle-app&#34;,  &#34;node_name&#34;:  &#34;gke-production-04-3455c6df-j526&#34;,  &#34;release&#34;:  &#34;toodle-app&#34;,  &#34;task_name&#34;:  &#34;/charmoffensive/toodle-app/pkg/core/user/user.go(67):GetAccountDetails&#34; },  &#34;value&#34;: [ 1600981630.344,  &#34;2&#34;</p><p> $ pqueryï¼†ï¼ƒ39; async_task_totalï¼†ï¼ƒ39; |å¤´-n 20 {ï¼†ï¼ƒ34; dataï¼†ï¼ƒ34 ;: {ï¼†ï¼ƒ34; resultï¼†ï¼ƒ34 ;: [{ï¼†ï¼ƒ34; metricï¼†ï¼ƒ34 ;: {ï¼†ï¼ƒ34; __ name __ï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; async_task_totalï¼† ï¼ƒ34 ;ã€ï¼†ï¼ƒ34; appï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; toodle-app-alphaï¼†ï¼ƒ34 ;ã€ï¼†ï¼ƒ34; instanceï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; 10.55.55.55ï¼š9393ï¼†ï¼ƒ34 ;ã€ï¼†ï¼ƒ 34; jobï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; toodle-app-alphaï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34; kubernetes_pod_nameï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; toodle-app-b446b7ccd-6mls6ï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34;å‘½åç©ºé—´ï¼†ï¼ƒ 34 ;ï¼šï¼†ï¼ƒ34; nowebï¼†ï¼ƒ34 ;ï¼Œï¼†ï¼ƒ34; netpolï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; toodle-appï¼†ï¼ƒ34 ;ï¼Œï¼†ï¼ƒ34; node_nameï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; gke-production-04 -3455c6df-j526ï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; releaseï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; toodle-appï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; task_nameï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; / charmoffensive / toodle-app / pkg / core / user / user.goï¼ˆ67ï¼‰ï¼šGetAccountDetailsï¼†ï¼ƒ34; }ï¼Œï¼†ï¼ƒ34; valueï¼†ï¼ƒ34 ;ï¼š [1600981630.344ï¼Œï¼†ï¼ƒ34; 2ï¼†ï¼ƒ34;</p><p>   Anyway we can see from above that  .data.result is the &#34;filter&#34; path for the metrics themselves. Let&#39;s get the  first result ( [0]) of this array so we can see what one metric looks like:</p><p>   æ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸Šæ–¹çœ‹åˆ°.data.resultæ˜¯ï¼†ï¼ƒ34; filterï¼†ï¼ƒ34;æŒ‡æ ‡æœ¬èº«çš„è·¯å¾„ã€‚è®©æˆ‘ä»¬è·å–æ­¤æ•°ç»„çš„ç¬¬ä¸€ä¸ªç»“æœï¼ˆ[0]ï¼‰ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåº¦é‡æ ‡å‡†ï¼š </p><p> $ pquery  &#39;async_task_total&#39; | jq  &#39;.data.result[0]&#39;{  &#34;metric&#34;: {  &#34;__name__&#34;:  &#34;async_task_total&#34;,  &#34;app&#34;:  &#34;toodle-app-alpha&#34;,  &#34;instance&#34;:  &#34;10.55.55.55:9393&#34;,  &#34;job&#34;:  &#34;toodle-app-alpha&#34;,  &#34;kubernetes_pod_name&#34;:  &#34;toodle-app-b446b7ccd-6mls6&#34;,  &#34;namespace&#34;:  &#34;noweb&#34;,  &#34;netpol&#34;:  &#34;toodle-app&#34;,  &#34;node_name&#34;:  &#34;gke-production-04-3455c6df-j526&#34;,  &#34;release&#34;:  &#34;toodle-app&#34;,  &#34;task_name&#34;:  &#34;/charmoffensive/toodle-app/pkg/core/user/user.go(67):GetAccountDetails&#34; },  &#34;value&#34;: [ 1600981906.069,  &#34;2&#34; ]}</p><p>$ pqueryï¼†ï¼ƒ39; async_task_totalï¼†ï¼ƒ39; | jqï¼†ï¼ƒ39; .data.result [0]ï¼†ï¼ƒ39; {ï¼†ï¼ƒ34; metricï¼†ï¼ƒ34 ;: {ï¼†ï¼ƒ34; __ name __ï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; async_task_totalï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; appï¼† ï¼ƒ34 ;:ï¼†ï¼ƒ34; toodle-app-alphaï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34; instanceï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; 10.55.55.55ï¼š9393ï¼†ï¼ƒ34 ;ã€ï¼†ï¼ƒ34; jobï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ 34; toodle-app-alphaï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; kubernetes_pod_nameï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; toodle-app-b446b7ccd-6mls6ï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; namespaceï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; nowebï¼†ï¼ƒ 34;ï¼Œnetpolï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; toodle-appï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34; node_nameï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; gke-production-04-3455c6df-j526ï¼†ï¼ƒ34;ï¼Œï¼† ï¼ƒ34; releaseï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; toodle-appï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; task_nameï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; /charmoffensive/toodle-app/pkg/core/user/user.goï¼ˆ67 ï¼‰ï¼šGetAccountDetailsï¼†ï¼ƒ34; }ï¼Œï¼†ï¼ƒ34; valueï¼†ï¼ƒ34 ;ï¼š [1600981906.069ï¼Œï¼†ï¼ƒ34; 2ï¼†ï¼ƒ34; ]}</p><p> Oops! That  app value ( toodle-app-alpha) indicates a mistake: I&#39;m only interested in results from the  toodle-app app,  not from other apps that may also emit this metric (such as the  alpha deployment we see here). We could  select for this using jq, but   promql already lets us filter by metric names so we&#39;ll do that instead:  pquery &#39;async_task_total{app=&#34;toodle-app&#34;}&#39;.</p><p> ç³Ÿç³•ï¼è¯¥åº”ç”¨ç¨‹åºçš„å€¼ï¼ˆsodle-app-alphaï¼‰è¡¨ç¤ºä¸€ä¸ªé”™è¯¯ï¼šæˆ‘åªå¯¹sodled-appåº”ç”¨ç¨‹åºçš„ç»“æœæ„Ÿå…´è¶£ï¼Œè€Œå¯¹å¯èƒ½å‘å‡ºæ­¤æŒ‡æ ‡çš„å…¶ä»–åº”ç”¨ç¨‹åºä¸æ„Ÿå…´è¶£ï¼ˆä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨æ­¤å¤„çœ‹åˆ°çš„alphaéƒ¨ç½²ï¼‰ ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨jqè¿›è¡Œé€‰æ‹©ï¼Œä½†æ˜¯promqlå·²ç»å…è®¸æˆ‘ä»¬æŒ‰æŒ‡æ ‡åç§°è¿›è¡Œè¿‡æ»¤ï¼Œå› æ­¤æˆ‘ä»¬å°†æ”¹ä¸ºï¼špqueryï¼†ï¼ƒ39; async_task_total {app =ï¼†ï¼ƒ34; toodle-appï¼†ï¼ƒ34;}ï¼†ï¼ƒ39 ;ã€‚</p><p> We&#39;re interested in the  task_name value in the  metric object, so let&#39;s pluck that from  each item in the array above:</p><p> æˆ‘ä»¬å¯¹åº¦é‡å¯¹è±¡ä¸­çš„task_nameå€¼æ„Ÿå…´è¶£ï¼Œå› æ­¤ï¼Œè¯·ä»ä¸Šé¢æ•°ç»„ä¸­çš„æ¯ä¸ªé¡¹ç›®ä¸­å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š</p><p>  Eighteen thousand values for that label!? That&#39;s bad!! But wait a ticâ€“if other labels are varying, some of these may actually be duplicates. Let&#39;s sort them and see:</p><p>  è¯¥æ ‡ç­¾çš„ä¸€ä¸‡å…«åƒä¸ªå€¼ï¼ä¸å¥½ï¼ï¼ä½†æ˜¯è¯·ç¨å€™-å¦‚æœå…¶ä»–æ ‡ç­¾æœ‰æ‰€ä¸åŒï¼Œåˆ™å…¶ä¸­ä¸€äº›å®é™…ä¸Šå¯èƒ½æ˜¯é‡å¤çš„ã€‚è®©æˆ‘ä»¬å¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼Œç„¶åæŸ¥çœ‹ï¼š</p><p>    Now I&#39;ve got a full list of all the  distinct values for this label, which answers my first question.</p><p>    ç°åœ¨ï¼Œæˆ‘å·²ç»è·å¾—äº†è¯¥æ ‡ç­¾æ‰€æœ‰ä¸åŒå€¼çš„å®Œæ•´åˆ—è¡¨ï¼Œå¯ä»¥å›ç­”æˆ‘çš„ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p><p>    Ninety-two! Not so bad. Mystery solved, and I can say with reasonable confidence &#34;the cardinality of these labels isn&#39;t terribly high, I&#39;m leaving this alone ğŸ˜…&#34;</p><p>    ä¹åäºŒï¼è¿˜ä¸é”™è°œå›¢è§£å†³äº†ï¼Œæˆ‘å¯ä»¥æ”¾å¿ƒåœ°è¯´ï¼†ï¼ƒ34;è¿™äº›æ ‡ç­¾çš„åŸºæ•°ä¸æ˜¯å¾ˆé«˜ï¼Œæˆ‘å°±åˆ«è¯´äº†ã€‚</p><p>     $ kubectl get deployments toodle-app -o json \| jq &#39;.status.conditions[]|(.reason + &#34;: &#34; + .message)&#39; -rNewReplicaSetAvailable: ReplicaSet &#34;toodle-app-545b65cfd4&#34; has successfully progressed.MinimumReplicasAvailable: Deployment has minimum availability.</p><p>     $ kubectlè·å–éƒ¨ç½²toodle-app -o json \ | jqï¼†ï¼ƒ39; .status.conditions [] |ï¼ˆ.reason +ï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; + .messageï¼‰ï¼†ï¼ƒ39; -rNewReplicaSetAvailableï¼šReplicaSetï¼†ï¼ƒ34; toodle-app-545b65cfd4ï¼†ï¼ƒ34; MinimumReplicasAvailableï¼šéƒ¨ç½²å…·æœ‰æœ€ä½å¯ç”¨æ€§ã€‚ </p><p>  $ kubectl get service toodle-app -o json \| jq  &#39;.metadata.annotations | with_entries(select(.key|match(&#34;prometheus&#34;)))&#39;{  &#34;prometheus.io/path&#34;:  &#34;/varz&#34;,  &#34;prometheus.io/port&#34;:  &#34;9393&#34;,  &#34;prometheus.io/scrape&#34;:  &#34;true&#34;}</p><p>$ kubectlè·å–æœåŠ¡toodle-app -o json \ | jqï¼†ï¼ƒ39.metadata.annotations | with_entriesï¼ˆselectï¼ˆ.key | matchï¼ˆï¼†ï¼ƒ34; prometheusï¼†ï¼ƒ34;ï¼‰ï¼‰ï¼‰ï¼‰ï¼†ï¼ƒ39; {ï¼†ï¼ƒ34; prometheus.io/path&#34 ;:ï¼†ï¼ƒ34; / varzï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ 34; prometheus.io/port&#34 ;ï¼šï¼†ï¼ƒ34; 9393ï¼†ï¼ƒ34 ;ï¼Œï¼†ï¼ƒ34; prometheus.io/scrape&#34 ;ï¼šï¼†ï¼ƒ34; trueï¼†ï¼ƒ34;}</p><p>  $ cat cronjob.yamlapiVersion: batch/v1beta1kind: CronJobspec: schedule:  &#34;*/1 * * * *&#34;  # once per minute jobTemplate: spec: template: spec: containers: - name: deployment-scanner image: deployment-scanner:38$ brew install yq$ yq  &#39;.spec.jobTemplate.spec.template.spec.containers[0].image&#39; cronjob.yaml &#34;deployment-scanner:38&#34;</p><p>  $ cat cronjob.yamlapiVersionï¼šbatch / v1beta1kindï¼šCronJobspecï¼šscheduleï¼šï¼†ï¼ƒ34; * / 1 * * * *ï¼†ï¼ƒ34; ï¼ƒæ¯åˆ†é’Ÿä¸€æ¬¡jobTemplateï¼šè§„æ ¼ï¼šæ¨¡æ¿ï¼šè§„æ ¼ï¼šå®¹å™¨ï¼š-åç§°ï¼šéƒ¨ç½²æ‰«æå™¨å›¾åƒï¼šéƒ¨ç½²æ‰«æå™¨ï¼š38 $ brew install yq $ yqï¼†ï¼ƒ39; .spec.jobTemplate.spec.template.spec.containers [ 0] .imageï¼†ï¼ƒ39; cronjob.yamlï¼†ï¼ƒ34; deployment-scannerï¼š38ï¼†ï¼ƒ34;</p><p> I used this to build a new docker image tag each time I incremented the image value in cronjob.yaml, before applying the configuration (while I was developing a kubernetes cronjob locally):</p><p> æ¯æ¬¡åœ¨åº”ç”¨é…ç½®ä¹‹å‰ï¼ˆå½“æˆ‘åœ¨æœ¬åœ°å¼€å‘kubernetes cronjobæ—¶ï¼‰ï¼Œæ¯æ¬¡åœ¨cronjob.yamlä¸­å¢åŠ å›¾åƒå€¼æ—¶ï¼Œæˆ‘éƒ½ä¼šä½¿ç”¨å®ƒæ¥æ„å»ºæ–°çš„dockerå›¾åƒæ ‡ç­¾ï¼š</p><p>   âœ curl  -sL https://postmates.com/feed | pup  &#39;head title&#39;&lt;title&gt; postmates: Food Delivery, Groceries, Alcohol - Anything from Anywhere&lt;/title&gt;âœ curl  -sL https://postmates.com/feed | pup  &#39;head meta[charset]&#39;&lt;meta charset= &#34;UTF-8&#34;&gt;âœ curl  -sL https://postmates.com/feed | pup  &#39;head meta[charset] json{}&#39;[ {  &#34;charset&#34;:  &#34;UTF-8&#34;,  &#34;tag&#34;:  &#34;meta&#34; }]</p><p>   âœcurl -sL https://postmates.com/feed | pupï¼†ï¼ƒ39;ï¼†lt; titleï¼†gt; postmatesï¼šé€é¤ï¼Œæ‚è´§ï¼Œé…’ç²¾-éšå¤„å¯è§ï¼†lt; / titleï¼†gt;âœcurl -sL pupï¼†ï¼ƒ39; head meta [charset]ï¼†lt; meta charset =ï¼†ï¼ƒ34; UTF-8ï¼†ï¼ƒ34;ï¼†gt; curl -sL https://postmates.com/feed | pupï¼†ï¼ƒ39; head meta [charset] json {}ï¼†ï¼ƒ39; [{ï¼†ï¼ƒ34; charsetï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; UTF-8ï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; tagï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ 34; metaï¼†ï¼ƒ34; }]</p><p>  What do you use  jq or  yq for? Will you be adding  pup to your workflow? Sound off in the comments, which is to say &#34;drop me a line!&#34;</p><p>  æ‚¨å°†jqæˆ–yqç”¨äºä»€ä¹ˆï¼Ÿæ‚¨ä¼šåœ¨å·¥ä½œæµç¨‹ä¸­æ·»åŠ å°ç‹—å—ï¼Ÿåœ¨è¯„è®ºä¸­å¬èµ·æ¥å¾ˆå“ï¼Œå°±æ˜¯è¯´â€œç»™æˆ‘ä¸‹ä¸€è¡Œï¼â€</p><p>    ğŸ“ Comments? Please email them to my  protonmail.com address, username  sequoiam</p><p>    ğŸ“è¯„è®ºï¼Ÿè¯·é€šè¿‡ç”µå­é‚®ä»¶å°†å®ƒä»¬å‘é€åˆ°æˆ‘çš„protonmail.comåœ°å€ï¼Œç”¨æˆ·åsequoiam </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://sequoia.makes.software/parsing-json-at-the-cli-a-practical-introduction-to-jq-and-more/">https://sequoia.makes.software/parsing-json-at-the-cli-a-practical-introduction-to-jq-and-more/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/å®ç”¨/">#å®ç”¨</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/json/">#json</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ†äº«/">#åˆ†äº«</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>