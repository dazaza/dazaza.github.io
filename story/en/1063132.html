<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>æ¼æ°´æŠ½è±¡ Leaky Abstractions</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Leaky Abstractions<br/>æ¼æ°´æŠ½è±¡ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-03 23:48:06</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/6/b92973c94c2b31441d4de3920dafc254.png"><img src="http://img2.diglog.com/img/2021/6/b92973c94c2b31441d4de3920dafc254.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>In the late 1990s, the Windows Shell and Internet Explorer teams introduced a lot of brilliant and intricate designs that allowed intricate extension of the shell and the browser to handle scenarios beyond what those built by Microsoft itself. For instance, Internet Explorer supported the notion of pluggable protocols (â€œ What if some protocol, say, FTPS becomes as important as HTTP?â€) and the Windows Shell offered an extremely flexible set of abstract browsing of namespaces, enabling third parties to build browsable â€œfoldersâ€ not backed by the file systemâ€“ everything from WebDAV (â€œ your HTTP-server is a folderâ€œ) to CAB Folders (â€œ your CAB archive is a folderâ€œ). As a PM on the clipart team in 2004, I built a .NET-based application to browse clipart from the Office web services, and I sketched out an initial design for a Windows Shell extension that would make it look like Microsoftâ€™s enormous web-based clipart archive were installed in a local folder on your system.</p><p>åœ¨20ä¸–çºª90å¹´ä»£æœ«ï¼ŒWindows Shellå’ŒInternet Explorerå›¢é˜Ÿä»‹ç»äº†è®¸å¤šè¾‰ç…Œå’Œå¤æ‚çš„è®¾è®¡ï¼Œå…è®¸é”™ç»¼å¤æ‚çš„shellå’Œæµè§ˆå™¨æ¥å¤„ç†è¶…å‡ºMicrosoftæœ¬èº«å»ºé€ çš„åœºæ™¯ã€‚ä¾‹å¦‚ï¼ŒInternet Exploreræ”¯æŒå¯æ’æ‹”åè®®çš„æ¦‚å¿µï¼ˆå¦‚æœæŸäº›åè®®ï¼Œä¾‹å¦‚ï¼ŒFTPSä¸HTTPï¼Ÿâ€œå˜å¾—åŒæ ·é‡è¦çš„è¯ï¼‰ï¼Œå¹¶ä¸”Windows Shellæä¾›äº†ä¸€ä¸ªéå¸¸çµæ´»çš„æŠ½è±¡æµè§ˆåç§°ç©ºé—´ï¼Œä½¿ç¬¬ä¸‰æ–¹èƒ½å¤Ÿæ„å»ºå¯æµè§ˆâ€œæ–‡ä»¶å¤¹â€æœªç”±æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½ - ä»WebDAVï¼ˆâ€œæ‚¨çš„HTTP-Serveræ˜¯æ–‡ä»¶å¤¹â€ï¼‰åˆ°CABæ–‡ä»¶å¤¹ï¼ˆâ€œæ‚¨çš„CABå­˜æ¡£æ˜¯æ–‡ä»¶å¤¹â€ï¼‰çš„æ‰€æœ‰å†…å®¹ã€‚ä½œä¸º2004å¹´çš„Clipartå›¢é˜Ÿçš„PMï¼Œæˆ‘å»ºç«‹äº†åŸºäº.NETçš„åº”ç”¨ç¨‹åºæ¥ä»Office WebæœåŠ¡æµè§ˆå‰ªè´´ç”»ï¼Œæˆ‘å‹¾å‹’å‡ºäº†ä¸€ä¸ªåˆå§‹è®¾è®¡ï¼Œä»¥ä½¿å…¶çœ‹èµ·æ¥åƒMicrosoftçš„åŸºäºWebçš„Web Clipartå­˜æ¡£å®‰è£…åœ¨ç³»ç»Ÿä¸Šçš„æœ¬åœ°æ–‡ä»¶å¤¹ä¸­ã€‚</p><p> Perhaps the most popular (or infamous) example of a shell namespace extension is the Compressed Folders extension, which handles the exploration of ZIP files. First introduced in the Windows 98  Plus Pack and later included with Windows Me+ directly, Compressed Folders allows billions of Windows users to interact with ZIP files without downloading third-party software. Perhaps surprisingly, the feature was itself was acquired from two third-parties â€” Microsoft acquired the Explorer integration from  Dave Plummerâ€™s â€œside projectâ€, while a company called  InnerMedia claims credit for the â€œDynaZIPâ€ engine underneath.</p><p> ä¹Ÿè®¸æœ€å—æ¬¢è¿çš„ï¼ˆæˆ–è‡­åæ˜­ç€ï¼‰çš„shellå‘½åç©ºé—´æ‰©å±•åç§°æ˜¯å‹ç¼©æ–‡ä»¶å¤¹æ‰©å±•ï¼Œå¤„ç†ZIPæ–‡ä»¶çš„æ¢ç´¢ã€‚é¦–å…ˆåœ¨Windows 98 PlusåŒ…ä¸­å¼•å…¥ï¼Œåæ¥åŒ…å«åœ¨Windows Me +ç›´æ¥ï¼Œå‹ç¼©æ–‡ä»¶å¤¹å…è®¸æ•°åäº¿ä¸ªWindowsç”¨æˆ·ä¸Zipæ–‡ä»¶è¿›è¡Œäº¤äº’ï¼Œè€Œæ— éœ€ä¸‹è½½ç¬¬ä¸‰æ–¹è½¯ä»¶ã€‚ä¹Ÿè®¸ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œè¯¥ç‰¹å¾æœ¬èº«å°±æ˜¯ä»ä¸¤ä¸ªç¬¬ä¸‰æ–¹è·å¾—çš„ - å¾®è½¯ä»Dave Plummerçš„â€œä¾§é¢é¡¹ç›®â€ä¸­è·å¾—äº†æ¢é™©å®¶é›†æˆï¼Œè€Œä¸€å®¶åä¸ºInnerMediaç´¢èµ”çš„å…¬å¸ï¼Œä¸ºä¸‹é¢çš„â€œDynazipâ€å¼•æ“ã€‚</p><p> Unfortunately, the code hasnâ€™t really been updated in a while. A long while. The timestamp in the module claims it was last updated on Valentineâ€™s Day 1998, and while I suspect there mayâ€™ve been a fix here or there since then (and one feature, extract-only Unicode filename support), itâ€™s no secret that the code is, as  Raymond Chen says: â€œ stuck at the turn of the century.â€ That means that it doesnâ€™t support â€œmodernâ€ features like AES encryption, and its performance (runtime, compression ratio) is known to be dramatically inferior to  modern 3rd-party implementations.</p><p> ä¸å¹¸çš„æ˜¯ï¼Œä»£ç æš‚æ—¶æ²¡æœ‰æ›´æ–°ã€‚å¾ˆä¹…äº†ã€‚æ¨¡å—ä¸­çš„æ—¶é—´æˆ³å£°ç§°å®ƒæœ€åä¸€æ¬¡æ›´æ–°äº†1998å¹´çš„æƒ…äººèŠ‚ï¼Œè€Œæˆ‘æ€€ç–‘åœ¨è¿™é‡Œæˆ–ä¹‹åå¯èƒ½å·²ç»è§£å†³äº†ï¼ˆå’Œä¸€ä¸ªåŠŸèƒ½ï¼Œåªæœ‰unicodeæ–‡ä»¶åæ”¯æŒï¼‰ï¼Œè€Œä»£ç åˆ™æ²¡æœ‰ç§˜å¯†æ˜¯çš„ï¼Œæ­£å¦‚Raymond Chenæ‰€è¯´ï¼šâ€œé™·å…¥ä¸–çºªä¹‹äº¤ã€‚â€è¿™æ„å‘³ç€å®ƒä¸æ”¯æŒåƒAESåŠ å¯†è¿™æ ·çš„â€œç°ä»£â€åŠŸèƒ½ï¼Œå¹¶ä¸”å·²çŸ¥å…¶æ€§èƒ½ï¼ˆè¿è¡Œæ—¶ï¼Œå‹ç¼©æ¯”ï¼‰è¢«æ˜¾ç€é€Šäºç°ä»£çš„ç¬¬ä¸‰æ–¹å®ç°ã€‚</p><p> So, why hasnâ€™t it been updated? Well, â€œ if it aint broke, donâ€™t fix itâ€ accounts for part of the thinkingâ€“ the ZIP Folders implementation has survived in Windows for 23 years without the howling of customers becoming unbearable, so thereâ€™s some evidence that users are happy enough.</p><p> é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆå®ƒæ²¡æœ‰æ›´æ–°ï¼Ÿå¥½å§ï¼Œâ€œå¦‚æœå®ƒæ˜¯ä¸€ä¸ªç ´åï¼Œä¸è¦ä¿®å¤å®ƒâ€å æ€è€ƒçš„ä¸€éƒ¨åˆ† -  Zipæ–‡ä»¶å¤¹çš„å®æ–½å·²ç»åœ¨Windowsä¸­å¹¸å­˜äº†23å¹´ï¼Œè€Œæ²¡æœ‰å®¢æˆ·ä»¤äººéš¾ä»¥å¿å—çš„åšå«ï¼Œå› æ­¤æœ‰ä¸€äº›è¯æ®è¡¨æ˜ç”¨æˆ·è¶³å¤Ÿé«˜å…´ã€‚</p><p> Unfortunately, there are degenerate cases where the ZIP Folders support really  is broken. I ran across one of those  yesterday. I had seen an interesting Twitter thread about  hex editors that offer annotation (useful for exploring file formats) and decided to try a few out (I decided I like   ReHex best). But in the process, I downloaded the portable version of  ImHex and tried to move it to my Tools folder.</p><p> ä¸å¹¸çš„æ˜¯ï¼ŒZIPæ–‡ä»¶å¤¹æ”¯æŒçœŸæ­£è¢«ç ´åçš„å •è½æƒ…å†µã€‚æˆ‘æ˜¨å¤©è·‘è¿‡å…¶ä¸­ä¸€ä¸ªã€‚æˆ‘å·²ç»çœ‹åˆ°äº†ä¸€ä¸ªå…³äºåå…­è¿›åˆ¶ç¼–è¾‘çš„æœ‰è¶£çš„æ¨ç‰¹çº¿ç¨‹ï¼Œæä¾›æ³¨é‡Šï¼ˆæœ‰åŠ©äºæ¢ç´¢æ–‡ä»¶æ ¼å¼ï¼‰å¹¶å†³å®šå°è¯•å‡ æ¬¡ï¼ˆæˆ‘å†³å®šæœ€å–œæ¬¢Rehexï¼‰ã€‚ä½†åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¸‹è½½äº†IMHEXçš„ä¾¿æºå¼ç‰ˆæœ¬ï¼Œå¹¶è¯•å›¾å°†å…¶ç§»åŠ¨åˆ°æˆ‘çš„å·¥å…·æ–‡ä»¶å¤¹ä¸­ã€‚</p><p> I did so by double-clicking the 11.5mb ZIP to open it. I then hit  CTRL+A to select all of the files within, then crucially ( spoiler alert)  CTRL+X to cut the files to my clipboard.</p><p> æˆ‘é€šè¿‡åŒå‡»11.5MB Zipæ‰“å¼€å®ƒæ¥å®Œæˆæ­¤æ“ä½œã€‚ç„¶åï¼Œæˆ‘æŒ‰Ctrl + Aé€‰æ‹©æ‰€æœ‰æ–‡ä»¶ï¼Œç„¶åç²—ç•¥ï¼ˆSPOILER ALERTï¼‰CTRL + Xå°†æ–‡ä»¶å‰ªåˆ‡åˆ°æˆ‘çš„å‰ªè´´æ¿ã€‚</p><p>  I then created a new subfolder in my  C:\Tools folder and hit  CTRL+V to paste. And hereâ€™s where everything went off the railsâ€“ Windows spent well over a minute showing â€œ Calculatingâ€¦â€ with no visible progress beyond the creation of a single subfolder with a single 5k file within:</p><p>  ç„¶åï¼Œæˆ‘åœ¨Cï¼š\ Toolsæ–‡ä»¶å¤¹ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å­æ–‡ä»¶å¤¹ï¼Œå¹¶æŒ‰ä½Ctrl + Vç²˜è´´ã€‚åœ¨è¿™é‡Œï¼Œä¸€åˆ‡éƒ½åœ¨è½¨é“ä¸Šè¶Šæ¥è¶Šå¤šåœ°åœ¨ä¸€åˆ†é’Ÿå†…èŠ±äº†â€œè®¡ç®—......â€ï¼Œé™¤äº†åœ¨å•ä¸ª5kæ–‡ä»¶ä¸­åˆ›å»ºå•ä¸ªå­æ–‡ä»¶å¤¹ä¹‹å¤–ï¼Œæ²¡æœ‰æ˜æ˜¾çš„è¿›å±•ï¼š </p><p>  Huh? I knew that the ZIP engine beneath ZIP Folders wasnâ€™t well-optimized, but Iâ€™d never seen anything  this bad before. After waiting a few more minutes, another file extracted, this one 6.5 mb:</p><p>å‘µå‘µï¼Ÿæˆ‘çŸ¥é“æ‹‰é“¾æ–‡ä»¶å¤¹ä¸‹æ–¹çš„æ‹‰é“¾å‘åŠ¨æœºå¹¶ä¸ä¼˜åŒ–ï¼Œä½†æˆ‘ä»¥å‰ä»æœªè§è¿‡è¿™ä¹ˆç³Ÿç³•ã€‚ç­‰å¾…å‡ åˆ†é’Ÿåï¼Œå¦ä¸€ä¸ªæ–‡ä»¶æå–ï¼Œè¿™æ˜¯6.5 MBï¼š</p><p>  This is bananas. I opened Task Manager, but nothing seemed to be using up much of my 12 thread CPU, my 64gb of memory, or my NVMe SSD. Finally, I opened up  SysInternalsâ€™ Process Monitor to try to see what was going on, and the root cause of the problem was quickly seen.</p><p>  è¿™æ˜¯é¦™è•‰ã€‚æˆ‘æ‰“å¼€äº†ä»»åŠ¡ç®¡ç†å™¨ï¼Œä½†ä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆå¯ä»¥ä½¿ç”¨æˆ‘çš„å¤§éƒ¨åˆ†çº¿ç¨‹CPUï¼Œæˆ‘çš„64GBå†…å­˜æˆ–æˆ‘çš„NVME SSDã€‚æœ€åï¼Œæˆ‘æ‰“å¼€äº†Sysinternalsçš„è¿‡ç¨‹ç›‘è§†å™¨ï¼Œè¯•å›¾çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå¹¶ä¸”å¾ˆå¿«å°±ä¼šçœ‹åˆ°é—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚</p><p> After some small reads from the end of the file (where the ZIP file keeps its index), the entire 11 million byte file was being read from disk  a single byte at a time:</p><p> åœ¨æ–‡ä»¶æœ«å°¾ï¼ˆZIPæ–‡ä»¶ä¿ç•™å…¶ç´¢å¼•çš„ä½ç½®ï¼‰ä¹‹åï¼Œä¸€æ¬¡ä»ç£ç›˜è¯»å–æ•´ä¸ª1100ä¸‡å­—èŠ‚æ–‡ä»¶ï¼š</p><p>  Looking more closely, I realized that the reads were  almost all a single byte, but every now and then, after a specific 1 byte read, a 15 byte read was issued:</p><p>  ä»”ç»†è§‚å¯Ÿï¼Œæˆ‘æ„è¯†åˆ°è¯»å–å‡ ä¹éƒ½æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ï¼Œç°åœ¨ï¼Œç„¶åï¼Œåœ¨ç‰¹å®šçš„1å­—èŠ‚è¯»å–ä¹‹åï¼Œå‘å‡ºäº†15ä¸ªå­—èŠ‚çš„è¯»å–ï¼š</p><p>  Whatâ€™s at those  interesting offsets ( 330,  337)? The byte  0x50, aka the letter  P.</p><p>  é‚£äº›æœ‰è¶£çš„æŠµæ¶ˆæ˜¯ä»€ä¹ˆï¼ˆ330,337ï¼‰ï¼Ÿå­—èŠ‚0x50ï¼ŒAKAå­—æ¯P.</p><p>  Having written some  trivial ZIP-recovery code in the past, I know whatâ€™s special about the character  P in ZIP filesâ€“ itâ€™s the first byte of the ZIP formatâ€™s  block markers, each of which start with  0x50 0x4B. So whatâ€™s plainly happening here is that the code is reading the file from start to finish looking for a particular block,  16 bytes in size. Each time it hits a  P, it looks at the next 15 bytes to see if they match the desired signature, and if not, it continues scanning byte-by-byte, looking for the next  P.</p><p>  åœ¨è¿‡å»ç¼–å†™äº†ä¸€äº›çç¢çš„æ‹‰é“¾æ¢å¤ä»£ç ï¼Œæˆ‘çŸ¥é“zipæ–‡ä»¶ä¸­çš„å­—ç¬¦pçš„ç‰¹æ®Šæ€§æ˜¯ä»€ä¹ˆ - å®ƒæ˜¯zipæ ¼å¼çš„å—æ ‡è®°çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²éƒ½ä»¥0x50 0x4bå¼€å¤´ã€‚å› æ­¤ï¼Œè¿™é‡Œæ˜¾ç„¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä»£ç æ­£åœ¨ä»å¼€å§‹è¯»å–æ–‡ä»¶ï¼Œä»¥å®Œæˆä¸€ä¸ªç‰¹å®šçš„å—ï¼Œå¤§å°ä¸º16ä¸ªå­—èŠ‚ã€‚æ¯æ¬¡å‡»ä¸­Pæ—¶ï¼Œå®ƒéƒ½ä¼šæŸ¥çœ‹æ¥ä¸‹æ¥çš„15ä¸ªå­—èŠ‚ï¼Œä»¥æŸ¥çœ‹å®ƒä»¬æ˜¯å¦ä¸æ‰€éœ€çš„ç­¾ååŒ¹é…ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå®ƒä¼šç»§ç»­æ‰«æByte-Byteï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ªP.</p><p>  The  ZIP Format consists of a series of file records, followed by a list (â€œCentral Directoryâ€) of those file records.</p><p>  é‚®æ”¿å±€æ ¼å¼ç”±ä¸€ç³»åˆ—æ–‡ä»¶è®°å½•ç»„æˆï¼Œç„¶åæ˜¯è¿™äº›æ–‡ä»¶è®°å½•çš„åˆ—è¡¨ï¼ˆâ€œä¸­å¤®ç›®å½•â€ï¼‰ã€‚ </p><p> Each file record has its own â€œlocal file headerâ€ which contains information about the file, including its size, compressed size, and CRC-32; the same data is repeated in the Central Directory.</p><p>æ¯ä¸ªæ–‡ä»¶è®°å½•éƒ½æœ‰è‡ªå·±çš„â€œæœ¬åœ°æ–‡ä»¶æ ‡é¢˜â€ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³æ–‡ä»¶çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¶å¤§å°ï¼Œå‹ç¼©å¤§å°å’ŒCRC-32;ä¸­å¤®ç›®å½•ä¸­é‡å¤ç›¸åŒçš„æ•°æ®ã€‚</p><p> However, the ZIP format allows the local file headers to omit this data and instead write it as a â€œtrailerâ€ after the compressed data, a capability that is useful when  streaming compressionâ€“ you cannot know the final compressed size until youâ€™ve actually finished compressing the data. Most ZIP files probably donâ€™t make use of this option, but my example download does.   You can see the CRC and sizes are  0â€˜d in the header and instead appear immediately following the signature  0x08074b50 (  Data Descriptor), just before the next fileâ€™s local header:</p><p> ä½†æ˜¯ï¼Œzipæ ¼å¼å…è®¸æœ¬åœ°æ–‡ä»¶å¤´çœç•¥æ­¤æ•°æ®ï¼Œè€Œæ˜¯åœ¨å‹ç¼©æ•°æ®ä¹‹åå°†å…¶å†™å…¥â€œæŒ‚æ­¥â€ï¼Œè¿™æ˜¯åœ¨æµå¼å‹ç¼©æ—¶æœ‰ç”¨çš„åŠŸèƒ½ - åœ¨æ‚¨å®é™…å®Œæˆä¹‹å‰ï¼Œæ— æ³•çŸ¥é“æœ€ç»ˆå‹ç¼©å¤§å°å‹ç¼©æ•°æ®ã€‚å¤§å¤šæ•°zipæ–‡ä»¶å¯èƒ½ä¸ä½¿ç”¨æ­¤é€‰é¡¹ï¼Œä½†æˆ‘çš„ç¤ºä¾‹ä¸‹è½½å®ƒæ˜¯ã€‚æ‚¨å¯ä»¥çœ‹åˆ°CRCå’Œå°ºå¯¸åœ¨æ ‡é¢˜ä¸­ä¸º0'ï¼Œè€Œæ˜¯åœ¨ç­¾å0x08074b50ï¼ˆæ•°æ®æè¿°ç¬¦ï¼‰ä¹‹åç«‹å³æ˜¾ç¤ºåœ¨ä¸‹ä¸€ä¸ªæ–‡ä»¶çš„æœ¬åœ°æ ‡é¢˜ä¹‹å‰ï¼š</p><p>  The 0x08 bit in the  General Purpose flag indicates this option; users of 7-Zip can find it mentioned as  Descriptor in the entryâ€™s  Characteristics column:</p><p>  é€šç”¨æ ‡å¿—ä¸­çš„0x08ä½è¡¨ç¤ºæ­¤é€‰é¡¹; 7-zipçš„ç”¨æˆ·å¯ä»¥åœ¨æ¡ç›®ç‰¹å¾åˆ—ä¸­æ‰¾åˆ°å®ƒä½œä¸ºæè¿°ç¬¦ï¼š</p><p>  Based on the read size ( 1+15 bytes), I assume the code is groveling for the Data Descriptor blocks.  Why it does that (vs. just reading the same data from the Central Directory) I do not know.</p><p>  åŸºäºè¯»å–å¤§å°ï¼ˆ1 + 15ä¸ªå­—èŠ‚ï¼‰ï¼Œæˆ‘å‡è®¾ä»£ç æ˜¯é’ˆå¯¹æ•°æ®æè¿°ç¬¦å—çš„åˆ¨èŠ±ã€‚ä¸ºä»€ä¹ˆå®ƒè¿™æ ·åšï¼ˆä¸è¯»å–æ¥è‡ªä¸­å¿ƒç›®å½•çš„ç›¸åŒæ•°æ®ï¼‰æˆ‘ä¸çŸ¥é“ã€‚</p><p> Making matters worse, this â€œread the file, byte by byteâ€ crawl through the file doesnâ€™t just happen onceâ€“ it happens at least once for  every file extracted. Making matters worse, this data is being  read with ReadFile rather than fread().</p><p> ä½¿äº‹æƒ…å˜å¾—æ›´ç³Ÿï¼Œè¿™å°±æ˜¯â€œè¯»å–æ–‡ä»¶ï¼Œå­—èŠ‚â€çˆ¬è¡Œé€šè¿‡æ–‡ä»¶çˆ¬ç½‘å¹¶ä¸åªæ˜¯å‘ç”Ÿä¸€æ¬¡ï¼Œå› ä¸ºæ¯ä¸ªæ–‡ä»¶éƒ½è‡³å°‘å‘ç”Ÿä¸€æ¬¡ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œä½¿ç”¨ReadFileè€Œä¸æ˜¯Freadï¼ˆï¼‰è¯»å–æ­¤æ•°æ®ã€‚</p><p>   After restarting and  configuring Process Monitor with Symbols, we can examine the one-byte reads and get a hint of whatâ€™s going on:</p><p>   ç”¨ç¬¦å·é‡æ–°å¯åŠ¨å’Œé…ç½®è¿›ç¨‹ç›‘è§†å™¨åï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ä¸€ä¸ªå­—èŠ‚è¯»å–å¹¶è·å¾—ä¸€ä¸æš—ç¤ºæ­£åœ¨è¿›è¡Œçš„å†…å®¹ï¼š</p><p>  The  GetSomeBytes function is getting hammered with calls passing a single byte buffer, in a tight loop inside the  readzipfile function. But look down the stack and the root cause of the mess becomes clearâ€“ this is happening because after each file is â€œmovedâ€ from the ZIP to the target folder, the ZIP file must be updated to delete the file that was â€œmoved.â€ This deletion process is  inherently not fast (because it results in shuffling all of the subsequent bytes of the file and updating the index), and as implemented in the  readzipfile function (with its one-byte read buffer) is atrociously slow.</p><p>  GetSomebyteså‡½æ•°æ­£åœ¨å‡»ä¸­ä¼ é€’å•ä¸ªå­—èŠ‚ç¼“å†²åŒºçš„å‘¼å«ï¼Œåœ¨ReadzipfileåŠŸèƒ½å†…çš„ç´§å¯†å¾ªç¯ä¸­ã€‚ä½†æ˜¯ç§ä¸èµ·å †æ ˆï¼Œä¹±ä¸ƒå…«ç³Ÿçš„æ ¹æœ¬åŸå› å˜å¾—æ¸…æ™° - è¿™å‘ç”Ÿäº†ï¼Œå› ä¸ºåœ¨æ¯ä¸ªæ–‡ä»¶ä»zipåˆ°ç›®æ ‡æ–‡ä»¶å¤¹åï¼Œå¿…é¡»æ›´æ–°zipæ–‡ä»¶ä»¥åˆ é™¤â€œç§»åŠ¨â€çš„æ–‡ä»¶ã€‚æ­¤åˆ é™¤è¿‡ç¨‹æœ¬è´¨ä¸Šä¸æ˜¯å¿«é€Ÿï¼ˆå› ä¸ºå®ƒå¯¼è‡´å°†æ–‡ä»¶çš„æ‰€æœ‰åç»­å­—èŠ‚è¿›è¡Œæ´—ç‰Œå¹¶æ›´æ–°ç´¢å¼•ï¼‰ï¼Œå¹¶ä¸”å¦‚åœ¨ReadzzipFileå‡½æ•°ä¸­å®ç°ï¼ˆå…·æœ‰å…¶å•å­—èŠ‚è¯»ç¼“å†²åŒºï¼‰æ›´æ…¢ã€‚ </p><p> Back up in my repro steps, note that I hit  CTRL+X to â€œCutâ€ the files, resulting in a Move operation. Had I instead hit  CTRL+C to â€œCopyâ€ the files, resulting in a Copy operation, the ZIP folder would not have performed a delete operation as each file was extracted. The time required to unpack the ZIP file drops  from over thirty minutes to four seconds. For perspective, 7-Zip unpacks the file in under a quarter of a second, although it  cheats a little.</p><p>å¤‡ä»½æˆ‘çš„reproæ­¥éª¤ï¼Œè¯·æ³¨æ„ï¼Œæˆ‘æŒ‰Ctrl + Xé”®â€œå‰ªåˆ‡â€æ–‡ä»¶ï¼Œä»è€Œå¯¼è‡´ç§»åŠ¨æ“ä½œã€‚å¦‚æœæˆ‘æ›¿ä»£åœ°å‡»ä¸­Ctrl + Cè¦â€œå¤åˆ¶â€æ–‡ä»¶ï¼Œå¯¼è‡´å¤åˆ¶æ“ä½œï¼ŒZIPæ–‡ä»¶å¤¹å°†ä¸æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œå› ä¸ºæå–äº†æ¯ä¸ªæ–‡ä»¶ã€‚è§£å‹ç¼©ZIPæ–‡ä»¶æ‰€éœ€çš„æ—¶é—´ä»30åˆ†é’Ÿåˆ°å››ç§’é’Ÿä¸‹é™ã€‚å¯¹äºé€è§†å›¾ï¼Œ7-zipå°†æ–‡ä»¶è§£å‹ç¼©åœ¨ä¸€ç§’é’Ÿå†…çš„ä¸€ç§’é’Ÿå†…ï¼Œå°½ç®¡å®ƒæ¬ºéª—äº†ä¸€ç‚¹ã€‚</p><p> And hereâ€™s where  the abstraction leaksâ€” from a userâ€™s point-of-view, copying files out of a ZIP file (then deleting the ZIP) vs. moving the files from a ZIP file seems like it shouldnâ€™t be very different. Unfortunately, the abstraction fails to fully paper over the reality that deleting from certain ZIP files is an extremely slow operation, while deleting a file from a disk is usually trivial. As a consequence, the Compressed Folder abstraction works well for tiny ZIPs, but fails for the larger ZIP files that are becoming increasingly common.</p><p> è¿™é‡Œæ˜¯ä»ç”¨æˆ·çš„è§†å›¾æ³„éœ²çš„åœ°æ–¹ï¼Œä»zipæ–‡ä»¶ä¸­å¤åˆ¶æ–‡ä»¶ï¼ˆç„¶ååˆ é™¤zipï¼‰ä¸zipæ–‡ä»¶ä¸­çš„æ–‡ä»¶ä¼¼ä¹ä¸åº”è¯¥æ˜¯éå¸¸ä¸åŒçš„ã€‚é—æ†¾çš„æ˜¯ï¼ŒæŠ½è±¡æ— æ³•é€šè¿‡åˆ é™¤æŸäº›ZIPæ–‡ä»¶çš„ç°å®ä¸­çš„ç°å®ä¸­çš„å®Œå…¨çº¸å¼ ï¼ŒåŒæ—¶ä»ç£ç›˜ä¸­åˆ é™¤æ–‡ä»¶é€šå¸¸æ˜¯å¾®ä¸è¶³é“çš„ã€‚å› æ­¤ï¼Œå‹ç¼©æ–‡ä»¶å¤¹æŠ½è±¡é€‚ç”¨äºå¾®å°çš„æ‹‰é“¾ï¼Œä½†å¤±è´¥çš„è¾ƒå¤§çš„ZIPæ–‡ä»¶å˜å¾—è¶Šæ¥è¶Šæ™®éã€‚</p><p> While itâ€™s relatively easy to think of ways to dramatically improve the performance of this scenario, precedent suggests that the code in Windows is unlikely to be improved anytime soon. Perhaps for its 25th Anniversary? ğŸ¤</p><p> è™½ç„¶è€ƒè™‘åˆ°å¤§å¤§æé«˜è¿™ç§æƒ…å†µçš„æ€§èƒ½çš„æ–¹æ³•ç›¸å¯¹å®¹æ˜“ï¼Œä½†æ˜¯å…ˆä¾‹è¡¨æ˜Windowsä¸­çš„ä»£ç ä¸å¤ªå¯èƒ½éšæ—¶æ”¹å–„ã€‚ä¹Ÿè®¸æ˜¯å®ƒçš„25å‘¨å¹´çºªå¿µæ—¥ï¼Ÿ ğŸ¤ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://textslashplain.com/2021/06/02/leaky-abstractions/">https://textslashplain.com/2021/06/02/leaky-abstractions/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/æ¼æ°´/">#æ¼æ°´</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/leaky/">#leaky</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/æ–‡ä»¶/">#æ–‡ä»¶</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è°·æ­Œ/">#è°·æ­Œ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>