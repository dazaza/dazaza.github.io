<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>ä½¿ç”¨Seleniumï¼ŒCronå’ŒPythonè®°å½•è™šæ‹Ÿç§æ—ç»“æœ Logging Virtual Race Results with Selenium, Cron and Python</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Logging Virtual Race Results with Selenium, Cron and Python<br/>ä½¿ç”¨Seleniumï¼ŒCronå’ŒPythonè®°å½•è™šæ‹Ÿç§æ—ç»“æœ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-18 18:25:37</div><div class="page_narrow text-break page_content"><p>Who else hates doing repetitive tasks that you know could be automated? I know I do  ğŸ™‹â€â™€ï¸. This is part two about how I used cron jobs and python to take care of â€˜the boring stuffâ€™ ( link to Part 1). In this article I will discuss how I used Stravaâ€™s API and cron jobs to automatically post new activities for virtual races on RunSignup.</p><p>è°è®¨åŒåšä½ çŸ¥é“çš„é‡å¤ä»»åŠ¡å¯ä»¥è‡ªåŠ¨åŒ–ï¼Ÿæˆ‘çŸ¥é“æˆ‘åšâ™¥ã€‚è¿™æ˜¯å…³äºæˆ‘å¦‚ä½•ä½¿ç”¨Cronä½œä¸šå’ŒPythonç…§é¡¾â€œæ— èŠçš„ä¸œè¥¿â€ï¼ˆé“¾æ¥åˆ°ç¬¬1éƒ¨åˆ†ï¼‰çš„ç¬¬äºŒéƒ¨åˆ†ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è®¨è®ºå¦‚ä½•ä½¿ç”¨stravaçš„APIå’ŒCronä½œä¸šï¼Œä»¥è‡ªåŠ¨å‘å¸ƒRunsignupä¸Šçš„è™šæ‹Ÿæ¯”èµ›çš„æ–°æ´»åŠ¨ã€‚</p><p>        Coronavirus caused all of us active outdoorsy folks to get creative about how we could continue our races. The virtual  Circumpolar Race Across the World (CRAW for short) was the one of the results. For this race you have to track all of your hikes/bikes/runs/etc and then log them online via  RunSignup.</p><p>        å† çŠ¶ç—…æ¯’å¯¼è‡´æˆ‘ä»¬æ‰€æœ‰çš„æˆ·å¤–äººå‘˜éƒ½èƒ½åˆ›é€ ç€æˆ‘ä»¬å¦‚ä½•ç»§ç»­æˆ‘ä»¬çš„æ¯”èµ›ã€‚ä¸–ç•Œä¸Šè™šæ‹Ÿçš„Circumpolarç«èµ›ï¼ˆç®€çŸ­çš„çˆ¬è¡Œï¼‰æ˜¯ç»“æœä¹‹ä¸€ã€‚å¯¹äºè¿™åœºæ¯”èµ›ï¼Œæ‚¨å¿…é¡»è·Ÿè¸ªæ‰€æœ‰å¾’æ­¥æ—…è¡Œ/è‡ªè¡Œè½¦/è¿è¡Œ/ etcï¼Œç„¶åé€šè¿‡runsignupåœ¨çº¿åœ¨çº¿è®°å½•å®ƒä»¬ã€‚</p><p>      Itâ€™s not a very long or complicated process, but I couldnâ€™t get over the feeling that it was one step too long. If Strava was already keeping track of the activities why couldnâ€™t I just have Strava tell RunSignup what I was doing instead of entering it myself?</p><p>      è¿™ä¸æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„æˆ–å¤æ‚çš„è¿‡ç¨‹ï¼Œä½†æˆ‘æ— æ³•å…‹æœå®ƒçš„æ„Ÿè§‰å¤ªé•¿äº†ã€‚å¦‚æœStravaå·²ç»è¿½è¸ªäº†è¿™äº›æ´»åŠ¨ï¼Œä¸ºä»€ä¹ˆæˆ‘ä¸èƒ½åˆšåˆšäº‰å–äº‰å¤ºç»Ÿä¸€ï¼Œè€Œä¸æ˜¯è‡ªå·±è¿›å…¥å®ƒï¼Ÿ</p><p>          In this section Iâ€™ll break down the various functions that come together to make up the python program that downloads the activities from Strava and uploads them to CRAW. They are all executed with a little bit of python glue when the file crawActivities.py is run.</p><p>          åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘å°†åˆ†è§£å„ç§å‡½æ•°ï¼Œä»¥ç»„æˆå¼¥è¡¥ä»Stravaä¸‹è½½æ´»åŠ¨çš„Pythonç¨‹åºå¹¶å°†å…¶ä¸Šä¼ åˆ°çˆ¬è¡Œã€‚å½“æ–‡ä»¶crawactivities.pyè¿è¡Œæ—¶ï¼Œå®ƒä»¬éƒ½åœ¨ç”¨ä¸€ç‚¹ç‚¹Pythonèƒ¶æ°´æ‰§è¡Œã€‚</p><p>    This function handles accessing the appâ€™s tokens.json file, which provides access to the Strava API. It checks to see if the token is expired, and calls refresh_token() to get a new token if it is.</p><p>    æ­¤åŠŸèƒ½å¤„ç†è®¿é—®åº”ç”¨ç¨‹åºçš„ä»¤ç‰Œ.JSONæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æä¾›å¯¹strava APIçš„è®¿é—®ã€‚å®ƒæ£€æŸ¥ä»¤ç‰Œæ˜¯å¦å·²è¿‡æœŸï¼Œå¹¶è°ƒç”¨refresh_tokenï¼ˆï¼‰å¦‚æœæ˜¯ï¼Œè¯·æ‹¨æ‰“æ–°ä»¤ç‰Œã€‚</p><p>      This function makes a get request to Stravaâ€™s â€˜activitiesâ€™ endpoint, which returns a json object consisting of an array of  SummaryActivity objects. There is no specific definition for this endpoint in the documentation, but it works similarly to the  â€œList Athlete Activitiesâ€ endpoint. The function uses the â€˜&amp;after=â€™ parameter to request only activities that were uploaded after the last time cron ran the program (this time is stored in the .env file and updated at the end of the program).</p><p>      æ­¤å‡½æ•°ä½¿è¯·æ±‚GETè¯·æ±‚stravaçš„â€œæ´»åŠ¨â€ç«¯ç‚¹ï¼Œè¯¥ç«¯ç‚¹è¿”å›ç”±emputeactivityå¯¹è±¡çš„æ•°ç»„ç»„æˆçš„JSONå¯¹è±¡ã€‚æ–‡æ¡£ä¸­æ­¤ç«¯ç‚¹æ²¡æœ‰å…·ä½“å®šä¹‰ï¼Œä½†å®ƒä¸â€œåˆ—å‡ºè¿åŠ¨å‘˜æ´»åŠ¨â€ç«¯ç‚¹ç±»ä¼¼ã€‚è¯¥å‡½æ•°ä½¿ç”¨'ï¼†amp; after ='å‚æ•°æ¥ä»…è¯·æ±‚åœ¨æœ€åä¸€æ¬¡Cron ran ran ran ran ran ran ran rançš„æ´»åŠ¨ï¼ˆæ­¤æ—¶é—´å­˜å‚¨åœ¨.envæ–‡ä»¶ä¸­å¹¶åœ¨ç¨‹åºç»“æŸæ—¶æ›´æ–°ï¼‰ã€‚</p><p>    The simplest way to upload all of my activities using selenium is to upload a CSV of all the data. This involved two button clicks as opposed to five plus if Selenium had to enter each value for each activity by â€˜handâ€™.</p><p>    ä½¿ç”¨Seleniumä¸Šä¼ æ‰€æœ‰æ´»åŠ¨çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä¸Šä¼ æ‰€æœ‰æ•°æ®çš„CSVã€‚å¦‚æœSeleniumå¿…é¡»é€šè¿‡â€œæ‰‹â€å°†æ¯ä¸ªæ´»åŠ¨è¾“å…¥æ¯ä¸ªæ´»åŠ¨ï¼Œåˆ™è¿™ä¸¤ä¸ªæŒ‰é’®ç‚¹å‡»ï¼Œè€Œä¸æ˜¯äº”åŠ ã€‚ </p><p>  If the json object returned by Strava is not empty and there are new activities to upload, this function handles putting the data in a the CSV. It takes the json object returned by Strava and uses csv.DictWriter to write the date, distance and type of activity out to a CSV (ignoring all the other data points). This function also reformats this data a bit to match the format required by RunSignup.</p><p>å¦‚æœstravaè¿”å›çš„JSONå¯¹è±¡ä¸æ˜¯ç©ºçš„ï¼Œå¹¶ä¸”æœ‰æ–°çš„æ´»åŠ¨ä¸Šä¼ ï¼Œåˆ™æ­¤åŠŸèƒ½å°†æ•°æ®æ”¾åœ¨CSVä¸­ã€‚å®ƒéœ€è¦Stravaè¿”å›çš„JSONå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨CSV.DictWriterå°†æ´»åŠ¨çš„æ—¥æœŸï¼Œè·ç¦»å’Œç±»å‹å†™å…¥CSVï¼ˆå¿½ç•¥æ‰€æœ‰å…¶ä»–æ•°æ®ç‚¹ï¼‰ã€‚æ­¤åŠŸèƒ½è¿˜é‡æ–°æ ¼å¼åŒ–æ­¤æ•°æ®ä¸€éƒ¨åˆ†ä»¥åŒ¹é…RunSignupæ‰€éœ€çš„æ ¼å¼ã€‚</p><p>    Hereâ€™s where the magic happens. Selenium is essentially a series of finding an element  via various methods (your web browserâ€™s developer tools will be helpful for this) and then doing something with the element. This function opens up a Chrome web browser instance, navigates to the CRAW activity upload page, authenticates, uploads the activity CSV and checks to see if the upload was successful.</p><p>    è¿™æ˜¯é­”æ³•å‘ç”Ÿçš„åœ°æ–¹ã€‚ SeleniumåŸºæœ¬ä¸Šæ˜¯ä¸€ç³»åˆ—é€šè¿‡å„ç§æ–¹æ³•æŸ¥æ‰¾å…ƒç´ ï¼ˆæ‚¨çš„Webæµè§ˆå™¨çš„å¼€å‘äººå‘˜å·¥å…·å¯¹æ­¤æœ‰æ‰€å¸®åŠ©ï¼‰ï¼Œç„¶åç”¨å…ƒç´ åšç‚¹ä»€ä¹ˆã€‚æ­¤å‡½æ•°æ‰“å¼€äº†Chrome Webæµè§ˆå™¨å®ä¾‹ï¼Œå¯¼èˆªåˆ°Craw Activity Uploadé¡µé¢ï¼ŒéªŒè¯ï¼Œä¸Šä¼ æ´»åŠ¨CSVå¹¶æ£€æŸ¥ä¸Šä¼ æ˜¯å¦æˆåŠŸã€‚</p><p>  I think itâ€™d be helpful to see the actual code, Iâ€™ve added lots of comments to help clarify what each bit is doing:</p><p>  æˆ‘è®¤ä¸ºçœ‹åˆ°å®é™…ä»£ç æœ‰æ‰€å¸®åŠ©ï¼Œæˆ‘æ·»åŠ äº†å¾ˆå¤šè¯„è®ºï¼Œä»¥å¸®åŠ©æ¾„æ¸…æ¯ä¸€ä½æ­£åœ¨åšçš„äº‹æƒ…ï¼š</p><p>        This function runs at the end of the program and it updates the date of last upload in .env file to the current date and time. By keeping track of when the upload last ran, I make sure to only upload new activities.</p><p>        æ­¤å‡½æ•°åœ¨ç¨‹åºçš„æœ«å°¾è¿è¡Œï¼Œå¹¶ä¸”å®ƒå°†ä¸Šä¼ çš„æ—¥æœŸæ›´æ–°ä¸º.envæ–‡ä»¶åˆ°å½“å‰æ—¥æœŸå’Œæ—¶é—´ã€‚é€šè¿‡è·Ÿè¸ªä¸Šä¼ æœ€åä¸€æ¬¡ranæ—¶ï¼Œæˆ‘ç¡®ä¿åªä¸Šä¼ æ–°æ´»åŠ¨ã€‚</p><p>          My cron job executes the above python script everyday at 9:01 am, provided that my laptop is on and active. Setting the cron job up is quite simple. Merely run â€˜crontab -eâ€™ in your command prompt and then add the following line of code to the file:</p><p>          æˆ‘çš„Cronä½œä¸šæ¯å¤©åœ¨ä¸Šåˆ9:01åœ¨ä¸Šåˆ9:01æ‰§è¡Œä¸Šè¿°Pythonè„šæœ¬ï¼Œåªè¦æˆ‘çš„ç¬”è®°æœ¬ç”µè„‘äº®èµ·ã€‚è®¾ç½®Cron Job Upéå¸¸ç®€å•ã€‚ä»…åœ¨å‘½ä»¤æç¤ºç¬¦ä¸­è¿è¡Œ'crontab -e'ï¼Œç„¶åå°†ä»¥ä¸‹ä»£ç è¡Œæ·»åŠ åˆ°æ–‡ä»¶ä¸­ï¼š</p><p>      â€˜1 9 * * *â€™ tells cron to run this program at 9:01 am everyday.  Learn more about how to tell cron when to run your program.  /Users/kellyfoulk/Documents/code/crawUpload/cron.sh is  the file (a bash script) that cron will run at the time listed above. &gt;&gt; /Users/kellyfoulk/Documents/code/crawUpload/cronlog.txt 2&gt;&amp;1 tells cron to send any program output (ie errors, printed statements, etc). I have the output being sent to a file cronlog.txt which is stored in the same folder as my application.</p><p>      '1 9 * * *'å‘Šè¯‰Cronæ¯å¤©ä¸Šåˆ9:01è¿è¡Œè¿™ä¸ªç¨‹åºã€‚äº†è§£æœ‰å…³å¦‚ä½•åˆ¤æ–­Cronä½•æ—¶è¿è¡Œç¨‹åºçš„æ›´å¤šä¿¡æ¯ã€‚ /users/kellyfoulk/documents/code/crawupload/cron.shæ˜¯Cronåœ¨ä¸Šé¢åˆ—å‡ºçš„æ—¶é—´è¿è¡Œçš„æ–‡ä»¶ï¼ˆbashè„šæœ¬ï¼‰ã€‚ ï¼†gt;ï¼†gt; /users/kellyfoulk/documents/code/crawupload/cronlog.txt 2ï¼†gt;ï¼†amp; 1å‘Šè¯‰cronå‘é€ä»»ä½•ç¨‹åºè¾“å‡ºï¼ˆå³é”™è¯¯ï¼Œæ‰“å°è¯­å¥ç­‰ï¼‰ã€‚æˆ‘å°†è¾“å‡ºå‘é€åˆ°æ–‡ä»¶cronlog.txtï¼Œå®ƒå­˜å‚¨åœ¨ä¸æˆ‘çš„åº”ç”¨ç¨‹åºç›¸åŒçš„æ–‡ä»¶å¤¹ä¸­ã€‚</p><p>    Letâ€™s talk a bit more about that bash script cron runs. Itâ€™s a simple script that activates the virtual environment, runs  crawActivities.py (the python script), and then deactivates the virtual environment. This script also tells the crontab where to find my ChromeDriver download. This is what the script looks like:</p><p>    è®©æˆ‘ä»¬æ›´å¤šåœ°è°ˆè°ˆBashè„šæœ¬Cronè¿è¡Œã€‚å®ƒæ˜¯ä¸€ä¸ªæ¿€æ´»è™šæ‹Ÿç¯å¢ƒçš„ç®€å•è„šæœ¬ï¼Œè¿è¡Œcrawactivities.pyï¼ˆpythonè„šæœ¬ï¼‰ï¼Œç„¶åå–æ¶ˆæ¿€æ´»è™šæ‹Ÿç¯å¢ƒã€‚æ­¤è„šæœ¬è¿˜å‘Šè¯‰CRONTABåœ¨å“ªé‡Œå¯ä»¥æŸ¥æ‰¾æˆ‘çš„æ‰«æç¨‹åºä¸‹è½½ã€‚è¿™æ˜¯è„šæœ¬çš„æ ·å­ï¼š </p><p>      Setting up Selenium and making sure it could access my ChromeDriver download was a bit finicky, but all in all this was a fun project that made me feel like a wizard and saves me approximately five minutes every night.</p><p>è®¾ç½®ç¡’å¹¶ç¡®ä¿å®ƒå¯ä»¥è®¿é—®æˆ‘çš„é“¬ä»£ç¨‹åºä¸‹è½½æœ‰ç‚¹æŒ‘å‰”ï¼Œä½†ä¸€åˆ‡éƒ½æ˜¯ä¸€ä¸ªæœ‰è¶£çš„é¡¹ç›®ï¼Œè®©æˆ‘è§‰å¾—è‡ªå·±è§‰å¾—å·«å¸ˆå¹¶æ¯æ™šæ‹¯æ•‘æˆ‘å¤§çº¦äº”åˆ†é’Ÿã€‚ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://kellyfoulk.herokuapp.com/post/7">https://kellyfoulk.herokuapp.com/post/7</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/python/">#python</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/selenium/">#selenium</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/virtual/">#virtual</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/æ´»åŠ¨/">#æ´»åŠ¨</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ†äº«/">#åˆ†äº«</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>