<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>å…³äºé‡æ„çš„çŸ­æš‚è­¦ç¤ºæ•…äº‹ A Short Cautionary Tale About Refactoring</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">A Short Cautionary Tale About Refactoring<br/>å…³äºé‡æ„çš„çŸ­æš‚è­¦ç¤ºæ•…äº‹ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-21 14:06:31</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/3/e2b2adc539c7a6c9bc9e2f20a9dea37a.png"><img src="http://img2.diglog.com/img/2021/3/e2b2adc539c7a6c9bc9e2f20a9dea37a.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>This week I was making changes in a part of the codebase I was unfamiliar with. While reading the code I spotted an inlined PNG image. This was not a small icon but an image of about 100kb in size. I searched the project and found the same inlined image in a couple of different components. Maybe it was because I was in a need of some coffee, but at that moment I could not think of a good reason for this approach. As the components with the inline image were quite similar, I surmised that they were copied from each other and the inline image is just one of those weird things that you find in legacy code.</p><p>æœ¬å‘¨æˆ‘æ­£åœ¨åˆ¶å®šç Baseçš„ä¸€éƒ¨åˆ†çš„å˜åŒ–ï¼Œæˆ‘ä¸ç†Ÿæ‚‰ã€‚è¯»å–ä»£ç æ—¶ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªå†…è”çš„PNGå›¾åƒã€‚è¿™ä¸æ˜¯ä¸€ä¸ªå°å›¾æ ‡ï¼Œä½†å¤§å°çº¦ä¸º100kbçš„å›¾åƒã€‚æˆ‘æœç´¢äº†è¯¥é¡¹ç›®ï¼Œå¹¶åœ¨å‡ ä¸ªä¸åŒçš„ç»„ä»¶ä¸­æ‰¾åˆ°äº†ç›¸åŒçš„å†…è”å›¾åƒã€‚ä¹Ÿè®¸æ˜¯å› ä¸ºæˆ‘éœ€è¦ä¸€äº›å’–å•¡ï¼Œä½†åœ¨é‚£ä¸€åˆ»ï¼Œæˆ‘æ— æ³•æƒ³åˆ°è¿™ç§æ–¹æ³•çš„å¥½ç†ç”±ã€‚ç”±äºå†…è”å›¾åƒçš„ç»„ä»¶éå¸¸ç›¸ä¼¼ï¼Œæˆ‘çŒœæµ‹å®ƒä»¬å½¼æ­¤å¤åˆ¶ï¼Œå†…è”å›¾åƒåªæ˜¯æ‚¨åœ¨é—ç•™ä»£ç ä¸­æ‰¾åˆ°çš„é‚£äº›å¥‡æ€ªçš„äº‹æƒ…ä¹‹ä¸€ã€‚</p><p> I decoded the embedded image from Base64 and created a separate PNG file from it. The final step was to replace the inlined image source with a relative path to the new image file. The diff for the commit was almost perfect: large red blocks of deleted code and just a few green lines of added code. A quick and easy refactoring win and a textbook example of the  boy scout rule. Or so I thought.</p><p> æˆ‘ä»Base64è§£ç äº†åµŒå…¥å¼å›¾åƒï¼Œå¹¶ä»ä¸­åˆ›å»ºå•ç‹¬çš„PNGæ–‡ä»¶ã€‚æœ€åä¸€æ­¥æ˜¯ç”¨æ–°å›¾åƒæ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„æ›¿æ¢å¸¦å†…çº¿çš„å›¾åƒæºã€‚è¯¥æäº¤çš„å·®å¼‚å‡ ä¹æ˜¯å®Œç¾çš„ï¼šåˆ é™¤ä»£ç çš„å¤§çº¢è‰²å—ï¼Œåªæœ‰å‡ æ¡ç»¿çº¿çš„æ·»åŠ ä»£ç ã€‚ä¸€ä¸ªå¿«é€Ÿç®€ä¾¿çš„é‡æ„èƒœåˆ©å’Œç”·æ€§ä¾¦å¯Ÿè§„åˆ™çš„æ•™ç§‘ä¹¦ç¤ºä¾‹ã€‚æˆ–è€…æˆ‘æƒ³ã€‚</p><p> I took a short break and grabbed some much-needed coffee. Fast forward a few hours and I completed the task that I was originally working on. I was in the final stages of testing when I noticed a bug. At that same moment, I also realized the exact purpose of the inlined image. Can you guess?</p><p> æˆ‘ä¼‘æ¯ä¸€ä¸‹ï¼ŒæŠ“ä½äº†ä¸€äº›éœ€è¦çš„å’–å•¡ã€‚å¿«è¿›å‡ ä¸ªå°æ—¶ï¼Œæˆ‘å®Œæˆäº†æˆ‘æœ€åˆå·¥ä½œçš„ä»»åŠ¡ã€‚å½“æˆ‘æ³¨æ„åˆ°ä¸€ä¸ªé”™è¯¯æ—¶ï¼Œæˆ‘æ˜¯åœ¨æµ‹è¯•çš„æœ€åé˜¶æ®µã€‚åœ¨é‚£ä¸ªåŒä¸€æ—¶åˆ»ï¼Œæˆ‘ä¹Ÿæ„è¯†åˆ°å†…è”å›¾åƒçš„ç¡®åˆ‡ç›®çš„ã€‚çŒœä¸€ä¸‹ï¼Ÿ</p><p> To give you more context, we use the components with the image to display error messages. The image is a cute illustration of the company mascot with the expression â€œOops something went wrongâ€. One of the possible errors that can happen, is when the user losses their connection or goes offline. So when that happens and you render a component that still needs to download an image, the image will fail to load. Oh yeahâ€¦ ğŸ¤¦â€â™‚ï¸</p><p> è¦ä¸ºæ‚¨æä¾›æ›´å¤šçš„ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸å›¾åƒçš„ç»„ä»¶æ˜¾ç¤ºä¸ºæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ã€‚è¿™å¼ ç…§ç‰‡æ˜¯å…¬å¸å‰ç¥¥ç‰©çš„å¯çˆ±æ’å›¾ï¼Œè¡¨è¾¾äº†â€œå“å‘€å‡ºäº†é—®é¢˜â€ã€‚å¯èƒ½å‘ç”Ÿçš„å¯èƒ½æ€§ä¹‹ä¸€ï¼Œæ˜¯ç”¨æˆ·ä¸¢å¤±å®ƒä»¬çš„è¿æ¥æˆ–è„±æœºã€‚å› æ­¤ï¼Œå½“å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼Œæ¸²æŸ“ä»ç„¶éœ€è¦ä¸‹è½½å›¾åƒçš„ç»„ä»¶ï¼Œå›¾åƒå°†æ— æ³•åŠ è½½ã€‚å“¦ï¼Œæ˜¯çš„......â™¥</p><p> I thought I had learned the hard way earlier in my career not to presume I know better than the original author. Of course, there are situations where a less experienced coder (ie. yourself from a couple of years ago) worked on a feature or where someone had to cut corners (eg. due to a deadline). But usually, there is a good reason why someone took the approach that they did.</p><p> æˆ‘ä»¥ä¸ºæˆ‘åœ¨èŒä¸šç”Ÿæ¶¯ä¸­æ—©äº›æ—¶å€™å·²ç»å­¦åˆ°äº†è‰°éš¾çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯å‡è®¾æˆ‘çŸ¥é“æ¯”åŸä½œè€…æ›´äº†è§£ã€‚å½“ç„¶ï¼Œæœ‰ä¸€ä¸ªç»éªŒä¸°å¯Œçš„ç¼–ç å™¨ï¼ˆå³ï¼Œæ¥è‡ªå‡ å¹´å‰çš„è‡ªå·±ï¼‰åœ¨ä¸€ä¸ªç‰¹å¾æˆ–æŸäººä¸å¾—ä¸å‰Šå‡è§’è½çš„æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚ï¼Œä»äº‹æˆªæ­¢æ—¥æœŸï¼‰ã€‚ä½†é€šå¸¸æƒ…å†µä¸‹ï¼Œæœ‰ä¸€ä¸ªå……æ»¡åŸå› çš„äººä¸ºä»€ä¹ˆæœ‰äººé‡‡å–äº†ä»–ä»¬æ‰€åšçš„æ–¹æ³•ã€‚</p><p> Luckily I spotted the issue before I pushed my branch. I could use  git reset --soft and alter my changes. I extracted the inlined image into a separate React component and used it where needed. This way we still get both benefits: the error components are much cleaner and easier to read, and the inlined image is located in one place. After that, I reapplied all the other commits. The Git history was clean and none of my coworkers were the wiser. Unless they are reading this, in which case: â€œOh hey, howâ€™s it going?â€Â  ğŸ˜…</p><p> å¹¸è¿çš„æ˜¯ï¼Œåœ¨æˆ‘æ¨åŠ¨åˆ†å…¬å¸ä¹‹å‰ï¼Œæˆ‘å‘ç°äº†è¿™ä¸ªé—®é¢˜ã€‚æˆ‘å¯ä»¥ä½¿ç”¨git reset --softå¹¶æ”¹å˜æˆ‘çš„æ›´æ”¹ã€‚æˆ‘å°†ç¯åˆ—çš„å›¾åƒæå–åˆ°å•ç‹¬çš„ååº”ç»„ä»¶ä¸­å¹¶åœ¨éœ€è¦æ—¶ä½¿ç”¨å®ƒã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ä»ç„¶è·å¾—ä¸¤ä¸ªå¥½å¤„ï¼šé”™è¯¯ç»„ä»¶æ˜¯æ›´æ¸…æ™°çš„æ›´æ¸…æ™°ï¼Œæ›´å®¹æ˜“è¯»å–ï¼Œå†…è¡¬å›¾åƒä½äºä¸€ä¸ªåœ°æ–¹ã€‚ä¹‹åï¼Œæˆ‘é‡æ–°ç”³è¯·äº†æ‰€æœ‰å…¶ä»–ç½ªè¡Œã€‚ Gitå†å²å¾ˆå¹²å‡€ï¼Œæˆ‘çš„åŒäº‹éƒ½ä¸æ˜¯æ›´èªæ˜ã€‚é™¤éä»–ä»¬æ­£åœ¨é˜…è¯»è¿™ä¸€ç‚¹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼šâ€œå“¦ï¼Œå˜¿ï¼Œæ€ä¹ˆæ ·ï¼Ÿâ€ ğŸ˜…</p><p> I know, this bug would not be the end of the world. But this small example shows how even the best of our refactoring intentions can do more harm than good. If you find yourself looking at a piece of code that looks strange or needlessly too complex, ask your coworkers. This is especially true if the original author is still at the company. You might be missing some context and youâ€™ll get to learn something new. Or you can indeed improve the code, in which case the original author may learn the better approach. In both cases, itâ€™s a win. Also if there is a good reason for the current approach, document it. Add a more descriptive name or a comment to avoid confusion in the future.</p><p> æˆ‘çŸ¥é“ï¼Œè¿™ä¸ªè™«å­ä¸ä¼šæˆä¸ºä¸–ç•Œçš„å°½å¤´ã€‚ä½†è¿™ä¸ªå°çš„ä¾‹å­è¡¨æ˜ï¼Œå³ä½¿æ˜¯æˆ‘ä»¬çš„é‡æ„æ„å›¾ä¹Ÿæœ‰å¤šå¼Šå¤§äºè‰¯å¥½ã€‚å¦‚æœæ‚¨å‘ç°è‡ªå·±çœ‹ä¸€æ®µçœ‹èµ·æ¥å¾ˆå¥‡æ€ªæˆ–ä¸å¿…è¦çš„ä»£ç ï¼Œè¯·è¯¢é—®æ‚¨çš„åŒäº‹ã€‚å¦‚æœåŸä½œè€…ä»ç„¶åœ¨å…¬å¸ï¼Œè¿™å°¤å…¶å¦‚æ­¤ã€‚æ‚¨å¯èƒ½ç¼ºå°‘ä¸€äº›ä¸Šä¸‹æ–‡ï¼Œæ‚¨å°†è·å¾—æ–°çš„ä¸œè¥¿ã€‚æˆ–è€…æ‚¨å¯ä»¥ç¡®å®å¯ä»¥æ”¹è¿›ä»£ç ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸä½œè€…å¯èƒ½ä¼šå­¦åˆ°æ›´å¥½çš„æ–¹æ³•ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ªèƒœåˆ©ã€‚æ­¤å¤–ï¼Œå¦‚æœç›®å‰çš„æ–¹æ³•æœ‰å¾ˆå¥½çš„ç†ç”±ï¼Œè¯·è®°å½•å®ƒã€‚æ·»åŠ æ›´å¤šæè¿°æ€§åç§°æˆ–è¯„è®ºä»¥é¿å…å°†æ¥æ··æ·†ã€‚ </p><p> Learn from my small mistake and research before making refactorings. This is 10 times more important for larger changes and when editing the core files of the project. And the most important thing: donâ€™t forget to drink some coffee before starting.</p><p>åœ¨åˆ¶ä½œé‡æ„ä¹‹å‰ä»æˆ‘çš„å°é”™è¯¯å’Œç ”ç©¶ä¸­å­¦ä¹ ã€‚ å¯¹äºæ›´å¤§çš„å˜åŒ–ä»¥åŠç¼–è¾‘é¡¹ç›®çš„æ ¸å¿ƒæ–‡ä»¶æ—¶ï¼Œè¿™æ˜¯10å€ã€‚ æœ€é‡è¦çš„æ˜¯ï¼šåœ¨å¼€å§‹ä¹‹å‰åˆ«å¿˜äº†å–ç‚¹å’–å•¡ã€‚ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://zigamiklic.com/cautionary-tale/">https://zigamiklic.com/cautionary-tale/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/è­¦ç¤º/">#è­¦ç¤º</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/å›¾åƒ/">#å›¾åƒ</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ†äº«/">#åˆ†äº«</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>