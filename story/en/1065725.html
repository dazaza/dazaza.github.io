<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>ç›‘æµ‹å‰ä½“çš„TRNGSçš„å¥åº· Monitoring the Health of Precursorâ€™s TRNGs</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Monitoring the Health of Precursorâ€™s TRNGs<br/>ç›‘æµ‹å‰ä½“çš„TRNGSçš„å¥åº· </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-15 02:39:06</div><div class="page_narrow text-break page_content"><p>This post is an abridged version of a  longer-form narrative on implementing health monitoring for Precursor/Betrustedâ€™s TRNGs. Itâ€™s the first of a series of two posts; the second, on implementing a CSPRNG conditioner for the TRNG, will go up later.</p><p>è¿™ç¯‡æ–‡ç« æ˜¯å…³äºå‰ä½“/å¾·å ¡TRNGçš„å¥åº·ç›‘æµ‹çš„æ›´é•¿å½¢å¼å™äº‹çš„é”€è¯·ã€‚è¿™æ˜¯ä¸¤ä¸ªå¸–å­çš„ç¬¬ä¸€ä¸ª;ç¬¬äºŒï¼Œå…³äºä¸ºTRNGå®æ–½CSPRNGè°ƒèŠ‚å™¨ï¼Œå°†åœ¨ä»¥åä¸Šå‡ã€‚</p><p>  Online health monitors are simple statistical tests that give users an indication of the quality of the entropy being produced. On-line health tests are like a tachometer on an engine: they give an indication of overall health, and can detect when something fails spectacularly; but they canâ€™t tell you if an engine is designed correctly. Thus, they are complimentary to longer-running, rigorous diagnostic tests. We cover some of these tests  at our wiki, plus we have a CI bench which generates gigabytes of raw entropy, over runtimes measured in months, that is run through a series of proofing tools, such as the Dieharder test suite and the NIST STS test suite.</p><p>  åœ¨çº¿å¥åº·ç›‘è§†å™¨æ˜¯ç®€å•çš„ç»Ÿè®¡æµ‹è¯•ï¼Œä½¿ç”¨æˆ·èƒ½å¤ŸæŒ‡ç¤ºæ­£åœ¨ç”Ÿäº§çš„ç†µçš„è´¨é‡ã€‚åœ¨çº¿å¥åº·æµ‹è¯•å°±åƒå‘åŠ¨æœºä¸Šçš„è½¬é€Ÿè¡¨ï¼šå®ƒä»¬ä¼šå‘ˆç°æ•´ä½“å¥åº·çŠ¶å†µï¼Œå¹¶å¯ä»¥æ£€æµ‹æŸäº›ä¸œè¥¿ä½•æ—¶é—»å;ä½†æ˜¯ä»–ä»¬ä¸èƒ½å‘Šè¯‰ä½ å‘åŠ¨æœºæ˜¯å¦æ­£ç¡®è®¾è®¡ã€‚å› æ­¤ï¼Œå®ƒä»¬æ˜¯äº’æƒ äº’åŠ¨ï¼Œä¸¥è°¨çš„è¯Šæ–­æµ‹è¯•ã€‚æˆ‘ä»¬æ¶µç›–äº†æˆ‘ä»¬çš„ç»´åŸºä¸Šçš„ä¸€äº›æµ‹è¯•ï¼ŒåŠ ä¸Šæˆ‘ä»¬æœ‰ä¸€ä¸ªCIæ›¿è¡¥è„šï¼Œå®ƒäº§ç”Ÿäº†å·¨å¤§çš„åŸå§‹ç†µï¼Œåœ¨æ•°æœˆä¸­æµ‹é‡çš„è¿è¡Œæ—¶é—´ï¼Œè¿™æ˜¯ä¸€ç³»åˆ—æ‰“æ ·å·¥å…·ï¼Œå¦‚Dieharderæµ‹è¯•å¥—ä»¶å’ŒNIST STSæµ‹è¯•å¥—æˆ¿ã€‚</p><p> Itâ€™s important that the health monitoring happens before any conditioning or mixing of the raw data happens, and significantly, there is no one-size-fits-all health monitor for a TRNG: itâ€™s even advised by the ( NIST SP 800-90B sec 4.4) specification to have tests that are tailored to the noise source.</p><p> é‡è¦çš„æ˜¯ï¼Œåœ¨åŸå§‹æ•°æ®å‘ç”Ÿçš„ä»»ä½•è°ƒç†æˆ–æ··åˆä¹‹å‰ï¼Œéƒ½ä¼šå‘ç”Ÿå¥åº·ç›‘æµ‹ï¼Œå¹¶ä¸”æ˜¾ç€åœ°ï¼Œæ²¡æœ‰ä¸€ä¸ªäººçš„å¥åº·ç›‘è§†å™¨å¯¹äºTRNGï¼šå®ƒç”šè‡³å»ºè®®ï¼ˆNIST SP 800-90B SEC 4.4è§„èŒƒè¦å…·æœ‰å¯¹å™ªå£°æºé‡èº«å®šåˆ¶çš„æµ‹è¯•ã€‚</p><p>  The first thing I do before doing any changes is some book research. As my graduate advisor,  Tom Knight, used to say, â€œDid you know you could save a whole afternoon in the library by spending two weeks at the lab bench?â€</p><p>  æˆ‘åœ¨åšä»»ä½•æ›´æ”¹ä¹‹å‰çš„ç¬¬ä¸€ä»¶äº‹æ˜¯ä¸€äº›ä¹¦ç±ç ”ç©¶ã€‚ä½œä¸ºæˆ‘çš„ç ”ç©¶ç”Ÿé¡¾é—®ï¼Œå¤éª‘å£«ï¼Œæ›¾ç»è¯´è¿‡ï¼Œâ€œä½ çŸ¥é“ä½ å¯ä»¥é€šè¿‡åœ¨å®éªŒå®¤é•¿å‡³ä¸Šæ”¯å‡ºä¸¤ä¸ªæ˜ŸæœŸçš„å›¾ä¹¦é¦†åœ¨å›¾ä¹¦é¦†ä¸­æ‹¯æ•‘æ•´ä¸ªä¸‹åˆå—ï¼Ÿâ€</p><p> NIST SP 800-90B section 4.4 specifies some health tests. The NIST spec seems to be fairly well regarded, so Iâ€™ll use this as a starting point for our tests. The tests come with the caveat that they only detect catastrophic failures in the TRNGs; they are no substitute for a very detailed, long-run statistical analysis of the TRNG outputs at the design phase (which we have already done). NIST recommends two tests: a repetition count test, and an adaptive proportion test.</p><p> NIST SP 800-90Bç¬¬4.4èŠ‚è§„å®šäº†ä¸€äº›å¥åº·æµ‹è¯•ã€‚ NISTè§„èŒƒä¼¼ä¹ç›¸å½“å¥½ï¼Œæ‰€ä»¥æˆ‘å°†ç”¨å®ƒä½œä¸ºæµ‹è¯•çš„èµ·ç‚¹ã€‚è¯¥æµ‹è¯•å…·æœ‰è­¦å‘Šï¼Œå³ä»–ä»¬åªæ£€æµ‹TRNGSä¸­çš„ç¾éš¾æ€§å¤±è´¥;å®ƒä»¬ä¸æ›¿ä»£å¯¹è®¾è®¡é˜¶æ®µçš„TRNGäº§å‡ºçš„éå¸¸è¯¦ç»†ï¼Œé•¿æœŸçš„ç»Ÿè®¡åˆ†æï¼ˆæˆ‘ä»¬å·²ç»å®Œæˆäº†ï¼‰ã€‚ NISTå»ºè®®è¿›è¡Œä¸¤æ¬¡æµ‹è¯•ï¼šé‡å¤è®¡æ•°æµ‹è¯•å’Œè‡ªé€‚åº”æ¯”ä¾‹æµ‹è¯•ã€‚</p><p>         OK, so now we know the tests. What do these even  mean in the context of our TRNGs?</p><p>         å¥½çš„ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬çŸ¥é“æµ‹è¯•ã€‚åœ¨æˆ‘ä»¬çš„TRNGSçš„èƒŒæ™¯ä¸‹ï¼Œè¿™äº›ç”šè‡³æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</p><p>  Our Ring Oscillator architecture consists of 33 independent ring oscillators that operate in two phases. In the first phase, the rings oscillate independently of each other to collect phase noise; the state of each ring is XORâ€™d into a state bit through snapshots taken at regular intervals. In a second phase, they are merged into a single large ring oscillator, where they then have to reach a consensus. A single bit is taken from the consensus oscillator, and progressively shifted into the state of the ring oscillator.</p><p>  æˆ‘ä»¬çš„ç¯å½¢æŒ¯è¡å™¨æ¶æ„ç”±33ä¸ªç‹¬ç«‹ç¯å½¢æŒ¯è¡å™¨ç»„æˆï¼Œå¯åˆ†ä¸¤çœ‹ã€‚åœ¨ç¬¬ä¸€é˜¶æ®µä¸­ï¼Œç¯æŒ¯è¡åœ°å½¼æ­¤ç‹¬ç«‹åœ°æ”¶é›†ç›¸ä½å™ªå£°;æ¯ä¸ªç¯çš„çŠ¶æ€é€šè¿‡å®šæœŸæ‹æ‘„çš„å¿«ç…§è¿›å…¥çŠ¶æ€ä½ã€‚åœ¨ç¬¬äºŒé˜¶æ®µï¼Œå®ƒä»¬è¢«åˆå¹¶åˆ°å•ä¸ªå¤§ç¯æŒ¯è¡å™¨ä¸­ï¼Œç„¶åå®ƒä»¬å¿…é¡»è¾¾åˆ°å…±è¯†ã€‚ä»å…±è¯†æŒ¯è¡å™¨æ‹æ‘„å•ä¸ªæ¯”ç‰¹ï¼Œå¹¶é€æ¸ç§»åŠ¨åˆ°ç¯å½¢æŒ¯è¡å™¨çš„çŠ¶æ€ã€‚ </p><p>  Above is a simplified â€œtwo bitâ€ version of the generator, where instead of 33 oscillators we have 3, and instead of 32 bits of entropy we get 2. The red arrow is the flow of entropy in the first phase, and the green arrow is the flow of entropy in the second phase. The two phases are repeated N+1 bit times (33 times in the full implementation, 3 times in the simplified diagram above).</p><p>ä¸Šé¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„â€œä¸¤ä½â€ç‰ˆæœ¬çš„å‘ç”µæœºï¼Œè€Œä¸æ˜¯33ä¸ªæŒ¯è¡å™¨æˆ‘ä»¬æœ‰3ä¸ªï¼Œè€Œä¸æ˜¯32ä½æˆ‘ä»¬å¾—åˆ°2.çº¢è‰²ç®­å¤´æ˜¯ç¬¬ä¸€é˜¶æ®µçš„ç†µæµï¼Œè€Œç»¿è‰²ç®­å¤´æ˜¯ç†µçš„æµåŠ¨æ˜¯ç¬¬äºŒé˜¶æ®µçš„ç†µæµã€‚ä¸¤é˜¶æ®µé‡å¤n + 1ä½æ¬¡æ•°ï¼ˆåœ¨å®Œæ•´å®æ–½çš„33æ¬¡ï¼Œä¸Šå›¾ä¸­çš„ç®€åŒ–å›¾ä¸­çš„3æ¬¡ï¼‰ã€‚</p><p>  Random phase accumulated in the smaller ring oscillators due to the accumulation of phase noise during a â€œdwellâ€ phase that can be set by software (nominally 1000 ns)</p><p>  ç”±äºåœ¨å¯ä»¥ç”±è½¯ä»¶è®¾å®šçš„â€œåœç•™â€é˜¶æ®µï¼Œç´¯ç§¯ç›¸ä½å™ªå£°çš„è¾ƒå°ç¯æŒ¯è¡å™¨ä¸­ç´¯ç§¯çš„éšæœºç›¸ä½ï¼ˆåä¹‰ä¸Š1000nsï¼‰</p><p> Decision noise associated with the sampling jitter of the smaller ring oscillators with an initial sampling flip-flop. Note that the ring oscillators operate at a higher frequency (~300-500MHz) than the sampling rate of the flip flops (100 MHz).</p><p> ä¸è¾ƒå°ç¯æŒ¯è¡å™¨çš„é‡‡æ ·æŠ–åŠ¨ç›¸å…³è”çš„å†³ç­–å™ªå£°ï¼Œå…·æœ‰åˆå§‹é‡‡æ ·è§¦å‘å™¨ã€‚è¯·æ³¨æ„ï¼Œç¯å½¢æŒ¯è¡å™¨ä»¥æ¯”è§¦å‘å™¨ï¼ˆ100MHzï¼‰çš„é‡‡æ ·ç‡æ›´é«˜çš„é¢‘ç‡ï¼ˆã€œ300-500MHzï¼‰æ“ä½œã€‚</p><p> Global phase accumulated during the consensus process of the larger ring oscillator. The time to achieve consensus is set by a â€œdelayâ€ parameter that is set by software (nominally 40ns)</p><p> å…¨å±€é˜¶æ®µåœ¨è¾ƒå¤§ç¯æŒ¯è¡å™¨çš„å…±è¯†è¿‡ç¨‹ä¸­ç´¯ç§¯ã€‚å®ç°å…±è¯†çš„æ—¶é—´ç”±è½¯ä»¶è®¾ç½®çš„â€œå»¶è¿Ÿâ€å‚æ•°è®¾ç½®ï¼ˆåä¹‰ä¸Šæ˜¯40nsï¼‰</p><p> Cross-element mixing through the continuous shifting of bits to the right, and further XORâ€™ing of phase</p><p> é€šè¿‡å¯¹å³ä¾§çš„è¿ç»­ç§»ä½çš„äº¤å‰å…ƒä»¶æ··åˆï¼Œä»¥åŠç›¸ä½çš„è¿›ä¸€æ­¥xor</p><p> The global phase consensus and cross-element mixing is quite important because ring oscillators have a tendency to couple and phase-lock due to crosstalk side-channels on both signal and power. In this architecture, each ringâ€™s local noise conditions, including its crosstalk, is applied across each of the 32 output bits; and each ringâ€™s oscillation is â€œresetâ€ with an arbitrary starting value between each cross-element phase.</p><p> å…¨å±€é˜¶æ®µå…±è¯†å’Œäº¤å‰å…ƒä»¶æ··åˆéå¸¸é‡è¦ï¼Œå› ä¸ºç¯æŒ¯è¡å™¨ç”±äºä¿¡å·å’ŒåŠŸç‡ä¸Šçš„ä¸²æ‰°ä¾§é€šé“è€Œå…·æœ‰è€¦åˆå’Œç›¸ä½é”çš„è¶‹åŠ¿ã€‚åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œæ¯ä¸ªç¯çš„å±€éƒ¨å™ªå£°æ¡ä»¶ï¼ˆåŒ…æ‹¬å…¶ä¸²æ‰°ï¼‰åº”ç”¨äº32ä¸ªè¾“å‡ºä½ä¸­çš„æ¯ä¸€ä¸ª;æ¯ä¸ªç¯çš„æŒ¯è¡éƒ½æ˜¯â€œå¤ä½â€ï¼Œæ¯ä¸ªäº¤å‰å…ƒç´ é˜¶æ®µä¹‹é—´å…·æœ‰ä»»æ„èµ·å§‹å€¼ã€‚</p><p> A higher rate of aggregate entropy is achieved by running four instances of the core described above in parallel, and XORâ€™ing their result together. In addition, the actual delay/dwell parameters are dynamically adjusted at run-time by picking some of the generated entropy and adding it to the base dwell/delay parameters.</p><p> é€šè¿‡åœ¨å¹¶è¡Œæè¿°ä¸Šè¿°æ ¸å¿ƒçš„å››ä¸ªå®ä¾‹ï¼Œå°†å®ƒä»¬çš„ç»“æœä¸€èµ·è¿è¡Œï¼Œå®ç°äº†æ›´é«˜çš„èšé›†ç†µç‡ã€‚æ­¤å¤–ï¼Œé€šè¿‡æŒ‘é€‰ä¸€äº›ç”Ÿæˆçš„ç†µå¹¶å°†å…¶æ·»åŠ åˆ°åŸºæœ¬åœç•™/å»¶è¿Ÿå‚æ•°ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´å®é™…å»¶è¿Ÿ/åœç•™å‚æ•°ã€‚ </p><p> Thus, when looking at this architecture and comparing it against the NIST spec, the question is, how do we apply the Repetition Count test and the Adaptive Proportion tests? The Repetition Count test is probably not sensitive enough to apply on the 32-bit aggregate output. Itâ€™s probably best to apply the Repetition Count and Adaptive Proportion test a bit upstream of the final generated number, at the sampled output of the ring oscillators, just to confirm that no constituent ring oscillator is â€œstuckâ€ for any reason. However, the amount of logic resources consumed by adding this must be considered, since we have (33 * 4) = 132 separate oscillators to consider. Thus, for practical reasons, itâ€™s only feasible to instrument one output from each of the four cores that is indicative of the health of the entire bank of oscillators.</p><p>äºæ˜¯ï¼Œåœ¨çœ‹è¿™ä¸ªæ¶æ„å¹¶å°†å…¶ä¸NISTè§„èŒƒç›¸æ¯”ï¼Œé—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬å¦‚ä½•åº”ç”¨é‡å¤è®¡æ•°æµ‹è¯•å’Œè‡ªé€‚åº”æ¯”ä¾‹æµ‹è¯•ï¼Ÿé‡å¤è®¡æ•°æµ‹è¯•å¯èƒ½ä¸è¶³ä»¥åº”ç”¨äº32ä½èšåˆè¾“å‡ºã€‚åœ¨ç¯å½¢æŒ¯è¡å™¨çš„é‡‡æ ·è¾“å‡ºï¼Œæœ€ä½³åœ°åº”ç”¨é‡å¤è®¡æ•°å’Œè‡ªé€‚åº”æ¯”ä¾‹æµ‹è¯•çš„é‡å¤è®¡æ•°å’Œè‡ªé€‚åº”æ¯”ä¾‹æµ‹è¯•ï¼Œåªæ˜¯ä¸ºäº†ç¡®è®¤æ²¡æœ‰ä»»ä½•æ„æˆç¯æŒ¯è¡å™¨æ˜¯ä»»ä½•åŸå› çš„â€œå¡ä½â€ã€‚ä½†æ˜¯ï¼Œå¿…é¡»è€ƒè™‘æ·»åŠ è¿™ä¸€ç‚¹çš„é€»è¾‘èµ„æºçš„é‡ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰ï¼ˆ33 * 4ï¼‰= 132ä¸ªå•ç‹¬çš„æŒ¯è¡å™¨æ¥è€ƒè™‘ã€‚å› æ­¤ï¼Œå‡ºäºå®é™…åŸå› ï¼Œå®ƒå¯¹äºä»å››ä¸ªæ ¸å¿ƒçš„æ¯ä¸ªæ ¸å¿ƒä»ªå™¨ä»ªå™¨çš„è¾“å‡ºä»…æ˜¯å¯è¡Œçš„ï¼Œè¯¥è¾“å‡ºæŒ‡ç¤ºæ•´ä¸ªæŒ¯è¡å™¨çš„æ•´ä¸ªæŒ¯è¡å™¨çš„å¥åº·çŠ¶å†µã€‚</p><p> Picking the right spot to instrument is tricky. The â€œlargeâ€ ring oscillator is actually low-quality entropy, because it has a period of about 30MHz but is oversampled at 100MHz. Thus the majority of the entropy is contributed from the repeated undersampling of the â€œsmallâ€ rings. The final sampling point chosen is the output of the sampling register after itâ€™s â€œsoaked upâ€ enough entropy from the combination of a small ring and a large ring to result in a useful measurement.</p><p> é€‰æ‹©æ­£ç¡®çš„ä»ªå™¨æ˜¯æ£˜æ‰‹çš„ã€‚ â€œå¤§â€ç¯å½¢æŒ¯è¡å™¨å®é™…ä¸Šæ˜¯ä½è´¨é‡çš„ç†µï¼Œå› ä¸ºå®ƒçš„æ—¶é—´çº¦ä¸º30MHzï¼Œä½†åœ¨100MHzä¸Šè¿‡é‡‡æ ·ã€‚å› æ­¤ï¼Œå¤§å¤šæ•°ç†µæ˜¯ä»â€œå°â€ç¯çš„é‡å¤æ¬ é‡‡æ ·ä¸­çš„è´¡çŒ®ã€‚æ‰€é€‰æ‹©çš„æœ€ç»ˆé‡‡æ ·ç‚¹æ˜¯ä»å°ç¯å’Œå¤§ç¯çš„ç»„åˆâ€œæµ¸æ³¡â€è¶³å¤Ÿçš„ç†µä¹‹åçš„é‡‡æ ·å¯„å­˜å™¨çš„è¾“å‡ºï¼Œä»¥å¯¼è‡´æœ‰ç”¨çš„æµ‹é‡ã€‚</p><p>  Originally, I had tried looking at the â€œlargeâ€ oscillator only to try to find something more â€œrawâ€, under the hypothesis that we would be more likely to catch problems in the system at a less refined stage; the problem is that it was so â€œrawâ€ that all we caught was problems. However, we do use this tap as a â€œtrue negativeâ€ test, to ensure that the health tests are capable of flagging an entropy source that is less than perfect.</p><p>  æœ€åˆï¼Œæˆ‘è¯•å›¾çœ‹çœ‹â€œå¤§â€æŒ¯è¡å™¨ï¼Œåªè¯•å›¾æ‰¾åˆ°æ›´å¤šâ€œRAWâ€ï¼Œåœ¨å‡è®¾ä¸‹ï¼Œæˆ‘ä»¬æ›´æœ‰å¯èƒ½åœ¨ç³»ç»Ÿä¸­æ•è·ä¸å¤ªç²¾è‡´çš„é˜¶æ®µçš„é—®é¢˜;é—®é¢˜æ˜¯ï¼Œå®ƒæ˜¯å¦‚æ­¤â€œç”Ÿâ€ï¼Œæˆ‘ä»¬æ‰€æ•è·çš„åªæ˜¯é—®é¢˜ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ç¡®å®ä½¿ç”¨æ­¤æŠ½å¤´ä½œä¸ºâ€œçœŸæ­£çš„å¦å®šâ€æµ‹è¯•ï¼Œä»¥ç¡®ä¿å¥åº·æµ‹è¯•èƒ½å¤Ÿæ ‡è®°ç†µæºï¼Œè¯¥ç†µæºå°äºå®Œç¾ã€‚</p><p> Iâ€™m also going to introduce an extra test thatâ€™s inspired by the Runs Test in the STS suite, that I call â€œMiniRunsâ€. This test records the frequency of continuous runs of bits: 0/1, 00/11, 000/111, 0000/1111, etc. This test will offer more insight into the dominant projected failure mode of the ring oscillator, namely, it oscillating as a perfectly synchronized square wave â€” a condition that neither of the recommended NIST tests are capable of capturing. However, if the oscillator becomes too deterministic, we should see a shift in the distribution of run lengths out of the MiniRuns test.</p><p> æˆ‘è¿˜å°†æ¨å‡ºä¸€ä¸ªé¢å¤–çš„æµ‹è¯•ï¼Œå®ƒå—åˆ°STSå¥—ä»¶çš„è¿è¡Œæµ‹è¯•çš„å¯å‘ï¼Œæˆ‘ç§°ä¹‹ä¸ºâ€œMINIRUNâ€ã€‚è¯¥æµ‹è¯•è®°å½•äº†è¿ç»­è¿è¡Œçš„é¢‘ç‡ï¼š0/1,00/11,000/111,111,0000 / 1111ç­‰ã€‚è¯¥æµ‹è¯•å°†æä¾›æ›´å¤šåœ°æ´å¯Ÿç¯å½¢æŒ¯è¡å™¨çš„ä¸»å¯¼æŠ•å½±å¤±æ•ˆæ¨¡å¼ï¼Œå³å®ƒæŒ¯è¡ä½œä¸ºä¸€ä¸ªå®Œç¾åŒæ­¥çš„æ–¹æ³¢ - ä¸€ç§æ¨èçš„NISTæµ‹è¯•èƒ½å¤Ÿæ•è·çš„æ¡ä»¶ã€‚ä½†æ˜¯ï¼Œå¦‚æœæŒ¯è¡å™¨ä¹Ÿå˜å¾—è¿‡äºç¡®å®šæ€§ï¼Œæˆ‘ä»¬åº”è¯¥çœ‹åˆ°åœ¨MiniRunsæµ‹è¯•ä¸­çš„è¿è¡Œé•¿åº¦åˆ†å¸ƒçš„è½¬å˜ã€‚</p><p>  The avalanche generator consists of two avalanche diodes biased from a shared power supply, sampled by a pair of op-amps with a slight bit of gain; see our page on its  theory of operation for details on the physics and electronic design. Here, we focus on its system integration. The outputs of each of the op-amps are sampled with a 12-bit ADC at a rate of ~1MSPS, and XORâ€™d together. As this sampling rate is close to the effective noise bandwidth of the diodes, we reduce the sampling rate by repeatedly shifting-by-5 and XORâ€™ing the results a number of times that can be set by software, nominally, 32 times into a 32-bit holding register, which forms the final entropy output. This 32x oversampling reduces the rate of the system to 31.25kHz.</p><p>  é›ªå´©å‘ç”µæœºç”±ä¸¤å°é›ªå´©äºŒæç®¡ç»„æˆï¼Œç”±å…±ç”¨ç”µæºåç½®ï¼Œç”±ä¸€å¯¹OP-AMPSé‡‡æ ·ï¼Œå…·æœ‰è½»å¾®çš„å¢ç›Š;æœ‰å…³ç‰©ç†å’Œç”µå­è®¾è®¡çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…å…¶è¿è¡Œç†è®ºçš„é¡µé¢ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸“æ³¨äºå…¶ç³»ç»Ÿé›†æˆã€‚æ¯ä¸ªè¿ç®—æ”¾å¤§å™¨çš„è¾“å‡ºä»¥12ä½ADCä»¥ã€œ1mspsçš„é€Ÿç‡è¿›è¡Œé‡‡æ ·ï¼Œå¹¶åœ¨ä¸€èµ·XORã€‚ç”±äºè¿™ç§é‡‡æ ·ç‡æ¥è¿‘äºŒæç®¡çš„æœ‰æ•ˆå™ªå£°å¸¦å®½ï¼Œæˆ‘ä»¬é€šè¿‡åå¤è½¬æ¢ -  5å’ŒXORçš„ç»“æœæ¥é™ä½é‡‡æ ·ç‡ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è½¯ä»¶ï¼Œåä¹‰ä¸Šï¼Œ32æ¬¡å¯ä»¥è®¾ç½®çš„æ¬¡æ•°ã€‚ 32ä½ä¿æŒå¯„å­˜å™¨ï¼Œå½¢æˆæœ€ç»ˆçš„ç†µè¾“å‡ºã€‚è¯¥32å€è¿‡é‡‡æ ·é™ä½äº†ç³»ç»Ÿçš„é€Ÿç‡è‡³31.25kHzã€‚</p><p>   The avalanche properties of two individual diodes. These are considered to be high-quality properties derived from the amplification of true thermal noise.</p><p>   ä¸¤ä¸ªå•ç‹¬äºŒæç®¡çš„é›ªå´©ç‰¹æ€§ã€‚è¿™äº›è¢«è®¤ä¸ºæ˜¯ä»çœŸæ­£çƒ­å™ªå£°çš„æ”¾å¤§æ¥æºçš„é«˜è´¨é‡ç‰¹æ€§ã€‚</p><p>   Note that the two diodes do share a bias supply, so there is an opportunity for some cross-correlation from supply noise, but we have not seen this in practice.</p><p>   è¯·æ³¨æ„ï¼Œä¸¤ä¸ªäºŒæç®¡ç¡®å®å…±äº«åç½®ç”µæºï¼Œå› æ­¤æœ‰æœºä¼šä¸ç”µæºå™ªéŸ³çš„ä¸€äº›äº’ç›¸å…³ï¼Œä½†æˆ‘ä»¬åœ¨å®è·µä¸­æ²¡æœ‰çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚ </p><p> Because we are oversampling the avalanche waveform and folding it onto itself, what we are typically measuring is the projected slope of the avalanche waveform plus the noise of the ADC. Significantly, the SNR of the Xilinx 7-series â€œ12-bitâ€ ADC integrated into our FPGA is 60dB. This means we actually have only 10 â€œgoodâ€ bits, implying that the bottom two bits are typically too noisy to be used for signal measurements. The XADC primitive compensates for this noise by offering automatic averaging over 16 samples; we turn this off when sampling the avalanche noise generators, because we actually *want* this noise, but turn it on for all the other duties of the XADC.</p><p>å› ä¸ºæˆ‘ä»¬å°†é›ªå´©æ³¢å½¢å’Œå°†å…¶æŠ˜å èµ·æ¥ï¼Œæˆ‘ä»¬é€šå¸¸æµ‹é‡çš„æ˜¯é›ªå´©æ³¢å½¢çš„é¢„è®¡æ–œç‡åŠ ä¸ŠADCçš„å™ªå£°ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒXilinx 7ç³»åˆ—â€œ12ä½â€ADCé›†æˆåˆ°æˆ‘ä»¬çš„FPGAä¸­çš„SNRä¸º60dBã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å®é™…ä¸Šåªæœ‰10ä¸ªâ€œè‰¯å¥½â€ä½ï¼Œæš—ç¤ºåº•éƒ¨ä¸¤ä½é€šå¸¸å¤ªåµä»¥ç”¨äºä¿¡å·æµ‹é‡ã€‚ XADCåŸå§‹é€šè¿‡æä¾›è¶…è¿‡16ä¸ªæ ·æœ¬çš„è‡ªåŠ¨å¹³å‡æ¥è¡¥å¿è¿™ç§å™ªå£°;å½“é‡‡æ ·é›ªå´©å™ªå£°å‘ç”Ÿå™¨æ—¶ï¼Œæˆ‘ä»¬ä¼šå…³é—­è¿™ä¸€ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬å®é™…ä¸Š*æƒ³è¦*è¿™ç§å™ªéŸ³ï¼Œè€Œæ˜¯ä¸ºäº†Xadcçš„æ‰€æœ‰å…¶ä»–èŒè´£æ¥æ‰“å¼€å®ƒã€‚</p><p>  Itâ€™s also important to consider the nature of sampling this analog waveform with an ADC. The actual waveform itself can have a DC offset, or some total amplitude variation, so naturally the LSBs will be dense in entropy, while the MSBs may be virtually constant. By focusing on the bottom 5 bits out of 12 with the 5-bit sliding window, we are effectively ignoring the top 7 bits. What does this do to the effective waveform? Itâ€™s a bit easier to show graphically:</p><p>  è€ƒè™‘ä½¿ç”¨ADCé‡‡æ ·æ­¤æ¨¡æ‹Ÿæ³¢å½¢çš„æ€§è´¨ä¹Ÿå¾ˆé‡è¦ã€‚å®é™…æ³¢å½¢æœ¬èº«å¯ä»¥å…·æœ‰DCåç§»ï¼Œæˆ–ä¸€äº›æ€»å¹…åº¦å˜åŒ–ï¼Œå› æ­¤è‡ªç„¶åœ°LSBå°†åœ¨ç†µä¸­å¯†é›†ï¼Œè€ŒMSBå¯ä»¥æ˜¯å‡ ä¹æ’å®šçš„ã€‚é€šè¿‡ä½¿ç”¨5ä½æ»‘åŠ¨çª—å£èšç„¦åœ¨12ä¸ªä¸­çš„åº•éƒ¨5ä½ï¼Œæˆ‘ä»¬æœ‰æ•ˆåœ°å¿½ç•¥äº†å‰7ä½ã€‚è¿™å¯¹æœ‰æ•ˆæ³¢å½¢åšäº†ä»€ä¹ˆï¼Ÿä»¥å›¾å½¢æ–¹å¼æ˜¾ç¤ºå®ƒæœ‰ç‚¹æ˜“äºï¼š</p><p>   If we were to only consider 11 bits out of the 12, we effectively take half the graph and â€œwrap it over itselfâ€, as shown below:</p><p>   å¦‚æœæˆ‘ä»¬åªè€ƒè™‘åœ¨12ä¸­åªè€ƒè™‘11ä½ï¼Œæˆ‘ä»¬æœ‰æ•ˆåœ°èŠ±äº†ä¸€åŠçš„å›¾å½¢ï¼Œå¹¶å°†â€œåŒ…è£…è‡ªèº«â€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>      And so forth. By the time we are down to just considering 5 bits, weâ€™ve now taken the effective DC offset and amplitude variations and turned them into just another random variable that helps add to the entropy pool. Now take two of these, XOR them together, and add in the effective noise of the ADC itself, and youâ€™ve arrived at the starting point for the ADC entropy pool.</p><p>      ç­‰ç­‰ã€‚å½“æˆ‘ä»¬éµå¾ªçš„æ—¶é—´è€ƒè™‘åˆ°5ä½ï¼Œæˆ‘ä»¬ç°åœ¨æ‹æ‘„äº†æœ‰æ•ˆçš„DCåç§»å’Œå¹…åº¦å˜åŒ–ï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢ä¸ºå¦ä¸€ä¸ªéšæœºå˜é‡ï¼Œæœ‰åŠ©äºæ·»åŠ åˆ°ç†µæ± ã€‚ç°åœ¨å°†å…¶ä¸­çš„ä¸¤ä¸ªä¸­æœ‰ä¸¤ä¸ªï¼ŒXORå®ƒä»¬åœ¨ä¸€èµ·ï¼Œå¹¶åœ¨ADCæœ¬èº«çš„æœ‰æ•ˆå™ªå£°ä¸­æ·»åŠ ï¼Œå¹¶ä¸”æ‚¨å·²åˆ°è¾¾ADCç†µæ± çš„èµ·ç‚¹ã€‚</p><p> In terms of on-line entropy tests, it probably makes the most sense to apply the Repetition Count test and the Adaptive Proportion tests to the bottom 5 bits of the raw ADC feed from each avalanche diode (as opposed to the full 12-bit output of the ADC). We donâ€™t expect to hit â€œperfect entropyâ€ with the raw ADC feed, but these tests should be able to at least isolate situations where e.g. the bias voltage goes too low and the avalanche effect ceases to work.</p><p> å°±åœ¨çº¿ç†µæµ‹è¯•è€Œè¨€ï¼Œå°†é‡å¤è®¡æ•°æµ‹è¯•å’Œè‡ªé€‚åº”æ¯”ä¾‹æµ‹è¯•åº”ç”¨äºä»æ¯ä¸ªé›ªå´©äºŒæç®¡ï¼ˆä¸å®Œæ•´çš„12ä½è¾“å‡ºç›¸åçš„åŸå§‹ADCè¿›æ–™çš„åº•éƒ¨5ä½ï¼Œå®ƒå¯èƒ½æ˜¯æœ€æœ‰æ„ä¹‰çš„ADCï¼‰ã€‚æˆ‘ä»¬ä¸å¸Œæœ›ä½¿ç”¨åŸå§‹ADCé¥²æ–™å‡»ä¸­â€œå®Œç¾ç†µâ€ï¼Œä½†è¿™äº›æµ‹è¯•åº”è¯¥èƒ½å¤Ÿè‡³å°‘éš”ç¦»ä¾‹å¦‚ä¾‹å¦‚æ—¶çš„æƒ…å†µã€‚åç½®ç”µå‹è¿‡ä½ï¼Œé›ªå´©æ•ˆæœåœæ­¢å·¥ä½œã€‚</p><p> In addition to these tests, itâ€™s probably good to have an â€œabsolute excursionâ€ test, where the min/max of the raw avalanche waveforms are recorded over a time window, to detect a diode that is flat-lining due to aging effects, or a bias voltage source that is otherwise malfunctioning. This test is not suitable for catching if an attacker is maliciously injecting a deterministic waveform on top of the avalanche diodes, but is well-suited as a basic health check of the TRNGâ€™s core mechanisms under nominal environmental conditions.</p><p> é™¤äº†è¿™äº›æµ‹è¯•ä¹‹å¤–ï¼Œæ‹¥æœ‰â€œç»å¯¹åç§»â€æµ‹è¯•å¯èƒ½å¾ˆå¥½ï¼Œå…¶ä¸­åŸå§‹é›ªå´©æ³¢å½¢çš„Min / Maxåœ¨æ—¶é—´çª—å£ä¸­è®°å½•ï¼Œä»¥æ£€æµ‹ç”±äºè€åŒ–æ•ˆæœå¯¼è‡´çš„å¹³å¦è¡¬é‡Œçš„äºŒæç®¡ï¼Œæˆ–è€…åç½®ç”µå‹æºï¼Œå¦åˆ™æ˜¯æ•…éšœçš„ã€‚å¦‚æœæ”»å‡»è€…åœ¨é›ªå´©äºŒæç®¡é¡¶éƒ¨æ¶æ„åœ°æ³¨å…¥ç¡®å®šæ€§æ³¢å½¢ï¼Œä½†å¦‚æœæ”»å‡»è€…åœ¨é›ªå´©äºŒæç®¡çš„é¡¶éƒ¨çš„ç¡®å®šæ€§æ³¢å½¢ä¸­ï¼Œåˆ™è¯¥æµ‹è¯•ä¸é€‚åˆæ•è·ï¼Œä½†æ˜¯åœ¨æ ‡ç§°ç¯å¢ƒæ¡ä»¶ä¸‹æ˜¯TRNGçš„æ ¸å¿ƒæœºåˆ¶çš„åŸºæœ¬å¥åº·æ£€æŸ¥ã€‚</p><p>  After installing the tooling necessary to build a  Precursor/Betrusted SoC, I started writing the code.</p><p>  å®‰è£…åœ¨æ„å»ºå‰ä½“/æ¼‚äº®çš„Socæ‰€éœ€çš„å·¥å…·åï¼Œæˆ‘å¼€å§‹ç¼–å†™ä»£ç ã€‚ </p><p>  Think about what Iâ€™m trying to do. See the first section of this article.</p><p>æƒ³æƒ³æˆ‘æƒ³åšä»€ä¹ˆã€‚è¯·å‚é˜…æœ¬æ–‡çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚</p><p>  Wrap the smaller modules into a simulation framework that shakes most of the skeletons out of the closet.</p><p>  å°†è¾ƒå°çš„æ¨¡å—åŒ…è£…æˆæ¨¡æ‹Ÿæ¡†æ¶ï¼Œä½¿å¤§éƒ¨åˆ†éª·é«…ä»å£æ©±ä¸­å¼¹å‡ºã€‚</p><p> Repeat 1-3, working your way up the chain until you arrive at your full solution.</p><p> é‡å¤1-3ï¼Œå‘ä¸Šå·¥ä½œï¼Œç›´åˆ°æ‚¨åˆ°è¾¾å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>    Continuously integrate, if possible, either by re-running your sim against every repo change or better yet recompiling and re-running your test on actual hardware.</p><p>    å¦‚æœå¯èƒ½çš„è¯ï¼Œé€šè¿‡é‡æ–°è¿è¡ŒSIMï¼Œé€šè¿‡é‡æ–°è¿è¡Œæ‚¨çš„SIMï¼Œæˆ–è€…æ›´å¥½åœ°é‡æ–°ç¼–è¯‘å¹¶é‡æ–°è¿è¡Œæ‚¨åœ¨å®é™…ç¡¬ä»¶ä¸Šçš„æµ‹è¯•ã€‚</p><p> The key to this loop is the simulation. The better your simulation, the better your outcome. By â€œbetter simulationâ€, I mean, the less assumptions and approximations made in the test bench. For example, one could simulate a module by hooking it up to a hand-rolled set of Verilog vectors that exercises a couple read and write cycles and verifies nothing explodes; or, one could simulate a module by hooking it up to a fully simulated CPU, complete with power-on reset and multiple clock phases, and using a Rust-based framework to exercise the same reads and writes. The two test benches ostensibly achieve the same outcome, but the latter checks much more of the hairy corner cases.</p><p> æ­¤å¾ªç¯çš„å…³é”®æ˜¯æ¨¡æ‹Ÿã€‚ä½ çš„æ¨¡æ‹Ÿè¶Šå¥½ï¼Œç»“æœè¶Šå¥½ã€‚é€šè¿‡â€œæ›´å¥½çš„ä»¿çœŸâ€ï¼Œæˆ‘çš„æ„æ€æ˜¯ï¼Œæµ‹è¯•å°ä¸­çš„å‡è®¾å’Œè¿‘ä¼¼å€¼è¶Šå°‘ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡å°†å…¶æŒ‚é’©åˆ°ä¸€å·çš„Verilogå‘é‡é›†ä¸­æ¨¡æ‹Ÿæ¨¡å—ï¼Œè¯¥å·æ»šåŠ¨è¯»å–å’Œå†™å…¥å‘¨æœŸå¹¶éªŒè¯ä»»ä½•çˆ†ç‚¸;æˆ–è€…ï¼Œå¯ä»¥é€šè¿‡å°†å…¶æŒ‚é’©åˆ°å®Œå…¨æ¨¡æ‹Ÿçš„CPUçš„æ¨¡å—æ¥æ¨¡æ‹Ÿæ¨¡å—ï¼Œä½¿ç”¨ç”µæºå¤ä½å’Œå¤šä¸ªæ—¶é’Ÿé˜¶æ®µï¼Œå¹¶ä½¿ç”¨åŸºäºRUSTçš„æ¡†æ¶æ¥é”»ç‚¼ç›¸åŒçš„è¯»å–å’Œå†™å…¥ã€‚è¿™ä¸¤ä¸ªæµ‹è¯•å°è¡¨é¢ä¸Šè¾¾åˆ°äº†ç›¸åŒçš„ç»“æœï¼Œä½†åè€…æ£€æŸ¥äº†æ›´å¤šçš„æ¯›èŒ¸èŒ¸çš„è§’è½æ¡ˆä¾‹ã€‚</p><p> For Betrusted/Precursor, we developed a comprehensive simulation framework that achieves the latter scenario as much as possible. We simulate a full, gate-level Vex CPU, running a Rust-built BIOS, employing as many of the Xilinx-provided hardware models as we can for things like the PLL and global power-on reset.</p><p> å¯¹äºè–„é¥¼/å‰ä½“ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªç»¼åˆæ€§ä»¿çœŸæ¡†æ¶ï¼Œå°½å¯èƒ½åœ°å®ç°äº†åä¸€ç§æƒ…å†µã€‚æˆ‘ä»¬æ¨¡æ‹Ÿäº†ä¸€ä¸ªå®Œæ•´çš„é—¨çº§vex cpuï¼Œè¿è¡Œäº†ä¸€ä¸ªç”Ÿé”ˆæ„å»ºçš„BIOSï¼Œå°±åƒè®¸å¤šXilinxæä¾›çš„ç¡¬ä»¶æ¨¡å‹ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºPLLå’Œå…¨çƒä¸Šç”µå¤ä½çš„ä¸œè¥¿ã€‚</p><p>  This is the point in the cooking show at which we put the turkey into an oven, say something to the effect of â€œâ€¦and in about five hours, your bird should be doneâ€¦â€ yet somehow magically pull out a finished turkey for carving and presentation by the time we finish the sentence.</p><p>  è¿™æ˜¯æˆ‘ä»¬æŠŠç«é¸¡æ”¾å…¥çƒ¤ç®±çš„çƒ¹é¥ªç§€çš„é‡ç‚¹ï¼Œå¯¹â€œ......å’Œå¤§çº¦äº”ä¸ªå°æ—¶å†…çš„æ•ˆæœæ¥è¯´ï¼Œä½ åº”è¯¥å®Œæˆçš„ä¸œè¥¿......â€ä½†æ˜¯ï¼Œä»¥æŸç§æ–¹å¼ç¥å¥‡åœ°æ‹‰å‡ºä¸€ä¸ªæˆå“çš„åœŸè€³å…¶é›•åˆ»å’Œé›•åˆ»å½“æˆ‘ä»¬å®Œæˆå¥å­æ—¶å‘ˆç°ã€‚ </p><p> So: after a bunch more driver-writing and breaking out signals to gain visibility into the various metrics and failure modes, we can see the on-line health tests in action.</p><p>æ‰€ä»¥ï¼šç»è¿‡æ›´å¤šçš„é©¾é©¶å‘˜å†™ä½œå’Œç ´åä¿¡å·ä»¥è·å¾—å„ç§åº¦é‡å’Œæ•…éšœæ¨¡å¼çš„å¯è§æ€§ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨çº¿è¿è¡Œä¸­çš„æ“ä½œã€‚</p><p>  Above is an example of the trng test data output on Precursor, set where `RO 0` is connected to the â€œlargeâ€ oscillator that runs too slowly (serving as a â€œtrue negativeâ€ test), and the others are connected to the final output tap for the test (serving as a â€œtrue positiveâ€). In the output, you can see the four ring oscillators (numbered 0-3) with the frequency of each of five run lengths printed out. `RO 0` has a significant depression in the count for the run-length 1 bin, compared to the other oscillators (440 vs 515, 540, and 508).</p><p>  ä»¥ä¸Šæ˜¯å‰ä½“ä¸Šçš„TRNGæµ‹è¯•æ•°æ®è¾“å‡ºçš„ç¤ºä¾‹ï¼Œè®¾ç½®ä¸º`RO 0`è¿æ¥åˆ°â€œå¤§â€æŒ¯è¡å™¨çš„ä½ç½®ï¼Œè¯¥æŒ¯è¡å™¨è¿è¡Œè¿‡äºç¼“æ…¢ï¼ˆç”¨ä½œâ€œçœŸæ­£çš„å¦å®šâ€æµ‹è¯•ï¼‰ï¼Œå…¶ä»–äººè¿æ¥åˆ°æœ€ç»ˆçŠ¶æ€ç”¨äºæµ‹è¯•çš„è¾“å‡ºæ°´é¾™å¤´ï¼ˆç”¨ä½œâ€œçœŸæ­£çš„æ­£é¢â€ï¼‰ã€‚åœ¨è¾“å‡ºä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å››ä¸ªç¯å½¢æŒ¯è¡å™¨ï¼ˆç¼–å·ä¸º0-3ï¼‰ï¼Œå…¶ä¸­æ¯ä¸ªäº”ä¸ªè¿è¡Œé•¿åº¦ä¸­çš„æ¯ä¸€ä¸ªéƒ½æ‰“å°å‡ºæ¥ã€‚ä¸å…¶ä»–æŒ¯è¡å™¨ç›¸æ¯”ï¼Œâ€œRO 0â€åœ¨è·‘æ­¥é•¿1ç®±çš„è®¡æ•°ä¸­å…·æœ‰æ˜¾ç€çš„æŠ‘éƒç—‡ï¼ˆ440 VS 515,540å’Œ508ï¼‰ã€‚</p><p> One final detail is implementing an automated decision mechanism for the MiniRuns test. Since the MiniRuns test wasnâ€™t from the NIST suite, I couldnâ€™t simply read a manual to derive a threshold. Instead, I had to consult with my perlfriend, who also happens to be an expert at statistics, to help me understand what I was doing and derive a model that could help me set limits. Originally, she suggested a chi-square test. This would be great, but the math for it would be too complicated for an automated quick power-on test. So, we downgraded the test to simple max/min thresholds on the counts for each â€œbinâ€ of runs. I used a similar criteria to that suggested in the NIST test, that is, ğ›‚ = 2^-20, to set the thresholds, and baked that into the hardware code. Hereâ€™s a  link to the original spreadsheet that she used to compute both the chi-square and the final, simpler min/max tests. One future upgrade could be to implement some recurring process in Xous that collects updated results from the MiniRuns test and does the more sophisticated chi-square tests on it; but thatâ€™s definitely a â€œone for the roadâ€ feature.</p><p> æœ€åä¸€ä¸ªç»†èŠ‚æ­£åœ¨å®æ–½minirunsæµ‹è¯•çš„è‡ªåŠ¨å†³ç­–æœºåˆ¶ã€‚ç”±äºMiniRunsæµ‹è¯•ä¸æ˜¯æ¥è‡ªNISTå¥—ä»¶ï¼Œå› æ­¤æˆ‘æ— æ³•ç®€å•åœ°é˜…è¯»æ‰‹åŠ¨æ¥å¯¼å‡ºé˜ˆå€¼ã€‚ç›¸åï¼Œæˆ‘ä¸å¾—ä¸å’¨è¯¢æˆ‘çš„Perlfriendï¼Œä»–ä¹Ÿæ°å¥½æˆä¸ºç»Ÿè®¡æ•°æ®çš„ä¸“å®¶ï¼Œå¸®åŠ©æˆ‘äº†è§£æˆ‘æ­£åœ¨åšçš„äº‹æƒ…å¹¶å¯¼å‡ºä¸€ä¸ªå¯ä»¥å¸®åŠ©æˆ‘è®¾å®šé™åˆ¶çš„æ¨¡å‹ã€‚æœ€åˆï¼Œå¥¹å»ºè®®äº†Chi-Squareæµ‹è¯•ã€‚è¿™å°†æ˜¯å¾ˆå¤§çš„ï¼Œä½†æ˜¯å¯¹äºè‡ªåŠ¨çš„å¿«é€Ÿä¸Šç”µæµ‹è¯•æ¥è¯´ï¼Œæ•°å­¦å°†å¤ªå¤æ‚ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†æµ‹è¯•é™çº§ä¸ºè¿è¡Œçš„æ¯ä¸ªâ€œåƒåœ¾ç®±â€çš„è®¡æ•°ä¸Šçš„ç®€å•æœ€å¤§/æœ€å°é˜ˆå€¼ã€‚æˆ‘å¯¹NISTæµ‹è¯•ä¸­å»ºè®®çš„ç±»ä¼¼æ ‡å‡†ï¼Œå³Î±= 2 ^ -20ï¼Œè®¾ç½®é˜ˆå€¼ï¼Œå¹¶å°†å…¶çƒ˜ç„™åˆ°ç¡¬ä»¶ä»£ç ä¸­ã€‚è¿™æ˜¯ä¸€ç§ä¸åŸå§‹ç”µå­è¡¨æ ¼çš„é“¾æ¥ï¼Œå¥¹ç”¨äºè®¡ç®—Chi-Squareå’Œæœ€ç»ˆï¼Œæœ€ç®€å•çš„æœ€å°/æœ€å¤§æµ‹è¯•ã€‚ä¸€ä¸ªæœªæ¥çš„å‡çº§å¯ä»¥æ˜¯åœ¨XOUSä¸­å®æ–½ä¸€äº›é‡å¤è¿‡ç¨‹ï¼Œä»Minirunsæµ‹è¯•ä¸­æ”¶é›†æ›´æ–°çš„ç»“æœï¼Œå¹¶å¯¹å…¶ä¸­æ›´å¤æ‚çš„Chi-Squareæµ‹è¯•;ä½†è¿™ç»å¯¹æ˜¯â€œé“è·¯çš„ä¸€ä¸ªâ€åŠŸèƒ½ã€‚</p><p>  The upshot is that we now have all the mandatory NIST tests plus one each â€œtailoredâ€ tests for each type of TRNG. Adding the MiniRuns automated criteria increased utilization to 56.5% â€” raising the total space used by the tests from about 2% of the FPGA to a bit over 4%. The MiniRuns test is expensive because it is currently configured to check for runs ranging from length 1 to 5 over 4 banks of ring oscillators â€” so thatâ€™s 5 * 4 * (registers/run ~30?) = ~600 registers just for the core logic, not counting the status readout or config inputs.</p><p>  ç»“æœæ˜¯æˆ‘ä»¬ç°åœ¨æ‹¥æœ‰æ‰€æœ‰å¼ºåˆ¶æ€§NISTæµ‹è¯•ä»¥åŠæ¯ç§ç±»å‹çš„TRNGæ¯æ¬¡â€œé‡èº«å®šåˆ¶â€æµ‹è¯•ã€‚æ·»åŠ Minirunsè‡ªåŠ¨åŒ–æ ‡å‡†å°†åˆ©ç”¨ç‡æé«˜åˆ°56.5ï¼… - å°†æµ‹è¯•ä½¿ç”¨çš„æ€»ç©ºé—´ä»çº¦2ï¼…çš„FPGAä»çº¦2ï¼…æé«˜åˆ°4ï¼…ä»¥ä¸Šã€‚ MiniRunsæµ‹è¯•æ˜¯æ˜‚è´µçš„ï¼Œå› ä¸ºå®ƒç›®å‰é…ç½®ä¸ºåœ¨é•¿åº¦1åˆ°5ä¸ªç¯æŒ¯è¡å™¨ä¸­æ£€æŸ¥è¿è¡ŒèŒƒå›´ - æ‰€ä»¥è¿™æ˜¯5 * 4 *ï¼ˆå¯„å­˜å™¨/è¿è¡Œã€œ30ï¼Ÿï¼‰=ã€œ600å¯„å­˜å™¨ä»…ç”¨äºæ ¸å¿ƒé€»è¾‘ï¼Œä¸è®¡ç®—çŠ¶æ€è¯»æ•°æˆ–é…ç½®è¾“å…¥ã€‚</p><p> Later on, if I start running out of space, cutting back on some of the instrumentation or the depth of the runs measured might be a reasonable thing to do. I would suggest disposing of some of the less effective NIST tests entirely in favor of the home-grown tests, but in the end I may have to kick out the more effective supplemental tests. The reality is that itâ€™s much easier to defend keeping inferior-but-spec-compliant tests in the system, rather than opting for superior tests at the expense of the specification tests.</p><p> åæ¥ï¼Œå¦‚æœæˆ‘å¼€å§‹ç©ºé—´è€—å°½ï¼Œå‰Šå‡ä¸€äº›ä»ªå™¨æˆ–æµ‹é‡çš„è¿è¡Œçš„æ·±åº¦å¯èƒ½æ˜¯åˆç†çš„äº‹æƒ…ã€‚æˆ‘å»ºè®®å¤„ç†å®Œå…¨æœ‰åˆ©äºå®¶åº­æˆé•¿çš„æµ‹è¯•çš„ä¸€äº›æ•ˆç‡æµ‹è¯•ï¼Œä½†æœ€ç»ˆæˆ‘å¯èƒ½å¿…é¡»è¸¢å‡ºæ›´æœ‰æ•ˆçš„è¡¥å……æµ‹è¯•ã€‚ç°å®æ˜¯ï¼Œæå«åœ¨ç³»ç»Ÿä¸­ä¿æŒè¾ƒä½çš„ç¬¦åˆè§„èŒƒçš„æµ‹è¯•æ˜¯æ›´å®¹æ˜“çš„ï¼Œè€Œä¸æ˜¯ä»¥è§„èŒƒæµ‹è¯•ä¸ºä»£ä»·ä¸ºå“è¶Šçš„æµ‹è¯•è¿›è¡Œå“è¶Šçš„æµ‹è¯•ã€‚</p><p> Thatâ€™s it for part 1. If youâ€™re super-eager to read more, you can read the full  wiki entry on data conditioning for the TRNG at the  Precursor/Betrusted documentation wiki. Or, you can just wait until I get around to chopping the page down to size and repackaging it into a more bite-side blog entry.</p><p> è¿™æ˜¯ç¬¬1éƒ¨åˆ†ã€‚å¦‚æœæ‚¨è¶…çº§æ¸´æœ›é˜…è¯»æ›´å¤šï¼Œæ‚¨å¯ä»¥é˜…è¯»å‰ä½“/ Betrustedæ–‡æ¡£Wikiçš„TRNGæ•°æ®è°ƒèŠ‚çš„å®Œæ•´Wikiæ¡ç›®ã€‚æˆ–è€…ï¼Œæ‚¨åªéœ€ç­‰åˆ°æˆ‘ç»•è¿‡å°†é¡µé¢ç ä¸‹åˆ°å°ºå¯¸å¹¶å°†å…¶é‡æ–°åŒ…è£…æˆä¸€ä¸ªæ›´å»åˆçš„åšå®¢æ¡ç›®ã€‚ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.bunniestudios.com/blog/?p=6097">https://www.bunniestudios.com/blog/?p=6097</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/å‰ä½“/">#å‰ä½“</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/health/">#health</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/æµ‹è¯•/">#æµ‹è¯•</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ†äº«/">#åˆ†äº«</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>