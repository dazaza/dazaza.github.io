<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>x86-64 4kb pageç¿»è¯‘è®¾è®¡ï¼šè¿™æ˜¯è¿™ä¸ªåŸå› ä¸º4096å­—èŠ‚å¯¹é½çš„åŸå› ï¼Ÿ x86â€“64 4Kb Page translation design: is this why pages are 4096 bytes aligned?</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">x86â€“64 4Kb Page translation design: is this why pages are 4096 bytes aligned?<br/>x86-64 4kb pageç¿»è¯‘è®¾è®¡ï¼šè¿™æ˜¯è¿™ä¸ªåŸå› ä¸º4096å­—èŠ‚å¯¹é½çš„åŸå› ï¼Ÿ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-22 16:43:33</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/6/1884f8fb9738c71dd30e341464e483f9.png"><img src="http://img2.diglog.com/img/2021/6/1884f8fb9738c71dd30e341464e483f9.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>I lost 3 weeks of my life trying to wrap my head around the Intel x86â€“64/AMD64 manuals to try implementing 4-Kbyte Page translation for my  hobbyist OS. The purpose of this small blog post is to document some of the things that in the manual arenâ€™t clear at all. (especially for newcomers)</p><p>æˆ‘ä¸¢å¤±äº†3å‘¨çš„æˆ‘çš„ç”Ÿå‘½ï¼Œè¯•å›¾åœ¨è‹±ç‰¹å°”X86-64 / AMD64æ‰‹å†Œä¸ŠåŒ…è£…æˆ‘çš„å¤´ï¼Œä»¥å°è¯•ä¸ºæˆ‘çš„çˆ±å¥½è€…æ“ä½œ4-KBETEé¡µé¢ç¿»è¯‘ã€‚è¿™ä¸ªå°åšå®¢æ–‡ç« çš„ç›®çš„æ˜¯è®°å½•æ‰‹å†Œä¸­çš„ä¸€äº›ä¸œè¥¿å¹¶ä¸æ¸…æ¥šã€‚ ï¼ˆç‰¹åˆ«æ˜¯æ–°äººï¼‰</p><p>   You have seen that picture a billion times and i  f you are reading this post you know that you need to create these Page Tables in memory so that the hardware establishes a well-defined interface with the OS for allocating small chunks of memory before moving to 64-bit mode.</p><p>   æ‚¨å·²ç»çœ‹åˆ°äº†å¤§çº¦åäº¿æ¬¡çš„ç…§ç‰‡ï¼Œå¦‚æœæ‚¨æ­£åœ¨é˜…è¯»æ­¤å¸–ï¼Œæ‚¨çŸ¥é“æ‚¨éœ€è¦åœ¨å†…å­˜ä¸­åˆ›å»ºè¿™äº›é¡µé¢è¡¨ï¼Œä»¥ä¾¿ç¡¬ä»¶ä¸æ“ä½œç³»ç»Ÿå»ºç«‹ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„æ¥å£ï¼Œä»¥ä¾¿åœ¨ç§»åŠ¨åˆ°64ä¹‹å‰åˆ†é…å°å—çš„å°å—-bitæ¨¡å¼ã€‚</p><p>    Image that I want to create identity-mapped pages for the first 10MB of memory during the early stages of the boot process. This will be useful for loading the kernel in memory memory before moving to Long mode (64-bit).</p><p>    åœ¨å¼•å¯¼è¿‡ç¨‹çš„æ—©æœŸé˜¶æ®µæœŸé—´ï¼Œæˆ‘æƒ³è¦ä¸ºå‰10MBå†…å­˜åˆ›å»ºIdentityæ˜ å°„é¡µé¢çš„å›¾åƒã€‚åœ¨ç§»åŠ¨åˆ°é•¿æ¨¡å¼ï¼ˆ64ä½ï¼‰ä¹‹å‰ï¼Œè¿™å°†æ˜¯åœ¨å†…å­˜å­˜å‚¨å™¨ä¸­åŠ è½½å†…æ ¸çš„æœ‰ç”¨ã€‚</p><p>         The explanation to why we do that is due to the expected 4-Kbyte PDE entry format</p><p>         å¯¹æˆ‘ä»¬ä¸ºä»€ä¹ˆè¿™æ ·åšçš„è§£é‡Šæ˜¯ç”±äºé¢„æœŸçš„4-Kbyte PDEæ¡ç›®æ ¼å¼</p><p>    But if you look closely, you will find something very very odd. We are led to believe that the Page-Table Base Address (0x13000) should be set between the bits 51:12 as per the picture above.</p><p>    ä½†å¦‚æœä½ ä»”ç»†çœ‹ï¼Œä½ ä¼šå‘ç°ä¸€äº›éå¸¸å¥‡æ€ªçš„ä¸œè¥¿ã€‚æˆ‘ä»¬è¢«å¯¼è‡´è®¤ä¸ºé¡µé¢è¡¨åŸºåœ°åœ°å€ï¼ˆ0x13000ï¼‰åº”æ ¹æ®ä¸Šå›¾çš„å›¾ç‰‡åœ¨æ¯”ç‰¹51:12ä¹‹é—´è®¾ç½®ã€‚</p><p> If that assumption is correct, then 0x13000 should be left shifted 12 bits and become 0x13000000. So after the setting the page flags it would become effectively 0x13000003. Which means that the code snippet you shared before is wrong, is that right?</p><p> å¦‚æœè¯¥å‡è®¾æ˜¯æ­£ç¡®çš„ï¼Œåˆ™0x13000åº”å·¦ç§»12ä½å¹¶å˜ä¸º0x13000000ã€‚å› æ­¤ï¼Œåœ¨è®¾ç½®é¡µé¢æ ‡å¿—ä¹‹åï¼Œå®ƒå°†å˜ä¸º0x13000003ã€‚è¿™æ„å‘³ç€æ‚¨ä¹‹å‰å…±äº«çš„ä»£ç ç‰‡æ®µæ˜¯é”™è¯¯çš„ï¼Œæ˜¯å¯¹çš„å—ï¼Ÿ</p><p> Think like that if you want to spend 3 weeks trying to figure out why you OS doesnâ€™t boot while questioning every career decision youâ€™ve made in the meantime ğŸ˜°</p><p> å¦‚æœä½ æƒ³èŠ±3å‘¨è¯•å›¾å¼„æ¸…æ¥šä½ ä¸ºä»€ä¹ˆæ²¡æœ‰å¯åŠ¨çš„æ—¶å€™ï¼Œé‚£ä¹ˆåœ¨è´¨ç–‘ä½ çš„æƒ…å†µä¸‹ä½ çš„æ¯ä¸€èŒä¸šå†³å®šéƒ½æ²¡æœ‰å¯åŠ¨ </p><p> The train of thought isnâ€™t wrong per se, but the x86â€“64 design works a bit different from what we speculated.</p><p>æ€æƒ³çš„ç«è½¦ä¸æ˜¯é”™è¯¯çš„ï¼Œä½†X86-64è®¾è®¡æœ‰ç‚¹ä¸åŒäºæˆ‘ä»¬æ¨æµ‹çš„ä¸œè¥¿ã€‚</p><p> Page data- structure tables are  always aligned on 4-Kbyte boundaries, so only the  address bits above bit 11 are stored in the translation-table base-address field. Bits 11:0 are assumed to be 0. (Taken from the AMD64 manual, page 150)</p><p> é¡µé¢æ•°æ®ç»“æ„è¡¨å§‹ç»ˆåœ¨4-kbyteè¾¹ç•Œä¸Šå¯¹é½ï¼Œå› æ­¤åªæœ‰ä¸Šè¿°ä½11çš„åœ°å€ä½å­˜å‚¨åœ¨ç¿»è¯‘è¡¨åŸºåœ°å€å­—æ®µä¸­ã€‚å‡è®¾ä½11ï¼š0ä¸º0.ï¼ˆå–è‡ªAMD64æ‰‹å†Œï¼Œç¬¬150é¡µï¼‰</p><p> What this means in practice is that if our page is on address 0x13000 and flag bits are 0x03 = 0x13003, our hardware â€˜re-utilisesâ€™ the 12-bits to set the flags while it knows that if it adds 0x1000 to the current page address, it can get to the next page. Itâ€™s hard not to speculate if that alone isnâ€™t the whole reason why page tables are 4096 bytes aligned (or 0x1000 ğŸ˜œ)</p><p> è¿™æ„å‘³ç€åœ¨å®è·µä¸­æ˜¯ä»€ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬çš„é¡µé¢åœ¨åœ°å€0x13000ä¸Šï¼Œæ ‡å¿—ä½æ˜¯0x03 = 0x13003ï¼Œæˆ‘ä»¬çš„ç¡¬ä»¶â€œé‡æ–°åˆ©ç”¨â€12ä½ä»¥åœ¨å½“å‰é¡µé¢åœ°å€æ·»åŠ 0x1000æ—¶è®¾ç½®æ ‡å¿—ï¼Œå®ƒå¯ä»¥åˆ°è¾¾ä¸‹ä¸€é¡µã€‚å¦‚æœå•ç‹¬çš„æ˜¯å•ç‹¬çš„ï¼Œè¿™æ˜¯éš¾ä»¥æ¨æµ‹çš„æ˜¯Page Tablesæ˜¯4096å­—èŠ‚çš„æ•´ä¸ªåŸå› ï¼ˆæˆ–0x1000ğŸ˜œï¼‰</p><p> The problem is that although this is written in the manual, no emphasis is really given to this sparse sentence in a middle of a manual with thousands of pages ğŸ˜«</p><p> é—®é¢˜æ˜¯ï¼Œè™½ç„¶è¿™æ˜¯åœ¨æ‰‹å†Œä¸­ç¼–å†™çš„ï¼Œä½†æ²¡æœ‰å¼ºè°ƒåœ¨ä¸€ä¸ªæ‰‹å†Œä¸­é—´çš„ç¨€ç–å¥å­ï¼Œåƒé¡µğŸ˜«</p><p> Well, it took me a long time to get to this and Iâ€™m sure that I will forget my name one day but wonâ€™t forget this battle with x86â€“64 paging implementation.</p><p> å¥½å§ï¼Œæˆ‘èŠ±äº†å¾ˆé•¿æ—¶é—´æ‰èƒ½è¾¾åˆ°è¿™ä¸ªï¼Œæˆ‘ç›¸ä¿¡ä¸€å¤©æˆ‘ä¼šå¿˜è®°æˆ‘çš„åå­—ï¼Œä½†ä¸ä¼šå¿˜è®°è¿™åœºä¸x86-64åˆ†é¡µçš„æˆ˜æ–—ã€‚</p><p> I hope that if someone is struggling with the same problem that I could have reduced that time it took you to figure this out. â¤ï¸</p><p> æˆ‘å¸Œæœ›å¦‚æœæœ‰äººåœ¨åŠªåŠ›ä¸æˆ‘å¯ä»¥å‡å°‘é‚£ä¸ªæ—¶é—´çš„åŒæ ·çš„é—®é¢˜ï¼Œé‚£å°±èŠ±äº†ä½ æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ â¤ï¸ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://deepdives.medium.com/x86-64-4kbyte-page-translation-design-is-this-the-reason-why-pages-are-4096-bytes-aligned-19952a0a55f4">https://deepdives.medium.com/x86-64-4kbyte-page-translation-design-is-this-the-reason-why-pages-are-4096-bytes-aligned-19952a0a55f4</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/page/">#page</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/é¡µé¢/">#é¡µé¢</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1067226.html"><img src="http://img2.diglog.com/img/2021/6/thumb_5d51e7954d251bef732fcb25c42a4e0d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1067226.html">æ–°çš„â€œä¿å­˜â€å›¾æ ‡ </a></div><span class="my_story_list_date">2021-6-22 0:42</span></div><div class="col-sm"><div><a target="_blank" href="/story/1066903.html"><img src="http://img2.diglog.com/img/2021/6/thumb_6cd0930f3044b8dc78a00250053d4315.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1066903.html">è‹è”è®¾è®¡çš„å¥‡æ€ªä¾‹å­ </a></div><span class="my_story_list_date">2021-6-20 0:6</span></div><div class="col-sm"><div><a target="_blank" href="/story/1066829.html"><img src="http://img2.diglog.com/img/2021/6/thumb_84d43a86d7f453d06fe4fb5dfb1f2e92.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1066829.html">UIè®¾è®¡çš„å±å¹•æˆªå›¾ï¼ŒLEDèŠ±æ——é›†å›¢ä¸å°å¿ƒå‘é€$ 893M </a></div><span class="my_story_list_date">2021-6-19 11:55</span></div><div class="col-sm"><div><a target="_blank" href="/story/1066755.html"><img src="http://img2.diglog.com/img/2021/6/thumb_9011e9be29143bbbde2cf607300594c4.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1066755.html">Windows 11ä¸­è‡³å°‘æœ‰10ä¸ªä¸åŒçš„Microsoftè®¾è®¡çº¦å®š </a></div><span class="my_story_list_date">2021-6-19 3:48</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è°·æ­Œ/">#è°·æ­Œ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>