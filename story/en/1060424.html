<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>ä½¿ç”¨åŸºäºç£ç›˜çš„rediså…‹éš†æ¥å‡å°‘AWS S3è´¦å• Using a disk-based Redis clone to reduce AWS S3 bill</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Using a disk-based Redis clone to reduce AWS S3 bill<br/>ä½¿ç”¨åŸºäºç£ç›˜çš„rediså…‹éš†æ¥å‡å°‘AWS S3è´¦å• </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-28 11:23:50</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/4/5b03300ba6a5da1125c56b323663eff7.png"><img src="http://img2.diglog.com/img/2021/4/5b03300ba6a5da1125c56b323663eff7.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Redis is an in-memory database with very high write and read speed, and a limitation that data sets canâ€™t be larger than available RAM.Itâ€™s like  memcached but supports data structures instead of just strings as values.Redis is great for caching lookups to AWS S3 from an external server, which can speed up your S3 reads and save you money on  Outgoing Data Transfer costs.However, having your entire data set limited to the size of available RAM on the machine means you can only cache a small fraction of your possible AWS S3 keys.Also with Redis, if snapshotting ever fails because youâ€™ve used more RAM than available, your  snapshot will fail and force your Redis instance into  read-only mode.This means your production Redis database might suddenly stop allowing writes until you restart it, yikes!ğŸ˜±</p><p>Redisæ˜¯ä¸€ä¸ªå…·æœ‰éå¸¸é«˜çš„å†™å…¥å’Œè¯»å–é€Ÿåº¦çš„å†…å­˜æ•°æ®åº“ï¼Œå¹¶ä¸”æ•°æ®é›†ä¸èƒ½å¤§äºå¯ç”¨RAM.itå°±åƒMEMCACHEDä¸€æ ·ï¼Œä½†æ”¯æŒæ•°æ®ç»“æ„è€Œä¸æ˜¯ä»…ä»…æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ä½œä¸ºå€¼.Rediséå¸¸é€‚åˆç¼“å­˜æŸ¥æ‰¾éå¸¸é‡è¦ä»å¤–éƒ¨æœåŠ¡å™¨åˆ°AWS S3ï¼Œå¯ä»¥åŠ å¿«S3è¯»å–å¹¶å°†æ‚¨èŠ‚çœæ‚¨çš„èµ„é‡‘åœ¨ä¼ å‡ºæ•°æ®ä¼ è¾“æˆæœ¬ä¸Šã€‚æ— è®ºä½•ç§æ•°æ®é›†ï¼Œéƒ½å¯ä»¥é™åˆ¶åœ¨æœºå™¨ä¸Šçš„å¯ç”¨RAMçš„å¤§å°æ„å‘³ç€æ‚¨åªèƒ½ç¼“å­˜å°éƒ¨åˆ†æ‚¨å¯èƒ½çš„AWS S3 keys.Also with Redisï¼Œå¦‚æœSnapshottingå¤±è´¥ï¼Œå› ä¸ºæ‚¨å·²ç»ä½¿ç”¨äº†æ›´å¤šçš„RAMè€Œä¸æ˜¯å¯ç”¨ï¼Œé‚£ä¹ˆæ‚¨çš„å¿«ç…§å°†å¤±è´¥å¹¶å°†rediså®ä¾‹å¼ºåˆ¶è¿›å…¥åªè¯»æ¨¡å¼ã€‚è¿™æ„å‘³ç€æ‚¨çš„ç”Ÿäº§Redisæ•°æ®åº“å¯èƒ½çªç„¶åœæ­¢å…è®¸å†™é“ï¼Œç›´åˆ°ä½ é‡æ–°å¯åŠ¨å®ƒï¼Œyikesï¼ğŸ˜±</p><p>  Right now, you might be thinking of a solutionâ€¦ shard the data across a multi-machine Redis Cluster.That increases your max OPS, but also has some downsides:</p><p>  ç°åœ¨ï¼Œæ‚¨å¯èƒ½æ­£åœ¨è€ƒè™‘ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ......å°†æ•°æ®åˆ’åˆ†å¤šæœºREDISé›†ç¾¤ã€‚è¯¥æ‹†åˆ†MAXæ“ä½œï¼Œè¿˜æœ‰ä¸€äº›ç¼ºç‚¹ï¼š</p><p>   WakaTime uses  S3 as a database for user code stats, because hosting for traditional relational databases with data sets in the terabytes is expensive.Not to mention traditional relational databases donâ€™t have the reliability, resiliency, scalability, and serverless features of S3.</p><p>   Wakatimeä½¿ç”¨S3ä½œä¸ºç”¨æˆ·ä»£ç ç»Ÿè®¡æ•°æ®åº“ï¼Œå› ä¸ºæ‰˜ç®¡Terabytesä¸­çš„æ•°æ®é›†çš„ä¼ ç»Ÿå…³ç³»æ•°æ®åº“å¾ˆæ˜‚è´µã€‚è¦æåŠä¼ ç»Ÿå…³ç³»æ•°æ®åº“çš„ä¸å¯é æ€§ï¼Œå¼¹æ€§ï¼Œå¯ä¼¸ç¼©æ€§å’ŒS3çš„æ— æœåŠ¡å™¨åŠŸèƒ½ã€‚</p><p> WakaTime hosts programming dashboards on  DigitalOcean servers.Thatâ€™s because DigitalOcean servers come with dedicated attached SSDs, and overall give you much more compute bang for the buck than EC2.DigitalOceanâ€™s S3 compatible object storage service ( Spaces) is very inexpensive, but we couldnâ€™t use DigitalOcean Spaces for our primary database because itâ€™s  much slower than S3.</p><p> Wakatimeåœ¨DigitaloCean Serversä¸Šå¯„å‡ºç¼–ç¨‹ä»ªè¡¨æ¿ã€‚è¿™æ˜¯å› ä¸ºDigitalCeanæœåŠ¡å™¨å¸¦æœ‰ä¸“ç”¨çš„é™„åŠ SSDï¼Œè€Œä¸”æ€»ä½“ä¸ºæ‚¨æä¾›æ¯”EC2.DigItaloCeançš„S3å…¼å®¹å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ˆç©ºæ ¼ï¼‰æ›´åŠ çªå‡ºçš„è®¡ç®—çˆ†ç‚¸ï¼Œä½†æˆ‘ä»¬ä¸èƒ½æ˜¯éå¸¸ä¾¿å®œçš„ï¼Œä½†æˆ‘ä»¬ä¸èƒ½ä¸ºæˆ‘ä»¬çš„ä¸»æ•°æ®åº“ä½¿ç”¨DigitaloCean Spacesï¼Œå› ä¸ºå®ƒæ¯”S3æ…¢å¾—å¤šã€‚</p><p> Transferring data from S3 to DigitalOcean servers costs $0.09 per GB, because Amazon charges a higher price for outgoing data transfers vs internal transfers.Using S3 as a database was becoming a significant portion of our monthly AWS bill.</p><p> å°†æ•°æ®ä»S3è½¬ç§»åˆ°DigitaloCeanæœåŠ¡å™¨è´¹ç”¨$ 0.09æ¯ä¸ªGBï¼Œå› ä¸ºäºšé©¬é€Šä¸ºä¼ å‡ºæ•°æ®ä¼ è¾“çš„ä»·æ ¼è¾ƒé«˜ï¼Œå› ä¸ºæ•°æ®åº“ä½œä¸ºæ•°æ®åº“çš„é‡è¦ç»„æˆéƒ¨åˆ†æ˜¯æˆ‘ä»¬æ¯æœˆçš„ä¸€éƒ¨åˆ†ã€‚</p><p>  To reduce costs and improve performance, we tried caching S3 reads with Redis.However, with the cache size limited by RAM it barely made a dent in our reads from S3.The amount of RAM we would need to cache multiple terabytes of S3 data would easily cost more than our total AWS bill.Instead, we decided to try several disk-based Redis alternatives and found one that fit our needs perfectly.</p><p>  ä¸ºäº†é™ä½æˆæœ¬å¹¶æé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬å°è¯•äº†ä½¿ç”¨Redisçš„ç¼“å­˜S3è¯»å–ã€‚ç„¶è€Œï¼Œé€šè¿‡RAMé™åˆ¶çš„ç¼“å­˜å¤§å°ï¼Œä»S3ä¸­çš„è¯»å–ä¸­å‡ ä¹æ²¡æœ‰å‡¹é™·ã€‚æˆ‘ä»¬éœ€è¦ç¼“å­˜çš„RAMæ•°é‡çš„S3æ•°æ®çš„å¤šé‡æ•°æ®è½»æ¾æˆæœ¬è¶…è¿‡æˆ‘ä»¬çš„AWS Bill.Insteadï¼Œæˆ‘ä»¬å†³å®šå°è¯•å‡ ä¸ªåŸºäºç£ç›˜çš„Redisæ›¿ä»£æ–¹æ¡ˆï¼Œå¹¶æ‰¾åˆ°ä¸€ä¸ªé€‚åˆæˆ‘ä»¬éœ€æ±‚çš„å®Œç¾ã€‚</p><p>  Weâ€™ve been  using a disk-backed Redis alternative in production for over 3 years now called  SSDB.SSDB is a drop-in replacement for Redis, so you donâ€™t need to change any client libraries.It uses  LevelDB (a key-value storage library by Google) behind the scenes to achieve performance comparable to Redis. According to benchmarks, writes to SSDB are slightly slower but reads are actually faster than Redis!ğŸ˜²</p><p>  æˆ‘ä»¬å·²ç»åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨çš„ç£ç›˜å¤‡ä»½çš„Redisæ›¿ä»£å“è¶…è¿‡3å¹´ï¼Œç°åœ¨ç§°ä¸ºSSDB.SDBæ˜¯Redisçš„å¦ä¸€ä¸ªæ›¿ä»£å“ï¼Œå› æ­¤æ‚¨æ— éœ€æ›´æ”¹ä»»ä½•å®¢æˆ·ç«¯åº“ã€‚å®ƒä½¿ç”¨leveldbï¼ˆä¸€ä¸ªé”® - è°·æ­Œçš„ä»·å€¼å­˜å‚¨åº“ï¼‰åœ¨å¹•åå®ç°ä¸Redisç›¸å½“çš„æ€§èƒ½ã€‚æ ¹æ®åŸºå‡†æµ‹è¯•ï¼ŒSSDBçš„å†™å…¥ç•¥å¾®æ…¢ï¼Œä½†è¯»æ•°å®é™…ä¸Šæ¯”REDISå¿«ï¼ğŸ˜² </p><p> SSDB supports  replication built-in and clustering with  twemproxy.Most importantly, it stores your data set on disk using RAM for caching.Our SSDB data set is 500GB and does a good job of lowering the number of reads we make to S3.Remember to  increase the file-max of your SSDB server to at least 10k, to prevent getting errors like  Too many open files or  Connection reset by peer.Also, remember to periodically trigger garbage collection on your SSDB data files by running ssdb-cli compact with this crontab:</p><p>SSDBæ”¯æŒä¸Twemproxyçš„å¤åˆ¶å†…ç½®å’Œç¾¤é›†ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå°†æ‚¨çš„æ•°æ®è®¾ç½®åœ¨ç£ç›˜ä¸Šä½¿ç”¨RAMç”¨äºç¼“å­˜.OUS SSDBæ•°æ®é›†æ˜¯500GBï¼Œå¹¶ä¸”åœ¨S3.Rembermberé™ä½è¯»æ•°çš„è‰¯å¥½å·¥ä½œæ˜¯è‰¯å¥½çš„å·¥ä½œã€‚å°†SSDBæœåŠ¡å™¨çš„File-Maxå¢åŠ åˆ°è‡³å°‘10kï¼Œä»¥é˜²æ­¢åƒPeer.Alsoé‡ç½®è¿‡å¤šçš„æ‰“å¼€æ–‡ä»¶æˆ–è¿æ¥é‡ç½®é”™è¯¯ï¼Œè®°ä½é€šè¿‡è¿è¡ŒSSDB-CLI Compactä¸æ­¤å®šæœŸè§¦å‘SSDBæ•°æ®æ–‡ä»¶ä¸Šçš„åƒåœ¾æ”¶é›†CRONTABï¼š</p><p>  Or else youâ€™ll see your SSDB disk usage  grow forever even after deleting keys.</p><p>  å¦åˆ™æ‚¨å°†çœ‹åˆ°SSDBç£ç›˜ä½¿ç”¨ç‡å³ä½¿åœ¨åˆ é™¤é”®åä¹Ÿä¼šç”Ÿé•¿ã€‚</p><p>  Using SSDB to cache S3 has significantly reduced the outbound data transfer portion of our AWS bill! ğŸ‰With performance comparable to Redis and using the disk to bypass Redisâ€™s RAM limitation, SSDB is a powerful tool for lean startups.</p><p>  ä½¿ç”¨SSDBåˆ°ç¼“å­˜S3æ˜¾ç€å‡å°‘äº†æˆ‘ä»¬AWSè´¦å•çš„å‡ºç«™æ•°æ®ä¼ è¾“éƒ¨åˆ†ï¼ ğŸ‰ä¸redisçš„æ€§èƒ½ç›¸åª²ç¾å¹¶ä½¿ç”¨ç£ç›˜ç»•è¿‡redisçš„RAMé™åˆ¶ï¼ŒSSDBæ˜¯ä¸€ä¸ªå¼ºå¤§çš„ç²¾ç®€åˆ›ä¸šå·¥å…·ã€‚</p><p> If you liked this post, browse similar writeups using the  devops tag.To get started with your free code time insights today,  install the WakaTime plugin for your IDE.</p><p> å¦‚æœæ‚¨å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ä½¿ç”¨Devops Tagseæµè§ˆç±»ä¼¼çš„å†™ä½œ.Toç«‹å³å¼€å§‹ä½¿ç”¨æ‚¨çš„å…è´¹ä»£ç æ—¶é—´æ´å¯ŸåŠ›ï¼Œä¸ºIDEå®‰è£…Wakatimeæ’ä»¶ã€‚ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://wakatime.com/blog/45-using-a-diskbased-redis-clone-to-reduce-aws-s3-bill">https://wakatime.com/blog/45-using-a-diskbased-redis-clone-to-reduce-aws-s3-bill</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/s3/">#s3</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/based/">#based</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/redis/">#redis</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ†äº«/">#åˆ†äº«</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>