<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>MacOSç½‘å®ˆå’Œæ–‡ä»¶éš”ç»•è¡Œ macOS gatekeeper and file quarantine bypass</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">macOS gatekeeper and file quarantine bypass<br/>MacOSç½‘å®ˆå’Œæ–‡ä»¶éš”ç»•è¡Œ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-28 11:09:59</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/4/8eb17107aa6f71b7b42a18efd51ac2f5.png"><img src="http://img2.diglog.com/img/2021/4/8eb17107aa6f71b7b42a18efd51ac2f5.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>ğŸ‘¾ Want to play along? Iâ€™ve uploaded a sample  Proof of Conceptâ€¦when run, it simply pops Calculator.app.   âš ï¸ Malware</p><p>ğŸ‘¾æƒ³ç©å—ï¼Ÿæˆ‘ä¸Šä¼ äº†ä¸€ä¸ªæ¦‚å¿µæ ·æœ¬è¯æ˜...è¿è¡Œæ—¶ï¼Œå®ƒåªæ˜¯å¼¹å‡ºè®¡ç®—å™¨.Appã€‚ âš ï¸æ¶æ„è½¯ä»¶</p><p> Iâ€™ve also uploaded a malware sample ( Shlayer.zip) that exploited this vulnerability in the wild as a 0day! (password: infect3d)</p><p> æˆ‘è¿˜ä¸Šä¼ äº†ä¸€ä¸ªæ¶æ„è½¯ä»¶ç¤ºä¾‹ï¼ˆshlayer.zipï¼‰ï¼Œå®ƒåœ¨é‡å¤–çˆ†ç‚¸äº†è¿™ä¸ªæ¼æ´ï¼Œä½œä¸º0dayï¼ ï¼ˆå¯†ç ï¼šInfect3Dï¼‰</p><p>     &#34;All_Your_Macs_Are_Belong_To_Us.pdf&#34;.    But first, go update your macOS systems to 11.3, as it contains a patch for a massive bug that affects all recent versions of macOSâ€¦a bug that is the topic of this blog post.</p><p>     ï¼†ï¼ƒ34; all_your_macs_are_belong_to_us.pdfï¼†ï¼ƒ34;ä½†é¦–å…ˆï¼ŒGoå°†éº¦å…‹æ–¯ç³»ç»Ÿæ›´æ–°ä¸º11.3ï¼Œå› ä¸ºå®ƒåŒ…å«ä¸€ä¸ªåºå¤§çš„é”™è¯¯çš„ä¿®è¡¥ç¨‹åºï¼Œå®ƒä¼šå½±å“æ‰€æœ‰æœ€è¿‘ç‰ˆæœ¬çš„éº¦å…‹æ–¯...ä¸€ä¸ªæ˜¯è¿™ä¸ªåšå®¢æ–‡ç« ä¸»é¢˜çš„é”™è¯¯ã€‚</p><p> This bug trivially bypasses many core Apple security mechanisms, leaving Mac users at grave risk:</p><p> è¿™ä¸ªé”™è¯¯é€æ¸ç»•è¿‡äº†è®¸å¤šæ ¸å¿ƒAppleå®‰å…¨æœºåˆ¶ï¼Œè®©Macç”¨æˆ·å¤„äºä¸¥é‡é£é™©ï¼š</p><p>  opened â†’ owned â€¦and especially worrisome, turns out malware authors are  already exploiting it in the wild as an 0day. Yikes!</p><p>  æ‰“å¼€â†’æ‹¥æœ‰......ç‰¹åˆ«æ˜¯ä»¤äººæ‹…å¿§çš„æ˜¯ï¼Œæ‹’ç»æ¶æ„è½¯ä»¶ä½œè€…å·²ç»åœ¨é‡å¤–åˆ©ç”¨å®ƒä½œä¸º0dayã€‚å“å‘€ï¼</p><p> Apple patched the bug as CVE-2021-30657, noting &#34;a malicious application may bypass Gatekeeper checks&#34; The security researcher  Cedric Owens uncovered the flaw and initially reported the bug to Cupertino. Epic find Cedric! ğŸ¤©</p><p> Appleå°†Bugä¿®è¡¥ä¸ºCVE-2021-30657ï¼Œæ³¨æ„åˆ°ï¼†ï¼ƒ34;æ¶æ„ç”³è¯·å¯ä»¥ç»•è¿‡é—¨å«æ£€æŸ¥ï¼†ï¼ƒ34;å®‰å…¨ç ”ç©¶å‘˜CEDRIC OWENSæ­ç¤ºäº†ç¼ºé™·ï¼Œæœ€åˆå‘CUPERTINOæŠ¥å‘Šäº†é”™è¯¯ã€‚å²è¯—å‘ç°åº·å¤ï¼ ğŸ¤©</p><p> Cedric notes the bug manifested while building red team payloads via the  appify developer tool. Heâ€™s posted a must read, that provides step by step details on how this bug may be practically leveraged to surreptitiously deliver payloads in red team exercises:</p><p> CEDRICæ³¨æ„é€šè¿‡â€œåº”ç”¨â€å¼€å‘äººå‘˜å·¥å…·æ„å»ºçº¢è‰²å›¢é˜Ÿæœ‰æ•ˆè½½è·çš„åŒæ—¶è¡¨ç°å‡ºçš„é”™è¯¯ã€‚ä»–å‘å¸ƒäº†ä¸€ä¸ªå¿…é¡»è¯»å–çš„ï¼Œè¿™ä¸€æ­¥ä¸€æ­¥ä¸€æ­¥åœ°è¯¦ç»†è¯´æ˜è¿™ä¸ªé”™è¯¯æ˜¯å¦‚ä½•å®é™…åˆ©ç”¨ï¼Œä»¥å·å·åœ°åœ¨çº¢è‰²å›¢é˜Ÿç»ƒä¹ ä¸­å·å·åœ°æä¾›æœ‰æ•ˆè½½è·ï¼š </p><p>   &#34;macOS Gatekeeper Bypass (2021) Addition&#34;. However, as the underlying cause of the bug remained unknown, our blog post focuses on uncovering the reason â€¦ultimately discovering a flaw that lay deep within macOSâ€™s policy subsystem(s).</p><p>ï¼†ï¼ƒ34;éº¦æ–¯å¡æ–¯å®ˆé—¨äººæ—è·¯ï¼ˆ2021ï¼‰åŠ æ³•ï¼†ï¼ƒ34;ç„¶è€Œï¼Œéšç€é”™è¯¯çš„æ ¹æœ¬åŸå› ä»ç„¶æ˜¯æœªçŸ¥çš„ï¼Œæˆ‘ä»¬çš„åšå®¢æ–‡ç« ä¾§é‡äºæ­ç¤ºçš„åŸå› ......æœ€ç»ˆå‘ç°åœ¨éº¦æ–¯ç§‘æ–¯æ”¿ç­–å­ç³»ç»Ÿä¸­å¥ å®šæ·±å¤„çš„ç¼ºé™·ã€‚</p><p> Thereâ€™s a rather massive amount of information presented in this blog post, so letâ€™s break down what weâ€™re going to cover:</p><p> åœ¨è¿™ä¸ªåšå®¢æ–‡ç« ä¸­æä¾›äº†ç›¸å½“å¤§é‡çš„ä¿¡æ¯ï¼Œå› æ­¤è®©æˆ‘ä»¬åˆ†è§£æˆ‘ä»¬è¦è¦†ç›–çš„ä¸œè¥¿ï¼š</p><p> Background:   We begin the post with a discussion of common (user-assisted) infection vectors and highlight security mechanisms that Apple has introduced to keep users safe. It is important to understand these core macOS security mechanisms, as they are the very mechanisms the bug trivially and wholly bypasses.</p><p> èƒŒæ™¯ï¼šæˆ‘ä»¬å¼€å§‹è®¨è®ºæ™®é€šï¼ˆç”¨æˆ·è¾…åŠ©ï¼‰æ„ŸæŸ“è½½ä½“çš„å¸–å­ï¼Œå¹¶çªå‡ºè‹¹æœæ¨å‡ºçš„å®‰å…¨æœºåˆ¶ï¼Œä»¥ä½¿ç”¨æˆ·ä¿æŒå®‰å…¨ã€‚äº†è§£è¿™äº›æ ¸å¿ƒéº¦å…‹æ–¯çš„å®‰å…¨æœºåˆ¶éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒä»¬æ˜¯çç¢çš„é”™è¯¯å’Œå®Œå…¨ç»•è¿‡çš„é”™è¯¯ã€‚</p><p>    Root Cause Analysis:   The core of the blog post digs deep into the bowels of macOS to uncover the root cause of the bug. In this section, we&#39;ll detail the flaw which ultimately results in the misclassification of quarantined items, such as malicious applications. Such misclassified apps, even if unsigned (and unnotarized), will be allowed to run uninhibited. No alerts, no prompts, and not blocked. Oops!</p><p>    æ ¹æœ¬åŸå› åˆ†æï¼šåšå®¢å¸–å­çš„æ ¸å¿ƒæ·±å…¥æŒ–æ˜æ‘©æ‰˜æ–¯çš„è‚ é“ï¼Œæ­å¼€äº†é”™è¯¯çš„æ ¹æœ¬åŸå› ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ï¼†ï¼ƒ39;è¯·è¯¦ç»†è¯´æ˜ç¼ºé™·ï¼Œæœ€ç»ˆå¯¼è‡´è¢«éš”ç¦»ç‰©å“çš„é”™è¯¯åˆ†ç±»ï¼Œä¾‹å¦‚æ¶æ„åº”ç”¨ç¨‹åºã€‚è¿™ç§é”™è¯¯åˆ†ç±»çš„åº”ç”¨ç¨‹åºï¼Œå³ä½¿æ˜¯æ— ç¬¦å·ï¼ˆå’Œä¸æ’ä»–æ€§çš„ï¼‰ï¼Œå°†è¢«å…è®¸è¿è¡Œä¸ç¾ã€‚æ²¡æœ‰è­¦æŠ¥ï¼Œæ²¡æœ‰æç¤ºï¼Œæ²¡æœ‰é˜»æ­¢ã€‚å“å‘€ï¼</p><p>    In the Wild (0day):   Unfortunately a subversive malware installer is already exploiting this flaw in the wild, as a 0day. In this section of the post, we briefly discuss this worrisome finding.</p><p>    åœ¨é‡å¤–ï¼ˆ0dayï¼‰ï¼šä¸å¹¸çš„æ˜¯ï¼Œä¸€ä¸ªé¢ è¦†æ¶æ„è½¯ä»¶å®‰è£…ç¨‹åºå·²ç»åœ¨é‡å¤–åˆ©ç”¨è¿™ä¸ªç¼ºé™·ï¼Œä½œä¸º0dayã€‚åœ¨è¯¥å¸–å­çš„è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç®€è¦è®¨è®ºäº†è¿™ä¸ªä»¤äººæ‹…å¿§çš„å‘ç°ã€‚</p><p>    The Patch:   Next, after reverse-engineering Apple&#39;s 11.3 update, we describe how Cupertino addressed this flaw. And good news, once patched macOS users should regain full protection.</p><p>    è¡¥ä¸ï¼šæ¥ä¸‹æ¥ï¼Œé€†å‘å·¥ç¨‹è‹¹æœï¼†ï¼ƒ39; S 11.3æ›´æ–°åï¼Œæˆ‘ä»¬æè¿°äº†Cupertinoå¦‚ä½•è§£å†³è¿™ä¸ªç¼ºé™·ã€‚å’Œå¥½æ¶ˆæ¯ï¼Œä¸€æ—¦ä¿®è¡¥çš„æ‘©æ‰˜æ–¯ç”¨æˆ·åº”è¯¥é‡æ–°è·å¾—å…¨é¢ä¿æŠ¤ã€‚</p><p>    Protections &amp;  Detections:   Finally, we&#39;ll wrap things up with a brief discussion on protections, most notably highlighting the fact that  BlockBlock already provided sufficient protection against this 0day. Here, we&#39;ll also discuss a novel idea aimed at detecting previous attacks that exploited this flaw, and provide a simple Python script,  scan.py, to automate such detection!</p><p>    ä¿æŠ¤ï¼†amp;æ£€æµ‹ï¼šæœ€åï¼Œæˆ‘ä»¬ï¼†ï¼ƒ39; LLä»‹ç»äº†å…³äºä¿æŠ¤çš„ç®€è¦è®¨è®ºï¼Œæœ€æ˜¾ç€åœ°çªå‡ºäº†é˜»æ»å—å·²ç»æä¾›äº†è¶³å¤Ÿçš„ä¿æŠ¤ï¼Œè¿™æ˜¯å¯¹è¿™ä¸ª0dayçš„è¿™ç§äº‹å®ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ï¼†ï¼ƒ39; LLè¿˜è®¨è®ºäº†ä¸€ä¸ªæ–°é¢–çš„æƒ³æ³•ï¼Œæ—¨åœ¨æ£€æµ‹åˆ°æ”»å‡»è¿™ä¸ªç¼ºé™·çš„å…ˆå‰æ”»å‡»ï¼Œå¹¶æä¾›ç®€å•çš„Pythonè„šæœ¬ï¼ŒScan.pyæ¥è‡ªåŠ¨è§£å†³æ­¤ç±»æ£€æµ‹ï¼ </p><p>  The majority of Mac malware infections are a result of users (naively, or mistakenly) running something they should not. And while such infections, yes, do require user interaction, they are still massively successful. In fact, the recently discovered  Silver Sparrow malware, successfully infected over 30,000 Macs in a matter of weeks, even though such infections did require such user interactions. (See: â€œ Mysterious Silver Sparrow Malware Found Nesting on 30K Macs&#34;).</p><p>å¤§å¤šæ•°Macæ¶æ„è½¯ä»¶æ„ŸæŸ“æ˜¯ç”¨æˆ·ï¼ˆå¤©çœŸæˆ–é”™è¯¯ï¼‰è¿è¡Œä»–ä»¬ä¸åº”è¯¥çš„ç»“æœã€‚è™½ç„¶è¿™ç§æ„ŸæŸ“ï¼Œæ˜¯çš„ï¼Œä½†æ˜¯ï¼Œéœ€è¦ç”¨æˆ·äº’åŠ¨ï¼Œä½†å®ƒä»¬ä»ç„¶éå¸¸æˆåŠŸã€‚äº‹å®ä¸Šï¼Œæœ€è¿‘å‘ç°çš„Silver Sparrowæ¶æ„è½¯ä»¶ï¼Œåœ¨å‡ å‘¨å†…æˆåŠŸåœ°æ„ŸæŸ“äº†è¶…è¿‡30,000 Macï¼Œå³ä½¿æ­¤ç±»æ„ŸæŸ“ç¡®å®éœ€è¦è¿™æ ·çš„ç”¨æˆ·äº’åŠ¨ã€‚ ï¼ˆå‚è§ï¼šâ€œMysterious Silver Sparrow Malwareå‘ç°åœ¨30k Macsï¼†ï¼ƒ34;ï¼‰ä¸ŠåµŒå¥—ã€‚</p><p> And how do malware authors convince such users to infect themselves? Ah, in a myriad of creative, wily, and surreptitious ways such as:</p><p> æ¶æ„è½¯ä»¶ä½œè€…å¦‚ä½•è¯´æœè¿™äº›ç”¨æˆ·æ„ŸæŸ“è‡ªå·±ï¼Ÿå•Šï¼Œåœ¨ä¸€ä¸ªæ— æ•°çš„åˆ›é€ æ€§ï¼Œç‹¡çŒ¾ï¼Œå·å·æ‘¸æ‘¸çš„æ–¹å¼ï¼Œå¦‚ï¼š</p><p>  Yes, when the user falls for some of these infection vectors (e.g. pirated applications) we collectively shake our heads and wonder â€œ well, what did you expect!?&#34;, however other infection vectors are far more surreptitious and arguably the user is not at fault in any way. For example, in a supply chain attack, where a legitimate software distribution website is hacked and legitimate products are trojanized, itâ€™s unreasonable to blame any user who inadvertently downloads and runs such software.</p><p>  æ˜¯çš„ï¼Œå½“ç”¨æˆ·è½ä¸‹ä¸€äº›æ„ŸæŸ“è½½ä½“ï¼ˆä¾‹å¦‚ç›—ç‰ˆåº”ç”¨ç¨‹åºï¼‰æ—¶ï¼Œæˆ‘ä»¬å…±åŒæ‘‡åŠ¨æˆ‘ä»¬çš„å¤´è„‘å’Œå¥‡è¿¹â€œå¥½å§ï¼Œä½ æœŸæœ›äº†ä»€ä¹ˆï¼ï¼Ÿï¼†ï¼ƒ34;ä½†å…¶ä»–æ„ŸæŸ“è½½ä½“æ›´ä¾§è§†ï¼Œå¯ä»¥è¯´ä¸æ˜¯ä»¥ä»»ä½•æ–¹å¼éƒ½æ²¡æœ‰é”™ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¾›åº”é“¾æ”»å‡»ä¸­ï¼Œè¢«é»‘å®¢æ”»å‡»å’Œåˆæ³•äº§å“çš„åŸºå‡†æ”»å‡»ï¼Œå¹¶ä¸”ç‰¹åˆ¶äºç‰¹æ´›ä¼Šï¼Œå› æ­¤è´£å¤‡æ— æ„ä¸­ä¸‹è½½å¹¶è¿è¡Œæ­¤ç±»è½¯ä»¶çš„ç”¨æˆ·æ˜¯ä¸åˆç†çš„ã€‚</p><p> Regardless of whoâ€™s at fault (or not), Apple seems to feel personally attacked. Besides of course wanting whatâ€™s best for their  shareholders users, they have an image to uphold! Remember, â€œ Macs Donâ€™t Get Malware!â€ (tm).</p><p> æ— è®ºè°åœ¨æ•…éšœï¼ˆæˆ–ä¸ï¼‰ï¼Œè‹¹æœä¼¼ä¹éƒ½æ„Ÿåˆ°äº²è‡ªæ”»å‡»ã€‚é™¤äº†æƒ³è¦å¯¹ä»–ä»¬çš„è‚¡ä¸œç”¨æˆ·æœ€é€‚åˆçš„è¯¾ç¨‹ï¼Œä»–ä»¬æœ‰ä¸€ä¸ªç§‰æ‰¿çš„å½¢è±¡ï¼è¯·è®°ä½ï¼Œâ€œMacä¸ä¼šå¾—åˆ°æ¶æ„è½¯ä»¶ï¼â€ ï¼ˆTmå€¼ï¼‰ã€‚</p><p> All kidding (and criticisms) aside, over the years Apple has taken several important steps aimed at preventing any and all â€œuser-assistedâ€ infections. Here, we briefly recap such major steps that include the addition of OS-level security mechanisms such as File Quarantine, Gatekeeper, and Application Notarization. An understanding of these foundation macOS protection mechanism is important as many users, and even some enterprises have come to (solely) depend on them. Which is fine(ish), unless Apple ships buggy code that undermines all such protections!</p><p> é™¤äº†å¤šå¹´æ¥ï¼Œæ‰€æœ‰å¼€ç©ç¬‘ï¼ˆå’Œæ‰¹è¯„ï¼‰ï¼Œè‹¹æœéƒ½é‡‡å–äº†å‡ ä¸ªé‡è¦çš„æ­¥éª¤ï¼Œæ—¨åœ¨é¢„é˜²ä»»ä½•å’Œæ‰€æœ‰â€œç”¨æˆ·è¾…åŠ©â€æ„ŸæŸ“ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç®€è¦é‡æ–°å›é¡¾äº†åŒ…æ‹¬æ·»åŠ OSçº§å®‰å…¨æœºåˆ¶ï¼ˆå¦‚æ–‡ä»¶éš”ç¦»ï¼Œç½‘å®ˆå’Œåº”ç”¨å…¬è¯ï¼‰çš„ä¸»è¦æ­¥éª¤ã€‚å¯¹è¿™äº›åŸºç¡€Macosä¿æŠ¤æœºåˆ¶çš„ç†è§£æ˜¯é‡è¦çš„ï¼Œå› ä¸ºè®¸å¤šç”¨æˆ·éƒ½å¾ˆé‡è¦ï¼Œç”šè‡³ä¸€äº›ä¼ä¸šå·²ç»åˆ°äº†ï¼ˆå®Œå…¨ï¼‰å–å†³äºä»–ä»¬ã€‚é™¤éAppleèˆ¹èˆ¶ç ´åäº†æ‰€æœ‰æ­¤ç±»ä¿æŠ¤çš„é”™è¯¯ä»£ç ï¼Œå¦åˆ™è¿™æ˜¯ç½šæ¬¾ï¼ˆISHï¼‰ï¼</p><p>  File Quarantine, was introduced in OSX Leopard (10.5), all the way back in 2007! When a user first opens a downloaded file such as an application, File Quarantine provides a warning to the user that requires explicit confirmation before allowing the file to execute. The idea is simply to ensure that the user understands that they are indeed opening an application (even if the file looks like, say, a PDF document).</p><p>  æ–‡ä»¶éš”ç¦»ï¼Œåœ¨osxè±¹ï¼ˆ10.5ï¼‰ä¸­å¼•å…¥äº†2007å¹´çš„ä¸€è·¯è¿”å›ï¼å½“ç”¨æˆ·é¦–å…ˆæ‰“å¼€è¯¸å¦‚åº”ç”¨ç¨‹åºçš„ä¸‹è½½æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶éš”ç¦»åŒºå‘ç”¨æˆ·æä¾›äº†åœ¨å…è®¸æ–‡ä»¶æ‰§è¡Œä¹‹å‰éœ€è¦æ˜¾å¼ç¡®è®¤çš„è­¦å‘Šã€‚è¿™ä¸ªæƒ³æ³•åªæ˜¯ä¸ºäº†ç¡®ä¿ç”¨æˆ·ç†è§£å®ƒä»¬ç¡®å®æ‰“å¼€äº†åº”ç”¨ç¨‹åºï¼ˆå³ä½¿æ–‡ä»¶çœ‹èµ·æ¥åƒï¼Œä¾‹å¦‚ï¼ŒPDFæ–‡æ¡£ï¼‰ã€‚</p><p> For an example of File Quarantine in action letâ€™s look at the  OSX.LaoShu malware. In order to surreptitiously trick users into infecting themselves, attackers sent targeted victims customized emails with a link to a malicious URL. If the user clicked on the link, a malicious application (masquerading as a PDF document) would be automatically downloaded:</p><p> æœ‰å…³æ–‡ä»¶éš”ç¦»çš„ç¤ºä¾‹ï¼Œè¯·å…è®¸æˆ‘ä»¬æŸ¥çœ‹osx.laoshuæ¶æ„è½¯ä»¶ã€‚ä¸ºäº†è®©ç”¨æˆ·å·å·æ‘¸æ‘¸è‡ªå·±æ„ŸæŸ“è‡ªå·±ï¼Œæ”»å‡»è€…å°†é’ˆå¯¹æ€§å—å®³è€…å‘é€å®šåˆ¶çš„ç”µå­é‚®ä»¶ä¸æ¶æ„URLçš„é“¾æ¥ã€‚å¦‚æœç”¨æˆ·ç‚¹å‡»é“¾æ¥ï¼Œå°†è‡ªåŠ¨ä¸‹è½½æ¶æ„åº”ç”¨ç¨‹åºï¼ˆä¼ªè£…ä¸ºPDFæ–‡æ¡£ï¼‰ï¼š </p><p>  A malicious app (OSX.LaoShu), masquerading as a PDF (image credit: Sophos). If the user would attempt to open what they (understandably) believed was a PDF document, File Quarantine would spring into action, alerting the user that this was in fact an application,  not a harmless PDF document:</p><p>æ¶æ„åº”ç”¨ç¨‹åºï¼ˆOSX.Laoshuï¼‰ï¼Œä¼ªè£…ä¸ºPDFï¼ˆå›¾ç‰‡ä¿¡ç”¨ï¼šSophosï¼‰ã€‚å¦‚æœç”¨æˆ·å°†å°è¯•æ‰“å¼€å®ƒä»¬ï¼ˆå¯ç†è§£ï¼‰è®¤ä¸ºæ˜¯PDFæ–‡æ¡£ï¼Œåˆ™æ–‡ä»¶éš”ç¦»ä¼šå°†å¼¹å‡ºåˆ°è¡ŒåŠ¨ï¼Œè­¦å‘Šç”¨æˆ·å®é™…ä¸Šæ˜¯ä¸€ä¸ªç”³è¯·ï¼Œè€Œä¸æ˜¯æ— å®³çš„PDFæ–‡ä»¶ï¼š</p><p>  File Quarantine in action (image credit: Sophos). Ideally the user would recognize their (near) faux pas and the infection would be thwarted thanks to File Quarantine! It should be noted that even today, a File Quarantine prompt is shown for approved (i.e. notarized) applications.</p><p>  æ–‡ä»¶éš”ç¦»åœ¨è¡ŒåŠ¨ä¸­ï¼ˆå›¾åƒä¿¡ç”¨ï¼šSophosï¼‰ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œç”¨æˆ·å°†è®¤è¯†åˆ°ä»–ä»¬çš„ï¼ˆè¿‘çš„ï¼‰äººé€ PASï¼Œæ„Ÿè°¢æ–‡ä»¶æ£€ç–«å°†è¢«æŒ«è´¥ï¼åº”è¯¥æŒ‡å‡ºçš„æ˜¯ï¼Œå³ä½¿åœ¨ä»Šå¤©ï¼Œæ‰¹å‡†çš„ï¼ˆå³å…¬è¯ï¼‰ç”³è¯·çš„æ–‡ä»¶éš”ç¦»æç¤ºä¹Ÿä¼šæ˜¾ç¤ºã€‚</p><p>  Unfortunately users kept infecting themselves, often by ignoring or simply clicking through File Quarantine alerts. To combat this, as well as evolving malware infection vectors, Apple introduced Gatekeeper in OSX Lion (10.7). Built atop File Quarantine, Gatekeeper checks the code signing information of downloaded items and blocks those that do not adhere to system policies. (For example, it checks that items are signed with a valid developer ID):</p><p>  é—æ†¾çš„æ˜¯ï¼Œç”¨æˆ·é€šå¸¸é€šè¿‡å¿½ç•¥æˆ–åªéœ€é€šè¿‡æ–‡ä»¶éš”ç¦»è­¦æŠ¥æ¥æ„ŸæŸ“è‡ªå·±ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»¥åŠä¸æ–­å‘å±•æ¶æ„è½¯ä»¶æ„ŸæŸ“è½½ä½“ï¼ŒAppleåœ¨osxç‹®å­ï¼ˆ10.7ï¼‰ä¸­å¼•å…¥äº†é—¨å®ˆã€‚å†…ç½®æ–‡ä»¶éš”ç¦»ï¼Œç½‘å®ˆæ£€æŸ¥ä¸‹è½½é¡¹ç›®çš„ä»£ç ï¼Œå¹¶é˜»æ­¢é‚£äº›ä¸éµå®ˆç³»ç»Ÿç­–ç•¥çš„ä¿¡æ¯ã€‚ ï¼ˆä¾‹å¦‚ï¼Œå®ƒæ£€æŸ¥é¡¹ç›®æ˜¯å¦ä½¿ç”¨æœ‰æ•ˆçš„å¼€å‘äººå‘˜IDç­¾åï¼‰ï¼š</p><p>  A Gatekeeper overview Appleâ€™s logic was rooted in the (mis)belief that malware authors would not be able to obtain such Apple Developer IDs, and thus their malware would remain unsigned and thus generically blocked by Gatekeeper. In the image above, note that when unsigned malware is executed, Gatekeeper will block it and alert the user. Moreover, there is no option in the Gatekeeper prompt to allow the (unsigned) code to run. Thus the user is protected. Hooray?</p><p>  ä¸€ä¸ªç½‘å®ˆæ¦‚è¿°Appleçš„é€»è¾‘æ¤æ ¹äºï¼ˆMISï¼‰ä¿¡å¿µä¸­ï¼Œæ¶æ„è½¯ä»¶ä½œè€…æ— æ³•è·å¾—æ­¤ç±»Appleå¼€å‘äººå‘˜IDï¼Œå› æ­¤ä»–ä»¬çš„æ¶æ„è½¯ä»¶å°†ä¿æŒæ— ç¬¦å·ï¼Œå› æ­¤ç”±Gatekeeperæ…·æ…¨åœ°é˜»æ­¢ã€‚åœ¨ä¸Šé¢çš„å›¾åƒä¸­ï¼Œæ³¨æ„å½“æ‰§è¡Œæœªç­¾åçš„æ¶æ„è½¯ä»¶æ—¶ï¼Œç½‘å®ˆå°†é˜»æ­¢å¹¶è­¦å‘Šç”¨æˆ·ã€‚æ­¤å¤–ï¼Œç½‘å®ˆæç¤ºæ²¡æœ‰é€‰é¡¹ä»¥å…è®¸ï¼ˆæœªç­¾åï¼‰çš„ä»£ç è¿è¡Œã€‚å› æ­¤ï¼Œç”¨æˆ·å—åˆ°ä¿æŠ¤ã€‚èµ«é›·ï¼Ÿ</p><p> Of course it turned to be fairly trivial for attackers to obtain Apple Developer IDs and thus sign their malicious creations. For example in a supply chain attack against the popular  MacUpdate.com website, attackers trojanized and (re)signed popular software such as Firefox:</p><p> å½“ç„¶ï¼Œå®ƒè½¬èº«å¯¹æ”»å‡»è€…è·å¾—è‹¹æœå¼€å‘äººå‘˜IDçš„ç›¸å½“å¾®ä¸è¶³é“ï¼Œä»è€Œç­¾ç½²ä»–ä»¬çš„æ¶æ„åˆ›ä½œã€‚ä¾‹å¦‚ï¼Œåœ¨å¯¹æµè¡Œçš„Macupdate.comç½‘ç«™çš„ä¾›åº”é“¾æ”»å‡»ä¸­ï¼Œæ”»å‡»è€…Trojanizedå’Œï¼ˆREï¼‰ç­¾ç½²äº†Firefoxç­‰æµè¡Œè½¯ä»¶ï¼š</p><p>  Trojanized Firefox (note: &#34;Developer ID Application: Ramos Jaxson&#34;) If users downloaded and ran the trojanized Firefox, Gatekeeper would allow it â€¦as it was â€œvalidlyâ€ (re)signed. Thus the system would be infected.</p><p>  Trojanized Firefoxï¼ˆæ³¨æ„ï¼šï¼†ï¼ƒ34;å¼€å‘äººå‘˜IDåº”ç”¨ç¨‹åºï¼šRamos Jaxsonï¼†ï¼ƒ34;ï¼‰å¦‚æœç”¨æˆ·ä¸‹è½½å¹¶è¿è¡Œäº†Trojanized Firefoxï¼Œåˆ™ç½‘å®ˆå°†å…è®¸å®ƒ......å› ä¸ºå®ƒæ˜¯â€œæœ‰æ•ˆåœ°â€ï¼ˆREï¼‰ç­¾åã€‚å› æ­¤ï¼Œç³»ç»Ÿå°†è¢«æ„ŸæŸ“ã€‚</p><p> Unfortunately even today, itâ€™s still trivial for attackers to obtain such Apple Developer IDs and thus sign their malicious creations:</p><p> é—æ†¾çš„æ˜¯ï¼Œå³ä½¿åœ¨ä»Šå¤©ï¼Œæ”»å‡»è€…ä»ç„¶çç¢çš„æ”»å‡»è€…è·å¾—æ­¤ç±»Appleå¼€å‘äººå‘˜IDï¼Œå› æ­¤ç­¾ç½²æ¶æ„åˆ›ä½œï¼š </p><p>  I noticed dozen websites flourishing (even through google ads) for buying/selling/renting Apple developer entreprise accounts and Apple developer certificates. I guess the macOS malware season has started ğŸ˜‚ğŸŒ»ğŸŒ¼  pic.twitter.com/PQnrUKQhUF</p><p>æˆ‘æ³¨æ„åˆ°åå‡ ä¸ªç½‘ç«™ç¹è£ï¼ˆç”šè‡³é€šè¿‡è°·æ­Œå¹¿å‘Šï¼‰è´­ä¹°/é”€å”®/ç§Ÿç”¨Appleå¼€å‘äººå‘˜ä¼ä¸šè´¦æˆ·å’ŒAppleå¼€å‘äººå‘˜è¯ä¹¦ã€‚æˆ‘çŒœéº¦æ–¯ç§‘æ–¯æ¶æ„è½¯ä»¶å·²ç»å¼€å§‹ğŸ˜‚ğŸŒ»ğŸŒ¼pic.twitter.com/pqnrukqhuf</p><p>â€” taha karim ×– (@lordx64)  April 3, 2021</p><p> -  Taha Karim×–ï¼ˆ@ Lordx64ï¼‰4æœˆ3æ—¥ï¼Œ2021å¹´4æœˆ3æ—¥</p><p> It should be noted that even if Gatekeeper is bypassed a File Quarantine prompt would still be shown to the user. Recall that such a prompt requires explicit user-approval. Still, as Gatekeeper failed to be a panacea, Apple had to respond â€¦yet again.</p><p> åº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿ç½‘å®ˆè¢«ç»•è¿‡æ–‡ä»¶éš”ç¦»æç¤ºï¼Œä»å°†æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚å›æƒ³ä¸€ä¸‹ï¼Œè¿™æ ·çš„æç¤ºéœ€è¦æ˜ç¡®çš„ç”¨æˆ·æ‰¹å‡†ã€‚å°½ç®¡å¦‚æ­¤ï¼Œç”±äºå®ˆé—¨äººæœªèƒ½æˆä¸ºçµä¸¹å¦™è¯ï¼Œè‹¹æœå¿…é¡»å†æ¬¡å›åº”......åˆä¸€æ¬¡ã€‚</p><p>  Most recently, macOS Catalina (10.15) took yet another step at combating user-assisted infections with the introduction of Application Notarization requirements. These requirements ensure that Apple has scanned and approved all software before it is allowed to run, giving users, (as noted by Apple), â€œconfidenceâ€ that the software, â€œhas been checked for malicious componentsâ€:</p><p>  æœ€è¿‘ï¼ŒMacOS Catalinaï¼ˆ10.15ï¼‰åœ¨å¼•å…¥åº”ç”¨å…¬è¯è¦æ±‚æ—¶ï¼Œåœ¨æ‰“å‡»ç”¨æˆ·è¾…åŠ©æ„ŸæŸ“çš„å¦ä¸€æ­¥ã€‚è¿™äº›è¦æ±‚ç¡®ä¿è‹¹æœåœ¨å…è®¸è¿è¡Œä¹‹å‰æ‰«æå¹¶æ‰¹å‡†æ‰€æœ‰è½¯ä»¶ï¼Œç»™äºˆç”¨æˆ·ï¼Œï¼ˆå¦‚è‹¹æœæŒ‡å‡ºçš„ï¼‰ï¼Œâ€œä¿¡å¿ƒâ€é‚£ä¸ªè½¯ä»¶ï¼Œâ€œå·²ç»æ£€æŸ¥äº†æ¶æ„ç»„ä»¶â€ï¼š</p><p>  A notarization overview Note that similar to a Gatekeeper alert, in a Notarization alert there is no option for the user to allow the unnotarized code to run. Thus code that has not been scanned and notarized by Apple will be blocked.</p><p>  å…¬è¯æ¦‚è¿°æ³¨æ„ï¼Œç±»ä¼¼äºç½‘å®ˆè­¦æŠ¥ï¼Œåœ¨å…¬è¯è­¦æŠ¥ä¸­ï¼Œç”¨æˆ·æ— æ³•é€‰ä¸­å…è®¸ä¸ä¼ è¾¾çš„ä»£ç è¿è¡Œã€‚å› æ­¤ï¼ŒAppleæœªè¢«æ‰«æå’Œå…¬è¯çš„ä»£ç å°†è¢«é˜»æ­¢ã€‚</p><p> Notarization is clearly the most draconian, yet arguably â€œbestâ€ approach yet to protect macOS users from inadvertently infecting themselves.â€¦and rather humorously has resulted in hackers sliding into my DMs, as notarization apparently ruined their whole operation. Ha!</p><p> å…¬è¯æ˜¾è€Œæ˜“è§çš„æ˜¯æœ€å…·æ­¦è£…ç»„ç»‡ï¼Œä½†å¯ä»¥è¯´æ˜¯â€œæœ€å¥½çš„â€æ–¹æ³•ï¼Œå°šæœªä¿æŠ¤éº¦æ–¯ç§‘æ–¯å·ç”¨æˆ·ä»æ— æ„ä¸­æ„ŸæŸ“è‡ªå·±ã€‚......è€Œä¸”ç›¸å½“æ‚²æƒ¨å¯¼è‡´é»‘å®¢æ»‘å…¥æˆ‘çš„DMSï¼Œå› ä¸ºå…¬è¯æ˜¾ç„¶æ¯äº†ä»–ä»¬çš„æ•´ä¸ªæ“ä½œã€‚å“ˆï¼</p><p>  Notarization vs. Hackers  Before we detail a logic flaw in macOS that allows an attacker to trivially and reliably bypass  all of these foundational mitigations, letâ€™s briefly talk about the quarantine attribute. You may have been wondering, how does macOS know to analyze a file in order to possibly display a File Quarantine, Gatekeeper, or Notarization prompt? The answer is the quarantine attribute!</p><p>  å…¬è¯ä¸é»‘å®¢åœ¨æˆ‘ä»¬è¯¦ç»†ä»‹ç»éº¦å…‹æ–¯ä¸­çš„é€»è¾‘ç¼ºé™·ä¹‹å‰ï¼Œå…è®¸æ”»å‡»è€…è¿›è¡Œå¾®ä¸è¶³é“ï¼Œå¯é åœ°ç»•è¿‡æ‰€æœ‰è¿™äº›åŸºç¡€ï¼Œè®©æˆ‘ä»¬ç®€è¦ä»‹ç»éš”ç¦»åŒºå±æ€§ã€‚æ‚¨å¯èƒ½ä¸€ç›´åœ¨æƒ³ï¼Œéº¦å…‹æ–¯å¦‚ä½•çŸ¥é“å¦‚ä½•åˆ†ææ–‡ä»¶ï¼Œä»¥ä¾¿å¯èƒ½æ˜¾ç¤ºæ–‡ä»¶éš”ç¦»ï¼Œç½‘å®ˆæˆ–å…¬è¯æç¤ºï¼Ÿç­”æ¡ˆæ˜¯Quarantineå±æ€§ï¼ </p><p> Simply put, whenever an item is downloaded from the Internet (via an application such as a browser), macOS or the application that downloaded the item, will tag it with an extended attribute, named  com.apple.quarantine. You can confirm this for yourself. First download any file via your browser and then run macOSâ€™s â€œextended attributeâ€ utility,  xattr along with the path to file:</p><p>åªéœ€æ”¾ç½®ï¼Œåªè¦é¡¹ç›®ä»Internetï¼ˆé€šè¿‡è¯¸å¦‚æµè§ˆå™¨çš„åº”ç”¨ç¨‹åºï¼‰ä¸‹è½½ï¼Œéº¦æ–¯å¡æ–¯æˆ–ä¸‹è½½è¯¥é¡¹ç›®çš„åº”ç”¨ç¨‹åºï¼Œéƒ½å°†ä½¿ç”¨åä¸ºcom.apple.quartineçš„æ‰©å±•å±æ€§æ ‡è®°ä¸ºå®ƒã€‚æ‚¨å¯ä»¥ä¸ºè‡ªå·±ç¡®è®¤è¿™ä¸€ç‚¹ã€‚é¦–å…ˆé€šè¿‡æµè§ˆå™¨ä¸‹è½½ä»»ä½•æ–‡ä»¶ï¼Œç„¶åè¿è¡ŒMacOSçš„â€œæ‰©å±•å±æ€§â€å®ç”¨ç¨‹åºï¼ŒXATTRä»¥åŠæ–‡ä»¶è·¯å¾„ï¼š</p><p>  Note that the  -p option will print out the contents of the specified extended attribute. For the  com.apple.quarantine this includes various flags, a time stamp, the responsible application that downloaded the file, and a UUID that maps to a key in the  com.apple.LaunchServices.QuarantineEventsV* database.</p><p>  è¯·æ³¨æ„ï¼Œ-pé€‰é¡¹å°†æ‰“å°å‡ºæŒ‡å®šçš„æ‰©å±•å±æ€§çš„å†…å®¹ã€‚å¯¹äºcom.apple.quartineè¿™åŒ…æ‹¬å„ç§æ ‡å¿—ï¼Œæ—¶é—´æˆ³ï¼Œä¸‹è½½æ–‡ä»¶çš„è´Ÿè´£ä»»çš„åº”ç”¨ç¨‹åºï¼Œä»¥åŠæ˜ å°„åˆ°com.apple.launchservices.quarantineventsv *æ•°æ®åº“ä¸­çš„å¯†é’¥çš„uuidã€‚</p><p> Whenever the user first attempts to open a file that contains a quarantine attribute (i.e. anything downloaded from the Internet), macOS will launch the process in a suspended state. Then, the system will perform a myriad of complex checks on the file, designed to trigger the appropriate alert or prompt. On modern versions of macOS the user will either be shown:</p><p> æ¯å½“ç”¨æˆ·é¦–æ¬¡å°è¯•æ‰“å¼€åŒ…å«éš”ç¦»å±æ€§çš„æ–‡ä»¶ï¼ˆå³ä»Internetä¸‹è½½çš„ä»»ä½•å†…å®¹ï¼‰ï¼Œéº¦æ–¯ç§‘åº§å°†åœ¨æš‚åœçŠ¶æ€ä¸‹å¯åŠ¨è¿›ç¨‹ã€‚ç„¶åï¼Œç³»ç»Ÿå°†åœ¨æ–‡ä»¶ä¸Šæ‰§è¡Œæ— æ•°çš„å¤æ‚æ£€æŸ¥ï¼Œæ—¨åœ¨è§¦å‘é€‚å½“çš„è­¦æŠ¥æˆ–æç¤ºã€‚åœ¨ç°ä»£ç‰ˆæœ¬çš„MacOSä¸Šï¼Œç”¨æˆ·å°†è¢«æ˜¾ç¤ºï¼š</p><p> A (File Quarantine) prompt requiring explicit user consent (if the item is validly signed and notarized).  â€¦or</p><p> aï¼ˆæ–‡ä»¶éš”ç¦»åŒºï¼‰æç¤ºè¦æ±‚æ˜ç¡®çš„ç”¨æˆ·åŒæ„ï¼ˆå¦‚æœé¡¹ç›®æœ‰æ•ˆç­¾åå’Œå…¬è¯ï¼‰ã€‚ â€¦æˆ–è€…</p><p> A (Notarization) alert informing the user that the file cannot be run (if the item is not validly signed and notarized).</p><p> aï¼ˆå…¬è¯ï¼‰è­¦æŠ¥é€šçŸ¥ç”¨æˆ·æ— æ³•è¿è¡Œæ–‡ä»¶ï¼ˆå¦‚æœé¡¹ç›®æœªæœ‰æ•ˆåœ°ç­¾åå’Œå…¬è¯ï¼‰ã€‚</p><p> If the process is allowed (signed &amp; notarized) and the user approves it, the system will then unsuspend (resume) it â€¦allowing it to now execute.</p><p> å¦‚æœå…è®¸è¯¥è¿‡ç¨‹ï¼ˆç­¾åï¼†amp;å…¬è¯ï¼‰å’Œç”¨æˆ·æ‰¹å‡†ï¼Œåˆ™ç³»ç»Ÿå°†æ¯«æ— ç–‘é—®ï¼ˆæ¢å¤ï¼‰å®ƒ...å…è®¸å®ƒç°åœ¨æ‰§è¡Œã€‚</p><p> If a file does not contain the com.apple.quarantine attribute, macOS assumes it&#39;s a local file. As such, none of the checks will be performed and thus no prompts/alerts will be shown. This is by design, and is not a bug.  While this means malware that is  already on the box can download unsigned/unnotarized (second-stage) payloads, strip the quarantine attribute, then launch said payloads without fear of alerts â€¦the fact remains the  initial malware (or its delivery mechanism) will possess the quarantine attribute, and thus will be subjected to such checks and/or alerts when launched.</p><p> å¦‚æœæ–‡ä»¶ä¸åŒ…å«com.apple.quartineå±æ€§ï¼Œåˆ™MacOSå‡å®šå®ƒï¼†ï¼ƒ39; sä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ã€‚å› æ­¤ï¼Œå‡æœªæ‰§è¡Œä»»ä½•æ£€æŸ¥ï¼Œå› æ­¤ä¸ä¼šæ˜¾ç¤ºæç¤º/è­¦æŠ¥ã€‚è¿™æ˜¯é€šè¿‡è®¾è®¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªé”™è¯¯ã€‚è™½ç„¶è¿™æ„å‘³ç€å·²ç»åœ¨æ¡†ä¸Šçš„æ¶æ„è½¯ä»¶å¯ä»¥ä¸‹è½½æ— ç¬¦å·/ä¸æ’ä»–æ€§ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰æœ‰æ•ˆè½½è·ï¼Œä½†æ˜¯å‰¥ç¦»éš”ç¦»åŒºå±æ€§ï¼Œç„¶åå¯åŠ¨æ‰€è¿°æœ‰æ•ˆè´Ÿè½½è€Œä¸æ‹…å¿ƒè­¦æŠ¥......äº‹å®ä»ç„¶æ˜¯åˆå§‹æ¶æ„è½¯ä»¶ï¼ˆæˆ–å…¶äº¤ä»˜æœºåˆ¶ï¼‰å°†æ‹¥æœ‰éš”ç¦»å±æ€§ï¼Œå› æ­¤å°†åœ¨æ¨å‡ºæ—¶è¿›è¡Œæ­¤ç±»æ”¯ç¥¨å’Œ/æˆ–è­¦æŠ¥ã€‚ </p><p> But what if I told you there was a trivial and reliable way to bypass any and all such prompts!? â€¦meaning, if a user simply double-clicks on the file, game freaking over!? ğŸ¥²</p><p>ä½†å¦‚æœæˆ‘å‘Šè¯‰è¿‡ä½ ï¼Œç»•è¿‡ä»»ä½•å’Œæ‰€æœ‰æ­¤ç±»æç¤ºï¼Œé‚£ä¹ˆä½•æ—¶ä½•åœ°ç»•è¿‡ä»»ä½•çç¢å’Œå¯é çš„æ–¹å¼ï¼ï¼Ÿ ......æ„æ€ï¼Œå¦‚æœç”¨æˆ·åªéœ€åŒå‡»è¯¥æ–‡ä»¶ï¼Œæ¸¸æˆå“åäº†ï¼ï¼Ÿ ğŸ¥²</p><p>  Since 2007 (when File Quarantine was introduced) macOS has alerted users whenever they attempt to launch an application that has been downloaded from the Internet. And now, on recent versions of macOS, unless that application has been scanned and explicitly approved (notarized) by Apple, macOS will refuse to run the file â€¦or will it!?</p><p>  è‡ª2007å¹´ä»¥æ¥ï¼ˆå¼•å…¥æ–‡ä»¶éš”ç¦»åŒºæ—¶ï¼‰éº¦æ–¯ç§‘æ–¯é˜Ÿå¯åŠ¨äº†ç”¨æˆ·åœ¨å°è¯•å¯åŠ¨ä»äº’è”ç½‘ä¸‹è½½çš„åº”ç”¨ç¨‹åºæ—¶æé†’ç”¨æˆ·ã€‚è€Œç°åœ¨ï¼Œåœ¨æœ€è¿‘çš„éº¦æ–¯ç§‘æ–¯ç‰ˆæœ¬ä¸­ï¼Œé™¤éè¯¥ç”³è¯·å·²ç»è¢«Appleæ‰«æå¹¶æ˜ç¡®æ‰¹å‡†ï¼ˆå…¬è¯ï¼‰ï¼Œå®å°†æ‹’ç»è¿è¡Œè¯¥æ–‡ä»¶......æˆ–è€…ä¼šæ‹’ç»ï¼</p><p> Unfortunately as weâ€™ll see, due to a subtle logic bug deep within Appleâ€™s policy engine, it was possible to craft a malicious application that though unsigned (and hence unnotarized), would be allowed to launch with no prompts nor alerts. No File Quarantine prompt, no Gatekeeper alert, no Notarization alert â€¦nothing!</p><p> ä¸å¹¸çš„æ˜¯ï¼Œç”±äºAppleçš„ç­–ç•¥å¼•æ“ä¸­æ·±å…¥äº†è§£äº†ä¸€ä¸ªå¾®å¦™çš„é€»è¾‘é”™è¯¯ï¼Œå¯ä»¥åˆ¶ä½œä¸€ä¸ªæ¶æ„åº”ç”¨ç¨‹åºï¼Œè™½ç„¶æ— ç¬¦å·ï¼ˆå¹¶ä¸”å› æ­¤ä¸å…¬å¼€ï¼‰ï¼Œå°†è¢«å…è®¸åœ¨æ²¡æœ‰æç¤ºå’Œè­¦æŠ¥æ—¶å¯åŠ¨ã€‚æ²¡æœ‰æ–‡ä»¶éš”ç¦»æç¤ºï¼Œæ²¡æœ‰ç½‘å®ˆè­¦æŠ¥ï¼Œæ²¡æœ‰å…¬è¯è­¦æŠ¥......æ²¡æœ‰ï¼</p><p> In the following demo, a proof of concept application named â€œPatricks_Resumeâ€ is downloaded. Though it appears to be a harmless PDF document, when opened, though unsigned, unnotarized, and quarantined, itâ€™s able to launch Calculator.app (or really do pretty much anything else):</p><p> åœ¨ä»¥ä¸‹æ¼”ç¤ºä¸­ï¼Œä¸‹è½½äº†åä¸ºâ€œpatricks_resumeâ€çš„æ¦‚å¿µåº”ç”¨ç¨‹åºçš„è¯æ˜ã€‚è™½ç„¶å®ƒä¼¼ä¹æ˜¯ä¸€ä¸ªæ— å®³çš„PDFæ–‡ä»¶ï¼Œä½†æ˜¯åœ¨æ‰“å¼€æ—¶ï¼Œè™½ç„¶æ— ç¬¦å·ï¼Œä¸é€šçš„å’Œéš”ç¦»ï¼Œä½†å®ƒèƒ½å¤Ÿå¯åŠ¨Calculator.Appï¼ˆæˆ–è€…çœŸçš„åšå¾—å‡ ä¹æ²¡æœ‰å…¶ä»–äº‹æƒ…ï¼‰ï¼š</p><p>  Note that the exploited system is a fully patched M1 Macbook, running the latest macOS Big Sur (11.2.3).</p><p>  è¯·æ³¨æ„ï¼Œå·²å‰¥å‰Šçš„ç³»ç»Ÿæ˜¯ä¸€ä¸ªå®Œå…¨ä¿®è¡¥çš„M1 MacBookï¼Œè¿è¡Œæœ€æ–°çš„MacOS Big Surï¼ˆ11.2.3ï¼‰ã€‚</p><p>     Unsigned, unnotarized, and quarantined  It appears that this bug was introduced in macOS 10.15 ...thus older versions of macOS do not seem be vulnerable. If I had to guess, it was likely introduced along with macOS 10.15â€™s new notarization logic. Thus the goal of attempting to secure and lock down macOS wholly backfired:</p><p>     æ¯«æ— ç¬¦å·ï¼Œä¸æ’ä»–æ€§å’Œéš”ç¦»ï¼Œä¼¼ä¹åœ¨MacOSä¸­å¼•å…¥äº†æ­¤é”™è¯¯...å› æ­¤ï¼Œæ—§ç‰ˆæœ¬çš„å®ä¼¼ä¹å¹¶ä¸è„†å¼±ã€‚å¦‚æœæˆ‘ä¸å¾—ä¸çŒœåˆ°ï¼Œå¾ˆå¯èƒ½ä¸MacOS 10.15çš„æ–°å…¬è¯é€»è¾‘ä¸€èµ·å¼•å…¥ã€‚å› æ­¤ï¼Œå°è¯•å®‰å…¨å’Œé”å®šå®çš„ç›®æ ‡æ˜¯å®Œå…¨è¢«åé¦ˆçš„ï¼š</p><p>  ...meanwhile, at Cupertino? (image credit: @urupzia)</p><p>  ......åŒæ—¶ï¼Œåœ¨Cupertinoï¼Ÿ ï¼ˆå›¾ç‰‡ä¿¡ç”¨ï¼š@URUPZIAï¼‰ </p><p>  Obviously this vulnerability is massively bad, as it affords malware authors the ability to return to their proven methods of targeting and infecting macOS users. Though weâ€™ll talk about 3rd-party methods of protections (that existed before Appleâ€™s patch!) as well as methods of detections exploitation attempts of this bug, first letâ€™s walk through the process of uncovering the root cause, the underlying flaw.</p><p>æ˜¾ç„¶ï¼Œè¿™ç§æ¼æ´æ˜¯éå¸¸ç³Ÿç³•çš„ï¼Œå› ä¸ºå®ƒæä¾›äº†æ¶æ„è½¯ä»¶ä½œè€…çš„èƒ½åŠ›è¿”å›ä»–ä»¬ç»è¿‡éªŒè¯çš„ç›®æ ‡å’Œæ„ŸæŸ“éº¦æ–¯ç§‘æ–¯ç”¨æˆ·çš„æ–¹æ³•ã€‚è™½ç„¶æˆ‘ä»¬å°†è°ˆè®ºç¬¬ä¸‰æ–¹ä¿æŠ¤æ–¹æ³•ï¼ˆè‹¹æœçš„è¡¥ä¸ä¹‹å‰å­˜åœ¨ï¼ï¼‰ä»¥åŠæ£€æµ‹è¯¥é”™è¯¯çš„å‰¥å‰Šå°è¯•æ–¹æ³•ï¼Œé¦–å…ˆè®©æˆ‘ä»¬èµ°è¿‡æ­å¼€æ ¹æœ¬åŸå› çš„è¿‡ç¨‹ï¼Œæ½œåœ¨çš„ç¼ºé™·ã€‚</p><p> Our analysis was performed on a fully patched macOS Big Sur (11.2.3) system. Due to &#34;security&#34; features on M1 systems (that hinder debugging), we&#39;ll stick to a Intel/x86_64 system. However as the flaw is a logic issue, the systems underlying architecture is irrelevant (as illustrated in the exploitation of a M1 system in the video above).</p><p> æˆ‘ä»¬çš„åˆ†ææ˜¯å¯¹å®Œå…¨ä¿®è¡¥çš„éº¦æ–¯ç§‘æ–¯å¤§å­¦ï¼ˆ11.2.3ï¼‰ç³»ç»Ÿè¿›è¡Œçš„ã€‚ç”±äºï¼†ï¼ƒ34;å®‰å…¨ï¼†ï¼ƒ34; M1ç³»ç»Ÿä¸Šçš„åŠŸèƒ½ï¼ˆé˜»ç¢è°ƒè¯•ï¼‰ï¼Œæˆ‘ä»¬ï¼†ï¼ƒ39; LLåšæŒåˆ°è‹±ç‰¹å°”/ X86_64ç³»ç»Ÿã€‚ç„¶è€Œï¼Œéšç€ç¼ºé™·æ˜¯é€»è¾‘é—®é¢˜ï¼Œåº•å±‚æ¶æ„çš„ç³»ç»Ÿæ˜¯æ— å…³çš„ï¼ˆå¦‚ä¸Šé¢è§†é¢‘ä¸­çš„M1ç³»ç»Ÿçš„å¼€å‘æ–¹å¼æ‰€ç¤ºï¼‰ã€‚</p><p> Though the underlying flaw is found deep in the bowels of macOS, donâ€™t worry weâ€™ll gently ease in.</p><p> è™½ç„¶æ½œåœ¨çš„ç¼ºé™·åœ¨éº¦å…‹æ–¯çš„è‚ å­æ·±å¤„å‘ç°ï¼Œä½†ä¸è¦æ‹…å¿ƒæˆ‘ä»¬ä¼šè½»æ¾åœ°è½»æ¾ã€‚</p><p> First, take a look at the our proof of concept application ( PoC.app) that triggers the vulnerability (as this will be launched with no alerts nor prompts, even though itâ€™s unsigned, unnotarized, and quarantined).</p><p> é¦–å…ˆï¼ŒæŸ¥çœ‹æˆ‘ä»¬å¯¹è§¦å‘æ¼æ´çš„æ¦‚å¿µåº”ç”¨ç¨‹åºï¼ˆPoc.Appï¼‰çš„è¯æ˜ï¼ˆå› ä¸ºè¿™å°†æ— æ³•æé†’ï¼Œå³ä½¿å®ƒæ˜¯æ— ç¬¦å·ï¼Œä¸æ’ä»–æ€§å’Œéš”ç¦»çš„ï¼‰ã€‚</p><p>  Our proof of concept application   The applicationâ€™s bundle is â€œmissingâ€ several standard components, most notably there is no  Info.plist file. (An  Info.plist file contains meta information about an application, such as the path to its executable).   Instead, the application is solely composed of a directory named  PoC.app, a  Contents subdirectory, a  MacOS sub-subdirectory, and then within that, a file whose name matches that of the (top-level) application ( PoC).</p><p>  æˆ‘ä»¬çš„æ¦‚å¿µåº”ç”¨è¯æ˜åº”ç”¨ç¨‹åºçš„æ†ç»‘åŒ…æ˜¯â€œç¼ºå°‘â€å‡ ä¸ªæ ‡å‡†ç»„ä»¶ï¼Œæœ€å€¼å¾—æ³¨æ„çš„æ˜¯æ²¡æœ‰ä¿¡æ¯æ–‡ä»¶ã€‚ ï¼ˆINFO.PLISTæ–‡ä»¶åŒ…å«æœ‰å…³åº”ç”¨ç¨‹åºçš„å…ƒä¿¡æ¯ï¼Œä¾‹å¦‚å…¶å¯æ‰§è¡Œâ€‹â€‹æ–‡ä»¶çš„è·¯å¾„ï¼‰ã€‚ç›¸åï¼Œåº”ç”¨ç¨‹åºä»…ç”±åä¸ºPoC.Appçš„ç›®å½•ï¼Œå†…å®¹å­ç›®å½•ï¼Œéº¦æ–¯ç§‘ç¾¤ç»„å­ç›®å½•ï¼Œç„¶ååœ¨å…¶ä¸­çš„æ–‡ä»¶ä¸­ç»„æˆï¼Œè¯¥æ–‡ä»¶ä¸ï¼ˆé¡¶çº§ï¼‰åº”ç”¨ç¨‹åºï¼ˆPoCï¼‰åŒ¹é…çš„æ–‡ä»¶ã€‚</p><p> The applicationâ€™s executable component ( PoC) is not a mach-O binary, but rather a (bash) script:</p><p> åº”ç”¨ç¨‹åºçš„å¯æ‰§è¡Œç»„ä»¶ï¼ˆPoCï¼‰ä¸æ˜¯Mach-OäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œæ˜¯Aï¼ˆBashï¼‰è„šæœ¬ï¼š</p><p> In terms of the first observation, it turns out that many of the standard components of an applicationâ€™s bundle (e.g. the  Info.plist file) are indeed optional. In fact, it appears that the system treats anything that ends in  .app as an application. To test this, simply create an empty folder name  foo.app and double-click it. Though it errors out (as itâ€™s just a folder, with no executable content), the error prompt confirms that the system did indeed try to launch it as an application:</p><p> å°±ç¬¬ä¸€æ¬¡è§‚å¯Ÿè€Œè¨€ï¼Œäº‹å®è¯æ˜ï¼Œåº”ç”¨ç¨‹åºæ†ç»‘åŒ…çš„è®¸å¤šæ ‡å‡†ç»„ä»¶ï¼ˆä¾‹å¦‚ï¼ŒINFO.PLISTæ–‡ä»¶ï¼‰ç¡®å®æ˜¯å¯é€‰çš„ã€‚äº‹å®ä¸Šï¼Œç³»ç»Ÿä¼¼ä¹å°†åœ¨.appä¸­ä½œä¸ºåº”ç”¨ç¨‹åºç»“æŸçš„ä»»ä½•ä¸œè¥¿ã€‚è¦æµ‹è¯•æ­¤åŠŸèƒ½ï¼Œåªéœ€åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹åç§°foo.appå¹¶åŒå‡»å®ƒã€‚è™½ç„¶å®ƒé”™è¯¯ï¼ˆå› ä¸ºå®ƒåªæ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œæ²¡æœ‰å¯æ‰§è¡Œå†…å®¹ï¼‰ï¼Œä½†é”™è¯¯æç¤ºç¡®è®¤ç³»ç»Ÿç¡®å®å°è¯•å°†å…¶æ¨å‡ºä¸ºåº”ç”¨ç¨‹åºï¼š </p><p>  ...tried (and failed) to launch as an app Turns out, if we add a  Contents folder, then (within that) a  MacOS folder, and finally (within that) an executable item â€¦it will successfully run! Though rather bare-boned, thatâ€™s apparently all thatâ€™s needed. Itâ€™s worth reiterating that without an  Info.plist file, the executable itemâ€™s name,  must match the name of the application. This is how macOS is still able to ascertain what to execute when the user double clicks the â€œappâ€. Hence, for our bare-bones proof of concept application ( PoC.app), the itemâ€™s name must be  PoC:</p><p>...é€šè¿‡åº”ç”¨ç¨‹åºæ¥å¯åŠ¨ï¼ˆå’Œå¤±è´¥ï¼‰æ¥å¯åŠ¨ï¼ˆå¦‚æœæˆ‘ä»¬æ·»åŠ å†…å®¹æ–‡ä»¶å¤¹ï¼Œé‚£ä¹ˆï¼ˆåœ¨å…¶ä¸­ï¼‰éº¦æ–¯ç§‘ç¾¤å²›æ–‡ä»¶å¤¹ä¸­ï¼Œæœ€åï¼ˆåœ¨é‚£ä¹‹å†…ï¼‰å¯ä»¥æˆåŠŸè¿è¡Œï¼è™½ç„¶ç›¸å½“èµ¤è£¸è£¸çš„æ˜¯ï¼Œè¿™æ˜¾ç„¶æ˜¯æ‰€éœ€è¦çš„ã€‚å€¼å¾—é‡æ–°é‡æ–°ä»‹ç»ï¼Œæ²¡æœ‰info.plistæ–‡ä»¶ï¼Œå¯æ‰§è¡Œé¡¹ç›®çš„åç§°å¿…é¡»ä¸åº”ç”¨ç¨‹åºçš„åç§°åŒ¹é…ã€‚è¿™å°±æ˜¯MacOSä»ç„¶èƒ½å¤Ÿç¡®å®šå½“ç”¨æˆ·åŒå‡»â€œAppâ€æ—¶æ‰§è¡Œçš„å†…å®¹ã€‚å› æ­¤ï¼Œå¯¹äºæˆ‘ä»¬çš„è£¸éª¨æ¦‚å¿µåº”ç”¨ç¨‹åºï¼ˆPoC.Appï¼‰è¯æ˜ï¼Œé¡¹ç›®çš„åç§°å¿…é¡»æ˜¯PoCï¼š</p><p>  Our bare-boned PoC app&#39;s bundle structure  The &#34; appify&#34; developer script on github, will programmatically create such a bare-bones application for you (that unintentionally, will trigger this vulnerability).</p><p>  æˆ‘ä»¬è£¸BOCåº”ç”¨ç¨‹åºï¼†ï¼ƒ39; Sæ†ç»‘ç»“æ„ï¼†ï¼ƒ34; Appifyï¼†ï¼ƒ34; GitHubä¸Šçš„å¼€å‘äººå‘˜è„šæœ¬å°†ä»¥ç¼–ç¨‹æ–¹å¼ä¸ºæ‚¨åˆ›å»ºå¦‚æ­¤è£¸éœ²çš„åº”ç”¨ç¨‹åºï¼ˆæ— æ„ä¸­ä¼šè§¦å‘æ­¤æ¼æ´ï¼‰ã€‚</p><p> Before moving on, letâ€™s ratchet up macOS application policy to its highest and most restrictive level, so that only applications from the macOS app store are allowed. In theory this means that external applications, even if notarized will be blocked by the OS:</p><p> åœ¨ç»§ç»­å‰è¿›ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å°†MacOSåº”ç”¨ç¨‹åºç­–ç•¥é¢ ç°¸åˆ°æœ€é«˜ï¼Œæœ€ä¸¥æ ¼çš„çº§åˆ«ï¼Œä»¥ä¾¿åªå…è®¸æ¥è‡ªéº¦æ–¯ç§‘åº§åº”ç”¨å•†åº—çš„åº”ç”¨ç¨‹åºã€‚åœ¨ç†è®ºä¸Šè¿™æ„å‘³ç€å¤–éƒ¨åº”ç”¨ç¨‹åºï¼Œå³ä½¿å…¬è¯åŒ–å°†è¢«æ“ä½œç³»ç»Ÿé˜»æ­¢ï¼š</p><p>  Application policy Itâ€™s important though to note that the vulnerability also presents itself at lower / the default policy settings. That is to say, it is unrelated and unaffected by the system policy settings.</p><p>  åº”ç”¨ç¨‹åºç­–ç•¥è™½ç„¶æŒ‡å‡ºï¼Œè¯¥æ¼æ´è¿˜å‘ˆç°è¾ƒä½/é»˜è®¤ç­–ç•¥è®¾ç½®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ˜¯ä¸ç›¸å…³çš„å¹¶ä¸”ä¸å—ç³»ç»Ÿç­–ç•¥è®¾ç½®çš„å½±å“ã€‚</p><p> Letâ€™s now upload this â€œbare-bonesâ€ application, and then download it to simulate an attack. Once downloaded, we can confirm that, as expected, the application has been automatically tagged with the  com.apple.quarantine extended attribute:</p><p> è®©æˆ‘ä»¬ç°åœ¨ä¸Šä¼ è¿™ä¸ªâ€œè£¸éª¨â€åº”ç”¨ç¨‹åºï¼Œç„¶åä¸‹è½½å®ƒæ¥æ¨¡æ‹Ÿæ”»å‡»ã€‚ä¸€æ—¦ä¸‹è½½ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤ï¼Œæ­£å¦‚æ‰€é¢„æœŸçš„é‚£æ ·ï¼Œåº”ç”¨ç¨‹åºå·²è‡ªåŠ¨ä½¿ç”¨com.apple.quartineæ‰©å±•å±æ€§è‡ªåŠ¨æ ‡è®°ï¼š</p><p>  Thus we can assume (and later confirm) that the bug is not related to a missing (or say corrupted)  com.apple.quarantine attribute. And due to the presence of this quarantine attribute, weâ€™ll see it will  still be evaluated by macOSâ€™s â€œshould-this-application-be-allowed-to-runâ€ logic.</p><p>  å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾ï¼ˆå¹¶ç¨åç¡®è®¤ï¼‰è¯¥é”™è¯¯ä¸ä¸¢å¤±ï¼ˆæˆ–æŸåï¼‰com.apple.quartineå±æ€§æ— å…³ã€‚ç”±äºå­˜åœ¨æ­¤éš”ç¦»å±æ€§ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å®ƒä»å°†é€šè¿‡MacOSçš„â€œåº”è¯¥ - æ­¤åº”ç”¨ç¨‹åºè¢«å…è®¸è¿è¡Œâ€é€»è¾‘è¯„ä¼°ã€‚</p><p> We can also confirm (via a tools such as  WhatsYourSign), that the application is unsigned (and thus also unnotarized):</p><p> æˆ‘ä»¬è¿˜å¯ä»¥ç¡®è®¤ï¼ˆé€šè¿‡è¯¸å¦‚Whatsyoursignç­‰å·¥å…·ï¼‰ï¼Œè¯¥åº”ç”¨ç¨‹åºæ˜¯æ— ç¬¦å·ï¼ˆå› æ­¤ä¹Ÿä¸æ˜¯ä¸åè°ƒï¼‰ï¼š </p><p>  PoC.app: unsigned/unnotarized Due to the fact that the application has been tagged with a quarantine attribute, and that it is unsigned (and thus not notarized), one would certainly think it would be soundly blocked by macOS. But as we noted early this is not the case â€¦itâ€™s allowed to run uninhibited.</p><p>poc.appï¼šç”±äºåº”ç”¨ç¨‹åºå·²è¢«æ ‡è®°ä¸ºéš”ç¦»å±æ€§ï¼Œå¹¶ä¸”å®ƒæ˜¯æ— ç¬¦å·ï¼ˆå› æ­¤æœªå…¬è¯ï¼‰çš„äº‹å®ï¼Œå› æ­¤è‚¯å®šä¼šè®¤ä¸ºå®ƒä¼šè¢«å®å°é”æ‰€å°é”çš„äº‹å®ï¼Œå› ä¸ºå®ƒæ¯«æ— ç¬¦åˆã€‚ä½†æ­£å¦‚æˆ‘ä»¬æ—©æ—©æ‰€è¯´ï¼Œè¿™ä¸æ˜¯è¿™ç§æƒ…å†µ......å®ƒè¢«å…è®¸è¿è¥ä¸ç¾ã€‚</p><p> As the quarantined application is allowed (with no alerts nor prompts), this implies a bug is somewhere in macOSâ€™s application â€œevaluationâ€ logic. Unfortunately (for us), when a user launches an application no less than half a dozen user-mode applications, system daemons and the kernel are involved.</p><p> ç”±äºå…è®¸éš”ç¦»çš„åº”ç”¨ç¨‹åºï¼ˆæ²¡æœ‰è­¦æŠ¥æˆ–æç¤ºï¼‰ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªé”™è¯¯æ˜¯éº¦æ–¯ç§‘æ–¯å·åº”ç”¨ç¨‹åºâ€œè¯„ä¼°â€é€»è¾‘çš„æŸä¸ªé”™è¯¯ã€‚ä¸å¹¸çš„æ˜¯ï¼ˆå¯¹äºæˆ‘ä»¬ï¼‰ï¼Œå½“ç”¨æˆ·å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶ä¸å°‘äºæœ‰å¤šæ¬¡ç”¨æˆ·æ¨¡å¼åº”ç”¨ç¨‹åºï¼Œæ¶‰åŠç³»ç»Ÿå®ˆæŠ¤ç¨‹åºå’Œå†…æ ¸ã€‚</p><p> In a 2016 talk at ShmooCon titled, â€œ Gatekeeper Exposed; Come, See, Conquer&#34;, I provided a detailed (although now somewhat dated) walk-through of these interactions:</p><p> åœ¨2016å¹´åœ¨Shmooconçš„è°ˆè¯ä¸­æ ‡é¢˜ä¸ºâ€œGatekeeperæš´éœ²â€æ¥å§ï¼Œçœ‹ï¼Œå¾æœï¼†ï¼ƒ34;æˆ‘æä¾›äº†è¯¦ç»†çš„ï¼ˆè™½ç„¶ç°åœ¨æœ‰äº›æ—¥æœŸäº†ï¼‰è¿™äº›äº’åŠ¨ï¼š</p><p>  Launching an application is a complicated ordeal Since this talk, Apple has expanded (read: complicated) this process, adding XPC calls into its system policy daemon,  syspolicyd, and its XProtect (anti-virus) agent,  XprotectService.</p><p>  å¯åŠ¨åº”ç”¨ç¨‹åºæ˜¯ä¸€ä¸ªå¤æ‚çš„æŠ˜ç£¨ï¼Œå› ä¸ºæ­¤è¯è¯­ä»¥æ¥ï¼ŒAppleå·²æ‰©å±•ï¼ˆé˜…è¯»ï¼šå¤æ‚ï¼‰æ­¤è¿‡ç¨‹ï¼Œå°†XPCè°ƒç”¨æ·»åŠ åˆ°å…¶ç³»ç»Ÿç­–ç•¥å®ˆæŠ¤ç¨‹åºï¼ŒsyspolicydåŠå…¶xprotectï¼ˆåç—…æ¯’ï¼‰ä»£ç†ï¼Œxprotectserviceã€‚</p><p> Instead of painstakingly walking through every single one of these interprocess and kernel interactions, letâ€™s see if we can first zero in on the likely location of the bug via a more passive approach â€¦log messages!</p><p> è€Œä¸æ˜¯ç…è´¹è‹¦å¿ƒåœ°è¡Œèµ°æ¯ä¸€ä¸ªå£å­¦å’Œå†…æ ¸äº’åŠ¨ï¼Œè€Œè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬æ˜¯å¦å¯ä»¥é€šè¿‡æ›´å¤šè¢«åŠ¨æ–¹æ³•æ¥é¦–å…ˆå½’é›¶ã€‚æ—¥å¿—æ¶ˆæ¯ï¼</p><p>  Recall that our problematic proof of concept application is a rather abnormal â€œbare-bonesâ€ application whose executable component is a script (versus a normal mach-O binary).</p><p>  å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„æ¦‚å¿µåº”ç”¨ç¨‹åºè¯æ˜æ˜¯ä¸€ä¸ªç›¸å½“å¼‚å¸¸çš„â€œè£¸éª¨â€åº”ç”¨ç¨‹åºï¼Œå…¶å¯æ‰§è¡Œç»„ä»¶æ˜¯è„šæœ¬ï¼ˆä¸æ­£å¸¸MACH-OäºŒè¿›åˆ¶ï¼‰ã€‚</p><p> Our idea to get a better sense of where the bug may lie is rather simple. While monitoring system logs letâ€™s run:</p><p> æˆ‘ä»¬çš„æƒ³æ³•è®©è™«å­å¯èƒ½æ’’è°çš„æ›´å¥½çš„ä½ç½®ç›¸å½“ç®€å•ã€‚ç›‘è§†ç³»ç»Ÿæ—¥å¿—è®©æˆ‘ä»¬è¿è¡Œï¼š </p><p> A â€œnormalâ€ application â€¦containing the standard application bundle files (such as an  Info.plist file), as well as standard mach-O executable.</p><p>ä¸€ä¸ªâ€œæ­£å¸¸â€åº”ç”¨ç¨‹åº...åŒ…å«æ ‡å‡†åº”ç”¨ç¨‹åºæ†ç»‘æ–‡ä»¶ï¼ˆä¾‹å¦‚Info.Plistæ–‡ä»¶ï¼‰ï¼Œä»¥åŠæ ‡å‡†MACH-Oå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p> A script-based application ( Script.app) â€¦containing the standard application bundle files (such as an  Info.plist file), but a (bash) script as its executable.</p><p> åŸºäºè„šæœ¬çš„åº”ç”¨ç¨‹åºï¼ˆScript.Appï¼‰...åŒ…å«æ ‡å‡†åº”ç”¨ç¨‹åºåŒ…æ–‡ä»¶ï¼ˆä¾‹å¦‚Info.Plistæ–‡ä»¶ï¼‰ï¼Œä½†æ˜¯ï¼ˆBashï¼‰è„šæœ¬ä½œä¸ºå…¶å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p> Our proof-of-concept application ( PoC.app) â€¦missing the standard application bundle files (such as an  Info.plist file),  and having a (bash) script as its executable.</p><p> æˆ‘ä»¬çš„æ¦‚å¿µéªŒè¯åº”ç”¨ç¨‹åºï¼ˆPoC.Appï¼‰...ç¼ºå°‘æ ‡å‡†åº”ç”¨ç¨‹åºåŒ…æ–‡ä»¶ï¼ˆä¾‹å¦‚info.plistæ–‡ä»¶ï¼‰ï¼Œå¹¶å°†ï¼ˆbashï¼‰è„šæœ¬ä½œä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p> All three are unsigned and downloaded from the Internet (i.e. tagged with the  com.apple.quarantine extended attribute). As the â€œnormalâ€ and script-based application are both blocked (as expected) ideally weâ€™ll quickly uncover any divergent logic which can point us decisively in the direction of a bug which allows our PoC to run!</p><p> è¿™ä¸‰ä¸ªéƒ½æ˜¯æ— ç¬¦å·çš„ï¼Œä»äº’è”ç½‘ä¸Šä¸‹è½½ï¼ˆå³ï¼Œç”¨com.apple.quartineæ‰©å±•å±æ€§æ ‡è®°ï¼‰ã€‚éšç€â€œæ­£å¸¸â€å’ŒåŸºäºè„šæœ¬çš„åº”ç”¨ç¨‹åºéƒ½è¢«é˜»æ­¢ï¼ˆå¦‚é¢„æœŸï¼‰ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†è¿…é€Ÿæ­ç¤ºä»»ä½•ä¸åŒçš„é€»è¾‘ï¼Œè¿™äº›é€»è¾‘å¯ä»¥åœ¨å…è®¸æˆ‘ä»¬PoCè¿è¡Œçš„é”™è¯¯æ–¹å‘ä¸Šæœæ–­åœ°æŒ‡å‘æˆ‘ä»¬ï¼</p><p> On recent versions of macOS, Apple has unified all logging and provided a new utility (aptly named)  log to parse and view all log messages. If executed with the  stream parameter, the  log utility will s</p><p> åœ¨æœ€è¿‘çš„éº¦å…‹æ–¯ç‰ˆæœ¬ä¸Šï¼ŒAppleç»Ÿä¸€æ‰€æœ‰æ—¥å¿—è®°å½•ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæ–°çš„å®ç”¨ç¨‹åºï¼ˆAptlyå‘½åï¼‰æ—¥å¿—æ¥è§£æå¹¶æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—æ¶ˆæ¯ã€‚å¦‚æœä½¿ç”¨Streamå‚æ•°æ‰§è¡Œï¼Œåˆ™æ—¥å¿—å®ç”¨ç¨‹åºå°†æ˜¯</p><p>......</p><p>...... </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://objective-see.com/blog/blog_0x64.html">https://objective-see.com/blog/blog_0x64.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/ç½‘å®ˆ/">#ç½‘å®ˆ</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/åº”ç”¨ç¨‹åº/">#åº”ç”¨ç¨‹åº</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ†äº«/">#åˆ†äº«</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>