<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Node.example.comæ˜¯IPåœ°å€ Node.example.com Is an IP Address</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Node.example.com Is an IP Address<br/>Node.example.comæ˜¯IPåœ°å€ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-29 14:33:23</div><div class="page_narrow text-break page_content"><p>Hello! Welcome to the once-yearly blog post! This year I&#39;d like to examine themost peculiar bug I encountered at work. To set the stage, let&#39;s start with alittle background. ğŸ“š</p><p>ä½ å¥½ï¼æ¬¢è¿æ¥åˆ°æ¯å¹´ä¸€æ¬¡çš„åšå®¢æ–‡ç« ï¼ä»Šå¹´ï¼Œæˆ‘æƒ³ç ”ç©¶ä¸€ä¸‹æˆ‘åœ¨å·¥ä½œä¸­é‡åˆ°çš„æœ€å¥‡æ€ªçš„é”™è¯¯ã€‚ä¸ºäº†åšå¥½å‡†å¤‡ï¼Œè®©æˆ‘ä»¬ä»å„ç§èƒŒæ™¯å¼€å§‹ã€‚ ğŸ“š</p><p> When we write  URLs with a  non-standard  port wespecify the port after a  :. With  hostnames and  IPv4 addressesthis is straightforward. Here&#39;s some  Python code to show how easy it is.</p><p> å½“æˆ‘ä»¬ä½¿ç”¨éæ ‡å‡†ç«¯å£ç¼–å†™URLæ—¶ï¼Œè¯·åœ¨ï¼šä¹‹åæŒ‡å®šç«¯å£ã€‚ä½¿ç”¨ä¸»æœºåå’ŒIPv4åœ°å€ï¼Œè¿™å¾ˆç®€å•ã€‚è¿™æ˜¯ä¸€äº›Pythonä»£ç ï¼Œä»¥æ˜¾ç¤ºå®ƒæ˜¯å¤šä¹ˆå®¹æ˜“ã€‚</p><p>   &gt;&gt;&gt;  url  =  urllib.parse.urlparse( ...  &#34;https://fdc8:bf8b:e62c:abcd:1111:2222:3333:4444:8000&#34; ... ) ... &gt;&gt;&gt;  url.hostname &#39;fdc8&#39; &gt;&gt;&gt;  try : ...  url.port ...  except  ValueError  as  error: ...  print (error) ...Port could  not  be cast to integer value  as   &#39;bf8b:e62c:abcd:1111:2222:3333:4444:8000&#39;</p><p>   ï¼†gt;ï¼†gt;ï¼†gt; url = urllib.parse.urlparseï¼ˆ...ï¼†ï¼ƒ34; httpsï¼š// fdc8ï¼šbf8bï¼še62cï¼šabcdï¼š1111ï¼š2222ï¼š3333ï¼š4444ï¼š8000ï¼†ï¼ƒ34; ...ï¼‰...ï¼†gt;ï¼†gt; ï¼†gt; url.hostnameï¼†ï¼ƒ39; fdc8ï¼†ï¼ƒ39; ï¼†gt;ï¼†gt;ï¼†gt;å°è¯•ï¼š... url.port ...é™¤äº†ValueErrorä½œä¸ºé”™è¯¯ï¼š... printï¼ˆé”™è¯¯ï¼‰...ç«¯å£æ— æ³•è½¬æ¢ä¸ºï¼†ï¼ƒ39; bf8bï¼še62cï¼šabcdï¼š1111ï¼š2222ï¼š3333 ï¼š4444ï¼š8000ï¼†ï¼ƒ39;</p><p> Since IPv6 addresses use a &#34;colon-hex&#34; format with  hexadecimal fieldsseparated by  : we can&#39;t tell a port apart from a normal field. Notice in theexample above that the hostname is truncated after the first  :, not the onejust before  8000.</p><p> ç”±äºIPv6åœ°å€ä½¿ç”¨ï¼†ï¼ƒ34;åå…­è¿›åˆ¶ï¼†ï¼ƒ34;æ ¼å¼ï¼Œåå…­è¿›åˆ¶å­—æ®µä¹‹é—´ç”¨ï¼šåˆ†éš”ï¼šæˆ‘ä»¬ä¸èƒ½åŒºåˆ†ç«¯å£ä¸æ™®é€šå­—æ®µã€‚è¯·æ³¨æ„ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œä¸»æœºååœ¨ç¬¬ä¸€ä¸ªï¼šä¹‹åè¢«æˆªæ–­ï¼Œè€Œä¸æ˜¯åœ¨8000ä¹‹å‰è¢«æˆªæ–­ã€‚</p><p> Fortunately, the spec for URLs recognizes this ambiguity and gives us a way tohandle it.  RFC 2732 ( Format for Literal IPv6 Addresses in URL&#39;s)says</p><p> å¹¸è¿çš„æ˜¯ï¼ŒURLè§„èŒƒè®¤è¯†åˆ°äº†è¿™ç§æ­§ä¹‰ï¼Œå¹¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§å¤„ç†æ–¹æ³•ã€‚ RFC 2732ï¼ˆURLä¸­çš„æ–‡å­—IPv6åœ°å€æ ¼å¼ï¼‰è¯´</p><p> To use a literal IPv6 address in a URL, the literal address should beenclosed in &#34;[&#34; and &#34;]&#34; characters.</p><p> è¦åœ¨URLä¸­ä½¿ç”¨åŸä¹‰IPv6åœ°å€ï¼Œåº”åœ¨ï¼†ï¼ƒ34; [ï¼†ï¼ƒ34;å’Œï¼†ï¼ƒ34;]ï¼†ï¼ƒ34;å­—ç¬¦ã€‚</p><p>      from  ipaddress  import  ip_address def  safe_host ( host ):  &#34;&#34;&#34;Surround `host` with brackets if it is an IPv6 address.&#34;&#34;&#34;  try :  if  ip_address(host) .version  ==  6 :  return  &#34;[ {} ]&#34; .format(host)  except  ValueError :  pass return  host</p><p>      ä»ipaddresså¯¼å…¥ip_address def safe_hostï¼ˆhostï¼‰ï¼šå¦‚æœæ˜¯IPv6åœ°å€ï¼Œè¯·ç”¨æ‹¬å·å°†ï¼†quot; hoståŒ…å›´èµ·æ¥ã€‚ï¼†quot;å°è¯•ï¼šå¦‚æœip_addressï¼ˆhostï¼‰.version == 6ï¼šè¿”å›ï¼†ï¼ƒ34; [{}]ï¼†ï¼ƒ34; .formatï¼ˆhostï¼‰ï¼Œé™¤äº†ValueErrorï¼šä¼ é€’è¿”å›ä¸»æœº </p><p> Elsewhere in the code it was invoked something like this, so that hostnames,IPv4 addresses, and IPv6 addresses could all be safely interpolated.</p><p>åœ¨ä»£ç çš„å…¶ä»–åœ°æ–¹ï¼Œä¹Ÿè°ƒç”¨äº†ç±»ä¼¼çš„æ–¹æ³•ï¼Œä»¥ä¾¿å¯ä»¥å®‰å…¨åœ°æ’å…¥ä¸»æœºåï¼ŒIPv4åœ°å€å’ŒIPv6åœ°å€ã€‚</p><p>   def  test_safe_host_with_hostname ():  &#34;&#34;&#34;Hostnames should be unchanged.&#34;&#34;&#34;  assert  safe_host( &#34;node.example.com&#34; )  ==  &#34;node.example.com&#34; def  test_safe_host_with_ipv4_address ():  &#34;&#34;&#34;IPv4 addresses should be unchanged.&#34;&#34;&#34;  assert  safe_host( &#34;192.168.0.1&#34; )  ==  &#34;192.168.0.1&#34; def  test_safe_host_with_ipv6_address ():  &#34;&#34;&#34;IPv6 addresses should be surrounded by brackets.&#34;&#34;&#34;  assert  (  safe_host( &#34;fdc8:bf8b:e62c:abcd:1111:2222:3333:4444&#34; )  ==  &#34;[fdc8:bf8b:e62c:abcd:1111:2222:3333:4444]&#34;  )</p><p>   def test_safe_host_with_hostnameï¼ˆï¼‰ï¼šï¼†ï¼ƒ34;ï¼†ï¼ƒ34;ï¼†ï¼ƒ34;ä¸»æœºååº”ä¿æŒä¸å˜ã€‚ï¼†ï¼ƒ34;ï¼†ï¼ƒ34;ï¼†ï¼ƒ34;æ–­è¨€safe_hostï¼ˆï¼†ï¼ƒ34; node.example.comï¼†ï¼ƒ34;ï¼‰==ï¼†ï¼ƒ34; node.example.comï¼†ï¼ƒ34; def test_safe_host_with_ipv4_addressï¼ˆï¼‰ï¼šï¼†ï¼ƒ34;ï¼†ï¼ƒ34;ï¼†ï¼ƒ34; IPv4åœ°å€åº”ä¿æŒä¸å˜ã€‚ï¼†ï¼ƒ34;ï¼†ï¼ƒ34;ï¼†ï¼ƒ34;æ–­è¨€safe_hostï¼ˆï¼†ï¼ƒ34; 192.168.0.1ï¼†ï¼ƒ34;ï¼‰==ï¼†ï¼ƒ34; 192.168.0.1ï¼†ï¼ƒ34; def test_safe_host_with_ipv6_addressï¼ˆï¼‰ï¼šï¼†ï¼ƒ34;ï¼†ï¼ƒ34;ï¼†ï¼ƒ34; IPv6åœ°å€åº”ç”¨æ–¹æ‹¬å·æ‹¬èµ·æ¥ã€‚ï¼†ï¼ƒ34;ï¼†ï¼ƒ34;ï¼†ï¼ƒ34;æ–­è¨€ï¼ˆsafe_hostï¼ˆï¼†ï¼ƒ34; fdc8ï¼šbf8bï¼še62cï¼šabcdï¼š1111ï¼š2222ï¼š3333ï¼š4444ï¼†ï¼ƒ34;ï¼‰==ï¼†ï¼ƒ34; [fdc8ï¼šbf8bï¼še62cï¼šabcdï¼š1111ï¼š2222ï¼š3333ï¼š4444] ï¼†ï¼ƒ34;ï¼‰</p><p> Thank goodness they did. The Python 2 tests failed ( don&#39;t look at me likethat ğŸ˜’).</p><p> è°¢å¤©è°¢åœ°ï¼Œä»–ä»¬åšäº†ã€‚ Python 2æµ‹è¯•å¤±è´¥ï¼ˆä¸è¦é‚£æ ·çœ‹ç€æˆ‘ğŸ˜’ï¼‰ã€‚</p><p> âœ–  FAIL  py27 in  1 . 83  secondsâœ”  OK  py36 in  2 . 82  secondsâœ”  OK  py37 in  2 . 621  secondsâœ”  OK  py38 in  2 . 524  secondsâœ”  OK  py39 in  2 . 461  seconds</p><p> in py27 in 1å¤±è´¥ã€‚ 83ç§’âœ”ç¡®å®špy36 in 2ã€‚ 82ç§’âœ”ç¡®å®špy37 in 2ã€‚ 621ç§’âœ”ç¡®å®špy38 in 2ã€‚ 524ç§’âœ”ç¡®å®špy39 in 2ã€‚ 461ç§’</p><p> Both the hostname and IPv6 address tests failed. But   why did they fail?And why did the Python 3 tests pass? ğŸ¤”</p><p> ä¸»æœºåå’ŒIPv6åœ°å€æµ‹è¯•å‡å¤±è´¥ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆå®ƒä»¬å¤±è´¥äº†ï¼Œä¸ºä»€ä¹ˆPython 3æµ‹è¯•é€šè¿‡äº†å‘¢ï¼Ÿ ğŸ¤”</p><p>   The failure says  node.example.com was surrounded by brackets, but that&#39;sonly supposed to happen for IPv6 addresses! Let&#39;s crack open a Python 2interpreter for a quick sanity check.</p><p>   å¤±è´¥è¡¨æ˜node.example.comè¢«æ–¹æ‹¬å·åŒ…å›´ï¼Œä½†è¿™ä»…åº”å‘ç”Ÿåœ¨IPv6åœ°å€ä¸Šï¼è®©æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªPython 2è§£é‡Šå™¨ä»¥è¿›è¡Œå¿«é€Ÿçš„å¥å…¨æ€§æ£€æŸ¥ã€‚</p><p>    If, like Jeff Bridges, you were confused by that result,  relax. We&#39;reprobably not in a  Bizarro World where  node.example.com is a valid IPv6address. There must be an explanation for this behavior.</p><p>    å¦‚æœæ‚¨åƒJeff Bridgesä¸€æ ·å¯¹ç»“æœæ„Ÿåˆ°å›°æƒ‘ï¼Œè¯·æ”¾æ¾ã€‚æˆ‘ä»¬å¾ˆå¯èƒ½ä¸åœ¨Bizarroä¸–ç•Œä¸­ï¼Œå…¶ä¸­node.example.comæ˜¯æœ‰æ•ˆçš„IPv6åœ°å€ã€‚å¿…é¡»å¯¹æ­¤è¡Œä¸ºåšå‡ºè§£é‡Šã€‚ </p><p> Things start to become a little more clear when we see the result of the  ip_address() function for ourselves.</p><p>å½“æˆ‘ä»¬è‡ªå·±çœ‹åˆ°ip_addressï¼ˆï¼‰å‡½æ•°çš„ç»“æœæ—¶ï¼Œäº‹æƒ…å¼€å§‹å˜å¾—æ›´åŠ æ¸…æ™°ã€‚</p><p>   &gt;&gt;&gt;  try : ...  ipaddress.ip_address( &#34;node.example.com&#34; ) ...  except  ValueError  as  error: ...  print (error) ...  &#39;node.example.com&#39;  does  not  appear to be an IPv4  or  IPv6 address</p><p>   ï¼†gt;ï¼†gt;ï¼†gt;å°è¯•ï¼š... ipaddress.ip_addressï¼ˆï¼†ï¼ƒ34; node.example.comï¼†ï¼ƒ34;ï¼‰...é™¤äº†ValueErrorä½œä¸ºé”™è¯¯ï¼š...æ‰“å°ï¼ˆé”™è¯¯ï¼‰...ï¼†ï¼ƒ39; node.example.comï¼†ï¼ƒ 39;ä¼¼ä¹ä¸æ˜¯IPv4æˆ–IPv6åœ°å€</p><p> Python 3 knows that&#39;s not an IPv6 address, so why doesn&#39;t Python 2? The answeris in how differently the two Python versions handle text.</p><p> Python 3çŸ¥é“è¿™ä¸æ˜¯IPv6åœ°å€ï¼Œæ‰€ä»¥Python 2ä¸ºä»€ä¹ˆä¸å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸¤ä¸ªPythonç‰ˆæœ¬åœ¨å¤„ç†æ–‡æœ¬æ–¹é¢æœ‰ä½•ä¸åŒã€‚</p><p>  Computers don&#39;t operate on text as humans think of it. They operate on numbers.That&#39;s part of why we have IP addresses to begin with. In order to representhuman-readable text with computers we had to assign meaning to the numbers.Thus,  ASCII was born.</p><p>  è®¡ç®—æœºä¸ä¼šåƒäººä»¬è®¤ä¸ºçš„é‚£æ ·å¯¹æ–‡æœ¬è¿›è¡Œæ“ä½œã€‚å®ƒä»¬ä»¥æ•°å­—è¿ç®—ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä»¥IPåœ°å€å¼€å¤´çš„éƒ¨åˆ†åŸå› ã€‚ä¸ºäº†ç”¨è®¡ç®—æœºè¡¨ç¤ºäººç±»å¯è¯»çš„æ–‡æœ¬ï¼Œæˆ‘ä»¬å¿…é¡»ç»™æ•°å­—èµ‹äºˆå«ä¹‰ã€‚å› æ­¤ï¼ŒASCIIè¯ç”Ÿäº†ã€‚</p><p> ASCII is a  character encoding, which means it specifies how to interpret bytes as text we understand (provided you speak English). So, when yourcomputer sees  01101110 in  binary ( 110 in  decimal) you see  n becausethat&#39;s what ASCII says it is.</p><p> ASCIIæ˜¯ä¸€ç§å­—ç¬¦ç¼–ç ï¼Œè¿™æ„å‘³ç€å®ƒæŒ‡å®šå¦‚ä½•å°†å­—èŠ‚è§£é‡Šä¸ºæˆ‘ä»¬ç†è§£çš„æ–‡æœ¬ï¼ˆå‡è®¾æ‚¨è¯´è‹±è¯­ï¼‰ã€‚å› æ­¤ï¼Œå½“æ‚¨çš„è®¡ç®—æœºçœ‹åˆ°äºŒè¿›åˆ¶å½¢å¼çš„01101110ï¼ˆåè¿›åˆ¶ä¸º110ï¼‰æ—¶ï¼Œæ‚¨ä¼šçœ‹åˆ°nï¼Œå› ä¸ºè¿™å°±æ˜¯ASCIIæ‰€è¡¨ç¤ºçš„æ„æ€ã€‚</p><p>   In fact, it doesn&#39;t matter what numbering system you use. If you specifybinary,  octal, decimal, hexadecimal, whatever... If it can be understood asthe right integer it will be displayed correctly.</p><p>   å®é™…ä¸Šï¼Œä½¿ç”¨å“ªç§ç¼–å·ç³»ç»Ÿéƒ½æ²¡æœ‰å…³ç³»ã€‚å¦‚æœæŒ‡å®šäº†äºŒè¿›åˆ¶ï¼Œå…«è¿›åˆ¶ï¼Œåè¿›åˆ¶ï¼Œåå…­è¿›åˆ¶ç­‰ï¼Œåˆ™...å¦‚æœå¯ä»¥å°†å…¶ç†è§£ä¸ºæ­£ç¡®çš„æ•´æ•°ï¼Œåˆ™å®ƒå°†æ­£ç¡®æ˜¾ç¤ºã€‚</p><p>    Just for giggles, humor me and let&#39;s look at the character-number translationsfor  node.example.com. We&#39;ll leave out binary and octal, because they makethis table uglier than it already is.</p><p>    åªæ˜¯ä¸ºäº†å’¯å’¯åœ°ç¬‘ï¼Œè®©æˆ‘å¾ˆå¹½é»˜ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹node.example.comçš„å­—ç¬¦ç¼–å·è½¬æ¢ã€‚æˆ‘ä»¬å°†çœç•¥äºŒè¿›åˆ¶å’Œå…«è¿›åˆ¶ï¼Œå› ä¸ºå®ƒä»¬ä½¿æ­¤è¡¨æ¯”åŸæ¥æ›´ä¸‘ã€‚ </p><p>  Hey, hold on a second... If you tilt your head sideways and squint that lastrow looks kinda like an IPv6 address, doesn&#39;t it?</p><p>å˜¿ï¼Œè¯·ç¨ç­‰...å¦‚æœæ‚¨ä¾§å‘å€¾æ–œå¤´å¹¶æ–œè§†é‚£è¡Œçœ‹ä¸Šå»æœ‰ç‚¹åƒIPv6åœ°å€ï¼Œä¸æ˜¯å—ï¼Ÿ</p><p> We should verify, just to be absolutely certain. You&#39;ve still got that Python 2interpreter open, right?</p><p> æˆ‘ä»¬å¿…é¡»è¿›è¡ŒéªŒè¯ï¼Œä»¥ä¾¿ç»å¯¹ç¡®å®šã€‚æ‚¨ä»ç„¶å¯ä»¥æ‰“å¼€Python 2è§£é‡Šå™¨ï¼Œå¯¹å—ï¼Ÿ</p><p> &gt;&gt;&gt;  # Convert the characters in the hostname to hexadecimal. &gt;&gt;&gt;  hostname  =  &#34;node.example.com&#34; &gt;&gt;&gt;  hostname_as_hexadecimal  =  &#34;&#34; .join( hex ( ord (c))[ 2 :]  for  c  in  hostname) &gt;&gt;&gt;  hostname_as_hexadecimal &#39;6e6f64652e6578616d706c652e636f6d&#39; &gt;&gt;&gt;&gt;&gt;&gt;  # Convert the &#34;IP address&#34; to text. &gt;&gt;&gt;  address  =  ipaddress.ip_address(hostname) &gt;&gt;&gt;  str (address) &#39;6e6f:6465:2e65:7861:6d70:6c65:2e63:6f6d&#39; &gt;&gt;&gt;&gt;&gt;&gt;  # Remove the colons from that text. &gt;&gt;&gt;  address_without_colons  =  str (address).replace( &#34;:&#34; ,  &#34;&#34; ) &gt;&gt;&gt;  address_without_colons &#39;6e6f64652e6578616d706c652e636f6d&#39; &gt;&gt;&gt;&gt;&gt;&gt;  # Compare the results and see they&#39;re equal. &gt;&gt;&gt;  hostname_as_hexadecimal  ==  address_without_colons True</p><p> ï¼†gt;ï¼†gt;ï¼†gt; ï¼ƒå°†ä¸»æœºåä¸­çš„å­—ç¬¦è½¬æ¢ä¸ºåå…­è¿›åˆ¶ã€‚ ï¼†gt;ï¼†gt;ï¼†gt;ä¸»æœºå=ï¼†ï¼ƒ34; node.example.comï¼†ï¼ƒ34; ï¼†gt;ï¼†gt;ï¼†gt; hostname_as_hexadecimal =ï¼†ï¼ƒ34;ï¼†ï¼ƒ34; .joinï¼ˆhexï¼ˆordï¼ˆcï¼‰ï¼‰[2ï¼š] for hostnameä¸­çš„cï¼‰ï¼†gt;ï¼†gt; hostname_as_hexadecimalï¼†ï¼ƒ39; 6e6f64652e6578616d706c652e636f6dï¼†ï¼ƒ39; ï¼†gt;ï¼†gt;ï¼†gt;ï¼†gt;ï¼†gt; ï¼ƒè½¬æ¢ï¼†ï¼ƒ34; IPåœ°å€ï¼†ï¼ƒ34;åˆ°æ–‡æœ¬ã€‚ ï¼†gt;ï¼†gt;ï¼†gt;åœ°å€= ipaddress.ip_addressï¼ˆä¸»æœºåï¼‰ï¼†gt;ï¼†gt; strï¼ˆåœ°å€ï¼‰ï¼†ï¼ƒ39; 6e6fï¼š6465ï¼š2e65ï¼š7861ï¼š6d70ï¼š6c65ï¼š2e63ï¼š6f6dï¼†ï¼ƒ39; ï¼†gt;ï¼†gt;ï¼†gt;ï¼†gt;ï¼†gt; ï¼ƒä»è¯¥æ–‡æœ¬ä¸­åˆ é™¤å†’å·ã€‚ ï¼†gt;ï¼†gt;ï¼†gt; address_without_colons = strï¼ˆåœ°å€ï¼‰.replaceï¼ˆï¼†ï¼ƒ34;ï¼šï¼†ï¼ƒ34;ï¼Œï¼†ï¼ƒ34;ï¼†ï¼ƒ34;ï¼‰ï¼†gt;ï¼†gt; address_without_colonsï¼†ï¼ƒ39; 6e6f64652e6578616d706c652e636f6dï¼†ï¼ƒ39; ï¼†gt;ï¼†gt;ï¼†gt;ï¼†gt;ï¼†gt; ï¼ƒæ¯”è¾ƒç»“æœï¼Œçœ‹çœ‹ç»“æœæ˜¯å¦ç›¸ç­‰ã€‚ ï¼†gt;ï¼†gt;ï¼†gt; hostname_as_hexadecimal == address_without_colonsæ˜¯</p><p> Sure enough, when you boil them both down to numbers they&#39;re the same mess ofhexadecimal.</p><p> æœç„¶ï¼Œå½“æ‚¨å°†å®ƒä»¬éƒ½ç…®æˆæ•°å­—æ—¶ï¼Œå®ƒä»¬éƒ½æ˜¯åå…­è¿›åˆ¶çš„ä¸€å›¢ç³Ÿã€‚</p><p>  If we dig into the source code for the Python 2 version of the  ipaddress module we ultimately come to a curious set of lines.</p><p>  å¦‚æœæˆ‘ä»¬æ·±å…¥ç ”ç©¶ipaddressæ¨¡å—â€‹â€‹çš„Python 2ç‰ˆæœ¬çš„æºä»£ç ï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šé‡åˆ°ä¸€äº›å¥‡æ€ªçš„é—®é¢˜ã€‚</p><p> # Constructing from a packed address if  isinstance (address,  bytes ) :  self._check_packed_address(address,  16 )  bvs  =  _compat_bytes_to_byte_vals(address) self ._ip  =  _compat_int_from_byte_vals(bvs,  &#39;big&#39; )  return</p><p> ï¼ƒå¦‚æœisinstanceï¼ˆaddressï¼Œbytesï¼‰ä»å‹ç¼©åœ°å€æ„é€ ï¼šself._check_packed_addressï¼ˆaddressï¼Œ16ï¼‰bvs = _compat_bytes_to_byte_valsï¼ˆaddressï¼‰self ._ip = _compat_int_from_byte_valsï¼ˆbvsï¼Œï¼†ï¼ƒ39; bigï¼†ï¼ƒ39;ï¼‰return</p><p> It turns out that, under certain conditions, the  ipaddress module can createIPv6 addresses from raw bytes. My assumption is that it offers this behavior asa convenient way to parse IP addresses from data fresh off the  wire.</p><p> äº‹å®è¯æ˜ï¼Œåœ¨æŸäº›æ¡ä»¶ä¸‹ï¼Œipaddressæ¨¡å—â€‹â€‹å¯ä»¥ä»åŸå§‹å­—èŠ‚åˆ›å»ºIPv6åœ°å€ã€‚æˆ‘çš„å‡è®¾æ˜¯ï¼Œå®ƒæä¾›äº†è¿™ç§è¡Œä¸ºï¼Œä½œä¸ºä»ç¦»çº¿æ•°æ®ä¸­è§£æIPåœ°å€çš„ä¾¿æ·æ–¹æ³•ã€‚ </p><p> Does  node.example.com meet those certain conditions? You bet it does. Becausewe&#39;re using Python 2 it&#39;s just  bytes and it happens to be 16 characters long.</p><p>node.example.comæ˜¯å¦æ»¡è¶³é‚£äº›ç‰¹å®šæ¡ä»¶ï¼Ÿä½ æ•¢æ‰“èµŒã€‚å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Python 2ï¼Œæ‰€ä»¥å®ƒåªæ˜¯å­—èŠ‚ï¼Œæ°å¥½æ˜¯16ä¸ªå­—ç¬¦é•¿ã€‚</p><p> &gt;&gt;&gt;  isinstance ( &#34;node.example.com&#34; ,  bytes ) True &gt;&gt;&gt;  # `self._check_packed_address` basically just checks how long it is. &gt;&gt;&gt;  len ( &#34;node.example.com&#34; )  ==  16True</p><p> ï¼†gt;ï¼†gt;ï¼†gt; isinstanceï¼ˆï¼†ï¼ƒ34; node.example.comï¼†ï¼ƒ34;ï¼Œå­—èŠ‚ï¼‰Trueï¼†gt;ï¼†gt;ï¼†gt; ï¼ƒ`self._check_packed_address`åŸºæœ¬ä¸Šåªæ˜¯æ£€æŸ¥å®ƒæœ‰å¤šé•¿æ—¶é—´ã€‚ ï¼†gt;ï¼†gt;ï¼†gt; lenï¼ˆï¼†ï¼ƒ34; node.example.comï¼†ï¼ƒ34;ï¼‰== 16çœŸ</p><p> The rest of the  ipaddress lines say to interpret the sequence of bytes as a big-endian integer. That&#39;s  magic best leftfor another blog post, but the gist is that hexadecimal interpretation of node.example.com is condensed into a single,  huge number.</p><p> å…¶ä½™çš„ipaddressè¡Œè¡¨ç¤ºå°†å­—èŠ‚åºåˆ—è§£é‡Šä¸ºbig-endianæ•´æ•°ã€‚é­”æœ¯æœ€é€‚åˆç•™ç»™å¦ä¸€ç¯‡åšå®¢æ–‡ç« ï¼Œä½†è¦ç‚¹æ˜¯node.example.comçš„åå…­è¿›åˆ¶è§£é‡Šè¢«å‹ç¼©ä¸ºä¸€ä¸ªå·¨å¤§çš„æ•°å­—ã€‚</p><p>  That&#39;s an absolutely massive number, but not so massive it won&#39;t fit within the IPv6 address space.</p><p>  è¿™ç»å¯¹æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—ï¼Œä½†å¹¶ä¸æ˜¯é‚£ä¹ˆå¤§ï¼Œä»¥è‡³äºå®ƒæ— æ³•å®¹çº³åœ¨IPv6åœ°å€ç©ºé—´ä¸­ã€‚</p><p>  As it turns out, if you&#39;re liberal in your interpretation,  node.example.com can be an IPv6 address!</p><p>  äº‹å®è¯æ˜ï¼Œå¦‚æœæ‚¨çš„è§£é‡Šè‡ªç”±ï¼Œåˆ™node.example.comå¯ä»¥æ˜¯IPv6åœ°å€ï¼</p><p>   There&#39;s a quote about numbers which is apocryphally attributed to  W.E.B. DuBois, but that actually comes from  Harold Geneen&#39;s book,  Managing.</p><p>   å…³äºæ•°å­—çš„ä¸€å¥æŠ¥ä»·å¼•è‡ªW.E.B. DuBoisï¼Œä½†è¿™å®é™…ä¸Šæ¥è‡ªHarold Geneençš„ä¹¦ã€Š Managingã€‹ã€‚</p><p> When you have mastered the numbers, you will in fact no longer be readingnumbers, any more than you read words when reading a book. You will bereading meanings.</p><p> æŒæ¡äº†æ•°å­—ä¹‹åï¼Œå®é™…ä¸Šï¼Œæ‚¨å°†ä¸å†æ˜¯é˜…è¯»æ•°å­—ï¼Œè€Œæ˜¯é˜…è¯»ä¹¦ç±æ—¶è¯»çš„å•è¯ã€‚æ‚¨å°†é˜…è¯»å«ä¹‰ã€‚ </p><p> Having not read the book I&#39;m probably taking the quote way out of context, butI think it fits our situation well.</p><p>æˆ‘å¯èƒ½æ²¡æœ‰è¯»è¿‡è¿™æœ¬ä¹¦ï¼Œä½†å¾ˆå¯èƒ½æ˜¯å‡ºäºä¸Šä¸‹æ–‡çš„è€ƒè™‘ï¼Œä½†æˆ‘è®¤ä¸ºè¿™å¾ˆé€‚åˆæˆ‘ä»¬çš„æƒ…å†µã€‚</p><p> As we&#39;ve seen above, we can freely convert characters to numbers and backagain. The root of our problem is that when we use Python 2 it considers textto be bytes. There&#39;s not a deeper, inherent meaning. Maybe the bytes are meantto be ASCII, maybe they&#39;re meant to be a long number, maybe they&#39;re meant to bean IP address. The interpretation of those bytes is up to us.</p><p> å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç”±åœ°å°†å­—ç¬¦è½¬æ¢ä¸ºæ•°å­—å¹¶é‡æ–°è¿”å›ã€‚é—®é¢˜çš„æ ¹æºåœ¨äºï¼Œå½“æˆ‘ä»¬ä½¿ç”¨Python 2æ—¶ï¼Œå®ƒå°†æ–‡æœ¬è§†ä¸ºå­—èŠ‚ã€‚æ²¡æœ‰æ›´æ·±çš„å†…åœ¨å«ä¹‰ã€‚å­—èŠ‚å¯èƒ½æ˜¯ASCIIï¼Œä¹Ÿè®¸æ˜¯é•¿æ•´æ•°ï¼Œä¹Ÿè®¸æ˜¯bean IPåœ°å€ã€‚è¿™äº›å­—èŠ‚çš„è§£é‡Šå–å†³äºæˆ‘ä»¬ã€‚</p><p> Python 2 doesn&#39;t differentiate between bytes and text by default. In fact, the bytes type is just an  alias for  str.</p><p> Python 2é»˜è®¤ä¸åŒºåˆ†å­—èŠ‚å’Œæ–‡æœ¬ã€‚å®é™…ä¸Šï¼Œå­—èŠ‚ç±»å‹åªæ˜¯strçš„åˆ«åã€‚</p><p>  To make that even more concrete, see how Python 2 considers  n to be the sameas this sequence of raw bytes.</p><p>  ä¸ºäº†æ›´å…·ä½“ä¸€ç‚¹ï¼Œè¯·å‚é˜…Python 2å¦‚ä½•å°†nè§†ä¸ºä¸æ­¤åŸå§‹å­—èŠ‚åºåˆ—ç›¸åŒã€‚</p><p>  Our Python 2 code doesn&#39;t work the way we want it to because raw bytes can havearbitrary meaning and we haven&#39;t told it to use our intended meaning.</p><p>  æˆ‘ä»¬çš„Python 2ä»£ç æ— æ³•æŒ‰æˆ‘ä»¬å¸Œæœ›çš„æ–¹å¼å·¥ä½œï¼Œå› ä¸ºåŸå§‹å­—èŠ‚å¯ä»¥å…·æœ‰ä»»æ„å«ä¹‰ï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜æ²¡æœ‰å‘Šè¯‰å®ƒä½¿ç”¨æˆ‘ä»¬æƒ³è¦çš„å«ä¹‰ã€‚</p><p> So now we know why Python 2 interprets  node.example.com as an IPv6 address,but why does Python 3 behave differently? More importantly, how can wereconcile the two?</p><p> å› æ­¤ï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“äº†ä¸ºä»€ä¹ˆPython 2å°†node.example.comè§£é‡Šä¸ºIPv6åœ°å€ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆPython 3çš„è¡Œä¸ºæœ‰æ‰€ä¸åŒï¼Ÿæ›´é‡è¦çš„æ˜¯ï¼Œå¦‚ä½•ä½¿ä¸¤è€…èä¸ºä¸€ä½“ï¼Ÿ</p><p>  ASCII looked like a good idea in the 1960&#39;s. With decades of hindsight weknow the 256 characters afforded to us by  Extended ASCII are insufficient tohandle all of the world&#39;s writing systems. Thus,  Unicode was born.</p><p>  åœ¨1960å¹´ä»£ï¼ŒASCIIçœ‹èµ·æ¥æ˜¯ä¸ªå¥½ä¸»æ„ã€‚ç»è¿‡å‡ åå¹´çš„äº‹ååˆ†æï¼Œæˆ‘ä»¬çŸ¥é“æ‰©å±•ASCIIæä¾›ç»™æˆ‘ä»¬çš„256ä¸ªå­—ç¬¦ä¸è¶³ä»¥å¤„ç†ä¸–ç•Œä¸Šæ‰€æœ‰çš„ä¹¦å†™ç³»ç»Ÿã€‚å› æ­¤ï¼ŒUnicodeè¯ç”Ÿäº†ã€‚ </p><p> There are scads of blog posts, Wikipedia articles, and technical documents thatwill do a better job than I can of explaining Unicode in detail. You shouldread them if you care to, but here&#39;s my gist.</p><p>æœ‰å¤§é‡çš„åšå®¢æ–‡ç« ï¼ŒWikipediaæ–‡ç« å’ŒæŠ€æœ¯æ–‡æ¡£ä¼šæ¯”æˆ‘è¯¦ç»†è§£é‡ŠUnicodeæ›´å¥½ã€‚å¦‚æœéœ€è¦ï¼Œæ‚¨åº”è¯¥é˜…è¯»å®ƒä»¬ï¼Œä½†è¿™æ˜¯æˆ‘çš„ä¸»æ—¨ã€‚</p><p> Unicode is a set of character encodings.  UTF-8 is the dominant encoding.UTF-8 overlaps with ASCII, so ASCII characters are still just one byte. Tohandle the multitude of other characters, however, multiple bytes can express asingle character.</p><p> Unicodeæ˜¯ä¸€ç»„å­—ç¬¦ç¼–ç ã€‚ UTF-8æ˜¯ä¸»è¦çš„ç¼–ç .UTF-8ä¸ASCIIé‡å ï¼Œå› æ­¤ASCIIå­—ç¬¦ä»ç„¶åªæ˜¯ä¸€ä¸ªå­—èŠ‚ã€‚ä¸ºäº†å¤„ç†å¤§é‡å…¶ä»–å­—ç¬¦ï¼Œå¤šä¸ªå­—èŠ‚å¯ä»¥è¡¨ç¤ºå•ä¸ªå­—ç¬¦ã€‚</p><p> &gt;&gt;&gt;  &#34;n&#34; .encode( &#34;utf-8&#34; ).hex()  # 1 character (U+006E), 1 byte. &#39;6e&#39; &gt;&gt;&gt;  &#34;ğŸ¤¿&#34; .encode( &#34;utf-8&#34; ).hex()  # 1 character (U+1F93F), 4 bytes. &#39;f09fa4bf&#39; &gt;&gt;&gt;  &#34;æ‚Ÿã‚Š&#34; .encode( &#34;utf-8&#34; ).hex()  # 2 characters (U+609F, U+308A), 6 bytes. &#39;e6829fe3828a&#39;</p><p> ï¼†gt;ï¼†gt;ï¼†gt; ï¼†ï¼ƒ34; nï¼†ï¼ƒ34; .encodeï¼ˆï¼†ï¼ƒ34; utf-8ï¼†ï¼ƒ34;ï¼‰.hexï¼ˆï¼‰ï¼ƒ1ä¸ªå­—ç¬¦ï¼ˆU + 006Eï¼‰ï¼Œ1ä¸ªå­—èŠ‚ã€‚ ï¼†ï¼ƒ39; 6eï¼†ï¼ƒ39; ï¼†gt;ï¼†gt;ï¼†gt; ï¼†ï¼ƒ34;ğŸ¤¿ï¼†ï¼ƒ34; .encodeï¼ˆï¼†ï¼ƒ34; utf-8ï¼†ï¼ƒ34;ï¼‰.hexï¼ˆï¼‰ï¼ƒ1ä¸ªå­—ç¬¦ï¼ˆU + 1F93Fï¼‰ï¼Œ4ä¸ªå­—èŠ‚ã€‚ ï¼†ï¼ƒ39; f09fa4bfï¼†ï¼ƒ39; ï¼†gt;ï¼†gt;ï¼†gt; ï¼†ï¼ƒ34;æ‚Ÿã‚Šï¼†ï¼ƒ34; .encodeï¼ˆï¼†ï¼ƒ34; utf-8ï¼†ï¼ƒ34;ï¼‰.hexï¼ˆï¼‰ï¼ƒ2ä¸ªå­—ç¬¦ï¼ˆU + 609Fï¼ŒU + 308Aï¼‰ï¼Œ6ä¸ªå­—èŠ‚ã€‚ ï¼†ï¼ƒ39; e6829fe3828aï¼†ï¼ƒ39;</p><p> Every programming language I know of that respects the difference betweenraw bytes and Unicode text maintains a strict separation between the twodatatypes.</p><p> æˆ‘æ‰€çŸ¥é“çš„æ¯ç§ç¼–ç¨‹è¯­è¨€éƒ½å°Šé‡åŸå§‹å­—èŠ‚å’ŒUnicodeæ–‡æœ¬ä¹‹é—´çš„å·®å¼‚ï¼Œè¿™ä¸¤ç§æ•°æ®ç±»å‹ä¹‹é—´ä¿æŒä¸¥æ ¼çš„åˆ†éš”ã€‚</p><p> In Python 3 this strict separation is enabled by default. Notice that itdoesn&#39;t consider  n and this sequence of raw bytes to be the same thing.</p><p> åœ¨Python 3ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šå¯ç”¨æ­¤ä¸¥æ ¼åˆ†éš”ã€‚è¯·æ³¨æ„ï¼Œå®ƒä¸è®¤ä¸ºnä¸åŸå§‹å­—èŠ‚åºåˆ—æ˜¯åŒä¸€å›äº‹ã€‚</p><p>    If we can get Python 2 to understand Unicode like Python 3 does, then we canprobably fix our bug.</p><p>    å¦‚æœæˆ‘ä»¬å¯ä»¥åƒPython 3ä¸€æ ·è®©Python 2ç†è§£Unicodeï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä¿®å¤æˆ‘ä»¬çš„é”™è¯¯ã€‚</p><p> As an aside, if you want to learn more about how to handle Unicode in Python,check out  Ned Batchelder&#39;s talk on   Pragmatic Unicode.</p><p> å¦å¤–ï¼Œå¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šæœ‰å…³å¦‚ä½•åœ¨Pythonä¸­å¤„ç†Unicodeçš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹Ned Batchelderå…³äºå®ç”¨Unicodeçš„æ¼”è®²ã€‚ </p><p>  Python 2 does actually know about Unicode, but it considers Unicode text tobe separate from &#34;normal&#34; text. At some point in Python 2 history the  unicode type was bolted onto the side of the language andnot enabled by default. Hard to get excited about it, but it does the trick.At least they knew it&#39;s a pain to type  unicode() all the time, so there&#39;s ahandy literal syntax using a  u prefix.</p><p>Python 2å®é™…ä¸Šç¡®å®äº†è§£Unicodeï¼Œä½†æ˜¯å®ƒè®¤ä¸ºUnicodeæ–‡æœ¬ä¸ï¼†ï¼ƒ34; normalï¼†ï¼ƒ34;æ˜¯åˆ†å¼€çš„ã€‚æ–‡æœ¬ã€‚åœ¨Python 2å†å²è®°å½•ä¸­çš„æŸä¸ªæ—¶å€™ï¼Œunicodeç±»å‹è¢«å›ºå®šåœ¨è¯¥è¯­è¨€çš„ä¸€ä¾§ï¼Œå¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹æœªå¯ç”¨ã€‚å¾ˆéš¾å¯¹æ­¤æ„Ÿåˆ°å…´å¥‹ï¼Œä½†æ˜¯å®ƒç¡®å®æˆåŠŸäº†ã€‚è‡³å°‘ä»–ä»¬çŸ¥é“æ€»æ˜¯ä¸€ç›´é”®å…¥unicodeï¼ˆï¼‰æ˜¯ä¸€ä»¶å¾ˆéº»çƒ¦çš„äº‹ï¼Œå› æ­¤ä½¿ç”¨uå‰ç¼€å¯ä»¥æ–¹ä¾¿åœ°å®ç°æ–‡å­—è¯­æ³•ã€‚</p><p>  This is  not the best fix, but it did in a pinch. We added a line convertingthe hostname to Unicode right off the bat. We also applied the sametransformation to the line with brackets. This way we always process thehostname as Unicode and we always return a Unicode value.</p><p>  è¿™ä¸æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä½†ç¡®å®å¾ˆå…³é”®ã€‚æˆ‘ä»¬ç«‹å³æ·»åŠ äº†å°†ä¸»æœºåè½¬æ¢ä¸ºUnicodeçš„è¡Œã€‚æˆ‘ä»¬è¿˜å°†ç›¸åŒçš„å˜æ¢åº”ç”¨äºå¸¦æ–¹æ‹¬å·çš„è¡Œã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å§‹ç»ˆå°†ä¸»æœºåå¤„ç†ä¸ºUnicodeï¼Œå¹¶ä¸”å§‹ç»ˆè¿”å›Unicodeå€¼ã€‚</p><p> def safe_host(host): &#34;&#34;&#34;Surround `host` with brackets if it is an IPv6 address.&#34;&#34;&#34; + host = u&#34;{}&#34;.format(host)  try: if ip_address(host).version == 6: - return &#34;[{}]&#34;.format(host) + return u&#34;[{}]&#34;.format(host)  except ValueError: pass</p><p> def safe_hostï¼ˆhostï¼‰ï¼šå¦‚æœä¸»æœºæ˜¯IPv6åœ°å€ï¼Œè¯·ç”¨æ‹¬å·å°†ï¼†quot; hostæ‹¬èµ·æ¥ï¼›ï¼†ï¼ƒ34;ï¼†ï¼ƒ34;ï¼†ï¼ƒ34; + host = uï¼†ï¼ƒ34; {}ï¼†ï¼ƒ34; .formatï¼ˆhostï¼‰å°è¯•ï¼šif ip_addressï¼ˆhostï¼‰.version == 6ï¼š-è¿”å›ï¼†ï¼ƒ34; [{}]ï¼†ï¼ƒ34; .formatï¼ˆhostï¼‰ +è¿”å›uï¼†ï¼ƒ34; [{}]ï¼†ï¼ƒ34; .formatï¼ˆhostï¼‰ï¼Œä½†ValueErrorï¼šé€šè¿‡</p><p> Luckily for us the  u prefix also works in Python 3 whereas  unicode() does not(because  all text is Unicode by default, so the type has nobusiness existing). In Python 3 the  u is treated as a  no-op.</p><p> å¯¹æˆ‘ä»¬æ¥è¯´å¹¸è¿çš„æ˜¯ï¼Œuå‰ç¼€ä¹Ÿå¯ä»¥åœ¨Python 3ä¸­ä½¿ç”¨ï¼Œè€Œunicodeï¼ˆï¼‰åˆ™ä¸èƒ½ï¼ˆå› ä¸ºé»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰æ–‡æœ¬éƒ½æ˜¯Unicodeï¼Œæ‰€ä»¥è¯¥ç±»å‹ä¸å­˜åœ¨ä»»ä½•ä¸šåŠ¡ï¼‰ã€‚åœ¨Python 3ä¸­ï¼Œå°†uè§†ä¸ºæ— æ“ä½œã€‚</p><p>   When we use the  unicode type the  ipaddress module no longer tries tointerpret  node.example.com as  bytes and convert those bytes to an IPaddress. We get just what we expect</p><p>   å½“æˆ‘ä»¬ä½¿ç”¨unicodeç±»å‹æ—¶ï¼Œipaddressæ¨¡å—â€‹â€‹ä¸å†å°è¯•å°†node.example.comè§£é‡Šä¸ºå­—èŠ‚å¹¶å°†è¿™äº›å­—èŠ‚è½¬æ¢ä¸ºIPåœ°å€ã€‚æˆ‘ä»¬å¾—åˆ°äº†æˆ‘ä»¬æ‰€æœŸæœ›çš„</p><p> &gt;&gt;&gt;  try : ...  ipaddress.ip_address( u &#34;node.example.com&#34; ) ...  except  ValueError  as  error: ...  print (error) ...  u &#39;node.example.com&#39;  does  not  appear to be an IPv4  or  IPv6 address</p><p> ï¼†gt;ï¼†gt;ï¼†gt;å°è¯•ï¼š... ipaddress.ip_addressï¼ˆuï¼†ï¼ƒ34; node.example.comï¼†ï¼ƒ34;ï¼‰...é™¤äº†ValueErrorä½œä¸ºé”™è¯¯ï¼š... printï¼ˆerrorï¼‰... uï¼†ï¼ƒ39; node.exampleã€‚ comï¼†ï¼ƒ39;ä¼¼ä¹ä¸æ˜¯IPv4æˆ–IPv6åœ°å€</p><p>  âœ”  OK  py27 in  1 . 728  secondsâœ”  OK  py36 in  2 . 775  secondsâœ”  OK  py37 in  2 . 717  secondsâœ”  OK  py38 in  2 . 674  secondsâœ”  OK  py39 in  2 . 506  seconds</p><p>  âœ”ç¡®å®špy27 in 1ã€‚ 728ç§’âœ”ç¡®å®špy36 in 2ã€‚ 775ç§’âœ”ç¡®å®špy37 in 2ã€‚ 717ç§’âœ”ç¡®å®špy38 in 2ã€‚ 674ç§’âœ”ç¡®å®špy39 in 2ã€‚ 506ç§’ </p><p>  I mentioned above that our fix wasn&#39;t the best. Given more time, how can we dobetter?</p><p>æˆ‘åœ¨ä¸Šé¢æåˆ°æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆä¸æ˜¯æœ€å¥½çš„ã€‚å¦‚æœæœ‰æ›´å¤šæ—¶é—´ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•åšå‘¢ï¼Ÿ</p><p> The first (and best) solution here is to drop Python 2 support. It&#39;s 2020now and Python 2 is officially no longer supported. The original code worked onPython 3. The best long-term decision is to migrate the code to run on Python 3 only and avoid the hassle of Python 2 maintenance. Unfortunately many ofthe people running this code still depend on it working on Python 2, so we&#39;llhave to make that transition gracefully.</p><p> è¿™é‡Œçš„ç¬¬ä¸€ä¸ªï¼ˆä¹Ÿæ˜¯æœ€å¥½çš„ï¼‰è§£å†³æ–¹æ¡ˆæ˜¯æ”¾å¼ƒå¯¹Python 2çš„æ”¯æŒã€‚ 2020nowå’ŒPython 2æ­£å¼ä¸å†å—æ”¯æŒã€‚åŸå§‹ä»£ç é€‚ç”¨äºPython3ã€‚æœ€å¥½çš„é•¿æœŸå†³ç­–æ˜¯è¿ç§»ä»£ç ä½¿å…¶ä»…åœ¨Python 3ä¸Šè¿è¡Œï¼Œå¹¶é¿å…Python 2ç»´æŠ¤çš„éº»çƒ¦ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿è¡Œæ­¤ä»£ç çš„è®¸å¤šäººä»ç„¶ä¾èµ–äºåœ¨Python 2ä¸Šè¿è¡Œçš„ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è¿›è¡Œé€‚å½“çš„è¿‡æ¸¡ã€‚</p><p> If a migration away from Python 2 isn&#39;t possible in the near-term, the nextbest thing to do is update our code so that it uses a compatibility layer like  future or   six. Those libraries are designed to modernizePython 2 and help smooth over issues like this one.</p><p> å¦‚æœåœ¨çŸ­æœŸå†…æ— æ³•ä»Python 2è¿ç§»å‡ºå»ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯æ›´æ–°æˆ‘ä»¬çš„ä»£ç ï¼Œä»¥ä¾¿å®ƒä½¿ç”¨è¯¸å¦‚futureæˆ–6è¿™æ ·çš„å…¼å®¹æ€§å±‚ã€‚è¿™äº›åº“æ—¨åœ¨ä½¿Python 2ç°ä»£åŒ–ï¼Œå¹¶å¸®åŠ©è§£å†³æ­¤ç±»é—®é¢˜ã€‚</p><p> It also wouldn&#39;t hurt for us to take a page from  Alexis King&#39;s  Parse, don&#39;t validate school of thought. When thehostname enters our program via user input it should  immediately beconverted to the  unicode type (or maybe even an IP address type) so we don&#39;tend up solving this problem in several different places throughout the code.</p><p> å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œä»äºšå†å…‹è¥¿æ–¯Â·é‡‘ï¼ˆAlexis Kingï¼‰çš„Parseç¿»é¡µä¹Ÿä¸ä¼šæ„Ÿåˆ°ä¼¤å®³ï¼Œä¹Ÿä¸å¿…éªŒè¯æ€æƒ³æµæ´¾ã€‚å½“ä¸»æœºåé€šè¿‡ç”¨æˆ·è¾“å…¥è¿›å…¥æˆ‘ä»¬çš„ç¨‹åºæ—¶ï¼Œåº”ç«‹å³å°†å…¶è½¬æ¢ä¸ºunicodeç±»å‹ï¼ˆç”šè‡³IPåœ°å€ç±»å‹ï¼‰ï¼Œå› æ­¤åœ¨æ•´ä¸ªä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨å¤šä¸ªä¸åŒä½ç½®è§£å†³æ­¤é—®é¢˜ã€‚</p><p> Finally, though our program doesn&#39;t currently handle any hostnames in languagesother than English, it&#39;s probably best to be thinking in Unicode anyway. Again,it&#39;s 2020 and  internationalized domain names like  https://Ğ¯Ğ½Ğ´ĞµĞºÑ.Ñ€Ñ„are a thing.</p><p> æœ€åï¼Œå°½ç®¡æˆ‘ä»¬çš„ç¨‹åºå½“å‰ä¸ä½¿ç”¨è‹±è¯­ä»¥å¤–çš„å…¶ä»–è¯­è¨€æ¥å¤„ç†ä»»ä½•ä¸»æœºåï¼Œä½†æ— è®ºå¦‚ä½•ï¼Œæœ€å¥½è¿˜æ˜¯ä»¥Unicodeçš„æ–¹å¼è¿›è¡Œæ€è€ƒã€‚åŒæ ·ï¼Œ2020å¹´å’Œhttpsï¼š//andĞ½Ğ´ĞµĞºÑ.Ñ€Ñ„ä¹‹ç±»çš„å›½é™…åŒ–åŸŸåä¹Ÿå¾ˆé‡è¦ã€‚</p><p> If you made it this far, thanks for reading. It was fun to turn a briefdebugging session with my co-worker into a treatise on the perils of Python 2and the value of Unicode. See you next year! ğŸ˜‚</p><p> å¦‚æœæ‚¨åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œè¯·å¤šè°¢é˜…è¯»ã€‚å°†ä¸æˆ‘çš„åŒäº‹è¿›è¡Œçš„ç®€çŸ­è°ƒè¯•ä¼šè®®å˜æˆå…³äºPython 2çš„å±é™©å’ŒUnicodeçš„ä»·å€¼çš„è®ºæ–‡å¾ˆæœ‰è¶£ã€‚æ˜å¹´å†è§ï¼ ğŸ˜‚ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://tuckersiemens.com/posts/node-example-com-is-an-ip-address/">https://tuckersiemens.com/posts/node-example-com-is-an-ip-address/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/ip/">#ip</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/python/">#python</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ†äº«/">#åˆ†äº«</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>