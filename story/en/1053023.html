<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>ä¸è¦åœ¨shellæç¤ºç¬¦ä¸­ä½¿ç”¨é‡å®šå‘å­—ç¬¦ Do not use redirection characters in your shell prompt</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Do not use redirection characters in your shell prompt<br/>ä¸è¦åœ¨shellæç¤ºç¬¦ä¸­ä½¿ç”¨é‡å®šå‘å­—ç¬¦ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-17 23:22:19</div><div class="page_narrow text-break page_content"><p>Over the years of troubleshooting performance problems in the Unix/Linux world, I have seen multiple cases where a regularly used command line tool in a customer server just stops working for some reason. The tool just returns immediately, doing absolutely nothing. No output printed, no coredumps and the exit code is zero (success!).</p><p>å¤šå¹´æ¥ï¼ŒUNIX / Linuxä¸–ç•Œä¸­çš„æ€§èƒ½é—®é¢˜è¿›è¡Œäº†æ•…éšœæ’é™¤é—®é¢˜ï¼Œæˆ‘å·²ç»çœ‹åˆ°äº†å¤šä¸ªæ¡ˆä¾‹ï¼Œåœ¨å®¢æˆ·æœåŠ¡å™¨ä¸­å®šæœŸä½¿ç”¨çš„å‘½ä»¤è¡Œå·¥å…·åªéœ€å‡ºäºæŸç§åŸå› å³å¯åœæ­¢å·¥ä½œã€‚è¯¥å·¥å…·ç«‹å³è¿”å›ï¼Œç»å¯¹æ²¡æœ‰ã€‚æ²¡æœ‰å°åˆ·è¾“å‡ºï¼Œæ²¡æœ‰COREDUMPå’Œé€€å‡ºä»£ç ä¸ºé›¶ï¼ˆæˆåŠŸï¼ï¼‰ã€‚</p><p> This article walks you through a couple of such incidents and in the end I explain how I avoid accidentally doing bad stuff in production in general.</p><p> è¿™ç¯‡æ–‡ç« èµ°è¿‡å‡ ä¸ªè¿™æ ·çš„äº‹ä»¶ï¼Œæœ€åæˆ‘è§£é‡Šäº†æˆ‘å¦‚ä½•é¿å…æ„å¤–åœ°åœ¨ç”Ÿäº§ä¸­åšé”™çš„ä¸œè¥¿ã€‚</p><p>   Hereâ€™s a (manually reproduced) example of such a problem on a Linux server. The  expdp command is an Oracle databaseâ€™s high-speed data export tool, but this can happen to any file. Normally the output is this:</p><p>   ä»¥ä¸‹æ˜¯LinuxæœåŠ¡å™¨ä¸Šæ­¤ç±»é—®é¢˜çš„ï¼ˆæ‰‹åŠ¨å†ç°ï¼‰ç¤ºä¾‹ã€‚ Expdpå‘½ä»¤æ˜¯Oracleæ•°æ®åº“çš„é«˜é€Ÿæ•°æ®å¯¼å‡ºå·¥å…·ï¼Œä½†è¿™å¯èƒ½å‘ç”Ÿåœ¨ä»»ä½•æ–‡ä»¶ä¸­ã€‚é€šå¸¸æ˜¯è¾“å‡ºï¼š</p><p> oracle@oel7l bin&gt;  pwd/u01/app/oracle/product/18.0.0/dbhome_1/binoracle@oel7l bin&gt; oracle@oel7l bin&gt;  expdp help=yExport: Release 18.0.0.0.0 - Production on Tue Mar 16 17:55:35 2021Version 18.3.0.0.0Copyright (c) 1982, 2018, Oracle and/or its affiliates. All rights reserved.The Data Pump export utility provides a mechanism for transferring data objectsbetween Oracle databases. The utility is invoked with the following command: Example: expdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp ... lots of output removed...</p><p> Oracle @ oel7l binï¼†gt; pwd/u01/pap/app/oracle/product/18.0.0/dbhome_1/binoracle@oel7l binï¼†gt; Oracle @ oel7l binï¼†gt; Expdp Help = yexportï¼šç‰ˆæœ¬18.0.0.0  -  MAR 16 17:55:35 2021Version 18.3.0.0.0copyrightï¼ˆcï¼‰1982,20.0.0ï¼Œ2018å¹´ï¼Œç”²éª¨æ–‡å’Œ/æˆ–å…¶é™„å±å…¬å¸ã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚æ•°æ®æ³µå‡ºå£å®ç”¨ç¨‹åºæä¾›äº†ä¸€ç§ä¼ è¾“Oracleæ•°æ®åº“çš„æ•°æ®å¯¹è±¡çš„æœºåˆ¶ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è°ƒç”¨è¯¥å®ç”¨ç¨‹åºï¼šç¤ºä¾‹ï¼šExpdp scott / tigerç›®å½•= dmpdir dumpfile = scott.dmp ...åˆ é™¤äº†å¤§é‡çš„è¾“å‡º...</p><p> However, when a customer tried to run that command in their environment one morning, this happened:</p><p> ä½†æ˜¯ï¼Œå½“å®¢æˆ·åœ¨ä¸€ä¸ªæ—©æ™¨è¯•å›¾åœ¨ä»–ä»¬çš„ç¯å¢ƒä¸­è¿è¡Œè¯¥å‘½ä»¤æ—¶ï¼Œä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼š</p><p>  The  expdp command had just stopped working overnight! It immediately returned, doing nothing, yet there were no error messages and even the shell command return code  $? showed  0 - success.</p><p>  Expdpå‘½ä»¤åˆšåˆšåœæ­¢å·¥ä½œè¿‡å¤œï¼å®ƒç«‹å³è¿”å›ï¼Œæ— æ‰€äº‹äº‹ï¼Œä½†ç”šè‡³æ²¡æœ‰é”™è¯¯æ¶ˆæ¯ï¼Œç”šè‡³æ˜¯shellå‘½ä»¤è¿”å›ä»£ç $ï¼Ÿæ˜¾ç¤º0  - æˆåŠŸã€‚</p><p> Time to dig deeper! Letâ€™s make sure that we are trying to execute the right command in its correct location:</p><p> æ˜¯æ—¶å€™æŒ–æ˜äº†ï¼è®©æˆ‘ä»¬ç¡®ä¿æˆ‘ä»¬æ­£åœ¨å°è¯•åœ¨å…¶æ­£ç¡®çš„ä½ç½®æ‰§è¡Œæ­£ç¡®çš„å‘½ä»¤ï¼š </p><p>  All looks correct so far, letâ€™s take a look into the binary itself:</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰€æœ‰çœ‹èµ·æ¥éƒ½æ˜¯æ­£ç¡®çš„ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹äºŒè¿›åˆ¶æœ¬èº«ï¼š</p><p> oracle@oel7l bin&gt;  file expdp expdp: emptyoracle@oel7l bin&gt;  ls -l expdp -rwxr-x--x. 1 oracle oinstall  0 Mar 16 17:55 expdp</p><p> Oracle @ oel7l binï¼†gt; File Expdp Expdpï¼šEvervoracle @ Oel7l Binï¼†gt; ls -l expdp -rwxr-x  -  xã€‚ 1 Oracle Oinstall 0 3æœˆ16æ—¥17:55 Expdp</p><p> Boom!  Something has truncated the file to zero bytes! I even see the last modification time of this file, it may give some extra clues regarding what/who it may have been (was there some database software patching/releasing going on then, done manually by humans).</p><p> ç¹è£ï¼æŸäº›ä¸œè¥¿å·²å°†æ–‡ä»¶æˆªæ–­ä¸ºé›¶å­—èŠ‚ï¼æˆ‘ç”šè‡³çœ‹åˆ°äº†è¿™ä¸ªæ–‡ä»¶çš„æœ€åä¸€ä¸ªä¿®æ”¹æ—¶é—´ï¼Œå®ƒå¯èƒ½ä¼šç»™ä¸€äº›é¢å¤–çš„çº¿ç´¢éƒ½æœ‰å…³äºå®ƒå¯èƒ½å·²ç»/è°ï¼ˆæœ‰ä¸€äº›æ•°æ®åº“è½¯ä»¶ä¿®è¡¥/é‡Šæ”¾ï¼Œç„¶åç”±äººæ‰‹åŠ¨å®Œæˆï¼‰ã€‚</p><p> An easy quick check is to take a look into shell history files (like  .bash_history in users&#39; home directories) in that server. Iâ€™ll query my own user history with  fc -l:</p><p> è½»æ¾å¿«é€Ÿæ£€æŸ¥æ˜¯åœ¨è¯¥æœåŠ¡å™¨ä¸­æŸ¥çœ‹shellå†å²æ–‡ä»¶ï¼ˆå¦‚ç”¨æˆ·ï¼†ï¼ƒ39ä¸­çš„.bash_history; homeç›®å½•ï¼‰ã€‚æˆ‘å°†ä½¿ç”¨fc -læŸ¥è¯¢è‡ªå·±çš„ç”¨æˆ·å†å²è®°å½•ï¼š</p><p> oracle@oel7l bin&gt;  fc -l1044 rm ls1045 cd bin/1046 pwd1047 expdp help=y1048  oracle@oel7l bin&gt; pwd1049  /u01/app/oracle/product/18.0.0/dbhome_1/bin1050  oracle@oel7l bin&gt;1051  oracle@oel7l bin&gt; expdp help=y1052  Export: Release 18.0.0.0.0 - Production on Tue Mar 16 17:55:35 20211053  Version 18.3.0.0.01054  Copyright (c) 1982, 2018, Oracle and/or its affiliates. All rights reserved.1055 expdp help=y1056 which expdp1057 file expdp1058 ls -l expdp 1059 pwdoracle@oel7l bin&gt;</p><p> Oracle @ oel7l binï¼†gt; FC -L1044 RM LS1045 CD BIN / 1046 PWD1047 EXPDPå¸®åŠ©= Y1048 Oracle @ Oel7L Binï¼†Gt; PWD1049 /U01/PARP/ORACLE/Product/18.0.0/DBHOME_1/BIN1050 ORACLE @ OEL7L BINï¼†GT; 1051 ORACLE @ OEL7L BINï¼†GT; Expdp Help = Y1052å‡ºå£ï¼šå‘å¸ƒ18.0.0.0  -  0.0.0  -  Tue Mar 16 18:55:35 20211053ç‰ˆæƒï¼ˆcï¼‰1982,201054 1982å¹´ï¼Œ2018ï¼Œç”²éª¨æ–‡å’Œ/æˆ–å…¶é™„å±å…¬å¸ã€‚ç‰ˆæƒæ‰€æœ‰.1055 EXPDPå¸®åŠ©= y1056å“ªä¸ªexpdp1057æ–‡ä»¶expdp1058 ls -l expdp 1059 pwdoracle @ oel7l binï¼†gt;</p><p> Whoa, the highlighted commands donâ€™t look like proper shell commands at all! They actually look like someone had accidentally pasted some random junk from their terminal screen back to the shell as commands!</p><p> å“‡ï¼Œçªå‡ºæ˜¾ç¤ºçš„å‘½ä»¤æ ¹æœ¬çœ‹èµ·æ¥ä¸åƒè´å£³å‘½ä»¤ä¸€æ ·ï¼ä»–ä»¬å®é™…ä¸Šçœ‹èµ·æ¥åƒæœ‰äººæ„å¤–åœ°ç²˜è´´äº†ä»ä»–ä»¬çš„ç»ˆç«¯å±å¹•ä¸Šçš„ä¸€äº›éšæœºåƒåœ¾å›åˆ°å£³ç‰Œä¸­ä½œä¸ºå‘½ä»¤ï¼</p><p> Now, all of of these highlighted â€œcommandsâ€ would have just errored out as they are some random terminal output, not valid shell commands, right? For example, trying to execute this command would give you an errorâ€¦</p><p> ç°åœ¨ï¼Œæ‰€æœ‰è¿™äº›çªå‡ºæ˜¾ç¤ºçš„â€œå‘½ä»¤â€å°±ä¼šåˆšåˆšå‡ºé”™ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ä¸€ä¸ªéšæœºç»ˆç«¯è¾“å‡ºï¼Œè€Œä¸æ˜¯æœ‰æ•ˆçš„shellå‘½ä»¤ï¼Œå¯¹å§ï¼Ÿä¾‹å¦‚ï¼Œå°è¯•æ‰§è¡Œæ­¤å‘½ä»¤å°†ä¸ºæ‚¨æä¾›é”™è¯¯... </p><p>    The above command itself did not succeed because of the abovementioned â€œcommand not foundâ€ shell error, but the  output of the failed command (zero bytes) will be still written into whatever file name comes after that â€œ&gt;â€ redirection character. Now, if you happen to be in your home directory or â€˜/tmpâ€™, youâ€™d be just accidentally creating a new empty file called  expdp there. However, when you happen to be in your application binary directory (like I was in this case) or used the full executable path in your previous commands, you will end up   clobbering the existing binary file. Youâ€™ll truncate it and replace it with a zero byte file. And from then on, your shell happily executes the zero-byte â€œshellâ€ script and returns success in doing nothing.</p><p>ç”±äºä¸Šè¿°çš„â€œå‘½ä»¤æœªæ‰¾åˆ°â€shellé”™è¯¯ï¼Œä½†ä¸Šé¢çš„å‘½ä»¤æœ¬èº«å¹¶æ²¡æœ‰æˆåŠŸï¼Œä½†å¤±è´¥å‘½ä»¤çš„è¾“å‡ºï¼ˆé›¶å­—èŠ‚ï¼‰ä»å°†å†™å…¥â€œï¼†gtâ€ä¹‹åçš„ä»»ä½•æ–‡ä»¶åã€‚é‡å®šå‘å­—ç¬¦ã€‚ç°åœ¨ï¼Œå¦‚æœæ‚¨ç¢°å·§åœ¨æ‚¨çš„ä¸»ç›®å½•æˆ–'/ tmp'ä¸­ï¼Œæ‚¨å°†æ„å¤–åœ°åˆ›å»ºä¸€ä¸ªåä¸ºExpdpçš„æ–°æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œå½“æ‚¨æ°å¥½åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶ç›®å½•ï¼ˆå°±åƒåœ¨è¿™ç§æƒ…å†µä¸‹ï¼‰æˆ–ä½¿ç”¨å…ˆå‰å‘½ä»¤ä¸­çš„å®Œæ•´å¯æ‰§è¡Œè·¯å¾„æ—¶ï¼Œæœ€ç»ˆå°†CLOBBOTingç°æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ‚¨å°†æˆªæ–­å®ƒå¹¶ç”¨é›¶å­—èŠ‚æ–‡ä»¶æ›¿æ¢å®ƒã€‚ä»é‚£æ—¶èµ·ï¼Œä½ çš„shellå¾ˆé«˜å…´åœ°æ‰§è¡Œé›¶å­—èŠ‚â€œshellâ€è„šæœ¬ï¼Œå¹¶è¿”å›ä»»ä½•æˆåŠŸã€‚</p><p> From my terminal scroll-back history of this experiment, youâ€™ll see me accidentally pasting lots of junk from the screen back as commands - and not all of it is harmless:</p><p> ä»æˆ‘çš„ç»ˆç«¯æ»šåŠ¨å›åˆ°è¿™ä¸ªå®éªŒçš„å†å²è®°å½•ï¼Œä½ ä¼šçœ‹åˆ°æˆ‘æ„å¤–åœ°ä»å±å¹•ä¸Šç²˜è´´äº†å¾ˆå¤šåƒåœ¾å›å½’å‘½ä»¤ - è€Œä¸æ˜¯æ‰€æœ‰çš„éƒ½æ˜¯æ— å®³çš„ï¼š</p><p> oracle@oel7l bin&gt; oracle@oel7l bin&gt;  oracle@oel7l bin&gt; oracle@oel7l bin&gt; pwd-bash: oracle@oel7l: command not foundoracle@oel7l bin&gt; /u01/app/oracle/product/18.0.0/dbhome_1/bin-bash: /u01/app/oracle/product/18.0.0/dbhome_1/bin: Is a directoryoracle@oel7l bin&gt; oracle@oel7l bin&gt; -bash: syntax error near unexpected token `newline&#39;oracle@oel7l bin&gt; oracle@oel7l bin&gt; -bash: syntax error near unexpected token `newline&#39; oracle@oel7l bin&gt; oracle@oel7l bin&gt; expdp help=y-bash: oracle@oel7l: command not foundoracle@oel7l bin&gt; oracle@oel7l bin&gt; Export: Release 18.0.0.0.0 - Production on Tue Mar 16 17:55:35 2021-bash: Export:: command not foundoracle@oel7l bin&gt; Version 18.3.0.0.0-bash: Version: command not foundoracle@oel7l bin&gt; oracle@oel7l bin&gt; Copyright (c) 1982, 2018, Oracle and/or its affiliates. All rights reserved.-bash: syntax error near unexpected token `c&#39;oracle@oel7l bin&gt;</p><p> Oracle @ oel7l binï¼†gt; Oracle @ oel7l binï¼†gt; Oracle @ oel7l binï¼†gt; Oracle @ oel7l binï¼†gt; pwd-bashï¼šOracle @ oel7lï¼šå‘½ä»¤ä¸æ˜¯unitor @ oel7l binï¼†gt; /u01/paracle/product/18.0.0/dbhome_1/bin-bashï¼š/u01/app/oracle/product/18.0.0/dbhome_1/binï¼šæ˜¯ä¸€ä¸ªç›®å½•@ oel7l binï¼†gt; Oracle @ oel7l binï¼†gt; -bashï¼šæ„å¤–ä»¤ç‰Œçš„è¯­æ³•é”™è¯¯ï¼Œæ„å¤–ä»¤ç‰Œ`newlineï¼†ï¼ƒ39; oracle @ oel7l binï¼†gt; Oracle @ oel7l binï¼†gt; -bashï¼šæ„å¤–ä»¤ç‰Œçš„è¯­æ³•é”™è¯¯ï¼Œæ„å¤–ä»¤ç‰Œ`çº½è¯ºï¼†ï¼ƒ39; Oracle @ oel7l binï¼†gt; Oracle @ oel7l binï¼†gt; Expdp Help = Y-Bashï¼šOracle @ oel7lï¼šå‘½ä»¤ä¸æ˜¯oledor @ oel7l binï¼†gt; Oracle @ oel7l binï¼†gt;å¯¼å‡ºï¼šç‰ˆæœ¬18.0.0.0  - ç”Ÿäº§ä¸Šå‘¨å›¾3æœˆ16æ—¥17:55:35 2021-bashï¼šå‡ºå£::å‘½ä»¤ä¸æ˜¯unitor @ oel7l binï¼†gt;ç‰ˆæœ¬18.3.0.0.0-bashï¼šç‰ˆæœ¬ï¼šå‘½ä»¤ä¸æ˜¯oder @ oel7l binï¼†gt; Oracle @ oel7l binï¼†gt;ç‰ˆæƒæ‰€æœ‰ï¼ˆcï¼‰1982å¹´ï¼Œ2018å¹´ï¼Œç”²éª¨æ–‡å’Œ/æˆ–å…¶é™„å±å…¬å¸ã€‚ç‰ˆæƒæ‰€æœ‰ã€‚ -  Bashï¼šæ„å¤–æ ‡è®°çš„è¯­æ³•é”™è¯¯ï¼Œæ„å¤–æ ‡è®°`Cï¼†ï¼ƒ39; Oracle @ Oel7L Binï¼†gt;</p><p>   In one system I once looked at, someone had managed to truncate  /bin/ls as root! It started as an exciting  â€œOMG did they delete the entire filesystem?!&#34; exercise:</p><p>   åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œæˆ‘æ›¾ç»çœ‹è¿‡ï¼Œæœ‰äººåœ¨rootä¸­è®¾æ³•æˆªæ–­/ç®±å­ï¼å®ƒå¼€å§‹ä½œä¸ºä¸€ä¸ªä»¤äººå…´å¥‹çš„â€œomgä»–ä»¬åˆ é™¤äº†æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Ÿï¼ï¼†ï¼ƒ34;é”»ç‚¼ï¼š</p><p>    What, the root directory is gone too?  How could I even log in if root is gone?  Is someone still deleting stuff?  Did we get hacked?!</p><p>    ä»€ä¹ˆï¼Œæ ¹ç›®å½•ä¹Ÿæ¶ˆå¤±äº†ï¼Ÿå¦‚æœrootç¦»å¼€ï¼Œæˆ‘ç”šè‡³å¦‚ä½•ç™»å½•ï¼Ÿæœ‰äººè¿˜åˆ é™¤äº†ä¸œè¥¿å—ï¼Ÿæˆ‘ä»¬è¢«é»‘äº†å—ï¼Ÿï¼</p><p> Luckily you donâ€™t have to rely only on  ls to list file &amp; directory names. Other than  find you could use shellâ€™s built-in wildcard expansion:</p><p> å¹¸è¿çš„æ˜¯ï¼Œæ‚¨ä¸å¿…åªä¾èµ–äºLSæ¥åˆ—å‡ºæ–‡ä»¶å’Œamp;ç›®å½•åç§°ã€‚é™¤äº†æ‰¾åˆ°æ‚¨å¯ä»¥ä½¿ç”¨shellçš„å†…ç½®é€šé…ç¬¦æ‰©å±•ï¼š</p><p> root@oel7l bin&gt;  echo /*/bin /boot /dev /etc /home /lib /lib64 /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /u01 /u02 /u03 /u04 /usr /varroot@oel7l bin&gt;</p><p> æ ¹@ oel7l binï¼†gt; echo / * / bin / boot / dev / dev / etc / home / lib / lib64 / media / mnt / opt / proc / root /è¿è¡Œ/ sbin / srv / sys / tmp / u01 / u02 / u03 / u04 / usr / varroot @ oel7l binï¼†gt; </p><p> The files are still there! We can further examine file metadata with  file or  stat commands (and the glob wildcard expansion is supported):</p><p>æ–‡ä»¶ä»ç„¶å­˜åœ¨ï¼æˆ‘ä»¬å¯ä»¥é€šè¿‡æ–‡ä»¶æˆ–statå‘½ä»¤è¿›ä¸€æ­¥æ£€æŸ¥æ–‡ä»¶å…ƒæ•°æ®ï¼ˆæ”¯æŒGlobé€šé…ç¬¦æ‰©å±•ï¼‰ï¼š</p><p> root@oel7l bin&gt;  file //: directoryroot@oel7l bin&gt; root@oel7l bin&gt;  stat / File: â€˜/â€™ Size: 4096 Blocks: 8 IO Block: 4096 directoryDevice: fc00h/64512d Inode: 128 Links: 21Access: (0555/dr-xr-xr-x) Uid: ( 0/ root) Gid: ( 0/ root)Context: system_u:object_r:root_t:s0Access: 2021-03-16 19:14:49.953914433 -0400Modify:  2018-09-14 19:01:29.695056064 -0400Change:  2018-09-14 19:01:29.695056064 -0400 Birth: -</p><p> æ ¹@ oel7l binï¼†gt;æ–‡ä»¶//ï¼šç›®å½•å·@ oel7l binï¼†gt;æ ¹@ oel7l binï¼†gt; stat / fileï¼š'/'å°ºå¯¸ï¼š4096å—ï¼š8 ioå—ï¼š4096ç›®å½•è®¾è®¡ï¼šfc00h / 64512d inodeï¼š128é“¾æ¥ï¼š21accessï¼šï¼ˆ0555 / dr-xr-xr-xï¼‰uidï¼šï¼ˆ0 / rootï¼‰gid :( 0 / rootï¼‰ä¸Šä¸‹æ–‡ï¼šsystem_uï¼šobject_rï¼šroot_tï¼šs0accessï¼š2021-03-16 19ï¼š14ï¼š49.953914433 -0400modifyï¼š2018-09-14 19ï¼š01ï¼š29.695056064 -0400Changeï¼š2018-09-14 19ï¼š01ï¼š29.695056064 -0400å‡ºç”Ÿï¼š - </p><p> We even see the last modification timestamp with the  stat command ( ls gets its info from the same place as  stat under the hood).</p><p> æˆ‘ä»¬ç”šè‡³çœ‹åˆ°æœ€åä¸€ä¸ªä¿®æ”¹æ—¶é—´æˆ³ä¸statå‘½ä»¤ï¼ˆlsä»ä¸å¼•æ“ç›–ä¸‹çš„statä¸statç›¸åŒçš„åœ°æ–¹è·å¾—å…¶ä¿¡æ¯ï¼‰ã€‚</p><p> So, thereâ€™s something wrong specifically with the  ls binary. The next logical command to run is  which ls. It would show you from which directory in your PATH it found a file with such name that is accessible to you and has an â€œxâ€ bit set. It is less known, but  which also shows if someone has aliased your  ls command to  shutdown as a prank.</p><p> æ‰€ä»¥ï¼ŒLSäºŒè¿›åˆ¶æ–‡ä»¶æœ‰ä¸€äº›å…·ä½“é—®é¢˜ã€‚è¿è¡Œçš„ä¸‹ä¸€ä¸ªé€»è¾‘å‘½ä»¤æ˜¯å“ªä¸ªlsã€‚å®ƒä¼šå‘æ‚¨å±•ç¤ºè·¯å¾„ä¸­çš„å“ªä¸ªç›®å½•ï¼Œå®ƒæ‰¾åˆ°äº†ä¸€ä¸ªå…·æœ‰æ­¤ç±»åç§°çš„æ–‡ä»¶ï¼Œå¯ä»¥è®¿é—®æ‚¨å¹¶å…·æœ‰â€œxâ€ä½è®¾ç½®ã€‚å®ƒè¾ƒå°‘æ‰€çŸ¥ï¼Œä½†ä¹Ÿæ˜¾ç¤ºäº†å¦‚æœæœ‰äººåˆ«åä¸ºæ¶ä½œå‰§çš„å‘½ä»¤å°†æ‚¨çš„LSå‘½ä»¤åˆ«åã€‚</p><p>   Hmm, I had always thought that  ls was in /bin not /usr/bin. Letâ€™s check whether the /bin directory is just a symlink:</p><p>   å—¯ï¼Œæˆ‘ä¸€ç›´è®¤ä¸ºLSä¸/ usr / binã€‚è®©æˆ‘ä»¬æ£€æŸ¥/ binç›®å½•æ˜¯å¦åªæ˜¯ä¸€ä¸ªsymlinkï¼š</p><p>   root@oel7l bin&gt;  file /bin /bin: symbolic link to `usr/bin&#39;root@oel7l bin&gt; root@oel7l bin&gt;  stat /bin  File: â€˜/binâ€™ -&gt; â€˜usr/binâ€™ Size: 7 Blocks: 0 IO Block: 4096 symbolic linkDevice: fc00h/64512d Inode: 773 Links: 1Access: (0777/lrwxrwxrwx) Uid: ( 0/ root) Gid: ( 0/ root)Context: system_u:object_r:bin_t:s0Access: 2021-03-16 17:38:36.389289020 -0400Modify: 2018-08-19 11:29:23.860005567 -0400Change: 2018-08-19 11:29:23.860005567 -0400 Birth: -</p><p>   æ ¹@ oel7l binï¼†gt;æ–‡ä»¶/ bin / binï¼šç¬¦å·é“¾æ¥åˆ°`usr / binï¼†ï¼ƒ39; root @ oel7l binï¼†gt;æ ¹@ oel7l binï¼†gt; stat / binæ–‡ä»¶ï¼š'/ bin' - ï¼†gt; 'USR / BIN'å°ºå¯¸ï¼š7ä¸ªè¡—åŒºï¼š0 IOå—ï¼š4096ç¬¦å·é“¾æ¥å™¨ï¼šFC00H / 64512D inodeï¼š773é“¾æ¥ï¼š1Accessï¼šï¼ˆ0777 / LRWXRWXRWXï¼‰UIDï¼šï¼ˆ0 / rootï¼‰GIDï¼šï¼ˆ0 / rootï¼‰ä¸Šä¸‹æ–‡ï¼šsystem_u ï¼šObject_Rï¼šBin_Tï¼šS0Accessï¼š2021-03-16 17ï¼š38ï¼š36.389289020 -0400Modifyï¼š2018-08-19 11ï¼š2018-0400Changeï¼š2018-08-19 11ï¼š29ï¼š23.860005567 -0400å‡ºç”Ÿï¼š - </p><p> Both  file and  stat can tell us if we are dealing with a link and where it points to. Using the  echo * pattern trick I can see what other files do we still have in  /usr/bin:</p><p> æ–‡ä»¶å’Œstatéƒ½å¯ä»¥å‘Šè¯‰æˆ‘ä»¬æˆ‘ä»¬æ˜¯å¦æ­£åœ¨å¤„ç†é“¾æ¥ä»¥åŠå®ƒæŒ‡å‘çš„ä½ç½®ã€‚ä½¿ç”¨echo *æ¨¡å¼è¯€çªæˆ‘å¯ä»¥çœ‹åˆ°/ usr / binä»ç„¶å­˜åœ¨å…¶ä»–æ–‡ä»¶ï¼š </p><p> root@oel7l bin&gt;  echo /usr/bin/ls*/usr/bin/ls /usr/bin/lsattr /usr/bin/lsblk /usr/bin/lscpu /usr/bin/lsinitrd /usr/bin/lsipc /usr/bin/lslocks /usr/bin/lslogins /usr/bin/lsmem /usr/bin/lsns /usr/bin/lsscsiroot@oel7l bin&gt;  file /usr/bin/ls/usr/bin/ls: empty</p><p>æ ¹@ oel7l binï¼†gt; Echo / USR / BIN / LS * / USR / BIN / LS / USR / BIN / LSATTR / USR / BIN / LSBLK / USR / BIN / LSCPU / USR / BIN / LSINTRD / USR / BIN / LSIPC / USR / BIN / LSLOCKS / USR / BIN / LSLOGINS / USR / BIN / LSMEM / USR / BIN / LSNS / USR / BIN / LSSCSIROT @ Oel7L BINï¼†GT;æ–‡ä»¶/ usr / bin / ls / usr / bin / lsï¼šç©º</p><p>  root@oel7l bin&gt; stat /usr/bin/ls File: â€˜/usr/bin/lsâ€™ Size: 0 Blocks: 0 IO Block: 4096 regular empty fileDevice: fc00h/64512d Inode: 104356 Links: 1Access: (0755/-rwxr-xr-x) Uid: ( 0/ root) Gid: ( 0/ root)Context: system_u:object_r:bin_t:s0Access: 2021-03-16 17:57:58.944003009 -0400Modify: 2021-03-16 17:57:54.594064500 -0400Change: 2021-03-16 17:57:54.594064500 -0400 Birth: -</p><p>  æ ¹@ oel7l binï¼†gt; stat / usr / bin / lsæ–‡ä»¶ï¼š'/ usr / bin / ls'å°ºå¯¸ï¼š0å—ï¼š0 IOå—ï¼š4096å¸¸è§„ç©ºæ‘˜æœºï¼šFC00H / 64512D inodeï¼š104356é“¾æ¥ï¼š1Accessï¼šï¼ˆ0755 / -RWXR-XR-X ï¼‰UIDï¼šï¼ˆ0 / rootï¼‰gidï¼šï¼ˆ0 / rootï¼‰ä¸Šä¸‹æ–‡ï¼šsystem_uï¼šobject_rï¼šbin_tï¼šs0accessï¼š2021-03-16 17ï¼š57ï¼š58.944003009 -0400modifyï¼š2021-03-16 17ï¼š57ï¼š54.594064500 -0400Change ï¼š2021-03-16 17ï¼š57ï¼š54.594064500 -0400å‡ºç”Ÿï¼š - </p><p> The fileâ€™s last modification date may give me extra insight into what/who might have accidentally overwritten the file. The  .bash_history shows a similar pattern of â€œsomeoneâ€ pasting in junk from the terminal screen:</p><p> è¯¥æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¥æœŸå¯èƒ½ä¼šè®©æˆ‘é¢å¤–äº†è§£å¯èƒ½æ„å¤–åœ°è¦†ç›–æ–‡ä»¶çš„å†…å®¹/è°ã€‚ .bash_historyåœ¨ç»ˆç«¯å±å¹•ä¸­æ˜¾ç¤ºäº†ç±»ä¼¼çš„â€œæŸäººâ€ç²˜è´´çš„æ¨¡å¼ï¼š</p><p> root@oel7l bin&gt; fc -l1005 ls /var/run1006 ls /var/log1007 ls /var/local1008  root@oel7l bin &gt; ls /var/local1009  root@oel7l bin&gt; 1010 ls /var/local1011 ls /1012 which ls1013 pwd1014 ls -ld /binroot@oel7l bin&gt;</p><p> æ ¹@ oel7l binï¼†gt; FC -L1005 LS / VAR / RUN1006 LS / VAR / LOG1007 LS / VAR / LOCAL1008 ROOT @ OEL7L BINï¼†GT; ls / var / local1009æ ¹@ oel7l binï¼†gt; 1010 LS / VAR / LOCAL1111 LS / 1012å…¶ä¸­LS1013 PWD1014 LS -LD / BINROOT @ OEL7L BINï¼†GT;</p><p> You would now need to restore your  ls binary or reinstall it from the install package. Or, if not having a working  ls command drives you nuts while doing the restore operation, you could create a shell wildcard expansion-based temporary shell script or even an alias that just uses  echo * :-)</p><p> æ‚¨ç°åœ¨éœ€è¦æ¢å¤LSäºŒè¿›åˆ¶æ–‡ä»¶æˆ–ä»å®‰è£…åŒ…é‡æ–°å®‰è£…å®ƒã€‚æˆ–è€…ï¼Œå¦‚æœæ²¡æœ‰å·¥ä½œLSå‘½ä»¤åœ¨è¿›è¡Œè¿˜åŸæ“ä½œçš„åŒæ—¶é©±åŠ¨èºæ¯ï¼Œåˆ™å¯ä»¥åˆ›å»ºä¸€ä¸ªåŸºäºshellé€šé…ç¬¦æ‰©å±•çš„ä¸´æ—¶shellè„šæœ¬ç”šè‡³æ˜¯åªä½¿ç”¨echo * :-)çš„åˆ«å</p><p> root@oel7l bin&gt;  alias ls=echoroot@oel7l bin&gt;  ls /*/bin /boot /dev /etc /home /lib /lib64 /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /u01 /u02 /u03 /u04 /usr /var</p><p> æ ¹@ oel7l binï¼†gt;åˆ«åls = echoroot @ oel7l binï¼†gt; LS / * / BIN / BOOT / DEV / ETC / HOME / LIB / LIB64 / MEDIC / MNT / OPT / PROC / ROOT / RUN / SBIN / SRV / SYS / TMP / U01 / U02 / U03 / U04 / U02 / U04 / USR / VAR</p><p>  In  bash you can just  set -o noclobber! This will tell the shell to not  clobber (overwrite contents) using the redirection operator.</p><p>  åœ¨Bashä¸­ï¼Œä½ å¯ä»¥æ‹æ‘„-o noclobberï¼è¿™å°†å‘Šè¯‰shellä½¿ç”¨é‡å®šå‘è¿ç®—ç¬¦æ¥åˆ é™¤ï¼ˆè¦†ç›–å†…å®¹ï¼‰ã€‚ </p><p> Letâ€™s check the current value, create a test file and enable  noclobber, to see how it helps:</p><p>è®©æˆ‘ä»¬æ¥æ£€æŸ¥å½“å‰å€¼ï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶å¹¶å¯ç”¨NOCLOBBERï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å¸®åŠ©çš„ï¼š</p><p> $  set -o | grep clobnoclobber  off$ $  echo hello &gt; a$ $  cat ahello$ $  set -o noclobber$  set -o | grep clobnoclobber  on$</p><p> $ set -o | grep clobnoclobber off $ $ echo helloï¼†gt; $ $ cat ahello $ $ set -o noclobber $ set -o | Grep Clobnooblobberåœ¨$</p><p>   Nice! Bash doesnâ€™t allow overwriting the file  a. Similarly, accidentally pasting in bad terminal output doesnâ€™t overwrite the file:</p><p>   å¥½çš„ï¼ Bashä¸å…è®¸è¦†ç›–æ–‡ä»¶aã€‚åŒæ ·ï¼Œåœ¨é”™è¯¯çš„ç»ˆç«¯è¾“å‡ºä¸­æ„å¤–ç²˜è´´ä¸ä¼šè¦†ç›–æ–‡ä»¶ï¼š</p><p>  However, the noclobber option is not very fool-proof, if your goal is to avoid accidental file modifications. For example, bash allows you to override the general noclobber setting and use  &gt;| to say that you really  do want to clobber that file:</p><p>  ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„ç›®æ ‡æ˜¯é¿å…æ„å¤–æ–‡ä»¶ä¿®æ”¹ï¼Œåˆ™Noclobberé€‰é¡¹ä¸æ˜¯éå¸¸ç®€å•çš„è¯æ˜ã€‚ä¾‹å¦‚ï¼ŒBashå…è®¸æ‚¨è¦†ç›–å¸¸è§„NOCLOBBERè®¾ç½®å’Œä½¿ç”¨ï¼†gt; |è¦è¯´ä½ çœŸçš„æƒ³æ‰“å‡»è¯¥æ–‡ä»¶ï¼š</p><p>  Itâ€™s less likely that someoneâ€™s prompt ends with  &gt;|, but when you accidentally paste in random junk from terminal, these character sequences may well happen. And more, noclobber does not prevent one from  appending to the end of the file with  &gt;&gt;:</p><p>  å®ƒä¸å¤ªå¯èƒ½ä¸æŸäººçš„æç¤ºä»¥ï¼†gtç»“å°¾; |å½“æ‚¨ä»ç»ˆç«¯ä¸­æ— æ„ä¸­ç²˜è´´åˆ°éšæœºåƒåœ¾æ—¶ï¼Œè¿™äº›å­—ç¬¦åºåˆ—å¯èƒ½ä¼šå‘ç”Ÿã€‚æ›´å¤šï¼ŒNoclobberä¸ä¼šé˜»æ­¢å…¶ä¸­ä¸€ä¸ªä¸”gt;ï¼†gt ;:</p><p> $ set -o noclobber$ cat a$ $ echo hello &gt; a-bash: a: cannot overwrite existing file$ $ cat a$</p><p> $ set -o noclobber $ cat a $ $ $ echo helloï¼†gt; a-bashï¼šç­”ï¼šä¸èƒ½è¦†ç›–ç°æœ‰æ–‡ä»¶$ $ cat a $</p><p> We couldnâ€™t overwrite the existing empty file with anything so far, thanks to noclobber. But letâ€™s try to append:</p><p> æ®NocloBberï¼Œæˆ‘ä»¬æ— æ³•å°†ç°æœ‰çš„ç©ºæ–‡ä»¶è¦†ç›–ä¸è¿„ä»Šä¸ºæ­¢çš„ä»»ä½•ä¸œè¥¿ã€‚ä½†æˆ‘ä»¬è¯•ç€è¿½åŠ ï¼š </p><p>   This requires a little more exotic circumstances, the accidentally executed command must actually exist and print something into its standard output, for it to be appended to whatever filename comes after the  &gt;&gt; redirection. Some examples from the Linux world would be the  mysql or  pcp users (the executable command name == username in typical installations, thus some people may have their prompts looking like  mysql&gt; or  pcp&gt; when logged in as these users. Nevertheless, pasting in a bunch of such unlucky enough junk from the terminal with  &gt;&gt; in it may cause you to  append random stuff to your existing binaries and scripts, instead of truncating them to zero. ( Which one is better? ğŸ¤”)</p><p>è¿™éœ€è¦æ›´åŠ å¼‚å›½æƒ…è°ƒçš„æƒ…å†µï¼Œæ„å¤–æ‰§è¡Œçš„å‘½ä»¤å®é™…ä¸Šå¿…é¡»å®é™…å­˜åœ¨å¹¶æ‰“å°åˆ°å…¶æ ‡å‡†è¾“å‡ºä¸­ï¼Œå› ä¸ºå®ƒè¦é™„åŠ åˆ°ï¼†gtä¹‹åçš„ä»»ä½•æ–‡ä»¶åã€‚ï¼†gt;é‡å®šå‘ã€‚ Linuxä¸–ç•Œçš„ä¸€äº›ä¾‹å­å°†æ˜¯MySQLæˆ–PCPç”¨æˆ·ï¼ˆå¯æ‰§è¡Œå‘½ä»¤åç§°==å…¸å‹å®‰è£…ä¸­çš„ç”¨æˆ·åï¼Œå› æ­¤æœ‰äº›äººå¯èƒ½ä¼šæœ‰ä»–ä»¬çš„æç¤ºï¼Œçœ‹èµ·æ¥åƒMySQLï¼†GT;æˆ–PCPï¼†gt;ç™»å½•ä¸ºè¿™äº›ç”¨æˆ·æ—¶ã€‚ä¸è¿‡ï¼Œç²˜è´´ä»ç»ˆç«¯çš„ç»ˆç«¯ä¸­æœ‰ä¸€å †è¿™ç§ä¸å¹¸çš„åƒåœ¾;ï¼†gt;åœ¨å®ƒå¯èƒ½ä¼šå¯¼è‡´ä½ å°†éšæœºçš„ä¸œè¥¿è¿½åŠ åˆ°ç°æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œè„šæœ¬ï¼Œè€Œä¸æ˜¯å°†å®ƒä»¬æˆªæ–­ä¸ºé›¶ã€‚ï¼ˆå“ªä¸€ä¸ªæ›´å¥½ï¼ŸğŸ¤”ï¼‰</p><p> What about the  # in a typical root prompt? Everything that comes after a # character, is gonna be a comment, right? I have allowed clobbering and am using just echo commands here to keep things simpler:</p><p> å…¸å‹çš„æ ¹æç¤ºç¬¦ä¸­çš„ï¼ƒå‘¢ï¼Ÿ ï¼ƒè§’è‰²åçš„ä¸€åˆ‡éƒ½ä¼šæ˜¯è¯„è®ºï¼Œå¯¹å—ï¼Ÿæˆ‘å…è®¸Clobberingå’ŒAmä½¿ç”¨çš„echoå‘½ä»¤åœ¨è¿™é‡Œä¿æŒæ›´ç®€å•çš„ä¸œè¥¿ï¼š</p><p>  The above example didnâ€™t try to overwrite my file, as the  #&gt; a was treated as a comment. The yellow â€œzzzâ€ you see repeated above, was just the  standard output of the echo command, displayed on terminal screen (and redirection to a file did not kick in thanks to the comment # character). My fileâ€™s contents still say â€œhelloâ€.</p><p>  ä¸Šé¢çš„ä¾‹å­æ²¡æœ‰å°è¯•è¦†ç›–æˆ‘çš„æ–‡ä»¶ï¼Œä½œä¸ºï¼ƒï¼†gt; Aè¢«è§†ä¸ºè¯„è®ºã€‚ä¸Šé¢é‡å¤çš„é»„è‰²â€œzzzâ€åªæ˜¯echoå‘½ä»¤çš„æ ‡å‡†è¾“å‡ºï¼Œåœ¨ç»ˆç«¯å±å¹•ä¸Šæ˜¾ç¤ºï¼ˆå¹¶ä¸”ç”±äºè¯„è®ºï¼ƒå­—ç¬¦è€Œå¯¹æ–‡ä»¶çš„é‡å®šå‘æ²¡æœ‰å¯åŠ¨ã€‚æˆ‘çš„æ–‡ä»¶çš„å†…å®¹ä»ç„¶è¯´â€œä½ å¥½â€ã€‚</p><p> Now letâ€™s make one last  tiny change as I want my awesome-shell-prompt to be more compact.  â€œI just trimmed some whitespace, I donâ€™t think we need to test thatâ€:</p><p> ç°åœ¨è®©æˆ‘ä»¬åšä¸€ä¸ªæœ€åçš„å¾®å°å˜åŒ–ï¼Œå› ä¸ºæˆ‘å¸Œæœ›æˆ‘çš„ä»¤äººæ•¬ç•çš„å£³ç‰Œæç¤ºæ›´ç´§å‡‘ã€‚ â€œæˆ‘åˆšä¿®å‰ªäº†ä¸€äº›ç©ºç™½ï¼Œæˆ‘è®¤ä¸ºæˆ‘ä»¬ä¸éœ€è¦æµ‹è¯•è¿™ä¸€ç‚¹â€ï¼š</p><p>  Oh crap,  I should have tested that! A tiny change to whitespace changed the meaning of the echo command. Without the space between â€œzzzâ€ and â€œ#â€, the shell thinks itâ€™s all part of a single argument passed to the echo commadn ( echo zzz#) and the output of that command ( zzz#) was then redirected to my file  a.</p><p>  å“¦ï¼Œåƒåœ¾ï¼Œæˆ‘åº”è¯¥æµ‹è¯•è¿‡ï¼å¯¹ç©ºæ ¼çš„å¾®å°æ›´æ”¹æ”¹å˜äº†echoå‘½ä»¤çš„å«ä¹‰ã€‚æ²¡æœ‰â€œzzzâ€å’Œâ€œï¼ƒâ€ä¹‹é—´çš„ç©ºé—´ï¼Œshellè®¤ä¸ºå®ƒæ˜¯ä¼ é€’ç»™å›å£°é€šè®¯çš„å•ä¸ªå‚æ•°çš„ä¸€éƒ¨åˆ†ï¼ˆecho zzzï¼ƒï¼‰ï¼Œç„¶åå°†è¯¥å‘½ä»¤çš„è¾“å‡ºé‡å®šå‘åˆ°æˆ‘çš„æ–‡ä»¶aã€‚</p><p> Hopefully by now it is pretty evident that for the sake of sanity of our production systems (and ourselves), you shouldnâ€™t use  &gt; in your shell prompts. However, this will not guarantee avoiding problems related to accidental pasting of other bad commands. For example, having an unintended space  between the desired directory/filename prefix and * in this example -  donâ€™t run it!:</p><p> å¸Œæœ›åˆ°ç°åœ¨å®ƒå¾ˆæ˜æ˜¾ï¼Œä¸ºæˆ‘ä»¬çš„ç”Ÿäº§ç³»ç»Ÿï¼ˆå’Œæˆ‘ä»¬è‡ªå·±ï¼‰çš„ç†æ™ºï¼Œæ‚¨ä¸åº”è¯¥ä½¿ç”¨ï¼†gt;åœ¨shellæç¤ºã€‚ä½†æ˜¯ï¼Œè¿™å°†æ— æ³•ä¿è¯é¿å…ä¸å…¶ä»–ä¸è‰¯å‘½ä»¤çš„æ„å¤–ç²˜è´´æœ‰å…³çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œåœ¨æ‰€éœ€çš„ç›®å½•/æ–‡ä»¶åå‰ç¼€å’Œ*åœ¨æ­¤ç¤ºä¾‹ä¸­å…·æœ‰æ„å¤–çš„ç©ºé—´ - ä¸è¦è¿è¡Œå®ƒï¼ï¼š</p><p>  The above command will try to erase a single file  /some/app/dir/oldlog_   and anything that matches  * in the current working directory!</p><p>  ä¸Šé¢çš„å‘½ä»¤å°†å°è¯•åˆ é™¤å•ä¸ªæ–‡ä»¶/æŸäº›/ app / dir / dir oldlog_ä»¥åŠä¸å½“å‰å·¥ä½œç›®å½•ä¸­åŒ¹é…çš„ä»»ä½•åŒ¹é…çš„ä»»ä½•æ–‡ä»¶ï¼ </p><p>  This stuff is complex! Small mistakes can come back to bite you in a variety of ways. We are running critical production systems after all - how to avoid these problem reliably, so we wouldnâ€™t be dependent on human errors not happening and always having luck?</p><p>è¿™ä¸ªä¸œè¥¿å¾ˆå¤æ‚ï¼å°é”™è¯¯å¯ä»¥å›æ¥å’¬ä½ çš„æ–¹å¼ã€‚æˆ‘ä»¬æ¯•ç«Ÿæ­£åœ¨è¿è¡Œå…³é”®çš„ç”Ÿäº§ç³»ç»Ÿ - å¦‚ä½•å¯é åœ°é¿å…è¿™äº›é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä¼šä¾èµ–äºæ²¡æœ‰å‘ç”Ÿçš„äººç±»é”™è¯¯ï¼Œå¹¶ä¸”æ€»æ˜¯æœ‰è¿æ°”ï¼Ÿ</p><p> I am not addressing any higher level solutions here, like various immutable infrastructure-as-code plaforms - they eliminate much of the â€œmanual everyday typingâ€ human error risk and shift the remaining risk to different layers.</p><p> æˆ‘åœ¨è¿™é‡Œæ²¡æœ‰è§£å†³ä»»ä½•æ›´é«˜çº§åˆ«çš„è§£å†³æ–¹æ¡ˆï¼Œå¦‚å„ç§ä¸å¯å˜åŸºç¡€è®¾æ–½ - ä»£ç æ–‘å— - å®ƒä»¬æ¶ˆé™¤äº†å¤§éƒ¨åˆ†çš„â€œæ‰‹åŠ¨æ—¥å¸¸æ‰“å­—â€äººä¸ºé”™è¯¯é£é™©ï¼Œå¹¶å°†å‰©ä½™çš„é£é™©è½¬ç§»åˆ°ä¸åŒçš„å±‚ã€‚</p><p> If you actually need to log in to the servers manually, then the best solution I know is to  not use privileged access when you donâ€™t need it. This will reduce convenience, but will increase safety.</p><p> å¦‚æœæ‚¨å®é™…ä¸Šéœ€è¦æ‰‹åŠ¨ç™»å½•æœåŠ¡å™¨ï¼Œé‚£ä¹ˆæˆ‘çŸ¥é“çš„æœ€ä½³è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ä¸éœ€è¦æ—¶ä¸ä½¿ç”¨ç‰¹æƒè®¿é—®ã€‚è¿™å°†å‡å°‘ä¾¿åˆ©æ€§ï¼Œä½†ä¼šå¢åŠ å®‰å…¨æ€§ã€‚</p><p>  Do not log in as root or sudo to an interactive root shell, even on development machines - theyâ€™re someoneâ€™s production too!</p><p>  ä¸è¦ä»¥rootæˆ–sudoç™»å½•åˆ°äº¤äº’å¼æ ¹å¤–å£³ï¼Œå³ä½¿æ˜¯å¼€å‘æœºå™¨ - ä»–ä»¬ä¹Ÿæ˜¯æŸäººçš„ç”Ÿäº§ï¼</p><p> In production, donâ€™t even log in as the database/application owner at OS level (so that the malformed  rm command above  canâ€™t erase important files)</p><p> åœ¨ç”Ÿäº§ä¸­ï¼Œç”šè‡³ä¸åœ¨æ“ä½œç³»ç»Ÿçº§åˆ«ç™»å½•æ•°æ®åº“/åº”ç”¨ç¨‹åºæ‰€æœ‰ï¼ˆä»¥ä¾¿ä¸Šé¢çš„æ ¼å¼é”™è¯¯çš„RMå‘½ä»¤æ— æ³•åˆ é™¤é‡è¦æ–‡ä»¶ï¼‰</p><p>  In production, you can enable typical (diagnostic) commands via passwordless  sudo (but everything else still needs a password)</p><p>  åœ¨ç”Ÿäº§ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ— å¯†ç sudoå¯ç”¨å…¸å‹ï¼ˆè¯Šæ–­ï¼‰å‘½ä»¤ï¼ˆä½†å…¶ä»–æ‰€æœ‰å…¶ä»–éœ€è¦å¯†ç ï¼‰</p><p>  When applying OS changes in production, write them all into a script, test it and run that exact script with  sudo + password</p><p>  åœ¨åº”ç”¨æ“ä½œç³»ç»Ÿçš„å˜åŒ–æ—¶ï¼Œå°†å®ƒä»¬å…¨éƒ¨å†™å…¥è„šæœ¬ï¼Œæµ‹è¯•å®ƒå¹¶ä½¿ç”¨sudo +å¯†ç è¿è¡Œè¯¥ç²¾ç¡®è„šæœ¬ </p><p> sudo and  /etc/sudoers arenâ€™t meant only for gaining selective access to  root user, but can be any other user too (dba, app owner)</p><p>sudoå’Œ/ etc / sudoerså¹¶ä¸ä»…ç”¨äºè·å¾—å¯¹rootç”¨æˆ·çš„é€‰æ‹©æ€§è®¿é—®ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯ä»»ä½•å…¶ä»–ç”¨æˆ·ï¼ˆDBAï¼ŒAPP WABLEï¼‰</p><p> This way, even if you do paste in some accidental junk from your clipboard, you  can not mess something up under the different OS users, unless you are deliberate or get extremely unlucky.</p><p> è¿™æ ·ï¼Œå³ä½¿ä½ åœ¨å‰ªè´´æ¿ä¸­ç²˜è´´ä¸€äº›æ„å¤–åƒåœ¾ï¼Œä½ ä¸èƒ½åœ¨ä¸åŒçš„OSç”¨æˆ·ä¸‹å¼„ä¹±ä¸€äº›ä¸œè¥¿ï¼Œé™¤éä½ æ˜¯æ•…æ„çš„ï¼Œæˆ–è€…éå¸¸ä¸å¹¸ã€‚</p><p>  Going back to the original topic in this article - pasting in  random stuff from your computerâ€™s clipboard is bad!</p><p>  å›åˆ°æœ¬æ–‡ä¸­çš„åŸå§‹ä¸»é¢˜ - ä»è®¡ç®—æœºçš„å‰ªè´´æ¿ä¸­ç²˜è´´åˆ°éšæœºçš„ä¸œè¥¿å¾ˆç³Ÿç³•ï¼</p><p> For me, the first step of avoiding some of the  paste horror is to not use a terminal which immediately pastes the clipboard on just a right mouse click. I accidentally right click my mouse multiple times per day! Iâ€™ve used this  terminal for the last 13 years as it gives me horizontal scrolling and doesnâ€™t have the insane right-mouse-click pasting. I paste with a deliberate  CMD+V, nothing else</p><p> å¯¹æˆ‘æ¥è¯´ï¼Œé¿å¼€ä¸€äº›ç²˜è´´ææ€–çš„ç¬¬ä¸€æ­¥æ˜¯ä¸è¦ä½¿ç”¨ç«‹å³ç²˜è´´å³é¼ æ ‡å³é”®çš„ç»ˆç«¯ã€‚æˆ‘ä¸å°å¿ƒå³ç‚¹å‡»æˆ‘çš„é¼ æ ‡æ¯å¤©å¤šæ¬¡ï¼æˆ‘åœ¨è¿‡å»çš„13å¹´é‡Œä½¿ç”¨äº†è¿™ä¸ªç»ˆç«¯ï¼Œå› ä¸ºå®ƒç»™äº†æˆ‘æ°´å¹³æ»šåŠ¨ï¼Œæ²¡æœ‰ç–¯ç‹‚çš„å³é”®å•å‡»ç²˜è´´ã€‚æˆ‘ç”¨åˆ»æ„çš„cmd + vï¼Œæ²¡æœ‰åˆ«çš„</p><p> I use various  notes.txt style files. When working interactively in production servers (having live  performance troubleshooting fun!), I tend to write any non-trivial command into an editor in a separate window first (often testing the commands out in a similar test environment)</p><p> æˆ‘ä½¿ç”¨å„ç§Notes.txtæ ·å¼æ–‡ä»¶ã€‚äº¤äº’å¼åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸­ï¼ˆå…·æœ‰å®æ—¶æ€§èƒ½æ•…éšœæ’é™¤ä¹è¶£ï¼ï¼‰ï¼Œæˆ‘å€¾å‘äºé¦–å…ˆåœ¨å•ç‹¬çš„çª—å£ä¸­å°†ä»»ä½•éçç¢çš„å‘½ä»¤å†™å…¥ç¼–è¾‘å™¨ï¼ˆé€šå¸¸åœ¨ç±»ä¼¼æµ‹è¯•ç¯å¢ƒä¸­æµ‹è¯•å‘½ä»¤ï¼‰</p><p> I donâ€™t  copy&amp;paste commands. I typically   cut&amp;paste back to the same text editor window, to make sure that the latest command was definitely put into the clipboard (I have had many occurrences of some browser or MS Word window just silently ignoring my  copy commands).</p><p> æˆ‘ä¸å¤åˆ¶ï¼†amp;ç²˜è´´å‘½ä»¤ã€‚æˆ‘é€šå¸¸ä¼šåˆ‡æ–­ï¼†amp;ç²˜è´´å›åˆ°åŒä¸€ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨çª—å£ï¼Œä»¥ç¡®ä¿æœ€æ–°å‘½ä»¤è‚¯å®šä¼šæ”¾å…¥å‰ªè´´æ¿ï¼ˆæˆ‘æœ‰å¾ˆå¤šæµè§ˆå™¨æˆ–MS Wordçª—å£çš„å‡ºç°åªæ˜¯é»˜é»˜åœ°å¿½ç•¥æˆ‘çš„å¤åˆ¶å‘½ä»¤ï¼‰ã€‚</p><p> Once I am sure that the clipboard contains what I intended, I will immediately paste it to the production terminal window. Sometimes with a manually typed  # prefix just to double-check it before hitting â€œgoâ€</p><p> ä¸€æ—¦æˆ‘ç›¸ä¿¡å‰ªè´´æ¿åŒ…å«æˆ‘çš„æ„å›¾ï¼Œæˆ‘ä¼šç«‹å³å°†å…¶ç²˜è´´åˆ°ç”Ÿäº§ç»ˆç«¯çª—å£ã€‚æœ‰æ—¶ä½¿ç”¨æ‰‹åŠ¨é”®å…¥çš„ï¼ƒå‰ç¼€åªæ˜¯ä¸ºäº†åœ¨å‡»ä¸­â€œgoâ€ä¹‹å‰ä»”ç»†æ£€æŸ¥å®ƒ </p><p> In extra paranoid mode, I double-check my clipboard contents even when visiting any browser windows (you know, because of  pastejacking)</p><p>åœ¨é¢å¤–çš„åæ‰§æ¨¡å¼ä¸­ï¼Œå³ä½¿è®¿é—®ä»»ä½•æµè§ˆå™¨çª—å£æ—¶ï¼Œæˆ‘ä¹Ÿä¼šä»”ç»†æ£€æŸ¥æˆ‘çš„å‰ªè´´æ¿å†…å®¹ï¼ˆä½ çŸ¥é“ï¼Œå› ä¸ºå¸•æ–¯ç‰¹æ°å…‹ï¼‰</p><p> You might think that youâ€™d just mitigate all risk by always pasting stuff to a  vim editor on the production server side, but what if your clipboard buffer contains an  ^ESC:q!\nsomeverybadcommand\n or an unfortunate VIM macro? So I tend to cut &amp; paste clipboard to my local editor, immediately before pasting it to the server</p><p> æ‚¨å¯èƒ½ä¼šè®¤ä¸ºæ‚¨åªæ˜¯é€šè¿‡å°†å†…å®¹ç²˜è´´åˆ°ç”Ÿäº§æœåŠ¡å™¨ç«¯çš„Vimç¼–è¾‘å™¨ï¼Œä½†å¦‚æœå‰ªè´´æ¿ç¼“å†²åŒºåŒ…å«ä¸€ä¸ª^ Escï¼šqï¼\ nsomeverybadcommand \ næˆ–ä¸å¹¸çš„vimå®ï¼Ÿæ‰€ä»¥æˆ‘å€¾å‘äºå‰Šå‡ï¼†amp;å°†å‰ªè´´æ¿ç²˜è´´åˆ°æˆ‘æœ¬åœ°ç¼–è¾‘å™¨ï¼Œç«‹å³å°†å…¶ç²˜è´´åˆ°æœåŠ¡å™¨ä¹‹å‰</p><p>  I hope that this was an entertaining readâ€¦ and maybe it helps to explain that old mysterious incident when you had to restore only the  mysql or  sqlplus binary from a backup, while everything else seemed to be fine (other than your shell prompt with the  &gt; suffix ;-)</p><p>  æˆ‘å¸Œæœ›è¿™æ˜¯ä¸€ä¸ªå¨±ä¹è¯»å–......ä¹Ÿè®¸å®ƒæœ‰åŠ©äºè§£é‡Šæ—§çš„ç¥ç§˜äº‹ä»¶ï¼Œå½“ä½ å¿…é¡»åªæ¢å¤å¤‡ä»½æ—¶æ¢å¤mysqlæˆ–sqlplusäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œå…¶ä»–ä¸€åˆ‡ä¼¼ä¹éƒ½å¾ˆå¥½ï¼ˆé™¤äº†ä½ çš„shellæç¤ºä¸ï¼†gté™¤å¤–; åç¼€ ;-ï¼‰</p><p> This file clobbering problem is just one example of how  accidental input can mess things up in your servers, even if you donâ€™t hit some of the worst case  rm -rf or  shutdown commands. There are multiple reliable options for avoiding trouble and greatly reducing the local blast radius. Having good command prompt hygiene, especially in important systems, reduces the amount of headaches as well. And after that, youâ€™ll need good backups.</p><p> æ­¤æ–‡ä»¶clobberingé—®é¢˜åªæ˜¯æ„å¤–è¾“å…¥å¦‚ä½•åœ¨æ‚¨çš„æœåŠ¡å™¨ä¸­æ··æ·†äº‹ç‰©çš„ä¸€ä¸ªç¤ºä¾‹ï¼Œå³ä½¿æ‚¨æ²¡æœ‰å‡»ä¸­ä¸€äº›æœ€åçš„æƒ…å†µrm -rfæˆ–shutdownå‘½ä»¤ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æœ‰å¤šç§å¯é çš„é€‰æ‹©ï¼Œå¯é¿å…éº»çƒ¦å’Œå¤§å¤§å‡å°‘å½“åœ°çˆ†ç‚¸åŠå¾„ã€‚å…·æœ‰è‰¯å¥½çš„å‘½ä»¤è¿…é€Ÿå«ç”Ÿï¼Œç‰¹åˆ«æ˜¯åœ¨é‡è¦çš„ç³»ç»Ÿä¸­ï¼Œä¹Ÿå‡å°‘äº†å¤´ç—›çš„æ•°é‡ã€‚ä¹‹åï¼Œä½ éœ€è¦è‰¯å¥½çš„å¤‡ä»½ã€‚</p><p> If you want further reading - one more way to look into misbehaving shell binaries is explained in my earlier blog entry. It talks about troubleshooting sudden SSH logon delays via system call tracing using  strace. While  strace doesnâ€™t trace the applicationâ€™s internal user-space logic directly, it can still be very useful in cases like immediate, abrupt exits or in scenarios like â€œmy config file changes are not picked up by the applicationâ€:</p><p> å¦‚æœæ‚¨æƒ³è¦è¿›ä¸€æ­¥é˜…è¯» - åœ¨æˆ‘ä¹‹å‰çš„åšå®¢æ¡ç›®ä¸­è§£é‡Šäº†ä¸€ä¸ªæ¢æœ›è¡Œä¸ºè¡Œä¸ºå£³äºŒè¿›åˆ¶æ–‡ä»¶çš„æ–¹æ³•ã€‚å®ƒè®¨è®ºäº†é€šè¿‡ä½¿ç”¨straceç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªçš„çªç„¶SSHç™»å½•å»¶è¿Ÿè¿›è¡Œæ•…éšœæ’é™¤ã€‚è™½ç„¶scraceä¸ç›´æ¥è·Ÿè¸ªåº”ç”¨ç¨‹åºçš„å†…éƒ¨ç”¨æˆ·ç©ºé—´é€»è¾‘ï¼Œä½†åœ¨ç«‹å³ï¼Œçªç„¶çš„é€€å‡ºæˆ–ç±»ä¼¼äºâ€œæˆ‘çš„é…ç½®æ–‡ä»¶æ›´æ”¹ä¹‹ç±»çš„æƒ…å†µä¸‹ï¼Œå®ƒä»ç„¶éå¸¸æœ‰ç”¨çš„æ˜¯â€æˆ‘çš„é…ç½®æ–‡ä»¶æ›´æ”¹â€œï¼š</p><p>     Check out my 2021 online training classes here!   Linux Performance &amp; Troubleshooting training,  Advanced Oracle Troubleshooting training,  Advanced Oracle SQL Tuning training. In addition to the live online classes, all attendees will receive personal downloadable video recordings too!</p><p>     æŸ¥çœ‹æˆ‘çš„2021å¹´åœ¨çº¿åŸ¹è®­è¯¾ç¨‹ï¼ Linuxæ€§èƒ½å’Œamp;æ•…éšœæ’é™¤åŸ¹è®­ï¼Œé«˜çº§Oracleæ•…éšœæ’é™¤åŸ¹è®­ï¼Œé«˜çº§Oracle SQL TuningåŸ¹è®­ã€‚é™¤äº†å®æ—¶åœ¨çº¿è¯¾ç¨‹ï¼Œæ‰€æœ‰ä¸ä¼šè€…ä¹Ÿå°†æ”¶åˆ°ä¸ªäººå¯ä¸‹è½½çš„è§†é¢‘å½•åˆ¶ï¼ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://tanelpoder.com/posts/how-to-stay-safe-in-shell/">https://tanelpoder.com/posts/how-to-stay-safe-in-shell/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/é‡å®šå‘/">#é‡å®šå‘</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/å‘½ä»¤/">#å‘½ä»¤</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è®¾è®¡/">#è®¾è®¡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ›æ„/">#åˆ›æ„</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‘„å½±/">#æ‘„å½±</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å›¾ç‰‡/">#å›¾ç‰‡</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¸¸æˆ/">#æ¸¸æˆ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è½¯ä»¶/">#è½¯ä»¶</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è§†é¢‘/">#è§†é¢‘</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ‰‹æœº/">#æ‰‹æœº</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¹¿å‘Š/">#å¹¿å‘Š</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ç½‘ç«™/">#ç½‘ç«™</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å…è´¹/">#å…è´¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/ä¸‹è½½/">#ä¸‹è½½</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å¾®è½¯/">#å¾®è½¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‹¹æœ/">#è‹¹æœ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/éŸ³ä¹/">#éŸ³ä¹</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åšå®¢/">#åšå®¢</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/æ¶æ/">#æ¶æ</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/è‰ºæœ¯/">#è‰ºæœ¯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/å·¥å…·/">#å·¥å…·</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/åˆ†äº«/">#åˆ†äº«</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>